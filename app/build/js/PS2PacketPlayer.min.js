"use strict";"undefined"==typeof Float32Array&&(Float32Array=Array);
// three.js - http://github.com/mrdoob/three.js
'use strict';var THREE=THREE||{REVISION:"61"};self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}};String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};THREE.extend=function(a,b){if(Object.keys)for(var c=Object.keys(b),d=0,e=c.length;d<e;d++){var f=c[d];Object.defineProperty(a,f,Object.getOwnPropertyDescriptor(b,f))}else for(f in c={}.hasOwnProperty,b)c.call(b,f)&&(a[f]=b[f]);return a};
(function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!self.requestAnimationFrame;++c)self.requestAnimationFrame=self[b[c]+"RequestAnimationFrame"],self.cancelAnimationFrame=self[b[c]+"CancelAnimationFrame"]||self[b[c]+"CancelRequestAnimationFrame"];void 0===self.requestAnimationFrame&&void 0!==self.setTimeout&&(self.requestAnimationFrame=function(b){var c=Date.now(),f=Math.max(0,16-(c-a)),h=self.setTimeout(function(){b(c+f)},f);a=c+f;return h});void 0===self.cancelAnimationFrame&&void 0!==
self.clearTimeout&&(self.cancelAnimationFrame=function(a){self.clearTimeout(a)})})();THREE.CullFaceNone=0;THREE.CullFaceBack=1;THREE.CullFaceFront=2;THREE.CullFaceFrontBack=3;THREE.FrontFaceDirectionCW=0;THREE.FrontFaceDirectionCCW=1;THREE.BasicShadowMap=0;THREE.PCFShadowMap=1;THREE.PCFSoftShadowMap=2;THREE.FrontSide=0;THREE.BackSide=1;THREE.DoubleSide=2;THREE.NoShading=0;THREE.FlatShading=1;THREE.SmoothShading=2;THREE.NoColors=0;THREE.FaceColors=1;THREE.VertexColors=2;THREE.NoBlending=0;
THREE.NormalBlending=1;THREE.AdditiveBlending=2;THREE.SubtractiveBlending=3;THREE.MultiplyBlending=4;THREE.CustomBlending=5;THREE.AddEquation=100;THREE.SubtractEquation=101;THREE.ReverseSubtractEquation=102;THREE.ZeroFactor=200;THREE.OneFactor=201;THREE.SrcColorFactor=202;THREE.OneMinusSrcColorFactor=203;THREE.SrcAlphaFactor=204;THREE.OneMinusSrcAlphaFactor=205;THREE.DstAlphaFactor=206;THREE.OneMinusDstAlphaFactor=207;THREE.DstColorFactor=208;THREE.OneMinusDstColorFactor=209;
THREE.SrcAlphaSaturateFactor=210;THREE.MultiplyOperation=0;THREE.MixOperation=1;THREE.AddOperation=2;THREE.UVMapping=function(){};THREE.CubeReflectionMapping=function(){};THREE.CubeRefractionMapping=function(){};THREE.SphericalReflectionMapping=function(){};THREE.SphericalRefractionMapping=function(){};THREE.RepeatWrapping=1E3;THREE.ClampToEdgeWrapping=1001;THREE.MirroredRepeatWrapping=1002;THREE.NearestFilter=1003;THREE.NearestMipMapNearestFilter=1004;THREE.NearestMipMapLinearFilter=1005;
THREE.LinearFilter=1006;THREE.LinearMipMapNearestFilter=1007;THREE.LinearMipMapLinearFilter=1008;THREE.UnsignedByteType=1009;THREE.ByteType=1010;THREE.ShortType=1011;THREE.UnsignedShortType=1012;THREE.IntType=1013;THREE.UnsignedIntType=1014;THREE.FloatType=1015;THREE.UnsignedShort4444Type=1016;THREE.UnsignedShort5551Type=1017;THREE.UnsignedShort565Type=1018;THREE.AlphaFormat=1019;THREE.RGBFormat=1020;THREE.RGBAFormat=1021;THREE.LuminanceFormat=1022;THREE.LuminanceAlphaFormat=1023;
THREE.RGB_S3TC_DXT1_Format=2001;THREE.RGBA_S3TC_DXT1_Format=2002;THREE.RGBA_S3TC_DXT3_Format=2003;THREE.RGBA_S3TC_DXT5_Format=2004;THREE.Color=function(a){void 0!==a&&this.set(a);return this};
THREE.Color.prototype={constructor:THREE.Color,r:1,g:1,b:1,set:function(a){a instanceof THREE.Color?this.copy(a):"number"===typeof a?this.setHex(a):"string"===typeof a&&this.setStyle(a);return this},setHex:function(a){a=Math.floor(a);this.r=(a>>16&255)/255;this.g=(a>>8&255)/255;this.b=(a&255)/255;return this},setRGB:function(a,b,c){this.r=a;this.g=b;this.b=c;return this},setHSL:function(a,b,c){if(0===b)this.r=this.g=this.b=c;else{var d=function(a,b,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?a+6*(b-a)*
c:0.5>c?b:c<2/3?a+6*(b-a)*(2/3-c):a},b=0.5>=c?c*(1+b):c+b-c*b,c=2*c-b;this.r=d(c,b,a+1/3);this.g=d(c,b,a);this.b=d(c,b,a-1/3)}return this},setStyle:function(a){if(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(a))return a=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(a),this.r=Math.min(255,parseInt(a[1],10))/255,this.g=Math.min(255,parseInt(a[2],10))/255,this.b=Math.min(255,parseInt(a[3],10))/255,this;if(/^rgb\((\d+)\%, ?(\d+)\%, ?(\d+)\%\)$/i.test(a))return a=/^rgb\((\d+)\%, ?(\d+)\%, ?(\d+)\%\)$/i.exec(a),this.r=
Math.min(100,parseInt(a[1],10))/100,this.g=Math.min(100,parseInt(a[2],10))/100,this.b=Math.min(100,parseInt(a[3],10))/100,this;if(/^\#([0-9a-f]{6})$/i.test(a))return a=/^\#([0-9a-f]{6})$/i.exec(a),this.setHex(parseInt(a[1],16)),this;if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(a))return a=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(a),this.setHex(parseInt(a[1]+a[1]+a[2]+a[2]+a[3]+a[3],16)),this;if(/^(\w+)$/i.test(a))return this.setHex(THREE.ColorKeywords[a]),this},copy:function(a){this.r=a.r;this.g=
a.g;this.b=a.b;return this},copyGammaToLinear:function(a){this.r=a.r*a.r;this.g=a.g*a.g;this.b=a.b*a.b;return this},copyLinearToGamma:function(a){this.r=Math.sqrt(a.r);this.g=Math.sqrt(a.g);this.b=Math.sqrt(a.b);return this},convertGammaToLinear:function(){var a=this.r,b=this.g,c=this.b;this.r=a*a;this.g=b*b;this.b=c*c;return this},convertLinearToGamma:function(){this.r=Math.sqrt(this.r);this.g=Math.sqrt(this.g);this.b=Math.sqrt(this.b);return this},getHex:function(){return 255*this.r<<16^255*this.g<<
8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(){var a={h:0,s:0,l:0};return function(){var b=this.r,c=this.g,d=this.b,e=Math.max(b,c,d),f=Math.min(b,c,d),h,g=(f+e)/2;if(f===e)f=h=0;else{var i=e-f,f=0.5>=g?i/(e+f):i/(2-e-f);switch(e){case b:h=(c-d)/i+(c<d?6:0);break;case c:h=(d-b)/i+2;break;case d:h=(b-c)/i+4}h/=6}a.h=h;a.s=f;a.l=g;return a}}(),getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},
offsetHSL:function(a,b,c){var d=this.getHSL();d.h+=a;d.s+=b;d.l+=c;this.setHSL(d.h,d.s,d.l);return this},add:function(a){this.r+=a.r;this.g+=a.g;this.b+=a.b;return this},addColors:function(a,b){this.r=a.r+b.r;this.g=a.g+b.g;this.b=a.b+b.b;return this},addScalar:function(a){this.r+=a;this.g+=a;this.b+=a;return this},multiply:function(a){this.r*=a.r;this.g*=a.g;this.b*=a.b;return this},multiplyScalar:function(a){this.r*=a;this.g*=a;this.b*=a;return this},lerp:function(a,b){this.r+=(a.r-this.r)*b;this.g+=
(a.g-this.g)*b;this.b+=(a.b-this.b)*b;return this},equals:function(a){return a.r===this.r&&a.g===this.g&&a.b===this.b},fromArray:function(a){this.r=a[0];this.g=a[1];this.b=a[2];return this},toArray:function(){return[this.r,this.g,this.b]},clone:function(){return(new THREE.Color).setRGB(this.r,this.g,this.b)}};
THREE.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,
darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,
grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,
lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,
palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,
tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};THREE.Quaternion=function(a,b,c,d){this._x=a||0;this._y=b||0;this._z=c||0;this._w=void 0!==d?d:1};
THREE.Quaternion.prototype={constructor:THREE.Quaternion,_x:0,_y:0,_z:0,_w:0,_euler:void 0,_updateEuler:function(){void 0!==this._euler&&this._euler.setFromQuaternion(this,void 0,!1)},get x(){return this._x},set x(a){this._x=a;this._updateEuler()},get y(){return this._y},set y(a){this._y=a;this._updateEuler()},get z(){return this._z},set z(a){this._z=a;this._updateEuler()},get w(){return this._w},set w(a){this._w=a;this._updateEuler()},set:function(a,b,c,d){this._x=a;this._y=b;this._z=c;this._w=d;
this._updateEuler();return this},copy:function(a){this._x=a._x;this._y=a._y;this._z=a._z;this._w=a._w;this._updateEuler();return this},setFromEuler:function(a,b){if(!1===a instanceof THREE.Euler)throw Error("ERROR: Quaternion's .setFromEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code.");var c=Math.cos(a._x/2),d=Math.cos(a._y/2),e=Math.cos(a._z/2),f=Math.sin(a._x/2),h=Math.sin(a._y/2),g=Math.sin(a._z/2);"XYZ"===a.order?(this._x=f*d*e+c*h*g,this._y=c*h*
e-f*d*g,this._z=c*d*g+f*h*e,this._w=c*d*e-f*h*g):"YXZ"===a.order?(this._x=f*d*e+c*h*g,this._y=c*h*e-f*d*g,this._z=c*d*g-f*h*e,this._w=c*d*e+f*h*g):"ZXY"===a.order?(this._x=f*d*e-c*h*g,this._y=c*h*e+f*d*g,this._z=c*d*g+f*h*e,this._w=c*d*e-f*h*g):"ZYX"===a.order?(this._x=f*d*e-c*h*g,this._y=c*h*e+f*d*g,this._z=c*d*g-f*h*e,this._w=c*d*e+f*h*g):"YZX"===a.order?(this._x=f*d*e+c*h*g,this._y=c*h*e+f*d*g,this._z=c*d*g-f*h*e,this._w=c*d*e-f*h*g):"XZY"===a.order&&(this._x=f*d*e-c*h*g,this._y=c*h*e-f*d*g,this._z=
c*d*g+f*h*e,this._w=c*d*e+f*h*g);!1!==b&&this._updateEuler();return this},setFromAxisAngle:function(a,b){var c=b/2,d=Math.sin(c);this._x=a.x*d;this._y=a.y*d;this._z=a.z*d;this._w=Math.cos(c);this._updateEuler();return this},setFromRotationMatrix:function(a){var b=a.elements,c=b[0],a=b[4],d=b[8],e=b[1],f=b[5],h=b[9],g=b[2],i=b[6],b=b[10],k=c+f+b;0<k?(c=0.5/Math.sqrt(k+1),this._w=0.25/c,this._x=(i-h)*c,this._y=(d-g)*c,this._z=(e-a)*c):c>f&&c>b?(c=2*Math.sqrt(1+c-f-b),this._w=(i-h)/c,this._x=0.25*c,
this._y=(a+e)/c,this._z=(d+g)/c):f>b?(c=2*Math.sqrt(1+f-c-b),this._w=(d-g)/c,this._x=(a+e)/c,this._y=0.25*c,this._z=(h+i)/c):(c=2*Math.sqrt(1+b-c-f),this._w=(e-a)/c,this._x=(d+g)/c,this._y=(h+i)/c,this._z=0.25*c);this._updateEuler();return this},inverse:function(){this.conjugate().normalize();return this},conjugate:function(){this._x*=-1;this._y*=-1;this._z*=-1;this._updateEuler();return this},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*
this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var a=this.length();0===a?(this._z=this._y=this._x=0,this._w=1):(a=1/a,this._x*=a,this._y*=a,this._z*=a,this._w*=a);return this},multiply:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Quaternion's .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(a,b)):this.multiplyQuaternions(this,a)},multiplyQuaternions:function(a,b){var c=a._x,d=a._y,e=a._z,f=
a._w,h=b._x,g=b._y,i=b._z,k=b._w;this._x=c*k+f*h+d*i-e*g;this._y=d*k+f*g+e*h-c*i;this._z=e*k+f*i+c*g-d*h;this._w=f*k-c*h-d*g-e*i;this._updateEuler();return this},multiplyVector3:function(a){console.warn("DEPRECATED: Quaternion's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead.");return a.applyQuaternion(this)},slerp:function(a,b){if(0===b)return this;if(1===b)return this.copy(a),this;var c=this._x,d=this._y,e=this._z,f=this._w,h=f*a._w+c*a._x+d*a._y+e*
a._z;0>h?(this._w=-a._w,this._x=-a._x,this._y=-a._y,this._z=-a._z,h=-h):this.copy(a);if(1<=h)return this._w=f,this._x=c,this._y=d,this._z=e,this;var g=Math.acos(h),i=Math.sqrt(1-h*h);if(0.001>Math.abs(i))return this._w=0.5*(f+this._w),this._x=0.5*(c+this._x),this._y=0.5*(d+this._y),this._z=0.5*(e+this._z),this;h=Math.sin((1-b)*g)/i;g=Math.sin(b*g)/i;this._w=f*h+this._w*g;this._x=c*h+this._x*g;this._y=d*h+this._y*g;this._z=e*h+this._z*g;this._updateEuler();return this},equals:function(a){return a._x===
this._x&&a._y===this._y&&a._z===this._z&&a._w===this._w},fromArray:function(a){this._x=a[0];this._y=a[1];this._z=a[2];this._w=a[3];this._updateEuler();return this},toArray:function(){return[this._x,this._y,this._z,this._w]},clone:function(){return new THREE.Quaternion(this._x,this._y,this._z,this._w)}};THREE.Quaternion.slerp=function(a,b,c,d){return c.copy(a).slerp(b,d)};THREE.Vector2=function(a,b){this.x=a||0;this.y=b||0};
THREE.Vector2.prototype={constructor:THREE.Vector2,set:function(a,b){this.x=a;this.y=b;return this},setX:function(a){this.x=a;return this},setY:function(a){this.y=a;return this},setComponent:function(a,b){switch(a){case 0:this.x=b;break;case 1:this.y=b;break;default:throw Error("index is out of range: "+a);}},getComponent:function(a){switch(a){case 0:return this.x;case 1:return this.y;default:throw Error("index is out of range: "+a);}},copy:function(a){this.x=a.x;this.y=a.y;return this},add:function(a,
b){if(void 0!==b)return console.warn("DEPRECATED: Vector2's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(a,b);this.x+=a.x;this.y+=a.y;return this},addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this},addScalar:function(a){this.x+=a;this.y+=a;return this},sub:function(a,b){if(void 0!==b)return console.warn("DEPRECATED: Vector2's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(a,b);this.x-=a.x;this.y-=
a.y;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;return this},divideScalar:function(a){0!==a?(a=1/a,this.x*=a,this.y*=a):this.y=this.x=0;return this},min:function(a){this.x>a.x&&(this.x=a.x);this.y>a.y&&(this.y=a.y);return this},max:function(a){this.x<a.x&&(this.x=a.x);this.y<a.y&&(this.y=a.y);return this},clamp:function(a,b){this.x<a.x?this.x=a.x:this.x>b.x&&(this.x=b.x);this.y<a.y?this.y=a.y:this.y>b.y&&(this.y=b.y);
return this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var b=this.x-a.x,a=this.y-a.y;return b*b+a*a},setLength:function(a){var b=this.length();0!==b&&a!==b&&this.multiplyScalar(a/
b);return this},lerp:function(a,b){this.x+=(a.x-this.x)*b;this.y+=(a.y-this.y)*b;return this},equals:function(a){return a.x===this.x&&a.y===this.y},fromArray:function(a){this.x=a[0];this.y=a[1];return this},toArray:function(){return[this.x,this.y]},clone:function(){return new THREE.Vector2(this.x,this.y)}};THREE.Vector3=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};
THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(a,b,c){this.x=a;this.y=b;this.z=c;return this},setX:function(a){this.x=a;return this},setY:function(a){this.y=a;return this},setZ:function(a){this.z=a;return this},setComponent:function(a,b){switch(a){case 0:this.x=b;break;case 1:this.y=b;break;case 2:this.z=b;break;default:throw Error("index is out of range: "+a);}},getComponent:function(a){switch(a){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw Error("index is out of range: "+
a);}},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},add:function(a,b){if(void 0!==b)return console.warn("DEPRECATED: Vector3's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(a,b);this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},addScalar:function(a){this.x+=a;this.y+=a;this.z+=a;return this},addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;return this},sub:function(a,b){if(void 0!==b)return console.warn("DEPRECATED: Vector3's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),
this.subVectors(a,b);this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this},multiply:function(a,b){if(void 0!==b)return console.warn("DEPRECATED: Vector3's .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(a,b);this.x*=a.x;this.y*=a.y;this.z*=a.z;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;this.z*=a;return this},multiplyVectors:function(a,b){this.x=a.x*
b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this},applyMatrix3:function(a){var b=this.x,c=this.y,d=this.z,a=a.elements;this.x=a[0]*b+a[3]*c+a[6]*d;this.y=a[1]*b+a[4]*c+a[7]*d;this.z=a[2]*b+a[5]*c+a[8]*d;return this},applyMatrix4:function(a){var b=this.x,c=this.y,d=this.z,a=a.elements;this.x=a[0]*b+a[4]*c+a[8]*d+a[12];this.y=a[1]*b+a[5]*c+a[9]*d+a[13];this.z=a[2]*b+a[6]*c+a[10]*d+a[14];return this},applyProjection:function(a){var b=this.x,c=this.y,d=this.z,a=a.elements,e=1/(a[3]*b+a[7]*c+a[11]*d+a[15]);
this.x=(a[0]*b+a[4]*c+a[8]*d+a[12])*e;this.y=(a[1]*b+a[5]*c+a[9]*d+a[13])*e;this.z=(a[2]*b+a[6]*c+a[10]*d+a[14])*e;return this},applyQuaternion:function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,h=a.z,a=a.w,g=a*b+f*d-h*c,i=a*c+h*b-e*d,k=a*d+e*c-f*b,b=-e*b-f*c-h*d;this.x=g*a+b*-e+i*-h-k*-f;this.y=i*a+b*-f+k*-e-g*-h;this.z=k*a+b*-h+g*-f-i*-e;return this},transformDirection:function(a){var b=this.x,c=this.y,d=this.z,a=a.elements;this.x=a[0]*b+a[4]*c+a[8]*d;this.y=a[1]*b+a[5]*c+a[9]*d;this.z=a[2]*
b+a[6]*c+a[10]*d;this.normalize();return this},divide:function(a){this.x/=a.x;this.y/=a.y;this.z/=a.z;return this},divideScalar:function(a){0!==a?(a=1/a,this.x*=a,this.y*=a,this.z*=a):this.z=this.y=this.x=0;return this},min:function(a){this.x>a.x&&(this.x=a.x);this.y>a.y&&(this.y=a.y);this.z>a.z&&(this.z=a.z);return this},max:function(a){this.x<a.x&&(this.x=a.x);this.y<a.y&&(this.y=a.y);this.z<a.z&&(this.z=a.z);return this},clamp:function(a,b){this.x<a.x?this.x=a.x:this.x>b.x&&(this.x=b.x);this.y<
a.y?this.y=a.y:this.y>b.y&&(this.y=b.y);this.z<a.z?this.z=a.z:this.z>b.z&&(this.z=b.z);return this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},
setLength:function(a){var b=this.length();0!==b&&a!==b&&this.multiplyScalar(a/b);return this},lerp:function(a,b){this.x+=(a.x-this.x)*b;this.y+=(a.y-this.y)*b;this.z+=(a.z-this.z)*b;return this},cross:function(a,b){if(void 0!==b)return console.warn("DEPRECATED: Vector3's .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(a,b);var c=this.x,d=this.y,e=this.z;this.x=d*a.z-e*a.y;this.y=e*a.x-c*a.z;this.z=c*a.y-d*a.x;return this},crossVectors:function(a,b){var c=
a.x,d=a.y,e=a.z,f=b.x,h=b.y,g=b.z;this.x=d*g-e*h;this.y=e*f-c*g;this.z=c*h-d*f;return this},angleTo:function(a){a=this.dot(a)/(this.length()*a.length());return Math.acos(THREE.Math.clamp(a,-1,1))},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var b=this.x-a.x,c=this.y-a.y,a=this.z-a.z;return b*b+c*c+a*a},setEulerFromRotationMatrix:function(){console.error("REMOVED: Vector3's setEulerFromRotationMatrix has been removed in favor of Euler.setFromRotationMatrix(), please update your code.")},
setEulerFromQuaternion:function(){console.error("REMOVED: Vector3's setEulerFromQuaternion: has been removed in favor of Euler.setFromQuaternion(), please update your code.")},getPositionFromMatrix:function(a){this.x=a.elements[12];this.y=a.elements[13];this.z=a.elements[14];return this},getScaleFromMatrix:function(a){var b=this.set(a.elements[0],a.elements[1],a.elements[2]).length(),c=this.set(a.elements[4],a.elements[5],a.elements[6]).length(),a=this.set(a.elements[8],a.elements[9],a.elements[10]).length();
this.x=b;this.y=c;this.z=a;return this},getColumnFromMatrix:function(a,b){var c=4*a,d=b.elements;this.x=d[c];this.y=d[c+1];this.z=d[c+2];return this},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z},fromArray:function(a){this.x=a[0];this.y=a[1];this.z=a[2];return this},toArray:function(){return[this.x,this.y,this.z]},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)}};
THREE.extend(THREE.Vector3.prototype,{applyEuler:function(){var a=new THREE.Quaternion;return function(b){!1===b instanceof THREE.Euler&&console.error("ERROR: Vector3's .applyEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code.");this.applyQuaternion(a.setFromEuler(b));return this}}(),applyAxisAngle:function(){var a=new THREE.Quaternion;return function(b,c){this.applyQuaternion(a.setFromAxisAngle(b,c));return this}}(),projectOnVector:function(){var a=new THREE.Vector3;
return function(b){a.copy(b).normalize();b=this.dot(a);return this.copy(a).multiplyScalar(b)}}(),projectOnPlane:function(){var a=new THREE.Vector3;return function(b){a.copy(this).projectOnVector(b);return this.sub(a)}}(),reflect:function(){var a=new THREE.Vector3;return function(b){a.copy(this).projectOnVector(b).multiplyScalar(2);return this.subVectors(a,this)}}()});THREE.Vector4=function(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=void 0!==d?d:1};
THREE.Vector4.prototype={constructor:THREE.Vector4,set:function(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d;return this},setX:function(a){this.x=a;return this},setY:function(a){this.y=a;return this},setZ:function(a){this.z=a;return this},setW:function(a){this.w=a;return this},setComponent:function(a,b){switch(a){case 0:this.x=b;break;case 1:this.y=b;break;case 2:this.z=b;break;case 3:this.w=b;break;default:throw Error("index is out of range: "+a);}},getComponent:function(a){switch(a){case 0:return this.x;
case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw Error("index is out of range: "+a);}},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=void 0!==a.w?a.w:1;return this},add:function(a,b){if(void 0!==b)return console.warn("DEPRECATED: Vector4's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(a,b);this.x+=a.x;this.y+=a.y;this.z+=a.z;this.w+=a.w;return this},addScalar:function(a){this.x+=a;this.y+=a;this.z+=a;this.w+=a;return this},
addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;this.w=a.w+b.w;return this},sub:function(a,b){if(void 0!==b)return console.warn("DEPRECATED: Vector4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(a,b);this.x-=a.x;this.y-=a.y;this.z-=a.z;this.w-=a.w;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;this.w=a.w-b.w;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;this.z*=a;this.w*=a;return this},
applyMatrix4:function(a){var b=this.x,c=this.y,d=this.z,e=this.w,a=a.elements;this.x=a[0]*b+a[4]*c+a[8]*d+a[12]*e;this.y=a[1]*b+a[5]*c+a[9]*d+a[13]*e;this.z=a[2]*b+a[6]*c+a[10]*d+a[14]*e;this.w=a[3]*b+a[7]*c+a[11]*d+a[15]*e;return this},divideScalar:function(a){0!==a?(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a):(this.z=this.y=this.x=0,this.w=1);return this},setAxisAngleFromQuaternion:function(a){this.w=2*Math.acos(a.w);var b=Math.sqrt(1-a.w*a.w);1E-4>b?(this.x=1,this.z=this.y=0):(this.x=a.x/b,
this.y=a.y/b,this.z=a.z/b);return this},setAxisAngleFromRotationMatrix:function(a){var b,c,d,a=a.elements,e=a[0];d=a[4];var f=a[8],h=a[1],g=a[5],i=a[9];c=a[2];b=a[6];var k=a[10];if(0.01>Math.abs(d-h)&&0.01>Math.abs(f-c)&&0.01>Math.abs(i-b)){if(0.1>Math.abs(d+h)&&0.1>Math.abs(f+c)&&0.1>Math.abs(i+b)&&0.1>Math.abs(e+g+k-3))return this.set(1,0,0,0),this;a=Math.PI;e=(e+1)/2;g=(g+1)/2;k=(k+1)/2;d=(d+h)/4;f=(f+c)/4;i=(i+b)/4;e>g&&e>k?0.01>e?(b=0,d=c=0.707106781):(b=Math.sqrt(e),c=d/b,d=f/b):g>k?0.01>g?
(b=0.707106781,c=0,d=0.707106781):(c=Math.sqrt(g),b=d/c,d=i/c):0.01>k?(c=b=0.707106781,d=0):(d=Math.sqrt(k),b=f/d,c=i/d);this.set(b,c,d,a);return this}a=Math.sqrt((b-i)*(b-i)+(f-c)*(f-c)+(h-d)*(h-d));0.001>Math.abs(a)&&(a=1);this.x=(b-i)/a;this.y=(f-c)/a;this.z=(h-d)/a;this.w=Math.acos((e+g+k-1)/2);return this},min:function(a){this.x>a.x&&(this.x=a.x);this.y>a.y&&(this.y=a.y);this.z>a.z&&(this.z=a.z);this.w>a.w&&(this.w=a.w);return this},max:function(a){this.x<a.x&&(this.x=a.x);this.y<a.y&&(this.y=
a.y);this.z<a.z&&(this.z=a.z);this.w<a.w&&(this.w=a.w);return this},clamp:function(a,b){this.x<a.x?this.x=a.x:this.x>b.x&&(this.x=b.x);this.y<a.y?this.y=a.y:this.y>b.y&&(this.y=b.y);this.z<a.z?this.z=a.z:this.z>b.z&&(this.z=b.z);this.w<a.w?this.w=a.w:this.w>b.w&&(this.w=b.w);return this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*
this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(a){var b=this.length();0!==b&&a!==b&&this.multiplyScalar(a/b);return this},lerp:function(a,b){this.x+=(a.x-this.x)*b;this.y+=(a.y-this.y)*b;this.z+=(a.z-this.z)*b;this.w+=(a.w-this.w)*b;return this},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z&&
a.w===this.w},fromArray:function(a){this.x=a[0];this.y=a[1];this.z=a[2];this.w=a[3];return this},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)}};THREE.Euler=function(a,b,c,d){this._x=a||0;this._y=b||0;this._z=c||0;this._order=d||THREE.Euler.DefaultOrder};THREE.Euler.RotationOrders="XYZ YZX ZXY XZY YXZ ZYX".split(" ");THREE.Euler.DefaultOrder="XYZ";
THREE.Euler.prototype={constructor:THREE.Euler,_x:0,_y:0,_z:0,_order:THREE.Euler.DefaultOrder,_quaternion:void 0,_updateQuaternion:function(){void 0!==this._quaternion&&this._quaternion.setFromEuler(this,!1)},get x(){return this._x},set x(a){this._x=a;this._updateQuaternion()},get y(){return this._y},set y(a){this._y=a;this._updateQuaternion()},get z(){return this._z},set z(a){this._z=a;this._updateQuaternion()},get order(){return this._order},set order(a){this._order=a;this._updateQuaternion()},
set:function(a,b,c,d){this._x=a;this._y=b;this._z=c;this._order=d||this._order;this._updateQuaternion();return this},copy:function(a){this._x=a._x;this._y=a._y;this._z=a._z;this._order=a._order;this._updateQuaternion();return this},setFromRotationMatrix:function(a,b){function c(a){return Math.min(Math.max(a,-1),1)}var d=a.elements,e=d[0],f=d[4],h=d[8],g=d[1],i=d[5],k=d[9],l=d[2],m=d[6],d=d[10],b=b||this._order;"XYZ"===b?(this._y=Math.asin(c(h)),0.99999>Math.abs(h)?(this._x=Math.atan2(-k,d),this._z=
Math.atan2(-f,e)):(this._x=Math.atan2(m,i),this._z=0)):"YXZ"===b?(this._x=Math.asin(-c(k)),0.99999>Math.abs(k)?(this._y=Math.atan2(h,d),this._z=Math.atan2(g,i)):(this._y=Math.atan2(-l,e),this._z=0)):"ZXY"===b?(this._x=Math.asin(c(m)),0.99999>Math.abs(m)?(this._y=Math.atan2(-l,d),this._z=Math.atan2(-f,i)):(this._y=0,this._z=Math.atan2(g,e))):"ZYX"===b?(this._y=Math.asin(-c(l)),0.99999>Math.abs(l)?(this._x=Math.atan2(m,d),this._z=Math.atan2(g,e)):(this._x=0,this._z=Math.atan2(-f,i))):"YZX"===b?(this._z=
Math.asin(c(g)),0.99999>Math.abs(g)?(this._x=Math.atan2(-k,i),this._y=Math.atan2(-l,e)):(this._x=0,this._y=Math.atan2(h,d))):"XZY"===b?(this._z=Math.asin(-c(f)),0.99999>Math.abs(f)?(this._x=Math.atan2(m,i),this._y=Math.atan2(h,e)):(this._x=Math.atan2(-k,d),this._y=0)):console.warn("WARNING: Euler.setFromRotationMatrix() given unsupported order: "+b);this._order=b;this._updateQuaternion();return this},setFromQuaternion:function(a,b,c){function d(a){return Math.min(Math.max(a,-1),1)}var e=a.x*a.x,f=
a.y*a.y,h=a.z*a.z,g=a.w*a.w,b=b||this._order;"XYZ"===b?(this._x=Math.atan2(2*(a.x*a.w-a.y*a.z),g-e-f+h),this._y=Math.asin(d(2*(a.x*a.z+a.y*a.w))),this._z=Math.atan2(2*(a.z*a.w-a.x*a.y),g+e-f-h)):"YXZ"===b?(this._x=Math.asin(d(2*(a.x*a.w-a.y*a.z))),this._y=Math.atan2(2*(a.x*a.z+a.y*a.w),g-e-f+h),this._z=Math.atan2(2*(a.x*a.y+a.z*a.w),g-e+f-h)):"ZXY"===b?(this._x=Math.asin(d(2*(a.x*a.w+a.y*a.z))),this._y=Math.atan2(2*(a.y*a.w-a.z*a.x),g-e-f+h),this._z=Math.atan2(2*(a.z*a.w-a.x*a.y),g-e+f-h)):"ZYX"===
b?(this._x=Math.atan2(2*(a.x*a.w+a.z*a.y),g-e-f+h),this._y=Math.asin(d(2*(a.y*a.w-a.x*a.z))),this._z=Math.atan2(2*(a.x*a.y+a.z*a.w),g+e-f-h)):"YZX"===b?(this._x=Math.atan2(2*(a.x*a.w-a.z*a.y),g-e+f-h),this._y=Math.atan2(2*(a.y*a.w-a.x*a.z),g+e-f-h),this._z=Math.asin(d(2*(a.x*a.y+a.z*a.w)))):"XZY"===b?(this._x=Math.atan2(2*(a.x*a.w+a.y*a.z),g-e+f-h),this._y=Math.atan2(2*(a.x*a.z+a.y*a.w),g+e-f-h),this._z=Math.asin(d(2*(a.z*a.w-a.x*a.y)))):console.warn("WARNING: Euler.setFromQuaternion() given unsupported order: "+
b);this._order=b;!1!==c&&this._updateQuaternion();return this},reorder:function(){var a=new THREE.Quaternion;return function(b){a.setFromEuler(this);this.setFromQuaternion(a,b)}}(),fromArray:function(a){this._x=a[0];this._y=a[1];this._z=a[2];void 0!==a[3]&&(this._order=a[3]);this._updateQuaternion();return this},toArray:function(){return[this._x,this._y,this._z,this._order]},equals:function(a){return a._x===this._x&&a._y===this._y&&a._z===this._z&&a._order===this._order},clone:function(){return new THREE.Euler(this._x,
this._y,this._z,this._order)}};THREE.Line3=function(a,b){this.start=void 0!==a?a:new THREE.Vector3;this.end=void 0!==b?b:new THREE.Vector3};
THREE.Line3.prototype={constructor:THREE.Line3,set:function(a,b){this.start.copy(a);this.end.copy(b);return this},copy:function(a){this.start.copy(a.start);this.end.copy(a.end);return this},center:function(a){return(a||new THREE.Vector3).addVectors(this.start,this.end).multiplyScalar(0.5)},delta:function(a){return(a||new THREE.Vector3).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(a,
b){var c=b||new THREE.Vector3;return this.delta(c).multiplyScalar(a).add(this.start)},closestPointToPointParameter:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c,d){a.subVectors(c,this.start);b.subVectors(this.end,this.start);var e=b.dot(b),e=b.dot(a)/e;d&&(e=THREE.Math.clamp(e,0,1));return e}}(),closestPointToPoint:function(a,b,c){a=this.closestPointToPointParameter(a,b);c=c||new THREE.Vector3;return this.delta(c).multiplyScalar(a).add(this.start)},applyMatrix4:function(a){this.start.applyMatrix4(a);
this.end.applyMatrix4(a);return this},equals:function(a){return a.start.equals(this.start)&&a.end.equals(this.end)},clone:function(){return(new THREE.Line3).copy(this)}};THREE.Box2=function(a,b){this.min=void 0!==a?a:new THREE.Vector2(Infinity,Infinity);this.max=void 0!==b?b:new THREE.Vector2(-Infinity,-Infinity)};
THREE.Box2.prototype={constructor:THREE.Box2,set:function(a,b){this.min.copy(a);this.max.copy(b);return this},setFromPoints:function(a){if(0<a.length){var b=a[0];this.min.copy(b);this.max.copy(b);for(var c=1,d=a.length;c<d;c++)b=a[c],b.x<this.min.x?this.min.x=b.x:b.x>this.max.x&&(this.max.x=b.x),b.y<this.min.y?this.min.y=b.y:b.y>this.max.y&&(this.max.y=b.y)}else this.makeEmpty();return this},setFromCenterAndSize:function(){var a=new THREE.Vector2;return function(b,c){var d=a.copy(c).multiplyScalar(0.5);
this.min.copy(b).sub(d);this.max.copy(b).add(d);return this}}(),copy:function(a){this.min.copy(a.min);this.max.copy(a.max);return this},makeEmpty:function(){this.min.x=this.min.y=Infinity;this.max.x=this.max.y=-Infinity;return this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},center:function(a){return(a||new THREE.Vector2).addVectors(this.min,this.max).multiplyScalar(0.5)},size:function(a){return(a||new THREE.Vector2).subVectors(this.max,this.min)},expandByPoint:function(a){this.min.min(a);
this.max.max(a);return this},expandByVector:function(a){this.min.sub(a);this.max.add(a);return this},expandByScalar:function(a){this.min.addScalar(-a);this.max.addScalar(a);return this},containsPoint:function(a){return a.x<this.min.x||a.x>this.max.x||a.y<this.min.y||a.y>this.max.y?!1:!0},containsBox:function(a){return this.min.x<=a.min.x&&a.max.x<=this.max.x&&this.min.y<=a.min.y&&a.max.y<=this.max.y?!0:!1},getParameter:function(a){return new THREE.Vector2((a.x-this.min.x)/(this.max.x-this.min.x),
(a.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(a){return a.max.x<this.min.x||a.min.x>this.max.x||a.max.y<this.min.y||a.min.y>this.max.y?!1:!0},clampPoint:function(a,b){return(b||new THREE.Vector2).copy(a).clamp(this.min,this.max)},distanceToPoint:function(){var a=new THREE.Vector2;return function(b){return a.copy(b).clamp(this.min,this.max).sub(b).length()}}(),intersect:function(a){this.min.max(a.min);this.max.min(a.max);return this},union:function(a){this.min.min(a.min);this.max.max(a.max);
return this},translate:function(a){this.min.add(a);this.max.add(a);return this},equals:function(a){return a.min.equals(this.min)&&a.max.equals(this.max)},clone:function(){return(new THREE.Box2).copy(this)}};THREE.Box3=function(a,b){this.min=void 0!==a?a:new THREE.Vector3(Infinity,Infinity,Infinity);this.max=void 0!==b?b:new THREE.Vector3(-Infinity,-Infinity,-Infinity)};
THREE.Box3.prototype={constructor:THREE.Box3,set:function(a,b){this.min.copy(a);this.max.copy(b);return this},addPoint:function(a){a.x<this.min.x?this.min.x=a.x:a.x>this.max.x&&(this.max.x=a.x);a.y<this.min.y?this.min.y=a.y:a.y>this.max.y&&(this.max.y=a.y);a.z<this.min.z?this.min.z=a.z:a.z>this.max.z&&(this.max.z=a.z)},setFromPoints:function(a){if(0<a.length){var b=a[0];this.min.copy(b);this.max.copy(b);for(var b=1,c=a.length;b<c;b++)this.addPoint(a[b])}else this.makeEmpty();return this},setFromCenterAndSize:function(){var a=
new THREE.Vector3;return function(b,c){var d=a.copy(c).multiplyScalar(0.5);this.min.copy(b).sub(d);this.max.copy(b).add(d);return this}}(),setFromObject:function(){var a=new THREE.Vector3;return function(b){var c=this;b.updateMatrixWorld(!0);this.makeEmpty();b.traverse(function(b){if(void 0!==b.geometry&&void 0!==b.geometry.vertices)for(var e=b.geometry.vertices,f=0,h=e.length;f<h;f++)a.copy(e[f]),a.applyMatrix4(b.matrixWorld),c.expandByPoint(a)});return this}}(),copy:function(a){this.min.copy(a.min);
this.max.copy(a.max);return this},makeEmpty:function(){this.min.x=this.min.y=this.min.z=Infinity;this.max.x=this.max.y=this.max.z=-Infinity;return this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(a){return(a||new THREE.Vector3).addVectors(this.min,this.max).multiplyScalar(0.5)},size:function(a){return(a||new THREE.Vector3).subVectors(this.max,this.min)},expandByPoint:function(a){this.min.min(a);this.max.max(a);return this},expandByVector:function(a){this.min.sub(a);
this.max.add(a);return this},expandByScalar:function(a){this.min.addScalar(-a);this.max.addScalar(a);return this},containsPoint:function(a){return a.x<this.min.x||a.x>this.max.x||a.y<this.min.y||a.y>this.max.y||a.z<this.min.z||a.z>this.max.z?!1:!0},containsBox:function(a){return this.min.x<=a.min.x&&a.max.x<=this.max.x&&this.min.y<=a.min.y&&a.max.y<=this.max.y&&this.min.z<=a.min.z&&a.max.z<=this.max.z?!0:!1},getParameter:function(a){return new THREE.Vector3((a.x-this.min.x)/(this.max.x-this.min.x),
(a.y-this.min.y)/(this.max.y-this.min.y),(a.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(a){return a.max.x<this.min.x||a.min.x>this.max.x||a.max.y<this.min.y||a.min.y>this.max.y||a.max.z<this.min.z||a.min.z>this.max.z?!1:!0},clampPoint:function(a,b){return(b||new THREE.Vector3).copy(a).clamp(this.min,this.max)},distanceToPoint:function(){var a=new THREE.Vector3;return function(b){return a.copy(b).clamp(this.min,this.max).sub(b).length()}}(),getBoundingSphere:function(){var a=
new THREE.Vector3;return function(b){b=b||new THREE.Sphere;b.center=this.center();b.radius=0.5*this.size(a).length();return b}}(),intersect:function(a){this.min.max(a.min);this.max.min(a.max);return this},union:function(a){this.min.min(a.min);this.max.max(a.max);return this},applyMatrix4:function(){var a=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];return function(b){a[0].set(this.min.x,this.min.y,
this.min.z).applyMatrix4(b);a[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(b);a[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(b);a[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(b);a[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(b);a[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(b);a[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(b);a[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(b);this.makeEmpty();this.setFromPoints(a);return this}}(),translate:function(a){this.min.add(a);
this.max.add(a);return this},equals:function(a){return a.min.equals(this.min)&&a.max.equals(this.max)},clone:function(){return(new THREE.Box3).copy(this)}};THREE.Matrix3=function(a,b,c,d,e,f,h,g,i){this.elements=new Float32Array(9);this.set(void 0!==a?a:1,b||0,c||0,d||0,void 0!==e?e:1,f||0,h||0,g||0,void 0!==i?i:1)};
THREE.Matrix3.prototype={constructor:THREE.Matrix3,set:function(a,b,c,d,e,f,h,g,i){var k=this.elements;k[0]=a;k[3]=b;k[6]=c;k[1]=d;k[4]=e;k[7]=f;k[2]=h;k[5]=g;k[8]=i;return this},identity:function(){this.set(1,0,0,0,1,0,0,0,1);return this},copy:function(a){a=a.elements;this.set(a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]);return this},multiplyVector3:function(a){console.warn("DEPRECATED: Matrix3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead.");return a.applyMatrix3(this)},
multiplyVector3Array:function(){var a=new THREE.Vector3;return function(b){for(var c=0,d=b.length;c<d;c+=3)a.x=b[c],a.y=b[c+1],a.z=b[c+2],a.applyMatrix3(this),b[c]=a.x,b[c+1]=a.y,b[c+2]=a.z;return b}}(),multiplyScalar:function(a){var b=this.elements;b[0]*=a;b[3]*=a;b[6]*=a;b[1]*=a;b[4]*=a;b[7]*=a;b[2]*=a;b[5]*=a;b[8]*=a;return this},determinant:function(){var a=this.elements,b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],h=a[5],g=a[6],i=a[7],a=a[8];return b*f*a-b*h*i-c*e*a+c*h*g+d*e*i-d*f*g},getInverse:function(a,
b){var c=a.elements,d=this.elements;d[0]=c[10]*c[5]-c[6]*c[9];d[1]=-c[10]*c[1]+c[2]*c[9];d[2]=c[6]*c[1]-c[2]*c[5];d[3]=-c[10]*c[4]+c[6]*c[8];d[4]=c[10]*c[0]-c[2]*c[8];d[5]=-c[6]*c[0]+c[2]*c[4];d[6]=c[9]*c[4]-c[5]*c[8];d[7]=-c[9]*c[0]+c[1]*c[8];d[8]=c[5]*c[0]-c[1]*c[4];c=c[0]*d[0]+c[1]*d[3]+c[2]*d[6];if(0===c){if(b)throw Error("Matrix3.getInverse(): can't invert matrix, determinant is 0");console.warn("Matrix3.getInverse(): can't invert matrix, determinant is 0");this.identity();return this}this.multiplyScalar(1/
c);return this},transpose:function(){var a,b=this.elements;a=b[1];b[1]=b[3];b[3]=a;a=b[2];b[2]=b[6];b[6]=a;a=b[5];b[5]=b[7];b[7]=a;return this},getNormalMatrix:function(a){this.getInverse(a).transpose();return this},transposeIntoArray:function(a){var b=this.elements;a[0]=b[0];a[1]=b[3];a[2]=b[6];a[3]=b[1];a[4]=b[4];a[5]=b[7];a[6]=b[2];a[7]=b[5];a[8]=b[8];return this},clone:function(){var a=this.elements;return new THREE.Matrix3(a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8])}};THREE.Matrix4=function(a,b,c,d,e,f,h,g,i,k,l,m,p,t,q,n){var r=this.elements=new Float32Array(16);r[0]=void 0!==a?a:1;r[4]=b||0;r[8]=c||0;r[12]=d||0;r[1]=e||0;r[5]=void 0!==f?f:1;r[9]=h||0;r[13]=g||0;r[2]=i||0;r[6]=k||0;r[10]=void 0!==l?l:1;r[14]=m||0;r[3]=p||0;r[7]=t||0;r[11]=q||0;r[15]=void 0!==n?n:1};
THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(a,b,c,d,e,f,h,g,i,k,l,m,p,t,q,n){var r=this.elements;r[0]=a;r[4]=b;r[8]=c;r[12]=d;r[1]=e;r[5]=f;r[9]=h;r[13]=g;r[2]=i;r[6]=k;r[10]=l;r[14]=m;r[3]=p;r[7]=t;r[11]=q;r[15]=n;return this},identity:function(){this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return this},copy:function(a){this.elements.set(a.elements);return this},extractPosition:function(a){console.warn("DEPRECATED: Matrix4's .extractPosition() has been renamed to .copyPosition().");
return this.copyPosition(a)},copyPosition:function(a){var b=this.elements,a=a.elements;b[12]=a[12];b[13]=a[13];b[14]=a[14];return this},extractRotation:function(){var a=new THREE.Vector3;return function(b){var c=this.elements,b=b.elements,d=1/a.set(b[0],b[1],b[2]).length(),e=1/a.set(b[4],b[5],b[6]).length(),f=1/a.set(b[8],b[9],b[10]).length();c[0]=b[0]*d;c[1]=b[1]*d;c[2]=b[2]*d;c[4]=b[4]*e;c[5]=b[5]*e;c[6]=b[6]*e;c[8]=b[8]*f;c[9]=b[9]*f;c[10]=b[10]*f;return this}}(),makeRotationFromEuler:function(a){!1===
a instanceof THREE.Euler&&console.error("ERROR: Matrix's .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code.");var b=this.elements,c=a.x,d=a.y,e=a.z,f=Math.cos(c),c=Math.sin(c),h=Math.cos(d),d=Math.sin(d),g=Math.cos(e),e=Math.sin(e);if("XYZ"===a.order){var a=f*g,i=f*e,k=c*g,l=c*e;b[0]=h*g;b[4]=-h*e;b[8]=d;b[1]=i+k*d;b[5]=a-l*d;b[9]=-c*h;b[2]=l-a*d;b[6]=k+i*d;b[10]=f*h}else"YXZ"===a.order?(a=h*g,i=h*e,k=d*g,l=d*e,b[0]=a+l*c,b[4]=k*c-i,b[8]=
f*d,b[1]=f*e,b[5]=f*g,b[9]=-c,b[2]=i*c-k,b[6]=l+a*c,b[10]=f*h):"ZXY"===a.order?(a=h*g,i=h*e,k=d*g,l=d*e,b[0]=a-l*c,b[4]=-f*e,b[8]=k+i*c,b[1]=i+k*c,b[5]=f*g,b[9]=l-a*c,b[2]=-f*d,b[6]=c,b[10]=f*h):"ZYX"===a.order?(a=f*g,i=f*e,k=c*g,l=c*e,b[0]=h*g,b[4]=k*d-i,b[8]=a*d+l,b[1]=h*e,b[5]=l*d+a,b[9]=i*d-k,b[2]=-d,b[6]=c*h,b[10]=f*h):"YZX"===a.order?(a=f*h,i=f*d,k=c*h,l=c*d,b[0]=h*g,b[4]=l-a*e,b[8]=k*e+i,b[1]=e,b[5]=f*g,b[9]=-c*g,b[2]=-d*g,b[6]=i*e+k,b[10]=a-l*e):"XZY"===a.order&&(a=f*h,i=f*d,k=c*h,l=c*d,b[0]=
h*g,b[4]=-e,b[8]=d*g,b[1]=a*e+l,b[5]=f*g,b[9]=i*e-k,b[2]=k*e-i,b[6]=c*g,b[10]=l*e+a);b[3]=0;b[7]=0;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return this},setRotationFromQuaternion:function(a){console.warn("DEPRECATED: Matrix4's .setRotationFromQuaternion() has been deprecated in favor of makeRotationFromQuaternion.  Please update your code.");return this.makeRotationFromQuaternion(a)},makeRotationFromQuaternion:function(a){var b=this.elements,c=a.x,d=a.y,e=a.z,f=a.w,h=c+c,g=d+d,i=e+e,a=c*h,k=c*g,c=
c*i,l=d*g,d=d*i,e=e*i,h=f*h,g=f*g,f=f*i;b[0]=1-(l+e);b[4]=k-f;b[8]=c+g;b[1]=k+f;b[5]=1-(a+e);b[9]=d-h;b[2]=c-g;b[6]=d+h;b[10]=1-(a+l);b[3]=0;b[7]=0;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return this},lookAt:function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3;return function(d,e,f){var h=this.elements;c.subVectors(d,e).normalize();0===c.length()&&(c.z=1);a.crossVectors(f,c).normalize();0===a.length()&&(c.x+=1E-4,a.crossVectors(f,c).normalize());b.crossVectors(c,a);h[0]=a.x;
h[4]=b.x;h[8]=c.x;h[1]=a.y;h[5]=b.y;h[9]=c.y;h[2]=a.z;h[6]=b.z;h[10]=c.z;return this}}(),multiply:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(a,b)):this.multiplyMatrices(this,a)},multiplyMatrices:function(a,b){var c=a.elements,d=b.elements,e=this.elements,f=c[0],h=c[4],g=c[8],i=c[12],k=c[1],l=c[5],m=c[9],p=c[13],t=c[2],q=c[6],n=c[10],r=c[14],s=c[3],u=c[7],x=c[11],c=c[15],
v=d[0],D=d[4],z=d[8],C=d[12],A=d[1],y=d[5],M=d[9],E=d[13],J=d[2],P=d[6],F=d[10],B=d[14],w=d[3],R=d[7],L=d[11],d=d[15];e[0]=f*v+h*A+g*J+i*w;e[4]=f*D+h*y+g*P+i*R;e[8]=f*z+h*M+g*F+i*L;e[12]=f*C+h*E+g*B+i*d;e[1]=k*v+l*A+m*J+p*w;e[5]=k*D+l*y+m*P+p*R;e[9]=k*z+l*M+m*F+p*L;e[13]=k*C+l*E+m*B+p*d;e[2]=t*v+q*A+n*J+r*w;e[6]=t*D+q*y+n*P+r*R;e[10]=t*z+q*M+n*F+r*L;e[14]=t*C+q*E+n*B+r*d;e[3]=s*v+u*A+x*J+c*w;e[7]=s*D+u*y+x*P+c*R;e[11]=s*z+u*M+x*F+c*L;e[15]=s*C+u*E+x*B+c*d;return this},multiplyToArray:function(a,b,
c){var d=this.elements;this.multiplyMatrices(a,b);c[0]=d[0];c[1]=d[1];c[2]=d[2];c[3]=d[3];c[4]=d[4];c[5]=d[5];c[6]=d[6];c[7]=d[7];c[8]=d[8];c[9]=d[9];c[10]=d[10];c[11]=d[11];c[12]=d[12];c[13]=d[13];c[14]=d[14];c[15]=d[15];return this},multiplyScalar:function(a){var b=this.elements;b[0]*=a;b[4]*=a;b[8]*=a;b[12]*=a;b[1]*=a;b[5]*=a;b[9]*=a;b[13]*=a;b[2]*=a;b[6]*=a;b[10]*=a;b[14]*=a;b[3]*=a;b[7]*=a;b[11]*=a;b[15]*=a;return this},multiplyVector3:function(a){console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead.");
return a.applyProjection(this)},multiplyVector4:function(a){console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead.");return a.applyMatrix4(this)},multiplyVector3Array:function(){var a=new THREE.Vector3;return function(b){for(var c=0,d=b.length;c<d;c+=3)a.x=b[c],a.y=b[c+1],a.z=b[c+2],a.applyProjection(this),b[c]=a.x,b[c+1]=a.y,b[c+2]=a.z;return b}}(),rotateAxis:function(a){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead.");
a.transformDirection(this)},crossVector:function(a){console.warn("DEPRECATED: Matrix4's .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead.");return a.applyMatrix4(this)},determinant:function(){var a=this.elements,b=a[0],c=a[4],d=a[8],e=a[12],f=a[1],h=a[5],g=a[9],i=a[13],k=a[2],l=a[6],m=a[10],p=a[14];return a[3]*(+e*g*l-d*i*l-e*h*m+c*i*m+d*h*p-c*g*p)+a[7]*(+b*g*p-b*i*m+e*f*m-d*f*p+d*i*k-e*g*k)+a[11]*(+b*i*l-b*h*p-e*f*l+c*f*p+e*h*k-c*i*k)+a[15]*(-d*h*k-b*g*l+b*h*m+d*f*l-c*f*
m+c*g*k)},transpose:function(){var a=this.elements,b;b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[3];a[3]=a[12];a[12]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return this},flattenToArray:function(a){var b=this.elements;a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15];return a},flattenToArrayOffset:function(a,b){var c=this.elements;
a[b]=c[0];a[b+1]=c[1];a[b+2]=c[2];a[b+3]=c[3];a[b+4]=c[4];a[b+5]=c[5];a[b+6]=c[6];a[b+7]=c[7];a[b+8]=c[8];a[b+9]=c[9];a[b+10]=c[10];a[b+11]=c[11];a[b+12]=c[12];a[b+13]=c[13];a[b+14]=c[14];a[b+15]=c[15];return a},getPosition:function(){var a=new THREE.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var b=this.elements;return a.set(b[12],b[13],b[14])}}(),setPosition:function(a){var b=this.elements;
b[12]=a.x;b[13]=a.y;b[14]=a.z;return this},getInverse:function(a,b){var c=this.elements,d=a.elements,e=d[0],f=d[4],h=d[8],g=d[12],i=d[1],k=d[5],l=d[9],m=d[13],p=d[2],t=d[6],q=d[10],n=d[14],r=d[3],s=d[7],u=d[11],d=d[15];c[0]=l*n*s-m*q*s+m*t*u-k*n*u-l*t*d+k*q*d;c[4]=g*q*s-h*n*s-g*t*u+f*n*u+h*t*d-f*q*d;c[8]=h*m*s-g*l*s+g*k*u-f*m*u-h*k*d+f*l*d;c[12]=g*l*t-h*m*t-g*k*q+f*m*q+h*k*n-f*l*n;c[1]=m*q*r-l*n*r-m*p*u+i*n*u+l*p*d-i*q*d;c[5]=h*n*r-g*q*r+g*p*u-e*n*u-h*p*d+e*q*d;c[9]=g*l*r-h*m*r-g*i*u+e*m*u+h*i*d-
e*l*d;c[13]=h*m*p-g*l*p+g*i*q-e*m*q-h*i*n+e*l*n;c[2]=k*n*r-m*t*r+m*p*s-i*n*s-k*p*d+i*t*d;c[6]=g*t*r-f*n*r-g*p*s+e*n*s+f*p*d-e*t*d;c[10]=f*m*r-g*k*r+g*i*s-e*m*s-f*i*d+e*k*d;c[14]=g*k*p-f*m*p-g*i*t+e*m*t+f*i*n-e*k*n;c[3]=l*t*r-k*q*r-l*p*s+i*q*s+k*p*u-i*t*u;c[7]=f*q*r-h*t*r+h*p*s-e*q*s-f*p*u+e*t*u;c[11]=h*k*r-f*l*r-h*i*s+e*l*s+f*i*u-e*k*u;c[15]=f*l*p-h*k*p+h*i*t-e*l*t-f*i*q+e*k*q;c=e*c[0]+i*c[4]+p*c[8]+r*c[12];if(0==c){if(b)throw Error("Matrix4.getInverse(): can't invert matrix, determinant is 0");console.warn("Matrix4.getInverse(): can't invert matrix, determinant is 0");
this.identity();return this}this.multiplyScalar(1/c);return this},translate:function(){console.warn("DEPRECATED: Matrix4's .translate() has been removed.")},rotateX:function(){console.warn("DEPRECATED: Matrix4's .rotateX() has been removed.")},rotateY:function(){console.warn("DEPRECATED: Matrix4's .rotateY() has been removed.")},rotateZ:function(){console.warn("DEPRECATED: Matrix4's .rotateZ() has been removed.")},rotateByAxis:function(){console.warn("DEPRECATED: Matrix4's .rotateByAxis() has been removed.")},
scale:function(a){var b=this.elements,c=a.x,d=a.y,a=a.z;b[0]*=c;b[4]*=d;b[8]*=a;b[1]*=c;b[5]*=d;b[9]*=a;b[2]*=c;b[6]*=d;b[10]*=a;b[3]*=c;b[7]*=d;b[11]*=a;return this},getMaxScaleOnAxis:function(){var a=this.elements;return Math.sqrt(Math.max(a[0]*a[0]+a[1]*a[1]+a[2]*a[2],Math.max(a[4]*a[4]+a[5]*a[5]+a[6]*a[6],a[8]*a[8]+a[9]*a[9]+a[10]*a[10])))},makeTranslation:function(a,b,c){this.set(1,0,0,a,0,1,0,b,0,0,1,c,0,0,0,1);return this},makeRotationX:function(a){var b=Math.cos(a),a=Math.sin(a);this.set(1,
0,0,0,0,b,-a,0,0,a,b,0,0,0,0,1);return this},makeRotationY:function(a){var b=Math.cos(a),a=Math.sin(a);this.set(b,0,a,0,0,1,0,0,-a,0,b,0,0,0,0,1);return this},makeRotationZ:function(a){var b=Math.cos(a),a=Math.sin(a);this.set(b,-a,0,0,a,b,0,0,0,0,1,0,0,0,0,1);return this},makeRotationAxis:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=1-c,f=a.x,h=a.y,g=a.z,i=e*f,k=e*h;this.set(i*f+c,i*h-d*g,i*g+d*h,0,i*h+d*g,k*h+c,k*g-d*f,0,i*g-d*h,k*g+d*f,e*g*g+c,0,0,0,0,1);return this},makeScale:function(a,b,c){this.set(a,
0,0,0,0,b,0,0,0,0,c,0,0,0,0,1);return this},compose:function(a,b,c){this.makeRotationFromQuaternion(b);this.scale(c);this.setPosition(a);return this},decompose:function(){var a=new THREE.Vector3,b=new THREE.Matrix4;return function(c,d,e){var f=this.elements,h=a.set(f[0],f[1],f[2]).length(),g=a.set(f[4],f[5],f[6]).length(),i=a.set(f[8],f[9],f[10]).length();c.x=f[12];c.y=f[13];c.z=f[14];b.elements.set(this.elements);var c=1/h,f=1/g,k=1/i;b.elements[0]*=c;b.elements[1]*=c;b.elements[2]*=c;b.elements[4]*=
f;b.elements[5]*=f;b.elements[6]*=f;b.elements[8]*=k;b.elements[9]*=k;b.elements[10]*=k;d.setFromRotationMatrix(b);e.x=h;e.y=g;e.z=i;return this}}(),makeFrustum:function(a,b,c,d,e,f){var h=this.elements;h[0]=2*e/(b-a);h[4]=0;h[8]=(b+a)/(b-a);h[12]=0;h[1]=0;h[5]=2*e/(d-c);h[9]=(d+c)/(d-c);h[13]=0;h[2]=0;h[6]=0;h[10]=-(f+e)/(f-e);h[14]=-2*f*e/(f-e);h[3]=0;h[7]=0;h[11]=-1;h[15]=0;return this},makePerspective:function(a,b,c,d){var a=c*Math.tan(THREE.Math.degToRad(0.5*a)),e=-a;return this.makeFrustum(e*
b,a*b,e,a,c,d)},makeOrthographic:function(a,b,c,d,e,f){var h=this.elements,g=b-a,i=c-d,k=f-e;h[0]=2/g;h[4]=0;h[8]=0;h[12]=-((b+a)/g);h[1]=0;h[5]=2/i;h[9]=0;h[13]=-((c+d)/i);h[2]=0;h[6]=0;h[10]=-2/k;h[14]=-((f+e)/k);h[3]=0;h[7]=0;h[11]=0;h[15]=1;return this},fromArray:function(a){this.elements.set(a);return this},toArray:function(){var a=this.elements;return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]},clone:function(){var a=this.elements;return new THREE.Matrix4(a[0],
a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15])}};THREE.Ray=function(a,b){this.origin=void 0!==a?a:new THREE.Vector3;this.direction=void 0!==b?b:new THREE.Vector3};
THREE.Ray.prototype={constructor:THREE.Ray,set:function(a,b){this.origin.copy(a);this.direction.copy(b);return this},copy:function(a){this.origin.copy(a.origin);this.direction.copy(a.direction);return this},at:function(a,b){return(b||new THREE.Vector3).copy(this.direction).multiplyScalar(a).add(this.origin)},recast:function(){var a=new THREE.Vector3;return function(b){this.origin.copy(this.at(b,a));return this}}(),closestPointToPoint:function(a,b){var c=b||new THREE.Vector3;c.subVectors(a,this.origin);
var d=c.dot(this.direction);return 0>d?c.copy(this.origin):c.copy(this.direction).multiplyScalar(d).add(this.origin)},distanceToPoint:function(){var a=new THREE.Vector3;return function(b){var c=a.subVectors(b,this.origin).dot(this.direction);if(0>c)return this.origin.distanceTo(b);a.copy(this.direction).multiplyScalar(c).add(this.origin);return a.distanceTo(b)}}(),distanceSqToSegment:function(a,b,c,d){var e=a.clone().add(b).multiplyScalar(0.5),f=b.clone().sub(a).normalize(),h=0.5*a.distanceTo(b),
g=this.origin.clone().sub(e),a=-this.direction.dot(f),b=g.dot(this.direction),i=-g.dot(f),k=g.lengthSq(),l=Math.abs(1-a*a),m,p;0<=l?(g=a*i-b,m=a*b-i,p=h*l,0<=g?m>=-p?m<=p?(h=1/l,g*=h,m*=h,a=g*(g+a*m+2*b)+m*(a*g+m+2*i)+k):(m=h,g=Math.max(0,-(a*m+b)),a=-g*g+m*(m+2*i)+k):(m=-h,g=Math.max(0,-(a*m+b)),a=-g*g+m*(m+2*i)+k):m<=-p?(g=Math.max(0,-(-a*h+b)),m=0<g?-h:Math.min(Math.max(-h,-i),h),a=-g*g+m*(m+2*i)+k):m<=p?(g=0,m=Math.min(Math.max(-h,-i),h),a=m*(m+2*i)+k):(g=Math.max(0,-(a*h+b)),m=0<g?h:Math.min(Math.max(-h,
-i),h),a=-g*g+m*(m+2*i)+k)):(m=0<a?-h:h,g=Math.max(0,-(a*m+b)),a=-g*g+m*(m+2*i)+k);c&&c.copy(this.direction.clone().multiplyScalar(g).add(this.origin));d&&d.copy(f.clone().multiplyScalar(m).add(e));return a},isIntersectionSphere:function(a){return this.distanceToPoint(a.center)<=a.radius},isIntersectionPlane:function(a){var b=a.distanceToPoint(this.origin);return 0===b||0>a.normal.dot(this.direction)*b?!0:!1},distanceToPlane:function(a){var b=a.normal.dot(this.direction);if(0==b)return 0==a.distanceToPoint(this.origin)?
0:null;a=-(this.origin.dot(a.normal)+a.constant)/b;return 0<=a?a:null},intersectPlane:function(a,b){var c=this.distanceToPlane(a);return null===c?null:this.at(c,b)},isIntersectionBox:function(){var a=new THREE.Vector3;return function(b){return null!==this.intersectBox(b,a)}}(),intersectBox:function(){console.log("Error: intersectBox has been removed due to license issue from this build")},intersectTriangle:function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3,d=new THREE.Vector3;
return function(e,f,h,g,i){b.subVectors(f,e);c.subVectors(h,e);d.crossVectors(b,c);f=this.direction.dot(d);if(0<f){if(g)return null;g=1}else if(0>f)g=-1,f=-f;else return null;a.subVectors(this.origin,e);e=g*this.direction.dot(c.crossVectors(a,c));if(0>e)return null;h=g*this.direction.dot(b.cross(a));if(0>h||e+h>f)return null;e=-g*a.dot(d);return 0>e?null:this.at(e/f,i)}}(),applyMatrix4:function(a){this.direction.add(this.origin).applyMatrix4(a);this.origin.applyMatrix4(a);this.direction.sub(this.origin);
this.direction.normalize();return this},equals:function(a){return a.origin.equals(this.origin)&&a.direction.equals(this.direction)},clone:function(){return(new THREE.Ray).copy(this)}};THREE.Sphere=function(a,b){this.center=void 0!==a?a:new THREE.Vector3;this.radius=void 0!==b?b:0};
THREE.Sphere.prototype={constructor:THREE.Sphere,set:function(a,b){this.center.copy(a);this.radius=b;return this},setFromPoints:function(){var a=new THREE.Box3;return function(b,c){var d=this.center;void 0!==c?d.copy(c):a.setFromPoints(b).center(d);for(var e=0,f=0,h=b.length;f<h;f++)e=Math.max(e,d.distanceToSquared(b[f]));this.radius=Math.sqrt(e);return this}}(),copy:function(a){this.center.copy(a.center);this.radius=a.radius;return this},empty:function(){return 0>=this.radius},containsPoint:function(a){return a.distanceToSquared(this.center)<=
this.radius*this.radius},distanceToPoint:function(a){return a.distanceTo(this.center)-this.radius},intersectsSphere:function(a){var b=this.radius+a.radius;return a.center.distanceToSquared(this.center)<=b*b},clampPoint:function(a,b){var c=this.center.distanceToSquared(a),d=b||new THREE.Vector3;d.copy(a);c>this.radius*this.radius&&(d.sub(this.center).normalize(),d.multiplyScalar(this.radius).add(this.center));return d},getBoundingBox:function(a){a=a||new THREE.Box3;a.set(this.center,this.center);a.expandByScalar(this.radius);
return a},applyMatrix4:function(a){this.center.applyMatrix4(a);this.radius*=a.getMaxScaleOnAxis();return this},translate:function(a){this.center.add(a);return this},equals:function(a){return a.center.equals(this.center)&&a.radius===this.radius},clone:function(){return(new THREE.Sphere).copy(this)}};THREE.Frustum=function(a,b,c,d,e,f){this.planes=[void 0!==a?a:new THREE.Plane,void 0!==b?b:new THREE.Plane,void 0!==c?c:new THREE.Plane,void 0!==d?d:new THREE.Plane,void 0!==e?e:new THREE.Plane,void 0!==f?f:new THREE.Plane]};
THREE.Frustum.prototype={constructor:THREE.Frustum,set:function(a,b,c,d,e,f){var h=this.planes;h[0].copy(a);h[1].copy(b);h[2].copy(c);h[3].copy(d);h[4].copy(e);h[5].copy(f);return this},copy:function(a){for(var b=this.planes,c=0;6>c;c++)b[c].copy(a.planes[c]);return this},setFromMatrix:function(a){var b=this.planes,c=a.elements,a=c[0],d=c[1],e=c[2],f=c[3],h=c[4],g=c[5],i=c[6],k=c[7],l=c[8],m=c[9],p=c[10],t=c[11],q=c[12],n=c[13],r=c[14],c=c[15];b[0].setComponents(f-a,k-h,t-l,c-q).normalize();b[1].setComponents(f+
a,k+h,t+l,c+q).normalize();b[2].setComponents(f+d,k+g,t+m,c+n).normalize();b[3].setComponents(f-d,k-g,t-m,c-n).normalize();b[4].setComponents(f-e,k-i,t-p,c-r).normalize();b[5].setComponents(f+e,k+i,t+p,c+r).normalize();return this},intersectsObject:function(){var a=new THREE.Sphere;return function(b){var c=b.geometry;null===c.boundingSphere&&c.computeBoundingSphere();a.copy(c.boundingSphere);a.applyMatrix4(b.matrixWorld);return this.intersectsSphere(a)}}(),intersectsSphere:function(a){for(var b=this.planes,
c=a.center,a=-a.radius,d=0;6>d;d++)if(b[d].distanceToPoint(c)<a)return!1;return!0},intersectsBox:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c){for(var d=this.planes,e=0;6>e;e++){var f=d[e];a.x=0<f.normal.x?c.min.x:c.max.x;b.x=0<f.normal.x?c.max.x:c.min.x;a.y=0<f.normal.y?c.min.y:c.max.y;b.y=0<f.normal.y?c.max.y:c.min.y;a.z=0<f.normal.z?c.min.z:c.max.z;b.z=0<f.normal.z?c.max.z:c.min.z;var h=f.distanceToPoint(a),f=f.distanceToPoint(b);if(0>h&&0>f)return!1}return!0}}(),containsPoint:function(a){for(var b=
this.planes,c=0;6>c;c++)if(0>b[c].distanceToPoint(a))return!1;return!0},clone:function(){return(new THREE.Frustum).copy(this)}};THREE.Plane=function(a,b){this.normal=void 0!==a?a:new THREE.Vector3(1,0,0);this.constant=void 0!==b?b:0};
THREE.Plane.prototype={constructor:THREE.Plane,set:function(a,b){this.normal.copy(a);this.constant=b;return this},setComponents:function(a,b,c,d){this.normal.set(a,b,c);this.constant=d;return this},setFromNormalAndCoplanarPoint:function(a,b){this.normal.copy(a);this.constant=-b.dot(this.normal);return this},setFromCoplanarPoints:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c,d,e){d=a.subVectors(e,d).cross(b.subVectors(c,d)).normalize();this.setFromNormalAndCoplanarPoint(d,
c);return this}}(),copy:function(a){this.normal.copy(a.normal);this.constant=a.constant;return this},normalize:function(){var a=1/this.normal.length();this.normal.multiplyScalar(a);this.constant*=a;return this},negate:function(){this.constant*=-1;this.normal.negate();return this},distanceToPoint:function(a){return this.normal.dot(a)+this.constant},distanceToSphere:function(a){return this.distanceToPoint(a.center)-a.radius},projectPoint:function(a,b){return this.orthoPoint(a,b).sub(a).negate()},orthoPoint:function(a,
b){var c=this.distanceToPoint(a);return(b||new THREE.Vector3).copy(this.normal).multiplyScalar(c)},isIntersectionLine:function(a){var b=this.distanceToPoint(a.start),a=this.distanceToPoint(a.end);return 0>b&&0<a||0>a&&0<b},intersectLine:function(){var a=new THREE.Vector3;return function(b,c){var d=c||new THREE.Vector3,e=b.delta(a),f=this.normal.dot(e);if(0==f){if(0==this.distanceToPoint(b.start))return d.copy(b.start)}else return f=-(b.start.dot(this.normal)+this.constant)/f,0>f||1<f?void 0:d.copy(e).multiplyScalar(f).add(b.start)}}(),
coplanarPoint:function(a){return(a||new THREE.Vector3).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c,d){var d=d||(new THREE.Matrix3).getNormalMatrix(c),e=a.copy(this.normal).applyMatrix3(d),f=this.coplanarPoint(b);f.applyMatrix4(c);this.setFromNormalAndCoplanarPoint(e,f);return this}}(),translate:function(a){this.constant-=a.dot(this.normal);return this},equals:function(a){return a.normal.equals(this.normal)&&
a.constant==this.constant},clone:function(){return(new THREE.Plane).copy(this)}};THREE.Math={PI2:2*Math.PI,generateUUID:function(){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),b=Array(36),c=0,d;return function(){for(var e=0;36>e;e++)8==e||13==e||18==e||23==e?b[e]="-":14==e?b[e]="4":(2>=c&&(c=33554432+16777216*Math.random()|0),d=c&15,c>>=4,b[e]=a[19==e?d&3|8:d]);return b.join("")}}(),clamp:function(a,b,c){return a<b?b:a>c?c:a},clampBottom:function(a,b){return a<b?b:a},mapLinear:function(a,b,c,d,e){return d+(a-b)*(e-d)/(c-b)},smoothstep:function(a,
b,c){if(a<=b)return 0;if(a>=c)return 1;a=(a-b)/(c-b);return a*a*(3-2*a)},smootherstep:function(a,b,c){if(a<=b)return 0;if(a>=c)return 1;a=(a-b)/(c-b);return a*a*a*(a*(6*a-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(a,b){return a+Math.floor(Math.random()*(b-a+1))},randFloat:function(a,b){return a+Math.random()*(b-a)},randFloatSpread:function(a){return a*(0.5-Math.random())},sign:function(a){return 0>a?-1:0<a?1:0},degToRad:function(){var a=Math.PI/
180;return function(b){return b*a}}(),radToDeg:function(){var a=180/Math.PI;return function(b){return b*a}}()};THREE.Spline=function(a){function b(a,b,c,d,e,f,h){a=0.5*(c-a);d=0.5*(d-b);return(2*(b-c)+a+d)*h+(-3*(b-c)-2*a-d)*f+a*e+b}this.points=a;var c=[],d={x:0,y:0,z:0},e,f,h,g,i,k,l,m,p;this.initFromArray=function(a){this.points=[];for(var b=0;b<a.length;b++)this.points[b]={x:a[b][0],y:a[b][1],z:a[b][2]}};this.getPoint=function(a){e=(this.points.length-1)*a;f=Math.floor(e);h=e-f;c[0]=0===f?f:f-1;c[1]=f;c[2]=f>this.points.length-2?this.points.length-1:f+1;c[3]=f>this.points.length-3?this.points.length-1:
f+2;k=this.points[c[0]];l=this.points[c[1]];m=this.points[c[2]];p=this.points[c[3]];g=h*h;i=h*g;d.x=b(k.x,l.x,m.x,p.x,h,g,i);d.y=b(k.y,l.y,m.y,p.y,h,g,i);d.z=b(k.z,l.z,m.z,p.z,h,g,i);return d};this.getControlPointsArray=function(){var a,b,c=this.points.length,d=[];for(a=0;a<c;a++)b=this.points[a],d[a]=[b.x,b.y,b.z];return d};this.getLength=function(a){var b,c,d,e=b=b=0,f=new THREE.Vector3,h=new THREE.Vector3,g=[],i=0;g[0]=0;a||(a=100);c=this.points.length*a;f.copy(this.points[0]);for(a=1;a<c;a++)b=
a/c,d=this.getPoint(b),h.copy(d),i+=h.distanceTo(f),f.copy(d),b*=this.points.length-1,b=Math.floor(b),b!=e&&(g[b]=i,e=b);g[g.length]=i;return{chunks:g,total:i}};this.reparametrizeByArcLength=function(a){var b,c,d,e,f,h,g=[],i=new THREE.Vector3,k=this.getLength();g.push(i.copy(this.points[0]).clone());for(b=1;b<this.points.length;b++){c=k.chunks[b]-k.chunks[b-1];h=Math.ceil(a*c/k.total);e=(b-1)/(this.points.length-1);f=b/(this.points.length-1);for(c=1;c<h-1;c++)d=e+c*(1/h)*(f-e),d=this.getPoint(d),
g.push(i.copy(d).clone());g.push(i.copy(this.points[b]).clone())}this.points=g}};THREE.Triangle=function(a,b,c){this.a=void 0!==a?a:new THREE.Vector3;this.b=void 0!==b?b:new THREE.Vector3;this.c=void 0!==c?c:new THREE.Vector3};THREE.Triangle.normal=function(){var a=new THREE.Vector3;return function(b,c,d,e){e=e||new THREE.Vector3;e.subVectors(d,c);a.subVectors(b,c);e.cross(a);b=e.lengthSq();return 0<b?e.multiplyScalar(1/Math.sqrt(b)):e.set(0,0,0)}}();
THREE.Triangle.barycoordFromPoint=function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3;return function(d,e,f,h,g){a.subVectors(h,e);b.subVectors(f,e);c.subVectors(d,e);var d=a.dot(a),e=a.dot(b),f=a.dot(c),i=b.dot(b),h=b.dot(c),k=d*i-e*e,g=g||new THREE.Vector3;if(0==k)return g.set(-2,-1,-1);k=1/k;i=(i*f-e*h)*k;d=(d*h-e*f)*k;return g.set(1-i-d,d,i)}}();
THREE.Triangle.containsPoint=function(){var a=new THREE.Vector3;return function(b,c,d,e){b=THREE.Triangle.barycoordFromPoint(b,c,d,e,a);return 0<=b.x&&0<=b.y&&1>=b.x+b.y}}();
THREE.Triangle.prototype={constructor:THREE.Triangle,set:function(a,b,c){this.a.copy(a);this.b.copy(b);this.c.copy(c);return this},setFromPointsAndIndices:function(a,b,c,d){this.a.copy(a[b]);this.b.copy(a[c]);this.c.copy(a[d]);return this},copy:function(a){this.a.copy(a.a);this.b.copy(a.b);this.c.copy(a.c);return this},area:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(){a.subVectors(this.c,this.b);b.subVectors(this.a,this.b);return 0.5*a.cross(b).length()}}(),midpoint:function(a){return(a||
new THREE.Vector3).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(a){return THREE.Triangle.normal(this.a,this.b,this.c,a)},plane:function(a){return(a||new THREE.Plane).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(a,b){return THREE.Triangle.barycoordFromPoint(a,this.a,this.b,this.c,b)},containsPoint:function(a){return THREE.Triangle.containsPoint(a,this.a,this.b,this.c)},equals:function(a){return a.a.equals(this.a)&&a.b.equals(this.b)&&a.c.equals(this.c)},
clone:function(){return(new THREE.Triangle).copy(this)}};THREE.Vertex=function(a){console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead.");return a};THREE.UV=function(a,b){console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead.");return new THREE.Vector2(a,b)};THREE.Clock=function(a){this.autoStart=void 0!==a?a:!0;this.elapsedTime=this.oldTime=this.startTime=0;this.running=!1};
THREE.Clock.prototype={constructor:THREE.Clock,start:function(){this.oldTime=this.startTime=void 0!==self.performance&&void 0!==self.performance.now?self.performance.now():Date.now();this.running=!0},stop:function(){this.getElapsedTime();this.running=!1},getElapsedTime:function(){this.getDelta();return this.elapsedTime},getDelta:function(){var a=0;this.autoStart&&!this.running&&this.start();if(this.running){var b=void 0!==self.performance&&void 0!==self.performance.now?self.performance.now():Date.now(),
a=0.001*(b-this.oldTime);this.oldTime=b;this.elapsedTime+=a}return a}};THREE.EventDispatcher=function(){};
THREE.EventDispatcher.prototype={constructor:THREE.EventDispatcher,apply:function(a){a.addEventListener=THREE.EventDispatcher.prototype.addEventListener;a.hasEventListener=THREE.EventDispatcher.prototype.hasEventListener;a.removeEventListener=THREE.EventDispatcher.prototype.removeEventListener;a.dispatchEvent=THREE.EventDispatcher.prototype.dispatchEvent},addEventListener:function(a,b){void 0===this._listeners&&(this._listeners={});var c=this._listeners;void 0===c[a]&&(c[a]=[]);-1===c[a].indexOf(b)&&
c[a].push(b)},hasEventListener:function(a,b){if(void 0===this._listeners)return!1;var c=this._listeners;return void 0!==c[a]&&-1!==c[a].indexOf(b)?!0:!1},removeEventListener:function(a,b){if(void 0!==this._listeners){var c=this._listeners,d=c[a].indexOf(b);-1!==d&&c[a].splice(d,1)}},dispatchEvent:function(a){if(void 0!==this._listeners){var b=this._listeners[a.type];if(void 0!==b){a.target=this;for(var c=0,d=b.length;c<d;c++)b[c].call(this,a)}}}};(function(a){a.Raycaster=function(b,c,d,e){this.ray=new a.Ray(b,c);this.near=d||0;this.far=e||Infinity};var b=new a.Sphere,c=new a.Ray;new a.Plane;new a.Vector3;var d=new a.Vector3,e=new a.Matrix4,f=function(a,b){return a.distance-b.distance},h=new a.Vector3,g=new a.Vector3,i=new a.Vector3,k=function(f,l,t){if(f instanceof a.Particle){d.getPositionFromMatrix(f.matrixWorld);var q=l.ray.distanceToPoint(d);if(q>f.scale.x)return t;t.push({distance:q,point:f.position,face:null,object:f})}else if(f instanceof
a.LOD)d.getPositionFromMatrix(f.matrixWorld),q=l.ray.origin.distanceTo(d),k(f.getObjectForDistance(q),l,t);else if(f instanceof a.Mesh){var n=f.geometry;null===n.boundingSphere&&n.computeBoundingSphere();b.copy(n.boundingSphere);b.applyMatrix4(f.matrixWorld);if(!1===l.ray.isIntersectionSphere(b))return t;e.getInverse(f.matrixWorld);c.copy(l.ray).applyMatrix4(e);if(null!==n.boundingBox&&!1===c.isIntersectionBox(n.boundingBox))return t;if(n instanceof a.BufferGeometry){var r=f.material;if(void 0===
r||!1===n.dynamic)return t;var s,u,x=l.precision;if(void 0!==n.attributes.index)for(var v=n.offsets,D=n.attributes.index.array,z=n.attributes.position.array,C=n.offsets.length,A=n.attributes.index.array.length/3,A=0;A<C;++A)for(var q=v[A].start,y=v[A].index,n=q,M=q+v[A].count;n<M;n+=3)q=y+D[n],s=y+D[n+1],u=y+D[n+2],h.set(z[3*q],z[3*q+1],z[3*q+2]),g.set(z[3*s],z[3*s+1],z[3*s+2]),i.set(z[3*u],z[3*u+1],z[3*u+2]),s=c.intersectTriangle(h,g,i,r.side!==a.DoubleSide),null!==s&&(s.applyMatrix4(f.matrixWorld),
q=l.ray.origin.distanceTo(s),q<x||(q<l.near||q>l.far)||t.push({distance:q,point:s,face:null,faceIndex:null,object:f}));else{z=n.attributes.position.array;A=n.attributes.position.array.length;for(n=0;n<A;n+=3)q=n,s=n+1,u=n+2,h.set(z[3*q],z[3*q+1],z[3*q+2]),g.set(z[3*s],z[3*s+1],z[3*s+2]),i.set(z[3*u],z[3*u+1],z[3*u+2]),s=c.intersectTriangle(h,g,i,r.side!==a.DoubleSide),null!==s&&(s.applyMatrix4(f.matrixWorld),q=l.ray.origin.distanceTo(s),q<x||(q<l.near||q>l.far)||t.push({distance:q,point:s,face:null,
faceIndex:null,object:f}))}}else if(n instanceof a.Geometry){D=f.material instanceof a.MeshFaceMaterial;z=!0===D?f.material.materials:null;x=l.precision;v=n.vertices;C=0;for(A=n.faces.length;C<A;C++)y=n.faces[C],r=!0===D?z[y.materialIndex]:f.material,void 0!==r&&(q=v[y.a],s=v[y.b],u=v[y.c],s=c.intersectTriangle(q,s,u,r.side!==a.DoubleSide),null!==s&&(s.applyMatrix4(f.matrixWorld),q=l.ray.origin.distanceTo(s),q<x||(q<l.near||q>l.far)||t.push({distance:q,point:s,face:y,faceIndex:C,object:f})))}}else if(f instanceof
a.Line){x=l.linePrecision;r=x*x;n=f.geometry;null===n.boundingSphere&&n.computeBoundingSphere();b.copy(n.boundingSphere);b.applyMatrix4(f.matrixWorld);if(!1===l.ray.isIntersectionSphere(b))return t;e.getInverse(f.matrixWorld);c.copy(l.ray).applyMatrix4(e);if(n instanceof a.Geometry){v=n.vertices;x=v.length;s=new a.Vector3;u=new a.Vector3;A=f.type===a.LineStrip?1:2;for(n=0;n<x-1;n+=A)c.distanceSqToSegment(v[n],v[n+1],u,s)>r||(q=c.origin.distanceTo(u),q<l.near||q>l.far||t.push({distance:q,point:s.clone().applyMatrix4(f.matrixWorld),
face:null,faceIndex:null,object:f}))}}},l=function(a,b,c){for(var a=a.getDescendants(),d=0,e=a.length;d<e;d++)k(a[d],b,c)};a.Raycaster.prototype.precision=1E-4;a.Raycaster.prototype.linePrecision=1;a.Raycaster.prototype.set=function(a,b){this.ray.set(a,b)};a.Raycaster.prototype.intersectObject=function(a,b){var c=[];!0===b&&l(a,this,c);k(a,this,c);c.sort(f);return c};a.Raycaster.prototype.intersectObjects=function(a,b){for(var c=[],d=0,e=a.length;d<e;d++)k(a[d],this,c),!0===b&&l(a[d],this,c);c.sort(f);
return c}})(THREE);THREE.Object3D=function(){this.id=THREE.Object3DIdCount++;this.uuid=THREE.Math.generateUUID();this.name="";this.parent=void 0;this.children=[];this.up=new THREE.Vector3(0,1,0);this.position=new THREE.Vector3;this.rotation=new THREE.Euler;this.quaternion=new THREE.Quaternion;this.scale=new THREE.Vector3(1,1,1);this.rotation._quaternion=this.quaternion;this.quaternion._euler=this.rotation;this.renderDepth=null;this.rotationAutoUpdate=!0;this.matrix=new THREE.Matrix4;this.matrixWorld=new THREE.Matrix4;
this.visible=this.matrixWorldNeedsUpdate=this.matrixAutoUpdate=!0;this.receiveShadow=this.castShadow=!1;this.frustumCulled=!0;this.userData={}};
THREE.Object3D.prototype={constructor:THREE.Object3D,get eulerOrder(){console.warn("DEPRECATED: Object3D's .eulerOrder has been moved to Object3D's .rotation.order.");return this.rotation.order},set eulerOrder(a){console.warn("DEPRECATED: Object3D's .eulerOrder has been moved to Object3D's .rotation.order.");this.rotation.order=a},get useQuaternion(){console.warn("DEPRECATED: Object3D's .useQuaternion has been removed. The library now uses quaternions by default.")},set useQuaternion(a){console.warn("DEPRECATED: Object3D's .useQuaternion has been removed. The library now uses quaternions by default.")},
applyMatrix:function(){var a=new THREE.Matrix4;return function(b){this.matrix.multiplyMatrices(b,this.matrix);this.position.getPositionFromMatrix(this.matrix);this.scale.getScaleFromMatrix(this.matrix);a.extractRotation(this.matrix);this.quaternion.setFromRotationMatrix(a)}}(),setRotationFromAxisAngle:function(a,b){this.quaternion.setFromAxisAngle(a,b)},setRotationFromEuler:function(a){this.quaternion.setFromEuler(a,!0)},setRotationFromMatrix:function(a){this.quaternion.setFromRotationMatrix(a)},
setRotationFromQuaternion:function(a){this.quaternion.copy(a)},rotateOnAxis:function(){var a=new THREE.Quaternion;return function(b,c){a.setFromAxisAngle(b,c);this.quaternion.multiply(a);return this}}(),rotateX:function(){var a=new THREE.Vector3(1,0,0);return function(b){return this.rotateOnAxis(a,b)}}(),rotateY:function(){var a=new THREE.Vector3(0,1,0);return function(b){return this.rotateOnAxis(a,b)}}(),rotateZ:function(){var a=new THREE.Vector3(0,0,1);return function(b){return this.rotateOnAxis(a,
b)}}(),translateOnAxis:function(){var a=new THREE.Vector3;return function(b,c){a.copy(b);a.applyQuaternion(this.quaternion);this.position.add(a.multiplyScalar(c));return this}}(),translate:function(a,b){console.warn("DEPRECATED: Object3D's .translate() has been removed. Use .translateOnAxis( axis, distance ) instead. Note args have been changed.");return this.translateOnAxis(b,a)},translateX:function(){var a=new THREE.Vector3(1,0,0);return function(b){return this.translateOnAxis(a,b)}}(),translateY:function(){var a=
new THREE.Vector3(0,1,0);return function(b){return this.translateOnAxis(a,b)}}(),translateZ:function(){var a=new THREE.Vector3(0,0,1);return function(b){return this.translateOnAxis(a,b)}}(),localToWorld:function(a){return a.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var a=new THREE.Matrix4;return function(b){return b.applyMatrix4(a.getInverse(this.matrixWorld))}}(),lookAt:function(){var a=new THREE.Matrix4;return function(b){a.lookAt(b,this.position,this.up);this.quaternion.setFromRotationMatrix(a)}}(),
add:function(a){if(a===this)console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");else if(a instanceof THREE.Object3D){void 0!==a.parent&&a.parent.remove(a);a.parent=this;a.dispatchEvent({type:"added"});this.children.push(a);for(var b=this;void 0!==b.parent;)b=b.parent;void 0!==b&&b instanceof THREE.Scene&&b.__addObject(a)}},remove:function(a){var b=this.children.indexOf(a);if(-1!==b){a.parent=void 0;a.dispatchEvent({type:"removed"});this.children.splice(b,1);for(b=this;void 0!==
b.parent;)b=b.parent;void 0!==b&&b instanceof THREE.Scene&&b.__removeObject(a)}},traverse:function(a){a(this);for(var b=0,c=this.children.length;b<c;b++)this.children[b].traverse(a)},getObjectById:function(a,b){for(var c=0,d=this.children.length;c<d;c++){var e=this.children[c];if(e.id===a||!0===b&&(e=e.getObjectById(a,b),void 0!==e))return e}},getObjectByName:function(a,b){for(var c=0,d=this.children.length;c<d;c++){var e=this.children[c];if(e.name===a||!0===b&&(e=e.getObjectByName(a,b),void 0!==
e))return e}},getChildByName:function(a,b){console.warn("DEPRECATED: Object3D's .getChildByName() has been renamed to .getObjectByName().");return this.getObjectByName(a,b)},getDescendants:function(a){void 0===a&&(a=[]);Array.prototype.push.apply(a,this.children);for(var b=0,c=this.children.length;b<c;b++)this.children[b].getDescendants(a);return a},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale);this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(a){!0===
this.matrixAutoUpdate&&this.updateMatrix();if(!0===this.matrixWorldNeedsUpdate||!0===a)void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,a=!0;for(var b=0,c=this.children.length;b<c;b++)this.children[b].updateMatrixWorld(a)},clone:function(a,b){void 0===a&&(a=new THREE.Object3D);void 0===b&&(b=!0);a.name=this.name;a.up.copy(this.up);a.position.copy(this.position);a.quaternion.copy(this.quaternion);
a.scale.copy(this.scale);a.renderDepth=this.renderDepth;a.rotationAutoUpdate=this.rotationAutoUpdate;a.matrix.copy(this.matrix);a.matrixWorld.copy(this.matrixWorld);a.matrixAutoUpdate=this.matrixAutoUpdate;a.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate;a.visible=this.visible;a.castShadow=this.castShadow;a.receiveShadow=this.receiveShadow;a.frustumCulled=this.frustumCulled;a.userData=JSON.parse(JSON.stringify(this.userData));if(!0===b)for(var c=0;c<this.children.length;c++)a.add(this.children[c].clone());
return a}};THREE.EventDispatcher.prototype.apply(THREE.Object3D.prototype);THREE.Object3DIdCount=0;THREE.Projector=function(){function a(){if(i===l){var a=new THREE.RenderableVertex;k.push(a);l++;i++;return a}return k[i++]}function b(a,b){return a.z!==b.z?b.z-a.z:a.id!==b.id?a.id-b.id:0}function c(a,b){var c=0,d=1,e=a.z+a.w,f=b.z+b.w,h=-a.z+a.w,g=-b.z+b.w;if(0<=e&&0<=f&&0<=h&&0<=g)return!0;if(0>e&&0>f||0>h&&0>g)return!1;0>e?c=Math.max(c,e/(e-f)):0>f&&(d=Math.min(d,e/(e-f)));0>h?c=Math.max(c,h/(h-g)):0>g&&(d=Math.min(d,h/(h-g)));if(d<c)return!1;a.lerp(b,c);b.lerp(a,1-d);return!0}var d,e,f=[],h=
0,g,i,k=[],l=0,m,p,t=[],q=0,n,r,s=[],u=0,x,v,D=[],z=0,C={objects:[],sprites:[],lights:[],elements:[]},A=new THREE.Vector3,y=new THREE.Vector4,M=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),E=new THREE.Box3,J=Array(3),P=new THREE.Matrix4,F=new THREE.Matrix4,B,w=new THREE.Matrix4,R=new THREE.Matrix3,L=new THREE.Matrix3,fa=new THREE.Vector3,ia=new THREE.Frustum,oa=new THREE.Vector4,H=new THREE.Vector4;this.projectVector=function(a,b){b.matrixWorldInverse.getInverse(b.matrixWorld);
F.multiplyMatrices(b.projectionMatrix,b.matrixWorldInverse);return a.applyProjection(F)};this.unprojectVector=function(a,b){b.projectionMatrixInverse.getInverse(b.projectionMatrix);F.multiplyMatrices(b.matrixWorld,b.projectionMatrixInverse);return a.applyProjection(F)};this.pickingRay=function(a,b){a.z=-1;var c=new THREE.Vector3(a.x,a.y,1);this.unprojectVector(a,b);this.unprojectVector(c,b);c.sub(a).normalize();return new THREE.Raycaster(a,c)};var T=function(a){if(e===h){var b=new THREE.RenderableObject;
f.push(b);h++;e++;d=b}else d=f[e++];d.id=a.id;d.object=a;null!==a.renderDepth?d.z=a.renderDepth:(A.getPositionFromMatrix(a.matrixWorld),A.applyProjection(F),d.z=A.z);return d},I=function(a){if(!1!==a.visible){a instanceof THREE.Light?C.lights.push(a):a instanceof THREE.Mesh||a instanceof THREE.Line?(!1===a.frustumCulled||!0===ia.intersectsObject(a))&&C.objects.push(T(a)):(a instanceof THREE.Sprite||a instanceof THREE.Particle)&&C.sprites.push(T(a));for(var b=0,c=a.children.length;b<c;b++)I(a.children[b])}};
this.projectScene=function(d,f,h,l){var A=!1,T,ea,X,N,$,ba,V,pa,sa,ja,Ea,Ia;v=r=p=0;C.elements.length=0;!0===d.autoUpdate&&d.updateMatrixWorld();void 0===f.parent&&f.updateMatrixWorld();P.copy(f.matrixWorldInverse.getInverse(f.matrixWorld));F.multiplyMatrices(f.projectionMatrix,P);L.getNormalMatrix(P);ia.setFromMatrix(F);e=0;C.objects.length=0;C.sprites.length=0;C.lights.length=0;I(d);!0===h&&C.objects.sort(b);d=0;for(h=C.objects.length;d<h;d++)if(V=C.objects[d].object,B=V.matrixWorld,i=0,V instanceof
THREE.Mesh){pa=V.geometry;X=pa.vertices;sa=pa.faces;pa=pa.faceVertexUvs;R.getNormalMatrix(B);Ea=V.material instanceof THREE.MeshFaceMaterial;Ia=!0===Ea?V.material:null;T=0;for(ea=X.length;T<ea;T++){g=a();g.positionWorld.copy(X[T]).applyMatrix4(B);g.positionScreen.copy(g.positionWorld).applyMatrix4(F);var va=1/g.positionScreen.w;g.positionScreen.x*=va;g.positionScreen.y*=va;g.positionScreen.z*=va;g.visible=!(-1>g.positionScreen.x||1<g.positionScreen.x||-1>g.positionScreen.y||1<g.positionScreen.y||
-1>g.positionScreen.z||1<g.positionScreen.z)}X=0;for(T=sa.length;X<T;X++)if(ea=sa[X],va=!0===Ea?Ia.materials[ea.materialIndex]:V.material,void 0!==va&&(ba=va.side,N=k[ea.a],$=k[ea.b],ja=k[ea.c],J[0]=N.positionScreen,J[1]=$.positionScreen,J[2]=ja.positionScreen,!0===N.visible||!0===$.visible||!0===ja.visible||M.isIntersectionBox(E.setFromPoints(J))))if(A=0>(ja.positionScreen.x-N.positionScreen.x)*($.positionScreen.y-N.positionScreen.y)-(ja.positionScreen.y-N.positionScreen.y)*($.positionScreen.x-N.positionScreen.x),
ba===THREE.DoubleSide||A===(ba===THREE.FrontSide)){if(p===q){var Ha=new THREE.RenderableFace3;t.push(Ha);q++;p++;m=Ha}else m=t[p++];m.id=V.id;m.v1.copy(N);m.v2.copy($);m.v3.copy(ja);m.normalModel.copy(ea.normal);!1===A&&(ba===THREE.BackSide||ba===THREE.DoubleSide)&&m.normalModel.negate();m.normalModel.applyMatrix3(R).normalize();m.normalModelView.copy(m.normalModel).applyMatrix3(L);m.centroidModel.copy(ea.centroid).applyMatrix4(B);ja=ea.vertexNormals;N=0;for($=Math.min(ja.length,3);N<$;N++)Ha=m.vertexNormalsModel[N],
Ha.copy(ja[N]),!1===A&&(ba===THREE.BackSide||ba===THREE.DoubleSide)&&Ha.negate(),Ha.applyMatrix3(R).normalize(),m.vertexNormalsModelView[N].copy(Ha).applyMatrix3(L);m.vertexNormalsLength=ja.length;A=0;for(N=Math.min(pa.length,3);A<N;A++)if(ja=pa[A][X],void 0!==ja){$=0;for(ba=ja.length;$<ba;$++)m.uvs[A][$]=ja[$]}m.color=ea.color;m.material=va;fa.copy(m.centroidModel).applyProjection(F);m.z=fa.z;C.elements.push(m)}}else if(V instanceof THREE.Line){w.multiplyMatrices(F,B);X=V.geometry.vertices;N=a();
N.positionScreen.copy(X[0]).applyMatrix4(w);sa=V.type===THREE.LinePieces?2:1;T=1;for(ea=X.length;T<ea;T++)N=a(),N.positionScreen.copy(X[T]).applyMatrix4(w),0<(T+1)%sa||($=k[i-2],oa.copy(N.positionScreen),H.copy($.positionScreen),!0===c(oa,H)&&(oa.multiplyScalar(1/oa.w),H.multiplyScalar(1/H.w),r===u?(pa=new THREE.RenderableLine,s.push(pa),u++,r++,n=pa):n=s[r++],n.id=V.id,n.v1.positionScreen.copy(oa),n.v2.positionScreen.copy(H),n.z=Math.max(oa.z,H.z),n.material=V.material,V.material.vertexColors===
THREE.VertexColors&&(n.vertexColors[0].copy(V.geometry.colors[T]),n.vertexColors[1].copy(V.geometry.colors[T-1])),C.elements.push(n)))}d=0;for(h=C.sprites.length;d<h;d++)V=C.sprites[d].object,B=V.matrixWorld,V instanceof THREE.Particle&&(y.set(B.elements[12],B.elements[13],B.elements[14],1),y.applyMatrix4(F),va=1/y.w,y.z*=va,0<y.z&&1>y.z&&(v===z?(sa=new THREE.RenderableParticle,D.push(sa),z++,v++,x=sa):x=D[v++],x.id=V.id,x.x=y.x*va,x.y=y.y*va,x.z=y.z,x.object=V,x.rotation=V.rotation.z,x.scale.x=V.scale.x*
Math.abs(x.x-(y.x+f.projectionMatrix.elements[0])/(y.w+f.projectionMatrix.elements[12])),x.scale.y=V.scale.y*Math.abs(x.y-(y.y+f.projectionMatrix.elements[5])/(y.w+f.projectionMatrix.elements[13])),x.material=V.material,C.elements.push(x)));!0===l&&C.elements.sort(b);return C}};THREE.Face3=function(a,b,c,d,e,f){this.a=a;this.b=b;this.c=c;this.normal=d instanceof THREE.Vector3?d:new THREE.Vector3;this.vertexNormals=d instanceof Array?d:[];this.color=e instanceof THREE.Color?e:new THREE.Color;this.vertexColors=e instanceof Array?e:[];this.vertexTangents=[];this.materialIndex=void 0!==f?f:0;this.centroid=new THREE.Vector3};
THREE.Face3.prototype={constructor:THREE.Face3,clone:function(){var a=new THREE.Face3(this.a,this.b,this.c);a.normal.copy(this.normal);a.color.copy(this.color);a.centroid.copy(this.centroid);a.materialIndex=this.materialIndex;var b,c;b=0;for(c=this.vertexNormals.length;b<c;b++)a.vertexNormals[b]=this.vertexNormals[b].clone();b=0;for(c=this.vertexColors.length;b<c;b++)a.vertexColors[b]=this.vertexColors[b].clone();b=0;for(c=this.vertexTangents.length;b<c;b++)a.vertexTangents[b]=this.vertexTangents[b].clone();
return a}};THREE.Face4=function(a,b,c,d,e,f,h){console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead.");return new THREE.Face3(a,b,c,e,f,h)};THREE.Geometry=function(){this.id=THREE.GeometryIdCount++;this.uuid=THREE.Math.generateUUID();this.name="";this.vertices=[];this.colors=[];this.faces=[];this.faceVertexUvs=[[]];this.morphTargets=[];this.morphColors=[];this.morphNormals=[];this.skinWeights=[];this.skinIndices=[];this.lineDistances=[];this.boundingSphere=this.boundingBox=null;this.hasTangents=!1;this.dynamic=!0;this.buffersNeedUpdate=this.lineDistancesNeedUpdate=this.colorsNeedUpdate=this.tangentsNeedUpdate=this.normalsNeedUpdate=this.uvsNeedUpdate=
this.elementsNeedUpdate=this.verticesNeedUpdate=!1};
THREE.Geometry.prototype={constructor:THREE.Geometry,applyMatrix:function(a){for(var b=(new THREE.Matrix3).getNormalMatrix(a),c=0,d=this.vertices.length;c<d;c++)this.vertices[c].applyMatrix4(a);c=0;for(d=this.faces.length;c<d;c++){var e=this.faces[c];e.normal.applyMatrix3(b).normalize();for(var f=0,h=e.vertexNormals.length;f<h;f++)e.vertexNormals[f].applyMatrix3(b).normalize();e.centroid.applyMatrix4(a)}this.boundingBox instanceof THREE.Box3&&this.computeBoundingBox();this.boundingSphere instanceof
THREE.Sphere&&this.computeBoundingSphere()},computeCentroids:function(){var a,b,c;a=0;for(b=this.faces.length;a<b;a++)c=this.faces[a],c.centroid.set(0,0,0),c.centroid.add(this.vertices[c.a]),c.centroid.add(this.vertices[c.b]),c.centroid.add(this.vertices[c.c]),c.centroid.divideScalar(3)},computeFaceNormals:function(){for(var a=new THREE.Vector3,b=new THREE.Vector3,c=0,d=this.faces.length;c<d;c++){var e=this.faces[c],f=this.vertices[e.a],h=this.vertices[e.b];a.subVectors(this.vertices[e.c],h);b.subVectors(f,
h);a.cross(b);a.normalize();e.normal.copy(a)}},computeVertexNormals:function(a){var b,c,d,e;if(void 0===this.__tmpVertices){e=this.__tmpVertices=Array(this.vertices.length);b=0;for(c=this.vertices.length;b<c;b++)e[b]=new THREE.Vector3;b=0;for(c=this.faces.length;b<c;b++)d=this.faces[b],d.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3]}else{e=this.__tmpVertices;b=0;for(c=this.vertices.length;b<c;b++)e[b].set(0,0,0)}a&&console.log("Error: areaWeighted has been removed due to license issue from this build");
b=0;for(c=this.faces.length;b<c;b++)d=this.faces[b],e[d.a].add(d.normal),e[d.b].add(d.normal),e[d.c].add(d.normal);b=0;for(c=this.vertices.length;b<c;b++)e[b].normalize();b=0;for(c=this.faces.length;b<c;b++)d=this.faces[b],d.vertexNormals[0].copy(e[d.a]),d.vertexNormals[1].copy(e[d.b]),d.vertexNormals[2].copy(e[d.c])},computeMorphNormals:function(){var a,b,c,d,e;c=0;for(d=this.faces.length;c<d;c++){e=this.faces[c];e.__originalFaceNormal?e.__originalFaceNormal.copy(e.normal):e.__originalFaceNormal=
e.normal.clone();e.__originalVertexNormals||(e.__originalVertexNormals=[]);a=0;for(b=e.vertexNormals.length;a<b;a++)e.__originalVertexNormals[a]?e.__originalVertexNormals[a].copy(e.vertexNormals[a]):e.__originalVertexNormals[a]=e.vertexNormals[a].clone()}var f=new THREE.Geometry;f.faces=this.faces;a=0;for(b=this.morphTargets.length;a<b;a++){if(!this.morphNormals[a]){this.morphNormals[a]={};this.morphNormals[a].faceNormals=[];this.morphNormals[a].vertexNormals=[];e=this.morphNormals[a].faceNormals;
var h=this.morphNormals[a].vertexNormals,g,i;c=0;for(d=this.faces.length;c<d;c++)g=new THREE.Vector3,i={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3},e.push(g),h.push(i)}h=this.morphNormals[a];f.vertices=this.morphTargets[a].vertices;f.computeFaceNormals();f.computeVertexNormals();c=0;for(d=this.faces.length;c<d;c++)e=this.faces[c],g=h.faceNormals[c],i=h.vertexNormals[c],g.copy(e.normal),i.a.copy(e.vertexNormals[0]),i.b.copy(e.vertexNormals[1]),i.c.copy(e.vertexNormals[2])}c=0;for(d=
this.faces.length;c<d;c++)e=this.faces[c],e.normal=e.__originalFaceNormal,e.vertexNormals=e.__originalVertexNormals},computeTangents:function(){var a,b,c,d,e,f,h,g,i,k,l,m,p,t,q,n,r,s=[],u=[];c=new THREE.Vector3;var x=new THREE.Vector3,v=new THREE.Vector3,D=new THREE.Vector3,z=new THREE.Vector3;a=0;for(b=this.vertices.length;a<b;a++)s[a]=new THREE.Vector3,u[a]=new THREE.Vector3;a=0;for(b=this.faces.length;a<b;a++)e=this.faces[a],f=this.faceVertexUvs[0][a],d=e.a,r=e.b,e=e.c,h=this.vertices[d],g=this.vertices[r],
i=this.vertices[e],k=f[0],l=f[1],m=f[2],f=g.x-h.x,p=i.x-h.x,t=g.y-h.y,q=i.y-h.y,g=g.z-h.z,h=i.z-h.z,i=l.x-k.x,n=m.x-k.x,l=l.y-k.y,k=m.y-k.y,m=1/(i*k-n*l),c.set((k*f-l*p)*m,(k*t-l*q)*m,(k*g-l*h)*m),x.set((i*p-n*f)*m,(i*q-n*t)*m,(i*h-n*g)*m),s[d].add(c),s[r].add(c),s[e].add(c),u[d].add(x),u[r].add(x),u[e].add(x);x=["a","b","c","d"];a=0;for(b=this.faces.length;a<b;a++){e=this.faces[a];for(c=0;c<Math.min(e.vertexNormals.length,3);c++)z.copy(e.vertexNormals[c]),d=e[x[c]],r=s[d],v.copy(r),v.sub(z.multiplyScalar(z.dot(r))).normalize(),
D.crossVectors(e.vertexNormals[c],r),d=D.dot(u[d]),d=0>d?-1:1,e.vertexTangents[c]=new THREE.Vector4(v.x,v.y,v.z,d)}this.hasTangents=!0},computeLineDistances:function(){for(var a=0,b=this.vertices,c=0,d=b.length;c<d;c++)0<c&&(a+=b[c].distanceTo(b[c-1])),this.lineDistances[c]=a},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere);
this.boundingSphere.setFromPoints(this.vertices)},mergeVertices:function(){var a={},b=[],c=[],d,e=Math.pow(10,4),f,h;this.__tmpVertices=void 0;f=0;for(h=this.vertices.length;f<h;f++)d=this.vertices[f],d=Math.round(d.x*e)+"_"+Math.round(d.y*e)+"_"+Math.round(d.z*e),void 0===a[d]?(a[d]=f,b.push(this.vertices[f]),c[f]=b.length-1):c[f]=c[a[d]];a=[];f=0;for(h=this.faces.length;f<h;f++){e=this.faces[f];e.a=c[e.a];e.b=c[e.b];e.c=c[e.c];e=[e.a,e.b,e.c];for(d=0;3>d;d++)if(e[d]==e[(d+1)%3]){a.push(f);break}}for(f=
a.length-1;0<=f;f--){e=a[f];this.faces.splice(e,1);c=0;for(h=this.faceVertexUvs.length;c<h;c++)this.faceVertexUvs[c].splice(e,1)}f=this.vertices.length-b.length;this.vertices=b;return f},clone:function(){for(var a=new THREE.Geometry,b=this.vertices,c=0,d=b.length;c<d;c++)a.vertices.push(b[c].clone());b=this.faces;c=0;for(d=b.length;c<d;c++)a.faces.push(b[c].clone());b=this.faceVertexUvs[0];c=0;for(d=b.length;c<d;c++){for(var e=b[c],f=[],h=0,g=e.length;h<g;h++)f.push(new THREE.Vector2(e[h].x,e[h].y));
a.faceVertexUvs[0].push(f)}return a},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.EventDispatcher.prototype.apply(THREE.Geometry.prototype);THREE.GeometryIdCount=0;THREE.BufferGeometry=function(){this.id=THREE.GeometryIdCount++;this.uuid=THREE.Math.generateUUID();this.name="";this.attributes={};this.dynamic=!0;this.offsets=[];this.boundingSphere=this.boundingBox=null;this.hasTangents=!1;this.morphTargets=[]};
THREE.BufferGeometry.prototype={constructor:THREE.BufferGeometry,applyMatrix:function(a){var b,c;this.attributes.position&&(b=this.attributes.position.array);this.attributes.normal&&(c=this.attributes.normal.array);void 0!==b&&(a.multiplyVector3Array(b),this.verticesNeedUpdate=!0);void 0!==c&&((new THREE.Matrix3).getNormalMatrix(a).multiplyVector3Array(c),this.normalizeNormals(),this.normalsNeedUpdate=!0)},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);var a=
this.attributes.position.array;if(a){var b=this.boundingBox,c,d,e;3<=a.length&&(b.min.x=b.max.x=a[0],b.min.y=b.max.y=a[1],b.min.z=b.max.z=a[2]);for(var f=3,h=a.length;f<h;f+=3)c=a[f],d=a[f+1],e=a[f+2],c<b.min.x?b.min.x=c:c>b.max.x&&(b.max.x=c),d<b.min.y?b.min.y=d:d>b.max.y&&(b.max.y=d),e<b.min.z?b.min.z=e:e>b.max.z&&(b.max.z=e)}if(void 0===a||0===a.length)this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)},computeBoundingSphere:function(){var a=new THREE.Box3,b=new THREE.Vector3;return function(){null===
this.boundingSphere&&(this.boundingSphere=new THREE.Sphere);var c=this.attributes.position.array;if(c){for(var d=this.boundingSphere.center,e=0,f=c.length;e<f;e+=3)b.set(c[e],c[e+1],c[e+2]),a.addPoint(b);a.center(d);for(var h=0,e=0,f=c.length;e<f;e+=3)b.set(c[e],c[e+1],c[e+2]),h=Math.max(h,d.distanceToSquared(b));this.boundingSphere.radius=Math.sqrt(h)}}}(),computeVertexNormals:function(){if(this.attributes.position){var a,b,c,d;a=this.attributes.position.array.length;if(void 0===this.attributes.normal)this.attributes.normal=
{itemSize:3,array:new Float32Array(a)};else{a=0;for(b=this.attributes.normal.array.length;a<b;a++)this.attributes.normal.array[a]=0}var e=this.attributes.position.array,f=this.attributes.normal.array,h,g,i,k,l,m,p=new THREE.Vector3,t=new THREE.Vector3,q=new THREE.Vector3,n=new THREE.Vector3,r=new THREE.Vector3;if(this.attributes.index){var s=this.attributes.index.array,u=this.offsets;c=0;for(d=u.length;c<d;++c){b=u[c].start;h=u[c].count;var x=u[c].index;a=b;for(b+=h;a<b;a+=3)h=x+s[a],g=x+s[a+1],i=
x+s[a+2],k=e[3*h],l=e[3*h+1],m=e[3*h+2],p.set(k,l,m),k=e[3*g],l=e[3*g+1],m=e[3*g+2],t.set(k,l,m),k=e[3*i],l=e[3*i+1],m=e[3*i+2],q.set(k,l,m),n.subVectors(q,t),r.subVectors(p,t),n.cross(r),f[3*h]+=n.x,f[3*h+1]+=n.y,f[3*h+2]+=n.z,f[3*g]+=n.x,f[3*g+1]+=n.y,f[3*g+2]+=n.z,f[3*i]+=n.x,f[3*i+1]+=n.y,f[3*i+2]+=n.z}}else{a=0;for(b=e.length;a<b;a+=9)k=e[a],l=e[a+1],m=e[a+2],p.set(k,l,m),k=e[a+3],l=e[a+4],m=e[a+5],t.set(k,l,m),k=e[a+6],l=e[a+7],m=e[a+8],q.set(k,l,m),n.subVectors(q,t),r.subVectors(p,t),n.cross(r),
f[a]=n.x,f[a+1]=n.y,f[a+2]=n.z,f[a+3]=n.x,f[a+4]=n.y,f[a+5]=n.z,f[a+6]=n.x,f[a+7]=n.y,f[a+8]=n.z}this.normalizeNormals();this.normalsNeedUpdate=!0}},normalizeNormals:function(){for(var a=this.attributes.normal.array,b,c,d,e=0,f=a.length;e<f;e+=3)b=a[e],c=a[e+1],d=a[e+2],b=1/Math.sqrt(b*b+c*c+d*d),a[e]*=b,a[e+1]*=b,a[e+2]*=b},computeTangents:function(){function a(a){ia.x=d[3*a];ia.y=d[3*a+1];ia.z=d[3*a+2];oa.copy(ia);T=g[a];L.copy(T);L.sub(ia.multiplyScalar(ia.dot(T))).normalize();fa.crossVectors(oa,
T);I=fa.dot(i[a]);H=0>I?-1:1;h[4*a]=L.x;h[4*a+1]=L.y;h[4*a+2]=L.z;h[4*a+3]=H}if(void 0===this.attributes.index||void 0===this.attributes.position||void 0===this.attributes.normal||void 0===this.attributes.uv)console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");else{var b=this.attributes.index.array,c=this.attributes.position.array,d=this.attributes.normal.array,e=this.attributes.uv.array,f=c.length/3;void 0===this.attributes.tangent&&(this.attributes.tangent=
{itemSize:4,array:new Float32Array(4*f)});for(var h=this.attributes.tangent.array,g=[],i=[],k=0;k<f;k++)g[k]=new THREE.Vector3,i[k]=new THREE.Vector3;var l,m,p,t,q,n,r,s,u,x,v,D,z,C,A,f=new THREE.Vector3,k=new THREE.Vector3,y,M,E,J,P,F,B,w=this.offsets;E=0;for(J=w.length;E<J;++E){M=w[E].start;P=w[E].count;var R=w[E].index;y=M;for(M+=P;y<M;y+=3)P=R+b[y],F=R+b[y+1],B=R+b[y+2],l=c[3*P],m=c[3*P+1],p=c[3*P+2],t=c[3*F],q=c[3*F+1],n=c[3*F+2],r=c[3*B],s=c[3*B+1],u=c[3*B+2],x=e[2*P],v=e[2*P+1],D=e[2*F],z=
e[2*F+1],C=e[2*B],A=e[2*B+1],t-=l,l=r-l,q-=m,m=s-m,n-=p,p=u-p,D-=x,x=C-x,z-=v,v=A-v,A=1/(D*v-x*z),f.set((v*t-z*l)*A,(v*q-z*m)*A,(v*n-z*p)*A),k.set((D*l-x*t)*A,(D*m-x*q)*A,(D*p-x*n)*A),g[P].add(f),g[F].add(f),g[B].add(f),i[P].add(k),i[F].add(k),i[B].add(k)}var L=new THREE.Vector3,fa=new THREE.Vector3,ia=new THREE.Vector3,oa=new THREE.Vector3,H,T,I;E=0;for(J=w.length;E<J;++E){M=w[E].start;P=w[E].count;R=w[E].index;y=M;for(M+=P;y<M;y+=3)P=R+b[y],F=R+b[y+1],B=R+b[y+2],a(P),a(F),a(B)}this.tangentsNeedUpdate=
this.hasTangents=!0}},clone:function(){var a=new THREE.BufferGeometry,b=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],c;for(c in this.attributes){for(var d=this.attributes[c],e=d.array,f={itemSize:d.itemSize,numItems:d.numItems,array:null},d=0,h=b.length;d<h;d++){var g=b[d];if(e instanceof g){f.array=new g(e);break}}a.attributes[c]=f}d=0;for(h=this.offsets.length;d<h;d++)b=this.offsets[d],a.offsets.push({start:b.start,index:b.index,
count:b.count});return a},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.EventDispatcher.prototype.apply(THREE.BufferGeometry.prototype);THREE.Camera=function(){THREE.Object3D.call(this);this.matrixWorldInverse=new THREE.Matrix4;this.projectionMatrix=new THREE.Matrix4;this.projectionMatrixInverse=new THREE.Matrix4};THREE.Camera.prototype=Object.create(THREE.Object3D.prototype);THREE.Camera.prototype.lookAt=function(){var a=new THREE.Matrix4;return function(b){a.lookAt(this.position,b,this.up);this.quaternion.setFromRotationMatrix(a)}}();
THREE.Camera.prototype.clone=function(a){void 0===a&&(a=new THREE.Camera);THREE.Object3D.prototype.clone.call(this,a);a.matrixWorldInverse.copy(this.matrixWorldInverse);a.projectionMatrix.copy(this.projectionMatrix);a.projectionMatrixInverse.copy(this.projectionMatrixInverse);return a};THREE.OrthographicCamera=function(a,b,c,d,e,f){THREE.Camera.call(this);this.left=a;this.right=b;this.top=c;this.bottom=d;this.near=void 0!==e?e:0.1;this.far=void 0!==f?f:2E3;this.updateProjectionMatrix()};THREE.OrthographicCamera.prototype=Object.create(THREE.Camera.prototype);THREE.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)};
THREE.OrthographicCamera.prototype.clone=function(){var a=new THREE.OrthographicCamera;THREE.Camera.prototype.clone.call(this,a);a.left=this.left;a.right=this.right;a.top=this.top;a.bottom=this.bottom;a.near=this.near;a.far=this.far;return a};THREE.PerspectiveCamera=function(a,b,c,d){THREE.Camera.call(this);this.fov=void 0!==a?a:50;this.aspect=void 0!==b?b:1;this.near=void 0!==c?c:0.1;this.far=void 0!==d?d:2E3;this.updateProjectionMatrix()};THREE.PerspectiveCamera.prototype=Object.create(THREE.Camera.prototype);THREE.PerspectiveCamera.prototype.setLens=function(a,b){void 0===b&&(b=24);this.fov=2*THREE.Math.radToDeg(Math.atan(b/(2*a)));this.updateProjectionMatrix()};
THREE.PerspectiveCamera.prototype.setViewOffset=function(a,b,c,d,e,f){this.fullWidth=a;this.fullHeight=b;this.x=c;this.y=d;this.width=e;this.height=f;this.updateProjectionMatrix()};
THREE.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var a=this.fullWidth/this.fullHeight,b=Math.tan(THREE.Math.degToRad(0.5*this.fov))*this.near,c=-b,d=a*c,a=Math.abs(a*b-d),c=Math.abs(b-c);this.projectionMatrix.makeFrustum(d+this.x*a/this.fullWidth,d+(this.x+this.width)*a/this.fullWidth,b-(this.y+this.height)*c/this.fullHeight,b-this.y*c/this.fullHeight,this.near,this.far)}else this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)};
THREE.PerspectiveCamera.prototype.clone=function(){var a=new THREE.PerspectiveCamera;THREE.Camera.prototype.clone.call(this,a);a.fov=this.fov;a.aspect=this.aspect;a.near=this.near;a.far=this.far;return a};THREE.Light=function(a){THREE.Object3D.call(this);this.color=new THREE.Color(a)};THREE.Light.prototype=Object.create(THREE.Object3D.prototype);THREE.Light.prototype.clone=function(a){void 0===a&&(a=new THREE.Light);THREE.Object3D.prototype.clone.call(this,a);a.color.copy(this.color);return a};THREE.AmbientLight=function(a){THREE.Light.call(this,a)};THREE.AmbientLight.prototype=Object.create(THREE.Light.prototype);THREE.AmbientLight.prototype.clone=function(){var a=new THREE.AmbientLight;THREE.Light.prototype.clone.call(this,a);return a};THREE.AreaLight=function(a,b){THREE.Light.call(this,a);this.normal=new THREE.Vector3(0,-1,0);this.right=new THREE.Vector3(1,0,0);this.intensity=void 0!==b?b:1;this.height=this.width=1;this.constantAttenuation=1.5;this.linearAttenuation=0.5;this.quadraticAttenuation=0.1};THREE.AreaLight.prototype=Object.create(THREE.Light.prototype);THREE.DirectionalLight=function(a,b){THREE.Light.call(this,a);this.position.set(0,1,0);this.target=new THREE.Object3D;this.intensity=void 0!==b?b:1;this.onlyShadow=this.castShadow=!1;this.shadowCameraNear=50;this.shadowCameraFar=5E3;this.shadowCameraLeft=-500;this.shadowCameraTop=this.shadowCameraRight=500;this.shadowCameraBottom=-500;this.shadowCameraVisible=!1;this.shadowBias=0;this.shadowDarkness=0.5;this.shadowMapHeight=this.shadowMapWidth=512;this.shadowCascade=!1;this.shadowCascadeOffset=new THREE.Vector3(0,
0,-1E3);this.shadowCascadeCount=2;this.shadowCascadeBias=[0,0,0];this.shadowCascadeWidth=[512,512,512];this.shadowCascadeHeight=[512,512,512];this.shadowCascadeNearZ=[-1,0.99,0.998];this.shadowCascadeFarZ=[0.99,0.998,1];this.shadowCascadeArray=[];this.shadowMatrix=this.shadowCamera=this.shadowMapSize=this.shadowMap=null};THREE.DirectionalLight.prototype=Object.create(THREE.Light.prototype);
THREE.DirectionalLight.prototype.clone=function(){var a=new THREE.DirectionalLight;THREE.Light.prototype.clone.call(this,a);a.target=this.target.clone();a.intensity=this.intensity;a.castShadow=this.castShadow;a.onlyShadow=this.onlyShadow;return a};THREE.HemisphereLight=function(a,b,c){THREE.Light.call(this,a);this.position.set(0,100,0);this.groundColor=new THREE.Color(b);this.intensity=void 0!==c?c:1};THREE.HemisphereLight.prototype=Object.create(THREE.Light.prototype);THREE.HemisphereLight.prototype.clone=function(){var a=new THREE.HemisphereLight;THREE.Light.prototype.clone.call(this,a);a.groundColor.copy(this.groundColor);a.intensity=this.intensity;return a};THREE.PointLight=function(a,b,c){THREE.Light.call(this,a);this.intensity=void 0!==b?b:1;this.distance=void 0!==c?c:0};THREE.PointLight.prototype=Object.create(THREE.Light.prototype);THREE.PointLight.prototype.clone=function(){var a=new THREE.PointLight;THREE.Light.prototype.clone.call(this,a);a.intensity=this.intensity;a.distance=this.distance;return a};THREE.SpotLight=function(a,b,c,d,e){THREE.Light.call(this,a);this.position.set(0,1,0);this.target=new THREE.Object3D;this.intensity=void 0!==b?b:1;this.distance=void 0!==c?c:0;this.angle=void 0!==d?d:Math.PI/3;this.exponent=void 0!==e?e:10;this.onlyShadow=this.castShadow=!1;this.shadowCameraNear=50;this.shadowCameraFar=5E3;this.shadowCameraFov=50;this.shadowCameraVisible=!1;this.shadowBias=0;this.shadowDarkness=0.5;this.shadowMapHeight=this.shadowMapWidth=512;this.shadowMatrix=this.shadowCamera=this.shadowMapSize=
this.shadowMap=null};THREE.SpotLight.prototype=Object.create(THREE.Light.prototype);THREE.SpotLight.prototype.clone=function(){var a=new THREE.SpotLight;THREE.Light.prototype.clone.call(this,a);a.target=this.target.clone();a.intensity=this.intensity;a.distance=this.distance;a.angle=this.angle;a.exponent=this.exponent;a.castShadow=this.castShadow;a.onlyShadow=this.onlyShadow;return a};THREE.Loader=function(a){this.statusDomElement=(this.showStatus=a)?THREE.Loader.prototype.addStatusElement():null;this.onLoadStart=function(){};this.onLoadProgress=function(){};this.onLoadComplete=function(){}};
THREE.Loader.prototype={constructor:THREE.Loader,crossOrigin:"anonymous",addStatusElement:function(){var a=document.createElement("div");a.style.position="absolute";a.style.right="0px";a.style.top="0px";a.style.fontSize="0.8em";a.style.textAlign="left";a.style.background="rgba(0,0,0,0.25)";a.style.color="#fff";a.style.width="120px";a.style.padding="0.5em 0.5em 0.5em 0.5em";a.style.zIndex=1E3;a.innerHTML="Loading ...";return a},updateProgress:function(a){var b="Loaded ",b=a.total?b+((100*a.loaded/
a.total).toFixed(0)+"%"):b+((a.loaded/1E3).toFixed(2)+" KB");this.statusDomElement.innerHTML=b},extractUrlBase:function(a){a=a.split("/");a.pop();return(1>a.length?".":a.join("/"))+"/"},initMaterials:function(a,b){for(var c=[],d=0;d<a.length;++d)c[d]=THREE.Loader.prototype.createMaterial(a[d],b);return c},needsTangents:function(a){for(var b=0,c=a.length;b<c;b++)if(a[b]instanceof THREE.ShaderMaterial)return!0;return!1},createMaterial:function(a,b){function c(a){a=Math.log(a)/Math.LN2;return Math.floor(a)==
a}function d(a){a=Math.log(a)/Math.LN2;return Math.pow(2,Math.round(a))}function e(a,e,f,g,i,k,r){var s=/\.dds$/i.test(f),u=b+"/"+f;if(s){var x=THREE.ImageUtils.loadCompressedTexture(u);a[e]=x}else x=document.createElement("canvas"),a[e]=new THREE.Texture(x);a[e].sourceFile=f;g&&(a[e].repeat.set(g[0],g[1]),1!==g[0]&&(a[e].wrapS=THREE.RepeatWrapping),1!==g[1]&&(a[e].wrapT=THREE.RepeatWrapping));i&&a[e].offset.set(i[0],i[1]);k&&(f={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping},void 0!==
f[k[0]]&&(a[e].wrapS=f[k[0]]),void 0!==f[k[1]]&&(a[e].wrapT=f[k[1]]));r&&(a[e].anisotropy=r);if(!s){var v=a[e],a=new Image;a.onload=function(){if(!c(this.width)||!c(this.height)){var a=d(this.width),b=d(this.height);v.image.width=a;v.image.height=b;v.image.getContext("2d").drawImage(this,0,0,a,b)}else v.image=this;v.needsUpdate=!0};a.crossOrigin=h.crossOrigin;a.src=u}}function f(a){return(255*a[0]<<16)+(255*a[1]<<8)+255*a[2]}var h=this,g="MeshLambertMaterial",i={color:15658734,opacity:1,map:null,
lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};if(a.shading){var k=a.shading.toLowerCase();"phong"===k?g="MeshPhongMaterial":"basic"===k&&(g="MeshBasicMaterial")}void 0!==a.blending&&void 0!==THREE[a.blending]&&(i.blending=THREE[a.blending]);if(void 0!==a.transparent||1>a.opacity)i.transparent=a.transparent;void 0!==a.depthTest&&(i.depthTest=a.depthTest);void 0!==a.depthWrite&&(i.depthWrite=a.depthWrite);void 0!==a.visible&&(i.visible=a.visible);void 0!==a.flipSided&&(i.side=THREE.BackSide);
void 0!==a.doubleSided&&(i.side=THREE.DoubleSide);void 0!==a.wireframe&&(i.wireframe=a.wireframe);void 0!==a.vertexColors&&("face"===a.vertexColors?i.vertexColors=THREE.FaceColors:a.vertexColors&&(i.vertexColors=THREE.VertexColors));a.colorDiffuse?i.color=f(a.colorDiffuse):a.DbgColor&&(i.color=a.DbgColor);a.colorSpecular&&(i.specular=f(a.colorSpecular));a.colorAmbient&&(i.ambient=f(a.colorAmbient));a.transparency&&(i.opacity=a.transparency);a.specularCoef&&(i.shininess=a.specularCoef);a.mapDiffuse&&
b&&e(i,"map",a.mapDiffuse,a.mapDiffuseRepeat,a.mapDiffuseOffset,a.mapDiffuseWrap,a.mapDiffuseAnisotropy);a.mapLight&&b&&e(i,"lightMap",a.mapLight,a.mapLightRepeat,a.mapLightOffset,a.mapLightWrap,a.mapLightAnisotropy);a.mapBump&&b&&e(i,"bumpMap",a.mapBump,a.mapBumpRepeat,a.mapBumpOffset,a.mapBumpWrap,a.mapBumpAnisotropy);a.mapNormal&&b&&e(i,"normalMap",a.mapNormal,a.mapNormalRepeat,a.mapNormalOffset,a.mapNormalWrap,a.mapNormalAnisotropy);a.mapSpecular&&b&&e(i,"specularMap",a.mapSpecular,a.mapSpecularRepeat,
a.mapSpecularOffset,a.mapSpecularWrap,a.mapSpecularAnisotropy);a.mapBumpScale&&(i.bumpScale=a.mapBumpScale);a.mapNormal?(g=THREE.ShaderLib.normalmap,k=THREE.UniformsUtils.clone(g.uniforms),k.tNormal.value=i.normalMap,a.mapNormalFactor&&k.uNormalScale.value.set(a.mapNormalFactor,a.mapNormalFactor),i.map&&(k.tDiffuse.value=i.map,k.enableDiffuse.value=!0),i.specularMap&&(k.tSpecular.value=i.specularMap,k.enableSpecular.value=!0),i.lightMap&&(k.tAO.value=i.lightMap,k.enableAO.value=!0),k.uDiffuseColor.value.setHex(i.color),
k.uSpecularColor.value.setHex(i.specular),k.uAmbientColor.value.setHex(i.ambient),k.uShininess.value=i.shininess,void 0!==i.opacity&&(k.uOpacity.value=i.opacity),g=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:k,lights:!0,fog:!0}),i.transparent&&(g.transparent=!0)):g=new THREE[g](i);void 0!==a.DbgName&&(g.name=a.DbgName);return g}};THREE.XHRLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager};
THREE.XHRLoader.prototype={constructor:THREE.XHRLoader,load:function(a,b,c,d){var e=this,f=new XMLHttpRequest;void 0!==b&&f.addEventListener("load",function(c){b(c.target.responseText);e.manager.itemEnd(a)},!1);void 0!==c&&f.addEventListener("progress",function(a){c(a)},!1);void 0!==d&&f.addEventListener("error",function(a){d(a)},!1);void 0!==this.crossOrigin&&(f.crossOrigin=this.crossOrigin);f.open("GET",a,!0);f.send(null);e.manager.itemStart(a)},setCrossOrigin:function(a){this.crossOrigin=a}};THREE.ImageLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager};
THREE.ImageLoader.prototype={constructor:THREE.ImageLoader,load:function(a,b,c,d){var e=this,f=document.createElement("img");void 0!==b&&f.addEventListener("load",function(){e.manager.itemEnd(a);b(this)},!1);void 0!==c&&f.addEventListener("progress",function(a){c(a)},!1);void 0!==d&&f.addEventListener("error",function(a){d(a)},!1);void 0!==this.crossOrigin&&(f.crossOrigin=this.crossOrigin);f.src=a;e.manager.itemStart(a);return f},setCrossOrigin:function(a){this.crossOrigin=a}};THREE.JSONLoader=function(a){THREE.Loader.call(this,a);this.withCredentials=!1};THREE.JSONLoader.prototype=Object.create(THREE.Loader.prototype);THREE.JSONLoader.prototype.load=function(a,b,c){c=c&&"string"===typeof c?c:this.extractUrlBase(a);this.onLoadStart();this.loadAjaxJSON(this,a,b,c)};
THREE.JSONLoader.prototype.loadAjaxJSON=function(a,b,c,d,e){var f=new XMLHttpRequest,h=0;f.onreadystatechange=function(){if(f.readyState===f.DONE)if(200===f.status||0===f.status){if(f.responseText){var g=JSON.parse(f.responseText),g=a.parse(g,d);c(g.geometry,g.materials)}else console.warn("THREE.JSONLoader: ["+b+"] seems to be unreachable or file there is empty");a.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load ["+b+"] ["+f.status+"]");else f.readyState===f.LOADING?e&&(0===h&&
(h=f.getResponseHeader("Content-Length")),e({total:h,loaded:f.responseText.length})):f.readyState===f.HEADERS_RECEIVED&&void 0!==e&&(h=f.getResponseHeader("Content-Length"))};f.open("GET",b,!0);f.withCredentials=this.withCredentials;f.send(null)};
THREE.JSONLoader.prototype.parse=function(a,b){var c=new THREE.Geometry,d=void 0!==a.scale?1/a.scale:1,e,f,h,g,i,k,l,m,p,t,q,n,r,s,u=a.faces;p=a.vertices;var x=a.normals,v=a.colors,D=0;if(void 0!==a.uvs){for(e=0;e<a.uvs.length;e++)a.uvs[e].length&&D++;for(e=0;e<D;e++)c.faceVertexUvs[e]=[]}g=0;for(i=p.length;g<i;)k=new THREE.Vector3,k.x=p[g++]*d,k.y=p[g++]*d,k.z=p[g++]*d,c.vertices.push(k);g=0;for(i=u.length;g<i;)if(p=u[g++],t=p&1,h=p&2,e=p&8,l=p&16,q=p&32,k=p&64,p&=128,t){t=new THREE.Face3;t.a=u[g];
t.b=u[g+1];t.c=u[g+3];n=new THREE.Face3;n.a=u[g+1];n.b=u[g+2];n.c=u[g+3];g+=4;h&&(h=u[g++],t.materialIndex=h,n.materialIndex=h);h=c.faces.length;if(e)for(e=0;e<D;e++){r=a.uvs[e];c.faceVertexUvs[e][h]=[];c.faceVertexUvs[e][h+1]=[];for(f=0;4>f;f++)m=u[g++],s=r[2*m],m=r[2*m+1],s=new THREE.Vector2(s,m),2!==f&&c.faceVertexUvs[e][h].push(s),0!==f&&c.faceVertexUvs[e][h+1].push(s)}l&&(l=3*u[g++],t.normal.set(x[l++],x[l++],x[l]),n.normal.copy(t.normal));if(q)for(e=0;4>e;e++)l=3*u[g++],q=new THREE.Vector3(x[l++],
x[l++],x[l]),2!==e&&t.vertexNormals.push(q),0!==e&&n.vertexNormals.push(q);k&&(k=u[g++],k=v[k],t.color.setHex(k),n.color.setHex(k));if(p)for(e=0;4>e;e++)k=u[g++],k=v[k],2!==e&&t.vertexColors.push(new THREE.Color(k)),0!==e&&n.vertexColors.push(new THREE.Color(k));c.faces.push(t);c.faces.push(n)}else{t=new THREE.Face3;t.a=u[g++];t.b=u[g++];t.c=u[g++];h&&(h=u[g++],t.materialIndex=h);h=c.faces.length;if(e)for(e=0;e<D;e++){r=a.uvs[e];c.faceVertexUvs[e][h]=[];for(f=0;3>f;f++)m=u[g++],s=r[2*m],m=r[2*m+1],
s=new THREE.Vector2(s,m),c.faceVertexUvs[e][h].push(s)}l&&(l=3*u[g++],t.normal.set(x[l++],x[l++],x[l]));if(q)for(e=0;3>e;e++)l=3*u[g++],q=new THREE.Vector3(x[l++],x[l++],x[l]),t.vertexNormals.push(q);k&&(k=u[g++],t.color.setHex(v[k]));if(p)for(e=0;3>e;e++)k=u[g++],t.vertexColors.push(new THREE.Color(v[k]));c.faces.push(t)}if(a.skinWeights){g=0;for(i=a.skinWeights.length;g<i;g+=2)u=a.skinWeights[g],x=a.skinWeights[g+1],c.skinWeights.push(new THREE.Vector4(u,x,0,0))}if(a.skinIndices){g=0;for(i=a.skinIndices.length;g<
i;g+=2)u=a.skinIndices[g],x=a.skinIndices[g+1],c.skinIndices.push(new THREE.Vector4(u,x,0,0))}c.bones=a.bones;c.animation=a.animation;if(void 0!==a.morphTargets){g=0;for(i=a.morphTargets.length;g<i;g++){c.morphTargets[g]={};c.morphTargets[g].name=a.morphTargets[g].name;c.morphTargets[g].vertices=[];v=c.morphTargets[g].vertices;D=a.morphTargets[g].vertices;u=0;for(x=D.length;u<x;u+=3)p=new THREE.Vector3,p.x=D[u]*d,p.y=D[u+1]*d,p.z=D[u+2]*d,v.push(p)}}if(void 0!==a.morphColors){g=0;for(i=a.morphColors.length;g<
i;g++){c.morphColors[g]={};c.morphColors[g].name=a.morphColors[g].name;c.morphColors[g].colors=[];x=c.morphColors[g].colors;v=a.morphColors[g].colors;d=0;for(u=v.length;d<u;d+=3)D=new THREE.Color(16755200),D.setRGB(v[d],v[d+1],v[d+2]),x.push(D)}}c.computeCentroids();c.computeFaceNormals();c.computeBoundingSphere();if(void 0===a.materials)return{geometry:c};d=this.initMaterials(a.materials,b);this.needsTangents(d)&&c.computeTangents();return{geometry:c,materials:d}};THREE.LoadingManager=function(a,b,c){var d=this,e=0,f=0;this.onLoad=a;this.onProgress=b;this.onError=c;this.itemStart=function(){f++};this.itemEnd=function(a){e++;if(void 0!==d.onProgress)d.onProgress(a,e,f);if(e===f&&void 0!==d.onLoad)d.onLoad()}};THREE.DefaultLoadingManager=new THREE.LoadingManager;THREE.BufferGeometryLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager};
THREE.BufferGeometryLoader.prototype={constructor:THREE.BufferGeometryLoader,load:function(a,b){var c=this,d=new THREE.XHRLoader;d.setCrossOrigin(this.crossOrigin);d.load(a,function(a){b(c.parse(JSON.parse(a)))})},setCrossOrigin:function(a){this.crossOrigin=a},parse:function(a){var b=new THREE.BufferGeometry,c=a.attributes,d=a.offsets,a=a.boundingSphere,e;for(e in c){var f=c[e];b.attributes[e]={itemSize:f.itemSize,array:new self[f.type](f.array)}}void 0!==d&&(b.offsets=JSON.parse(JSON.stringify(d)));
void 0!==a&&(b.boundingSphere=new THREE.Sphere((new THREE.Vector3).fromArray(void 0!==a.center?a.center:[0,0,0]),a.radius));return b}};THREE.GeometryLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager};THREE.GeometryLoader.prototype={constructor:THREE.GeometryLoader,load:function(a,b){var c=this,d=new THREE.XHRLoader;d.setCrossOrigin(this.crossOrigin);d.load(a,function(a){b(c.parse(JSON.parse(a)))})},setCrossOrigin:function(a){this.crossOrigin=a},parse:function(){}};THREE.MaterialLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager};
THREE.MaterialLoader.prototype={constructor:THREE.MaterialLoader,load:function(a,b){var c=this,d=new THREE.XHRLoader;d.setCrossOrigin(this.crossOrigin);d.load(a,function(a){b(c.parse(JSON.parse(a)))})},setCrossOrigin:function(a){this.crossOrigin=a},parse:function(a){var b=new THREE[a.type];void 0!==a.color&&b.color.setHex(a.color);void 0!==a.ambient&&b.ambient.setHex(a.ambient);void 0!==a.emissive&&b.emissive.setHex(a.emissive);void 0!==a.specular&&b.specular.setHex(a.specular);void 0!==a.shininess&&
(b.shininess=a.shininess);void 0!==a.vertexColors&&(b.vertexColors=a.vertexColors);void 0!==a.blending&&(b.blending=a.blending);void 0!==a.opacity&&(b.opacity=a.opacity);void 0!==a.transparent&&(b.transparent=a.transparent);void 0!==a.wireframe&&(b.wireframe=a.wireframe);if(void 0!==a.materials)for(var c=0,d=a.materials.length;c<d;c++)b.materials.push(this.parse(a.materials[c]));return b}};THREE.ObjectLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager};
THREE.ObjectLoader.prototype={constructor:THREE.ObjectLoader,load:function(a,b){var c=this,d=new THREE.XHRLoader(c.manager);d.setCrossOrigin(this.crossOrigin);d.load(a,function(a){b(c.parse(JSON.parse(a)))})},setCrossOrigin:function(a){this.crossOrigin=a},parse:function(a){var b=this.parseGeometries(a.geometries),c=this.parseMaterials(a.materials);return this.parseObject(a.object,b,c)},parseGeometries:function(a){var b={};if(void 0!==a)for(var c=new THREE.JSONLoader,d=new THREE.BufferGeometryLoader,
e=0,f=a.length;e<f;e++){var h,g=a[e];switch(g.type){case "PlaneGeometry":h=new THREE.PlaneGeometry(g.width,g.height,g.widthSegments,g.heightSegments);break;case "CircleGeometry":h=new THREE.CircleGeometry(g.radius,g.segments);break;case "CubeGeometry":h=new THREE.CubeGeometry(g.width,g.height,g.depth,g.widthSegments,g.heightSegments,g.depthSegments);break;case "CylinderGeometry":h=new THREE.CylinderGeometry(g.radiusTop,g.radiusBottom,g.height,g.radiusSegments,g.heightSegments,g.openEnded);break;case "SphereGeometry":h=
new THREE.SphereGeometry(g.radius,g.widthSegments,g.heightSegments,g.phiStart,g.phiLength,g.thetaStart,g.thetaLength);break;case "IcosahedronGeometry":h=new THREE.IcosahedronGeometry(g.radius,g.detail);break;case "TorusGeometry":h=new THREE.TorusGeometry(g.radius,g.tube,g.radialSegments,g.tubularSegments,g.arc);break;case "TorusKnotGeometry":h=new THREE.TorusKnotGeometry(g.radius,g.tube,g.radialSegments,g.tubularSegments,g.p,g.q,g.heightScale);break;case "BufferGeometry":h=d.parse(g.data);break;case "Geometry":h=
c.parse(g.data).geometry}h.uuid=g.uuid;void 0!==g.name&&(h.name=g.name);b[g.uuid]=h}return b},parseMaterials:function(a){var b={};if(void 0!==a)for(var c=new THREE.MaterialLoader,d=0,e=a.length;d<e;d++){var f=a[d],h=c.parse(f);h.uuid=f.uuid;void 0!==f.name&&(h.name=f.name);b[f.uuid]=h}return b},parseObject:function(){var a=new THREE.Matrix4;return function(b,c,d){var e;switch(b.type){case "Scene":e=new THREE.Scene;break;case "PerspectiveCamera":e=new THREE.PerspectiveCamera(b.fov,b.aspect,b.near,
b.far);break;case "OrthographicCamera":e=new THREE.OrthographicCamera(b.left,b.right,b.top,b.bottom,b.near,b.far);break;case "AmbientLight":e=new THREE.AmbientLight(b.color);break;case "DirectionalLight":e=new THREE.DirectionalLight(b.color,b.intensity);break;case "PointLight":e=new THREE.PointLight(b.color,b.intensity,b.distance);break;case "SpotLight":e=new THREE.SpotLight(b.color,b.intensity,b.distance,b.angle,b.exponent);break;case "HemisphereLight":e=new THREE.HemisphereLight(b.color,b.groundColor,
b.intensity);break;case "Mesh":e=c[b.geometry];var f=d[b.material];void 0===e&&console.error("THREE.ObjectLoader: Undefined geometry "+b.geometry);void 0===f&&console.error("THREE.ObjectLoader: Undefined material "+b.material);e=new THREE.Mesh(e,f);break;default:e=new THREE.Object3D}e.uuid=b.uuid;void 0!==b.name&&(e.name=b.name);void 0!==b.matrix?(a.fromArray(b.matrix),a.decompose(e.position,e.quaternion,e.scale)):(void 0!==b.position&&e.position.fromArray(b.position),void 0!==b.rotation&&e.rotation.fromArray(b.rotation),
void 0!==b.scale&&e.scale.fromArray(b.scale));void 0!==b.visible&&(e.visible=b.visible);void 0!==b.userData&&(e.userData=b.userData);if(void 0!==b.children)for(var h in b.children)e.add(this.parseObject(b.children[h],c,d));return e}}()};THREE.SceneLoader=function(){this.onLoadStart=function(){};this.onLoadProgress=function(){};this.onLoadComplete=function(){};this.callbackSync=function(){};this.callbackProgress=function(){};this.geometryHandlers={};this.hierarchyHandlers={};this.addGeometryHandler("ascii",THREE.JSONLoader)};
THREE.SceneLoader.prototype={constructor:THREE.SceneLoader,load:function(a,b){var c=this,d=new THREE.XHRLoader(c.manager);d.setCrossOrigin(this.crossOrigin);d.load(a,function(d){c.parse(JSON.parse(d),b,a)})},setCrossOrigin:function(a){this.crossOrigin=a},addGeometryHandler:function(a,b){this.geometryHandlers[a]={loaderClass:b}},addHierarchyHandler:function(a,b){this.hierarchyHandlers[a]={loaderClass:b}},parse:function(a,b,c){function d(a,b){return"relativeToHTML"==b?a:p+"/"+a}function e(){f(y.scene,
E.objects)}function f(a,b){var c,e,h,i,k,l,p;for(p in b){var r=y.objects[p],s=b[p];if(void 0===r){if(s.type&&s.type in m.hierarchyHandlers){if(void 0===s.loading){e={type:1,url:1,material:1,position:1,rotation:1,scale:1,visible:1,children:1,userData:1,skin:1,morph:1,mirroredLoop:1,duration:1};h={};for(var D in s)D in e||(h[D]=s[D]);q=y.materials[s.material];s.loading=!0;e=m.hierarchyHandlers[s.type].loaderObject;e.options?e.load(d(s.url,E.urlBaseType),g(p,a,q,s)):e.load(d(s.url,E.urlBaseType),g(p,
a,q,s),h)}}else if(void 0!==s.geometry){if(t=y.geometries[s.geometry]){r=!1;q=y.materials[s.material];r=q instanceof THREE.ShaderMaterial;h=s.position;i=s.rotation;k=s.scale;c=s.matrix;l=s.quaternion;s.material||(q=new THREE.MeshFaceMaterial(y.face_materials[s.geometry]));q instanceof THREE.MeshFaceMaterial&&0===q.materials.length&&(q=new THREE.MeshFaceMaterial(y.face_materials[s.geometry]));if(q instanceof THREE.MeshFaceMaterial)for(e=0;e<q.materials.length;e++)r=r||q.materials[e]instanceof THREE.ShaderMaterial;
r&&t.computeTangents();s.skin?r=new THREE.SkinnedMesh(t,q):s.morph?(r=new THREE.MorphAnimMesh(t,q),void 0!==s.duration&&(r.duration=s.duration),void 0!==s.time&&(r.time=s.time),void 0!==s.mirroredLoop&&(r.mirroredLoop=s.mirroredLoop),q.morphNormals&&t.computeMorphNormals()):r=new THREE.Mesh(t,q);r.name=p;c?(r.matrixAutoUpdate=!1,r.matrix.set(c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8],c[9],c[10],c[11],c[12],c[13],c[14],c[15])):(r.position.fromArray(h),l?r.quaternion.fromArray(l):r.rotation.fromArray(i),
r.scale.fromArray(k));r.visible=s.visible;r.castShadow=s.castShadow;r.receiveShadow=s.receiveShadow;a.add(r);y.objects[p]=r}}else"DirectionalLight"===s.type||"PointLight"===s.type||"AmbientLight"===s.type?(x=void 0!==s.color?s.color:16777215,v=void 0!==s.intensity?s.intensity:1,"DirectionalLight"===s.type?(h=s.direction,u=new THREE.DirectionalLight(x,v),u.position.fromArray(h),s.target&&(M.push({object:u,targetName:s.target}),u.target=null)):"PointLight"===s.type?(h=s.position,e=s.distance,u=new THREE.PointLight(x,
v,e),u.position.fromArray(h)):"AmbientLight"===s.type&&(u=new THREE.AmbientLight(x)),a.add(u),u.name=p,y.lights[p]=u,y.objects[p]=u):"PerspectiveCamera"===s.type||"OrthographicCamera"===s.type?(h=s.position,i=s.rotation,l=s.quaternion,"PerspectiveCamera"===s.type?n=new THREE.PerspectiveCamera(s.fov,s.aspect,s.near,s.far):"OrthographicCamera"===s.type&&(n=new THREE.OrthographicCamera(s.left,s.right,s.top,s.bottom,s.near,s.far)),n.name=p,n.position.fromArray(h),void 0!==l?n.quaternion.fromArray(l):
void 0!==i&&n.rotation.fromArray(i),a.add(n),y.cameras[p]=n,y.objects[p]=n):(h=s.position,i=s.rotation,k=s.scale,l=s.quaternion,r=new THREE.Object3D,r.name=p,r.position.fromArray(h),l?r.quaternion.fromArray(l):r.rotation.fromArray(i),r.scale.fromArray(k),r.visible=void 0!==s.visible?s.visible:!1,a.add(r),y.objects[p]=r,y.empties[p]=r);if(r){if(void 0!==s.userData)for(var A in s.userData)r.userData[A]=s.userData[A];if(void 0!==s.groups)for(e=0;e<s.groups.length;e++)h=s.groups[e],void 0===y.groups[h]&&
(y.groups[h]=[]),y.groups[h].push(p)}}void 0!==r&&void 0!==s.children&&f(r,s.children)}}function h(a){return function(b,c){b.name=a;y.geometries[a]=b;y.face_materials[a]=c;e();D-=1;m.onLoadComplete();k()}}function g(a,b,c,d){return function(f){var f=f.content?f.content:f.dae?f.scene:f,h=d.rotation,g=d.quaternion,i=d.scale;f.position.fromArray(d.position);g?f.quaternion.fromArray(g):f.rotation.fromArray(h);f.scale.fromArray(i);c&&f.traverse(function(a){a.material=c});var l=void 0!==d.visible?d.visible:
!0;f.traverse(function(a){a.visible=l});b.add(f);f.name=a;y.objects[a]=f;e();D-=1;m.onLoadComplete();k()}}function i(a){return function(b,c){b.name=a;y.geometries[a]=b;y.face_materials[a]=c}}function k(){m.callbackProgress({totalModels:C,totalTextures:A,loadedModels:C-D,loadedTextures:A-z},y);m.onLoadProgress();if(0===D&&0===z){for(var a=0;a<M.length;a++){var c=M[a],d=y.objects[c.targetName];d?c.object.target=d:(c.object.target=new THREE.Object3D,y.scene.add(c.object.target));c.object.target.userData.targetInverse=
c.object}b(y)}}function l(a,b){b(a);if(void 0!==a.children)for(var c in a.children)l(a.children[c],b)}var m=this,p=THREE.Loader.prototype.extractUrlBase(c),t,q,n,r,s,u,x,v,D,z,C,A,y,M=[],E=a,J;for(J in this.geometryHandlers)a=this.geometryHandlers[J].loaderClass,this.geometryHandlers[J].loaderObject=new a;for(J in this.hierarchyHandlers)a=this.hierarchyHandlers[J].loaderClass,this.hierarchyHandlers[J].loaderObject=new a;z=D=0;y={scene:new THREE.Scene,geometries:{},face_materials:{},materials:{},textures:{},
objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}};if(E.transform&&(J=E.transform.position,a=E.transform.rotation,c=E.transform.scale,J&&y.scene.position.fromArray(J),a&&y.scene.rotation.fromArray(a),c&&y.scene.scale.fromArray(c),J||a||c))y.scene.updateMatrix(),y.scene.updateMatrixWorld();J=function(a){return function(){z-=a;k();m.onLoadComplete()}};for(var P in E.fogs)a=E.fogs[P],"linear"===a.type?r=new THREE.Fog(0,a.near,a.far):"exp2"===a.type&&(r=new THREE.FogExp2(0,a.density)),a=a.color,
r.color.setRGB(a[0],a[1],a[2]),y.fogs[P]=r;for(var F in E.geometries)r=E.geometries[F],r.type in this.geometryHandlers&&(D+=1,m.onLoadStart());for(var B in E.objects)l(E.objects[B],function(a){a.type&&a.type in m.hierarchyHandlers&&(D+=1,m.onLoadStart())});C=D;for(F in E.geometries)if(r=E.geometries[F],"cube"===r.type)t=new THREE.CubeGeometry(r.width,r.height,r.depth,r.widthSegments,r.heightSegments,r.depthSegments),t.name=F,y.geometries[F]=t;else if("plane"===r.type)t=new THREE.PlaneGeometry(r.width,
r.height,r.widthSegments,r.heightSegments),t.name=F,y.geometries[F]=t;else if("sphere"===r.type)t=new THREE.SphereGeometry(r.radius,r.widthSegments,r.heightSegments),t.name=F,y.geometries[F]=t;else if("cylinder"===r.type)t=new THREE.CylinderGeometry(r.topRad,r.botRad,r.height,r.radSegs,r.heightSegs),t.name=F,y.geometries[F]=t;else if("torus"===r.type)t=new THREE.TorusGeometry(r.radius,r.tube,r.segmentsR,r.segmentsT),t.name=F,y.geometries[F]=t;else if("icosahedron"===r.type)t=new THREE.IcosahedronGeometry(r.radius,
r.subdivisions),t.name=F,y.geometries[F]=t;else if(r.type in this.geometryHandlers){B={};for(s in r)"type"!==s&&"url"!==s&&(B[s]=r[s]);this.geometryHandlers[r.type].loaderObject.load(d(r.url,E.urlBaseType),h(F),B)}else"embedded"===r.type&&(B=E.embeds[r.id],B.metadata=E.metadata,B&&(B=this.geometryHandlers.ascii.loaderObject.parse(B,""),i(F)(B.geometry,B.materials)));for(var w in E.textures)if(F=E.textures[w],F.url instanceof Array){z+=F.url.length;for(s=0;s<F.url.length;s++)m.onLoadStart()}else z+=
1,m.onLoadStart();A=z;for(w in E.textures){F=E.textures[w];void 0!==F.mapping&&void 0!==THREE[F.mapping]&&(F.mapping=new THREE[F.mapping]);if(F.url instanceof Array){B=F.url.length;r=[];for(s=0;s<B;s++)r[s]=d(F.url[s],E.urlBaseType);s=(s=/\.dds$/i.test(r[0]))?THREE.ImageUtils.loadCompressedTextureCube(r,F.mapping,J(B)):THREE.ImageUtils.loadTextureCube(r,F.mapping,J(B))}else s=/\.dds$/i.test(F.url),B=d(F.url,E.urlBaseType),r=J(1),s=s?THREE.ImageUtils.loadCompressedTexture(B,F.mapping,r):THREE.ImageUtils.loadTexture(B,
F.mapping,r),void 0!==THREE[F.minFilter]&&(s.minFilter=THREE[F.minFilter]),void 0!==THREE[F.magFilter]&&(s.magFilter=THREE[F.magFilter]),F.anisotropy&&(s.anisotropy=F.anisotropy),F.repeat&&(s.repeat.set(F.repeat[0],F.repeat[1]),1!==F.repeat[0]&&(s.wrapS=THREE.RepeatWrapping),1!==F.repeat[1]&&(s.wrapT=THREE.RepeatWrapping)),F.offset&&s.offset.set(F.offset[0],F.offset[1]),F.wrap&&(B={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping},void 0!==B[F.wrap[0]]&&(s.wrapS=B[F.wrap[0]]),void 0!==
B[F.wrap[1]]&&(s.wrapT=B[F.wrap[1]]));y.textures[w]=s}var R,L;for(R in E.materials){w=E.materials[R];for(L in w.parameters)"envMap"===L||"map"===L||"lightMap"===L||"bumpMap"===L?w.parameters[L]=y.textures[w.parameters[L]]:"shading"===L?w.parameters[L]="flat"===w.parameters[L]?THREE.FlatShading:THREE.SmoothShading:"side"===L?w.parameters[L]="double"==w.parameters[L]?THREE.DoubleSide:"back"==w.parameters[L]?THREE.BackSide:THREE.FrontSide:"blending"===L?w.parameters[L]=w.parameters[L]in THREE?THREE[w.parameters[L]]:
THREE.NormalBlending:"combine"===L?w.parameters[L]=w.parameters[L]in THREE?THREE[w.parameters[L]]:THREE.MultiplyOperation:"vertexColors"===L?"face"==w.parameters[L]?w.parameters[L]=THREE.FaceColors:w.parameters[L]&&(w.parameters[L]=THREE.VertexColors):"wrapRGB"===L&&(J=w.parameters[L],w.parameters[L]=new THREE.Vector3(J[0],J[1],J[2]));void 0!==w.parameters.opacity&&1>w.parameters.opacity&&(w.parameters.transparent=!0);w.parameters.normalMap?(J=THREE.ShaderLib.normalmap,F=THREE.UniformsUtils.clone(J.uniforms),
s=w.parameters.color,B=w.parameters.specular,r=w.parameters.ambient,P=w.parameters.shininess,F.tNormal.value=y.textures[w.parameters.normalMap],w.parameters.normalScale&&F.uNormalScale.value.set(w.parameters.normalScale[0],w.parameters.normalScale[1]),w.parameters.map&&(F.tDiffuse.value=w.parameters.map,F.enableDiffuse.value=!0),w.parameters.envMap&&(F.tCube.value=w.parameters.envMap,F.enableReflection.value=!0,F.uReflectivity.value=w.parameters.reflectivity),w.parameters.lightMap&&(F.tAO.value=w.parameters.lightMap,
F.enableAO.value=!0),w.parameters.specularMap&&(F.tSpecular.value=y.textures[w.parameters.specularMap],F.enableSpecular.value=!0),w.parameters.displacementMap&&(F.tDisplacement.value=y.textures[w.parameters.displacementMap],F.enableDisplacement.value=!0,F.uDisplacementBias.value=w.parameters.displacementBias,F.uDisplacementScale.value=w.parameters.displacementScale),F.uDiffuseColor.value.setHex(s),F.uSpecularColor.value.setHex(B),F.uAmbientColor.value.setHex(r),F.uShininess.value=P,w.parameters.opacity&&
(F.uOpacity.value=w.parameters.opacity),q=new THREE.ShaderMaterial({fragmentShader:J.fragmentShader,vertexShader:J.vertexShader,uniforms:F,lights:!0,fog:!0})):q=new THREE[w.type](w.parameters);q.name=R;y.materials[R]=q}for(R in E.materials)if(w=E.materials[R],w.parameters.materials){L=[];for(s=0;s<w.parameters.materials.length;s++)L.push(y.materials[w.parameters.materials[s]]);y.materials[R].materials=L}e();y.cameras&&E.defaults.camera&&(y.currentCamera=y.cameras[E.defaults.camera]);y.fogs&&E.defaults.fog&&
(y.scene.fog=y.fogs[E.defaults.fog]);m.callbackSync(y);k()}};THREE.TextureLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager};THREE.TextureLoader.prototype={constructor:THREE.TextureLoader,load:function(a,b){var c=new THREE.ImageLoader(this.manager);c.setCrossOrigin(this.crossOrigin);c.load(a,function(a){a=new THREE.Texture(a);a.needsUpdate=!0;void 0!==b&&b(a)})},setCrossOrigin:function(a){this.crossOrigin=a}};THREE.Material=function(){this.id=THREE.MaterialIdCount++;this.uuid=THREE.Math.generateUUID();this.name="";this.side=THREE.FrontSide;this.opacity=1;this.transparent=!1;this.blending=THREE.NormalBlending;this.blendSrc=THREE.SrcAlphaFactor;this.blendDst=THREE.OneMinusSrcAlphaFactor;this.blendEquation=THREE.AddEquation;this.depthWrite=this.depthTest=!0;this.polygonOffset=!1;this.overdraw=this.alphaTest=this.polygonOffsetUnits=this.polygonOffsetFactor=0;this.needsUpdate=this.visible=!0};
THREE.Material.prototype={constructor:THREE.Material,setValues:function(a){if(void 0!==a)for(var b in a){var c=a[b];if(void 0===c)console.warn("THREE.Material: '"+b+"' parameter is undefined.");else if(b in this){var d=this[b];d instanceof THREE.Color?d.set(c):d instanceof THREE.Vector3&&c instanceof THREE.Vector3?d.copy(c):this[b]="overdraw"==b?Number(c):c}}},clone:function(a){void 0===a&&(a=new THREE.Material);a.name=this.name;a.side=this.side;a.opacity=this.opacity;a.transparent=this.transparent;
a.blending=this.blending;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.polygonOffset=this.polygonOffset;a.polygonOffsetFactor=this.polygonOffsetFactor;a.polygonOffsetUnits=this.polygonOffsetUnits;a.alphaTest=this.alphaTest;a.overdraw=this.overdraw;a.visible=this.visible;return a},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.EventDispatcher.prototype.apply(THREE.Material.prototype);
THREE.MaterialIdCount=0;THREE.LineBasicMaterial=function(a){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.linewidth=1;this.linejoin=this.linecap="round";this.vertexColors=!1;this.fog=!0;this.setValues(a)};THREE.LineBasicMaterial.prototype=Object.create(THREE.Material.prototype);
THREE.LineBasicMaterial.prototype.clone=function(){var a=new THREE.LineBasicMaterial;THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.linewidth=this.linewidth;a.linecap=this.linecap;a.linejoin=this.linejoin;a.vertexColors=this.vertexColors;a.fog=this.fog;return a};THREE.LineDashedMaterial=function(a){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.scale=this.linewidth=1;this.dashSize=3;this.gapSize=1;this.vertexColors=!1;this.fog=!0;this.setValues(a)};THREE.LineDashedMaterial.prototype=Object.create(THREE.Material.prototype);
THREE.LineDashedMaterial.prototype.clone=function(){var a=new THREE.LineDashedMaterial;THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.linewidth=this.linewidth;a.scale=this.scale;a.dashSize=this.dashSize;a.gapSize=this.gapSize;a.vertexColors=this.vertexColors;a.fog=this.fog;return a};THREE.MeshBasicMaterial=function(a){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.envMap=this.specularMap=this.lightMap=this.map=null;this.combine=THREE.MultiplyOperation;this.reflectivity=1;this.refractionRatio=0.98;this.fog=!0;this.shading=THREE.SmoothShading;this.wireframe=!1;this.wireframeLinewidth=1;this.wireframeLinejoin=this.wireframeLinecap="round";this.vertexColors=THREE.NoColors;this.morphTargets=this.skinning=!1;this.setValues(a)};
THREE.MeshBasicMaterial.prototype=Object.create(THREE.Material.prototype);
THREE.MeshBasicMaterial.prototype.clone=function(){var a=new THREE.MeshBasicMaterial;THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.map=this.map;a.lightMap=this.lightMap;a.specularMap=this.specularMap;a.envMap=this.envMap;a.combine=this.combine;a.reflectivity=this.reflectivity;a.refractionRatio=this.refractionRatio;a.fog=this.fog;a.shading=this.shading;a.wireframe=this.wireframe;a.wireframeLinewidth=this.wireframeLinewidth;a.wireframeLinecap=this.wireframeLinecap;a.wireframeLinejoin=
this.wireframeLinejoin;a.vertexColors=this.vertexColors;a.skinning=this.skinning;a.morphTargets=this.morphTargets;return a};THREE.MeshLambertMaterial=function(a){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.ambient=new THREE.Color(16777215);this.emissive=new THREE.Color(0);this.wrapAround=!1;this.wrapRGB=new THREE.Vector3(1,1,1);this.envMap=this.specularMap=this.lightMap=this.map=null;this.combine=THREE.MultiplyOperation;this.reflectivity=1;this.refractionRatio=0.98;this.fog=!0;this.shading=THREE.SmoothShading;this.wireframe=!1;this.wireframeLinewidth=1;this.wireframeLinejoin=this.wireframeLinecap=
"round";this.vertexColors=THREE.NoColors;this.morphNormals=this.morphTargets=this.skinning=!1;this.setValues(a)};THREE.MeshLambertMaterial.prototype=Object.create(THREE.Material.prototype);
THREE.MeshLambertMaterial.prototype.clone=function(){var a=new THREE.MeshLambertMaterial;THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.ambient.copy(this.ambient);a.emissive.copy(this.emissive);a.wrapAround=this.wrapAround;a.wrapRGB.copy(this.wrapRGB);a.map=this.map;a.lightMap=this.lightMap;a.specularMap=this.specularMap;a.envMap=this.envMap;a.combine=this.combine;a.reflectivity=this.reflectivity;a.refractionRatio=this.refractionRatio;a.fog=this.fog;a.shading=this.shading;
a.wireframe=this.wireframe;a.wireframeLinewidth=this.wireframeLinewidth;a.wireframeLinecap=this.wireframeLinecap;a.wireframeLinejoin=this.wireframeLinejoin;a.vertexColors=this.vertexColors;a.skinning=this.skinning;a.morphTargets=this.morphTargets;a.morphNormals=this.morphNormals;return a};THREE.MeshPhongMaterial=function(a){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.ambient=new THREE.Color(16777215);this.emissive=new THREE.Color(0);this.specular=new THREE.Color(1118481);this.shininess=30;this.metal=!1;this.perPixel=!0;this.wrapAround=!1;this.wrapRGB=new THREE.Vector3(1,1,1);this.bumpMap=this.lightMap=this.map=null;this.bumpScale=1;this.normalMap=null;this.normalScale=new THREE.Vector2(1,1);this.envMap=this.specularMap=null;this.combine=THREE.MultiplyOperation;
this.reflectivity=1;this.refractionRatio=0.98;this.fog=!0;this.shading=THREE.SmoothShading;this.wireframe=!1;this.wireframeLinewidth=1;this.wireframeLinejoin=this.wireframeLinecap="round";this.vertexColors=THREE.NoColors;this.morphNormals=this.morphTargets=this.skinning=!1;this.setValues(a)};THREE.MeshPhongMaterial.prototype=Object.create(THREE.Material.prototype);
THREE.MeshPhongMaterial.prototype.clone=function(){var a=new THREE.MeshPhongMaterial;THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.ambient.copy(this.ambient);a.emissive.copy(this.emissive);a.specular.copy(this.specular);a.shininess=this.shininess;a.metal=this.metal;a.perPixel=this.perPixel;a.wrapAround=this.wrapAround;a.wrapRGB.copy(this.wrapRGB);a.map=this.map;a.lightMap=this.lightMap;a.bumpMap=this.bumpMap;a.bumpScale=this.bumpScale;a.normalMap=this.normalMap;a.normalScale.copy(this.normalScale);
a.specularMap=this.specularMap;a.envMap=this.envMap;a.combine=this.combine;a.reflectivity=this.reflectivity;a.refractionRatio=this.refractionRatio;a.fog=this.fog;a.shading=this.shading;a.wireframe=this.wireframe;a.wireframeLinewidth=this.wireframeLinewidth;a.wireframeLinecap=this.wireframeLinecap;a.wireframeLinejoin=this.wireframeLinejoin;a.vertexColors=this.vertexColors;a.skinning=this.skinning;a.morphTargets=this.morphTargets;a.morphNormals=this.morphNormals;return a};THREE.MeshDepthMaterial=function(a){THREE.Material.call(this);this.wireframe=!1;this.wireframeLinewidth=1;this.setValues(a)};THREE.MeshDepthMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshDepthMaterial.prototype.clone=function(){var a=new THREE.MeshDepthMaterial;THREE.Material.prototype.clone.call(this,a);a.wireframe=this.wireframe;a.wireframeLinewidth=this.wireframeLinewidth;return a};THREE.MeshNormalMaterial=function(a){THREE.Material.call(this,a);this.shading=THREE.FlatShading;this.wireframe=!1;this.wireframeLinewidth=1;this.morphTargets=!1;this.setValues(a)};THREE.MeshNormalMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshNormalMaterial.prototype.clone=function(){var a=new THREE.MeshNormalMaterial;THREE.Material.prototype.clone.call(this,a);a.shading=this.shading;a.wireframe=this.wireframe;a.wireframeLinewidth=this.wireframeLinewidth;return a};THREE.MeshFaceMaterial=function(a){this.materials=a instanceof Array?a:[]};THREE.MeshFaceMaterial.prototype.clone=function(){for(var a=new THREE.MeshFaceMaterial,b=0;b<this.materials.length;b++)a.materials.push(this.materials[b].clone());return a};THREE.ParticleBasicMaterial=function(a){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.map=null;this.size=1;this.sizeAttenuation=!0;this.vertexColors=!1;this.fog=!0;this.setValues(a)};THREE.ParticleBasicMaterial.prototype=Object.create(THREE.Material.prototype);
THREE.ParticleBasicMaterial.prototype.clone=function(){var a=new THREE.ParticleBasicMaterial;THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.map=this.map;a.size=this.size;a.sizeAttenuation=this.sizeAttenuation;a.vertexColors=this.vertexColors;a.fog=this.fog;return a};THREE.ParticleCanvasMaterial=function(a){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.program=function(){};this.setValues(a)};THREE.ParticleCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.ParticleCanvasMaterial.prototype.clone=function(){var a=new THREE.ParticleCanvasMaterial;THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.program=this.program;return a};THREE.ShaderMaterial=function(a){THREE.Material.call(this);this.vertexShader=this.fragmentShader="void main() {}";this.uniforms={};this.defines={};this.attributes=null;this.shading=THREE.SmoothShading;this.linewidth=1;this.wireframe=!1;this.wireframeLinewidth=1;this.lights=this.fog=!1;this.vertexColors=THREE.NoColors;this.morphNormals=this.morphTargets=this.skinning=!1;this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]};this.index0AttributeName="position";this.setValues(a)};
THREE.ShaderMaterial.prototype=Object.create(THREE.Material.prototype);
THREE.ShaderMaterial.prototype.clone=function(){var a=new THREE.ShaderMaterial;THREE.Material.prototype.clone.call(this,a);a.fragmentShader=this.fragmentShader;a.vertexShader=this.vertexShader;a.uniforms=THREE.UniformsUtils.clone(this.uniforms);a.attributes=this.attributes;a.defines=this.defines;a.shading=this.shading;a.wireframe=this.wireframe;a.wireframeLinewidth=this.wireframeLinewidth;a.fog=this.fog;a.lights=this.lights;a.vertexColors=this.vertexColors;a.skinning=this.skinning;a.morphTargets=
this.morphTargets;a.morphNormals=this.morphNormals;return a};THREE.SpriteMaterial=function(a){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.map=new THREE.Texture;this.useScreenCoordinates=!0;this.depthTest=!this.useScreenCoordinates;this.sizeAttenuation=!this.useScreenCoordinates;this.scaleByViewport=!this.sizeAttenuation;this.alignment=THREE.SpriteAlignment.center.clone();this.fog=!1;this.uvOffset=new THREE.Vector2(0,0);this.uvScale=new THREE.Vector2(1,1);this.setValues(a);a=a||{};void 0===a.depthTest&&(this.depthTest=!this.useScreenCoordinates);
void 0===a.sizeAttenuation&&(this.sizeAttenuation=!this.useScreenCoordinates);void 0===a.scaleByViewport&&(this.scaleByViewport=!this.sizeAttenuation)};THREE.SpriteMaterial.prototype=Object.create(THREE.Material.prototype);
THREE.SpriteMaterial.prototype.clone=function(){var a=new THREE.SpriteMaterial;THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.map=this.map;a.useScreenCoordinates=this.useScreenCoordinates;a.sizeAttenuation=this.sizeAttenuation;a.scaleByViewport=this.scaleByViewport;a.alignment.copy(this.alignment);a.uvOffset.copy(this.uvOffset);a.uvScale.copy(this.uvScale);a.fog=this.fog;return a};THREE.SpriteAlignment={};THREE.SpriteAlignment.topLeft=new THREE.Vector2(1,-1);
THREE.SpriteAlignment.topCenter=new THREE.Vector2(0,-1);THREE.SpriteAlignment.topRight=new THREE.Vector2(-1,-1);THREE.SpriteAlignment.centerLeft=new THREE.Vector2(1,0);THREE.SpriteAlignment.center=new THREE.Vector2(0,0);THREE.SpriteAlignment.centerRight=new THREE.Vector2(-1,0);THREE.SpriteAlignment.bottomLeft=new THREE.Vector2(1,1);THREE.SpriteAlignment.bottomCenter=new THREE.Vector2(0,1);THREE.SpriteAlignment.bottomRight=new THREE.Vector2(-1,1);THREE.Texture=function(a,b,c,d,e,f,h,g,i){this.id=THREE.TextureIdCount++;this.uuid=THREE.Math.generateUUID();this.name="";this.image=a;this.mipmaps=[];this.mapping=void 0!==b?b:new THREE.UVMapping;this.wrapS=void 0!==c?c:THREE.ClampToEdgeWrapping;this.wrapT=void 0!==d?d:THREE.ClampToEdgeWrapping;this.magFilter=void 0!==e?e:THREE.LinearFilter;this.minFilter=void 0!==f?f:THREE.LinearMipMapLinearFilter;this.anisotropy=void 0!==i?i:1;this.format=void 0!==h?h:THREE.RGBAFormat;this.type=void 0!==g?g:THREE.UnsignedByteType;
this.offset=new THREE.Vector2(0,0);this.repeat=new THREE.Vector2(1,1);this.generateMipmaps=!0;this.premultiplyAlpha=!1;this.flipY=!0;this.unpackAlignment=4;this.needsUpdate=!1;this.onUpdate=null};
THREE.Texture.prototype={constructor:THREE.Texture,clone:function(a){void 0===a&&(a=new THREE.Texture);a.image=this.image;a.mipmaps=this.mipmaps.slice(0);a.mapping=this.mapping;a.wrapS=this.wrapS;a.wrapT=this.wrapT;a.magFilter=this.magFilter;a.minFilter=this.minFilter;a.anisotropy=this.anisotropy;a.format=this.format;a.type=this.type;a.offset.copy(this.offset);a.repeat.copy(this.repeat);a.generateMipmaps=this.generateMipmaps;a.premultiplyAlpha=this.premultiplyAlpha;a.flipY=this.flipY;a.unpackAlignment=
this.unpackAlignment;return a},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.EventDispatcher.prototype.apply(THREE.Texture.prototype);THREE.TextureIdCount=0;THREE.CompressedTexture=function(a,b,c,d,e,f,h,g,i,k,l){THREE.Texture.call(this,null,f,h,g,i,k,d,e,l);this.image={width:b,height:c};this.mipmaps=a;this.generateMipmaps=!1};THREE.CompressedTexture.prototype=Object.create(THREE.Texture.prototype);THREE.CompressedTexture.prototype.clone=function(){var a=new THREE.CompressedTexture;THREE.Texture.prototype.clone.call(this,a);return a};THREE.DataTexture=function(a,b,c,d,e,f,h,g,i,k,l){THREE.Texture.call(this,null,f,h,g,i,k,d,e,l);this.image={data:a,width:b,height:c}};THREE.DataTexture.prototype=Object.create(THREE.Texture.prototype);THREE.DataTexture.prototype.clone=function(){var a=new THREE.DataTexture;THREE.Texture.prototype.clone.call(this,a);return a};THREE.Particle=function(a){THREE.Object3D.call(this);this.material=a};THREE.Particle.prototype=Object.create(THREE.Object3D.prototype);THREE.Particle.prototype.clone=function(a){void 0===a&&(a=new THREE.Particle(this.material));THREE.Object3D.prototype.clone.call(this,a);return a};THREE.ParticleSystem=function(a,b){THREE.Object3D.call(this);this.geometry=void 0!==a?a:new THREE.Geometry;this.material=void 0!==b?b:new THREE.ParticleBasicMaterial({color:16777215*Math.random()});this.frustumCulled=this.sortParticles=!1};THREE.ParticleSystem.prototype=Object.create(THREE.Object3D.prototype);
THREE.ParticleSystem.prototype.clone=function(a){void 0===a&&(a=new THREE.ParticleSystem(this.geometry,this.material));a.sortParticles=this.sortParticles;THREE.Object3D.prototype.clone.call(this,a);return a};THREE.Line=function(a,b,c){THREE.Object3D.call(this);this.geometry=void 0!==a?a:new THREE.Geometry;this.material=void 0!==b?b:new THREE.LineBasicMaterial({color:16777215*Math.random()});this.type=void 0!==c?c:THREE.LineStrip};THREE.LineStrip=0;THREE.LinePieces=1;THREE.Line.prototype=Object.create(THREE.Object3D.prototype);THREE.Line.prototype.clone=function(a){void 0===a&&(a=new THREE.Line(this.geometry,this.material,this.type));THREE.Object3D.prototype.clone.call(this,a);return a};THREE.Mesh=function(a,b){THREE.Object3D.call(this);this.geometry=void 0!==a?a:new THREE.Geometry;this.material=void 0!==b?b:new THREE.MeshBasicMaterial({color:16777215*Math.random()});this.updateMorphTargets()};THREE.Mesh.prototype=Object.create(THREE.Object3D.prototype);
THREE.Mesh.prototype.updateMorphTargets=function(){if(0<this.geometry.morphTargets.length){this.morphTargetBase=-1;this.morphTargetForcedOrder=[];this.morphTargetInfluences=[];this.morphTargetDictionary={};for(var a=0,b=this.geometry.morphTargets.length;a<b;a++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[this.geometry.morphTargets[a].name]=a}};
THREE.Mesh.prototype.getMorphTargetIndexByName=function(a){if(void 0!==this.morphTargetDictionary[a])return this.morphTargetDictionary[a];console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+a+" does not exist. Returning 0.");return 0};THREE.Mesh.prototype.clone=function(a){void 0===a&&(a=new THREE.Mesh(this.geometry,this.material));THREE.Object3D.prototype.clone.call(this,a);return a};THREE.Bone=function(a){THREE.Object3D.call(this);this.skin=a;this.skinMatrix=new THREE.Matrix4};THREE.Bone.prototype=Object.create(THREE.Object3D.prototype);THREE.Bone.prototype.update=function(a,b){this.matrixAutoUpdate&&(b|=this.updateMatrix());if(b||this.matrixWorldNeedsUpdate)a?this.skinMatrix.multiplyMatrices(a,this.matrix):this.skinMatrix.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,b=!0;var c,d=this.children.length;for(c=0;c<d;c++)this.children[c].update(this.skinMatrix,b)};THREE.SkinnedMesh=function(a,b,c){THREE.Mesh.call(this,a,b);this.useVertexTexture=void 0!==c?c:!0;this.identityMatrix=new THREE.Matrix4;this.bones=[];this.boneMatrices=[];var d,e,f;if(this.geometry&&void 0!==this.geometry.bones){for(a=0;a<this.geometry.bones.length;a++)c=this.geometry.bones[a],d=c.pos,e=c.rotq,f=c.scl,b=this.addBone(),b.name=c.name,b.position.set(d[0],d[1],d[2]),b.quaternion.set(e[0],e[1],e[2],e[3]),void 0!==f?b.scale.set(f[0],f[1],f[2]):b.scale.set(1,1,1);for(a=0;a<this.bones.length;a++)c=
this.geometry.bones[a],b=this.bones[a],-1===c.parent?this.add(b):this.bones[c.parent].add(b);a=this.bones.length;this.useVertexTexture?(this.boneTextureHeight=this.boneTextureWidth=a=256<a?64:64<a?32:16<a?16:8,this.boneMatrices=new Float32Array(4*this.boneTextureWidth*this.boneTextureHeight),this.boneTexture=new THREE.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,THREE.RGBAFormat,THREE.FloatType),this.boneTexture.minFilter=THREE.NearestFilter,this.boneTexture.magFilter=
THREE.NearestFilter,this.boneTexture.generateMipmaps=!1,this.boneTexture.flipY=!1):this.boneMatrices=new Float32Array(16*a);this.pose()}};THREE.SkinnedMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.SkinnedMesh.prototype.addBone=function(a){void 0===a&&(a=new THREE.Bone(this));this.bones.push(a);return a};
THREE.SkinnedMesh.prototype.updateMatrixWorld=function(){var a=new THREE.Matrix4;return function(b){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||b)this.parent?this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1;for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];d instanceof THREE.Bone?d.update(this.identityMatrix,!1):d.updateMatrixWorld(!0)}if(void 0==this.boneInverses){this.boneInverses=
[];b=0;for(c=this.bones.length;b<c;b++)d=new THREE.Matrix4,d.getInverse(this.bones[b].skinMatrix),this.boneInverses.push(d)}b=0;for(c=this.bones.length;b<c;b++)a.multiplyMatrices(this.bones[b].skinMatrix,this.boneInverses[b]),a.flattenToArrayOffset(this.boneMatrices,16*b);this.useVertexTexture&&(this.boneTexture.needsUpdate=!0)}}();THREE.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(!0);this.normalizeSkinWeights()};
THREE.SkinnedMesh.prototype.normalizeSkinWeights=function(){if(this.geometry instanceof THREE.Geometry)for(var a=0;a<this.geometry.skinIndices.length;a++){var b=this.geometry.skinWeights[a],c=1/b.lengthManhattan();Infinity!==c?b.multiplyScalar(c):b.set(1)}};THREE.SkinnedMesh.prototype.clone=function(a){void 0===a&&(a=new THREE.SkinnedMesh(this.geometry,this.material,this.useVertexTexture));THREE.Mesh.prototype.clone.call(this,a);return a};THREE.MorphAnimMesh=function(a,b){THREE.Mesh.call(this,a,b);this.duration=1E3;this.mirroredLoop=!1;this.currentKeyframe=this.lastKeyframe=this.time=0;this.direction=1;this.directionBackwards=!1;this.setFrameRange(0,this.geometry.morphTargets.length-1)};THREE.MorphAnimMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.MorphAnimMesh.prototype.setFrameRange=function(a,b){this.startKeyframe=a;this.endKeyframe=b;this.length=this.endKeyframe-this.startKeyframe+1};
THREE.MorphAnimMesh.prototype.setDirectionForward=function(){this.direction=1;this.directionBackwards=!1};THREE.MorphAnimMesh.prototype.setDirectionBackward=function(){this.direction=-1;this.directionBackwards=!0};
THREE.MorphAnimMesh.prototype.parseAnimations=function(){var a=this.geometry;a.animations||(a.animations={});for(var b,c=a.animations,d=/([a-z]+)(\d+)/,e=0,f=a.morphTargets.length;e<f;e++){var h=a.morphTargets[e].name.match(d);if(h&&1<h.length){h=h[1];c[h]||(c[h]={start:Infinity,end:-Infinity});var g=c[h];e<g.start&&(g.start=e);e>g.end&&(g.end=e);b||(b=h)}}a.firstAnimation=b};
THREE.MorphAnimMesh.prototype.setAnimationLabel=function(a,b,c){this.geometry.animations||(this.geometry.animations={});this.geometry.animations[a]={start:b,end:c}};THREE.MorphAnimMesh.prototype.playAnimation=function(a,b){var c=this.geometry.animations[a];c?(this.setFrameRange(c.start,c.end),this.duration=1E3*((c.end-c.start)/b),this.time=0):console.warn("animation["+a+"] undefined")};
THREE.MorphAnimMesh.prototype.updateAnimation=function(a){var b=this.duration/this.length;this.time+=this.direction*a;if(this.mirroredLoop){if(this.time>this.duration||0>this.time)this.direction*=-1,this.time>this.duration&&(this.time=this.duration,this.directionBackwards=!0),0>this.time&&(this.time=0,this.directionBackwards=!1)}else this.time%=this.duration,0>this.time&&(this.time+=this.duration);a=this.startKeyframe+THREE.Math.clamp(Math.floor(this.time/b),0,this.length-1);a!==this.currentKeyframe&&
(this.morphTargetInfluences[this.lastKeyframe]=0,this.morphTargetInfluences[this.currentKeyframe]=1,this.morphTargetInfluences[a]=0,this.lastKeyframe=this.currentKeyframe,this.currentKeyframe=a);b=this.time%b/b;this.directionBackwards&&(b=1-b);this.morphTargetInfluences[this.currentKeyframe]=b;this.morphTargetInfluences[this.lastKeyframe]=1-b};
THREE.MorphAnimMesh.prototype.clone=function(a){void 0===a&&(a=new THREE.MorphAnimMesh(this.geometry,this.material));a.duration=this.duration;a.mirroredLoop=this.mirroredLoop;a.time=this.time;a.lastKeyframe=this.lastKeyframe;a.currentKeyframe=this.currentKeyframe;a.direction=this.direction;a.directionBackwards=this.directionBackwards;THREE.Mesh.prototype.clone.call(this,a);return a};THREE.LOD=function(){THREE.Object3D.call(this);this.objects=[]};THREE.LOD.prototype=Object.create(THREE.Object3D.prototype);THREE.LOD.prototype.addLevel=function(a,b){void 0===b&&(b=0);for(var b=Math.abs(b),c=0;c<this.objects.length&&!(b<this.objects[c].distance);c++);this.objects.splice(c,0,{distance:b,object:a});this.add(a)};THREE.LOD.prototype.getObjectForDistance=function(a){for(var b=1,c=this.objects.length;b<c&&!(a<this.objects[b].distance);b++);return this.objects[b-1].object};
THREE.LOD.prototype.update=function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c){if(1<this.objects.length){a.getPositionFromMatrix(c.matrixWorld);b.getPositionFromMatrix(this.matrixWorld);c=a.distanceTo(b);this.objects[0].object.visible=!0;for(var d=1,e=this.objects.length;d<e;d++)if(c>=this.objects[d].distance)this.objects[d-1].object.visible=!1,this.objects[d].object.visible=!0;else break;for(;d<e;d++)this.objects[d].object.visible=!1}}}();THREE.LOD.prototype.clone=function(){};THREE.Sprite=function(a){THREE.Object3D.call(this);this.material=void 0!==a?a:new THREE.SpriteMaterial;this.rotation3d=this.rotation;this.rotation=0};THREE.Sprite.prototype=Object.create(THREE.Object3D.prototype);THREE.Sprite.prototype.updateMatrix=function(){this.rotation3d.set(0,0,this.rotation,this.rotation3d.order);this.quaternion.setFromEuler(this.rotation3d);this.matrix.compose(this.position,this.quaternion,this.scale);this.matrixWorldNeedsUpdate=!0};
THREE.Sprite.prototype.clone=function(a){void 0===a&&(a=new THREE.Sprite(this.material));THREE.Object3D.prototype.clone.call(this,a);return a};THREE.Scene=function(){THREE.Object3D.call(this);this.overrideMaterial=this.fog=null;this.autoUpdate=!0;this.matrixAutoUpdate=!1;this.__lights=[];this.__objectsAdded=[];this.__objectsRemoved=[]};THREE.Scene.prototype=Object.create(THREE.Object3D.prototype);
THREE.Scene.prototype.__addObject=function(a){if(a instanceof THREE.Light)-1===this.__lights.indexOf(a)&&this.__lights.push(a),a.target&&void 0===a.target.parent&&this.add(a.target);else if(!(a instanceof THREE.Camera)){this.__objectsAdded.push(a);var b=this.__objectsRemoved.indexOf(a);-1!==b&&this.__objectsRemoved.splice(b,1)}for(b=0;b<a.children.length;b++)this.__addObject(a.children[b])};
THREE.Scene.prototype.__removeObject=function(a){if(a instanceof THREE.Light){var b=this.__lights.indexOf(a);-1!==b&&this.__lights.splice(b,1);if(a.shadowCascadeArray)for(b=0;b<a.shadowCascadeArray.length;b++)this.__removeObject(a.shadowCascadeArray[b])}else a instanceof THREE.Camera||(this.__objectsRemoved.push(a),b=this.__objectsAdded.indexOf(a),-1!==b&&this.__objectsAdded.splice(b,1));for(b=0;b<a.children.length;b++)this.__removeObject(a.children[b])};
THREE.Scene.prototype.clone=function(a){void 0===a&&(a=new THREE.Scene);THREE.Object3D.prototype.clone.call(this,a);null!==this.fog&&(a.fog=this.fog.clone());null!==this.overrideMaterial&&(a.overrideMaterial=this.overrideMaterial.clone());a.autoUpdate=this.autoUpdate;a.matrixAutoUpdate=this.matrixAutoUpdate;return a};THREE.Fog=function(a,b,c){this.name="";this.color=new THREE.Color(a);this.near=void 0!==b?b:1;this.far=void 0!==c?c:1E3};THREE.Fog.prototype.clone=function(){return new THREE.Fog(this.color.getHex(),this.near,this.far)};THREE.FogExp2=function(a,b){this.name="";this.color=new THREE.Color(a);this.density=void 0!==b?b:2.5E-4};THREE.FogExp2.prototype.clone=function(){return new THREE.FogExp2(this.color.getHex(),this.density)};THREE.CanvasRenderer=function(a){function b(a,b,c){for(var d=0,e=v.length;d<e;d++){var f=v[d];Ea.copy(f.color);if(f instanceof THREE.DirectionalLight){var h=Da.getPositionFromMatrix(f.matrixWorld).normalize(),g=b.dot(h);0>=g||(g*=f.intensity,c.add(Ea.multiplyScalar(g)))}else f instanceof THREE.PointLight&&(h=Da.getPositionFromMatrix(f.matrixWorld),g=b.dot(Da.subVectors(h,a).normalize()),0>=g||(g*=0==f.distance?1:1-Math.min(a.distanceTo(h)/f.distance,1),0!=g&&(g*=f.intensity,c.add(Ea.multiplyScalar(g)))))}}
function c(a,b,c,d){l(b);m(c);p(d);t(a.getStyle());E.stroke();ta.expandByScalar(2*b)}function d(a){q(a.getStyle());E.fill()}function e(a,b,c,e,f,h,g,j,i,k,l,m,p){if(!(p instanceof THREE.DataTexture||void 0===p.image||0==p.image.width)){if(!0===p.needsUpdate){var n=p.wrapS==THREE.RepeatWrapping,t=p.wrapT==THREE.RepeatWrapping;Ia[p.id]=E.createPattern(p.image,!0===n&&!0===t?"repeat":!0===n&&!1===t?"repeat-x":!1===n&&!0===t?"repeat-y":"no-repeat");p.needsUpdate=!1}void 0===Ia[p.id]?q("rgba(0,0,0,1)"):
q(Ia[p.id]);var n=p.offset.x/p.repeat.x,t=p.offset.y/p.repeat.y,r=p.image.width*p.repeat.x,s=p.image.height*p.repeat.y,g=(g+n)*r,j=(1-j+t)*s,c=c-a,e=e-b,f=f-a,h=h-b,i=(i+n)*r-g,k=(1-k+t)*s-j,l=(l+n)*r-g,m=(1-m+t)*s-j,n=i*m-l*k;0===n?(void 0===va[p.id]&&(b=document.createElement("canvas"),b.width=p.image.width,b.height=p.image.height,b=b.getContext("2d"),b.drawImage(p.image,0,0),va[p.id]=b.getImageData(0,0,p.image.width,p.image.height).data),b=va[p.id],g=4*(Math.floor(g)+Math.floor(j)*p.image.width),
N.setRGB(b[g]/255,b[g+1]/255,b[g+2]/255),d(N)):(n=1/n,p=(m*c-k*f)*n,k=(m*e-k*h)*n,c=(i*f-l*c)*n,e=(i*h-l*e)*n,a=a-p*g-c*j,g=b-k*g-e*j,E.save(),E.transform(p,k,c,e,a,g),E.fill(),E.restore())}}function f(a,b,c,d,e,f,h,g,j,i,k,l,m){var p,n;p=m.width-1;n=m.height-1;h*=p;g*=n;c-=a;d-=b;e-=a;f-=b;j=j*p-h;i=i*n-g;k=k*p-h;l=l*n-g;n=1/(j*l-k*i);p=(l*c-i*e)*n;i=(l*d-i*f)*n;c=(j*e-k*c)*n;d=(j*f-k*d)*n;a=a-p*h-c*g;b=b-i*h-d*g;E.save();E.transform(p,i,c,d,a,b);E.clip();E.drawImage(m,0,0);E.restore()}function h(a,
b,c,d){qa[0]=255*a.r|0;qa[1]=255*a.g|0;qa[2]=255*a.b|0;qa[4]=255*b.r|0;qa[5]=255*b.g|0;qa[6]=255*b.b|0;qa[8]=255*c.r|0;qa[9]=255*c.g|0;qa[10]=255*c.b|0;qa[12]=255*d.r|0;qa[13]=255*d.g|0;qa[14]=255*d.b|0;Na.putImageData(Ua,0,0);bb.drawImage(j,0,0);return Fa}function g(a,b,c){var d=b.x-a.x,e=b.y-a.y,f=d*d+e*e;0!==f&&(c/=Math.sqrt(f),d*=c,e*=c,b.x+=d,b.y+=e,a.x-=d,a.y-=e)}function i(a){F!==a&&(F=E.globalAlpha=a)}function k(a){B!==a&&(a===THREE.NormalBlending?E.globalCompositeOperation="source-over":
a===THREE.AdditiveBlending?E.globalCompositeOperation="lighter":a===THREE.SubtractiveBlending&&(E.globalCompositeOperation="darker"),B=a)}function l(a){L!==a&&(L=E.lineWidth=a)}function m(a){fa!==a&&(fa=E.lineCap=a)}function p(a){ia!==a&&(ia=E.lineJoin=a)}function t(a){w!==a&&(w=E.strokeStyle=a)}function q(a){R!==a&&(R=E.fillStyle=a)}function n(a,b){if(oa!==a||H!==b)E.setLineDash([a,b]),oa=a,H=b}console.log("THREE.CanvasRenderer",THREE.REVISION);var r=THREE.Math.smoothstep,a=a||{},s=this,u,x,v,D=
new THREE.Projector,z=void 0!==a.canvas?a.canvas:document.createElement("canvas"),C,A,y,M,E=z.getContext("2d"),J=new THREE.Color(0),P=0,F=1,B=0,w=null,R=null,L=null,fa=null,ia=null,oa=null,H=0,T,I,W,ua;new THREE.RenderableVertex;new THREE.RenderableVertex;var U,Ba,Ca,ca,ea,X,N=new THREE.Color,$=new THREE.Color,ba=new THREE.Color,V=new THREE.Color,pa=new THREE.Color,sa=new THREE.Color,ja=new THREE.Color,Ea=new THREE.Color,Ia={},va={},Ha,cb,Ja,xa,pb,qb,fb,gb,vb,Pa,ya=new THREE.Box2,wa=new THREE.Box2,
ta=new THREE.Box2,ka=new THREE.Color,ga=new THREE.Color,Qa=new THREE.Color,Da=new THREE.Vector3,j,Na,Ua,qa,Fa,bb,Ra=16;j=document.createElement("canvas");j.width=j.height=2;Na=j.getContext("2d");Na.fillStyle="rgba(0,0,0,1)";Na.fillRect(0,0,2,2);Ua=Na.getImageData(0,0,2,2);qa=Ua.data;Fa=document.createElement("canvas");Fa.width=Fa.height=Ra;bb=Fa.getContext("2d");bb.translate(-Ra/2,-Ra/2);bb.scale(Ra,Ra);Ra--;void 0===E.setLineDash&&(E.setLineDash=void 0!==E.mozDash?function(a){E.mozDash=null!==a[0]?
a:null}:function(){});this.domElement=z;this.devicePixelRatio=void 0!==a.devicePixelRatio?a.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1;this.sortElements=this.sortObjects=this.autoClear=!0;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.setSize=function(a,b,c){C=a*this.devicePixelRatio;A=b*this.devicePixelRatio;y=Math.floor(C/2);M=Math.floor(A/2);z.width=C;z.height=A;1!==this.devicePixelRatio&&!1!==
c&&(z.style.width=a+"px",z.style.height=b+"px");ya.set(new THREE.Vector2(-y,-M),new THREE.Vector2(y,M));wa.set(new THREE.Vector2(-y,-M),new THREE.Vector2(y,M));F=1;B=0;ia=fa=L=R=w=null};this.setClearColor=function(a,b){J.set(a);P=void 0!==b?b:1;wa.set(new THREE.Vector2(-y,-M),new THREE.Vector2(y,M))};this.setClearColorHex=function(a,b){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(a,b)};this.getMaxAnisotropy=function(){return 0};
this.clear=function(){E.setTransform(1,0,0,-1,y,M);!1===wa.empty()&&(wa.intersect(ya),wa.expandByScalar(2),1>P&&E.clearRect(wa.min.x|0,wa.min.y|0,wa.max.x-wa.min.x|0,wa.max.y-wa.min.y|0),0<P&&(k(THREE.NormalBlending),i(1),q("rgba("+Math.floor(255*J.r)+","+Math.floor(255*J.g)+","+Math.floor(255*J.b)+","+P+")"),E.fillRect(wa.min.x|0,wa.min.y|0,wa.max.x-wa.min.x|0,wa.max.y-wa.min.y|0)),wa.makeEmpty())};this.render=function(a,j){if(!1===j instanceof THREE.Camera)console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");
else{!0===this.autoClear&&this.clear();E.setTransform(1,0,0,-1,y,M);s.info.render.vertices=0;s.info.render.faces=0;u=D.projectScene(a,j,this.sortObjects,this.sortElements);x=u.elements;v=u.lights;T=j;ka.setRGB(0,0,0);ga.setRGB(0,0,0);Qa.setRGB(0,0,0);for(var A=0,F=v.length;A<F;A++){var w=v[A],C=w.color;w instanceof THREE.AmbientLight?ka.add(C):w instanceof THREE.DirectionalLight?ga.add(C):w instanceof THREE.PointLight&&Qa.add(C)}A=0;for(F=x.length;A<F;A++){var z=x[A],B=z.material;if(!(void 0===B||
!1===B.visible)){ta.makeEmpty();if(z instanceof THREE.RenderableParticle){I=z;I.x*=y;I.y*=M;var w=I,C=z,H=B;i(H.opacity);k(H.blending);var L=B=z=void 0,J=void 0,P=void 0,R=void 0,fa=void 0;H instanceof THREE.ParticleBasicMaterial?null===H.map?(L=C.object.scale.x,J=C.object.scale.y,L*=C.scale.x*y,J*=C.scale.y*M,ta.min.set(w.x-L,w.y-J),ta.max.set(w.x+L,w.y+J),!1===ya.isIntersectionBox(ta)?ta.makeEmpty():(q(H.color.getStyle()),E.save(),E.translate(w.x,w.y),E.rotate(-C.rotation),E.scale(L,J),E.fillRect(-1,
-1,2,2),E.restore())):(P=H.map.image,R=P.width>>1,fa=P.height>>1,L=C.scale.x*y,J=C.scale.y*M,z=L*R,B=J*fa,ta.min.set(w.x-z,w.y-B),ta.max.set(w.x+z,w.y+B),!1===ya.isIntersectionBox(ta)?ta.makeEmpty():(E.save(),E.translate(w.x,w.y),E.rotate(-C.rotation),E.scale(L,-J),E.translate(-R,-fa),E.drawImage(P,0,0),E.restore())):H instanceof THREE.ParticleCanvasMaterial&&(z=C.scale.x*y,B=C.scale.y*M,ta.min.set(w.x-z,w.y-B),ta.max.set(w.x+z,w.y+B),!1===ya.isIntersectionBox(ta)?ta.makeEmpty():(t(H.color.getStyle()),
q(H.color.getStyle()),E.save(),E.translate(w.x,w.y),E.rotate(-C.rotation),E.scale(z,B),H.program(E),E.restore()))}else if(z instanceof THREE.RenderableLine){if(I=z.v1,W=z.v2,I.positionScreen.x*=y,I.positionScreen.y*=M,W.positionScreen.x*=y,W.positionScreen.y*=M,ta.setFromPoints([I.positionScreen,W.positionScreen]),!0===ya.isIntersectionBox(ta))if(w=I,C=W,H=z,z=B,i(z.opacity),k(z.blending),E.beginPath(),E.moveTo(w.positionScreen.x,w.positionScreen.y),E.lineTo(C.positionScreen.x,C.positionScreen.y),
z instanceof THREE.LineBasicMaterial){l(z.linewidth);m(z.linecap);p(z.linejoin);if(z.vertexColors!==THREE.VertexColors)t(z.color.getStyle());else if(B=H.vertexColors[0].getStyle(),H=H.vertexColors[1].getStyle(),B===H)t(B);else{try{var ia=E.createLinearGradient(w.positionScreen.x,w.positionScreen.y,C.positionScreen.x,C.positionScreen.y);ia.addColorStop(0,B);ia.addColorStop(1,H)}catch(qa){ia=B}t(ia)}E.stroke();ta.expandByScalar(2*z.linewidth)}else z instanceof THREE.LineDashedMaterial&&(l(z.linewidth),
m(z.linecap),p(z.linejoin),t(z.color.getStyle()),n(z.dashSize,z.gapSize),E.stroke(),ta.expandByScalar(2*z.linewidth),n(null,null))}else if(z instanceof THREE.RenderableFace3){I=z.v1;W=z.v2;ua=z.v3;if(-1>I.positionScreen.z||1<I.positionScreen.z)continue;if(-1>W.positionScreen.z||1<W.positionScreen.z)continue;if(-1>ua.positionScreen.z||1<ua.positionScreen.z)continue;I.positionScreen.x*=y;I.positionScreen.y*=M;W.positionScreen.x*=y;W.positionScreen.y*=M;ua.positionScreen.x*=y;ua.positionScreen.y*=M;
0<B.overdraw&&(g(I.positionScreen,W.positionScreen,B.overdraw),g(W.positionScreen,ua.positionScreen,B.overdraw),g(ua.positionScreen,I.positionScreen,B.overdraw));ta.setFromPoints([I.positionScreen,W.positionScreen,ua.positionScreen]);if(!0===ya.isIntersectionBox(ta)){w=I;C=W;H=ua;s.info.render.vertices+=3;s.info.render.faces++;i(B.opacity);k(B.blending);U=w.positionScreen.x;Ba=w.positionScreen.y;Ca=C.positionScreen.x;ca=C.positionScreen.y;ea=H.positionScreen.x;X=H.positionScreen.y;var L=U,J=Ba,P=
Ca,R=ca,fa=ea,oa=X;E.beginPath();E.moveTo(L,J);E.lineTo(P,R);E.lineTo(fa,oa);E.closePath();(B instanceof THREE.MeshLambertMaterial||B instanceof THREE.MeshPhongMaterial)&&null===B.map?(sa.copy(B.color),ja.copy(B.emissive),B.vertexColors===THREE.FaceColors&&sa.multiply(z.color),!1===B.wireframe&&B.shading==THREE.SmoothShading&&3==z.vertexNormalsLength?($.copy(ka),ba.copy(ka),V.copy(ka),b(z.v1.positionWorld,z.vertexNormalsModel[0],$),b(z.v2.positionWorld,z.vertexNormalsModel[1],ba),b(z.v3.positionWorld,
z.vertexNormalsModel[2],V),$.multiply(sa).add(ja),ba.multiply(sa).add(ja),V.multiply(sa).add(ja),pa.addColors(ba,V).multiplyScalar(0.5),Ja=h($,ba,V,pa),f(U,Ba,Ca,ca,ea,X,0,0,1,0,0,1,Ja)):(N.copy(ka),b(z.centroidModel,z.normalModel,N),N.multiply(sa).add(ja),!0===B.wireframe?c(N,B.wireframeLinewidth,B.wireframeLinecap,B.wireframeLinejoin):d(N))):B instanceof THREE.MeshBasicMaterial||B instanceof THREE.MeshLambertMaterial||B instanceof THREE.MeshPhongMaterial?null!==B.map?B.map.mapping instanceof THREE.UVMapping&&
(xa=z.uvs[0],e(U,Ba,Ca,ca,ea,X,xa[0].x,xa[0].y,xa[1].x,xa[1].y,xa[2].x,xa[2].y,B.map)):null!==B.envMap?B.envMap.mapping instanceof THREE.SphericalReflectionMapping&&(Da.copy(z.vertexNormalsModelView[0]),pb=0.5*Da.x+0.5,qb=0.5*Da.y+0.5,Da.copy(z.vertexNormalsModelView[1]),fb=0.5*Da.x+0.5,gb=0.5*Da.y+0.5,Da.copy(z.vertexNormalsModelView[2]),vb=0.5*Da.x+0.5,Pa=0.5*Da.y+0.5,e(U,Ba,Ca,ca,ea,X,pb,qb,fb,gb,vb,Pa,B.envMap)):(N.copy(B.color),B.vertexColors===THREE.FaceColors&&N.multiply(z.color),!0===B.wireframe?
c(N,B.wireframeLinewidth,B.wireframeLinecap,B.wireframeLinejoin):d(N)):B instanceof THREE.MeshDepthMaterial?(Ha=T.near,cb=T.far,$.r=$.g=$.b=1-r(w.positionScreen.z*w.positionScreen.w,Ha,cb),ba.r=ba.g=ba.b=1-r(C.positionScreen.z*C.positionScreen.w,Ha,cb),V.r=V.g=V.b=1-r(H.positionScreen.z*H.positionScreen.w,Ha,cb),pa.addColors(ba,V).multiplyScalar(0.5),Ja=h($,ba,V,pa),f(U,Ba,Ca,ca,ea,X,0,0,1,0,0,1,Ja)):B instanceof THREE.MeshNormalMaterial&&(w=void 0,B.shading==THREE.FlatShading?(w=z.normalModelView,
N.setRGB(w.x,w.y,w.z).multiplyScalar(0.5).addScalar(0.5),!0===B.wireframe?c(N,B.wireframeLinewidth,B.wireframeLinecap,B.wireframeLinejoin):d(N)):B.shading==THREE.SmoothShading&&(w=z.vertexNormalsModelView[0],$.setRGB(w.x,w.y,w.z).multiplyScalar(0.5).addScalar(0.5),w=z.vertexNormalsModelView[1],ba.setRGB(w.x,w.y,w.z).multiplyScalar(0.5).addScalar(0.5),w=z.vertexNormalsModelView[2],V.setRGB(w.x,w.y,w.z).multiplyScalar(0.5).addScalar(0.5),pa.addColors(ba,V).multiplyScalar(0.5),Ja=h($,ba,V,pa),f(U,Ba,
Ca,ca,ea,X,0,0,1,0,0,1,Ja)))}}wa.union(ta)}}E.setTransform(1,0,0,1,0,0)}}};THREE.ShaderChunk={fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;\nuniform float fogFar;\n#endif\n#endif",fog_fragment:"#ifdef USE_FOG\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#ifdef FOG_EXP2\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n#endif",
envmap_pars_fragment:"#ifdef USE_ENVMAP\nuniform float reflectivity;\nuniform samplerCube envMap;\nuniform float flipEnvMap;\nuniform int combine;\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nuniform bool useRefract;\nuniform float refractionRatio;\n#else\nvarying vec3 vReflect;\n#endif\n#endif",envmap_fragment:"#ifdef USE_ENVMAP\nvec3 reflectVec;\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\nif ( useRefract ) {\nreflectVec = refract( cameraToVertex, normal, refractionRatio );\n} else { \nreflectVec = reflect( cameraToVertex, normal );\n}\n#else\nreflectVec = vReflect;\n#endif\n#ifdef DOUBLE_SIDED\nfloat flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );\nvec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n#else\nvec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n#endif\n#ifdef GAMMA_INPUT\ncubeColor.xyz *= cubeColor.xyz;\n#endif\nif ( combine == 1 ) {\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );\n} else if ( combine == 2 ) {\ngl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;\n} else {\ngl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );\n}\n#endif",
envmap_pars_vertex:"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )\nvarying vec3 vReflect;\nuniform float refractionRatio;\nuniform bool useRefract;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\n#ifdef USE_SKINNING\nvec4 worldPosition = modelMatrix * skinned;\n#endif\n#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )\nvec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );\n#endif\n#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n#endif\n#endif",
envmap_vertex:"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )\nvec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;\nworldNormal = normalize( worldNormal );\nvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\nif ( useRefract ) {\nvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n} else {\nvReflect = reflect( cameraToVertex, worldNormal );\n}\n#endif",map_particle_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",
map_particle_fragment:"#ifdef USE_MAP\ngl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );\n#endif",map_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvarying vec2 vUv;\nuniform vec4 offsetRepeat;\n#endif",map_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif",
map_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n#endif",map_fragment:"#ifdef USE_MAP\nvec4 texelColor = texture2D( map, vUv );\n#ifdef GAMMA_INPUT\ntexelColor.xyz *= texelColor.xyz;\n#endif\ngl_FragColor = gl_FragColor * texelColor;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\nuniform sampler2D lightMap;\n#endif",lightmap_pars_vertex:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\n#endif",
lightmap_fragment:"#ifdef USE_LIGHTMAP\ngl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );\n#endif",lightmap_vertex:"#ifdef USE_LIGHTMAP\nvUv2 = uv2;\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\nuniform sampler2D bumpMap;\nuniform float bumpScale;\nvec2 dHdxy_fwd() {\nvec2 dSTdx = dFdx( vUv );\nvec2 dSTdy = dFdy( vUv );\nfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\nfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\nfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\nreturn vec2( dBx, dBy );\n}\nvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\nvec3 vSigmaX = dFdx( surf_pos );\nvec3 vSigmaY = dFdy( surf_pos );\nvec3 vN = surf_norm;\nvec3 R1 = cross( vSigmaY, vN );\nvec3 R2 = cross( vN, vSigmaX );\nfloat fDet = dot( vSigmaX, R1 );\nvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\nreturn normalize( abs( fDet ) * surf_norm - vGrad );\n}\n#endif",
specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\nuniform sampler2D specularMap;\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\nvec4 texelSpecular = texture2D( specularMap, vUv );\nspecularStrength = texelSpecular.r;\n#else\nspecularStrength = 1.0;\n#endif",lights_lambert_pars_vertex:"uniform vec3 ambient;\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif",
lights_lambert_vertex:"vLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\nvLightBack = vec3( 0.0 );\n#endif\ntransformedNormal = normalize( transformedNormal );\n#if MAX_DIR_LIGHTS > 0\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( transformedNormal, dirVector );\nvec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\ndirectionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\ndirectionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += directionalLightColor[ i ] * directionalLightWeighting;\n#ifdef DOUBLE_SIDED\nvLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;\n#endif\n}\n#endif\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat dotProduct = dot( transformedNormal, lVector );\nvec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\npointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\npointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;\n#ifdef DOUBLE_SIDED\nvLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;\n#endif\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nfor( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );\nif ( spotEffect > spotLightAngleCos[ i ] ) {\nspotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );\nfloat lDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat dotProduct = dot( transformedNormal, lVector );\nvec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\nspotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\nspotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;\n#ifdef DOUBLE_SIDED\nvLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;\n#endif\n}\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );\nvec3 lVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( transformedNormal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nfloat hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;\nvLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\n#ifdef DOUBLE_SIDED\nvLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );\n#endif\n}\n#endif\nvLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;\n#ifdef DOUBLE_SIDED\nvLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;\n#endif",
lights_phong_pars_vertex:"#ifndef PHONG_PER_PIXEL\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\nvarying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvarying vec3 vWorldPosition;\n#endif",
lights_phong_vertex:"#ifndef PHONG_PER_PIXEL\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nvPointLight[ i ] = vec4( lVector, lDistance );\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nfor( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\nvSpotLight[ i ] = vec4( lVector, lDistance );\n}\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvWorldPosition = worldPosition.xyz;\n#endif",
lights_phong_pars_fragment:"uniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\n#ifdef PHONG_PER_PIXEL\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#else\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\n#ifdef PHONG_PER_PIXEL\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n#else\nvarying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvarying vec3 vWorldPosition;\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",
lights_phong_fragment:"vec3 normal = normalize( vNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#ifdef DOUBLE_SIDED\nnormal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n#endif\n#ifdef USE_NORMALMAP\nnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\nnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse  = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\n#ifdef PHONG_PER_PIXEL\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz + vViewPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\n#else\nvec3 lVector = normalize( vPointLight[ i ].xyz );\nfloat lDistance = vPointLight[ i ].w;\n#endif\nfloat dotProduct = dot( normal, lVector );\n#ifdef WRAP_AROUND\nfloat pointDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );\n#else\nfloat pointDiffuseWeight = max( dotProduct, 0.0 );\n#endif\npointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;\nvec3 pointHalfVector = normalize( lVector + viewPosition );\nfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\nfloat pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );\npointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;\n#else\npointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;\n#endif\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nvec3 spotDiffuse  = vec3( 0.0 );\nvec3 spotSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\n#ifdef PHONG_PER_PIXEL\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz + vViewPosition.xyz;\nfloat lDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\n#else\nvec3 lVector = normalize( vSpotLight[ i ].xyz );\nfloat lDistance = vSpotLight[ i ].w;\n#endif\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );\nif ( spotEffect > spotLightAngleCos[ i ] ) {\nspotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );\nfloat dotProduct = dot( normal, lVector );\n#ifdef WRAP_AROUND\nfloat spotDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );\n#else\nfloat spotDiffuseWeight = max( dotProduct, 0.0 );\n#endif\nspotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;\nvec3 spotHalfVector = normalize( lVector + viewPosition );\nfloat spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );\nfloat spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );\nspotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;\n#else\nspotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;\n#endif\n}\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse  = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( normal, dirVector );\n#ifdef WRAP_AROUND\nfloat dirDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );\n#else\nfloat dirDiffuseWeight = max( dotProduct, 0.0 );\n#endif\ndirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;\nvec3 dirHalfVector = normalize( dirVector + viewPosition );\nfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\nfloat dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );\ndirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;\n#else\ndirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;\n#endif\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nvec3 hemiDiffuse  = vec3( 0.0 );\nvec3 hemiSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );\nvec3 lVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( normal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nvec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\nhemiDiffuse += diffuse * hemiColor;\nvec3 hemiHalfVectorSky = normalize( lVector + viewPosition );\nfloat hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;\nfloat hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );\nvec3 lVectorGround = -lVector;\nvec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );\nfloat hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;\nfloat hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat dotProductGround = dot( normal, lVectorGround );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );\nvec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );\nhemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );\n#else\nhemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;\n#endif\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_HEMI_LIGHTS > 0\ntotalDiffuse += hemiDiffuse;\ntotalSpecular += hemiSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\n#if MAX_SPOT_LIGHTS > 0\ntotalDiffuse += spotDiffuse;\ntotalSpecular += spotSpecular;\n#endif\n#ifdef METAL\ngl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;\n#endif",
color_pars_fragment:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_fragment:"#ifdef USE_COLOR\ngl_FragColor = gl_FragColor * vec4( vColor, opacity );\n#endif",color_pars_vertex:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n#ifdef GAMMA_INPUT\nvColor = color * color;\n#else\nvColor = color;\n#endif\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n#ifdef BONE_TEXTURE\nuniform sampler2D boneTexture;\nuniform int boneTextureWidth;\nuniform int boneTextureHeight;\nmat4 getBoneMatrix( const in float i ) {\nfloat j = i * 4.0;\nfloat x = mod( j, float( boneTextureWidth ) );\nfloat y = floor( j / float( boneTextureWidth ) );\nfloat dx = 1.0 / float( boneTextureWidth );\nfloat dy = 1.0 / float( boneTextureHeight );\ny = dy * ( y + 0.5 );\nvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\nvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\nvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\nvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\nmat4 bone = mat4( v1, v2, v3, v4 );\nreturn bone;\n}\n#else\nuniform mat4 boneGlobalMatrices[ MAX_BONES ];\nmat4 getBoneMatrix( const in float i ) {\nmat4 bone = boneGlobalMatrices[ int(i) ];\nreturn bone;\n}\n#endif\n#endif",
skinbase_vertex:"#ifdef USE_SKINNING\nmat4 boneMatX = getBoneMatrix( skinIndex.x );\nmat4 boneMatY = getBoneMatrix( skinIndex.y );\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n#ifdef USE_MORPHTARGETS\nvec4 skinVertex = vec4( morphed, 1.0 );\n#else\nvec4 skinVertex = vec4( position, 1.0 );\n#endif\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned \t  += boneMatY * skinVertex * skinWeight.y;\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n#ifndef USE_MORPHNORMALS\nuniform float morphTargetInfluences[ 8 ];\n#else\nuniform float morphTargetInfluences[ 4 ];\n#endif\n#endif",
morphtarget_vertex:"#ifdef USE_MORPHTARGETS\nvec3 morphed = vec3( 0.0 );\nmorphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\nmorphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\nmorphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\nmorphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n#ifndef USE_MORPHNORMALS\nmorphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\nmorphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\nmorphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\nmorphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n#endif\nmorphed += position;\n#endif",
default_vertex:"vec4 mvPosition;\n#ifdef USE_SKINNING\nmvPosition = modelViewMatrix * skinned;\n#endif\n#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )\nmvPosition = modelViewMatrix * vec4( morphed, 1.0 );\n#endif\n#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )\nmvPosition = modelViewMatrix * vec4( position, 1.0 );\n#endif\ngl_Position = projectionMatrix * mvPosition;",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\nvec3 morphedNormal = vec3( 0.0 );\nmorphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\nmorphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\nmorphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\nmorphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\nmorphedNormal += normal;\n#endif",
skinnormal_vertex:"#ifdef USE_SKINNING\nmat4 skinMatrix = skinWeight.x * boneMatX;\nskinMatrix \t+= skinWeight.y * boneMatY;\n#ifdef USE_MORPHNORMALS\nvec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );\n#else\nvec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );\n#endif\n#endif",defaultnormal_vertex:"vec3 objectNormal;\n#ifdef USE_SKINNING\nobjectNormal = skinnedNormal.xyz;\n#endif\n#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )\nobjectNormal = morphedNormal;\n#endif\n#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )\nobjectNormal = normal;\n#endif\n#ifdef FLIP_SIDED\nobjectNormal = -objectNormal;\n#endif\nvec3 transformedNormal = normalMatrix * objectNormal;",
alphatest_fragment:"#ifdef ALPHATEST\nif ( gl_FragColor.a < ALPHATEST ) discard;\n#endif",linear_to_gamma_fragment:"#ifdef GAMMA_OUTPUT\ngl_FragColor.xyz = sqrt( gl_FragColor.xyz );\n#endif"};
THREE.UniformsUtils={merge:function(a){var b,c,d,e={};for(b=0;b<a.length;b++)for(c in d=this.clone(a[b]),d)e[c]=d[c];return e},clone:function(a){var b,c,d,e={};for(b in a)for(c in e[b]={},a[b])d=a[b][c],e[b][c]=d instanceof THREE.Color||d instanceof THREE.Vector2||d instanceof THREE.Vector3||d instanceof THREE.Vector4||d instanceof THREE.Matrix4||d instanceof THREE.Texture?d.clone():d instanceof Array?d.slice():d;return e}};
THREE.UniformsLib={common:{diffuse:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:0.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},bump:{bumpMap:{type:"t",
value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:2.5E-4},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2E3},fogColor:{type:"c",value:new THREE.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",
value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",
value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:2.5E-4},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2E3},fogColor:{type:"c",value:new THREE.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}};
THREE.ShaderLib={basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog]),vertexShader:[THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.skinbase_vertex,"#ifdef USE_ENVMAP",
THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"#endif",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,
THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},lambert:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,
THREE.UniformsLib.fog,THREE.UniformsLib.lights,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\n#endif",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,
THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,
THREE.ShaderChunk.lights_lambert_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\n#endif",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,
THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED\nif ( gl_FrontFacing )\ngl_FragColor.xyz *= vLightFront;\nelse\ngl_FragColor.xyz *= vLightBack;\n#else\ngl_FragColor.xyz *= vLightFront;\n#endif",THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,
THREE.UniformsLib.bump,THREE.UniformsLib.fog,THREE.UniformsLib.lights,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define PHONG\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_phong_pars_vertex,
THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,
"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_phong_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;\nuniform vec3 ambient;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,
THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.bumpmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,
"}"].join("\n")},particle_basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.particle]),vertexShader:["uniform float size;\nuniform float scale;",THREE.ShaderChunk.color_pars_vertex,"void main() {",THREE.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n#ifdef USE_SIZEATTENUATION\ngl_PointSize = size * ( scale / length( mvPosition.xyz ) );\n#else\ngl_PointSize = size;\n#endif\ngl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk.worldpos_vertex,
"}"].join("\n"),fragmentShader:["uniform vec3 psColor;\nuniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_particle_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( psColor, opacity );",THREE.ShaderChunk.map_particle_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},dashed:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,
{scale:{type:"f",value:1},dashSize:{type:"f",value:1},totalSize:{type:"f",value:2}}]),vertexShader:["uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;",THREE.ShaderChunk.color_pars_vertex,"void main() {",THREE.ShaderChunk.color_vertex,"vLineDistance = scale * lineDistance;\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;",
THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,"void main() {\nif ( mod( vLineDistance, totalSize ) > dashSize ) {\ndiscard;\n}\ngl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2E3},opacity:{type:"f",value:1}},vertexShader:"void main() {\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float mNear;\nuniform float mFar;\nuniform float opacity;\nvoid main() {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat color = 1.0 - smoothstep( mNear, mFar, depth );\ngl_FragColor = vec4( vec3( color ), opacity );\n}"},
normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;",THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {\nvNormal = normalize( normalMatrix * normal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:"uniform float opacity;\nvarying vec3 vNormal;\nvoid main() {\ngl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );\n}"},normalmap:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.fog,THREE.UniformsLib.lights,
{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new THREE.Vector2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",
value:new THREE.Color(16777215)},uSpecularColor:{type:"c",value:new THREE.Color(1118481)},uAmbientColor:{type:"c",value:new THREE.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:0.98},uReflectivity:{type:"f",value:0.5},uOffset:{type:"v2",value:new THREE.Vector2(0,0)},uRepeat:{type:"v2",value:new THREE.Vector2(1,1)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;\nuniform vec3 uDiffuseColor;\nuniform vec3 uSpecularColor;\nuniform float uShininess;\nuniform float uOpacity;\nuniform bool enableDiffuse;\nuniform bool enableSpecular;\nuniform bool enableAO;\nuniform bool enableReflection;\nuniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\nuniform sampler2D tSpecular;\nuniform sampler2D tAO;\nuniform samplerCube tCube;\nuniform vec2 uNormalScale;\nuniform bool useRefract;\nuniform float uRefractionRatio;\nuniform float uReflectivity;\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif\nvarying vec3 vWorldPosition;\nvarying vec3 vViewPosition;",
THREE.ShaderChunk.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3( 1.0 ), uOpacity );\nvec3 specularTex = vec3( 1.0 );\nvec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;\nnormalTex.xy *= uNormalScale;\nnormalTex = normalize( normalTex );\nif( enableDiffuse ) {\n#ifdef GAMMA_INPUT\nvec4 texelColor = texture2D( tDiffuse, vUv );\ntexelColor.xyz *= texelColor.xyz;\ngl_FragColor = gl_FragColor * texelColor;\n#else\ngl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );\n#endif\n}\nif( enableAO ) {\n#ifdef GAMMA_INPUT\nvec4 aoColor = texture2D( tAO, vUv );\naoColor.xyz *= aoColor.xyz;\ngl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;\n#endif\n}\nif( enableSpecular )\nspecularTex = texture2D( tSpecular, vUv ).xyz;\nmat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );\nvec3 finalNormal = tsb * normalTex;\n#ifdef FLIP_SIDED\nfinalNormal = -finalNormal;\n#endif\nvec3 normal = normalize( finalNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 pointVector = lPosition.xyz + vViewPosition.xyz;\nfloat pointDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\npointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );\npointVector = normalize( pointVector );\n#ifdef WRAP_AROUND\nfloat pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );\nfloat pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );\nvec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );\n#else\nfloat pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );\n#endif\npointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;\nvec3 pointHalfVector = normalize( pointVector + viewPosition );\nfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\nfloat pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( uShininess + 2.0001 ) / 8.0;\nvec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );\npointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;\n#else\npointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;\n#endif\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nvec3 spotDiffuse = vec3( 0.0 );\nvec3 spotSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 spotVector = lPosition.xyz + vViewPosition.xyz;\nfloat spotDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nspotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );\nspotVector = normalize( spotVector );\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );\nif ( spotEffect > spotLightAngleCos[ i ] ) {\nspotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );\n#ifdef WRAP_AROUND\nfloat spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );\nfloat spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );\nvec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );\n#else\nfloat spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );\n#endif\nspotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect;\nvec3 spotHalfVector = normalize( spotVector + viewPosition );\nfloat spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );\nfloat spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( uShininess + 2.0001 ) / 8.0;\nvec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );\nspotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;\n#else\nspotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect;\n#endif\n}\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\n#ifdef WRAP_AROUND\nfloat directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );\nfloat directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );\nvec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );\n#else\nfloat dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );\n#endif\ndirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;\nvec3 dirHalfVector = normalize( dirVector + viewPosition );\nfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\nfloat dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( uShininess + 2.0001 ) / 8.0;\nvec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );\ndirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;\n#else\ndirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;\n#endif\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nvec3 hemiDiffuse  = vec3( 0.0 );\nvec3 hemiSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );\nvec3 lVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( normal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nvec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\nhemiDiffuse += uDiffuseColor * hemiColor;\nvec3 hemiHalfVectorSky = normalize( lVector + viewPosition );\nfloat hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;\nfloat hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );\nvec3 lVectorGround = -lVector;\nvec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );\nfloat hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;\nfloat hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat dotProductGround = dot( normal, lVectorGround );\nfloat specularNormalization = ( uShininess + 2.0001 ) / 8.0;\nvec3 schlickSky = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );\nvec3 schlickGround = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );\nhemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );\n#else\nhemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;\n#endif\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_HEMI_LIGHTS > 0\ntotalDiffuse += hemiDiffuse;\ntotalSpecular += hemiSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\n#if MAX_SPOT_LIGHTS > 0\ntotalDiffuse += spotDiffuse;\ntotalSpecular += spotSpecular;\n#endif\n#ifdef METAL\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;\n#endif\nif ( enableReflection ) {\nvec3 vReflect;\nvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\nif ( useRefract ) {\nvReflect = refract( cameraToVertex, normal, uRefractionRatio );\n} else {\nvReflect = reflect( cameraToVertex, normal );\n}\nvec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\n#ifdef GAMMA_INPUT\ncubeColor.xyz *= cubeColor.xyz;\n#endif\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );\n}",
THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;\nuniform vec2 uOffset;\nuniform vec2 uRepeat;\nuniform bool enableDisplacement;\n#ifdef VERTEX_TEXTURES\nuniform sampler2D tDisplacement;\nuniform float uDisplacementScale;\nuniform float uDisplacementBias;\n#endif\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vWorldPosition;\nvarying vec3 vViewPosition;",THREE.ShaderChunk.skinning_pars_vertex,
"void main() {",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING\nvNormal = normalize( normalMatrix * skinnedNormal.xyz );\nvec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );\nvTangent = normalize( normalMatrix * skinnedTangent.xyz );\n#else\nvNormal = normalize( normalMatrix * normal );\nvTangent = normalize( normalMatrix * tangent.xyz );\n#endif\nvBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );\nvUv = uv * uRepeat + uOffset;\nvec3 displacedPosition;\n#ifdef VERTEX_TEXTURES\nif ( enableDisplacement ) {\nvec3 dv = texture2D( tDisplacement, uv ).xyz;\nfloat df = uDisplacementScale * dv.x + uDisplacementBias;\ndisplacedPosition = position + normalize( normal ) * df;\n} else {\n#ifdef USE_SKINNING\nvec4 skinVertex = vec4( position, 1.0 );\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned \t  += boneMatY * skinVertex * skinWeight.y;\ndisplacedPosition  = skinned.xyz;\n#else\ndisplacedPosition = position;\n#endif\n}\n#else\n#ifdef USE_SKINNING\nvec4 skinVertex = vec4( position, 1.0 );\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned \t  += boneMatY * skinVertex * skinWeight.y;\ndisplacedPosition  = skinned.xyz;\n#else\ndisplacedPosition = position;\n#endif\n#endif\nvec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );\nvec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\nvWorldPosition = worldPosition.xyz;\nvViewPosition = -mvPosition.xyz;\n#ifdef USE_SHADOWMAP\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;\n}\n#endif\n}"].join("\n")},
cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:"varying vec3 vWorldPosition;\nvoid main() {\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\nvWorldPosition = worldPosition.xyz;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform samplerCube tCube;\nuniform float tFlip;\nvarying vec3 vWorldPosition;\nvoid main() {\ngl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n}"}};THREE.WebGLRenderer=function(a){function b(a,b){var c=a.vertices.length,d=b.material;if(d.attributes){void 0===a.__webglCustomAttributesList&&(a.__webglCustomAttributesList=[]);for(var e in d.attributes){var f=d.attributes[e];if(!f.__webglInitialized||f.createUniqueBuffers){f.__webglInitialized=!0;var h=1;"v2"===f.type?h=2:"v3"===f.type?h=3:"v4"===f.type?h=4:"c"===f.type&&(h=3);f.size=h;f.array=new Float32Array(c*h);f.buffer=j.createBuffer();f.buffer.belongsToAttribute=e;f.needsUpdate=!0}a.__webglCustomAttributesList.push(f)}}}
function c(a,b){var c=b.geometry,h=a.faces3,g=3*h.length,i=1*h.length,k=3*h.length,h=d(b,a),l=f(h),m=e(h),p=h.vertexColors?h.vertexColors:!1;a.__vertexArray=new Float32Array(3*g);m&&(a.__normalArray=new Float32Array(3*g));c.hasTangents&&(a.__tangentArray=new Float32Array(4*g));p&&(a.__colorArray=new Float32Array(3*g));l&&(0<c.faceVertexUvs.length&&(a.__uvArray=new Float32Array(2*g)),1<c.faceVertexUvs.length&&(a.__uv2Array=new Float32Array(2*g)));b.geometry.skinWeights.length&&b.geometry.skinIndices.length&&
(a.__skinIndexArray=new Float32Array(4*g),a.__skinWeightArray=new Float32Array(4*g));a.__faceArray=new Uint16Array(3*i);a.__lineArray=new Uint16Array(2*k);if(a.numMorphTargets){a.__morphTargetsArrays=[];c=0;for(l=a.numMorphTargets;c<l;c++)a.__morphTargetsArrays.push(new Float32Array(3*g))}if(a.numMorphNormals){a.__morphNormalsArrays=[];c=0;for(l=a.numMorphNormals;c<l;c++)a.__morphNormalsArrays.push(new Float32Array(3*g))}a.__webglFaceCount=3*i;a.__webglLineCount=2*k;if(h.attributes){void 0===a.__webglCustomAttributesList&&
(a.__webglCustomAttributesList=[]);for(var n in h.attributes){var i=h.attributes[n],k={},t;for(t in i)k[t]=i[t];if(!k.__webglInitialized||k.createUniqueBuffers)k.__webglInitialized=!0,c=1,"v2"===k.type?c=2:"v3"===k.type?c=3:"v4"===k.type?c=4:"c"===k.type&&(c=3),k.size=c,k.array=new Float32Array(g*c),k.buffer=j.createBuffer(),k.buffer.belongsToAttribute=n,i.needsUpdate=!0,k.__original=i;a.__webglCustomAttributesList.push(k)}}a.__inittedArrays=!0}function d(a,b){return a.material instanceof THREE.MeshFaceMaterial?
a.material.materials[b.materialIndex]:a.material}function e(a){return a instanceof THREE.MeshBasicMaterial&&!a.envMap||a instanceof THREE.MeshDepthMaterial?!1:a&&void 0!==a.shading&&a.shading===THREE.SmoothShading?THREE.SmoothShading:THREE.FlatShading}function f(a){return a.map||a.lightMap||a.bumpMap||a.normalMap||a.specularMap||a instanceof THREE.ShaderMaterial?!0:!1}function h(a){Pa[a]||(j.enableVertexAttribArray(a),Pa[a]=!0)}function g(){for(var a in Pa)Pa[a]&&(j.disableVertexAttribArray(a),Pa[a]=
!1)}function i(a,b){return a.z!==b.z?b.z-a.z:a.id-b.id}function k(a,b){return b[0]-a[0]}function l(a,b,c){if(a.length)for(var d=0,e=a.length;d<e;d++)ea=U=null,Ca=ca=ba=$=Ia=Ea=V=-1,Qa=!0,a[d].render(b,c,gb,vb),ea=U=null,Ca=ca=ba=$=Ia=Ea=V=-1,Qa=!0}function m(a,b,c,d,e,f,h,g){var j,i,k,l;b?(i=a.length-1,l=b=-1):(i=0,b=a.length,l=1);for(var m=i;m!==b;m+=l)if(j=a[m],j.render){i=j.object;k=j.buffer;if(g)j=g;else{j=j[c];if(!j)continue;h&&I.setBlending(j.blending,j.blendEquation,j.blendSrc,j.blendDst);
I.setDepthTest(j.depthTest);I.setDepthWrite(j.depthWrite);A(j.polygonOffset,j.polygonOffsetFactor,j.polygonOffsetUnits)}I.setMaterialFaces(j);k instanceof THREE.BufferGeometry?I.renderBufferDirect(d,e,f,j,k,i):I.renderBuffer(d,e,f,j,k,i)}}function p(a,b,c,d,e,f,h){for(var g,j,i=0,k=a.length;i<k;i++)if(g=a[i],j=g.object,j.visible){if(h)g=h;else{g=g[b];if(!g)continue;f&&I.setBlending(g.blending,g.blendEquation,g.blendSrc,g.blendDst);I.setDepthTest(g.depthTest);I.setDepthWrite(g.depthWrite);A(g.polygonOffset,
g.polygonOffsetFactor,g.polygonOffsetUnits)}I.renderImmediateObject(c,d,e,g,j)}}function t(a,d){var e,f,h,g;if(void 0===a.__webglInit&&(a.__webglInit=!0,a._modelViewMatrix=new THREE.Matrix4,a._normalMatrix=new THREE.Matrix3,void 0!==a.geometry&&void 0===a.geometry.__webglInit&&(a.geometry.__webglInit=!0,a.geometry.addEventListener("dispose",Fb)),f=a.geometry,void 0!==f))if(f instanceof THREE.BufferGeometry){var i,k;for(i in f.attributes)k="index"===i?j.ELEMENT_ARRAY_BUFFER:j.ARRAY_BUFFER,g=f.attributes[i],
void 0===g.numItems&&(g.numItems=g.array.length),g.buffer=j.createBuffer(),j.bindBuffer(k,g.buffer),j.bufferData(k,g.array,j.STATIC_DRAW)}else if(a instanceof THREE.Mesh){h=a.material;if(void 0===f.geometryGroups){i=f;var l,m,p;k={};var n=i.morphTargets.length,t=i.morphNormals.length,r=h instanceof THREE.MeshFaceMaterial;i.geometryGroups={};h=0;for(l=i.faces.length;h<l;h++)m=i.faces[h],m=r?m.materialIndex:0,void 0===k[m]&&(k[m]={hash:m,counter:0}),p=k[m].hash+"_"+k[m].counter,void 0===i.geometryGroups[p]&&
(i.geometryGroups[p]={faces3:[],materialIndex:m,vertices:0,numMorphTargets:n,numMorphNormals:t}),65535<i.geometryGroups[p].vertices+3&&(k[m].counter+=1,p=k[m].hash+"_"+k[m].counter,void 0===i.geometryGroups[p]&&(i.geometryGroups[p]={faces3:[],materialIndex:m,vertices:0,numMorphTargets:n,numMorphNormals:t})),i.geometryGroups[p].faces3.push(h),i.geometryGroups[p].vertices+=3;i.geometryGroupsList=[];for(g in i.geometryGroups)i.geometryGroups[g].id=X++,i.geometryGroupsList.push(i.geometryGroups[g])}for(e in f.geometryGroups)if(g=
f.geometryGroups[e],!g.__webglVertexBuffer){i=g;i.__webglVertexBuffer=j.createBuffer();i.__webglNormalBuffer=j.createBuffer();i.__webglTangentBuffer=j.createBuffer();i.__webglColorBuffer=j.createBuffer();i.__webglUVBuffer=j.createBuffer();i.__webglUV2Buffer=j.createBuffer();i.__webglSkinIndicesBuffer=j.createBuffer();i.__webglSkinWeightsBuffer=j.createBuffer();i.__webglFaceBuffer=j.createBuffer();i.__webglLineBuffer=j.createBuffer();n=k=void 0;if(i.numMorphTargets){i.__webglMorphTargetsBuffers=[];
k=0;for(n=i.numMorphTargets;k<n;k++)i.__webglMorphTargetsBuffers.push(j.createBuffer())}if(i.numMorphNormals){i.__webglMorphNormalsBuffers=[];k=0;for(n=i.numMorphNormals;k<n;k++)i.__webglMorphNormalsBuffers.push(j.createBuffer())}I.info.memory.geometries++;c(g,a);f.verticesNeedUpdate=!0;f.morphTargetsNeedUpdate=!0;f.elementsNeedUpdate=!0;f.uvsNeedUpdate=!0;f.normalsNeedUpdate=!0;f.tangentsNeedUpdate=!0;f.colorsNeedUpdate=!0}}else a instanceof THREE.Line?f.__webglVertexBuffer||(g=f,g.__webglVertexBuffer=
j.createBuffer(),g.__webglColorBuffer=j.createBuffer(),g.__webglLineDistanceBuffer=j.createBuffer(),I.info.memory.geometries++,g=f,i=g.vertices.length,g.__vertexArray=new Float32Array(3*i),g.__colorArray=new Float32Array(3*i),g.__lineDistanceArray=new Float32Array(1*i),g.__webglLineCount=i,b(g,a),f.verticesNeedUpdate=!0,f.colorsNeedUpdate=!0,f.lineDistancesNeedUpdate=!0):a instanceof THREE.ParticleSystem&&!f.__webglVertexBuffer&&(g=f,g.__webglVertexBuffer=j.createBuffer(),g.__webglColorBuffer=j.createBuffer(),
I.info.memory.geometries++,g=f,i=g.vertices.length,g.__vertexArray=new Float32Array(3*i),g.__colorArray=new Float32Array(3*i),g.__sortArray=[],g.__webglParticleCount=i,b(g,a),f.verticesNeedUpdate=!0,f.colorsNeedUpdate=!0);if(void 0===a.__webglActive){if(a instanceof THREE.Mesh)if(f=a.geometry,f instanceof THREE.BufferGeometry)q(d.__webglObjects,f,a);else{if(f instanceof THREE.Geometry)for(e in f.geometryGroups)g=f.geometryGroups[e],q(d.__webglObjects,g,a)}else a instanceof THREE.Line||a instanceof
THREE.ParticleSystem?(f=a.geometry,q(d.__webglObjects,f,a)):(a instanceof THREE.ImmediateRenderObject||a.immediateRenderCallback)&&d.__webglObjectsImmediate.push({id:null,object:a,opaque:null,transparent:null,z:0});a.__webglActive=!0}}function q(a,b,c){a.push({id:null,buffer:b,object:c,opaque:null,transparent:null,z:0})}function n(a){for(var b in a.attributes)if(a.attributes[b].needsUpdate)return!0;return!1}function r(a){for(var b in a.attributes)a.attributes[b].needsUpdate=!1}function s(a,b){a instanceof
THREE.Mesh||a instanceof THREE.ParticleSystem||a instanceof THREE.Line?u(b.__webglObjects,a):a instanceof THREE.Sprite?x(b.__webglSprites,a):a instanceof THREE.LensFlare?x(b.__webglFlares,a):(a instanceof THREE.ImmediateRenderObject||a.immediateRenderCallback)&&u(b.__webglObjectsImmediate,a);delete a.__webglActive}function u(a,b){for(var c=a.length-1;0<=c;c--)a[c].object===b&&a.splice(c,1)}function x(a,b){for(var c=a.length-1;0<=c;c--)a[c]===b&&a.splice(c,1)}function v(a,b,c,d,e){N=0;d.needsUpdate&&
(d.program&&Kb(d),I.initMaterial(d,b,c,e),d.needsUpdate=!1);d.morphTargets&&!e.__webglMorphTargetInfluences&&(e.__webglMorphTargetInfluences=new Float32Array(I.maxMorphTargets));var f=!1,g=d.program,h=g.uniforms,i=d.uniforms;g!==U&&(j.useProgram(g),U=g,f=!0);d.id!==Ca&&(Ca=d.id,f=!0);if(f||a!==ea)j.uniformMatrix4fv(h.projectionMatrix,!1,a.projectionMatrix.elements),a!==ea&&(ea=a);if(d.skinning)if(Db&&e.useVertexTexture){if(null!==h.boneTexture){var k=D();j.uniform1i(h.boneTexture,k);I.setTexture(e.boneTexture,
k)}null!==h.boneTextureWidth&&j.uniform1i(h.boneTextureWidth,e.boneTextureWidth);null!==h.boneTextureHeight&&j.uniform1i(h.boneTextureHeight,e.boneTextureHeight)}else null!==h.boneGlobalMatrices&&j.uniformMatrix4fv(h.boneGlobalMatrices,!1,e.boneMatrices);if(f){c&&d.fog&&(i.fogColor.value=c.color,c instanceof THREE.Fog?(i.fogNear.value=c.near,i.fogFar.value=c.far):c instanceof THREE.FogExp2&&(i.fogDensity.value=c.density));if(d instanceof THREE.MeshPhongMaterial||d instanceof THREE.MeshLambertMaterial||
d.lights){if(Qa){for(var m,l=k=0,p=0,n,t,r,q=Da,s=q.directional.colors,u=q.directional.positions,w=q.point.colors,x=q.point.positions,y=q.point.distances,A=q.spot.colors,v=q.spot.positions,H=q.spot.distances,L=q.spot.directions,M=q.spot.anglesCos,J=q.spot.exponents,P=q.hemi.skyColors,V=q.hemi.groundColors,T=q.hemi.positions,$=0,ba=0,R=0,W=0,Ba=0,ec=0,Z=0,Y=0,ca=m=0,c=r=ca=0,f=b.length;c<f;c++)m=b[c],m.onlyShadow||(n=m.color,t=m.intensity,r=m.distance,m instanceof THREE.AmbientLight?m.visible&&(I.gammaInput?
(k+=n.r*n.r,l+=n.g*n.g,p+=n.b*n.b):(k+=n.r,l+=n.g,p+=n.b)):m instanceof THREE.DirectionalLight?(Ba+=1,m.visible&&(ga.getPositionFromMatrix(m.matrixWorld),ka.getPositionFromMatrix(m.target.matrixWorld),ga.sub(ka),ga.normalize(),0===ga.x&&0===ga.y&&0===ga.z||(m=3*$,u[m]=ga.x,u[m+1]=ga.y,u[m+2]=ga.z,I.gammaInput?z(s,m,n,t*t):C(s,m,n,t),$+=1))):m instanceof THREE.PointLight?(ec+=1,m.visible&&(ca=3*ba,I.gammaInput?z(w,ca,n,t*t):C(w,ca,n,t),ka.getPositionFromMatrix(m.matrixWorld),x[ca]=ka.x,x[ca+1]=ka.y,
x[ca+2]=ka.z,y[ba]=r,ba+=1)):m instanceof THREE.SpotLight?(Z+=1,m.visible&&(ca=3*R,I.gammaInput?z(A,ca,n,t*t):C(A,ca,n,t),ka.getPositionFromMatrix(m.matrixWorld),v[ca]=ka.x,v[ca+1]=ka.y,v[ca+2]=ka.z,H[R]=r,ga.copy(ka),ka.getPositionFromMatrix(m.target.matrixWorld),ga.sub(ka),ga.normalize(),L[ca]=ga.x,L[ca+1]=ga.y,L[ca+2]=ga.z,M[R]=Math.cos(m.angle),J[R]=m.exponent,R+=1)):m instanceof THREE.HemisphereLight&&(Y+=1,m.visible&&(ga.getPositionFromMatrix(m.matrixWorld),ga.normalize(),0===ga.x&&0===ga.y&&
0===ga.z||(r=3*W,T[r]=ga.x,T[r+1]=ga.y,T[r+2]=ga.z,n=m.color,m=m.groundColor,I.gammaInput?(t*=t,z(P,r,n,t),z(V,r,m,t)):(C(P,r,n,t),C(V,r,m,t)),W+=1))));c=3*$;for(f=Math.max(s.length,3*Ba);c<f;c++)s[c]=0;c=3*ba;for(f=Math.max(w.length,3*ec);c<f;c++)w[c]=0;c=3*R;for(f=Math.max(A.length,3*Z);c<f;c++)A[c]=0;c=3*W;for(f=Math.max(P.length,3*Y);c<f;c++)P[c]=0;c=3*W;for(f=Math.max(V.length,3*Y);c<f;c++)V[c]=0;q.directional.length=$;q.point.length=ba;q.spot.length=R;q.hemi.length=W;q.ambient[0]=k;q.ambient[1]=
l;q.ambient[2]=p;Qa=!1}c=Da;i.ambientLightColor.value=c.ambient;i.directionalLightColor.value=c.directional.colors;i.directionalLightDirection.value=c.directional.positions;i.pointLightColor.value=c.point.colors;i.pointLightPosition.value=c.point.positions;i.pointLightDistance.value=c.point.distances;i.spotLightColor.value=c.spot.colors;i.spotLightPosition.value=c.spot.positions;i.spotLightDistance.value=c.spot.distances;i.spotLightDirection.value=c.spot.directions;i.spotLightAngleCos.value=c.spot.anglesCos;
i.spotLightExponent.value=c.spot.exponents;i.hemisphereLightSkyColor.value=c.hemi.skyColors;i.hemisphereLightGroundColor.value=c.hemi.groundColors;i.hemisphereLightDirection.value=c.hemi.positions}if(d instanceof THREE.MeshBasicMaterial||d instanceof THREE.MeshLambertMaterial||d instanceof THREE.MeshPhongMaterial){i.opacity.value=d.opacity;I.gammaInput?i.diffuse.value.copyGammaToLinear(d.color):i.diffuse.value=d.color;i.map.value=d.map;i.lightMap.value=d.lightMap;i.specularMap.value=d.specularMap;
d.bumpMap&&(i.bumpMap.value=d.bumpMap,i.bumpScale.value=d.bumpScale);d.normalMap&&(i.normalMap.value=d.normalMap,i.normalScale.value.copy(d.normalScale));var X;d.map?X=d.map:d.specularMap?X=d.specularMap:d.normalMap?X=d.normalMap:d.bumpMap&&(X=d.bumpMap);void 0!==X&&(c=X.offset,X=X.repeat,i.offsetRepeat.value.set(c.x,c.y,X.x,X.y));i.envMap.value=d.envMap;i.flipEnvMap.value=d.envMap instanceof THREE.WebGLRenderTargetCube?1:-1;i.reflectivity.value=d.reflectivity;i.refractionRatio.value=d.refractionRatio;
i.combine.value=d.combine;i.useRefract.value=d.envMap&&d.envMap.mapping instanceof THREE.CubeRefractionMapping}d instanceof THREE.LineBasicMaterial?(i.diffuse.value=d.color,i.opacity.value=d.opacity):d instanceof THREE.LineDashedMaterial?(i.diffuse.value=d.color,i.opacity.value=d.opacity,i.dashSize.value=d.dashSize,i.totalSize.value=d.dashSize+d.gapSize,i.scale.value=d.scale):d instanceof THREE.ParticleBasicMaterial?(i.psColor.value=d.color,i.opacity.value=d.opacity,i.size.value=d.size,i.scale.value=
B.height/2,i.map.value=d.map):d instanceof THREE.MeshPhongMaterial?(i.shininess.value=d.shininess,I.gammaInput?(i.ambient.value.copyGammaToLinear(d.ambient),i.emissive.value.copyGammaToLinear(d.emissive),i.specular.value.copyGammaToLinear(d.specular)):(i.ambient.value=d.ambient,i.emissive.value=d.emissive,i.specular.value=d.specular),d.wrapAround&&i.wrapRGB.value.copy(d.wrapRGB)):d instanceof THREE.MeshLambertMaterial?(I.gammaInput?(i.ambient.value.copyGammaToLinear(d.ambient),i.emissive.value.copyGammaToLinear(d.emissive)):
(i.ambient.value=d.ambient,i.emissive.value=d.emissive),d.wrapAround&&i.wrapRGB.value.copy(d.wrapRGB)):d instanceof THREE.MeshDepthMaterial?(i.mNear.value=a.near,i.mFar.value=a.far,i.opacity.value=d.opacity):d instanceof THREE.MeshNormalMaterial&&(i.opacity.value=d.opacity);if(e.receiveShadow&&!d._shadowPass&&i.shadowMatrix){c=X=0;for(f=b.length;c<f;c++)if(k=b[c],k.castShadow&&(k instanceof THREE.SpotLight||k instanceof THREE.DirectionalLight&&!k.shadowCascade))i.shadowMap.value[X]=k.shadowMap,i.shadowMapSize.value[X]=
k.shadowMapSize,i.shadowMatrix.value[X]=k.shadowMatrix,i.shadowDarkness.value[X]=k.shadowDarkness,i.shadowBias.value[X]=k.shadowBias,X++}b=d.uniformsList;i=0;for(X=b.length;i<X;i++)if(f=g.uniforms[b[i][1]])if(c=b[i][0],l=c.type,k=c.value,"i"===l)j.uniform1i(f,k);else if("f"===l)j.uniform1f(f,k);else if("v2"===l)j.uniform2f(f,k.x,k.y);else if("v3"===l)j.uniform3f(f,k.x,k.y,k.z);else if("v4"===l)j.uniform4f(f,k.x,k.y,k.z,k.w);else if("c"===l)j.uniform3f(f,k.r,k.g,k.b);else if("iv1"===l)j.uniform1iv(f,
k);else if("iv"===l)j.uniform3iv(f,k);else if("fv1"===l)j.uniform1fv(f,k);else if("fv"===l)j.uniform3fv(f,k);else if("v2v"===l){void 0===c._array&&(c._array=new Float32Array(2*k.length));l=0;for(p=k.length;l<p;l++)q=2*l,c._array[q]=k[l].x,c._array[q+1]=k[l].y;j.uniform2fv(f,c._array)}else if("v3v"===l){void 0===c._array&&(c._array=new Float32Array(3*k.length));l=0;for(p=k.length;l<p;l++)q=3*l,c._array[q]=k[l].x,c._array[q+1]=k[l].y,c._array[q+2]=k[l].z;j.uniform3fv(f,c._array)}else if("v4v"===l){void 0===
c._array&&(c._array=new Float32Array(4*k.length));l=0;for(p=k.length;l<p;l++)q=4*l,c._array[q]=k[l].x,c._array[q+1]=k[l].y,c._array[q+2]=k[l].z,c._array[q+3]=k[l].w;j.uniform4fv(f,c._array)}else if("m4"===l)void 0===c._array&&(c._array=new Float32Array(16)),k.flattenToArray(c._array),j.uniformMatrix4fv(f,!1,c._array);else if("m4v"===l){void 0===c._array&&(c._array=new Float32Array(16*k.length));l=0;for(p=k.length;l<p;l++)k[l].flattenToArrayOffset(c._array,16*l);j.uniformMatrix4fv(f,!1,c._array)}else if("t"===
l){if(q=k,k=D(),j.uniform1i(f,k),q)if(q.image instanceof Array&&6===q.image.length){if(c=q,f=k,6===c.image.length)if(c.needsUpdate){c.image.__webglTextureCube||(c.addEventListener("dispose",Gb),c.image.__webglTextureCube=j.createTexture(),I.info.memory.textures++);j.activeTexture(j.TEXTURE0+f);j.bindTexture(j.TEXTURE_CUBE_MAP,c.image.__webglTextureCube);j.pixelStorei(j.UNPACK_FLIP_Y_WEBGL,c.flipY);f=c instanceof THREE.CompressedTexture;k=[];for(l=0;6>l;l++)p=k,q=l,I.autoScaleCubemaps&&!f?(s=c.image[l],
w=ac,s.width<=w&&s.height<=w||(x=Math.max(s.width,s.height),u=Math.floor(s.width*w/x),w=Math.floor(s.height*w/x),x=document.createElement("canvas"),x.width=u,x.height=w,x.getContext("2d").drawImage(s,0,0,s.width,s.height,0,0,u,w),s=x)):s=c.image[l],p[q]=s;l=k[0];p=0===(l.width&l.width-1)&&0===(l.height&l.height-1);q=F(c.format);s=F(c.type);E(j.TEXTURE_CUBE_MAP,c,p);for(l=0;6>l;l++)if(f){w=k[l].mipmaps;x=0;for(y=w.length;x<y;x++)u=w[x],c.format!==THREE.RGBAFormat?j.compressedTexImage2D(j.TEXTURE_CUBE_MAP_POSITIVE_X+
l,x,q,u.width,u.height,0,u.data):j.texImage2D(j.TEXTURE_CUBE_MAP_POSITIVE_X+l,x,q,u.width,u.height,0,q,s,u.data)}else j.texImage2D(j.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,q,q,s,k[l]);c.generateMipmaps&&p&&j.generateMipmap(j.TEXTURE_CUBE_MAP);c.needsUpdate=!1;if(c.onUpdate)c.onUpdate()}else j.activeTexture(j.TEXTURE0+f),j.bindTexture(j.TEXTURE_CUBE_MAP,c.image.__webglTextureCube)}else q instanceof THREE.WebGLRenderTargetCube?(c=q,j.activeTexture(j.TEXTURE0+k),j.bindTexture(j.TEXTURE_CUBE_MAP,c.__webglTexture)):
I.setTexture(q,k)}else if("tv"===l){void 0===c._array&&(c._array=[]);l=0;for(p=c.value.length;l<p;l++)c._array[l]=D();j.uniform1iv(f,c._array);l=0;for(p=c.value.length;l<p;l++)q=c.value[l],k=c._array[l],q&&I.setTexture(q,k)}else console.warn("THREE.WebGLRenderer: Unknown uniform type: "+l);if((d instanceof THREE.ShaderMaterial||d instanceof THREE.MeshPhongMaterial||d.envMap)&&null!==h.cameraPosition)ka.getPositionFromMatrix(a.matrixWorld),j.uniform3f(h.cameraPosition,ka.x,ka.y,ka.z);(d instanceof
THREE.MeshPhongMaterial||d instanceof THREE.MeshLambertMaterial||d instanceof THREE.ShaderMaterial||d.skinning)&&null!==h.viewMatrix&&j.uniformMatrix4fv(h.viewMatrix,!1,a.matrixWorldInverse.elements)}j.uniformMatrix4fv(h.modelViewMatrix,!1,e._modelViewMatrix.elements);h.normalMatrix&&j.uniformMatrix3fv(h.normalMatrix,!1,e._normalMatrix.elements);null!==h.modelMatrix&&j.uniformMatrix4fv(h.modelMatrix,!1,e.matrixWorld.elements);return g}function D(){var a=N;a>=Pb&&console.warn("WebGLRenderer: trying to use "+
a+" texture units while this GPU supports only "+Pb);N+=1;return a}function z(a,b,c,d){a[b]=c.r*c.r*d;a[b+1]=c.g*c.g*d;a[b+2]=c.b*c.b*d}function C(a,b,c,d){a[b]=c.r*d;a[b+1]=c.g*d;a[b+2]=c.b*d}function A(a,b,c){va!==a&&(a?j.enable(j.POLYGON_OFFSET_FILL):j.disable(j.POLYGON_OFFSET_FILL),va=a);if(a&&(Ha!==b||cb!==c))j.polygonOffset(b,c),Ha=b,cb=c}function y(a){for(var a=a.split("\n"),b=0,c=a.length;b<c;b++)a[b]=b+1+": "+a[b];return a.join("\n")}function M(a,b){var c;"fragment"===a?c=j.createShader(j.FRAGMENT_SHADER):
"vertex"===a&&(c=j.createShader(j.VERTEX_SHADER));j.shaderSource(c,b);j.compileShader(c);return!j.getShaderParameter(c,j.COMPILE_STATUS)?(console.error(j.getShaderInfoLog(c)),console.error(y(b)),null):c}function E(a,b,c){c?(j.texParameteri(a,j.TEXTURE_WRAP_S,F(b.wrapS)),j.texParameteri(a,j.TEXTURE_WRAP_T,F(b.wrapT)),j.texParameteri(a,j.TEXTURE_MAG_FILTER,F(b.magFilter)),j.texParameteri(a,j.TEXTURE_MIN_FILTER,F(b.minFilter))):(j.texParameteri(a,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE),j.texParameteri(a,j.TEXTURE_WRAP_T,
j.CLAMP_TO_EDGE),j.texParameteri(a,j.TEXTURE_MAG_FILTER,P(b.magFilter)),j.texParameteri(a,j.TEXTURE_MIN_FILTER,P(b.minFilter)));if(qa&&b.type!==THREE.FloatType&&(1<b.anisotropy||b.__oldAnisotropy))j.texParameterf(a,qa.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(b.anisotropy,Qb)),b.__oldAnisotropy=b.anisotropy}function J(a,b){j.bindRenderbuffer(j.RENDERBUFFER,a);b.depthBuffer&&!b.stencilBuffer?(j.renderbufferStorage(j.RENDERBUFFER,j.DEPTH_COMPONENT16,b.width,b.height),j.framebufferRenderbuffer(j.FRAMEBUFFER,
j.DEPTH_ATTACHMENT,j.RENDERBUFFER,a)):b.depthBuffer&&b.stencilBuffer?(j.renderbufferStorage(j.RENDERBUFFER,j.DEPTH_STENCIL,b.width,b.height),j.framebufferRenderbuffer(j.FRAMEBUFFER,j.DEPTH_STENCIL_ATTACHMENT,j.RENDERBUFFER,a)):j.renderbufferStorage(j.RENDERBUFFER,j.RGBA4,b.width,b.height)}function P(a){return a===THREE.NearestFilter||a===THREE.NearestMipMapNearestFilter||a===THREE.NearestMipMapLinearFilter?j.NEAREST:j.LINEAR}function F(a){if(a===THREE.RepeatWrapping)return j.REPEAT;if(a===THREE.ClampToEdgeWrapping)return j.CLAMP_TO_EDGE;
if(a===THREE.MirroredRepeatWrapping)return j.MIRRORED_REPEAT;if(a===THREE.NearestFilter)return j.NEAREST;if(a===THREE.NearestMipMapNearestFilter)return j.NEAREST_MIPMAP_NEAREST;if(a===THREE.NearestMipMapLinearFilter)return j.NEAREST_MIPMAP_LINEAR;if(a===THREE.LinearFilter)return j.LINEAR;if(a===THREE.LinearMipMapNearestFilter)return j.LINEAR_MIPMAP_NEAREST;if(a===THREE.LinearMipMapLinearFilter)return j.LINEAR_MIPMAP_LINEAR;if(a===THREE.UnsignedByteType)return j.UNSIGNED_BYTE;if(a===THREE.UnsignedShort4444Type)return j.UNSIGNED_SHORT_4_4_4_4;
if(a===THREE.UnsignedShort5551Type)return j.UNSIGNED_SHORT_5_5_5_1;if(a===THREE.UnsignedShort565Type)return j.UNSIGNED_SHORT_5_6_5;if(a===THREE.ByteType)return j.BYTE;if(a===THREE.ShortType)return j.SHORT;if(a===THREE.UnsignedShortType)return j.UNSIGNED_SHORT;if(a===THREE.IntType)return j.INT;if(a===THREE.UnsignedIntType)return j.UNSIGNED_INT;if(a===THREE.FloatType)return j.FLOAT;if(a===THREE.AlphaFormat)return j.ALPHA;if(a===THREE.RGBFormat)return j.RGB;if(a===THREE.RGBAFormat)return j.RGBA;if(a===
THREE.LuminanceFormat)return j.LUMINANCE;if(a===THREE.LuminanceAlphaFormat)return j.LUMINANCE_ALPHA;if(a===THREE.AddEquation)return j.FUNC_ADD;if(a===THREE.SubtractEquation)return j.FUNC_SUBTRACT;if(a===THREE.ReverseSubtractEquation)return j.FUNC_REVERSE_SUBTRACT;if(a===THREE.ZeroFactor)return j.ZERO;if(a===THREE.OneFactor)return j.ONE;if(a===THREE.SrcColorFactor)return j.SRC_COLOR;if(a===THREE.OneMinusSrcColorFactor)return j.ONE_MINUS_SRC_COLOR;if(a===THREE.SrcAlphaFactor)return j.SRC_ALPHA;if(a===
THREE.OneMinusSrcAlphaFactor)return j.ONE_MINUS_SRC_ALPHA;if(a===THREE.DstAlphaFactor)return j.DST_ALPHA;if(a===THREE.OneMinusDstAlphaFactor)return j.ONE_MINUS_DST_ALPHA;if(a===THREE.DstColorFactor)return j.DST_COLOR;if(a===THREE.OneMinusDstColorFactor)return j.ONE_MINUS_DST_COLOR;if(a===THREE.SrcAlphaSaturateFactor)return j.SRC_ALPHA_SATURATE;if(void 0!==Fa){if(a===THREE.RGB_S3TC_DXT1_Format)return Fa.COMPRESSED_RGB_S3TC_DXT1_EXT;if(a===THREE.RGBA_S3TC_DXT1_Format)return Fa.COMPRESSED_RGBA_S3TC_DXT1_EXT;
if(a===THREE.RGBA_S3TC_DXT3_Format)return Fa.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(a===THREE.RGBA_S3TC_DXT5_Format)return Fa.COMPRESSED_RGBA_S3TC_DXT5_EXT}return 0}console.log("THREE.WebGLRenderer",THREE.REVISION);var a=a||{},B=void 0!==a.canvas?a.canvas:document.createElement("canvas"),w=void 0!==a.precision?a.precision:"highp",R=void 0!==a.alpha?a.alpha:!0,L=void 0!==a.premultipliedAlpha?a.premultipliedAlpha:!0,fa=void 0!==a.antialias?a.antialias:!1,ia=void 0!==a.stencil?a.stencil:!0,oa=void 0!==a.preserveDrawingBuffer?
a.preserveDrawingBuffer:!1,H=new THREE.Color(0),T=0;this.domElement=B;this.context=null;this.devicePixelRatio=void 0!==a.devicePixelRatio?a.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1;this.autoUpdateObjects=this.sortObjects=this.autoClearStencil=this.autoClearDepth=this.autoClearColor=this.autoClear=!0;this.shadowMapEnabled=this.physicallyBasedShading=this.gammaOutput=this.gammaInput=!1;this.shadowMapAutoUpdate=!0;this.shadowMapType=THREE.PCFShadowMap;this.shadowMapCullFace=
THREE.CullFaceFront;this.shadowMapCascade=this.shadowMapDebug=!1;this.maxMorphTargets=8;this.maxMorphNormals=4;this.autoScaleCubemaps=!0;this.renderPluginsPre=[];this.renderPluginsPost=[];this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var I=this,W=[],ua=0,U=null,Ba=null,Ca=-1,ca=null,ea=null,X=0,N=0,$=-1,ba=-1,V=-1,pa=-1,sa=-1,ja=-1,Ea=-1,Ia=-1,va=null,Ha=null,cb=null,Ja=null,xa=0,pb=0,qb=0,fb=0,gb=0,vb=0,Pa={},ya=new THREE.Frustum,wa=new THREE.Matrix4,
ta=new THREE.Matrix4,ka=new THREE.Vector3,ga=new THREE.Vector3,Qa=!0,Da={ambient:[0,0,0],directional:{length:0,colors:[],positions:[]},point:{length:0,colors:[],positions:[],distances:[]},spot:{length:0,colors:[],positions:[],distances:[],directions:[],anglesCos:[],exponents:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]}},j,Na,Ua,qa,Fa;try{var bb={alpha:R,premultipliedAlpha:L,antialias:fa,stencil:ia,preserveDrawingBuffer:oa};j=B.getContext("webgl",bb)||B.getContext("experimental-webgl",
bb);if(null===j)throw"Error creating WebGL context.";}catch(Ra){console.error(Ra)}Na=j.getExtension("OES_texture_float");j.getExtension("OES_texture_float_linear");Ua=j.getExtension("OES_standard_derivatives");qa=j.getExtension("EXT_texture_filter_anisotropic")||j.getExtension("MOZ_EXT_texture_filter_anisotropic")||j.getExtension("WEBKIT_EXT_texture_filter_anisotropic");Fa=j.getExtension("WEBGL_compressed_texture_s3tc")||j.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||j.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");
Na||console.log("THREE.WebGLRenderer: Float textures not supported.");Ua||console.log("THREE.WebGLRenderer: Standard derivatives not supported.");qa||console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported.");Fa||console.log("THREE.WebGLRenderer: S3TC compressed textures not supported.");void 0===j.getShaderPrecisionFormat&&(j.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}});j.clearColor(0,0,0,1);j.clearDepth(1);j.enable(j.DEPTH_TEST);j.depthFunc(j.LEQUAL);
j.frontFace(j.CCW);j.cullFace(j.BACK);j.enable(j.CULL_FACE);j.enable(j.BLEND);j.blendEquation(j.FUNC_ADD);j.blendFunc(j.SRC_ALPHA,j.ONE_MINUS_SRC_ALPHA);j.clearColor(H.r,H.g,H.b,T);this.context=j;var Pb=j.getParameter(j.MAX_TEXTURE_IMAGE_UNITS),$b=j.getParameter(j.MAX_VERTEX_TEXTURE_IMAGE_UNITS);j.getParameter(j.MAX_TEXTURE_SIZE);var ac=j.getParameter(j.MAX_CUBE_MAP_TEXTURE_SIZE),Qb=qa?j.getParameter(qa.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,Ab=0<$b,Db=Ab&&Na;Fa&&j.getParameter(j.COMPRESSED_TEXTURE_FORMATS);
var bc=j.getShaderPrecisionFormat(j.VERTEX_SHADER,j.HIGH_FLOAT),cc=j.getShaderPrecisionFormat(j.VERTEX_SHADER,j.MEDIUM_FLOAT);j.getShaderPrecisionFormat(j.VERTEX_SHADER,j.LOW_FLOAT);var dc=j.getShaderPrecisionFormat(j.FRAGMENT_SHADER,j.HIGH_FLOAT),qc=j.getShaderPrecisionFormat(j.FRAGMENT_SHADER,j.MEDIUM_FLOAT);j.getShaderPrecisionFormat(j.FRAGMENT_SHADER,j.LOW_FLOAT);j.getShaderPrecisionFormat(j.VERTEX_SHADER,j.HIGH_INT);j.getShaderPrecisionFormat(j.VERTEX_SHADER,j.MEDIUM_INT);j.getShaderPrecisionFormat(j.VERTEX_SHADER,
j.LOW_INT);j.getShaderPrecisionFormat(j.FRAGMENT_SHADER,j.HIGH_INT);j.getShaderPrecisionFormat(j.FRAGMENT_SHADER,j.MEDIUM_INT);j.getShaderPrecisionFormat(j.FRAGMENT_SHADER,j.LOW_INT);var rc=0<bc.precision&&0<dc.precision,Eb=0<cc.precision&&0<qc.precision;"highp"===w&&!rc&&(Eb?(w="mediump",console.warn("WebGLRenderer: highp not supported, using mediump")):(w="lowp",console.warn("WebGLRenderer: highp and mediump not supported, using lowp")));"mediump"===w&&!Eb&&(w="lowp",console.warn("WebGLRenderer: mediump not supported, using lowp"));
this.getContext=function(){return j};this.supportsVertexTextures=function(){return Ab};this.supportsFloatTextures=function(){return Na};this.supportsStandardDerivatives=function(){return Ua};this.supportsCompressedTextureS3TC=function(){return Fa};this.getMaxAnisotropy=function(){return Qb};this.getPrecision=function(){return w};this.setSize=function(a,b,c){B.width=a*this.devicePixelRatio;B.height=b*this.devicePixelRatio;1!==this.devicePixelRatio&&!1!==c&&(B.style.width=a+"px",B.style.height=b+"px");
this.setViewport(0,0,B.width,B.height)};this.setViewport=function(a,b,c,d){xa=void 0!==a?a:0;pb=void 0!==b?b:0;qb=void 0!==c?c:B.width;fb=void 0!==d?d:B.height;j.viewport(xa,pb,qb,fb)};this.setScissor=function(a,b,c,d){j.scissor(a,b,c,d)};this.enableScissorTest=function(a){a?j.enable(j.SCISSOR_TEST):j.disable(j.SCISSOR_TEST)};this.setClearColor=function(a,b){H.set(a);T=void 0!==b?b:1;j.clearColor(H.r,H.g,H.b,T)};this.setClearColorHex=function(a,b){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead.");
this.setClearColor(a,b)};this.getClearColor=function(){return H};this.getClearAlpha=function(){return T};this.clear=function(a,b,c){var d=0;if(void 0===a||a)d|=j.COLOR_BUFFER_BIT;if(void 0===b||b)d|=j.DEPTH_BUFFER_BIT;if(void 0===c||c)d|=j.STENCIL_BUFFER_BIT;j.clear(d)};this.clearTarget=function(a,b,c,d){this.setRenderTarget(a);this.clear(b,c,d)};this.addPostPlugin=function(a){a.init(this);this.renderPluginsPost.push(a)};this.addPrePlugin=function(a){a.init(this);this.renderPluginsPre.push(a)};this.updateShadowMap=
function(a,b){U=null;Ca=ca=Ia=Ea=V=-1;Qa=!0;ba=$=-1;this.shadowMapPlugin.update(a,b)};var Fb=function(a){a=a.target;a.removeEventListener("dispose",Fb);a.__webglInit=void 0;if(a instanceof THREE.BufferGeometry){var b=a.attributes,c;for(c in b)void 0!==b[c].buffer&&j.deleteBuffer(b[c].buffer);I.info.memory.geometries--}else if(void 0!==a.geometryGroups)for(b in a.geometryGroups){c=a.geometryGroups[b];if(void 0!==c.numMorphTargets)for(var d=0,e=c.numMorphTargets;d<e;d++)j.deleteBuffer(c.__webglMorphTargetsBuffers[d]);
if(void 0!==c.numMorphNormals){d=0;for(e=c.numMorphNormals;d<e;d++)j.deleteBuffer(c.__webglMorphNormalsBuffers[d])}Jb(c)}else Jb(a)},Gb=function(a){a=a.target;a.removeEventListener("dispose",Gb);a.image&&a.image.__webglTextureCube?j.deleteTexture(a.image.__webglTextureCube):a.__webglInit&&(a.__webglInit=!1,j.deleteTexture(a.__webglTexture));I.info.memory.textures--},Hb=function(a){a=a.target;a.removeEventListener("dispose",Hb);if(a&&a.__webglTexture)if(j.deleteTexture(a.__webglTexture),a instanceof
THREE.WebGLRenderTargetCube)for(var b=0;6>b;b++)j.deleteFramebuffer(a.__webglFramebuffer[b]),j.deleteRenderbuffer(a.__webglRenderbuffer[b]);else j.deleteFramebuffer(a.__webglFramebuffer),j.deleteRenderbuffer(a.__webglRenderbuffer);I.info.memory.textures--},Ib=function(a){a=a.target;a.removeEventListener("dispose",Ib);Kb(a)},Jb=function(a){void 0!==a.__webglVertexBuffer&&j.deleteBuffer(a.__webglVertexBuffer);void 0!==a.__webglNormalBuffer&&j.deleteBuffer(a.__webglNormalBuffer);void 0!==a.__webglTangentBuffer&&
j.deleteBuffer(a.__webglTangentBuffer);void 0!==a.__webglColorBuffer&&j.deleteBuffer(a.__webglColorBuffer);void 0!==a.__webglUVBuffer&&j.deleteBuffer(a.__webglUVBuffer);void 0!==a.__webglUV2Buffer&&j.deleteBuffer(a.__webglUV2Buffer);void 0!==a.__webglSkinIndicesBuffer&&j.deleteBuffer(a.__webglSkinIndicesBuffer);void 0!==a.__webglSkinWeightsBuffer&&j.deleteBuffer(a.__webglSkinWeightsBuffer);void 0!==a.__webglFaceBuffer&&j.deleteBuffer(a.__webglFaceBuffer);void 0!==a.__webglLineBuffer&&j.deleteBuffer(a.__webglLineBuffer);
void 0!==a.__webglLineDistanceBuffer&&j.deleteBuffer(a.__webglLineDistanceBuffer);if(void 0!==a.__webglCustomAttributesList)for(var b in a.__webglCustomAttributesList)j.deleteBuffer(a.__webglCustomAttributesList[b].buffer);I.info.memory.geometries--},Kb=function(a){var b=a.program;if(void 0!==b){a.program=void 0;var c,d,e=!1,a=0;for(c=W.length;a<c;a++)if(d=W[a],d.program===b){d.usedTimes--;0===d.usedTimes&&(e=!0);break}if(!0===e){e=[];a=0;for(c=W.length;a<c;a++)d=W[a],d.program!==b&&e.push(d);W=e;
j.deleteProgram(b);I.info.memory.programs--}}};this.renderBufferImmediate=function(a,b,c){a.hasPositions&&!a.__webglVertexBuffer&&(a.__webglVertexBuffer=j.createBuffer());a.hasNormals&&!a.__webglNormalBuffer&&(a.__webglNormalBuffer=j.createBuffer());a.hasUvs&&!a.__webglUvBuffer&&(a.__webglUvBuffer=j.createBuffer());a.hasColors&&!a.__webglColorBuffer&&(a.__webglColorBuffer=j.createBuffer());a.hasPositions&&(j.bindBuffer(j.ARRAY_BUFFER,a.__webglVertexBuffer),j.bufferData(j.ARRAY_BUFFER,a.positionArray,
j.DYNAMIC_DRAW),j.enableVertexAttribArray(b.attributes.position),j.vertexAttribPointer(b.attributes.position,3,j.FLOAT,!1,0,0));if(a.hasNormals){j.bindBuffer(j.ARRAY_BUFFER,a.__webglNormalBuffer);if(c.shading===THREE.FlatShading){var d,e,f,g,h,i,k,l,m,p,n,q=3*a.count;for(n=0;n<q;n+=9)p=a.normalArray,d=p[n],e=p[n+1],f=p[n+2],g=p[n+3],i=p[n+4],l=p[n+5],h=p[n+6],k=p[n+7],m=p[n+8],d=(d+g+h)/3,e=(e+i+k)/3,f=(f+l+m)/3,p[n]=d,p[n+1]=e,p[n+2]=f,p[n+3]=d,p[n+4]=e,p[n+5]=f,p[n+6]=d,p[n+7]=e,p[n+8]=f}j.bufferData(j.ARRAY_BUFFER,
a.normalArray,j.DYNAMIC_DRAW);j.enableVertexAttribArray(b.attributes.normal);j.vertexAttribPointer(b.attributes.normal,3,j.FLOAT,!1,0,0)}a.hasUvs&&c.map&&(j.bindBuffer(j.ARRAY_BUFFER,a.__webglUvBuffer),j.bufferData(j.ARRAY_BUFFER,a.uvArray,j.DYNAMIC_DRAW),j.enableVertexAttribArray(b.attributes.uv),j.vertexAttribPointer(b.attributes.uv,2,j.FLOAT,!1,0,0));a.hasColors&&c.vertexColors!==THREE.NoColors&&(j.bindBuffer(j.ARRAY_BUFFER,a.__webglColorBuffer),j.bufferData(j.ARRAY_BUFFER,a.colorArray,j.DYNAMIC_DRAW),
j.enableVertexAttribArray(b.attributes.color),j.vertexAttribPointer(b.attributes.color,3,j.FLOAT,!1,0,0));j.drawArrays(j.TRIANGLES,0,a.count);a.count=0};this.renderBufferDirect=function(a,b,c,d,e,f){if(!1!==d.visible){var i,k,l,m;i=v(a,b,c,d,f);b=i.attributes;a=e.attributes;c=!1;i=16777215*e.id+2*i.id+(d.wireframe?1:0);i!==ca&&(ca=i,c=!0);c&&g();if(f instanceof THREE.Mesh)if(f=a.index){e=e.offsets;1<e.length&&(c=!0);for(var p=0,n=e.length;p<n;p++){var q=e[p].index;if(c){for(k in b)l=b[k],i=a[k],0<=
l&&(i?(m=i.itemSize,j.bindBuffer(j.ARRAY_BUFFER,i.buffer),h(l),j.vertexAttribPointer(l,m,j.FLOAT,!1,0,4*q*m)):d.defaultAttributeValues&&(2===d.defaultAttributeValues[k].length?j.vertexAttrib2fv(l,d.defaultAttributeValues[k]):3===d.defaultAttributeValues[k].length&&j.vertexAttrib3fv(l,d.defaultAttributeValues[k])));j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,f.buffer)}j.drawElements(j.TRIANGLES,e[p].count,j.UNSIGNED_SHORT,2*e[p].start);I.info.render.calls++;I.info.render.vertices+=e[p].count;I.info.render.faces+=
e[p].count/3}}else{if(c)for(k in b)"index"!==k&&(l=b[k],i=a[k],0<=l&&(i?(m=i.itemSize,j.bindBuffer(j.ARRAY_BUFFER,i.buffer),h(l),j.vertexAttribPointer(l,m,j.FLOAT,!1,0,0)):d.defaultAttributeValues&&d.defaultAttributeValues[k]&&(2===d.defaultAttributeValues[k].length?j.vertexAttrib2fv(l,d.defaultAttributeValues[k]):3===d.defaultAttributeValues[k].length&&j.vertexAttrib3fv(l,d.defaultAttributeValues[k]))));d=e.attributes.position;j.drawArrays(j.TRIANGLES,0,d.numItems/3);I.info.render.calls++;I.info.render.vertices+=
d.numItems/3;I.info.render.faces+=d.numItems/3/3}else if(f instanceof THREE.ParticleSystem){if(c){for(k in b)l=b[k],i=a[k],0<=l&&(i?(m=i.itemSize,j.bindBuffer(j.ARRAY_BUFFER,i.buffer),h(l),j.vertexAttribPointer(l,m,j.FLOAT,!1,0,0)):d.defaultAttributeValues&&d.defaultAttributeValues[k]&&(2===d.defaultAttributeValues[k].length?j.vertexAttrib2fv(l,d.defaultAttributeValues[k]):3===d.defaultAttributeValues[k].length&&j.vertexAttrib3fv(l,d.defaultAttributeValues[k])));d=a.position;j.drawArrays(j.POINTS,
0,d.numItems/3);I.info.render.calls++;I.info.render.points+=d.numItems/3}}else if(f instanceof THREE.Line&&c){for(k in b)l=b[k],i=a[k],0<=l&&(i?(m=i.itemSize,j.bindBuffer(j.ARRAY_BUFFER,i.buffer),h(l),j.vertexAttribPointer(l,m,j.FLOAT,!1,0,0)):d.defaultAttributeValues&&d.defaultAttributeValues[k]&&(2===d.defaultAttributeValues[k].length?j.vertexAttrib2fv(l,d.defaultAttributeValues[k]):3===d.defaultAttributeValues[k].length&&j.vertexAttrib3fv(l,d.defaultAttributeValues[k])));k=f.type===THREE.LineStrip?
j.LINE_STRIP:j.LINES;d=d.linewidth;d!==Ja&&(Ja=d);d=a.position;j.drawArrays(k,0,d.numItems/3);I.info.render.calls++;I.info.render.points+=d.numItems}}};this.renderBuffer=function(a,b,c,d,e,f){if(!1!==d.visible){var i,l,c=v(a,b,c,d,f),b=c.attributes,a=!1,c=16777215*e.id+2*c.id+(d.wireframe?1:0);c!==ca&&(ca=c,a=!0);a&&g();if(!d.morphTargets&&0<=b.position)a&&(j.bindBuffer(j.ARRAY_BUFFER,e.__webglVertexBuffer),h(b.position),j.vertexAttribPointer(b.position,3,j.FLOAT,!1,0,0));else if(f.morphTargetBase){c=
d.program.attributes;-1!==f.morphTargetBase&&0<=c.position?(j.bindBuffer(j.ARRAY_BUFFER,e.__webglMorphTargetsBuffers[f.morphTargetBase]),h(c.position),j.vertexAttribPointer(c.position,3,j.FLOAT,!1,0,0)):0<=c.position&&(j.bindBuffer(j.ARRAY_BUFFER,e.__webglVertexBuffer),h(c.position),j.vertexAttribPointer(c.position,3,j.FLOAT,!1,0,0));if(f.morphTargetForcedOrder.length){var m=0;l=f.morphTargetForcedOrder;for(i=f.morphTargetInfluences;m<d.numSupportedMorphTargets&&m<l.length;)0<=c["morphTarget"+m]&&
(j.bindBuffer(j.ARRAY_BUFFER,e.__webglMorphTargetsBuffers[l[m]]),h(c["morphTarget"+m]),j.vertexAttribPointer(c["morphTarget"+m],3,j.FLOAT,!1,0,0)),0<=c["morphNormal"+m]&&d.morphNormals&&(j.bindBuffer(j.ARRAY_BUFFER,e.__webglMorphNormalsBuffers[l[m]]),h(c["morphNormal"+m]),j.vertexAttribPointer(c["morphNormal"+m],3,j.FLOAT,!1,0,0)),f.__webglMorphTargetInfluences[m]=i[l[m]],m++}else{l=[];i=f.morphTargetInfluences;var p,n=i.length;for(p=0;p<n;p++)m=i[p],0<m&&l.push([m,p]);l.length>d.numSupportedMorphTargets?
(l.sort(k),l.length=d.numSupportedMorphTargets):l.length>d.numSupportedMorphNormals?l.sort(k):0===l.length&&l.push([0,0]);for(m=0;m<d.numSupportedMorphTargets;)l[m]?(p=l[m][1],0<=c["morphTarget"+m]&&(j.bindBuffer(j.ARRAY_BUFFER,e.__webglMorphTargetsBuffers[p]),h(c["morphTarget"+m]),j.vertexAttribPointer(c["morphTarget"+m],3,j.FLOAT,!1,0,0)),0<=c["morphNormal"+m]&&d.morphNormals&&(j.bindBuffer(j.ARRAY_BUFFER,e.__webglMorphNormalsBuffers[p]),h(c["morphNormal"+m]),j.vertexAttribPointer(c["morphNormal"+
m],3,j.FLOAT,!1,0,0)),f.__webglMorphTargetInfluences[m]=i[p]):f.__webglMorphTargetInfluences[m]=0,m++}null!==d.program.uniforms.morphTargetInfluences&&j.uniform1fv(d.program.uniforms.morphTargetInfluences,f.__webglMorphTargetInfluences)}if(a){if(e.__webglCustomAttributesList){i=0;for(l=e.__webglCustomAttributesList.length;i<l;i++)c=e.__webglCustomAttributesList[i],0<=b[c.buffer.belongsToAttribute]&&(j.bindBuffer(j.ARRAY_BUFFER,c.buffer),h(b[c.buffer.belongsToAttribute]),j.vertexAttribPointer(b[c.buffer.belongsToAttribute],
c.size,j.FLOAT,!1,0,0))}0<=b.color&&(0<f.geometry.colors.length||0<f.geometry.faces.length?(j.bindBuffer(j.ARRAY_BUFFER,e.__webglColorBuffer),h(b.color),j.vertexAttribPointer(b.color,3,j.FLOAT,!1,0,0)):d.defaultAttributeValues&&j.vertexAttrib3fv(b.color,d.defaultAttributeValues.color));0<=b.normal&&(j.bindBuffer(j.ARRAY_BUFFER,e.__webglNormalBuffer),h(b.normal),j.vertexAttribPointer(b.normal,3,j.FLOAT,!1,0,0));0<=b.tangent&&(j.bindBuffer(j.ARRAY_BUFFER,e.__webglTangentBuffer),h(b.tangent),j.vertexAttribPointer(b.tangent,
4,j.FLOAT,!1,0,0));0<=b.uv&&(f.geometry.faceVertexUvs[0]?(j.bindBuffer(j.ARRAY_BUFFER,e.__webglUVBuffer),h(b.uv),j.vertexAttribPointer(b.uv,2,j.FLOAT,!1,0,0)):d.defaultAttributeValues&&j.vertexAttrib2fv(b.uv,d.defaultAttributeValues.uv));0<=b.uv2&&(f.geometry.faceVertexUvs[1]?(j.bindBuffer(j.ARRAY_BUFFER,e.__webglUV2Buffer),h(b.uv2),j.vertexAttribPointer(b.uv2,2,j.FLOAT,!1,0,0)):d.defaultAttributeValues&&j.vertexAttrib2fv(b.uv2,d.defaultAttributeValues.uv2));d.skinning&&(0<=b.skinIndex&&0<=b.skinWeight)&&
(j.bindBuffer(j.ARRAY_BUFFER,e.__webglSkinIndicesBuffer),h(b.skinIndex),j.vertexAttribPointer(b.skinIndex,4,j.FLOAT,!1,0,0),j.bindBuffer(j.ARRAY_BUFFER,e.__webglSkinWeightsBuffer),h(b.skinWeight),j.vertexAttribPointer(b.skinWeight,4,j.FLOAT,!1,0,0));0<=b.lineDistance&&(j.bindBuffer(j.ARRAY_BUFFER,e.__webglLineDistanceBuffer),h(b.lineDistance),j.vertexAttribPointer(b.lineDistance,1,j.FLOAT,!1,0,0))}f instanceof THREE.Mesh?(d.wireframe?(d=d.wireframeLinewidth,d!==Ja&&(Ja=d),a&&j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,
e.__webglLineBuffer),j.drawElements(j.LINES,e.__webglLineCount,j.UNSIGNED_SHORT,0)):(a&&j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,e.__webglFaceBuffer),j.drawElements(j.TRIANGLES,e.__webglFaceCount,j.UNSIGNED_SHORT,0)),I.info.render.calls++,I.info.render.vertices+=e.__webglFaceCount,I.info.render.faces+=e.__webglFaceCount/3):f instanceof THREE.Line?(f=f.type===THREE.LineStrip?j.LINE_STRIP:j.LINES,d=d.linewidth,d!==Ja&&(Ja=d),j.drawArrays(f,0,e.__webglLineCount),I.info.render.calls++):f instanceof THREE.ParticleSystem&&
(j.drawArrays(j.POINTS,0,e.__webglParticleCount),I.info.render.calls++,I.info.render.points+=e.__webglParticleCount)}};this.render=function(a,b,c,d){if(!1===b instanceof THREE.Camera)console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");else{var e,f,g,h,k=a.__lights,n=a.fog;Ca=-1;Qa=!0;!0===a.autoUpdate&&a.updateMatrixWorld();void 0===b.parent&&b.updateMatrixWorld();b.matrixWorldInverse.getInverse(b.matrixWorld);wa.multiplyMatrices(b.projectionMatrix,b.matrixWorldInverse);
ya.setFromMatrix(wa);this.autoUpdateObjects&&this.initWebGLObjects(a);l(this.renderPluginsPre,a,b);I.info.render.calls=0;I.info.render.vertices=0;I.info.render.faces=0;I.info.render.points=0;this.setRenderTarget(c);(this.autoClear||d)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil);h=a.__webglObjects;d=0;for(e=h.length;d<e;d++)if(f=h[d],g=f.object,f.id=d,f.render=!1,g.visible&&(!(g instanceof THREE.Mesh||g instanceof THREE.ParticleSystem)||!g.frustumCulled||ya.intersectsObject(g))){var q=
g;q._modelViewMatrix.multiplyMatrices(b.matrixWorldInverse,q.matrixWorld);q._normalMatrix.getNormalMatrix(q._modelViewMatrix);var q=f,t=q.buffer,s=void 0,r=s=void 0,r=q.object.material;if(r instanceof THREE.MeshFaceMaterial)s=t.materialIndex,s=r.materials[s],s.transparent?(q.transparent=s,q.opaque=null):(q.opaque=s,q.transparent=null);else if(s=r)s.transparent?(q.transparent=s,q.opaque=null):(q.opaque=s,q.transparent=null);f.render=!0;!0===this.sortObjects&&(null!==g.renderDepth?f.z=g.renderDepth:
(ka.getPositionFromMatrix(g.matrixWorld),ka.applyProjection(wa),f.z=ka.z))}this.sortObjects&&h.sort(i);h=a.__webglObjectsImmediate;d=0;for(e=h.length;d<e;d++)f=h[d],g=f.object,g.visible&&(g._modelViewMatrix.multiplyMatrices(b.matrixWorldInverse,g.matrixWorld),g._normalMatrix.getNormalMatrix(g._modelViewMatrix),g=f.object.material,g.transparent?(f.transparent=g,f.opaque=null):(f.opaque=g,f.transparent=null));a.overrideMaterial?(d=a.overrideMaterial,this.setBlending(d.blending,d.blendEquation,d.blendSrc,
d.blendDst),this.setDepthTest(d.depthTest),this.setDepthWrite(d.depthWrite),A(d.polygonOffset,d.polygonOffsetFactor,d.polygonOffsetUnits),m(a.__webglObjects,!1,"",b,k,n,!0,d),p(a.__webglObjectsImmediate,"",b,k,n,!1,d)):(d=null,this.setBlending(THREE.NoBlending),m(a.__webglObjects,!0,"opaque",b,k,n,!1,d),p(a.__webglObjectsImmediate,"opaque",b,k,n,!1,d),m(a.__webglObjects,!1,"transparent",b,k,n,!0,d),p(a.__webglObjectsImmediate,"transparent",b,k,n,!0,d));l(this.renderPluginsPost,a,b);c&&(c.generateMipmaps&&
c.minFilter!==THREE.NearestFilter&&c.minFilter!==THREE.LinearFilter)&&(c instanceof THREE.WebGLRenderTargetCube?(j.bindTexture(j.TEXTURE_CUBE_MAP,c.__webglTexture),j.generateMipmap(j.TEXTURE_CUBE_MAP),j.bindTexture(j.TEXTURE_CUBE_MAP,null)):(j.bindTexture(j.TEXTURE_2D,c.__webglTexture),j.generateMipmap(j.TEXTURE_2D),j.bindTexture(j.TEXTURE_2D,null)));this.setDepthTest(!0);this.setDepthWrite(!0)}};this.renderImmediateObject=function(a,b,c,d,e){var f=v(a,b,c,d,e);ca=-1;I.setMaterialFaces(d);e.immediateRenderCallback?
e.immediateRenderCallback(f,j,ya):e.render(function(a){I.renderBufferImmediate(a,f,d)})};this.initWebGLObjects=function(a){a.__webglObjects||(a.__webglObjects=[],a.__webglObjectsImmediate=[],a.__webglSprites=[],a.__webglFlares=[]);for(;a.__objectsAdded.length;)t(a.__objectsAdded[0],a),a.__objectsAdded.splice(0,1);for(;a.__objectsRemoved.length;)s(a.__objectsRemoved[0],a),a.__objectsRemoved.splice(0,1);for(var b=0,g=a.__webglObjects.length;b<g;b++){var h=a.__webglObjects[b].object;void 0===h.__webglInit&&
(void 0!==h.__webglActive&&s(h,a),t(h,a));var i=h,l=i.geometry,m=void 0,p=void 0,q=void 0;if(l instanceof THREE.BufferGeometry){var u=j.DYNAMIC_DRAW,x=!l.dynamic,w=l.attributes,z=void 0,y=void 0;for(z in w)y=w[z],y.needsUpdate&&("index"===z?(j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,y.buffer),j.bufferData(j.ELEMENT_ARRAY_BUFFER,y.array,u)):(j.bindBuffer(j.ARRAY_BUFFER,y.buffer),j.bufferData(j.ARRAY_BUFFER,y.array,u)),y.needsUpdate=!1),x&&!y.dynamic&&(y.array=null)}else if(i instanceof THREE.Mesh){for(var A=
0,B=l.geometryGroupsList.length;A<B;A++)if(m=l.geometryGroupsList[A],q=d(i,m),l.buffersNeedUpdate&&c(m,i),p=q.attributes&&n(q),l.verticesNeedUpdate||l.morphTargetsNeedUpdate||l.elementsNeedUpdate||l.uvsNeedUpdate||l.normalsNeedUpdate||l.colorsNeedUpdate||l.tangentsNeedUpdate||p){var v=m,C=i,D=j.DYNAMIC_DRAW,E=!l.dynamic,F=q;if(v.__inittedArrays){var H=e(F),I=F.vertexColors?F.vertexColors:!1,L=f(F),M=H===THREE.SmoothShading,O=void 0,J=void 0,P=void 0,N=void 0,V=void 0,R=void 0,$=void 0,ba=void 0,X=
void 0,T=void 0,ca=void 0,U=void 0,Z=void 0,Y=void 0,W=void 0,Ca=void 0,ea=void 0,Ba=void 0,fa=void 0,ja=void 0,ga=void 0,ia=void 0,pa=void 0,oa=void 0,sa=void 0,qa=void 0,ua=void 0,va=void 0,Ea=void 0,Ga=void 0,Ha=void 0,Da=void 0,Fa=void 0,Ia=void 0,Sa=void 0,Ja=void 0,xa=void 0,ya=void 0,Na=void 0,Qa=void 0,db=0,eb=0,Pa=0,Ra=0,Ua=0,hb=0,Ta=0,tb=0,Za=0,ra=0,za=0,K=0,Oa=void 0,ib=v.__vertexArray,bb=v.__uvArray,cb=v.__uv2Array,wb=v.__normalArray,Va=v.__tangentArray,jb=v.__colorArray,Wa=v.__skinIndexArray,
Xa=v.__skinWeightArray,pb=v.__morphTargetsArrays,qb=v.__morphNormalsArrays,fb=v.__webglCustomAttributesList,G=void 0,gb=v.__faceArray,xb=v.__lineArray,Ka=C.geometry,vb=Ka.elementsNeedUpdate,Ab=Ka.uvsNeedUpdate,Db=Ka.normalsNeedUpdate,Gb=Ka.tangentsNeedUpdate,Pb=Ka.colorsNeedUpdate,Qb=Ka.morphTargetsNeedUpdate,fc=Ka.vertices,da=v.faces3,kb=Ka.faces,Eb=Ka.faceVertexUvs[0],Fb=Ka.faceVertexUvs[1],gc=Ka.skinIndices,Rb=Ka.skinWeights,Sb=Ka.morphTargets,Hb=Ka.morphNormals;if(Ka.verticesNeedUpdate){O=0;for(J=
da.length;O<J;O++)N=kb[da[O]],U=fc[N.a],Z=fc[N.b],Y=fc[N.c],ib[eb]=U.x,ib[eb+1]=U.y,ib[eb+2]=U.z,ib[eb+3]=Z.x,ib[eb+4]=Z.y,ib[eb+5]=Z.z,ib[eb+6]=Y.x,ib[eb+7]=Y.y,ib[eb+8]=Y.z,eb+=9;j.bindBuffer(j.ARRAY_BUFFER,v.__webglVertexBuffer);j.bufferData(j.ARRAY_BUFFER,ib,D)}if(Qb){Sa=0;for(Ja=Sb.length;Sa<Ja;Sa++){O=za=0;for(J=da.length;O<J;O++)Na=da[O],N=kb[Na],U=Sb[Sa].vertices[N.a],Z=Sb[Sa].vertices[N.b],Y=Sb[Sa].vertices[N.c],xa=pb[Sa],xa[za]=U.x,xa[za+1]=U.y,xa[za+2]=U.z,xa[za+3]=Z.x,xa[za+4]=Z.y,xa[za+
5]=Z.z,xa[za+6]=Y.x,xa[za+7]=Y.y,xa[za+8]=Y.z,F.morphNormals&&(M?(Qa=Hb[Sa].vertexNormals[Na],Ba=Qa.a,fa=Qa.b,ja=Qa.c):ja=fa=Ba=Hb[Sa].faceNormals[Na],ya=qb[Sa],ya[za]=Ba.x,ya[za+1]=Ba.y,ya[za+2]=Ba.z,ya[za+3]=fa.x,ya[za+4]=fa.y,ya[za+5]=fa.z,ya[za+6]=ja.x,ya[za+7]=ja.y,ya[za+8]=ja.z),za+=9;j.bindBuffer(j.ARRAY_BUFFER,v.__webglMorphTargetsBuffers[Sa]);j.bufferData(j.ARRAY_BUFFER,pb[Sa],D);F.morphNormals&&(j.bindBuffer(j.ARRAY_BUFFER,v.__webglMorphNormalsBuffers[Sa]),j.bufferData(j.ARRAY_BUFFER,qb[Sa],
D))}}if(Rb.length){O=0;for(J=da.length;O<J;O++)N=kb[da[O]],oa=Rb[N.a],sa=Rb[N.b],qa=Rb[N.c],Xa[ra]=oa.x,Xa[ra+1]=oa.y,Xa[ra+2]=oa.z,Xa[ra+3]=oa.w,Xa[ra+4]=sa.x,Xa[ra+5]=sa.y,Xa[ra+6]=sa.z,Xa[ra+7]=sa.w,Xa[ra+8]=qa.x,Xa[ra+9]=qa.y,Xa[ra+10]=qa.z,Xa[ra+11]=qa.w,ua=gc[N.a],va=gc[N.b],Ea=gc[N.c],Wa[ra]=ua.x,Wa[ra+1]=ua.y,Wa[ra+2]=ua.z,Wa[ra+3]=ua.w,Wa[ra+4]=va.x,Wa[ra+5]=va.y,Wa[ra+6]=va.z,Wa[ra+7]=va.w,Wa[ra+8]=Ea.x,Wa[ra+9]=Ea.y,Wa[ra+10]=Ea.z,Wa[ra+11]=Ea.w,ra+=12;0<ra&&(j.bindBuffer(j.ARRAY_BUFFER,
v.__webglSkinIndicesBuffer),j.bufferData(j.ARRAY_BUFFER,Wa,D),j.bindBuffer(j.ARRAY_BUFFER,v.__webglSkinWeightsBuffer),j.bufferData(j.ARRAY_BUFFER,Xa,D))}if(Pb&&I){O=0;for(J=da.length;O<J;O++)N=kb[da[O]],$=N.vertexColors,ba=N.color,3===$.length&&I===THREE.VertexColors?(ga=$[0],ia=$[1],pa=$[2]):pa=ia=ga=ba,jb[Za]=ga.r,jb[Za+1]=ga.g,jb[Za+2]=ga.b,jb[Za+3]=ia.r,jb[Za+4]=ia.g,jb[Za+5]=ia.b,jb[Za+6]=pa.r,jb[Za+7]=pa.g,jb[Za+8]=pa.b,Za+=9;0<Za&&(j.bindBuffer(j.ARRAY_BUFFER,v.__webglColorBuffer),j.bufferData(j.ARRAY_BUFFER,
jb,D))}if(Gb&&Ka.hasTangents){O=0;for(J=da.length;O<J;O++)N=kb[da[O]],X=N.vertexTangents,W=X[0],Ca=X[1],ea=X[2],Va[Ta]=W.x,Va[Ta+1]=W.y,Va[Ta+2]=W.z,Va[Ta+3]=W.w,Va[Ta+4]=Ca.x,Va[Ta+5]=Ca.y,Va[Ta+6]=Ca.z,Va[Ta+7]=Ca.w,Va[Ta+8]=ea.x,Va[Ta+9]=ea.y,Va[Ta+10]=ea.z,Va[Ta+11]=ea.w,Ta+=12;j.bindBuffer(j.ARRAY_BUFFER,v.__webglTangentBuffer);j.bufferData(j.ARRAY_BUFFER,Va,D)}if(Db&&H){O=0;for(J=da.length;O<J;O++)if(N=kb[da[O]],V=N.vertexNormals,R=N.normal,3===V.length&&M)for(Ga=0;3>Ga;Ga++)Da=V[Ga],wb[hb]=
Da.x,wb[hb+1]=Da.y,wb[hb+2]=Da.z,hb+=3;else for(Ga=0;3>Ga;Ga++)wb[hb]=R.x,wb[hb+1]=R.y,wb[hb+2]=R.z,hb+=3;j.bindBuffer(j.ARRAY_BUFFER,v.__webglNormalBuffer);j.bufferData(j.ARRAY_BUFFER,wb,D)}if(Ab&&Eb&&L){O=0;for(J=da.length;O<J;O++)if(P=da[O],T=Eb[P],void 0!==T)for(Ga=0;3>Ga;Ga++)Fa=T[Ga],bb[Pa]=Fa.x,bb[Pa+1]=Fa.y,Pa+=2;0<Pa&&(j.bindBuffer(j.ARRAY_BUFFER,v.__webglUVBuffer),j.bufferData(j.ARRAY_BUFFER,bb,D))}if(Ab&&Fb&&L){O=0;for(J=da.length;O<J;O++)if(P=da[O],ca=Fb[P],void 0!==ca)for(Ga=0;3>Ga;Ga++)Ia=
ca[Ga],cb[Ra]=Ia.x,cb[Ra+1]=Ia.y,Ra+=2;0<Ra&&(j.bindBuffer(j.ARRAY_BUFFER,v.__webglUV2Buffer),j.bufferData(j.ARRAY_BUFFER,cb,D))}if(vb){O=0;for(J=da.length;O<J;O++)gb[Ua]=db,gb[Ua+1]=db+1,gb[Ua+2]=db+2,Ua+=3,xb[tb]=db,xb[tb+1]=db+1,xb[tb+2]=db,xb[tb+3]=db+2,xb[tb+4]=db+1,xb[tb+5]=db+2,tb+=6,db+=3;j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,v.__webglFaceBuffer);j.bufferData(j.ELEMENT_ARRAY_BUFFER,gb,D);j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,v.__webglLineBuffer);j.bufferData(j.ELEMENT_ARRAY_BUFFER,xb,D)}if(fb){Ga=
0;for(Ha=fb.length;Ga<Ha;Ga++)if(G=fb[Ga],G.__original.needsUpdate){K=0;if(1===G.size)if(void 0===G.boundTo||"vertices"===G.boundTo){O=0;for(J=da.length;O<J;O++)N=kb[da[O]],G.array[K]=G.value[N.a],G.array[K+1]=G.value[N.b],G.array[K+2]=G.value[N.c],K+=3}else{if("faces"===G.boundTo){O=0;for(J=da.length;O<J;O++)Oa=G.value[da[O]],G.array[K]=Oa,G.array[K+1]=Oa,G.array[K+2]=Oa,K+=3}}else if(2===G.size)if(void 0===G.boundTo||"vertices"===G.boundTo){O=0;for(J=da.length;O<J;O++)N=kb[da[O]],U=G.value[N.a],
Z=G.value[N.b],Y=G.value[N.c],G.array[K]=U.x,G.array[K+1]=U.y,G.array[K+2]=Z.x,G.array[K+3]=Z.y,G.array[K+4]=Y.x,G.array[K+5]=Y.y,K+=6}else{if("faces"===G.boundTo){O=0;for(J=da.length;O<J;O++)Y=Z=U=Oa=G.value[da[O]],G.array[K]=U.x,G.array[K+1]=U.y,G.array[K+2]=Z.x,G.array[K+3]=Z.y,G.array[K+4]=Y.x,G.array[K+5]=Y.y,K+=6}}else if(3===G.size){var na;na="c"===G.type?["r","g","b"]:["x","y","z"];if(void 0===G.boundTo||"vertices"===G.boundTo){O=0;for(J=da.length;O<J;O++)N=kb[da[O]],U=G.value[N.a],Z=G.value[N.b],
Y=G.value[N.c],G.array[K]=U[na[0]],G.array[K+1]=U[na[1]],G.array[K+2]=U[na[2]],G.array[K+3]=Z[na[0]],G.array[K+4]=Z[na[1]],G.array[K+5]=Z[na[2]],G.array[K+6]=Y[na[0]],G.array[K+7]=Y[na[1]],G.array[K+8]=Y[na[2]],K+=9}else if("faces"===G.boundTo){O=0;for(J=da.length;O<J;O++)Y=Z=U=Oa=G.value[da[O]],G.array[K]=U[na[0]],G.array[K+1]=U[na[1]],G.array[K+2]=U[na[2]],G.array[K+3]=Z[na[0]],G.array[K+4]=Z[na[1]],G.array[K+5]=Z[na[2]],G.array[K+6]=Y[na[0]],G.array[K+7]=Y[na[1]],G.array[K+8]=Y[na[2]],K+=9}else if("faceVertices"===
G.boundTo){O=0;for(J=da.length;O<J;O++)Oa=G.value[da[O]],U=Oa[0],Z=Oa[1],Y=Oa[2],G.array[K]=U[na[0]],G.array[K+1]=U[na[1]],G.array[K+2]=U[na[2]],G.array[K+3]=Z[na[0]],G.array[K+4]=Z[na[1]],G.array[K+5]=Z[na[2]],G.array[K+6]=Y[na[0]],G.array[K+7]=Y[na[1]],G.array[K+8]=Y[na[2]],K+=9}}else if(4===G.size)if(void 0===G.boundTo||"vertices"===G.boundTo){O=0;for(J=da.length;O<J;O++)N=kb[da[O]],U=G.value[N.a],Z=G.value[N.b],Y=G.value[N.c],G.array[K]=U.x,G.array[K+1]=U.y,G.array[K+2]=U.z,G.array[K+3]=U.w,G.array[K+
4]=Z.x,G.array[K+5]=Z.y,G.array[K+6]=Z.z,G.array[K+7]=Z.w,G.array[K+8]=Y.x,G.array[K+9]=Y.y,G.array[K+10]=Y.z,G.array[K+11]=Y.w,K+=12}else if("faces"===G.boundTo){O=0;for(J=da.length;O<J;O++)Y=Z=U=Oa=G.value[da[O]],G.array[K]=U.x,G.array[K+1]=U.y,G.array[K+2]=U.z,G.array[K+3]=U.w,G.array[K+4]=Z.x,G.array[K+5]=Z.y,G.array[K+6]=Z.z,G.array[K+7]=Z.w,G.array[K+8]=Y.x,G.array[K+9]=Y.y,G.array[K+10]=Y.z,G.array[K+11]=Y.w,K+=12}else if("faceVertices"===G.boundTo){O=0;for(J=da.length;O<J;O++)Oa=G.value[da[O]],
U=Oa[0],Z=Oa[1],Y=Oa[2],G.array[K]=U.x,G.array[K+1]=U.y,G.array[K+2]=U.z,G.array[K+3]=U.w,G.array[K+4]=Z.x,G.array[K+5]=Z.y,G.array[K+6]=Z.z,G.array[K+7]=Z.w,G.array[K+8]=Y.x,G.array[K+9]=Y.y,G.array[K+10]=Y.z,G.array[K+11]=Y.w,K+=12}j.bindBuffer(j.ARRAY_BUFFER,G.buffer);j.bufferData(j.ARRAY_BUFFER,G.array,D)}}E&&(delete v.__inittedArrays,delete v.__colorArray,delete v.__normalArray,delete v.__tangentArray,delete v.__uvArray,delete v.__uv2Array,delete v.__faceArray,delete v.__vertexArray,delete v.__lineArray,
delete v.__skinIndexArray,delete v.__skinWeightArray)}}l.verticesNeedUpdate=!1;l.morphTargetsNeedUpdate=!1;l.elementsNeedUpdate=!1;l.uvsNeedUpdate=!1;l.normalsNeedUpdate=!1;l.colorsNeedUpdate=!1;l.tangentsNeedUpdate=!1;l.buffersNeedUpdate=!1;q.attributes&&r(q)}else if(i instanceof THREE.Line){q=d(i,l);p=q.attributes&&n(q);if(l.verticesNeedUpdate||l.colorsNeedUpdate||l.lineDistancesNeedUpdate||p){var Ya=l,Tb=j.DYNAMIC_DRAW,Lb=void 0,Mb=void 0,Nb=void 0,Ub=void 0,ma=void 0,Vb=void 0,Ib=Ya.vertices,
Jb=Ya.colors,Kb=Ya.lineDistances,$b=Ib.length,ac=Jb.length,bc=Kb.length,Wb=Ya.__vertexArray,Xb=Ya.__colorArray,lc=Ya.__lineDistanceArray,cc=Ya.colorsNeedUpdate,dc=Ya.lineDistancesNeedUpdate,hc=Ya.__webglCustomAttributesList,Yb=void 0,mc=void 0,Aa=void 0,Bb=void 0,La=void 0,la=void 0;if(Ya.verticesNeedUpdate){for(Lb=0;Lb<$b;Lb++)Ub=Ib[Lb],ma=3*Lb,Wb[ma]=Ub.x,Wb[ma+1]=Ub.y,Wb[ma+2]=Ub.z;j.bindBuffer(j.ARRAY_BUFFER,Ya.__webglVertexBuffer);j.bufferData(j.ARRAY_BUFFER,Wb,Tb)}if(cc){for(Mb=0;Mb<ac;Mb++)Vb=
Jb[Mb],ma=3*Mb,Xb[ma]=Vb.r,Xb[ma+1]=Vb.g,Xb[ma+2]=Vb.b;j.bindBuffer(j.ARRAY_BUFFER,Ya.__webglColorBuffer);j.bufferData(j.ARRAY_BUFFER,Xb,Tb)}if(dc){for(Nb=0;Nb<bc;Nb++)lc[Nb]=Kb[Nb];j.bindBuffer(j.ARRAY_BUFFER,Ya.__webglLineDistanceBuffer);j.bufferData(j.ARRAY_BUFFER,lc,Tb)}if(hc){Yb=0;for(mc=hc.length;Yb<mc;Yb++)if(la=hc[Yb],la.needsUpdate&&(void 0===la.boundTo||"vertices"===la.boundTo)){ma=0;Bb=la.value.length;if(1===la.size)for(Aa=0;Aa<Bb;Aa++)la.array[Aa]=la.value[Aa];else if(2===la.size)for(Aa=
0;Aa<Bb;Aa++)La=la.value[Aa],la.array[ma]=La.x,la.array[ma+1]=La.y,ma+=2;else if(3===la.size)if("c"===la.type)for(Aa=0;Aa<Bb;Aa++)La=la.value[Aa],la.array[ma]=La.r,la.array[ma+1]=La.g,la.array[ma+2]=La.b,ma+=3;else for(Aa=0;Aa<Bb;Aa++)La=la.value[Aa],la.array[ma]=La.x,la.array[ma+1]=La.y,la.array[ma+2]=La.z,ma+=3;else if(4===la.size)for(Aa=0;Aa<Bb;Aa++)La=la.value[Aa],la.array[ma]=La.x,la.array[ma+1]=La.y,la.array[ma+2]=La.z,la.array[ma+3]=La.w,ma+=4;j.bindBuffer(j.ARRAY_BUFFER,la.buffer);j.bufferData(j.ARRAY_BUFFER,
la.array,Tb)}}}l.verticesNeedUpdate=!1;l.colorsNeedUpdate=!1;l.lineDistancesNeedUpdate=!1;q.attributes&&r(q)}else if(i instanceof THREE.ParticleSystem){q=d(i,l);p=q.attributes&&n(q);if(l.verticesNeedUpdate||l.colorsNeedUpdate||i.sortParticles||p){var lb=l,ic=j.DYNAMIC_DRAW,Ob=i,Ma=void 0,mb=void 0,nb=void 0,S=void 0,ob=void 0,ub=void 0,Zb=lb.vertices,jc=Zb.length,kc=lb.colors,nc=kc.length,yb=lb.__vertexArray,zb=lb.__colorArray,rb=lb.__sortArray,oc=lb.verticesNeedUpdate,pc=lb.colorsNeedUpdate,sb=lb.__webglCustomAttributesList,
$a=void 0,Cb=void 0,aa=void 0,ab=void 0,ha=void 0,Q=void 0;if(Ob.sortParticles){ta.copy(wa);ta.multiply(Ob.matrixWorld);for(Ma=0;Ma<jc;Ma++)nb=Zb[Ma],ka.copy(nb),ka.applyProjection(ta),rb[Ma]=[ka.z,Ma];rb.sort(k);for(Ma=0;Ma<jc;Ma++)nb=Zb[rb[Ma][1]],S=3*Ma,yb[S]=nb.x,yb[S+1]=nb.y,yb[S+2]=nb.z;for(mb=0;mb<nc;mb++)S=3*mb,ub=kc[rb[mb][1]],zb[S]=ub.r,zb[S+1]=ub.g,zb[S+2]=ub.b;if(sb){$a=0;for(Cb=sb.length;$a<Cb;$a++)if(Q=sb[$a],void 0===Q.boundTo||"vertices"===Q.boundTo)if(S=0,ab=Q.value.length,1===Q.size)for(aa=
0;aa<ab;aa++)ob=rb[aa][1],Q.array[aa]=Q.value[ob];else if(2===Q.size)for(aa=0;aa<ab;aa++)ob=rb[aa][1],ha=Q.value[ob],Q.array[S]=ha.x,Q.array[S+1]=ha.y,S+=2;else if(3===Q.size)if("c"===Q.type)for(aa=0;aa<ab;aa++)ob=rb[aa][1],ha=Q.value[ob],Q.array[S]=ha.r,Q.array[S+1]=ha.g,Q.array[S+2]=ha.b,S+=3;else for(aa=0;aa<ab;aa++)ob=rb[aa][1],ha=Q.value[ob],Q.array[S]=ha.x,Q.array[S+1]=ha.y,Q.array[S+2]=ha.z,S+=3;else if(4===Q.size)for(aa=0;aa<ab;aa++)ob=rb[aa][1],ha=Q.value[ob],Q.array[S]=ha.x,Q.array[S+1]=
ha.y,Q.array[S+2]=ha.z,Q.array[S+3]=ha.w,S+=4}}else{if(oc)for(Ma=0;Ma<jc;Ma++)nb=Zb[Ma],S=3*Ma,yb[S]=nb.x,yb[S+1]=nb.y,yb[S+2]=nb.z;if(pc)for(mb=0;mb<nc;mb++)ub=kc[mb],S=3*mb,zb[S]=ub.r,zb[S+1]=ub.g,zb[S+2]=ub.b;if(sb){$a=0;for(Cb=sb.length;$a<Cb;$a++)if(Q=sb[$a],Q.needsUpdate&&(void 0===Q.boundTo||"vertices"===Q.boundTo))if(ab=Q.value.length,S=0,1===Q.size)for(aa=0;aa<ab;aa++)Q.array[aa]=Q.value[aa];else if(2===Q.size)for(aa=0;aa<ab;aa++)ha=Q.value[aa],Q.array[S]=ha.x,Q.array[S+1]=ha.y,S+=2;else if(3===
Q.size)if("c"===Q.type)for(aa=0;aa<ab;aa++)ha=Q.value[aa],Q.array[S]=ha.r,Q.array[S+1]=ha.g,Q.array[S+2]=ha.b,S+=3;else for(aa=0;aa<ab;aa++)ha=Q.value[aa],Q.array[S]=ha.x,Q.array[S+1]=ha.y,Q.array[S+2]=ha.z,S+=3;else if(4===Q.size)for(aa=0;aa<ab;aa++)ha=Q.value[aa],Q.array[S]=ha.x,Q.array[S+1]=ha.y,Q.array[S+2]=ha.z,Q.array[S+3]=ha.w,S+=4}}if(oc||Ob.sortParticles)j.bindBuffer(j.ARRAY_BUFFER,lb.__webglVertexBuffer),j.bufferData(j.ARRAY_BUFFER,yb,ic);if(pc||Ob.sortParticles)j.bindBuffer(j.ARRAY_BUFFER,
lb.__webglColorBuffer),j.bufferData(j.ARRAY_BUFFER,zb,ic);if(sb){$a=0;for(Cb=sb.length;$a<Cb;$a++)if(Q=sb[$a],Q.needsUpdate||Ob.sortParticles)j.bindBuffer(j.ARRAY_BUFFER,Q.buffer),j.bufferData(j.ARRAY_BUFFER,Q.array,ic)}}l.verticesNeedUpdate=!1;l.colorsNeedUpdate=!1;q.attributes&&r(q)}}};this.initMaterial=function(a,b,c,d){var e,f,g,h;a.addEventListener("dispose",Ib);var i,k,l,m,p;a instanceof THREE.MeshDepthMaterial?p="depth":a instanceof THREE.MeshNormalMaterial?p="normal":a instanceof THREE.MeshBasicMaterial?
p="basic":a instanceof THREE.MeshLambertMaterial?p="lambert":a instanceof THREE.MeshPhongMaterial?p="phong":a instanceof THREE.LineBasicMaterial?p="basic":a instanceof THREE.LineDashedMaterial?p="dashed":a instanceof THREE.ParticleBasicMaterial&&(p="particle_basic");if(p){var n=THREE.ShaderLib[p];a.uniforms=THREE.UniformsUtils.clone(n.uniforms);a.vertexShader=n.vertexShader;a.fragmentShader=n.fragmentShader}var q=0,t=0,s=0;e=n=0;for(f=b.length;e<f;e++)g=b[e],g.onlyShadow||(g instanceof THREE.DirectionalLight&&
q++,g instanceof THREE.PointLight&&t++,g instanceof THREE.SpotLight&&s++,g instanceof THREE.HemisphereLight&&n++);e=q;f=t;g=s;h=n;s=n=0;for(t=b.length;s<t;s++)q=b[s],q.castShadow&&(q instanceof THREE.SpotLight&&n++,q instanceof THREE.DirectionalLight&&!q.shadowCascade&&n++);m=n;Db&&d&&d.useVertexTexture?l=1024:(b=j.getParameter(j.MAX_VERTEX_UNIFORM_VECTORS),l=Math.floor((b-20)/4));a:{var s=a.fragmentShader,t=a.vertexShader,n=a.uniforms,b=a.attributes,q=a.defines,c={map:!!a.map,envMap:!!a.envMap,lightMap:!!a.lightMap,
bumpMap:!!a.bumpMap,normalMap:!!a.normalMap,specularMap:!!a.specularMap,vertexColors:a.vertexColors,fog:c,useFog:a.fog,fogExp:c instanceof THREE.FogExp2,sizeAttenuation:a.sizeAttenuation,skinning:a.skinning,maxBones:l,useVertexTexture:Db&&d&&d.useVertexTexture,morphTargets:a.morphTargets,morphNormals:a.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:e,maxPointLights:f,maxSpotLights:g,maxHemiLights:h,maxShadows:m,shadowMapEnabled:this.shadowMapEnabled&&
d.receiveShadow,shadowMapType:this.shadowMapType,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,alphaTest:a.alphaTest,metal:a.metal,perPixel:a.perPixel,wrapAround:a.wrapAround,doubleSided:a.side===THREE.DoubleSide,flipSided:a.side===THREE.BackSide},d=a.index0AttributeName,r,u,x;e=[];p?e.push(p):(e.push(s),e.push(t));for(u in q)e.push(u),e.push(q[u]);for(r in c)e.push(r),e.push(c[r]);p=e.join();r=0;for(u=W.length;r<u;r++)if(e=W[r],e.code===p){e.usedTimes++;k=e.program;break a}r=
"SHADOWMAP_TYPE_BASIC";c.shadowMapType===THREE.PCFShadowMap?r="SHADOWMAP_TYPE_PCF":c.shadowMapType===THREE.PCFSoftShadowMap&&(r="SHADOWMAP_TYPE_PCF_SOFT");u=[];for(x in q)e=q[x],!1!==e&&(e="#define "+x+" "+e,u.push(e));q=u.join("\n");x=j.createProgram();u=["precision "+w+" float;","precision "+w+" int;",q,Ab?"#define VERTEX_TEXTURES":"",I.gammaInput?"#define GAMMA_INPUT":"",I.gammaOutput?"#define GAMMA_OUTPUT":"",I.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+
c.maxDirLights,"#define MAX_POINT_LIGHTS "+c.maxPointLights,"#define MAX_SPOT_LIGHTS "+c.maxSpotLights,"#define MAX_HEMI_LIGHTS "+c.maxHemiLights,"#define MAX_SHADOWS "+c.maxShadows,"#define MAX_BONES "+c.maxBones,c.map?"#define USE_MAP":"",c.envMap?"#define USE_ENVMAP":"",c.lightMap?"#define USE_LIGHTMAP":"",c.bumpMap?"#define USE_BUMPMAP":"",c.normalMap?"#define USE_NORMALMAP":"",c.specularMap?"#define USE_SPECULARMAP":"",c.vertexColors?"#define USE_COLOR":"",c.skinning?"#define USE_SKINNING":"",
c.useVertexTexture?"#define BONE_TEXTURE":"",c.morphTargets?"#define USE_MORPHTARGETS":"",c.morphNormals?"#define USE_MORPHNORMALS":"",c.perPixel?"#define PHONG_PER_PIXEL":"",c.wrapAround?"#define WRAP_AROUND":"",c.doubleSided?"#define DOUBLE_SIDED":"",c.flipSided?"#define FLIP_SIDED":"",c.shadowMapEnabled?"#define USE_SHADOWMAP":"",c.shadowMapEnabled?"#define "+r:"",c.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",c.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",c.sizeAttenuation?"#define USE_SIZEATTENUATION":
"","uniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 cameraPosition;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nattribute vec2 uv2;\n#ifdef USE_COLOR\nattribute vec3 color;\n#endif\n#ifdef USE_MORPHTARGETS\nattribute vec3 morphTarget0;\nattribute vec3 morphTarget1;\nattribute vec3 morphTarget2;\nattribute vec3 morphTarget3;\n#ifdef USE_MORPHNORMALS\nattribute vec3 morphNormal0;\nattribute vec3 morphNormal1;\nattribute vec3 morphNormal2;\nattribute vec3 morphNormal3;\n#else\nattribute vec3 morphTarget4;\nattribute vec3 morphTarget5;\nattribute vec3 morphTarget6;\nattribute vec3 morphTarget7;\n#endif\n#endif\n#ifdef USE_SKINNING\nattribute vec4 skinIndex;\nattribute vec4 skinWeight;\n#endif\n"].join("\n");
r=["precision "+w+" float;","precision "+w+" int;",c.bumpMap||c.normalMap?"#extension GL_OES_standard_derivatives : enable":"",q,"#define MAX_DIR_LIGHTS "+c.maxDirLights,"#define MAX_POINT_LIGHTS "+c.maxPointLights,"#define MAX_SPOT_LIGHTS "+c.maxSpotLights,"#define MAX_HEMI_LIGHTS "+c.maxHemiLights,"#define MAX_SHADOWS "+c.maxShadows,c.alphaTest?"#define ALPHATEST "+c.alphaTest:"",I.gammaInput?"#define GAMMA_INPUT":"",I.gammaOutput?"#define GAMMA_OUTPUT":"",I.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":
"",c.useFog&&c.fog?"#define USE_FOG":"",c.useFog&&c.fogExp?"#define FOG_EXP2":"",c.map?"#define USE_MAP":"",c.envMap?"#define USE_ENVMAP":"",c.lightMap?"#define USE_LIGHTMAP":"",c.bumpMap?"#define USE_BUMPMAP":"",c.normalMap?"#define USE_NORMALMAP":"",c.specularMap?"#define USE_SPECULARMAP":"",c.vertexColors?"#define USE_COLOR":"",c.metal?"#define METAL":"",c.perPixel?"#define PHONG_PER_PIXEL":"",c.wrapAround?"#define WRAP_AROUND":"",c.doubleSided?"#define DOUBLE_SIDED":"",c.flipSided?"#define FLIP_SIDED":
"",c.shadowMapEnabled?"#define USE_SHADOWMAP":"",c.shadowMapEnabled?"#define "+r:"",c.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",c.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n"].join("\n");u=M("vertex",u+t);r=M("fragment",r+s);j.attachShader(x,u);j.attachShader(x,r);d&&j.bindAttribLocation(x,0,d);j.linkProgram(x);j.getProgramParameter(x,j.LINK_STATUS)||(console.error("Could not initialise shader\nVALIDATE_STATUS: "+j.getProgramParameter(x,
j.VALIDATE_STATUS)+", gl error ["+j.getError()+"]"),console.error("Program Info Log: "+j.getProgramInfoLog(x)));j.deleteShader(r);j.deleteShader(u);x.uniforms={};x.attributes={};var v;r="viewMatrix modelViewMatrix projectionMatrix normalMatrix modelMatrix cameraPosition morphTargetInfluences".split(" ");c.useVertexTexture?(r.push("boneTexture"),r.push("boneTextureWidth"),r.push("boneTextureHeight")):r.push("boneGlobalMatrices");for(v in n)r.push(v);v=r;r=0;for(n=v.length;r<n;r++)u=v[r],x.uniforms[u]=
j.getUniformLocation(x,u);r="position normal uv uv2 tangent color skinIndex skinWeight lineDistance".split(" ");for(v=0;v<c.maxMorphTargets;v++)r.push("morphTarget"+v);for(v=0;v<c.maxMorphNormals;v++)r.push("morphNormal"+v);for(k in b)r.push(k);k=r;v=0;for(b=k.length;v<b;v++)r=k[v],x.attributes[r]=j.getAttribLocation(x,r);x.id=ua++;W.push({program:x,code:p,usedTimes:1});I.info.memory.programs=W.length;k=x}a.program=k;v=a.program.attributes;if(a.morphTargets){a.numSupportedMorphTargets=0;b="morphTarget";
for(k=0;k<this.maxMorphTargets;k++)x=b+k,0<=v[x]&&a.numSupportedMorphTargets++}if(a.morphNormals){a.numSupportedMorphNormals=0;b="morphNormal";for(k=0;k<this.maxMorphNormals;k++)x=b+k,0<=v[x]&&a.numSupportedMorphNormals++}a.uniformsList=[];for(i in a.uniforms)a.uniformsList.push([a.uniforms[i],i])};this.setFaceCulling=function(a,b){a===THREE.CullFaceNone?j.disable(j.CULL_FACE):(b===THREE.FrontFaceDirectionCW?j.frontFace(j.CW):j.frontFace(j.CCW),a===THREE.CullFaceBack?j.cullFace(j.BACK):a===THREE.CullFaceFront?
j.cullFace(j.FRONT):j.cullFace(j.FRONT_AND_BACK),j.enable(j.CULL_FACE))};this.setMaterialFaces=function(a){var b=a.side===THREE.DoubleSide,a=a.side===THREE.BackSide;$!==b&&(b?j.disable(j.CULL_FACE):j.enable(j.CULL_FACE),$=b);ba!==a&&(a?j.frontFace(j.CW):j.frontFace(j.CCW),ba=a)};this.setDepthTest=function(a){Ea!==a&&(a?j.enable(j.DEPTH_TEST):j.disable(j.DEPTH_TEST),Ea=a)};this.setDepthWrite=function(a){Ia!==a&&(j.depthMask(a),Ia=a)};this.setBlending=function(a,b,c,d){a!==V&&(a===THREE.NoBlending?
j.disable(j.BLEND):a===THREE.AdditiveBlending?(j.enable(j.BLEND),j.blendEquation(j.FUNC_ADD),j.blendFunc(j.SRC_ALPHA,j.ONE)):a===THREE.SubtractiveBlending?(j.enable(j.BLEND),j.blendEquation(j.FUNC_ADD),j.blendFunc(j.ZERO,j.ONE_MINUS_SRC_COLOR)):a===THREE.MultiplyBlending?(j.enable(j.BLEND),j.blendEquation(j.FUNC_ADD),j.blendFunc(j.ZERO,j.SRC_COLOR)):a===THREE.CustomBlending?j.enable(j.BLEND):(j.enable(j.BLEND),j.blendEquationSeparate(j.FUNC_ADD,j.FUNC_ADD),j.blendFuncSeparate(j.SRC_ALPHA,j.ONE_MINUS_SRC_ALPHA,
j.ONE,j.ONE_MINUS_SRC_ALPHA)),V=a);if(a===THREE.CustomBlending){if(b!==pa&&(j.blendEquation(F(b)),pa=b),c!==sa||d!==ja)j.blendFunc(F(c),F(d)),sa=c,ja=d}else ja=sa=pa=null};this.uploadTexture=function(a){a.__webglInit||(a.__webglInit=!0,a.addEventListener("dispose",Gb),a.__webglTexture=j.createTexture(),I.info.memory.textures++);j.bindTexture(j.TEXTURE_2D,a.__webglTexture);a.flipY&&j.pixelStorei(j.UNPACK_FLIP_Y_WEBGL,a.flipY);a.premultiplyAlpha&&j.pixelStorei(j.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha);
4!==a.unpackAlignment&&j.pixelStorei(j.UNPACK_ALIGNMENT,a.unpackAlignment);var b=a.image,c=0===(b.width&b.width-1)&&0===(b.height&b.height-1),d=F(a.format),e=F(a.type);E(j.TEXTURE_2D,a,c);var f=a.mipmaps;if(a instanceof THREE.DataTexture)if(0<f.length&&c){for(var g=0,h=f.length;g<h;g++)b=f[g],j.texImage2D(j.TEXTURE_2D,g,d,b.width,b.height,0,d,e,b.data);a.generateMipmaps=!1}else j.texImage2D(j.TEXTURE_2D,0,d,b.width,b.height,0,d,e,b.data);else if(0<f.length&&c){g=0;for(h=f.length;g<h;g++)b=f[g],j.texImage2D(j.TEXTURE_2D,
g,d,d,e,b);a.generateMipmaps=!1}else j.texImage2D(j.TEXTURE_2D,0,d,d,e,a.image);a.generateMipmaps&&c&&j.generateMipmap(j.TEXTURE_2D);a.needsUpdate=!1;if(a.onUpdate)a.onUpdate()};this.setTexture=function(a,b){j.activeTexture(j.TEXTURE0+b);a.needsUpdate?I.uploadTexture(a):j.bindTexture(j.TEXTURE_2D,a.__webglTexture)};this.setRenderTarget=function(a){var b=a instanceof THREE.WebGLRenderTargetCube;if(a&&!a.__webglFramebuffer){void 0===a.depthBuffer&&(a.depthBuffer=!0);void 0===a.stencilBuffer&&(a.stencilBuffer=
!0);a.addEventListener("dispose",Hb);a.__webglTexture=j.createTexture();I.info.memory.textures++;var c=0===(a.width&a.width-1)&&0===(a.height&a.height-1),d=F(a.format),e=F(a.type);if(b){a.__webglFramebuffer=[];a.__webglRenderbuffer=[];j.bindTexture(j.TEXTURE_CUBE_MAP,a.__webglTexture);E(j.TEXTURE_CUBE_MAP,a,c);for(var f=0;6>f;f++){a.__webglFramebuffer[f]=j.createFramebuffer();a.__webglRenderbuffer[f]=j.createRenderbuffer();j.texImage2D(j.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,d,a.width,a.height,0,d,e,null);
var g=a,h=j.TEXTURE_CUBE_MAP_POSITIVE_X+f;j.bindFramebuffer(j.FRAMEBUFFER,a.__webglFramebuffer[f]);j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,h,g.__webglTexture,0);J(a.__webglRenderbuffer[f],a)}c&&j.generateMipmap(j.TEXTURE_CUBE_MAP)}else a.__webglFramebuffer=j.createFramebuffer(),a.__webglRenderbuffer=a.shareDepthFrom?a.shareDepthFrom.__webglRenderbuffer:j.createRenderbuffer(),j.bindTexture(j.TEXTURE_2D,a.__webglTexture),E(j.TEXTURE_2D,a,c),j.texImage2D(j.TEXTURE_2D,0,d,a.width,a.height,
0,d,e,null),d=j.TEXTURE_2D,j.bindFramebuffer(j.FRAMEBUFFER,a.__webglFramebuffer),j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,d,a.__webglTexture,0),a.shareDepthFrom?a.depthBuffer&&!a.stencilBuffer?j.framebufferRenderbuffer(j.FRAMEBUFFER,j.DEPTH_ATTACHMENT,j.RENDERBUFFER,a.__webglRenderbuffer):a.depthBuffer&&a.stencilBuffer&&j.framebufferRenderbuffer(j.FRAMEBUFFER,j.DEPTH_STENCIL_ATTACHMENT,j.RENDERBUFFER,a.__webglRenderbuffer):J(a.__webglRenderbuffer,a),c&&j.generateMipmap(j.TEXTURE_2D);
b?j.bindTexture(j.TEXTURE_CUBE_MAP,null):j.bindTexture(j.TEXTURE_2D,null);j.bindRenderbuffer(j.RENDERBUFFER,null);j.bindFramebuffer(j.FRAMEBUFFER,null)}a?(b=b?a.__webglFramebuffer[a.activeCubeFace]:a.__webglFramebuffer,c=a.width,a=a.height,e=d=0):(b=null,c=qb,a=fb,d=xa,e=pb);b!==Ba&&(j.bindFramebuffer(j.FRAMEBUFFER,b),j.viewport(d,e,c,a),Ba=b);gb=c;vb=a}};THREE.WebGLRenderTarget=function(a,b,c){this.width=a;this.height=b;c=c||{};this.wrapS=void 0!==c.wrapS?c.wrapS:THREE.ClampToEdgeWrapping;this.wrapT=void 0!==c.wrapT?c.wrapT:THREE.ClampToEdgeWrapping;this.magFilter=void 0!==c.magFilter?c.magFilter:THREE.LinearFilter;this.minFilter=void 0!==c.minFilter?c.minFilter:THREE.LinearMipMapLinearFilter;this.anisotropy=void 0!==c.anisotropy?c.anisotropy:1;this.offset=new THREE.Vector2(0,0);this.repeat=new THREE.Vector2(1,1);this.format=void 0!==c.format?c.format:
THREE.RGBAFormat;this.type=void 0!==c.type?c.type:THREE.UnsignedByteType;this.depthBuffer=void 0!==c.depthBuffer?c.depthBuffer:!0;this.stencilBuffer=void 0!==c.stencilBuffer?c.stencilBuffer:!0;this.generateMipmaps=!0;this.shareDepthFrom=null};
THREE.WebGLRenderTarget.prototype={constructor:THREE.WebGLRenderTarget,clone:function(){var a=new THREE.WebGLRenderTarget(this.width,this.height);a.wrapS=this.wrapS;a.wrapT=this.wrapT;a.magFilter=this.magFilter;a.minFilter=this.minFilter;a.anisotropy=this.anisotropy;a.offset.copy(this.offset);a.repeat.copy(this.repeat);a.format=this.format;a.type=this.type;a.depthBuffer=this.depthBuffer;a.stencilBuffer=this.stencilBuffer;a.generateMipmaps=this.generateMipmaps;a.shareDepthFrom=this.shareDepthFrom;
return a},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.EventDispatcher.prototype.apply(THREE.WebGLRenderTarget.prototype);THREE.WebGLRenderTargetCube=function(a,b,c){THREE.WebGLRenderTarget.call(this,a,b,c);this.activeCubeFace=0};THREE.WebGLRenderTargetCube.prototype=Object.create(THREE.WebGLRenderTarget.prototype);THREE.RenderableVertex=function(){this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=!0};THREE.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld);this.positionScreen.copy(a.positionScreen)};THREE.RenderableFace3=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.centroidModel=new THREE.Vector3;this.normalModel=new THREE.Vector3;this.normalModelView=new THREE.Vector3;this.vertexNormalsLength=0;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsModelView=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.material=this.color=null;this.uvs=[[]];this.z=
0};THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0};THREE.RenderableParticle=function(){this.id=0;this.object=null;this.z=this.y=this.x=0;this.rotation=null;this.scale=new THREE.Vector2;this.material=null};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.z=0};THREE.GeometryUtils={merge:function(a,b,c){var d,e,f=a.vertices.length,h=b instanceof THREE.Mesh?b.geometry:b,g=a.vertices,i=h.vertices,k=a.faces,l=h.faces,a=a.faceVertexUvs[0],h=h.faceVertexUvs[0];void 0===c&&(c=0);b instanceof THREE.Mesh&&(b.matrixAutoUpdate&&b.updateMatrix(),d=b.matrix,e=(new THREE.Matrix3).getNormalMatrix(d));for(var b=0,m=i.length;b<m;b++){var p=i[b].clone();d&&p.applyMatrix4(d);g.push(p)}b=0;for(m=l.length;b<m;b++){var p=l[b],t,q,n=p.vertexNormals,r=p.vertexColors;t=new THREE.Face3(p.a+
f,p.b+f,p.c+f);t.normal.copy(p.normal);e&&t.normal.applyMatrix3(e).normalize();g=0;for(i=n.length;g<i;g++)q=n[g].clone(),e&&q.applyMatrix3(e).normalize(),t.vertexNormals.push(q);t.color.copy(p.color);g=0;for(i=r.length;g<i;g++)q=r[g],t.vertexColors.push(q.clone());t.materialIndex=p.materialIndex+c;t.centroid.copy(p.centroid);d&&t.centroid.applyMatrix4(d);k.push(t)}b=0;for(m=h.length;b<m;b++){c=h[b];d=[];g=0;for(i=c.length;g<i;g++)d.push(new THREE.Vector2(c[g].x,c[g].y));a.push(d)}},randomPointInTriangle:function(){var a=
new THREE.Vector3;return function(b,c,d){var e=new THREE.Vector3,f=THREE.Math.random16(),h=THREE.Math.random16();1<f+h&&(f=1-f,h=1-h);var g=1-f-h;e.copy(b);e.multiplyScalar(f);a.copy(c);a.multiplyScalar(h);e.add(a);a.copy(d);a.multiplyScalar(g);e.add(a);return e}}(),randomPointInFace:function(a,b){return THREE.GeometryUtils.randomPointInTriangle(b.vertices[a.a],b.vertices[a.b],b.vertices[a.c])},randomPointsInGeometry:function(a,b){function c(a){function b(c,d){if(d<c)return c;var e=c+Math.floor((d-
c)/2);return k[e]>a?b(c,e-1):k[e]<a?b(e+1,d):e}return b(0,k.length-1)}var d,e,f=a.faces,h=a.vertices,g=f.length,i=0,k=[],l,m,p;for(e=0;e<g;e++)d=f[e],l=h[d.a],m=h[d.b],p=h[d.c],d._area=THREE.GeometryUtils.triangleArea(l,m,p),i+=d._area,k[e]=i;d=[];for(e=0;e<b;e++)h=THREE.Math.random16()*i,h=c(h),d[e]=THREE.GeometryUtils.randomPointInFace(f[h],a,!0);return d},triangleArea:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c,d,e){a.subVectors(d,c);b.subVectors(e,c);a.cross(b);return 0.5*
a.length()}}(),center:function(a){a.computeBoundingBox();var b=a.boundingBox,c=new THREE.Vector3;c.addVectors(b.min,b.max);c.multiplyScalar(-0.5);a.applyMatrix((new THREE.Matrix4).makeTranslation(c.x,c.y,c.z));a.computeBoundingBox();return c},triangulateQuads:function(a){var b,c,d,e,f=[],h=[];b=0;for(c=a.faceVertexUvs.length;b<c;b++)h[b]=[];b=0;for(c=a.faces.length;b<c;b++){f.push(a.faces[b]);d=0;for(e=a.faceVertexUvs.length;d<e;d++)h[d].push(a.faceVertexUvs[d][b])}a.faces=f;a.faceVertexUvs=h;a.computeCentroids();
a.computeFaceNormals();a.computeVertexNormals();a.hasTangents&&a.computeTangents()}};THREE.ImageUtils={crossOrigin:"anonymous",loadTexture:function(a,b,c){var d=new THREE.ImageLoader;d.crossOrigin=this.crossOrigin;var e=new THREE.Texture(void 0,b),b=d.load(a,function(){e.needsUpdate=!0;c&&c(e)});e.image=b;e.sourceFile=a;return e},loadCompressedTexture:function(a,b,c,d){var e=new THREE.CompressedTexture;e.mapping=b;var f=new XMLHttpRequest;f.onload=function(){var a=THREE.ImageUtils.parseDDS(f.response,!0);e.format=a.format;e.mipmaps=a.mipmaps;e.image.width=a.width;e.image.height=a.height;
e.generateMipmaps=!1;e.needsUpdate=!0;c&&c(e)};f.onerror=d;f.open("GET",a,!0);f.responseType="arraybuffer";f.send(null);return e},loadTextureCube:function(a,b,c,d){var e=[];e.loadCount=0;var f=new THREE.Texture;f.image=e;void 0!==b&&(f.mapping=b);f.flipY=!1;for(var b=0,h=a.length;b<h;++b){var g=new Image;e[b]=g;g.onload=function(){e.loadCount+=1;6===e.loadCount&&(f.needsUpdate=!0,c&&c(f))};g.onerror=d;g.crossOrigin=this.crossOrigin;g.src=a[b]}return f},loadCompressedTextureCube:function(a,b,c,d){var e=
[];e.loadCount=0;var f=new THREE.CompressedTexture;f.image=e;void 0!==b&&(f.mapping=b);f.flipY=!1;f.generateMipmaps=!1;b=function(a,b){return function(){var d=THREE.ImageUtils.parseDDS(a.response,!0);b.format=d.format;b.mipmaps=d.mipmaps;b.width=d.width;b.height=d.height;e.loadCount+=1;6===e.loadCount&&(f.format=d.format,f.needsUpdate=!0,c&&c(f))}};if(a instanceof Array)for(var h=0,g=a.length;h<g;++h){var i={};e[h]=i;var k=new XMLHttpRequest;k.onload=b(k,i);k.onerror=d;i=a[h];k.open("GET",i,!0);k.responseType=
"arraybuffer";k.send(null)}else k=new XMLHttpRequest,k.onload=function(){var a=THREE.ImageUtils.parseDDS(k.response,!0);if(a.isCubemap){for(var b=a.mipmaps.length/a.mipmapCount,d=0;d<b;d++){e[d]={mipmaps:[]};for(var g=0;g<a.mipmapCount;g++)e[d].mipmaps.push(a.mipmaps[d*a.mipmapCount+g]),e[d].format=a.format,e[d].width=a.width,e[d].height=a.height}f.format=a.format;f.needsUpdate=!0;c&&c(f)}},k.onerror=d,k.open("GET",a,!0),k.responseType="arraybuffer",k.send(null);return f},loadDDSTexture:function(a,
b,c,d){var e=[];e.loadCount=0;var f=new THREE.CompressedTexture;f.image=e;void 0!==b&&(f.mapping=b);f.flipY=!1;f.generateMipmaps=!1;var h=new XMLHttpRequest;h.onload=function(){var a=THREE.ImageUtils.parseDDS(h.response,!0);if(a.isCubemap)for(var b=a.mipmaps.length/a.mipmapCount,d=0;d<b;d++){e[d]={mipmaps:[]};for(var l=0;l<a.mipmapCount;l++)e[d].mipmaps.push(a.mipmaps[d*a.mipmapCount+l]),e[d].format=a.format,e[d].width=a.width,e[d].height=a.height}else f.image.width=a.width,f.image.height=a.height,
f.mipmaps=a.mipmaps;f.format=a.format;f.needsUpdate=!0;c&&c(f)};h.onerror=d;h.open("GET",a,!0);h.responseType="arraybuffer";h.send(null);return f},parseDDS:function(a,b){function c(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}var d={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},e=c("DXT1"),f=c("DXT3"),h=c("DXT5"),g=new Int32Array(a,0,31);if(542327876!==g[0])return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),d;if(!g[20]&
4)return console.error("ImageUtils.parseDDS(): Unsupported format, must contain a FourCC code"),d;var i=g[21],k=!1;switch(i){case e:e=8;d.format=THREE.RGB_S3TC_DXT1_Format;break;case f:e=16;d.format=THREE.RGBA_S3TC_DXT3_Format;break;case h:e=16;d.format=THREE.RGBA_S3TC_DXT5_Format;break;default:if(32==g[22]&&g[23]&16711680&&g[24]&65280&&g[25]&255&&g[26]&4278190080)k=!0,e=64,d.format=THREE.RGBAFormat;else return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",String.fromCharCode(i&
255,i>>8&255,i>>16&255,i>>24&255)),d}d.mipmapCount=1;g[2]&131072&&!1!==b&&(d.mipmapCount=Math.max(1,g[7]));d.isCubemap=g[28]&512?!0:!1;d.width=g[4];d.height=g[3];for(var g=g[1]+4,f=d.width,h=d.height,i=d.isCubemap?6:1,l=0;l<i;l++){for(var m=0;m<d.mipmapCount;m++){if(k){var p;p=f;for(var t=h,q=4*p*t,n=new Uint8Array(a,g,q),q=new Uint8Array(q),r=0,s=0,u=0;u<t;u++)for(var x=0;x<p;x++){var v=n[s];s++;var D=n[s];s++;var z=n[s];s++;var C=n[s];s++;q[r]=z;r++;q[r]=D;r++;q[r]=v;r++;q[r]=C;r++}p=q;t=p.length}else t=
Math.max(4,f)/4*Math.max(4,h)/4*e,p=new Uint8Array(a,g,t);d.mipmaps.push({data:p,width:f,height:h});g+=t;f=Math.max(0.5*f,1);h=Math.max(0.5*h,1)}f=d.width;h=d.height}return d},getNormalMap:function(){console.log("Error: getNormalMap has been removed due to license issue from this build")},generateDataTexture:function(a,b,c){for(var d=a*b,e=new Uint8Array(3*d),f=Math.floor(255*c.r),h=Math.floor(255*c.g),c=Math.floor(255*c.b),g=0;g<d;g++)e[3*g]=f,e[3*g+1]=h,e[3*g+2]=c;a=new THREE.DataTexture(e,a,b,
THREE.RGBFormat);a.needsUpdate=!0;return a}};THREE.SceneUtils={createMultiMaterialObject:function(a,b){for(var c=new THREE.Object3D,d=0,e=b.length;d<e;d++)c.add(new THREE.Mesh(a,b[d]));return c},detach:function(a,b,c){a.applyMatrix(b.matrixWorld);b.remove(a);c.add(a)},attach:function(a,b,c){var d=new THREE.Matrix4;d.getInverse(c.matrixWorld);a.applyMatrix(d);b.remove(a);c.add(a)}};THREE.Curve=function(){};THREE.Curve.prototype.getPoint=function(){console.log("Warning, getPoint() not implemented!");return null};THREE.Curve.prototype.getPointAt=function(a){a=this.getUtoTmapping(a);return this.getPoint(a)};THREE.Curve.prototype.getPoints=function(a){a||(a=5);var b,c=[];for(b=0;b<=a;b++)c.push(this.getPoint(b/a));return c};THREE.Curve.prototype.getSpacedPoints=function(a){a||(a=5);var b,c=[];for(b=0;b<=a;b++)c.push(this.getPointAt(b/a));return c};
THREE.Curve.prototype.getLength=function(){var a=this.getLengths();return a[a.length-1]};THREE.Curve.prototype.getLengths=function(a){a||(a=this.__arcLengthDivisions?this.__arcLengthDivisions:200);if(this.cacheArcLengths&&this.cacheArcLengths.length==a+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var b=[],c,d=this.getPoint(0),e,f=0;b.push(0);for(e=1;e<=a;e++)c=this.getPoint(e/a),f+=c.distanceTo(d),b.push(f),d=c;return this.cacheArcLengths=b};
THREE.Curve.prototype.updateArcLengths=function(){this.needsUpdate=!0;this.getLengths()};THREE.Curve.prototype.getUtoTmapping=function(a,b){var c=this.getLengths(),d=0,e=c.length,f;f=b?b:a*c[e-1];for(var h=0,g=e-1,i;h<=g;)if(d=Math.floor(h+(g-h)/2),i=c[d]-f,0>i)h=d+1;else if(0<i)g=d-1;else{g=d;break}d=g;if(c[d]==f)return d/(e-1);h=c[d];return c=(d+(f-h)/(c[d+1]-h))/(e-1)};THREE.Curve.prototype.getTangent=function(a){var b=a-1E-4,a=a+1E-4;0>b&&(b=0);1<a&&(a=1);b=this.getPoint(b);return this.getPoint(a).clone().sub(b).normalize()};
THREE.Curve.prototype.getTangentAt=function(a){a=this.getUtoTmapping(a);return this.getTangent(a)};
THREE.Curve.Utils={tangentQuadraticBezier:function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},tangentCubicBezier:function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},tangentSpline:function(a){return 6*a*a-6*a+(3*a*a-4*a+1)+(-6*a*a+6*a)+(3*a*a-2*a)},interpolate:function(a,b,c,d,e){var a=0.5*(c-a),d=0.5*(d-b),f=e*e;return(2*b-2*c+a+d)*e*f+(-3*b+3*c-2*a-d)*f+a*e+b}};
THREE.Curve.create=function(a,b){a.prototype=Object.create(THREE.Curve.prototype);a.prototype.getPoint=b;return a};THREE.CurvePath=function(){this.curves=[];this.bends=[];this.autoClose=!1};THREE.CurvePath.prototype=Object.create(THREE.Curve.prototype);THREE.CurvePath.prototype.add=function(a){this.curves.push(a)};THREE.CurvePath.prototype.checkConnection=function(){};THREE.CurvePath.prototype.closePath=function(){var a=this.curves[0].getPoint(0),b=this.curves[this.curves.length-1].getPoint(1);a.equals(b)||this.curves.push(new THREE.LineCurve(b,a))};
THREE.CurvePath.prototype.getPoint=function(a){for(var b=a*this.getLength(),c=this.getCurveLengths(),a=0;a<c.length;){if(c[a]>=b)return b=c[a]-b,a=this.curves[a],b=1-b/a.getLength(),a.getPointAt(b);a++}return null};THREE.CurvePath.prototype.getLength=function(){var a=this.getCurveLengths();return a[a.length-1]};
THREE.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var a=[],b=0,c,d=this.curves.length;for(c=0;c<d;c++)b+=this.curves[c].getLength(),a.push(b);return this.cacheLengths=a};
THREE.CurvePath.prototype.getBoundingBox=function(){var a=this.getPoints(),b,c,d,e,f,h;b=c=Number.NEGATIVE_INFINITY;e=f=Number.POSITIVE_INFINITY;var g,i,k,l,m=a[0]instanceof THREE.Vector3;l=m?new THREE.Vector3:new THREE.Vector2;i=0;for(k=a.length;i<k;i++)g=a[i],g.x>b?b=g.x:g.x<e&&(e=g.x),g.y>c?c=g.y:g.y<f&&(f=g.y),m&&(g.z>d?d=g.z:g.z<h&&(h=g.z)),l.add(g);a={minX:e,minY:f,maxX:b,maxY:c,centroid:l.divideScalar(k)};m&&(a.maxZ=d,a.minZ=h);return a};
THREE.CurvePath.prototype.createPointsGeometry=function(a){a=this.getPoints(a,!0);return this.createGeometry(a)};THREE.CurvePath.prototype.createSpacedPointsGeometry=function(a){a=this.getSpacedPoints(a,!0);return this.createGeometry(a)};THREE.CurvePath.prototype.createGeometry=function(a){for(var b=new THREE.Geometry,c=0;c<a.length;c++)b.vertices.push(new THREE.Vector3(a[c].x,a[c].y,a[c].z||0));return b};THREE.CurvePath.prototype.addWrapPath=function(a){this.bends.push(a)};
THREE.CurvePath.prototype.getTransformedPoints=function(a,b){var c=this.getPoints(a),d,e;b||(b=this.bends);d=0;for(e=b.length;d<e;d++)c=this.getWrapPoints(c,b[d]);return c};THREE.CurvePath.prototype.getTransformedSpacedPoints=function(a,b){var c=this.getSpacedPoints(a),d,e;b||(b=this.bends);d=0;for(e=b.length;d<e;d++)c=this.getWrapPoints(c,b[d]);return c};
THREE.CurvePath.prototype.getWrapPoints=function(a,b){var c=this.getBoundingBox(),d,e,f,h,g,i;d=0;for(e=a.length;d<e;d++)f=a[d],h=f.x,g=f.y,i=h/c.maxX,i=b.getUtoTmapping(i,h),h=b.getPoint(i),g=b.getNormalVector(i).multiplyScalar(g),f.x=h.x+g.x,f.y=h.y+g.y;return a};THREE.Gyroscope=function(){THREE.Object3D.call(this)};THREE.Gyroscope.prototype=Object.create(THREE.Object3D.prototype);
THREE.Gyroscope.prototype.updateMatrixWorld=function(a){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||a)this.parent?(this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorld.decompose(this.translationWorld,this.quaternionWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.quaternionObject,this.scaleObject),this.matrixWorld.compose(this.translationWorld,this.quaternionObject,this.scaleWorld)):this.matrixWorld.copy(this.matrix),
this.matrixWorldNeedsUpdate=!1,a=!0;for(var b=0,c=this.children.length;b<c;b++)this.children[b].updateMatrixWorld(a)};THREE.Gyroscope.prototype.translationWorld=new THREE.Vector3;THREE.Gyroscope.prototype.translationObject=new THREE.Vector3;THREE.Gyroscope.prototype.quaternionWorld=new THREE.Quaternion;THREE.Gyroscope.prototype.quaternionObject=new THREE.Quaternion;THREE.Gyroscope.prototype.scaleWorld=new THREE.Vector3;THREE.Gyroscope.prototype.scaleObject=new THREE.Vector3;THREE.Path=function(a){THREE.CurvePath.call(this);this.actions=[];a&&this.fromPoints(a)};THREE.Path.prototype=Object.create(THREE.CurvePath.prototype);THREE.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"};THREE.Path.prototype.fromPoints=function(a){this.moveTo(a[0].x,a[0].y);for(var b=1,c=a.length;b<c;b++)this.lineTo(a[b].x,a[b].y)};
THREE.Path.prototype.moveTo=function(a,b){var c=Array.prototype.slice.call(arguments);this.actions.push({action:THREE.PathActions.MOVE_TO,args:c})};THREE.Path.prototype.lineTo=function(a,b){var c=Array.prototype.slice.call(arguments),d=this.actions[this.actions.length-1].args,d=new THREE.LineCurve(new THREE.Vector2(d[d.length-2],d[d.length-1]),new THREE.Vector2(a,b));this.curves.push(d);this.actions.push({action:THREE.PathActions.LINE_TO,args:c})};
THREE.Path.prototype.quadraticCurveTo=function(a,b,c,d){var e=Array.prototype.slice.call(arguments),f=this.actions[this.actions.length-1].args,f=new THREE.QuadraticBezierCurve(new THREE.Vector2(f[f.length-2],f[f.length-1]),new THREE.Vector2(a,b),new THREE.Vector2(c,d));this.curves.push(f);this.actions.push({action:THREE.PathActions.QUADRATIC_CURVE_TO,args:e})};
THREE.Path.prototype.bezierCurveTo=function(a,b,c,d,e,f){var h=Array.prototype.slice.call(arguments),g=this.actions[this.actions.length-1].args,g=new THREE.CubicBezierCurve(new THREE.Vector2(g[g.length-2],g[g.length-1]),new THREE.Vector2(a,b),new THREE.Vector2(c,d),new THREE.Vector2(e,f));this.curves.push(g);this.actions.push({action:THREE.PathActions.BEZIER_CURVE_TO,args:h})};
THREE.Path.prototype.splineThru=function(a){var b=Array.prototype.slice.call(arguments),c=this.actions[this.actions.length-1].args,c=[new THREE.Vector2(c[c.length-2],c[c.length-1])];Array.prototype.push.apply(c,a);c=new THREE.SplineCurve(c);this.curves.push(c);this.actions.push({action:THREE.PathActions.CSPLINE_THRU,args:b})};THREE.Path.prototype.arc=function(a,b,c,d,e,f){var h=this.actions[this.actions.length-1].args;this.absarc(a+h[h.length-2],b+h[h.length-1],c,d,e,f)};
THREE.Path.prototype.absarc=function(a,b,c,d,e,f){this.absellipse(a,b,c,c,d,e,f)};THREE.Path.prototype.ellipse=function(a,b,c,d,e,f,h){var g=this.actions[this.actions.length-1].args;this.absellipse(a+g[g.length-2],b+g[g.length-1],c,d,e,f,h)};THREE.Path.prototype.absellipse=function(a,b,c,d,e,f,h){var g=Array.prototype.slice.call(arguments),i=new THREE.EllipseCurve(a,b,c,d,e,f,h);this.curves.push(i);i=i.getPoint(1);g.push(i.x);g.push(i.y);this.actions.push({action:THREE.PathActions.ELLIPSE,args:g})};
THREE.Path.prototype.getSpacedPoints=function(a){a||(a=40);for(var b=[],c=0;c<a;c++)b.push(this.getPoint(c/a));return b};
THREE.Path.prototype.getPoints=function(a,b){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(a,b);var a=a||12,c=[],d,e,f,h,g,i,k,l,m,p,t,q,n;d=0;for(e=this.actions.length;d<e;d++)switch(f=this.actions[d],h=f.action,f=f.args,h){case THREE.PathActions.MOVE_TO:c.push(new THREE.Vector2(f[0],f[1]));break;case THREE.PathActions.LINE_TO:c.push(new THREE.Vector2(f[0],f[1]));break;case THREE.PathActions.QUADRATIC_CURVE_TO:g=f[2];i=f[3];m=f[0];p=f[1];0<c.length?(h=c[c.length-1],t=h.x,
q=h.y):(h=this.actions[d-1].args,t=h[h.length-2],q=h[h.length-1]);for(f=1;f<=a;f++)n=f/a,h=THREE.Shape.Utils.b2(n,t,m,g),n=THREE.Shape.Utils.b2(n,q,p,i),c.push(new THREE.Vector2(h,n));break;case THREE.PathActions.BEZIER_CURVE_TO:g=f[4];i=f[5];m=f[0];p=f[1];k=f[2];l=f[3];0<c.length?(h=c[c.length-1],t=h.x,q=h.y):(h=this.actions[d-1].args,t=h[h.length-2],q=h[h.length-1]);for(f=1;f<=a;f++)n=f/a,h=THREE.Shape.Utils.b3(n,t,m,k,g),n=THREE.Shape.Utils.b3(n,q,p,l,i),c.push(new THREE.Vector2(h,n));break;case THREE.PathActions.CSPLINE_THRU:h=
this.actions[d-1].args;n=[new THREE.Vector2(h[h.length-2],h[h.length-1])];h=a*f[0].length;n=n.concat(f[0]);n=new THREE.SplineCurve(n);for(f=1;f<=h;f++)c.push(n.getPointAt(f/h));break;case THREE.PathActions.ARC:g=f[0];i=f[1];p=f[2];k=f[3];h=f[4];m=!!f[5];t=h-k;q=2*a;for(f=1;f<=q;f++)n=f/q,m||(n=1-n),n=k+n*t,h=g+p*Math.cos(n),n=i+p*Math.sin(n),c.push(new THREE.Vector2(h,n));break;case THREE.PathActions.ELLIPSE:g=f[0];i=f[1];p=f[2];l=f[3];k=f[4];h=f[5];m=!!f[6];t=h-k;q=2*a;for(f=1;f<=q;f++)n=f/q,m||
(n=1-n),n=k+n*t,h=g+p*Math.cos(n),n=i+l*Math.sin(n),c.push(new THREE.Vector2(h,n))}d=c[c.length-1];1E-10>Math.abs(d.x-c[0].x)&&1E-10>Math.abs(d.y-c[0].y)&&c.splice(c.length-1,1);b&&c.push(c[0]);return c};
THREE.Path.prototype.toShapes=function(a){var b,c,d,e,f=[],h=new THREE.Path;b=0;for(c=this.actions.length;b<c;b++)d=this.actions[b],e=d.args,d=d.action,d==THREE.PathActions.MOVE_TO&&0!=h.actions.length&&(f.push(h),h=new THREE.Path),h[d].apply(h,e);0!=h.actions.length&&f.push(h);if(0==f.length)return[];var g;e=[];if(1==f.length)return d=f[0],g=new THREE.Shape,g.actions=d.actions,g.curves=d.curves,e.push(g),e;b=!THREE.Shape.Utils.isClockWise(f[0].getPoints());if(a?!b:b){g=new THREE.Shape;b=0;for(c=
f.length;b<c;b++)d=f[b],h=THREE.Shape.Utils.isClockWise(d.getPoints()),(h=a?!h:h)?(g.actions=d.actions,g.curves=d.curves,e.push(g),g=new THREE.Shape):g.holes.push(d)}else{g=void 0;b=0;for(c=f.length;b<c;b++)d=f[b],h=THREE.Shape.Utils.isClockWise(d.getPoints()),(h=a?!h:h)?(g&&e.push(g),g=new THREE.Shape,g.actions=d.actions,g.curves=d.curves):g.holes.push(d);e.push(g)}return e};THREE.Shape=function(){THREE.Path.apply(this,arguments);this.holes=[]};THREE.Shape.prototype=Object.create(THREE.Path.prototype);THREE.Shape.prototype.extrude=function(a){return new THREE.ExtrudeGeometry(this,a)};THREE.Shape.prototype.makeGeometry=function(a){return new THREE.ShapeGeometry(this,a)};THREE.Shape.prototype.getPointsHoles=function(a){var b,c=this.holes.length,d=[];for(b=0;b<c;b++)d[b]=this.holes[b].getTransformedPoints(a,this.bends);return d};
THREE.Shape.prototype.getSpacedPointsHoles=function(a){var b,c=this.holes.length,d=[];for(b=0;b<c;b++)d[b]=this.holes[b].getTransformedSpacedPoints(a,this.bends);return d};THREE.Shape.prototype.extractAllPoints=function(a){return{shape:this.getTransformedPoints(a),holes:this.getPointsHoles(a)}};THREE.Shape.prototype.extractPoints=function(a){return this.useSpacedPoints?this.extractAllSpacedPoints(a):this.extractAllPoints(a)};
THREE.Shape.prototype.extractAllSpacedPoints=function(a){return{shape:this.getTransformedSpacedPoints(a),holes:this.getSpacedPointsHoles(a)}};
THREE.Shape.Utils={removeHoles:function(a,b){var c=a.concat(),d=c.concat(),e,f,h,g,i,k,l,m,p,t,q=[];for(i=0;i<b.length;i++){k=b[i];Array.prototype.push.apply(d,k);f=Number.POSITIVE_INFINITY;for(e=0;e<k.length;e++){p=k[e];t=[];for(m=0;m<c.length;m++)l=c[m],l=p.distanceToSquared(l),t.push(l),l<f&&(f=l,h=e,g=m)}e=0<=g-1?g-1:c.length-1;f=0<=h-1?h-1:k.length-1;var n=[k[h],c[g],c[e]];m=THREE.FontUtils.Triangulate.area(n);var r=[k[h],k[f],c[g]];p=THREE.FontUtils.Triangulate.area(r);t=g;l=h;g+=1;h+=-1;0>
g&&(g+=c.length);g%=c.length;0>h&&(h+=k.length);h%=k.length;e=0<=g-1?g-1:c.length-1;f=0<=h-1?h-1:k.length-1;n=[k[h],c[g],c[e]];n=THREE.FontUtils.Triangulate.area(n);r=[k[h],k[f],c[g]];r=THREE.FontUtils.Triangulate.area(r);m+p>n+r&&(g=t,h=l,0>g&&(g+=c.length),g%=c.length,0>h&&(h+=k.length),h%=k.length,e=0<=g-1?g-1:c.length-1,f=0<=h-1?h-1:k.length-1);m=c.slice(0,g);p=c.slice(g);t=k.slice(h);l=k.slice(0,h);f=[k[h],k[f],c[g]];q.push([k[h],c[g],c[e]]);q.push(f);c=m.concat(t).concat(l).concat(p)}return{shape:c,
isolatedPts:q,allpoints:d}},triangulateShape:function(a,b){var c=THREE.Shape.Utils.removeHoles(a,b),d=c.allpoints,e=c.isolatedPts,c=THREE.FontUtils.Triangulate(c.shape,!1),f,h,g,i,k={};f=0;for(h=d.length;f<h;f++)i=d[f].x+":"+d[f].y,void 0!==k[i]&&console.log("Duplicate point",i),k[i]=f;f=0;for(h=c.length;f<h;f++){g=c[f];for(d=0;3>d;d++)i=g[d].x+":"+g[d].y,i=k[i],void 0!==i&&(g[d]=i)}f=0;for(h=e.length;f<h;f++){g=e[f];for(d=0;3>d;d++)i=g[d].x+":"+g[d].y,i=k[i],void 0!==i&&(g[d]=i)}return c.concat(e)},
isClockWise:function(a){return 0>THREE.FontUtils.Triangulate.area(a)},b2p0:function(a,b){var c=1-a;return c*c*b},b2p1:function(a,b){return 2*(1-a)*a*b},b2p2:function(a,b){return a*a*b},b2:function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},b3p0:function(a,b){var c=1-a;return c*c*c*b},b3p1:function(a,b){var c=1-a;return 3*c*c*a*b},b3p2:function(a,b){return 3*(1-a)*a*a*b},b3p3:function(a,b){return a*a*a*b},b3:function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+
this.b3p3(a,e)}};THREE.LineCurve=function(a,b){this.v1=a;this.v2=b};THREE.LineCurve.prototype=Object.create(THREE.Curve.prototype);THREE.LineCurve.prototype.getPoint=function(a){var b=this.v2.clone().sub(this.v1);b.multiplyScalar(a).add(this.v1);return b};THREE.LineCurve.prototype.getPointAt=function(a){return this.getPoint(a)};THREE.LineCurve.prototype.getTangent=function(){return this.v2.clone().sub(this.v1).normalize()};THREE.QuadraticBezierCurve=function(a,b,c){this.v0=a;this.v1=b;this.v2=c};THREE.QuadraticBezierCurve.prototype=Object.create(THREE.Curve.prototype);THREE.QuadraticBezierCurve.prototype.getPoint=function(a){var b;b=THREE.Shape.Utils.b2(a,this.v0.x,this.v1.x,this.v2.x);a=THREE.Shape.Utils.b2(a,this.v0.y,this.v1.y,this.v2.y);return new THREE.Vector2(b,a)};
THREE.QuadraticBezierCurve.prototype.getTangent=function(a){var b;b=THREE.Curve.Utils.tangentQuadraticBezier(a,this.v0.x,this.v1.x,this.v2.x);a=THREE.Curve.Utils.tangentQuadraticBezier(a,this.v0.y,this.v1.y,this.v2.y);b=new THREE.Vector2(b,a);b.normalize();return b};THREE.CubicBezierCurve=function(a,b,c,d){this.v0=a;this.v1=b;this.v2=c;this.v3=d};THREE.CubicBezierCurve.prototype=Object.create(THREE.Curve.prototype);THREE.CubicBezierCurve.prototype.getPoint=function(a){var b;b=THREE.Shape.Utils.b3(a,this.v0.x,this.v1.x,this.v2.x,this.v3.x);a=THREE.Shape.Utils.b3(a,this.v0.y,this.v1.y,this.v2.y,this.v3.y);return new THREE.Vector2(b,a)};
THREE.CubicBezierCurve.prototype.getTangent=function(a){var b;b=THREE.Curve.Utils.tangentCubicBezier(a,this.v0.x,this.v1.x,this.v2.x,this.v3.x);a=THREE.Curve.Utils.tangentCubicBezier(a,this.v0.y,this.v1.y,this.v2.y,this.v3.y);b=new THREE.Vector2(b,a);b.normalize();return b};THREE.SplineCurve=function(a){this.points=void 0==a?[]:a};THREE.SplineCurve.prototype=Object.create(THREE.Curve.prototype);THREE.SplineCurve.prototype.getPoint=function(a){var b=new THREE.Vector2,c=[],d=this.points,e;e=(d.length-1)*a;a=Math.floor(e);e-=a;c[0]=0==a?a:a-1;c[1]=a;c[2]=a>d.length-2?d.length-1:a+1;c[3]=a>d.length-3?d.length-1:a+2;b.x=THREE.Curve.Utils.interpolate(d[c[0]].x,d[c[1]].x,d[c[2]].x,d[c[3]].x,e);b.y=THREE.Curve.Utils.interpolate(d[c[0]].y,d[c[1]].y,d[c[2]].y,d[c[3]].y,e);return b};THREE.EllipseCurve=function(a,b,c,d,e,f,h){this.aX=a;this.aY=b;this.xRadius=c;this.yRadius=d;this.aStartAngle=e;this.aEndAngle=f;this.aClockwise=h};THREE.EllipseCurve.prototype=Object.create(THREE.Curve.prototype);
THREE.EllipseCurve.prototype.getPoint=function(a){var b;b=this.aEndAngle-this.aStartAngle;0>b&&(b+=2*Math.PI);b>2*Math.PI&&(b-=2*Math.PI);b=!0===this.aClockwise?this.aEndAngle+(1-a)*(2*Math.PI-b):this.aStartAngle+a*b;a=this.aX+this.xRadius*Math.cos(b);b=this.aY+this.yRadius*Math.sin(b);return new THREE.Vector2(a,b)};THREE.ArcCurve=function(a,b,c,d,e,f){THREE.EllipseCurve.call(this,a,b,c,c,d,e,f)};THREE.ArcCurve.prototype=Object.create(THREE.EllipseCurve.prototype);THREE.LineCurve3=THREE.Curve.create(function(a,b){this.v1=a;this.v2=b},function(a){var b=new THREE.Vector3;b.subVectors(this.v2,this.v1);b.multiplyScalar(a);b.add(this.v1);return b});THREE.QuadraticBezierCurve3=THREE.Curve.create(function(a,b,c){this.v0=a;this.v1=b;this.v2=c},function(a){var b,c;b=THREE.Shape.Utils.b2(a,this.v0.x,this.v1.x,this.v2.x);c=THREE.Shape.Utils.b2(a,this.v0.y,this.v1.y,this.v2.y);a=THREE.Shape.Utils.b2(a,this.v0.z,this.v1.z,this.v2.z);return new THREE.Vector3(b,c,a)});THREE.CubicBezierCurve3=THREE.Curve.create(function(a,b,c,d){this.v0=a;this.v1=b;this.v2=c;this.v3=d},function(a){var b,c;b=THREE.Shape.Utils.b3(a,this.v0.x,this.v1.x,this.v2.x,this.v3.x);c=THREE.Shape.Utils.b3(a,this.v0.y,this.v1.y,this.v2.y,this.v3.y);a=THREE.Shape.Utils.b3(a,this.v0.z,this.v1.z,this.v2.z,this.v3.z);return new THREE.Vector3(b,c,a)});THREE.SplineCurve3=THREE.Curve.create(function(a){this.points=void 0==a?[]:a},function(a){var b=new THREE.Vector3,c=[],d=this.points,e,a=(d.length-1)*a;e=Math.floor(a);a-=e;c[0]=0==e?e:e-1;c[1]=e;c[2]=e>d.length-2?d.length-1:e+1;c[3]=e>d.length-3?d.length-1:e+2;e=d[c[0]];var f=d[c[1]],h=d[c[2]],c=d[c[3]];b.x=THREE.Curve.Utils.interpolate(e.x,f.x,h.x,c.x,a);b.y=THREE.Curve.Utils.interpolate(e.y,f.y,h.y,c.y,a);b.z=THREE.Curve.Utils.interpolate(e.z,f.z,h.z,c.z,a);return b});THREE.ClosedSplineCurve3=THREE.Curve.create(function(a){this.points=void 0==a?[]:a},function(a){var b=new THREE.Vector3,c=[],d=this.points,e;e=(d.length-0)*a;a=Math.floor(e);e-=a;a+=0<a?0:(Math.floor(Math.abs(a)/d.length)+1)*d.length;c[0]=(a-1)%d.length;c[1]=a%d.length;c[2]=(a+1)%d.length;c[3]=(a+2)%d.length;b.x=THREE.Curve.Utils.interpolate(d[c[0]].x,d[c[1]].x,d[c[2]].x,d[c[3]].x,e);b.y=THREE.Curve.Utils.interpolate(d[c[0]].y,d[c[1]].y,d[c[2]].y,d[c[3]].y,e);b.z=THREE.Curve.Utils.interpolate(d[c[0]].z,
d[c[1]].z,d[c[2]].z,d[c[3]].z,e);return b});THREE.AnimationHandler=function(){var a=[],b={},c={update:function(b){for(var c=0;c<a.length;c++)a[c].update(b)},addToUpdate:function(b){-1===a.indexOf(b)&&a.push(b)},removeFromUpdate:function(b){b=a.indexOf(b);-1!==b&&a.splice(b,1)},add:function(a){void 0!==b[a.name]&&console.log("THREE.AnimationHandler.add: Warning! "+a.name+" already exists in library. Overwriting.");b[a.name]=a;if(!0!==a.initialized){for(var c=0;c<a.hierarchy.length;c++){for(var d=0;d<a.hierarchy[c].keys.length;d++)if(0>a.hierarchy[c].keys[d].time&&
(a.hierarchy[c].keys[d].time=0),void 0!==a.hierarchy[c].keys[d].rot&&!(a.hierarchy[c].keys[d].rot instanceof THREE.Quaternion)){var g=a.hierarchy[c].keys[d].rot;a.hierarchy[c].keys[d].rot=new THREE.Quaternion(g[0],g[1],g[2],g[3])}if(a.hierarchy[c].keys.length&&void 0!==a.hierarchy[c].keys[0].morphTargets){g={};for(d=0;d<a.hierarchy[c].keys.length;d++)for(var i=0;i<a.hierarchy[c].keys[d].morphTargets.length;i++){var k=a.hierarchy[c].keys[d].morphTargets[i];g[k]=-1}a.hierarchy[c].usedMorphTargets=g;
for(d=0;d<a.hierarchy[c].keys.length;d++){var l={};for(k in g){for(i=0;i<a.hierarchy[c].keys[d].morphTargets.length;i++)if(a.hierarchy[c].keys[d].morphTargets[i]===k){l[k]=a.hierarchy[c].keys[d].morphTargetsInfluences[i];break}i===a.hierarchy[c].keys[d].morphTargets.length&&(l[k]=0)}a.hierarchy[c].keys[d].morphTargetsInfluences=l}}for(d=1;d<a.hierarchy[c].keys.length;d++)a.hierarchy[c].keys[d].time===a.hierarchy[c].keys[d-1].time&&(a.hierarchy[c].keys.splice(d,1),d--);for(d=0;d<a.hierarchy[c].keys.length;d++)a.hierarchy[c].keys[d].index=
d}d=parseInt(a.length*a.fps,10);a.JIT={};a.JIT.hierarchy=[];for(c=0;c<a.hierarchy.length;c++)a.JIT.hierarchy.push(Array(d));a.initialized=!0}},get:function(a){if("string"===typeof a){if(b[a])return b[a];console.log("THREE.AnimationHandler.get: Couldn't find animation "+a);return null}},parse:function(a){var b=[];if(a instanceof THREE.SkinnedMesh)for(var c=0;c<a.bones.length;c++)b.push(a.bones[c]);else d(a,b);return b}},d=function(a,b){b.push(a);for(var c=0;c<a.children.length;c++)d(a.children[c],
b)};c.LINEAR=0;c.CATMULLROM=1;c.CATMULLROM_FORWARD=2;return c}();THREE.Animation=function(a,b,c){this.root=a;this.data=THREE.AnimationHandler.get(b);this.hierarchy=THREE.AnimationHandler.parse(a);this.currentTime=0;this.timeScale=1;this.isPlaying=!1;this.loop=this.isPaused=!0;this.interpolationType=void 0!==c?c:THREE.AnimationHandler.LINEAR;this.points=[];this.target=new THREE.Vector3};
THREE.Animation.prototype.play=function(a,b){if(!1===this.isPlaying){this.isPlaying=!0;this.loop=void 0!==a?a:!0;this.currentTime=void 0!==b?b:0;var c,d=this.hierarchy.length,e;for(c=0;c<d;c++){e=this.hierarchy[c];e.matrixAutoUpdate=!0;void 0===e.animationCache&&(e.animationCache={},e.animationCache.prevKey={pos:0,rot:0,scl:0},e.animationCache.nextKey={pos:0,rot:0,scl:0},e.animationCache.originalMatrix=e instanceof THREE.Bone?e.skinMatrix:e.matrix);var f=e.animationCache.prevKey;e=e.animationCache.nextKey;
f.pos=this.data.hierarchy[c].keys[0];f.rot=this.data.hierarchy[c].keys[0];f.scl=this.data.hierarchy[c].keys[0];e.pos=this.getNextKeyWith("pos",c,1);e.rot=this.getNextKeyWith("rot",c,1);e.scl=this.getNextKeyWith("scl",c,1)}this.update(0)}this.isPaused=!1;THREE.AnimationHandler.addToUpdate(this)};THREE.Animation.prototype.pause=function(){!0===this.isPaused?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this);this.isPaused=!this.isPaused};
THREE.Animation.prototype.stop=function(){this.isPaused=this.isPlaying=!1;THREE.AnimationHandler.removeFromUpdate(this)};
THREE.Animation.prototype.update=function(a){if(!1!==this.isPlaying){var b=["pos","rot","scl"],c,d,e,f,h,g,i,k,l;l=this.currentTime+=a*this.timeScale;k=this.currentTime%=this.data.length;parseInt(Math.min(k*this.data.fps,this.data.length*this.data.fps),10);for(var m=0,p=this.hierarchy.length;m<p;m++){a=this.hierarchy[m];i=a.animationCache;for(var t=0;3>t;t++){c=b[t];h=i.prevKey[c];g=i.nextKey[c];if(g.time<=l){if(k<l)if(this.loop){h=this.data.hierarchy[m].keys[0];for(g=this.getNextKeyWith(c,m,1);g.time<
k;)h=g,g=this.getNextKeyWith(c,m,g.index+1)}else{this.stop();return}else{do h=g,g=this.getNextKeyWith(c,m,g.index+1);while(g.time<k)}i.prevKey[c]=h;i.nextKey[c]=g}a.matrixAutoUpdate=!0;a.matrixWorldNeedsUpdate=!0;d=(k-h.time)/(g.time-h.time);e=h[c];f=g[c];if(0>d||1<d)console.log("THREE.Animation.update: Warning! Scale out of bounds:"+d+" on bone "+m),d=0>d?0:1;if("pos"===c)if(c=a.position,this.interpolationType===THREE.AnimationHandler.LINEAR)c.x=e[0]+(f[0]-e[0])*d,c.y=e[1]+(f[1]-e[1])*d,c.z=e[2]+
(f[2]-e[2])*d;else{if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD)this.points[0]=this.getPrevKeyWith("pos",m,h.index-1).pos,this.points[1]=e,this.points[2]=f,this.points[3]=this.getNextKeyWith("pos",m,g.index+1).pos,d=0.33*d+0.33,e=this.interpolateCatmullRom(this.points,d),c.x=e[0],c.y=e[1],c.z=e[2],this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD&&(d=this.interpolateCatmullRom(this.points,1.01*d),
this.target.set(d[0],d[1],d[2]),this.target.sub(c),this.target.y=0,this.target.normalize(),d=Math.atan2(this.target.x,this.target.z),a.rotation.set(0,d,0))}else"rot"===c?THREE.Quaternion.slerp(e,f,a.quaternion,d):"scl"===c&&(c=a.scale,c.x=e[0]+(f[0]-e[0])*d,c.y=e[1]+(f[1]-e[1])*d,c.z=e[2]+(f[2]-e[2])*d)}}}};
THREE.Animation.prototype.interpolateCatmullRom=function(a,b){var c=[],d=[],e,f,h,g,i,k;e=(a.length-1)*b;f=Math.floor(e);e-=f;c[0]=0===f?f:f-1;c[1]=f;c[2]=f>a.length-2?f:f+1;c[3]=f>a.length-3?f:f+2;f=a[c[0]];g=a[c[1]];i=a[c[2]];k=a[c[3]];c=e*e;h=e*c;d[0]=this.interpolate(f[0],g[0],i[0],k[0],e,c,h);d[1]=this.interpolate(f[1],g[1],i[1],k[1],e,c,h);d[2]=this.interpolate(f[2],g[2],i[2],k[2],e,c,h);return d};
THREE.Animation.prototype.interpolate=function(a,b,c,d,e,f,h){a=0.5*(c-a);d=0.5*(d-b);return(2*(b-c)+a+d)*h+(-3*(b-c)-2*a-d)*f+a*e+b};THREE.Animation.prototype.getNextKeyWith=function(a,b,c){for(var d=this.data.hierarchy[b].keys,c=this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?c<d.length-1?c:d.length-1:c%d.length;c<d.length;c++)if(void 0!==d[c][a])return d[c];return this.data.hierarchy[b].keys[0]};
THREE.Animation.prototype.getPrevKeyWith=function(a,b,c){for(var d=this.data.hierarchy[b].keys,c=this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?0<c?c:0:0<=c?c:c+d.length;0<=c;c--)if(void 0!==d[c][a])return d[c];return this.data.hierarchy[b].keys[d.length-1]};THREE.KeyFrameAnimation=function(a,b,c){this.root=a;this.data=THREE.AnimationHandler.get(b);this.hierarchy=THREE.AnimationHandler.parse(a);this.currentTime=0;this.timeScale=0.001;this.isPlaying=!1;this.loop=this.isPaused=!0;this.JITCompile=void 0!==c?c:!0;a=0;for(b=this.hierarchy.length;a<b;a++){var c=this.data.hierarchy[a].sids,d=this.hierarchy[a];if(this.data.hierarchy[a].keys.length&&c){for(var e=0;e<c.length;e++){var f=c[e],h=this.getNextKeyWith(f,a,0);h&&h.apply(f)}d.matrixAutoUpdate=!1;this.data.hierarchy[a].node.updateMatrix();
d.matrixWorldNeedsUpdate=!0}}};
THREE.KeyFrameAnimation.prototype.play=function(a,b){if(!this.isPlaying){this.isPlaying=!0;this.loop=void 0!==a?a:!0;this.currentTime=void 0!==b?b:0;this.startTimeMs=b;this.startTime=1E7;this.endTime=-this.startTime;var c,d=this.hierarchy.length,e,f;for(c=0;c<d;c++)e=this.hierarchy[c],f=this.data.hierarchy[c],void 0===f.animationCache&&(f.animationCache={},f.animationCache.prevKey=null,f.animationCache.nextKey=null,f.animationCache.originalMatrix=e instanceof THREE.Bone?e.skinMatrix:e.matrix),e=this.data.hierarchy[c].keys,
e.length&&(f.animationCache.prevKey=e[0],f.animationCache.nextKey=e[1],this.startTime=Math.min(e[0].time,this.startTime),this.endTime=Math.max(e[e.length-1].time,this.endTime));this.update(0)}this.isPaused=!1;THREE.AnimationHandler.addToUpdate(this)};THREE.KeyFrameAnimation.prototype.pause=function(){this.isPaused?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this);this.isPaused=!this.isPaused};
THREE.KeyFrameAnimation.prototype.stop=function(){this.isPaused=this.isPlaying=!1;THREE.AnimationHandler.removeFromUpdate(this);for(var a=0;a<this.data.hierarchy.length;a++){var b=this.hierarchy[a],c=this.data.hierarchy[a];if(void 0!==c.animationCache){var d=c.animationCache.originalMatrix;b instanceof THREE.Bone?(d.copy(b.skinMatrix),b.skinMatrix=d):(d.copy(b.matrix),b.matrix=d);delete c.animationCache}}};
THREE.KeyFrameAnimation.prototype.update=function(a){if(this.isPlaying){var b,c,d,e,f=this.data.JIT.hierarchy,h,g,i;g=this.currentTime+=a*this.timeScale;h=this.currentTime%=this.data.length;h<this.startTimeMs&&(h=this.currentTime=this.startTimeMs+h);e=parseInt(Math.min(h*this.data.fps,this.data.length*this.data.fps),10);if((i=h<g)&&!this.loop){for(var a=0,k=this.hierarchy.length;a<k;a++){var l=this.data.hierarchy[a].keys,f=this.data.hierarchy[a].sids;d=l.length-1;e=this.hierarchy[a];if(l.length){for(l=
0;l<f.length;l++)h=f[l],(g=this.getPrevKeyWith(h,a,d))&&g.apply(h);this.data.hierarchy[a].node.updateMatrix();e.matrixWorldNeedsUpdate=!0}}this.stop()}else if(!(h<this.startTime)){a=0;for(k=this.hierarchy.length;a<k;a++){d=this.hierarchy[a];b=this.data.hierarchy[a];var l=b.keys,m=b.animationCache;if(this.JITCompile&&void 0!==f[a][e])d instanceof THREE.Bone?(d.skinMatrix=f[a][e],d.matrixWorldNeedsUpdate=!1):(d.matrix=f[a][e],d.matrixWorldNeedsUpdate=!0);else if(l.length){this.JITCompile&&m&&(d instanceof
THREE.Bone?d.skinMatrix=m.originalMatrix:d.matrix=m.originalMatrix);b=m.prevKey;c=m.nextKey;if(b&&c){if(c.time<=g){if(i&&this.loop){b=l[0];for(c=l[1];c.time<h;)b=c,c=l[b.index+1]}else if(!i)for(var p=l.length-1;c.time<h&&c.index!==p;)b=c,c=l[b.index+1];m.prevKey=b;m.nextKey=c}c.time>=h?b.interpolate(c,h):b.interpolate(c,c.time)}this.data.hierarchy[a].node.updateMatrix();d.matrixWorldNeedsUpdate=!0}}if(this.JITCompile&&void 0===f[0][e]){this.hierarchy[0].updateMatrixWorld(!0);for(a=0;a<this.hierarchy.length;a++)f[a][e]=
this.hierarchy[a]instanceof THREE.Bone?this.hierarchy[a].skinMatrix.clone():this.hierarchy[a].matrix.clone()}}}};THREE.KeyFrameAnimation.prototype.getNextKeyWith=function(a,b,c){b=this.data.hierarchy[b].keys;for(c%=b.length;c<b.length;c++)if(b[c].hasTarget(a))return b[c];return b[0]};THREE.KeyFrameAnimation.prototype.getPrevKeyWith=function(a,b,c){b=this.data.hierarchy[b].keys;for(c=0<=c?c:c+b.length;0<=c;c--)if(b[c].hasTarget(a))return b[c];return b[b.length-1]};THREE.CubeCamera=function(a,b,c){THREE.Object3D.call(this);var d=new THREE.PerspectiveCamera(90,1,a,b);d.up.set(0,-1,0);d.lookAt(new THREE.Vector3(1,0,0));this.add(d);var e=new THREE.PerspectiveCamera(90,1,a,b);e.up.set(0,-1,0);e.lookAt(new THREE.Vector3(-1,0,0));this.add(e);var f=new THREE.PerspectiveCamera(90,1,a,b);f.up.set(0,0,1);f.lookAt(new THREE.Vector3(0,1,0));this.add(f);var h=new THREE.PerspectiveCamera(90,1,a,b);h.up.set(0,0,-1);h.lookAt(new THREE.Vector3(0,-1,0));this.add(h);var g=new THREE.PerspectiveCamera(90,
1,a,b);g.up.set(0,-1,0);g.lookAt(new THREE.Vector3(0,0,1));this.add(g);var i=new THREE.PerspectiveCamera(90,1,a,b);i.up.set(0,-1,0);i.lookAt(new THREE.Vector3(0,0,-1));this.add(i);this.renderTarget=new THREE.WebGLRenderTargetCube(c,c,{format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter});this.updateCubeMap=function(a,b){var c=this.renderTarget,p=c.generateMipmaps;c.generateMipmaps=!1;c.activeCubeFace=0;a.render(b,d,c);c.activeCubeFace=1;a.render(b,e,c);c.activeCubeFace=
2;a.render(b,f,c);c.activeCubeFace=3;a.render(b,h,c);c.activeCubeFace=4;a.render(b,g,c);c.generateMipmaps=p;c.activeCubeFace=5;a.render(b,i,c)}};THREE.CubeCamera.prototype=Object.create(THREE.Object3D.prototype);THREE.CombinedCamera=function(a,b,c,d,e,f,h){THREE.Camera.call(this);this.fov=c;this.left=-a/2;this.right=a/2;this.top=b/2;this.bottom=-b/2;this.cameraO=new THREE.OrthographicCamera(a/-2,a/2,b/2,b/-2,f,h);this.cameraP=new THREE.PerspectiveCamera(c,a/b,d,e);this.zoom=1;this.toPerspective()};THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype);
THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near;this.far=this.cameraP.far;this.cameraP.fov=this.fov/this.zoom;this.cameraP.updateProjectionMatrix();this.projectionMatrix=this.cameraP.projectionMatrix;this.inPerspectiveMode=!0;this.inOrthographicMode=!1};
THREE.CombinedCamera.prototype.toOrthographic=function(){var a=this.cameraP.aspect,b=(this.cameraP.near+this.cameraP.far)/2,b=Math.tan(this.fov/2)*b,a=2*b*a/2,b=b/this.zoom,a=a/this.zoom;this.cameraO.left=-a;this.cameraO.right=a;this.cameraO.top=b;this.cameraO.bottom=-b;this.cameraO.updateProjectionMatrix();this.near=this.cameraO.near;this.far=this.cameraO.far;this.projectionMatrix=this.cameraO.projectionMatrix;this.inPerspectiveMode=!1;this.inOrthographicMode=!0};
THREE.CombinedCamera.prototype.setSize=function(a,b){this.cameraP.aspect=a/b;this.left=-a/2;this.right=a/2;this.top=b/2;this.bottom=-b/2};THREE.CombinedCamera.prototype.setFov=function(a){this.fov=a;this.inPerspectiveMode?this.toPerspective():this.toOrthographic()};THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){this.inPerspectiveMode?this.toPerspective():(this.toPerspective(),this.toOrthographic())};
THREE.CombinedCamera.prototype.setLens=function(a,b){void 0===b&&(b=24);var c=2*THREE.Math.radToDeg(Math.atan(b/(2*a)));this.setFov(c);return c};THREE.CombinedCamera.prototype.setZoom=function(a){this.zoom=a;this.inPerspectiveMode?this.toPerspective():this.toOrthographic()};THREE.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=!1};
THREE.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0;this.rotation.y=Math.PI;this.rotation.z=0;this.rotationAutoUpdate=!1};THREE.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0;this.rotation.y=-Math.PI/2;this.rotation.z=0;this.rotationAutoUpdate=!1};THREE.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0;this.rotation.y=Math.PI/2;this.rotation.z=0;this.rotationAutoUpdate=!1};
THREE.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=!1};THREE.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=!1};THREE.CircleGeometry=function(a,b,c,d){THREE.Geometry.call(this);this.radius=a=a||50;this.segments=b=void 0!==b?Math.max(3,b):8;this.thetaStart=c=void 0!==c?c:0;this.thetaLength=d=void 0!==d?d:2*Math.PI;var e,f=[];e=new THREE.Vector3;var h=new THREE.Vector2(0.5,0.5);this.vertices.push(e);f.push(h);for(e=0;e<=b;e++){var g=new THREE.Vector3,i=c+e/b*d;g.x=a*Math.cos(i);g.y=a*Math.sin(i);this.vertices.push(g);f.push(new THREE.Vector2((g.x/a+1)/2,(g.y/a+1)/2))}c=new THREE.Vector3(0,0,1);for(e=1;e<=b;e++)this.faces.push(new THREE.Face3(e,
e+1,0,[c,c,c])),this.faceVertexUvs[0].push([f[e],f[e+1],h]);this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,a)};THREE.CircleGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.CubeGeometry=function(a,b,c,d,e,f){function h(a,b,c,d,e,f,h,n){var r,s=g.widthSegments,u=g.heightSegments,x=e/2,v=f/2,D=g.vertices.length;if("x"===a&&"y"===b||"y"===a&&"x"===b)r="z";else if("x"===a&&"z"===b||"z"===a&&"x"===b)r="y",u=g.depthSegments;else if("z"===a&&"y"===b||"y"===a&&"z"===b)r="x",s=g.depthSegments;var z=s+1,C=u+1,A=e/s,y=f/u,M=new THREE.Vector3;M[r]=0<h?1:-1;for(e=0;e<C;e++)for(f=0;f<z;f++){var E=new THREE.Vector3;E[a]=(f*A-x)*c;E[b]=(e*y-v)*d;E[r]=h;g.vertices.push(E)}for(e=
0;e<u;e++)for(f=0;f<s;f++)v=f+z*e,a=f+z*(e+1),b=f+1+z*(e+1),c=f+1+z*e,d=new THREE.Vector2(f/s,1-e/u),h=new THREE.Vector2(f/s,1-(e+1)/u),r=new THREE.Vector2((f+1)/s,1-(e+1)/u),x=new THREE.Vector2((f+1)/s,1-e/u),v=new THREE.Face3(v+D,a+D,c+D),v.normal.copy(M),v.vertexNormals.push(M.clone(),M.clone(),M.clone()),v.materialIndex=n,g.faces.push(v),g.faceVertexUvs[0].push([d,h,x]),v=new THREE.Face3(a+D,b+D,c+D),v.normal.copy(M),v.vertexNormals.push(M.clone(),M.clone(),M.clone()),v.materialIndex=n,g.faces.push(v),
g.faceVertexUvs[0].push([h.clone(),r,x.clone()])}THREE.Geometry.call(this);var g=this;this.width=a;this.height=b;this.depth=c;this.widthSegments=d||1;this.heightSegments=e||1;this.depthSegments=f||1;a=this.width/2;b=this.height/2;c=this.depth/2;h("z","y",-1,-1,this.depth,this.height,a,0);h("z","y",1,-1,this.depth,this.height,-a,1);h("x","z",1,1,this.width,this.depth,b,2);h("x","z",1,-1,this.width,this.depth,-b,3);h("x","y",1,-1,this.width,this.height,c,4);h("x","y",-1,-1,this.width,this.height,-c,
5);this.computeCentroids();this.mergeVertices()};THREE.CubeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.CylinderGeometry=function(a,b,c,d,e,f){THREE.Geometry.call(this);this.radiusTop=a=void 0!==a?a:20;this.radiusBottom=b=void 0!==b?b:20;this.height=c=void 0!==c?c:100;this.radialSegments=d=d||8;this.heightSegments=e=e||1;this.openEnded=f=void 0!==f?f:!1;var h=c/2,g,i,k=[],l=[];for(i=0;i<=e;i++){var m=[],p=[],t=i/e,q=t*(b-a)+a;for(g=0;g<=d;g++){var n=g/d,r=new THREE.Vector3;r.x=q*Math.sin(2*n*Math.PI);r.y=-t*c+h;r.z=q*Math.cos(2*n*Math.PI);this.vertices.push(r);m.push(this.vertices.length-1);p.push(new THREE.Vector2(n,
1-t))}k.push(m);l.push(p)}c=(b-a)/c;for(g=0;g<d;g++){0!==a?(m=this.vertices[k[0][g]].clone(),p=this.vertices[k[0][g+1]].clone()):(m=this.vertices[k[1][g]].clone(),p=this.vertices[k[1][g+1]].clone());m.setY(Math.sqrt(m.x*m.x+m.z*m.z)*c).normalize();p.setY(Math.sqrt(p.x*p.x+p.z*p.z)*c).normalize();for(i=0;i<e;i++){var t=k[i][g],q=k[i+1][g],n=k[i+1][g+1],r=k[i][g+1],s=m.clone(),u=m.clone(),x=p.clone(),v=p.clone(),D=l[i][g].clone(),z=l[i+1][g].clone(),C=l[i+1][g+1].clone(),A=l[i][g+1].clone();this.faces.push(new THREE.Face3(t,
q,r,[s,u,v]));this.faceVertexUvs[0].push([D,z,A]);this.faces.push(new THREE.Face3(q,n,r,[u,x,v]));this.faceVertexUvs[0].push([z,C,A])}}if(!1===f&&0<a){this.vertices.push(new THREE.Vector3(0,h,0));for(g=0;g<d;g++)t=k[0][g],q=k[0][g+1],n=this.vertices.length-1,s=new THREE.Vector3(0,1,0),u=new THREE.Vector3(0,1,0),x=new THREE.Vector3(0,1,0),D=l[0][g].clone(),z=l[0][g+1].clone(),C=new THREE.Vector2(z.u,0),this.faces.push(new THREE.Face3(t,q,n,[s,u,x])),this.faceVertexUvs[0].push([D,z,C])}if(!1===f&&0<
b){this.vertices.push(new THREE.Vector3(0,-h,0));for(g=0;g<d;g++)t=k[i][g+1],q=k[i][g],n=this.vertices.length-1,s=new THREE.Vector3(0,-1,0),u=new THREE.Vector3(0,-1,0),x=new THREE.Vector3(0,-1,0),D=l[i][g+1].clone(),z=l[i][g].clone(),C=new THREE.Vector2(z.u,1),this.faces.push(new THREE.Face3(t,q,n,[s,u,x])),this.faceVertexUvs[0].push([D,z,C])}this.computeCentroids();this.computeFaceNormals()};THREE.CylinderGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ExtrudeGeometry=function(a,b){"undefined"!==typeof a&&(THREE.Geometry.call(this),a=a instanceof Array?a:[a],this.shapebb=a[a.length-1].getBoundingBox(),this.addShapeList(a,b),this.computeCentroids(),this.computeFaceNormals())};THREE.ExtrudeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ExtrudeGeometry.prototype.addShapeList=function(a,b){for(var c=a.length,d=0;d<c;d++)this.addShape(a[d],b)};
THREE.ExtrudeGeometry.prototype.addShape=function(a,b){function c(a,b,c){b||console.log("die");return b.clone().multiplyScalar(c).add(a)}function d(a,b,c){var d=THREE.ExtrudeGeometry.__v1,e=THREE.ExtrudeGeometry.__v2,f=THREE.ExtrudeGeometry.__v3,g=THREE.ExtrudeGeometry.__v4,h=THREE.ExtrudeGeometry.__v5,i=THREE.ExtrudeGeometry.__v6;d.set(a.x-b.x,a.y-b.y);e.set(a.x-c.x,a.y-c.y);d=d.normalize();e=e.normalize();f.set(-d.y,d.x);g.set(e.y,-e.x);h.copy(a).add(f);i.copy(a).add(g);if(h.equals(i))return g.clone();
h.copy(b).add(f);i.copy(c).add(g);f=d.dot(g);g=i.sub(h).dot(g);0===f&&(console.log("Either infinite or no solutions!"),0===g?console.log("Its finite solutions."):console.log("Too bad, no solutions."));g/=f;return 0>g?(b=Math.atan2(b.y-a.y,b.x-a.x),a=Math.atan2(c.y-a.y,c.x-a.x),b>a&&(a+=2*Math.PI),c=(b+a)/2,a=-Math.cos(c),c=-Math.sin(c),new THREE.Vector2(a,c)):d.multiplyScalar(g).add(h).sub(a).clone()}function e(c,d){var e,f;for(H=c.length;0<=--H;){e=H;f=H-1;0>f&&(f=c.length-1);for(var g=0,h=t+2*l,
g=0;g<h;g++){var i=fa*g,k=fa*(g+1),m=d+e+i,i=d+f+i,p=d+f+k,k=d+e+k,n=c,q=g,r=h,s=e,v=f,m=m+J,i=i+J,p=p+J,k=k+J;E.faces.push(new THREE.Face3(m,i,k,null,null,u));E.faces.push(new THREE.Face3(i,p,k,null,null,u));m=x.generateSideWallUV(E,a,n,b,m,i,p,k,q,r,s,v);E.faceVertexUvs[0].push([m[0],m[1],m[3]]);E.faceVertexUvs[0].push([m[1],m[2],m[3]])}}}function f(a,b,c){E.vertices.push(new THREE.Vector3(a,b,c))}function h(c,d,e,f){c+=J;d+=J;e+=J;E.faces.push(new THREE.Face3(c,d,e,null,null,s));c=f?x.generateBottomUV(E,
a,b,c,d,e):x.generateTopUV(E,a,b,c,d,e);E.faceVertexUvs[0].push(c)}var g=void 0!==b.amount?b.amount:100,i=void 0!==b.bevelThickness?b.bevelThickness:6,k=void 0!==b.bevelSize?b.bevelSize:i-2,l=void 0!==b.bevelSegments?b.bevelSegments:3,m=void 0!==b.bevelEnabled?b.bevelEnabled:!0,p=void 0!==b.curveSegments?b.curveSegments:12,t=void 0!==b.steps?b.steps:1,q=b.extrudePath,n,r=!1,s=b.material,u=b.extrudeMaterial,x=void 0!==b.UVGenerator?b.UVGenerator:THREE.ExtrudeGeometry.WorldUVGenerator,v,D,z,C;q&&(n=
q.getSpacedPoints(t),r=!0,m=!1,v=void 0!==b.frames?b.frames:new THREE.TubeGeometry.FrenetFrames(q,t,!1),D=new THREE.Vector3,z=new THREE.Vector3,C=new THREE.Vector3);m||(k=i=l=0);var A,y,M,E=this,J=this.vertices.length,p=a.extractPoints(p),P=p.shape,p=p.holes;if(q=!THREE.Shape.Utils.isClockWise(P)){P=P.reverse();y=0;for(M=p.length;y<M;y++)A=p[y],THREE.Shape.Utils.isClockWise(A)&&(p[y]=A.reverse());q=!1}var F=THREE.Shape.Utils.triangulateShape(P,p),q=P;y=0;for(M=p.length;y<M;y++)A=p[y],P=P.concat(A);
var B,w,R,L,fa=P.length,ia=F.length,oa=[],H=0,T=q.length;B=T-1;for(w=H+1;H<T;H++,B++,w++)B===T&&(B=0),w===T&&(w=0),oa[H]=d(q[H],q[B],q[w]);var I=[],W,ua=oa.concat();y=0;for(M=p.length;y<M;y++){A=p[y];W=[];H=0;T=A.length;B=T-1;for(w=H+1;H<T;H++,B++,w++)B===T&&(B=0),w===T&&(w=0),W[H]=d(A[H],A[B],A[w]);I.push(W);ua=ua.concat(W)}for(B=0;B<l;B++){A=B/l;R=i*(1-A);w=k*Math.sin(A*Math.PI/2);H=0;for(T=q.length;H<T;H++)L=c(q[H],oa[H],w),f(L.x,L.y,-R);y=0;for(M=p.length;y<M;y++){A=p[y];W=I[y];H=0;for(T=A.length;H<
T;H++)L=c(A[H],W[H],w),f(L.x,L.y,-R)}}w=k;for(H=0;H<fa;H++)L=m?c(P[H],ua[H],w):P[H],r?(z.copy(v.normals[0]).multiplyScalar(L.x),D.copy(v.binormals[0]).multiplyScalar(L.y),C.copy(n[0]).add(z).add(D),f(C.x,C.y,C.z)):f(L.x,L.y,0);for(A=1;A<=t;A++)for(H=0;H<fa;H++)L=m?c(P[H],ua[H],w):P[H],r?(z.copy(v.normals[A]).multiplyScalar(L.x),D.copy(v.binormals[A]).multiplyScalar(L.y),C.copy(n[A]).add(z).add(D),f(C.x,C.y,C.z)):f(L.x,L.y,g/t*A);for(B=l-1;0<=B;B--){A=B/l;R=i*(1-A);w=k*Math.sin(A*Math.PI/2);H=0;for(T=
q.length;H<T;H++)L=c(q[H],oa[H],w),f(L.x,L.y,g+R);y=0;for(M=p.length;y<M;y++){A=p[y];W=I[y];H=0;for(T=A.length;H<T;H++)L=c(A[H],W[H],w),r?f(L.x,L.y+n[t-1].y,n[t-1].x+R):f(L.x,L.y,g+R)}}if(m){i=0*fa;for(H=0;H<ia;H++)g=F[H],h(g[2]+i,g[1]+i,g[0]+i,!0);i=fa*(t+2*l);for(H=0;H<ia;H++)g=F[H],h(g[0]+i,g[1]+i,g[2]+i,!1)}else{for(H=0;H<ia;H++)g=F[H],h(g[2],g[1],g[0],!0);for(H=0;H<ia;H++)g=F[H],h(g[0]+fa*t,g[1]+fa*t,g[2]+fa*t,!1)}g=0;e(q,g);g+=q.length;y=0;for(M=p.length;y<M;y++)A=p[y],e(A,g),g+=A.length};
THREE.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(a,b,c,d,e,f){b=a.vertices[e].x;e=a.vertices[e].y;c=a.vertices[f].x;f=a.vertices[f].y;return[new THREE.Vector2(a.vertices[d].x,a.vertices[d].y),new THREE.Vector2(b,e),new THREE.Vector2(c,f)]},generateBottomUV:function(a,b,c,d,e,f){return this.generateTopUV(a,b,c,d,e,f)},generateSideWallUV:function(a,b,c,d,e,f,h,g){var b=a.vertices[e].x,c=a.vertices[e].y,e=a.vertices[e].z,d=a.vertices[f].x,i=a.vertices[f].y,f=a.vertices[f].z,k=a.vertices[h].x,
l=a.vertices[h].y,h=a.vertices[h].z,m=a.vertices[g].x,p=a.vertices[g].y,a=a.vertices[g].z;return 0.01>Math.abs(c-i)?[new THREE.Vector2(b,1-e),new THREE.Vector2(d,1-f),new THREE.Vector2(k,1-h),new THREE.Vector2(m,1-a)]:[new THREE.Vector2(c,1-e),new THREE.Vector2(i,1-f),new THREE.Vector2(l,1-h),new THREE.Vector2(p,1-a)]}};THREE.ExtrudeGeometry.__v1=new THREE.Vector2;THREE.ExtrudeGeometry.__v2=new THREE.Vector2;THREE.ExtrudeGeometry.__v3=new THREE.Vector2;THREE.ExtrudeGeometry.__v4=new THREE.Vector2;
THREE.ExtrudeGeometry.__v5=new THREE.Vector2;THREE.ExtrudeGeometry.__v6=new THREE.Vector2;THREE.ShapeGeometry=function(a,b){THREE.Geometry.call(this);!1===a instanceof Array&&(a=[a]);this.shapebb=a[a.length-1].getBoundingBox();this.addShapeList(a,b);this.computeCentroids();this.computeFaceNormals()};THREE.ShapeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ShapeGeometry.prototype.addShapeList=function(a,b){for(var c=0,d=a.length;c<d;c++)this.addShape(a[c],b);return this};
THREE.ShapeGeometry.prototype.addShape=function(a,b){void 0===b&&(b={});var c=b.material,d=void 0===b.UVGenerator?THREE.ExtrudeGeometry.WorldUVGenerator:b.UVGenerator,e,f,h,g=this.vertices.length;e=a.extractPoints(void 0!==b.curveSegments?b.curveSegments:12);var i=e.shape,k=e.holes;if(!THREE.Shape.Utils.isClockWise(i)){i=i.reverse();e=0;for(f=k.length;e<f;e++)h=k[e],THREE.Shape.Utils.isClockWise(h)&&(k[e]=h.reverse())}var l=THREE.Shape.Utils.triangulateShape(i,k);e=0;for(f=k.length;e<f;e++)h=k[e],
i=i.concat(h);k=i.length;f=l.length;for(e=0;e<k;e++)h=i[e],this.vertices.push(new THREE.Vector3(h.x,h.y,0));for(e=0;e<f;e++)k=l[e],i=k[0]+g,h=k[1]+g,k=k[2]+g,this.faces.push(new THREE.Face3(i,h,k,null,null,c)),this.faceVertexUvs[0].push(d.generateBottomUV(this,a,b,i,h,k))};THREE.LatheGeometry=function(a,b,c,d){THREE.Geometry.call(this);for(var b=b||12,c=c||0,d=d||2*Math.PI,e=1/(a.length-1),f=1/b,h=0,g=b;h<=g;h++)for(var i=c+h*f*d,k=Math.cos(i),l=Math.sin(i),i=0,m=a.length;i<m;i++){var p=a[i],t=new THREE.Vector3;t.x=k*p.x-l*p.y;t.y=l*p.x+k*p.y;t.z=p.z;this.vertices.push(t)}c=a.length;h=0;for(g=b;h<g;h++){i=0;for(m=a.length-1;i<m;i++){var b=l=i+c*h,d=l+c,k=l+1+c,l=l+1,p=h*f,t=i*e,q=p+f,n=t+e;this.faces.push(new THREE.Face3(b,d,l));this.faceVertexUvs[0].push([new THREE.Vector2(p,
t),new THREE.Vector2(q,t),new THREE.Vector2(p,n)]);this.faces.push(new THREE.Face3(d,k,l));this.faceVertexUvs[0].push([new THREE.Vector2(q,t),new THREE.Vector2(q,n),new THREE.Vector2(p,n)])}}this.mergeVertices();this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.LatheGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.PlaneGeometry=function(a,b,c,d){THREE.Geometry.call(this);this.width=a;this.height=b;this.widthSegments=c||1;this.heightSegments=d||1;for(var e=a/2,f=b/2,c=this.widthSegments,d=this.heightSegments,h=c+1,g=d+1,i=this.width/c,k=this.height/d,l=new THREE.Vector3(0,0,1),a=0;a<g;a++)for(b=0;b<h;b++)this.vertices.push(new THREE.Vector3(b*i-e,-(a*k-f),0));for(a=0;a<d;a++)for(b=0;b<c;b++){var m=b+h*a,e=b+h*(a+1),f=b+1+h*(a+1),g=b+1+h*a,i=new THREE.Vector2(b/c,1-a/d),k=new THREE.Vector2(b/c,1-(a+1)/
d),p=new THREE.Vector2((b+1)/c,1-(a+1)/d),t=new THREE.Vector2((b+1)/c,1-a/d),m=new THREE.Face3(m,e,g);m.normal.copy(l);m.vertexNormals.push(l.clone(),l.clone(),l.clone());this.faces.push(m);this.faceVertexUvs[0].push([i,k,t]);m=new THREE.Face3(e,f,g);m.normal.copy(l);m.vertexNormals.push(l.clone(),l.clone(),l.clone());this.faces.push(m);this.faceVertexUvs[0].push([k.clone(),p,t.clone()])}this.computeCentroids()};THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.RingGeometry=function(a,b,c,d,e,f){THREE.Geometry.call(this);for(var a=a||0,b=b||50,e=void 0!==e?e:0,f=void 0!==f?f:2*Math.PI,c=void 0!==c?Math.max(3,c):8,d=void 0!==d?Math.max(3,d):8,h=[],g=a,i=(b-a)/d,a=0;a<=d;a++){for(b=0;b<=c;b++){var k=new THREE.Vector3,l=e+b/c*f;k.x=g*Math.cos(l);k.y=g*Math.sin(l);this.vertices.push(k);h.push(new THREE.Vector2((k.x/g+1)/2,-(k.y/g+1)/2+1))}g+=i}e=new THREE.Vector3(0,0,1);for(a=0;a<d;a++){f=a*c;for(b=0;b<=c;b++){var l=b+f,i=l+a,k=l+c+a,m=l+c+1+a;this.faces.push(new THREE.Face3(i,
k,m,[e,e,e]));this.faceVertexUvs[0].push([h[i],h[k],h[m]]);i=l+a;k=l+c+1+a;m=l+1+a;this.faces.push(new THREE.Face3(i,k,m,[e,e,e]));this.faceVertexUvs[0].push([h[i],h[k],h[m]])}}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,g)};THREE.RingGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.SphereGeometry=function(a,b,c,d,e,f,h){THREE.Geometry.call(this);this.radius=a=a||50;this.widthSegments=b=Math.max(3,Math.floor(b)||8);this.heightSegments=c=Math.max(2,Math.floor(c)||6);this.phiStart=d=void 0!==d?d:0;this.phiLength=e=void 0!==e?e:2*Math.PI;this.thetaStart=f=void 0!==f?f:0;this.thetaLength=h=void 0!==h?h:Math.PI;var g,i,k=[],l=[];for(i=0;i<=c;i++){var m=[],p=[];for(g=0;g<=b;g++){var t=g/b,q=i/c,n=new THREE.Vector3;n.x=-a*Math.cos(d+t*e)*Math.sin(f+q*h);n.y=a*Math.cos(f+q*h);
n.z=a*Math.sin(d+t*e)*Math.sin(f+q*h);this.vertices.push(n);m.push(this.vertices.length-1);p.push(new THREE.Vector2(t,1-q))}k.push(m);l.push(p)}for(i=0;i<this.heightSegments;i++)for(g=0;g<this.widthSegments;g++){var b=k[i][g+1],c=k[i][g],d=k[i+1][g],e=k[i+1][g+1],f=this.vertices[b].clone().normalize(),h=this.vertices[c].clone().normalize(),m=this.vertices[d].clone().normalize(),p=this.vertices[e].clone().normalize(),t=l[i][g+1].clone(),q=l[i][g].clone(),n=l[i+1][g].clone(),r=l[i+1][g+1].clone();Math.abs(this.vertices[b].y)===
this.radius?(this.faces.push(new THREE.Face3(b,d,e,[f,m,p])),this.faceVertexUvs[0].push([t,n,r])):Math.abs(this.vertices[d].y)===this.radius?(this.faces.push(new THREE.Face3(b,c,d,[f,h,m])),this.faceVertexUvs[0].push([t,q,n])):(this.faces.push(new THREE.Face3(b,c,e,[f,h,p])),this.faceVertexUvs[0].push([t,q,r]),this.faces.push(new THREE.Face3(c,d,e,[h,m,p])),this.faceVertexUvs[0].push([q.clone(),n,r.clone()]))}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,
a)};THREE.SphereGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TextGeometry=function(a,b){var b=b||{},c=THREE.FontUtils.generateShapes(a,b);b.amount=void 0!==b.height?b.height:50;void 0===b.bevelThickness&&(b.bevelThickness=10);void 0===b.bevelSize&&(b.bevelSize=8);void 0===b.bevelEnabled&&(b.bevelEnabled=!1);THREE.ExtrudeGeometry.call(this,c,b)};THREE.TextGeometry.prototype=Object.create(THREE.ExtrudeGeometry.prototype);THREE.TorusGeometry=function(a,b,c,d,e){THREE.Geometry.call(this);this.radius=a||100;this.tube=b||40;this.radialSegments=c||8;this.tubularSegments=d||6;this.arc=e||2*Math.PI;e=new THREE.Vector3;a=[];b=[];for(c=0;c<=this.radialSegments;c++)for(d=0;d<=this.tubularSegments;d++){var f=d/this.tubularSegments*this.arc,h=2*c/this.radialSegments*Math.PI;e.x=this.radius*Math.cos(f);e.y=this.radius*Math.sin(f);var g=new THREE.Vector3;g.x=(this.radius+this.tube*Math.cos(h))*Math.cos(f);g.y=(this.radius+this.tube*
Math.cos(h))*Math.sin(f);g.z=this.tube*Math.sin(h);this.vertices.push(g);a.push(new THREE.Vector2(d/this.tubularSegments,c/this.radialSegments));b.push(g.clone().sub(e).normalize())}for(c=1;c<=this.radialSegments;c++)for(d=1;d<=this.tubularSegments;d++){var e=(this.tubularSegments+1)*c+d-1,f=(this.tubularSegments+1)*(c-1)+d-1,h=(this.tubularSegments+1)*(c-1)+d,g=(this.tubularSegments+1)*c+d,i=new THREE.Face3(e,f,g,[b[e],b[f],b[g]]);i.normal.add(b[e]);i.normal.add(b[f]);i.normal.add(b[g]);i.normal.normalize();
this.faces.push(i);this.faceVertexUvs[0].push([a[e].clone(),a[f].clone(),a[g].clone()]);i=new THREE.Face3(f,h,g,[b[f],b[h],b[g]]);i.normal.add(b[f]);i.normal.add(b[h]);i.normal.add(b[g]);i.normal.normalize();this.faces.push(i);this.faceVertexUvs[0].push([a[f].clone(),a[h].clone(),a[g].clone()])}this.computeCentroids()};THREE.TorusGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TorusKnotGeometry=function(a,b,c,d,e,f,h){function g(a,b,c,d,e){var f=Math.cos(a),g=Math.sin(a),a=b/c*a,b=Math.cos(a),f=0.5*(d*(2+b))*f,g=0.5*d*(2+b)*g,d=0.5*e*d*Math.sin(a);return new THREE.Vector3(f,g,d)}THREE.Geometry.call(this);this.radius=a||100;this.tube=b||40;this.radialSegments=c||64;this.tubularSegments=d||8;this.p=e||2;this.q=f||3;this.heightScale=h||1;this.grid=Array(this.radialSegments);c=new THREE.Vector3;d=new THREE.Vector3;e=new THREE.Vector3;for(a=0;a<this.radialSegments;++a){this.grid[a]=
Array(this.tubularSegments);b=2*(a/this.radialSegments)*this.p*Math.PI;f=g(b,this.q,this.p,this.radius,this.heightScale);b=g(b+0.01,this.q,this.p,this.radius,this.heightScale);c.subVectors(b,f);d.addVectors(b,f);e.crossVectors(c,d);d.crossVectors(e,c);e.normalize();d.normalize();for(b=0;b<this.tubularSegments;++b){var i=2*(b/this.tubularSegments)*Math.PI,h=-this.tube*Math.cos(i),i=this.tube*Math.sin(i),k=new THREE.Vector3;k.x=f.x+h*d.x+i*e.x;k.y=f.y+h*d.y+i*e.y;k.z=f.z+h*d.z+i*e.z;this.grid[a][b]=
this.vertices.push(k)-1}}for(a=0;a<this.radialSegments;++a)for(b=0;b<this.tubularSegments;++b){var e=(a+1)%this.radialSegments,f=(b+1)%this.tubularSegments,c=this.grid[a][b],d=this.grid[e][b],e=this.grid[e][f],f=this.grid[a][f],h=new THREE.Vector2(a/this.radialSegments,b/this.tubularSegments),i=new THREE.Vector2((a+1)/this.radialSegments,b/this.tubularSegments),k=new THREE.Vector2((a+1)/this.radialSegments,(b+1)/this.tubularSegments),l=new THREE.Vector2(a/this.radialSegments,(b+1)/this.tubularSegments);
this.faces.push(new THREE.Face3(c,d,f));this.faceVertexUvs[0].push([h,i,l]);this.faces.push(new THREE.Face3(d,e,f));this.faceVertexUvs[0].push([i.clone(),k,l.clone()])}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.TorusKnotGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TubeGeometry=function(a,b,c,d,e){THREE.Geometry.call(this);this.path=a;this.segments=b||64;this.radius=c||1;this.radialSegments=d||8;this.closed=e||!1;this.grid=[];var f,h,d=this.segments+1,g,i,k,e=new THREE.Vector3,l,m,b=new THREE.TubeGeometry.FrenetFrames(this.path,this.segments,this.closed);l=b.normals;m=b.binormals;this.tangents=b.tangents;this.normals=l;this.binormals=m;for(b=0;b<d;b++){this.grid[b]=[];c=b/(d-1);k=a.getPointAt(c);f=l[b];h=m[b];for(c=0;c<this.radialSegments;c++)g=2*(c/this.radialSegments)*
Math.PI,i=-this.radius*Math.cos(g),g=this.radius*Math.sin(g),e.copy(k),e.x+=i*f.x+g*h.x,e.y+=i*f.y+g*h.y,e.z+=i*f.z+g*h.z,this.grid[b][c]=this.vertices.push(new THREE.Vector3(e.x,e.y,e.z))-1}for(b=0;b<this.segments;b++)for(c=0;c<this.radialSegments;c++)e=this.closed?(b+1)%this.segments:b+1,l=(c+1)%this.radialSegments,a=this.grid[b][c],d=this.grid[e][c],e=this.grid[e][l],l=this.grid[b][l],m=new THREE.Vector2(b/this.segments,c/this.radialSegments),f=new THREE.Vector2((b+1)/this.segments,c/this.radialSegments),
h=new THREE.Vector2((b+1)/this.segments,(c+1)/this.radialSegments),i=new THREE.Vector2(b/this.segments,(c+1)/this.radialSegments),this.faces.push(new THREE.Face3(a,d,l)),this.faceVertexUvs[0].push([m,f,i]),this.faces.push(new THREE.Face3(d,e,l)),this.faceVertexUvs[0].push([f.clone(),h,i.clone()]);this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.TubeGeometry.prototype=Object.create(THREE.Geometry.prototype);
THREE.TubeGeometry.FrenetFrames=function(a,b,c){new THREE.Vector3;var d=new THREE.Vector3;new THREE.Vector3;var e=[],f=[],h=[],g=new THREE.Vector3,i=new THREE.Matrix4,b=b+1,k,l,m;this.tangents=e;this.normals=f;this.binormals=h;for(k=0;k<b;k++)l=k/(b-1),e[k]=a.getTangentAt(l),e[k].normalize();f[0]=new THREE.Vector3;h[0]=new THREE.Vector3;a=Number.MAX_VALUE;k=Math.abs(e[0].x);l=Math.abs(e[0].y);m=Math.abs(e[0].z);k<=a&&(a=k,d.set(1,0,0));l<=a&&(a=l,d.set(0,1,0));m<=a&&d.set(0,0,1);g.crossVectors(e[0],
d).normalize();f[0].crossVectors(e[0],g);h[0].crossVectors(e[0],f[0]);for(k=1;k<b;k++)f[k]=f[k-1].clone(),h[k]=h[k-1].clone(),g.crossVectors(e[k-1],e[k]),1E-4<g.length()&&(g.normalize(),d=Math.acos(THREE.Math.clamp(e[k-1].dot(e[k]),-1,1)),f[k].applyMatrix4(i.makeRotationAxis(g,d))),h[k].crossVectors(e[k],f[k]);if(c){d=Math.acos(THREE.Math.clamp(f[0].dot(f[b-1]),-1,1));d/=b-1;0<e[0].dot(g.crossVectors(f[0],f[b-1]))&&(d=-d);for(k=1;k<b;k++)f[k].applyMatrix4(i.makeRotationAxis(e[k],d*k)),h[k].crossVectors(e[k],
f[k])}};THREE.PolyhedronGeometry=function(a,b,c,d){function e(a){var b=a.normalize().clone();b.index=g.vertices.push(b)-1;var c=Math.atan2(a.z,-a.x)/2/Math.PI+0.5,a=Math.atan2(-a.y,Math.sqrt(a.x*a.x+a.z*a.z))/Math.PI+0.5;b.uv=new THREE.Vector2(c,1-a);return b}function f(a,b,c){var d=new THREE.Face3(a.index,b.index,c.index,[a.clone(),b.clone(),c.clone()]);d.centroid.add(a).add(b).add(c).divideScalar(3);g.faces.push(d);d=Math.atan2(d.centroid.z,-d.centroid.x);g.faceVertexUvs[0].push([h(a.uv,a,d),h(b.uv,b,d),
h(c.uv,c,d)])}function h(a,b,c){0>c&&1===a.x&&(a=new THREE.Vector2(a.x-1,a.y));0===b.x&&0===b.z&&(a=new THREE.Vector2(c/2/Math.PI+0.5,a.y));return a.clone()}THREE.Geometry.call(this);for(var c=c||1,d=d||0,g=this,i=0,k=a.length;i<k;i++)e(new THREE.Vector3(a[i][0],a[i][1],a[i][2]));for(var l=this.vertices,a=[],i=0,k=b.length;i<k;i++){var m=l[b[i][0]],p=l[b[i][1]],t=l[b[i][2]];a[i]=new THREE.Face3(m.index,p.index,t.index,[m.clone(),p.clone(),t.clone()])}i=0;for(k=a.length;i<k;i++){p=a[i];l=d;b=Math.pow(2,
l);Math.pow(4,l);for(var l=e(g.vertices[p.a]),m=e(g.vertices[p.b]),q=e(g.vertices[p.c]),p=[],t=0;t<=b;t++){p[t]=[];for(var n=e(l.clone().lerp(q,t/b)),r=e(m.clone().lerp(q,t/b)),s=b-t,u=0;u<=s;u++)p[t][u]=0==u&&t==b?n:e(n.clone().lerp(r,u/s))}for(t=0;t<b;t++)for(u=0;u<2*(b-t)-1;u++)l=Math.floor(u/2),0==u%2?f(p[t][l+1],p[t+1][l],p[t][l]):f(p[t][l+1],p[t+1][l+1],p[t+1][l])}i=0;for(k=this.faceVertexUvs[0].length;i<k;i++)d=this.faceVertexUvs[0][i],a=d[0].x,b=d[1].x,l=d[2].x,m=Math.max(a,Math.max(b,l)),
p=Math.min(a,Math.min(b,l)),0.9<m&&0.1>p&&(0.2>a&&(d[0].x+=1),0.2>b&&(d[1].x+=1),0.2>l&&(d[2].x+=1));i=0;for(k=this.vertices.length;i<k;i++)this.vertices[i].multiplyScalar(c);this.mergeVertices();this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,c)};THREE.PolyhedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.IcosahedronGeometry=function(a,b){this.radius=a;this.detail=b;var c=(1+Math.sqrt(5))/2;THREE.PolyhedronGeometry.call(this,[[-1,c,0],[1,c,0],[-1,-c,0],[1,-c,0],[0,-1,c],[0,1,c],[0,-1,-c],[0,1,-c],[c,0,-1],[c,0,1],[-c,0,-1],[-c,0,1]],[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],a,b)};THREE.IcosahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.OctahedronGeometry=function(a,b){THREE.PolyhedronGeometry.call(this,[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]],a,b)};THREE.OctahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TetrahedronGeometry=function(a,b){THREE.PolyhedronGeometry.call(this,[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]],[[2,1,0],[0,3,2],[1,3,0],[2,3,1]],a,b)};THREE.TetrahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ParametricGeometry=function(a,b,c){THREE.Geometry.call(this);var d=this.vertices,e=this.faces,f=this.faceVertexUvs[0],h,g,i,k,l=b+1;for(h=0;h<=c;h++){k=h/c;for(g=0;g<=b;g++)i=g/b,i=a(i,k),d.push(i)}var m,p,t,q;for(h=0;h<c;h++)for(g=0;g<b;g++)a=h*l+g,d=h*l+g+1,k=(h+1)*l+g+1,i=(h+1)*l+g,m=new THREE.Vector2(g/b,h/c),p=new THREE.Vector2((g+1)/b,h/c),t=new THREE.Vector2((g+1)/b,(h+1)/c),q=new THREE.Vector2(g/b,(h+1)/c),e.push(new THREE.Face3(a,d,i)),f.push([m,p,q]),e.push(new THREE.Face3(d,k,i)),
f.push([p.clone(),t,q.clone()]);this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.ParametricGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.AxisHelper=function(a){var a=a||1,b=new THREE.Geometry;b.vertices.push(new THREE.Vector3,new THREE.Vector3(a,0,0),new THREE.Vector3,new THREE.Vector3(0,a,0),new THREE.Vector3,new THREE.Vector3(0,0,a));b.colors.push(new THREE.Color(16711680),new THREE.Color(16755200),new THREE.Color(65280),new THREE.Color(11206400),new THREE.Color(255),new THREE.Color(43775));a=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});THREE.Line.call(this,b,a,THREE.LinePieces)};
THREE.AxisHelper.prototype=Object.create(THREE.Line.prototype);THREE.ArrowHelper=function(a,b,c,d){THREE.Object3D.call(this);void 0===d&&(d=16776960);void 0===c&&(c=1);this.position=b;b=new THREE.Geometry;b.vertices.push(new THREE.Vector3(0,0,0));b.vertices.push(new THREE.Vector3(0,1,0));this.line=new THREE.Line(b,new THREE.LineBasicMaterial({color:d}));this.line.matrixAutoUpdate=!1;this.add(this.line);b=new THREE.CylinderGeometry(0,0.05,0.25,5,1);b.applyMatrix((new THREE.Matrix4).makeTranslation(0,0.875,0));this.cone=new THREE.Mesh(b,new THREE.MeshBasicMaterial({color:d}));
this.cone.matrixAutoUpdate=!1;this.add(this.cone);this.setDirection(a);this.setLength(c)};THREE.ArrowHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.ArrowHelper.prototype.setDirection=function(){var a=new THREE.Vector3,b;return function(c){0.99999<c.y?this.quaternion.set(0,0,0,1):-0.99999>c.y?this.quaternion.set(1,0,0,0):(a.set(c.z,0,-c.x).normalize(),b=Math.acos(c.y),this.quaternion.setFromAxisAngle(a,b))}}();THREE.ArrowHelper.prototype.setLength=function(a){this.scale.set(a,a,a)};
THREE.ArrowHelper.prototype.setColor=function(a){this.line.material.color.setHex(a);this.cone.material.color.setHex(a)};THREE.BoxHelper=function(a){var b=[new THREE.Vector3(1,1,1),new THREE.Vector3(-1,1,1),new THREE.Vector3(-1,-1,1),new THREE.Vector3(1,-1,1),new THREE.Vector3(1,1,-1),new THREE.Vector3(-1,1,-1),new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,-1,-1)];this.vertices=b;var c=new THREE.Geometry;c.vertices.push(b[0],b[1],b[1],b[2],b[2],b[3],b[3],b[0],b[4],b[5],b[5],b[6],b[6],b[7],b[7],b[4],b[0],b[4],b[1],b[5],b[2],b[6],b[3],b[7]);THREE.Line.call(this,c,new THREE.LineBasicMaterial({color:16776960}),THREE.LinePieces);
void 0!==a&&this.update(a)};THREE.BoxHelper.prototype=Object.create(THREE.Line.prototype);
THREE.BoxHelper.prototype.update=function(a){var b=a.geometry;null===b.boundingBox&&b.computeBoundingBox();var c=b.boundingBox.min,b=b.boundingBox.max,d=this.vertices;d[0].set(b.x,b.y,b.z);d[1].set(c.x,b.y,b.z);d[2].set(c.x,c.y,b.z);d[3].set(b.x,c.y,b.z);d[4].set(b.x,b.y,c.z);d[5].set(c.x,b.y,c.z);d[6].set(c.x,c.y,c.z);d[7].set(b.x,c.y,c.z);this.geometry.computeBoundingSphere();this.geometry.verticesNeedUpdate=!0;this.matrixAutoUpdate=!1;this.matrixWorld=a.matrixWorld};THREE.BoundingBoxHelper=function(a,b){var c=b||8947848;this.object=a;this.box=new THREE.Box3;THREE.Mesh.call(this,new THREE.CubeGeometry(1,1,1),new THREE.MeshBasicMaterial({color:c,wireframe:!0}))};THREE.BoundingBoxHelper.prototype=Object.create(THREE.Mesh.prototype);THREE.BoundingBoxHelper.prototype.update=function(){this.box.setFromObject(this.object);this.box.size(this.scale);this.box.center(this.position)};THREE.CameraHelper=function(a){function b(a,b,d){c(a,d);c(b,d)}function c(a,b){d.vertices.push(new THREE.Vector3);d.colors.push(new THREE.Color(b));void 0===f[a]&&(f[a]=[]);f[a].push(d.vertices.length-1)}var d=new THREE.Geometry,e=new THREE.LineBasicMaterial({color:16777215,vertexColors:THREE.FaceColors}),f={};b("n1","n2",16755200);b("n2","n4",16755200);b("n4","n3",16755200);b("n3","n1",16755200);b("f1","f2",16755200);b("f2","f4",16755200);b("f4","f3",16755200);b("f3","f1",16755200);b("n1","f1",16755200);
b("n2","f2",16755200);b("n3","f3",16755200);b("n4","f4",16755200);b("p","n1",16711680);b("p","n2",16711680);b("p","n3",16711680);b("p","n4",16711680);b("u1","u2",43775);b("u2","u3",43775);b("u3","u1",43775);b("c","t",16777215);b("p","c",3355443);b("cn1","cn2",3355443);b("cn3","cn4",3355443);b("cf1","cf2",3355443);b("cf3","cf4",3355443);THREE.Line.call(this,d,e,THREE.LinePieces);this.camera=a;this.matrixWorld=a.matrixWorld;this.matrixAutoUpdate=!1;this.pointMap=f;this.update()};
THREE.CameraHelper.prototype=Object.create(THREE.Line.prototype);
THREE.CameraHelper.prototype.update=function(){var a=new THREE.Vector3,b=new THREE.Camera,c=new THREE.Projector;return function(){function d(d,h,g,i){a.set(h,g,i);c.unprojectVector(a,b);d=e.pointMap[d];if(void 0!==d){h=0;for(g=d.length;h<g;h++)e.geometry.vertices[d[h]].copy(a)}}var e=this;b.projectionMatrix.copy(this.camera.projectionMatrix);d("c",0,0,-1);d("t",0,0,1);d("n1",-1,-1,-1);d("n2",1,-1,-1);d("n3",-1,1,-1);d("n4",1,1,-1);d("f1",-1,-1,1);d("f2",1,-1,1);d("f3",-1,1,1);d("f4",1,1,1);d("u1",
0.7,1.1,-1);d("u2",-0.7,1.1,-1);d("u3",0,2,-1);d("cf1",-1,0,1);d("cf2",1,0,1);d("cf3",0,-1,1);d("cf4",0,1,1);d("cn1",-1,0,-1);d("cn2",1,0,-1);d("cn3",0,-1,-1);d("cn4",0,1,-1);this.geometry.verticesNeedUpdate=!0}}();THREE.DirectionalLightHelper=function(a,b){THREE.Object3D.call(this);this.light=a;this.light.updateMatrixWorld();this.matrixWorld=a.matrixWorld;this.matrixAutoUpdate=!1;var c=new THREE.PlaneGeometry(b,b),d=new THREE.MeshBasicMaterial({wireframe:!0,fog:!1});d.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightPlane=new THREE.Mesh(c,d);this.add(this.lightPlane);c=new THREE.Geometry;c.vertices.push(new THREE.Vector3);c.vertices.push(new THREE.Vector3);c.computeLineDistances();
d=new THREE.LineBasicMaterial({fog:!1});d.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.targetLine=new THREE.Line(c,d);this.add(this.targetLine);this.update()};THREE.DirectionalLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.DirectionalLightHelper.prototype.dispose=function(){this.lightPlane.geometry.dispose();this.lightPlane.material.dispose();this.targetLine.geometry.dispose();this.targetLine.material.dispose()};
THREE.DirectionalLightHelper.prototype.update=function(){var a=new THREE.Vector3;return function(){a.getPositionFromMatrix(this.light.matrixWorld).negate();this.lightPlane.lookAt(a);this.lightPlane.material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.targetLine.geometry.vertices[1].copy(a);this.targetLine.geometry.verticesNeedUpdate=!0;this.targetLine.material.color.copy(this.lightPlane.material.color)}}();THREE.FaceNormalsHelper=function(a,b,c,d){this.object=a;this.size=b||1;for(var a=c||16776960,d=d||1,b=new THREE.Geometry,c=0,e=this.object.geometry.faces.length;c<e;c++)b.vertices.push(new THREE.Vector3),b.vertices.push(new THREE.Vector3);THREE.Line.call(this,b,new THREE.LineBasicMaterial({color:a,linewidth:d}),THREE.LinePieces);this.matrixAutoUpdate=!1;this.normalMatrix=new THREE.Matrix3;this.update()};THREE.FaceNormalsHelper.prototype=Object.create(THREE.Line.prototype);
THREE.FaceNormalsHelper.prototype.update=function(){var a=new THREE.Vector3;return function(){this.object.updateMatrixWorld(!0);this.normalMatrix.getNormalMatrix(this.object.matrixWorld);for(var b=this.geometry.vertices,c=this.object.geometry.faces,d=this.object.matrixWorld,e=0,f=c.length;e<f;e++){var h=c[e];a.copy(h.normal).applyMatrix3(this.normalMatrix).normalize().multiplyScalar(this.size);var g=2*e;b[g].copy(h.centroid).applyMatrix4(d);b[g+1].addVectors(b[g],a)}this.geometry.verticesNeedUpdate=
!0;return this}}();THREE.GridHelper=function(a,b){var c=new THREE.Geometry,d=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});this.color1=new THREE.Color(4473924);this.color2=new THREE.Color(8947848);for(var e=-a;e<=a;e+=b){c.vertices.push(new THREE.Vector3(-a,0,e),new THREE.Vector3(a,0,e),new THREE.Vector3(e,0,-a),new THREE.Vector3(e,0,a));var f=0===e?this.color1:this.color2;c.colors.push(f,f,f,f)}THREE.Line.call(this,c,d,THREE.LinePieces)};THREE.GridHelper.prototype=Object.create(THREE.Line.prototype);
THREE.GridHelper.prototype.setColors=function(a,b){this.color1.set(a);this.color2.set(b);this.geometry.colorsNeedUpdate=!0};THREE.HemisphereLightHelper=function(a,b){THREE.Object3D.call(this);this.light=a;this.light.updateMatrixWorld();this.matrixWorld=a.matrixWorld;this.matrixAutoUpdate=!1;this.colors=[new THREE.Color,new THREE.Color];var c=new THREE.SphereGeometry(b,4,2);c.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));for(var d=0;8>d;d++)c.faces[d].color=this.colors[4>d?0:1];d=new THREE.MeshBasicMaterial({vertexColors:THREE.FaceColors,wireframe:!0});this.lightSphere=new THREE.Mesh(c,d);this.add(this.lightSphere);
this.update()};THREE.HemisphereLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.HemisphereLightHelper.prototype.dispose=function(){this.lightSphere.geometry.dispose();this.lightSphere.material.dispose()};
THREE.HemisphereLightHelper.prototype.update=function(){var a=new THREE.Vector3;return function(){this.colors[0].copy(this.light.color).multiplyScalar(this.light.intensity);this.colors[1].copy(this.light.groundColor).multiplyScalar(this.light.intensity);this.lightSphere.lookAt(a.getPositionFromMatrix(this.light.matrixWorld).negate());this.lightSphere.geometry.colorsNeedUpdate=!0}}();THREE.PointLightHelper=function(a,b){this.light=a;this.light.updateMatrixWorld();var c=new THREE.SphereGeometry(b,4,2),d=new THREE.MeshBasicMaterial({wireframe:!0,fog:!1});d.color.copy(this.light.color).multiplyScalar(this.light.intensity);THREE.Mesh.call(this,c,d);this.matrixWorld=this.light.matrixWorld;this.matrixAutoUpdate=!1};THREE.PointLightHelper.prototype=Object.create(THREE.Mesh.prototype);THREE.PointLightHelper.prototype.dispose=function(){this.geometry.dispose();this.material.dispose()};
THREE.PointLightHelper.prototype.update=function(){this.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)};THREE.SpotLightHelper=function(a){THREE.Object3D.call(this);this.light=a;this.light.updateMatrixWorld();this.matrixWorld=a.matrixWorld;this.matrixAutoUpdate=!1;a=new THREE.CylinderGeometry(0,1,1,8,1,!0);a.applyMatrix((new THREE.Matrix4).makeTranslation(0,-0.5,0));a.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));var b=new THREE.MeshBasicMaterial({wireframe:!0,fog:!1});this.cone=new THREE.Mesh(a,b);this.add(this.cone);this.update()};THREE.SpotLightHelper.prototype=Object.create(THREE.Object3D.prototype);
THREE.SpotLightHelper.prototype.dispose=function(){this.cone.geometry.dispose();this.cone.material.dispose()};THREE.SpotLightHelper.prototype.update=function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(){var c=this.light.distance?this.light.distance:1E4,d=c*Math.tan(this.light.angle);this.cone.scale.set(d,d,c);a.getPositionFromMatrix(this.light.matrixWorld);b.getPositionFromMatrix(this.light.target.matrixWorld);this.cone.lookAt(b.sub(a));this.cone.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)}}();THREE.VertexNormalsHelper=function(a,b,c,d){this.object=a;this.size=b||1;for(var b=c||16711680,d=d||1,c=new THREE.Geometry,a=a.geometry.faces,e=0,f=a.length;e<f;e++)for(var h=0,g=a[e].vertexNormals.length;h<g;h++)c.vertices.push(new THREE.Vector3),c.vertices.push(new THREE.Vector3);THREE.Line.call(this,c,new THREE.LineBasicMaterial({color:b,linewidth:d}),THREE.LinePieces);this.matrixAutoUpdate=!1;this.normalMatrix=new THREE.Matrix3;this.update()};THREE.VertexNormalsHelper.prototype=Object.create(THREE.Line.prototype);
THREE.VertexNormalsHelper.prototype.update=function(){var a=new THREE.Vector3;return function(){var b=["a","b","c","d"];this.object.updateMatrixWorld(!0);this.normalMatrix.getNormalMatrix(this.object.matrixWorld);for(var c=this.geometry.vertices,d=this.object.geometry.vertices,e=this.object.geometry.faces,f=this.object.matrixWorld,h=0,g=0,i=e.length;g<i;g++)for(var k=e[g],l=0,m=k.vertexNormals.length;l<m;l++){var p=k.vertexNormals[l];c[h].copy(d[k[b[l]]]).applyMatrix4(f);a.copy(p).applyMatrix3(this.normalMatrix).normalize().multiplyScalar(this.size);
a.add(c[h]);h+=1;c[h].copy(a);h+=1}this.geometry.verticesNeedUpdate=!0;return this}}();THREE.VertexTangentsHelper=function(a,b,c,d){this.object=a;this.size=b||1;for(var b=c||255,d=d||1,c=new THREE.Geometry,a=a.geometry.faces,e=0,f=a.length;e<f;e++)for(var h=0,g=a[e].vertexTangents.length;h<g;h++)c.vertices.push(new THREE.Vector3),c.vertices.push(new THREE.Vector3);THREE.Line.call(this,c,new THREE.LineBasicMaterial({color:b,linewidth:d}),THREE.LinePieces);this.matrixAutoUpdate=!1;this.update()};THREE.VertexTangentsHelper.prototype=Object.create(THREE.Line.prototype);
THREE.VertexTangentsHelper.prototype.update=function(){var a=new THREE.Vector3;return function(){var b=["a","b","c","d"];this.object.updateMatrixWorld(!0);for(var c=this.geometry.vertices,d=this.object.geometry.vertices,e=this.object.geometry.faces,f=this.object.matrixWorld,h=0,g=0,i=e.length;g<i;g++)for(var k=e[g],l=0,m=k.vertexTangents.length;l<m;l++){var p=k.vertexTangents[l];c[h].copy(d[k[b[l]]]).applyMatrix4(f);a.copy(p).transformDirection(f).multiplyScalar(this.size);a.add(c[h]);h+=1;c[h].copy(a);
h+=1}this.geometry.verticesNeedUpdate=!0;return this}}();THREE.WireframeHelper=function(a){for(var b=[0,0],c={},d=function(a,b){return a-b},e=["a","b","c","d"],f=new THREE.Geometry,h=a.geometry.vertices,g=a.geometry.faces,i=0,k=g.length;i<k;i++)for(var l=g[i],m=0;3>m;m++){b[0]=l[e[m]];b[1]=l[e[(m+1)%3]];b.sort(d);var p=b.toString();void 0===c[p]&&(f.vertices.push(h[b[0]]),f.vertices.push(h[b[1]]),c[p]=!0)}THREE.Line.call(this,f,new THREE.LineBasicMaterial({color:16777215}),THREE.LinePieces);this.matrixAutoUpdate=!1;this.matrixWorld=a.matrixWorld};
THREE.WireframeHelper.prototype=Object.create(THREE.Line.prototype);THREE.ImmediateRenderObject=function(){THREE.Object3D.call(this);this.render=function(){}};THREE.ImmediateRenderObject.prototype=Object.create(THREE.Object3D.prototype);THREE.LensFlare=function(a,b,c,d,e){THREE.Object3D.call(this);this.lensFlares=[];this.positionScreen=new THREE.Vector3;this.customUpdateCallback=void 0;void 0!==a&&this.add(a,b,c,d,e)};THREE.LensFlare.prototype=Object.create(THREE.Object3D.prototype);
THREE.LensFlare.prototype.add=function(a,b,c,d,e,f){void 0===b&&(b=-1);void 0===c&&(c=0);void 0===f&&(f=1);void 0===e&&(e=new THREE.Color(16777215));void 0===d&&(d=THREE.NormalBlending);c=Math.min(c,Math.max(0,c));this.lensFlares.push({texture:a,size:b,distance:c,x:0,y:0,z:0,scale:1,rotation:1,opacity:f,color:e,blending:d})};
THREE.LensFlare.prototype.updateLensFlares=function(){var a,b=this.lensFlares.length,c,d=2*-this.positionScreen.x,e=2*-this.positionScreen.y;for(a=0;a<b;a++)c=this.lensFlares[a],c.x=this.positionScreen.x+d*c.distance,c.y=this.positionScreen.y+e*c.distance,c.wantedRotation=0.25*c.x*Math.PI,c.rotation+=0.25*(c.wantedRotation-c.rotation)};THREE.MorphBlendMesh=function(a,b){THREE.Mesh.call(this,a,b);this.animationsMap={};this.animationsList=[];var c=this.geometry.morphTargets.length;this.createAnimation("__default",0,c-1,c/1);this.setAnimationWeight("__default",1)};THREE.MorphBlendMesh.prototype=Object.create(THREE.Mesh.prototype);
THREE.MorphBlendMesh.prototype.createAnimation=function(a,b,c,d){b={startFrame:b,endFrame:c,length:c-b+1,fps:d,duration:(c-b)/d,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[a]=b;this.animationsList.push(b)};
THREE.MorphBlendMesh.prototype.autoCreateAnimations=function(a){for(var b=/([a-z]+)(\d+)/,c,d={},e=this.geometry,f=0,h=e.morphTargets.length;f<h;f++){var g=e.morphTargets[f].name.match(b);if(g&&1<g.length){var i=g[1];d[i]||(d[i]={start:Infinity,end:-Infinity});g=d[i];f<g.start&&(g.start=f);f>g.end&&(g.end=f);c||(c=i)}}for(i in d)g=d[i],this.createAnimation(i,g.start,g.end,a);this.firstAnimation=c};
THREE.MorphBlendMesh.prototype.setAnimationDirectionForward=function(a){if(a=this.animationsMap[a])a.direction=1,a.directionBackwards=!1};THREE.MorphBlendMesh.prototype.setAnimationDirectionBackward=function(a){if(a=this.animationsMap[a])a.direction=-1,a.directionBackwards=!0};THREE.MorphBlendMesh.prototype.setAnimationFPS=function(a,b){var c=this.animationsMap[a];c&&(c.fps=b,c.duration=(c.end-c.start)/c.fps)};
THREE.MorphBlendMesh.prototype.setAnimationDuration=function(a,b){var c=this.animationsMap[a];c&&(c.duration=b,c.fps=(c.end-c.start)/c.duration)};THREE.MorphBlendMesh.prototype.setAnimationWeight=function(a,b){var c=this.animationsMap[a];c&&(c.weight=b)};THREE.MorphBlendMesh.prototype.setAnimationTime=function(a,b){var c=this.animationsMap[a];c&&(c.time=b)};THREE.MorphBlendMesh.prototype.getAnimationTime=function(a){var b=0;if(a=this.animationsMap[a])b=a.time;return b};
THREE.MorphBlendMesh.prototype.getAnimationDuration=function(a){var b=-1;if(a=this.animationsMap[a])b=a.duration;return b};THREE.MorphBlendMesh.prototype.playAnimation=function(a){var b=this.animationsMap[a];b?(b.time=0,b.active=!0):console.warn("animation["+a+"] undefined")};THREE.MorphBlendMesh.prototype.stopAnimation=function(a){if(a=this.animationsMap[a])a.active=!1};
THREE.MorphBlendMesh.prototype.update=function(a){for(var b=0,c=this.animationsList.length;b<c;b++){var d=this.animationsList[b];if(d.active){var e=d.duration/d.length;d.time+=d.direction*a;if(d.mirroredLoop){if(d.time>d.duration||0>d.time)d.direction*=-1,d.time>d.duration&&(d.time=d.duration,d.directionBackwards=!0),0>d.time&&(d.time=0,d.directionBackwards=!1)}else d.time%=d.duration,0>d.time&&(d.time+=d.duration);var f=d.startFrame+THREE.Math.clamp(Math.floor(d.time/e),0,d.length-1),h=d.weight;
f!==d.currentFrame&&(this.morphTargetInfluences[d.lastFrame]=0,this.morphTargetInfluences[d.currentFrame]=1*h,this.morphTargetInfluences[f]=0,d.lastFrame=d.currentFrame,d.currentFrame=f);e=d.time%e/e;d.directionBackwards&&(e=1-e);this.morphTargetInfluences[d.currentFrame]=e*h;this.morphTargetInfluences[d.lastFrame]=(1-e)*h}}};THREE.LensFlarePlugin=function(){function a(a,c){var d=b.createProgram(),e=b.createShader(b.FRAGMENT_SHADER),f=b.createShader(b.VERTEX_SHADER),g="precision "+c+" float;\n";b.shaderSource(e,g+a.fragmentShader);b.shaderSource(f,g+a.vertexShader);b.compileShader(e);b.compileShader(f);b.attachShader(d,e);b.attachShader(d,f);b.linkProgram(d);return d}var b,c,d,e,f,h,g,i,k,l,m,p,t;this.init=function(q){b=q.context;c=q;d=q.getPrecision();e=new Float32Array(16);f=new Uint16Array(6);q=0;e[q++]=-1;e[q++]=-1;
e[q++]=0;e[q++]=0;e[q++]=1;e[q++]=-1;e[q++]=1;e[q++]=0;e[q++]=1;e[q++]=1;e[q++]=1;e[q++]=1;e[q++]=-1;e[q++]=1;e[q++]=0;e[q++]=1;q=0;f[q++]=0;f[q++]=1;f[q++]=2;f[q++]=0;f[q++]=2;f[q++]=3;h=b.createBuffer();g=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,h);b.bufferData(b.ARRAY_BUFFER,e,b.STATIC_DRAW);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,g);b.bufferData(b.ELEMENT_ARRAY_BUFFER,f,b.STATIC_DRAW);i=b.createTexture();k=b.createTexture();b.bindTexture(b.TEXTURE_2D,i);b.texImage2D(b.TEXTURE_2D,0,b.RGB,16,16,
0,b.RGB,b.UNSIGNED_BYTE,null);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.bindTexture(b.TEXTURE_2D,k);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,16,16,0,b.RGBA,b.UNSIGNED_BYTE,null);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);
b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);0>=b.getParameter(b.MAX_VERTEX_TEXTURE_IMAGE_UNITS)?(l=!1,m=a(THREE.ShaderFlares.lensFlare,d)):(l=!0,m=a(THREE.ShaderFlares.lensFlareVertexTexture,d));p={};t={};p.vertex=b.getAttribLocation(m,"position");p.uv=b.getAttribLocation(m,"uv");t.renderType=b.getUniformLocation(m,"renderType");t.map=b.getUniformLocation(m,"map");t.occlusionMap=b.getUniformLocation(m,"occlusionMap");t.opacity=
b.getUniformLocation(m,"opacity");t.color=b.getUniformLocation(m,"color");t.scale=b.getUniformLocation(m,"scale");t.rotation=b.getUniformLocation(m,"rotation");t.screenPosition=b.getUniformLocation(m,"screenPosition")};this.render=function(a,d,e,f){var a=a.__webglFlares,u=a.length;if(u){var x=new THREE.Vector3,v=f/e,D=0.5*e,z=0.5*f,C=16/f,A=new THREE.Vector2(C*v,C),y=new THREE.Vector3(1,1,0),M=new THREE.Vector2(1,1),E=t,C=p;b.useProgram(m);b.enableVertexAttribArray(p.vertex);b.enableVertexAttribArray(p.uv);
b.uniform1i(E.occlusionMap,0);b.uniform1i(E.map,1);b.bindBuffer(b.ARRAY_BUFFER,h);b.vertexAttribPointer(C.vertex,2,b.FLOAT,!1,16,0);b.vertexAttribPointer(C.uv,2,b.FLOAT,!1,16,8);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,g);b.disable(b.CULL_FACE);b.depthMask(!1);var J,P,F,B,w;for(J=0;J<u;J++)if(C=16/f,A.set(C*v,C),B=a[J],x.set(B.matrixWorld.elements[12],B.matrixWorld.elements[13],B.matrixWorld.elements[14]),x.applyMatrix4(d.matrixWorldInverse),x.applyProjection(d.projectionMatrix),y.copy(x),M.x=y.x*D+D,
M.y=y.y*z+z,l||0<M.x&&M.x<e&&0<M.y&&M.y<f){b.activeTexture(b.TEXTURE1);b.bindTexture(b.TEXTURE_2D,i);b.copyTexImage2D(b.TEXTURE_2D,0,b.RGB,M.x-8,M.y-8,16,16,0);b.uniform1i(E.renderType,0);b.uniform2f(E.scale,A.x,A.y);b.uniform3f(E.screenPosition,y.x,y.y,y.z);b.disable(b.BLEND);b.enable(b.DEPTH_TEST);b.drawElements(b.TRIANGLES,6,b.UNSIGNED_SHORT,0);b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,k);b.copyTexImage2D(b.TEXTURE_2D,0,b.RGBA,M.x-8,M.y-8,16,16,0);b.uniform1i(E.renderType,1);b.disable(b.DEPTH_TEST);
b.activeTexture(b.TEXTURE1);b.bindTexture(b.TEXTURE_2D,i);b.drawElements(b.TRIANGLES,6,b.UNSIGNED_SHORT,0);B.positionScreen.copy(y);B.customUpdateCallback?B.customUpdateCallback(B):B.updateLensFlares();b.uniform1i(E.renderType,2);b.enable(b.BLEND);P=0;for(F=B.lensFlares.length;P<F;P++)w=B.lensFlares[P],0.001<w.opacity&&0.001<w.scale&&(y.x=w.x,y.y=w.y,y.z=w.z,C=w.size*w.scale/f,A.x=C*v,A.y=C,b.uniform3f(E.screenPosition,y.x,y.y,y.z),b.uniform2f(E.scale,A.x,A.y),b.uniform1f(E.rotation,w.rotation),b.uniform1f(E.opacity,
w.opacity),b.uniform3f(E.color,w.color.r,w.color.g,w.color.b),c.setBlending(w.blending,w.blendEquation,w.blendSrc,w.blendDst),c.setTexture(w.texture,1),b.drawElements(b.TRIANGLES,6,b.UNSIGNED_SHORT,0))}b.enable(b.CULL_FACE);b.enable(b.DEPTH_TEST);b.depthMask(!0)}}};THREE.ShadowMapPlugin=function(){var a,b,c,d,e,f,h=new THREE.Frustum,g=new THREE.Matrix4,i=new THREE.Vector3,k=new THREE.Vector3,l=new THREE.Vector3;this.init=function(g){a=g.context;b=g;var g=THREE.ShaderLib.depthRGBA,h=THREE.UniformsUtils.clone(g.uniforms);c=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h});d=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,morphTargets:!0});e=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,
vertexShader:g.vertexShader,uniforms:h,skinning:!0});f=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,morphTargets:!0,skinning:!0});c._shadowPass=!0;d._shadowPass=!0;e._shadowPass=!0;f._shadowPass=!0};this.render=function(a,c){b.shadowMapEnabled&&b.shadowMapAutoUpdate&&this.update(a,c)};this.update=function(m,p){var t,q,n,r,s,u,x,v,D,z=[];r=0;a.clearColor(1,1,1,1);a.disable(a.BLEND);a.enable(a.CULL_FACE);a.frontFace(a.CCW);b.shadowMapCullFace===THREE.CullFaceFront?
a.cullFace(a.FRONT):a.cullFace(a.BACK);b.setDepthTest(!0);t=0;for(q=m.__lights.length;t<q;t++)if(n=m.__lights[t],n.castShadow)if(n instanceof THREE.DirectionalLight&&n.shadowCascade)for(s=0;s<n.shadowCascadeCount;s++){var C;if(n.shadowCascadeArray[s])C=n.shadowCascadeArray[s];else{D=n;x=s;C=new THREE.DirectionalLight;C.isVirtual=!0;C.onlyShadow=!0;C.castShadow=!0;C.shadowCameraNear=D.shadowCameraNear;C.shadowCameraFar=D.shadowCameraFar;C.shadowCameraLeft=D.shadowCameraLeft;C.shadowCameraRight=D.shadowCameraRight;
C.shadowCameraBottom=D.shadowCameraBottom;C.shadowCameraTop=D.shadowCameraTop;C.shadowCameraVisible=D.shadowCameraVisible;C.shadowDarkness=D.shadowDarkness;C.shadowBias=D.shadowCascadeBias[x];C.shadowMapWidth=D.shadowCascadeWidth[x];C.shadowMapHeight=D.shadowCascadeHeight[x];C.pointsWorld=[];C.pointsFrustum=[];v=C.pointsWorld;u=C.pointsFrustum;for(var A=0;8>A;A++)v[A]=new THREE.Vector3,u[A]=new THREE.Vector3;v=D.shadowCascadeNearZ[x];D=D.shadowCascadeFarZ[x];u[0].set(-1,-1,v);u[1].set(1,-1,v);u[2].set(-1,
1,v);u[3].set(1,1,v);u[4].set(-1,-1,D);u[5].set(1,-1,D);u[6].set(-1,1,D);u[7].set(1,1,D);C.originalCamera=p;u=new THREE.Gyroscope;u.position=n.shadowCascadeOffset;u.add(C);u.add(C.target);p.add(u);n.shadowCascadeArray[s]=C;console.log("Created virtualLight",C)}x=n;v=s;D=x.shadowCascadeArray[v];D.position.copy(x.position);D.target.position.copy(x.target.position);D.lookAt(D.target);D.shadowCameraVisible=x.shadowCameraVisible;D.shadowDarkness=x.shadowDarkness;D.shadowBias=x.shadowCascadeBias[v];u=x.shadowCascadeNearZ[v];
x=x.shadowCascadeFarZ[v];D=D.pointsFrustum;D[0].z=u;D[1].z=u;D[2].z=u;D[3].z=u;D[4].z=x;D[5].z=x;D[6].z=x;D[7].z=x;z[r]=C;r++}else z[r]=n,r++;t=0;for(q=z.length;t<q;t++){n=z[t];n.shadowMap||(s=THREE.LinearFilter,b.shadowMapType===THREE.PCFSoftShadowMap&&(s=THREE.NearestFilter),n.shadowMap=new THREE.WebGLRenderTarget(n.shadowMapWidth,n.shadowMapHeight,{minFilter:s,magFilter:s,format:THREE.RGBAFormat}),n.shadowMapSize=new THREE.Vector2(n.shadowMapWidth,n.shadowMapHeight),n.shadowMatrix=new THREE.Matrix4);
if(!n.shadowCamera){if(n instanceof THREE.SpotLight)n.shadowCamera=new THREE.PerspectiveCamera(n.shadowCameraFov,n.shadowMapWidth/n.shadowMapHeight,n.shadowCameraNear,n.shadowCameraFar);else if(n instanceof THREE.DirectionalLight)n.shadowCamera=new THREE.OrthographicCamera(n.shadowCameraLeft,n.shadowCameraRight,n.shadowCameraTop,n.shadowCameraBottom,n.shadowCameraNear,n.shadowCameraFar);else{console.error("Unsupported light type for shadow");continue}m.add(n.shadowCamera);!0===m.autoUpdate&&m.updateMatrixWorld()}n.shadowCameraVisible&&
!n.cameraHelper&&(n.cameraHelper=new THREE.CameraHelper(n.shadowCamera),n.shadowCamera.add(n.cameraHelper));if(n.isVirtual&&C.originalCamera==p){s=p;r=n.shadowCamera;u=n.pointsFrustum;D=n.pointsWorld;i.set(Infinity,Infinity,Infinity);k.set(-Infinity,-Infinity,-Infinity);for(x=0;8>x;x++)v=D[x],v.copy(u[x]),THREE.ShadowMapPlugin.__projector.unprojectVector(v,s),v.applyMatrix4(r.matrixWorldInverse),v.x<i.x&&(i.x=v.x),v.x>k.x&&(k.x=v.x),v.y<i.y&&(i.y=v.y),v.y>k.y&&(k.y=v.y),v.z<i.z&&(i.z=v.z),v.z>k.z&&
(k.z=v.z);r.left=i.x;r.right=k.x;r.top=k.y;r.bottom=i.y;r.updateProjectionMatrix()}r=n.shadowMap;u=n.shadowMatrix;s=n.shadowCamera;s.position.getPositionFromMatrix(n.matrixWorld);l.getPositionFromMatrix(n.target.matrixWorld);s.lookAt(l);s.updateMatrixWorld();s.matrixWorldInverse.getInverse(s.matrixWorld);n.cameraHelper&&(n.cameraHelper.visible=n.shadowCameraVisible);n.shadowCameraVisible&&n.cameraHelper.update();u.set(0.5,0,0,0.5,0,0.5,0,0.5,0,0,0.5,0.5,0,0,0,1);u.multiply(s.projectionMatrix);u.multiply(s.matrixWorldInverse);
g.multiplyMatrices(s.projectionMatrix,s.matrixWorldInverse);h.setFromMatrix(g);b.setRenderTarget(r);b.clear();D=m.__webglObjects;n=0;for(r=D.length;n<r;n++)if(x=D[n],u=x.object,x.render=!1,u.visible&&u.castShadow&&(!(u instanceof THREE.Mesh||u instanceof THREE.ParticleSystem)||!u.frustumCulled||h.intersectsObject(u)))u._modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,u.matrixWorld),x.render=!0;n=0;for(r=D.length;n<r;n++)x=D[n],x.render&&(u=x.object,x=x.buffer,A=u.material instanceof THREE.MeshFaceMaterial?
u.material.materials[0]:u.material,v=0<u.geometry.morphTargets.length&&A.morphTargets,A=u instanceof THREE.SkinnedMesh&&A.skinning,v=u.customDepthMaterial?u.customDepthMaterial:A?v?f:e:v?d:c,x instanceof THREE.BufferGeometry?b.renderBufferDirect(s,m.__lights,null,v,x,u):b.renderBuffer(s,m.__lights,null,v,x,u));D=m.__webglObjectsImmediate;n=0;for(r=D.length;n<r;n++)x=D[n],u=x.object,u.visible&&u.castShadow&&(u._modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,u.matrixWorld),b.renderImmediateObject(s,
m.__lights,null,c,u))}t=b.getClearColor();q=b.getClearAlpha();a.clearColor(t.r,t.g,t.b,q);a.enable(a.BLEND);b.shadowMapCullFace===THREE.CullFaceFront&&a.cullFace(a.BACK)}};THREE.ShadowMapPlugin.__projector=new THREE.Projector;THREE.SpritePlugin=function(){function a(a,b){return a.z!==b.z?b.z-a.z:b.id-a.id}var b,c,d,e,f,h,g,i,k,l;this.init=function(a){b=a.context;c=a;d=a.getPrecision();e=new Float32Array(16);f=new Uint16Array(6);a=0;e[a++]=-1;e[a++]=-1;e[a++]=0;e[a++]=0;e[a++]=1;e[a++]=-1;e[a++]=1;e[a++]=0;e[a++]=1;e[a++]=1;e[a++]=1;e[a++]=1;e[a++]=-1;e[a++]=1;e[a++]=0;e[a++]=1;a=0;f[a++]=0;f[a++]=1;f[a++]=2;f[a++]=0;f[a++]=2;f[a++]=3;h=b.createBuffer();g=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,h);b.bufferData(b.ARRAY_BUFFER,
e,b.STATIC_DRAW);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,g);b.bufferData(b.ELEMENT_ARRAY_BUFFER,f,b.STATIC_DRAW);var a=THREE.ShaderSprite.sprite,p=b.createProgram(),t=b.createShader(b.FRAGMENT_SHADER),q=b.createShader(b.VERTEX_SHADER),n="precision "+d+" float;\n";b.shaderSource(t,n+a.fragmentShader);b.shaderSource(q,n+a.vertexShader);b.compileShader(t);b.compileShader(q);b.attachShader(p,t);b.attachShader(p,q);b.linkProgram(p);i=p;k={};l={};k.position=b.getAttribLocation(i,"position");k.uv=b.getAttribLocation(i,
"uv");l.uvOffset=b.getUniformLocation(i,"uvOffset");l.uvScale=b.getUniformLocation(i,"uvScale");l.rotation=b.getUniformLocation(i,"rotation");l.scale=b.getUniformLocation(i,"scale");l.alignment=b.getUniformLocation(i,"alignment");l.color=b.getUniformLocation(i,"color");l.map=b.getUniformLocation(i,"map");l.opacity=b.getUniformLocation(i,"opacity");l.useScreenCoordinates=b.getUniformLocation(i,"useScreenCoordinates");l.sizeAttenuation=b.getUniformLocation(i,"sizeAttenuation");l.screenPosition=b.getUniformLocation(i,
"screenPosition");l.modelViewMatrix=b.getUniformLocation(i,"modelViewMatrix");l.projectionMatrix=b.getUniformLocation(i,"projectionMatrix");l.fogType=b.getUniformLocation(i,"fogType");l.fogDensity=b.getUniformLocation(i,"fogDensity");l.fogNear=b.getUniformLocation(i,"fogNear");l.fogFar=b.getUniformLocation(i,"fogFar");l.fogColor=b.getUniformLocation(i,"fogColor");l.alphaTest=b.getUniformLocation(i,"alphaTest")};this.render=function(d,e,f,q){var n=d.__webglSprites,r=n.length;if(r){var s=k,u=l,x=q/
f,f=0.5*f,v=0.5*q;b.useProgram(i);b.enableVertexAttribArray(s.position);b.enableVertexAttribArray(s.uv);b.disable(b.CULL_FACE);b.enable(b.BLEND);b.bindBuffer(b.ARRAY_BUFFER,h);b.vertexAttribPointer(s.position,2,b.FLOAT,!1,16,0);b.vertexAttribPointer(s.uv,2,b.FLOAT,!1,16,8);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,g);b.uniformMatrix4fv(u.projectionMatrix,!1,e.projectionMatrix.elements);b.activeTexture(b.TEXTURE0);b.uniform1i(u.map,0);var D=s=0,z=d.fog;z?(b.uniform3f(u.fogColor,z.color.r,z.color.g,z.color.b),
z instanceof THREE.Fog?(b.uniform1f(u.fogNear,z.near),b.uniform1f(u.fogFar,z.far),b.uniform1i(u.fogType,1),D=s=1):z instanceof THREE.FogExp2&&(b.uniform1f(u.fogDensity,z.density),b.uniform1i(u.fogType,2),D=s=2)):(b.uniform1i(u.fogType,0),D=s=0);for(var C,A,y=[],z=0;z<r;z++)C=n[z],A=C.material,C.visible&&0!==A.opacity&&(A.useScreenCoordinates?C.z=-C.position.z:(C._modelViewMatrix.multiplyMatrices(e.matrixWorldInverse,C.matrixWorld),C.z=-C._modelViewMatrix.elements[14]));n.sort(a);for(z=0;z<r;z++)C=
n[z],A=C.material,C.visible&&0!==A.opacity&&(A.map&&A.map.image&&A.map.image.width)&&(b.uniform1f(u.alphaTest,A.alphaTest),!0===A.useScreenCoordinates?(b.uniform1i(u.useScreenCoordinates,1),b.uniform3f(u.screenPosition,(C.position.x*c.devicePixelRatio-f)/f,(v-C.position.y*c.devicePixelRatio)/v,Math.max(0,Math.min(1,C.position.z))),y[0]=c.devicePixelRatio,y[1]=c.devicePixelRatio):(b.uniform1i(u.useScreenCoordinates,0),b.uniform1i(u.sizeAttenuation,A.sizeAttenuation?1:0),b.uniformMatrix4fv(u.modelViewMatrix,
!1,C._modelViewMatrix.elements),y[0]=1,y[1]=1),e=d.fog&&A.fog?D:0,s!==e&&(b.uniform1i(u.fogType,e),s=e),e=1/(A.scaleByViewport?q:1),y[0]*=e*x*C.scale.x,y[1]*=e*C.scale.y,b.uniform2f(u.uvScale,A.uvScale.x,A.uvScale.y),b.uniform2f(u.uvOffset,A.uvOffset.x,A.uvOffset.y),b.uniform2f(u.alignment,A.alignment.x,A.alignment.y),b.uniform1f(u.opacity,A.opacity),b.uniform3f(u.color,A.color.r,A.color.g,A.color.b),b.uniform1f(u.rotation,C.rotation),b.uniform2fv(u.scale,y),c.setBlending(A.blending,A.blendEquation,
A.blendSrc,A.blendDst),c.setDepthTest(A.depthTest),c.setDepthWrite(A.depthWrite),c.setTexture(A.map,0),b.drawElements(b.TRIANGLES,6,b.UNSIGNED_SHORT,0));b.enable(b.CULL_FACE)}}};THREE.DepthPassPlugin=function(){this.enabled=!1;this.renderTarget=null;var a,b,c,d,e,f,h=new THREE.Frustum,g=new THREE.Matrix4;this.init=function(g){a=g.context;b=g;var g=THREE.ShaderLib.depthRGBA,h=THREE.UniformsUtils.clone(g.uniforms);c=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h});d=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,morphTargets:!0});e=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,
vertexShader:g.vertexShader,uniforms:h,skinning:!0});f=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,morphTargets:!0,skinning:!0});c._shadowPass=!0;d._shadowPass=!0;e._shadowPass=!0;f._shadowPass=!0};this.render=function(a,b){this.enabled&&this.update(a,b)};this.update=function(i,k){var l,m,p,t,q,n;a.clearColor(1,1,1,1);a.disable(a.BLEND);b.setDepthTest(!0);!0===i.autoUpdate&&i.updateMatrixWorld();k.matrixWorldInverse.getInverse(k.matrixWorld);g.multiplyMatrices(k.projectionMatrix,
k.matrixWorldInverse);h.setFromMatrix(g);b.setRenderTarget(this.renderTarget);b.clear();n=i.__webglObjects;l=0;for(m=n.length;l<m;l++)if(p=n[l],q=p.object,p.render=!1,q.visible&&(!(q instanceof THREE.Mesh||q instanceof THREE.ParticleSystem)||!q.frustumCulled||h.intersectsObject(q)))q._modelViewMatrix.multiplyMatrices(k.matrixWorldInverse,q.matrixWorld),p.render=!0;var r;l=0;for(m=n.length;l<m;l++)if(p=n[l],p.render&&(q=p.object,p=p.buffer,!(q instanceof THREE.ParticleSystem)||q.customDepthMaterial))(r=
q.material instanceof THREE.MeshFaceMaterial?q.material.materials[0]:q.material)&&b.setMaterialFaces(q.material),t=0<q.geometry.morphTargets.length&&r.morphTargets,r=q instanceof THREE.SkinnedMesh&&r.skinning,t=q.customDepthMaterial?q.customDepthMaterial:r?t?f:e:t?d:c,p instanceof THREE.BufferGeometry?b.renderBufferDirect(k,i.__lights,null,t,p,q):b.renderBuffer(k,i.__lights,null,t,p,q);n=i.__webglObjectsImmediate;l=0;for(m=n.length;l<m;l++)p=n[l],q=p.object,q.visible&&(q._modelViewMatrix.multiplyMatrices(k.matrixWorldInverse,
q.matrixWorld),b.renderImmediateObject(k,i.__lights,null,c,q));l=b.getClearColor();m=b.getClearAlpha();a.clearColor(l.r,l.g,l.b,m);a.enable(a.BLEND)}};THREE.ShaderFlares={lensFlareVertexTexture:{vertexShader:"uniform lowp int renderType;\nuniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nuniform sampler2D occlusionMap;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif( renderType == 2 ) {\nvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );\nvVisibility =        visibility.r / 9.0;\nvVisibility *= 1.0 - visibility.g / 9.0;\nvVisibility *=       visibility.b / 9.0;\nvVisibility *= 1.0 - visibility.a / 9.0;\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}",
fragmentShader:"uniform lowp int renderType;\nuniform sampler2D map;\nuniform float opacity;\nuniform vec3 color;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nif( renderType == 0 ) {\ngl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );\n} else if( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * vVisibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}"},lensFlare:{vertexShader:"uniform lowp int renderType;\nuniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif( renderType == 2 ) {\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}",
fragmentShader:"precision mediump float;\nuniform lowp int renderType;\nuniform sampler2D map;\nuniform sampler2D occlusionMap;\nuniform float opacity;\nuniform vec3 color;\nvarying vec2 vUV;\nvoid main() {\nif( renderType == 0 ) {\ngl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );\n} else if( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nfloat visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a;\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a;\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a;\nvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;\nvisibility = ( 1.0 - visibility / 4.0 );\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * visibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}"}};THREE.ShaderSprite={sprite:{vertexShader:"uniform int useScreenCoordinates;\nuniform int sizeAttenuation;\nuniform vec3 screenPosition;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform float rotation;\nuniform vec2 scale;\nuniform vec2 alignment;\nuniform vec2 uvOffset;\nuniform vec2 uvScale;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uvOffset + uv * uvScale;\nvec2 alignedPosition = position + alignment;\nvec2 rotatedPosition;\nrotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;\nrotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;\nvec4 finalPosition;\nif( useScreenCoordinates != 0 ) {\nfinalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );\n} else {\nfinalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\nfinalPosition.xy += rotatedPosition * ( sizeAttenuation == 1 ? 1.0 : finalPosition.z );\n}\ngl_Position = finalPosition;\n}",
fragmentShader:"uniform vec3 color;\nuniform sampler2D map;\nuniform float opacity;\nuniform int fogType;\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\nuniform float alphaTest;\nvarying vec2 vUV;\nvoid main() {\nvec4 texture = texture2D( map, vUV );\nif ( texture.a < alphaTest ) discard;\ngl_FragColor = vec4( color * texture.xyz, texture.a * opacity );\nif ( fogType > 0 ) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = 0.0;\nif ( fogType == 1 ) {\nfogFactor = smoothstep( fogNear, fogFar, depth );\n} else {\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\n}\ngl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n}\n}"}};

/**
 * dat-gui JavaScript Controller Library
 * http://code.google.com/p/dat-gui
 *
 * Copyright 2011 Data Arts Team, Google Creative Lab
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 */
var dat=dat||{};dat.gui=dat.gui||{};dat.utils=dat.utils||{};dat.controllers=dat.controllers||{};dat.dom=dat.dom||{};dat.color=dat.color||{};dat.utils.css=function(){return{load:function(e,a){var a=a||document,c=a.createElement("link");c.type="text/css";c.rel="stylesheet";c.href=e;a.getElementsByTagName("head")[0].appendChild(c)},inject:function(e,a){var a=a||document,c=document.createElement("style");c.type="text/css";c.innerHTML=e;a.getElementsByTagName("head")[0].appendChild(c)}}}();
dat.utils.common=function(){var e=Array.prototype.forEach,a=Array.prototype.slice;return{BREAK:{},extend:function(c){this.each(a.call(arguments,1),function(a){for(var f in a)this.isUndefined(a[f])||(c[f]=a[f])},this);return c},defaults:function(c){this.each(a.call(arguments,1),function(a){for(var f in a)this.isUndefined(c[f])&&(c[f]=a[f])},this);return c},compose:function(){var c=a.call(arguments);return function(){for(var d=a.call(arguments),f=c.length-1;f>=0;f--)d=[c[f].apply(this,d)];return d[0]}},
each:function(a,d,f){if(e&&a.forEach===e)a.forEach(d,f);else if(a.length===a.length+0)for(var b=0,n=a.length;b<n;b++){if(b in a&&d.call(f,a[b],b)===this.BREAK)break}else for(b in a)if(d.call(f,a[b],b)===this.BREAK)break},defer:function(a){setTimeout(a,0)},toArray:function(c){return c.toArray?c.toArray():a.call(c)},isUndefined:function(a){return a===void 0},isNull:function(a){return a===null},isNaN:function(a){return a!==a},isArray:Array.isArray||function(a){return a.constructor===Array},isObject:function(a){return a===
Object(a)},isNumber:function(a){return a===a+0},isString:function(a){return a===a+""},isBoolean:function(a){return a===false||a===true},isFunction:function(a){return Object.prototype.toString.call(a)==="[object Function]"}}}();
dat.controllers.Controller=function(e){var a=function(a,d){this.initialValue=a[d];this.domElement=document.createElement("div");this.object=a;this.property=d;this.__onFinishChange=this.__onChange=void 0};e.extend(a.prototype,{onChange:function(a){this.__onChange=a;return this},onFinishChange:function(a){this.__onFinishChange=a;return this},setValue:function(a){this.object[this.property]=a;this.__onChange&&this.__onChange.call(this,a);this.updateDisplay();return this},getValue:function(){return this.object[this.property]},
updateDisplay:function(){return this},isModified:function(){return this.initialValue!==this.getValue()}});return a}(dat.utils.common);
dat.dom.dom=function(e){function a(b){if(b==="0"||e.isUndefined(b))return 0;b=b.match(d);return!e.isNull(b)?parseFloat(b[1]):0}var c={};e.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},function(b,a){e.each(b,function(b){c[b]=a})});var d=/(\d+(\.\d+)?)px/,f={makeSelectable:function(b,a){if(!(b===void 0||b.style===void 0))b.onselectstart=a?function(){return false}:function(){},b.style.MozUserSelect=a?"auto":"none",b.style.KhtmlUserSelect=
a?"auto":"none",b.unselectable=a?"on":"off"},makeFullscreen:function(b,a,d){e.isUndefined(a)&&(a=true);e.isUndefined(d)&&(d=true);b.style.position="absolute";if(a)b.style.left=0,b.style.right=0;if(d)b.style.top=0,b.style.bottom=0},fakeEvent:function(b,a,d,f){var d=d||{},m=c[a];if(!m)throw Error("Event type "+a+" not supported.");var l=document.createEvent(m);switch(m){case "MouseEvents":l.initMouseEvent(a,d.bubbles||false,d.cancelable||true,window,d.clickCount||1,0,0,d.x||d.clientX||0,d.y||d.clientY||
0,false,false,false,false,0,null);break;case "KeyboardEvents":m=l.initKeyboardEvent||l.initKeyEvent;e.defaults(d,{cancelable:true,ctrlKey:false,altKey:false,shiftKey:false,metaKey:false,keyCode:void 0,charCode:void 0});m(a,d.bubbles||false,d.cancelable,window,d.ctrlKey,d.altKey,d.shiftKey,d.metaKey,d.keyCode,d.charCode);break;default:l.initEvent(a,d.bubbles||false,d.cancelable||true)}e.defaults(l,f);b.dispatchEvent(l)},bind:function(b,a,d,c){b.addEventListener?b.addEventListener(a,d,c||false):b.attachEvent&&
b.attachEvent("on"+a,d);return f},unbind:function(b,a,d,c){b.removeEventListener?b.removeEventListener(a,d,c||false):b.detachEvent&&b.detachEvent("on"+a,d);return f},addClass:function(b,a){if(b.className===void 0)b.className=a;else if(b.className!==a){var d=b.className.split(/ +/);if(d.indexOf(a)==-1)d.push(a),b.className=d.join(" ").replace(/^\s+/,"").replace(/\s+$/,"")}return f},removeClass:function(b,a){if(a){if(b.className!==void 0)if(b.className===a)b.removeAttribute("class");else{var d=b.className.split(/ +/),
c=d.indexOf(a);if(c!=-1)d.splice(c,1),b.className=d.join(" ")}}else b.className=void 0;return f},hasClass:function(a,d){return RegExp("(?:^|\\s+)"+d+"(?:\\s+|$)").test(a.className)||false},getWidth:function(b){b=getComputedStyle(b);return a(b["border-left-width"])+a(b["border-right-width"])+a(b["padding-left"])+a(b["padding-right"])+a(b.width)},getHeight:function(b){b=getComputedStyle(b);return a(b["border-top-width"])+a(b["border-bottom-width"])+a(b["padding-top"])+a(b["padding-bottom"])+a(b.height)},
getOffset:function(a){var d={left:0,top:0};if(a.offsetParent){do d.left+=a.offsetLeft,d.top+=a.offsetTop;while(a=a.offsetParent)}return d},isActive:function(a){return a===document.activeElement&&(a.type||a.href)}};return f}(dat.utils.common);
dat.controllers.OptionController=function(e,a,c){var d=function(f,b,e){d.superclass.call(this,f,b);var h=this;this.__select=document.createElement("select");if(c.isArray(e)){var j={};c.each(e,function(a){j[a]=a});e=j}c.each(e,function(a,b){var d=document.createElement("option");d.innerHTML=b;d.setAttribute("value",a);h.__select.appendChild(d)});this.updateDisplay();a.bind(this.__select,"change",function(){h.setValue(this.options[this.selectedIndex].value)});this.domElement.appendChild(this.__select)};
d.superclass=e;c.extend(d.prototype,e.prototype,{setValue:function(a){a=d.superclass.prototype.setValue.call(this,a);this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue());return a},updateDisplay:function(){this.__select.value=this.getValue();return d.superclass.prototype.updateDisplay.call(this)}});return d}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);
dat.controllers.NumberController=function(e,a){var c=function(d,f,b){c.superclass.call(this,d,f);b=b||{};this.__min=b.min;this.__max=b.max;this.__step=b.step;d=this.__impliedStep=a.isUndefined(this.__step)?this.initialValue==0?1:Math.pow(10,Math.floor(Math.log(this.initialValue)/Math.LN10))/10:this.__step;d=d.toString();this.__precision=d.indexOf(".")>-1?d.length-d.indexOf(".")-1:0};c.superclass=e;a.extend(c.prototype,e.prototype,{setValue:function(a){if(this.__min!==void 0&&a<this.__min)a=this.__min;
else if(this.__max!==void 0&&a>this.__max)a=this.__max;this.__step!==void 0&&a%this.__step!=0&&(a=Math.round(a/this.__step)*this.__step);return c.superclass.prototype.setValue.call(this,a)},min:function(a){this.__min=a;return this},max:function(a){this.__max=a;return this},step:function(a){this.__step=a;return this}});return c}(dat.controllers.Controller,dat.utils.common);
dat.controllers.NumberControllerBox=function(e,a,c){var d=function(f,b,e){function h(){var a=parseFloat(l.__input.value);c.isNaN(a)||l.setValue(a)}function j(a){var b=o-a.clientY;l.setValue(l.getValue()+b*l.__impliedStep);o=a.clientY}function m(){a.unbind(window,"mousemove",j);a.unbind(window,"mouseup",m)}this.__truncationSuspended=false;d.superclass.call(this,f,b,e);var l=this,o;this.__input=document.createElement("input");this.__input.setAttribute("type","text");a.bind(this.__input,"change",h);
a.bind(this.__input,"blur",function(){h();l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())});a.bind(this.__input,"mousedown",function(b){a.bind(window,"mousemove",j);a.bind(window,"mouseup",m);o=b.clientY});a.bind(this.__input,"keydown",function(a){if(a.keyCode===13)l.__truncationSuspended=true,this.blur(),l.__truncationSuspended=false});this.updateDisplay();this.domElement.appendChild(this.__input)};d.superclass=e;c.extend(d.prototype,e.prototype,{updateDisplay:function(){var a=this.__input,
b;if(this.__truncationSuspended)b=this.getValue();else{b=this.getValue();var c=Math.pow(10,this.__precision);b=Math.round(b*c)/c}a.value=b;return d.superclass.prototype.updateDisplay.call(this)}});return d}(dat.controllers.NumberController,dat.dom.dom,dat.utils.common);
dat.controllers.NumberControllerSlider=function(e,a,c,d,f){var b=function(d,c,f,e,l){function o(b){b.preventDefault();var d=a.getOffset(g.__background),c=a.getWidth(g.__background);g.setValue(g.__min+(g.__max-g.__min)*((b.clientX-d.left)/(d.left+c-d.left)));return false}function y(){a.unbind(window,"mousemove",o);a.unbind(window,"mouseup",y);g.__onFinishChange&&g.__onFinishChange.call(g,g.getValue())}b.superclass.call(this,d,c,{min:f,max:e,step:l});var g=this;this.__background=document.createElement("div");
this.__foreground=document.createElement("div");a.bind(this.__background,"mousedown",function(b){a.bind(window,"mousemove",o);a.bind(window,"mouseup",y);o(b)});a.addClass(this.__background,"slider");a.addClass(this.__foreground,"slider-fg");this.updateDisplay();this.__background.appendChild(this.__foreground);this.domElement.appendChild(this.__background)};b.superclass=e;b.useDefaultStyles=function(){c.inject(f)};d.extend(b.prototype,e.prototype,{updateDisplay:function(){this.__foreground.style.width=
(this.getValue()-this.__min)/(this.__max-this.__min)*100+"%";return b.superclass.prototype.updateDisplay.call(this)}});return b}(dat.controllers.NumberController,dat.dom.dom,dat.utils.css,dat.utils.common,".slider {\n  box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);\n  height: 1em;\n  border-radius: 1em;\n  background-color: #eee;\n  padding: 0 0.5em;\n  overflow: hidden;\n}\n\n.slider-fg {\n  padding: 1px 0 2px 0;\n  background-color: #aaa;\n  height: 1em;\n  margin-left: -0.5em;\n  padding-right: 0.5em;\n  border-radius: 1em 0 0 1em;\n}\n\n.slider-fg:after {\n  display: inline-block;\n  border-radius: 1em;\n  background-color: #fff;\n  border:  1px solid #aaa;\n  content: '';\n  float: right;\n  margin-right: -1em;\n  margin-top: -1px;\n  height: 0.9em;\n  width: 0.9em;\n}");
dat.controllers.FunctionController=function(e,a,c){var d=function(c,b,e){d.superclass.call(this,c,b);var h=this;this.__button=document.createElement("div");this.__button.innerHTML=e===void 0?"Fire":e;a.bind(this.__button,"click",function(a){a.preventDefault();h.fire();return false});a.addClass(this.__button,"button");this.domElement.appendChild(this.__button)};d.superclass=e;c.extend(d.prototype,e.prototype,{fire:function(){this.__onChange&&this.__onChange.call(this);this.__onFinishChange&&this.__onFinishChange.call(this,
this.getValue());this.getValue().call(this.object)}});return d}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);
dat.controllers.BooleanController=function(e,a,c){var d=function(c,b){d.superclass.call(this,c,b);var e=this;this.__prev=this.getValue();this.__checkbox=document.createElement("input");this.__checkbox.setAttribute("type","checkbox");a.bind(this.__checkbox,"change",function(){e.setValue(!e.__prev)},false);this.domElement.appendChild(this.__checkbox);this.updateDisplay()};d.superclass=e;c.extend(d.prototype,e.prototype,{setValue:function(a){a=d.superclass.prototype.setValue.call(this,a);this.__onFinishChange&&
this.__onFinishChange.call(this,this.getValue());this.__prev=this.getValue();return a},updateDisplay:function(){this.getValue()===true?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=true):this.__checkbox.checked=false;return d.superclass.prototype.updateDisplay.call(this)}});return d}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);
dat.color.toString=function(e){return function(a){if(a.a==1||e.isUndefined(a.a)){for(a=a.hex.toString(16);a.length<6;)a="0"+a;return"#"+a}else return"rgba("+Math.round(a.r)+","+Math.round(a.g)+","+Math.round(a.b)+","+a.a+")"}}(dat.utils.common);
dat.color.interpret=function(e,a){var c,d,f=[{litmus:a.isString,conversions:{THREE_CHAR_HEX:{read:function(a){a=a.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return a===null?false:{space:"HEX",hex:parseInt("0x"+a[1].toString()+a[1].toString()+a[2].toString()+a[2].toString()+a[3].toString()+a[3].toString())}},write:e},SIX_CHAR_HEX:{read:function(a){a=a.match(/^#([A-F0-9]{6})$/i);return a===null?false:{space:"HEX",hex:parseInt("0x"+a[1].toString())}},write:e},CSS_RGB:{read:function(a){a=a.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);
return a===null?false:{space:"RGB",r:parseFloat(a[1]),g:parseFloat(a[2]),b:parseFloat(a[3])}},write:e},CSS_RGBA:{read:function(a){a=a.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/);return a===null?false:{space:"RGB",r:parseFloat(a[1]),g:parseFloat(a[2]),b:parseFloat(a[3]),a:parseFloat(a[4])}},write:e}}},{litmus:a.isNumber,conversions:{HEX:{read:function(a){return{space:"HEX",hex:a,conversionName:"HEX"}},write:function(a){return a.hex}}}},{litmus:a.isArray,conversions:{RGB_ARRAY:{read:function(a){return a.length!=
3?false:{space:"RGB",r:a[0],g:a[1],b:a[2]}},write:function(a){return[a.r,a.g,a.b]}},RGBA_ARRAY:{read:function(a){return a.length!=4?false:{space:"RGB",r:a[0],g:a[1],b:a[2],a:a[3]}},write:function(a){return[a.r,a.g,a.b,a.a]}}}},{litmus:a.isObject,conversions:{RGBA_OBJ:{read:function(b){return a.isNumber(b.r)&&a.isNumber(b.g)&&a.isNumber(b.b)&&a.isNumber(b.a)?{space:"RGB",r:b.r,g:b.g,b:b.b,a:b.a}:false},write:function(a){return{r:a.r,g:a.g,b:a.b,a:a.a}}},RGB_OBJ:{read:function(b){return a.isNumber(b.r)&&
a.isNumber(b.g)&&a.isNumber(b.b)?{space:"RGB",r:b.r,g:b.g,b:b.b}:false},write:function(a){return{r:a.r,g:a.g,b:a.b}}},HSVA_OBJ:{read:function(b){return a.isNumber(b.h)&&a.isNumber(b.s)&&a.isNumber(b.v)&&a.isNumber(b.a)?{space:"HSV",h:b.h,s:b.s,v:b.v,a:b.a}:false},write:function(a){return{h:a.h,s:a.s,v:a.v,a:a.a}}},HSV_OBJ:{read:function(b){return a.isNumber(b.h)&&a.isNumber(b.s)&&a.isNumber(b.v)?{space:"HSV",h:b.h,s:b.s,v:b.v}:false},write:function(a){return{h:a.h,s:a.s,v:a.v}}}}}];return function(){d=
false;var b=arguments.length>1?a.toArray(arguments):arguments[0];a.each(f,function(e){if(e.litmus(b))return a.each(e.conversions,function(e,f){c=e.read(b);if(d===false&&c!==false)return d=c,c.conversionName=f,c.conversion=e,a.BREAK}),a.BREAK});return d}}(dat.color.toString,dat.utils.common);
dat.GUI=dat.gui.GUI=function(e,a,c,d,f,b,n,h,j,m,l,o,y,g,i){function q(a,b,r,c){if(b[r]===void 0)throw Error("Object "+b+' has no property "'+r+'"');c.color?b=new l(b,r):(b=[b,r].concat(c.factoryArgs),b=d.apply(a,b));if(c.before instanceof f)c.before=c.before.__li;t(a,b);g.addClass(b.domElement,"c");r=document.createElement("span");g.addClass(r,"property-name");r.innerHTML=b.property;var e=document.createElement("div");e.appendChild(r);e.appendChild(b.domElement);c=s(a,e,c.before);g.addClass(c,k.CLASS_CONTROLLER_ROW);
g.addClass(c,typeof b.getValue());p(a,c,b);a.__controllers.push(b);return b}function s(a,b,d){var c=document.createElement("li");b&&c.appendChild(b);d?a.__ul.insertBefore(c,params.before):a.__ul.appendChild(c);a.onResize();return c}function p(a,d,c){c.__li=d;c.__gui=a;i.extend(c,{options:function(b){if(arguments.length>1)return c.remove(),q(a,c.object,c.property,{before:c.__li.nextElementSibling,factoryArgs:[i.toArray(arguments)]});if(i.isArray(b)||i.isObject(b))return c.remove(),q(a,c.object,c.property,
{before:c.__li.nextElementSibling,factoryArgs:[b]})},name:function(a){c.__li.firstElementChild.firstElementChild.innerHTML=a;return c},listen:function(){c.__gui.listen(c);return c},remove:function(){c.__gui.remove(c);return c}});if(c instanceof j){var e=new h(c.object,c.property,{min:c.__min,max:c.__max,step:c.__step});i.each(["updateDisplay","onChange","onFinishChange"],function(a){var b=c[a],H=e[a];c[a]=e[a]=function(){var a=Array.prototype.slice.call(arguments);b.apply(c,a);return H.apply(e,a)}});
g.addClass(d,"has-slider");c.domElement.insertBefore(e.domElement,c.domElement.firstElementChild)}else if(c instanceof h){var f=function(b){return i.isNumber(c.__min)&&i.isNumber(c.__max)?(c.remove(),q(a,c.object,c.property,{before:c.__li.nextElementSibling,factoryArgs:[c.__min,c.__max,c.__step]})):b};c.min=i.compose(f,c.min);c.max=i.compose(f,c.max)}else if(c instanceof b)g.bind(d,"click",function(){g.fakeEvent(c.__checkbox,"click")}),g.bind(c.__checkbox,"click",function(a){a.stopPropagation()});
else if(c instanceof n)g.bind(d,"click",function(){g.fakeEvent(c.__button,"click")}),g.bind(d,"mouseover",function(){g.addClass(c.__button,"hover")}),g.bind(d,"mouseout",function(){g.removeClass(c.__button,"hover")});else if(c instanceof l)g.addClass(d,"color"),c.updateDisplay=i.compose(function(a){d.style.borderLeftColor=c.__color.toString();return a},c.updateDisplay),c.updateDisplay();c.setValue=i.compose(function(b){a.getRoot().__preset_select&&c.isModified()&&B(a.getRoot(),true);return b},c.setValue)}
function t(a,b){var c=a.getRoot(),d=c.__rememberedObjects.indexOf(b.object);if(d!=-1){var e=c.__rememberedObjectIndecesToControllers[d];e===void 0&&(e={},c.__rememberedObjectIndecesToControllers[d]=e);e[b.property]=b;if(c.load&&c.load.remembered){c=c.load.remembered;if(c[a.preset])c=c[a.preset];else if(c[w])c=c[w];else return;if(c[d]&&c[d][b.property]!==void 0)d=c[d][b.property],b.initialValue=d,b.setValue(d)}}}function I(a){var b=a.__save_row=document.createElement("li");g.addClass(a.domElement,
"has-save");a.__ul.insertBefore(b,a.__ul.firstChild);g.addClass(b,"save-row");var c=document.createElement("span");c.innerHTML="&nbsp;";g.addClass(c,"button gears");var d=document.createElement("span");d.innerHTML="Save";g.addClass(d,"button");g.addClass(d,"save");var e=document.createElement("span");e.innerHTML="New";g.addClass(e,"button");g.addClass(e,"save-as");var f=document.createElement("span");f.innerHTML="Revert";g.addClass(f,"button");g.addClass(f,"revert");var m=a.__preset_select=document.createElement("select");
a.load&&a.load.remembered?i.each(a.load.remembered,function(b,c){C(a,c,c==a.preset)}):C(a,w,false);g.bind(m,"change",function(){for(var b=0;b<a.__preset_select.length;b++)a.__preset_select[b].innerHTML=a.__preset_select[b].value;a.preset=this.value});b.appendChild(m);b.appendChild(c);b.appendChild(d);b.appendChild(e);b.appendChild(f);if(u){var b=document.getElementById("dg-save-locally"),l=document.getElementById("dg-local-explain");b.style.display="block";b=document.getElementById("dg-local-storage");
localStorage.getItem(document.location.href+".isLocal")==="true"&&b.setAttribute("checked","checked");var o=function(){l.style.display=a.useLocalStorage?"block":"none"};o();g.bind(b,"change",function(){a.useLocalStorage=!a.useLocalStorage;o()})}var h=document.getElementById("dg-new-constructor");g.bind(h,"keydown",function(a){a.metaKey&&(a.which===67||a.keyCode==67)&&x.hide()});g.bind(c,"click",function(){h.innerHTML=JSON.stringify(a.getSaveObject(),void 0,2);x.show();h.focus();h.select()});g.bind(d,
"click",function(){a.save()});g.bind(e,"click",function(){var b=prompt("Enter a new preset name.");b&&a.saveAs(b)});g.bind(f,"click",function(){a.revert()})}function J(a){function b(f){f.preventDefault();e=f.clientX;g.addClass(a.__closeButton,k.CLASS_DRAG);g.bind(window,"mousemove",c);g.bind(window,"mouseup",d);return false}function c(b){b.preventDefault();a.width+=e-b.clientX;a.onResize();e=b.clientX;return false}function d(){g.removeClass(a.__closeButton,k.CLASS_DRAG);g.unbind(window,"mousemove",
c);g.unbind(window,"mouseup",d)}a.__resize_handle=document.createElement("div");i.extend(a.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});var e;g.bind(a.__resize_handle,"mousedown",b);g.bind(a.__closeButton,"mousedown",b);a.domElement.insertBefore(a.__resize_handle,a.domElement.firstElementChild)}function D(a,b){a.domElement.style.width=b+"px";if(a.__save_row&&a.autoPlace)a.__save_row.style.width=b+"px";if(a.__closeButton)a.__closeButton.style.width=
b+"px"}function z(a,b){var c={};i.each(a.__rememberedObjects,function(d,e){var f={};i.each(a.__rememberedObjectIndecesToControllers[e],function(a,c){f[c]=b?a.initialValue:a.getValue()});c[e]=f});return c}function C(a,b,c){var d=document.createElement("option");d.innerHTML=b;d.value=b;a.__preset_select.appendChild(d);if(c)a.__preset_select.selectedIndex=a.__preset_select.length-1}function B(a,b){var c=a.__preset_select[a.__preset_select.selectedIndex];c.innerHTML=b?c.value+"*":c.value}function E(a){a.length!=
0&&o(function(){E(a)});i.each(a,function(a){a.updateDisplay()})}e.inject(c);var w="Default",u;try{u="localStorage"in window&&window.localStorage!==null}catch(K){u=false}var x,F=true,v,A=false,G=[],k=function(a){function b(){localStorage.setItem(document.location.href+".gui",JSON.stringify(d.getSaveObject()))}function c(){var a=d.getRoot();a.width+=1;i.defer(function(){a.width-=1})}var d=this;this.domElement=document.createElement("div");this.__ul=document.createElement("ul");this.domElement.appendChild(this.__ul);
g.addClass(this.domElement,"dg");this.__folders={};this.__controllers=[];this.__rememberedObjects=[];this.__rememberedObjectIndecesToControllers=[];this.__listening=[];a=a||{};a=i.defaults(a,{autoPlace:true,width:k.DEFAULT_WIDTH});a=i.defaults(a,{resizable:a.autoPlace,hideable:a.autoPlace});if(i.isUndefined(a.load))a.load={preset:w};else if(a.preset)a.load.preset=a.preset;i.isUndefined(a.parent)&&a.hideable&&G.push(this);a.resizable=i.isUndefined(a.parent)&&a.resizable;if(a.autoPlace&&i.isUndefined(a.scrollable))a.scrollable=
true;var e=u&&localStorage.getItem(document.location.href+".isLocal")==="true";Object.defineProperties(this,{parent:{get:function(){return a.parent}},scrollable:{get:function(){return a.scrollable}},autoPlace:{get:function(){return a.autoPlace}},preset:{get:function(){return d.parent?d.getRoot().preset:a.load.preset},set:function(b){d.parent?d.getRoot().preset=b:a.load.preset=b;for(b=0;b<this.__preset_select.length;b++)if(this.__preset_select[b].value==this.preset)this.__preset_select.selectedIndex=
b;d.revert()}},width:{get:function(){return a.width},set:function(b){a.width=b;D(d,b)}},name:{get:function(){return a.name},set:function(b){a.name=b;if(m)m.innerHTML=a.name}},closed:{get:function(){return a.closed},set:function(b){a.closed=b;a.closed?g.addClass(d.__ul,k.CLASS_CLOSED):g.removeClass(d.__ul,k.CLASS_CLOSED);this.onResize();if(d.__closeButton)d.__closeButton.innerHTML=b?k.TEXT_OPEN:k.TEXT_CLOSED}},load:{get:function(){return a.load}},useLocalStorage:{get:function(){return e},set:function(a){u&&
((e=a)?g.bind(window,"unload",b):g.unbind(window,"unload",b),localStorage.setItem(document.location.href+".isLocal",a))}}});if(i.isUndefined(a.parent)){a.closed=false;g.addClass(this.domElement,k.CLASS_MAIN);g.makeSelectable(this.domElement,false);if(u&&e){d.useLocalStorage=true;var f=localStorage.getItem(document.location.href+".gui");if(f)a.load=JSON.parse(f)}this.__closeButton=document.createElement("div");this.__closeButton.innerHTML=k.TEXT_CLOSED;g.addClass(this.__closeButton,k.CLASS_CLOSE_BUTTON);
this.domElement.appendChild(this.__closeButton);g.bind(this.__closeButton,"click",function(){d.closed=!d.closed})}else{if(a.closed===void 0)a.closed=true;var m=document.createTextNode(a.name);g.addClass(m,"controller-name");f=s(d,m);g.addClass(this.__ul,k.CLASS_CLOSED);g.addClass(f,"title");g.bind(f,"click",function(a){a.preventDefault();d.closed=!d.closed;return false});if(!a.closed)this.closed=false}a.autoPlace&&(i.isUndefined(a.parent)&&(F&&(v=document.createElement("div"),g.addClass(v,"dg"),g.addClass(v,
k.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(v),F=false),v.appendChild(this.domElement),g.addClass(this.domElement,k.CLASS_AUTO_PLACE)),this.parent||D(d,a.width));g.bind(window,"resize",function(){d.onResize()});g.bind(this.__ul,"webkitTransitionEnd",function(){d.onResize()});g.bind(this.__ul,"transitionend",function(){d.onResize()});g.bind(this.__ul,"oTransitionEnd",function(){d.onResize()});this.onResize();a.resizable&&J(this);d.getRoot();a.parent||c()};k.toggleHide=function(){A=!A;i.each(G,
function(a){a.domElement.style.zIndex=A?-999:999;a.domElement.style.opacity=A?0:1})};k.CLASS_AUTO_PLACE="a";k.CLASS_AUTO_PLACE_CONTAINER="ac";k.CLASS_MAIN="main";k.CLASS_CONTROLLER_ROW="cr";k.CLASS_TOO_TALL="taller-than-window";k.CLASS_CLOSED="closed";k.CLASS_CLOSE_BUTTON="close-button";k.CLASS_DRAG="drag";k.DEFAULT_WIDTH=245;k.TEXT_CLOSED="Close Controls";k.TEXT_OPEN="Open Controls";g.bind(window,"keydown",function(a){document.activeElement.type!=="text"&&(a.which===72||a.keyCode==72)&&k.toggleHide()},
false);i.extend(k.prototype,{add:function(a,b){return q(this,a,b,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(a,b){return q(this,a,b,{color:true})},remove:function(a){this.__ul.removeChild(a.__li);this.__controllers.slice(this.__controllers.indexOf(a),1);var b=this;i.defer(function(){b.onResize()})},destroy:function(){this.autoPlace&&v.removeChild(this.domElement)},addFolder:function(a){if(this.__folders[a]!==void 0)throw Error('You already have a folder in this GUI by the name "'+
a+'"');var b={name:a,parent:this};b.autoPlace=this.autoPlace;if(this.load&&this.load.folders&&this.load.folders[a])b.closed=this.load.folders[a].closed,b.load=this.load.folders[a];b=new k(b);this.__folders[a]=b;a=s(this,b.domElement);g.addClass(a,"folder");return b},open:function(){this.closed=false},close:function(){this.closed=true},onResize:function(){var a=this.getRoot();if(a.scrollable){var b=g.getOffset(a.__ul).top,c=0;i.each(a.__ul.childNodes,function(b){a.autoPlace&&b===a.__save_row||(c+=
g.getHeight(b))});window.innerHeight-b-20<c?(g.addClass(a.domElement,k.CLASS_TOO_TALL),a.__ul.style.height=window.innerHeight-b-20+"px"):(g.removeClass(a.domElement,k.CLASS_TOO_TALL),a.__ul.style.height="auto")}a.__resize_handle&&i.defer(function(){a.__resize_handle.style.height=a.__ul.offsetHeight+"px"});if(a.__closeButton)a.__closeButton.style.width=a.width+"px"},remember:function(){if(i.isUndefined(x))x=new y,x.domElement.innerHTML=a;if(this.parent)throw Error("You can only call remember on a top level GUI.");
var b=this;i.each(Array.prototype.slice.call(arguments),function(a){b.__rememberedObjects.length==0&&I(b);b.__rememberedObjects.indexOf(a)==-1&&b.__rememberedObjects.push(a)});this.autoPlace&&D(this,this.width)},getRoot:function(){for(var a=this;a.parent;)a=a.parent;return a},getSaveObject:function(){var a=this.load;a.closed=this.closed;if(this.__rememberedObjects.length>0){a.preset=this.preset;if(!a.remembered)a.remembered={};a.remembered[this.preset]=z(this)}a.folders={};i.each(this.__folders,function(b,
c){a.folders[c]=b.getSaveObject()});return a},save:function(){if(!this.load.remembered)this.load.remembered={};this.load.remembered[this.preset]=z(this);B(this,false)},saveAs:function(a){if(!this.load.remembered)this.load.remembered={},this.load.remembered[w]=z(this,true);this.load.remembered[a]=z(this);this.preset=a;C(this,a,true)},revert:function(a){i.each(this.__controllers,function(b){this.getRoot().load.remembered?t(a||this.getRoot(),b):b.setValue(b.initialValue)},this);i.each(this.__folders,
function(a){a.revert(a)});a||B(this.getRoot(),false)},listen:function(a){var b=this.__listening.length==0;this.__listening.push(a);b&&E(this.__listening)}});return k}(dat.utils.css,'<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n      \n    </div>\n    \n  </div>\n\n</div>',
".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity 0.1s linear;-o-transition:opacity 0.1s linear;-moz-transition:opacity 0.1s linear;transition:opacity 0.1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity 0.1s linear;-o-transition:opacity 0.1s linear;-moz-transition:opacity 0.1s linear;transition:opacity 0.1s linear;border:0;position:absolute;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-x:hidden}.dg.a.has-save ul{margin-top:27px}.dg.a.has-save ul.closed{margin-top:0}.dg.a .save-row{position:fixed;top:0;z-index:1002}.dg li{-webkit-transition:height 0.1s ease-out;-o-transition:height 0.1s ease-out;-moz-transition:height 0.1s ease-out;transition:height 0.1s ease-out}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;overflow:hidden;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li > *{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .c{float:left;width:60%}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:9px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2fa1d6}.dg .cr.number input[type=text]{color:#2fa1d6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2fa1d6}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n",
dat.controllers.factory=function(e,a,c,d,f,b,n){return function(h,j,m,l){var o=h[j];if(n.isArray(m)||n.isObject(m))return new e(h,j,m);if(n.isNumber(o))return n.isNumber(m)&&n.isNumber(l)?new c(h,j,m,l):new a(h,j,{min:m,max:l});if(n.isString(o))return new d(h,j);if(n.isFunction(o))return new f(h,j,"");if(n.isBoolean(o))return new b(h,j)}}(dat.controllers.OptionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.StringController=function(e,a,c){var d=
function(c,b){function e(){h.setValue(h.__input.value)}d.superclass.call(this,c,b);var h=this;this.__input=document.createElement("input");this.__input.setAttribute("type","text");a.bind(this.__input,"keyup",e);a.bind(this.__input,"change",e);a.bind(this.__input,"blur",function(){h.__onFinishChange&&h.__onFinishChange.call(h,h.getValue())});a.bind(this.__input,"keydown",function(a){a.keyCode===13&&this.blur()});this.updateDisplay();this.domElement.appendChild(this.__input)};d.superclass=e;c.extend(d.prototype,
e.prototype,{updateDisplay:function(){if(!a.isActive(this.__input))this.__input.value=this.getValue();return d.superclass.prototype.updateDisplay.call(this)}});return d}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.FunctionController,dat.controllers.BooleanController,dat.utils.common),dat.controllers.Controller,dat.controllers.BooleanController,dat.controllers.FunctionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.OptionController,
dat.controllers.ColorController=function(e,a,c,d,f){function b(a,b,c,d){a.style.background="";f.each(j,function(e){a.style.cssText+="background: "+e+"linear-gradient("+b+", "+c+" 0%, "+d+" 100%); "})}function n(a){a.style.background="";a.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);";a.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";
a.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";a.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";a.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var h=function(e,l){function o(b){q(b);a.bind(window,"mousemove",q);a.bind(window,
"mouseup",j)}function j(){a.unbind(window,"mousemove",q);a.unbind(window,"mouseup",j)}function g(){var a=d(this.value);a!==false?(p.__color.__state=a,p.setValue(p.__color.toOriginal())):this.value=p.__color.toString()}function i(){a.unbind(window,"mousemove",s);a.unbind(window,"mouseup",i)}function q(b){b.preventDefault();var c=a.getWidth(p.__saturation_field),d=a.getOffset(p.__saturation_field),e=(b.clientX-d.left+document.body.scrollLeft)/c,b=1-(b.clientY-d.top+document.body.scrollTop)/c;b>1?b=
1:b<0&&(b=0);e>1?e=1:e<0&&(e=0);p.__color.v=b;p.__color.s=e;p.setValue(p.__color.toOriginal());return false}function s(b){b.preventDefault();var c=a.getHeight(p.__hue_field),d=a.getOffset(p.__hue_field),b=1-(b.clientY-d.top+document.body.scrollTop)/c;b>1?b=1:b<0&&(b=0);p.__color.h=b*360;p.setValue(p.__color.toOriginal());return false}h.superclass.call(this,e,l);this.__color=new c(this.getValue());this.__temp=new c(0);var p=this;this.domElement=document.createElement("div");a.makeSelectable(this.domElement,
false);this.__selector=document.createElement("div");this.__selector.className="selector";this.__saturation_field=document.createElement("div");this.__saturation_field.className="saturation-field";this.__field_knob=document.createElement("div");this.__field_knob.className="field-knob";this.__field_knob_border="2px solid ";this.__hue_knob=document.createElement("div");this.__hue_knob.className="hue-knob";this.__hue_field=document.createElement("div");this.__hue_field.className="hue-field";this.__input=
document.createElement("input");this.__input.type="text";this.__input_textShadow="0 1px 1px ";a.bind(this.__input,"keydown",function(a){a.keyCode===13&&g.call(this)});a.bind(this.__input,"blur",g);a.bind(this.__selector,"mousedown",function(){a.addClass(this,"drag").bind(window,"mouseup",function(){a.removeClass(p.__selector,"drag")})});var t=document.createElement("div");f.extend(this.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"});
f.extend(this.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:this.__field_knob_border+(this.__color.v<0.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1});f.extend(this.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1});f.extend(this.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"});f.extend(t.style,
{width:"100%",height:"100%",background:"none"});b(t,"top","rgba(0,0,0,0)","#000");f.extend(this.__hue_field.style,{width:"15px",height:"100px",display:"inline-block",border:"1px solid #555",cursor:"ns-resize"});n(this.__hue_field);f.extend(this.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:this.__input_textShadow+"rgba(0,0,0,0.7)"});a.bind(this.__saturation_field,"mousedown",o);a.bind(this.__field_knob,"mousedown",o);a.bind(this.__hue_field,"mousedown",
function(b){s(b);a.bind(window,"mousemove",s);a.bind(window,"mouseup",i)});this.__saturation_field.appendChild(t);this.__selector.appendChild(this.__field_knob);this.__selector.appendChild(this.__saturation_field);this.__selector.appendChild(this.__hue_field);this.__hue_field.appendChild(this.__hue_knob);this.domElement.appendChild(this.__input);this.domElement.appendChild(this.__selector);this.updateDisplay()};h.superclass=e;f.extend(h.prototype,e.prototype,{updateDisplay:function(){var a=d(this.getValue());
if(a!==false){var e=false;f.each(c.COMPONENTS,function(b){if(!f.isUndefined(a[b])&&!f.isUndefined(this.__color.__state[b])&&a[b]!==this.__color.__state[b])return e=true,{}},this);e&&f.extend(this.__color.__state,a)}f.extend(this.__temp.__state,this.__color.__state);this.__temp.a=1;var h=this.__color.v<0.5||this.__color.s>0.5?255:0,j=255-h;f.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toString(),border:this.__field_knob_border+
"rgb("+h+","+h+","+h+")"});this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px";this.__temp.s=1;this.__temp.v=1;b(this.__saturation_field,"left","#fff",this.__temp.toString());f.extend(this.__input.style,{backgroundColor:this.__input.value=this.__color.toString(),color:"rgb("+h+","+h+","+h+")",textShadow:this.__input_textShadow+"rgba("+j+","+j+","+j+",.7)"})}});var j=["-moz-","-o-","-webkit-","-ms-",""];return h}(dat.controllers.Controller,dat.dom.dom,dat.color.Color=function(e,a,c,d){function f(a,
b,c){Object.defineProperty(a,b,{get:function(){if(this.__state.space==="RGB")return this.__state[b];n(this,b,c);return this.__state[b]},set:function(a){if(this.__state.space!=="RGB")n(this,b,c),this.__state.space="RGB";this.__state[b]=a}})}function b(a,b){Object.defineProperty(a,b,{get:function(){if(this.__state.space==="HSV")return this.__state[b];h(this);return this.__state[b]},set:function(a){if(this.__state.space!=="HSV")h(this),this.__state.space="HSV";this.__state[b]=a}})}function n(b,c,e){if(b.__state.space===
"HEX")b.__state[c]=a.component_from_hex(b.__state.hex,e);else if(b.__state.space==="HSV")d.extend(b.__state,a.hsv_to_rgb(b.__state.h,b.__state.s,b.__state.v));else throw"Corrupted color state";}function h(b){var c=a.rgb_to_hsv(b.r,b.g,b.b);d.extend(b.__state,{s:c.s,v:c.v});if(d.isNaN(c.h)){if(d.isUndefined(b.__state.h))b.__state.h=0}else b.__state.h=c.h}var j=function(){this.__state=e.apply(this,arguments);if(this.__state===false)throw"Failed to interpret color arguments";this.__state.a=this.__state.a||
1};j.COMPONENTS="r,g,b,h,s,v,hex,a".split(",");d.extend(j.prototype,{toString:function(){return c(this)},toOriginal:function(){return this.__state.conversion.write(this)}});f(j.prototype,"r",2);f(j.prototype,"g",1);f(j.prototype,"b",0);b(j.prototype,"h");b(j.prototype,"s");b(j.prototype,"v");Object.defineProperty(j.prototype,"a",{get:function(){return this.__state.a},set:function(a){this.__state.a=a}});Object.defineProperty(j.prototype,"hex",{get:function(){if(!this.__state.space!=="HEX")this.__state.hex=
a.rgb_to_hex(this.r,this.g,this.b);return this.__state.hex},set:function(a){this.__state.space="HEX";this.__state.hex=a}});return j}(dat.color.interpret,dat.color.math=function(){var e;return{hsv_to_rgb:function(a,c,d){var e=a/60-Math.floor(a/60),b=d*(1-c),n=d*(1-e*c),c=d*(1-(1-e)*c),a=[[d,c,b],[n,d,b],[b,d,c],[b,n,d],[c,b,d],[d,b,n]][Math.floor(a/60)%6];return{r:a[0]*255,g:a[1]*255,b:a[2]*255}},rgb_to_hsv:function(a,c,d){var e=Math.min(a,c,d),b=Math.max(a,c,d),e=b-e;if(b==0)return{h:NaN,s:0,v:0};
a=a==b?(c-d)/e:c==b?2+(d-a)/e:4+(a-c)/e;a/=6;a<0&&(a+=1);return{h:a*360,s:e/b,v:b/255}},rgb_to_hex:function(a,c,d){a=this.hex_with_component(0,2,a);a=this.hex_with_component(a,1,c);return a=this.hex_with_component(a,0,d)},component_from_hex:function(a,c){return a>>c*8&255},hex_with_component:function(a,c,d){return d<<(e=c*8)|a&~(255<<e)}}}(),dat.color.toString,dat.utils.common),dat.color.interpret,dat.utils.common),dat.utils.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||
window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1E3/60)}}(),dat.dom.CenteredDiv=function(e,a){var c=function(){this.backgroundElement=document.createElement("div");a.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear"});e.makeFullscreen(this.backgroundElement);this.backgroundElement.style.position="fixed";this.domElement=
document.createElement("div");a.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear"});document.body.appendChild(this.backgroundElement);document.body.appendChild(this.domElement);var c=this;e.bind(this.backgroundElement,"click",function(){c.hide()})};c.prototype.show=function(){var c=this;this.backgroundElement.style.display="block";this.domElement.style.display="block";this.domElement.style.opacity=
0;this.domElement.style.webkitTransform="scale(1.1)";this.layout();a.defer(function(){c.backgroundElement.style.opacity=1;c.domElement.style.opacity=1;c.domElement.style.webkitTransform="scale(1)"})};c.prototype.hide=function(){var a=this,c=function(){a.domElement.style.display="none";a.backgroundElement.style.display="none";e.unbind(a.domElement,"webkitTransitionEnd",c);e.unbind(a.domElement,"transitionend",c);e.unbind(a.domElement,"oTransitionEnd",c)};e.bind(this.domElement,"webkitTransitionEnd",
c);e.bind(this.domElement,"transitionend",c);e.bind(this.domElement,"oTransitionEnd",c);this.backgroundElement.style.opacity=0;this.domElement.style.opacity=0;this.domElement.style.webkitTransform="scale(1.1)"};c.prototype.layout=function(){this.domElement.style.left=window.innerWidth/2-e.getWidth(this.domElement)/2+"px";this.domElement.style.top=window.innerHeight/2-e.getHeight(this.domElement)/2+"px"};return c}(dat.dom.dom,dat.utils.common),dat.dom.dom,dat.utils.common);

//! <%= pkg.name %> <%= pkg.version %>
//! Built on <%= grunt.template.today('yyyy-mm-dd') %>
//! Git commit: <%= gitInfo %>
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
window.OpenSeadragon=window.OpenSeadragon||function(a){return new OpenSeadragon.Viewer(a)},function(a){a.version={versionStr:"1.1.1",major:parseInt("1",10),minor:parseInt("1",10),revision:parseInt("1",10)};var b={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},c=Object.prototype.toString,d=Object.prototype.hasOwnProperty;a.isFunction=function(b){return"function"===a.type(b)},a.isArray=Array.isArray||function(b){return"array"===a.type(b)},a.isWindow=function(a){return a&&"object"==typeof a&&"setInterval"in a},a.type=function(a){return null===a||void 0===a?String(a):b[c.call(a)]||"object"},a.isPlainObject=function(b){if(!b||"object"!==OpenSeadragon.type(b)||b.nodeType||a.isWindow(b))return!1;if(b.constructor&&!d.call(b,"constructor")&&!d.call(b.constructor.prototype,"isPrototypeOf"))return!1;var c;for(c in b);return void 0===c||d.call(b,c)},a.isEmptyObject=function(a){for(var b in a)return!1;return!0},a.supportsCanvas=function(){var b=document.createElement("canvas");return!(!a.isFunction(b.getContext)||!b.getContext("2d"))}()}(OpenSeadragon),function(a){function b(a,b){return b&&a!=document.body?document.body:a.offsetParent}a.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=arguments.length,i=!1,j=1;for("boolean"==typeof g&&(i=g,g=arguments[1]||{},j=2),"object"==typeof g||OpenSeadragon.isFunction(g)||(g={}),h===j&&(g=this,--j);h>j;j++)if(a=arguments[j],null!==a||void 0!==a)for(b in a)c=g[b],d=a[b],g!==d&&(i&&d&&(OpenSeadragon.isPlainObject(d)||(e=OpenSeadragon.isArray(d)))?(e?(e=!1,f=c&&OpenSeadragon.isArray(c)?c:[]):f=c&&OpenSeadragon.isPlainObject(c)?c:{},g[b]=OpenSeadragon.extend(i,f,d)):void 0!==d&&(g[b]=d));return g},a.extend(a,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,pinchToZoom:!1,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,pinchToZoom:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25},gestureSettingsPen:{scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,pinchToZoom:!1,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25},gestureSettingsUnknown:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,pinchToZoom:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25},zoomPerClick:2,zoomPerScroll:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,pixelsPerWheelLine:40,autoResize:!0,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,degrees:0,opacity:1,layersAspectRatioEpsilon:1e-4,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,useCanvas:!0,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:"#437AB2"},SIGNAL:"----seadragon----",delegate:function(a,b){return function(){var c=arguments;return void 0===c&&(c=[]),b.apply(a,c)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5},getElement:function(a){return"string"==typeof a&&(a=document.getElementById(a)),a},getElementPosition:function(c){var d,e,f=new a.Point;for(c=a.getElement(c),d="fixed"==a.getElementStyle(c).position,e=b(c,d);e;)f.x+=c.offsetLeft,f.y+=c.offsetTop,d&&(f=f.plus(a.getPageScroll())),c=e,d="fixed"==a.getElementStyle(c).position,e=b(c,d);return f},getElementOffset:function(b){b=a.getElement(b);var c,d,e=b&&b.ownerDocument,f={top:0,left:0};return e?(c=e.documentElement,"undefined"!=typeof b.getBoundingClientRect&&(f=b.getBoundingClientRect()),d=e==e.window?e:9===e.nodeType?e.defaultView||e.parentWindow:!1,new a.Point(f.left+(d.pageXOffset||c.scrollLeft)-(c.clientLeft||0),f.top+(d.pageYOffset||c.scrollTop)-(c.clientTop||0))):new a.Point},getElementSize:function(b){return b=a.getElement(b),new a.Point(b.clientWidth,b.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(b){return b=a.getElement(b),b.currentStyle}:function(b){return b=a.getElement(b),window.getComputedStyle(b,"")},pointInElement:function(b,c){b=a.getElement(b);var d=a.getElementOffset(b),e=a.getElementSize(b);return c.x>=d.x&&c.x<d.x+e.x&&c.y<d.y+e.y&&c.y>=d.y},getEvent:function(b){return a.getEvent=b?function(a){return a}:function(){return window.event},a.getEvent(b)},getMousePosition:function(b){if("number"==typeof b.pageX)a.getMousePosition=function(b){var c=new a.Point;return b=a.getEvent(b),c.x=b.pageX,c.y=b.pageY,c};else{if("number"!=typeof b.clientX)throw new Error("Unknown event mouse position, no known technique.");a.getMousePosition=function(b){var c=new a.Point;return b=a.getEvent(b),c.x=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c.y=b.clientY+document.body.scrollTop+document.documentElement.scrollTop,c}}return a.getMousePosition(b)},getPageScroll:function(){var b=document.documentElement||{},c=document.body||{};if("number"==typeof window.pageXOffset)a.getPageScroll=function(){return new a.Point(window.pageXOffset,window.pageYOffset)};else if(c.scrollLeft||c.scrollTop)a.getPageScroll=function(){return new a.Point(document.body.scrollLeft,document.body.scrollTop)};else{if(!b.scrollLeft&&!b.scrollTop)return new a.Point(0,0);a.getPageScroll=function(){return new a.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)}}return a.getPageScroll()},setPageScroll:function(b){if("undefined"!=typeof window.scrollTo)a.setPageScroll=function(a){window.scrollTo(a.x,a.y)};else{var c=a.getPageScroll();if(c.x===b.x&&c.y===b.y)return;document.body.scrollLeft=b.x,document.body.scrollTop=b.y;var d=a.getPageScroll();if(d.x!==c.x&&d.y!==c.y)return void(a.setPageScroll=function(a){document.body.scrollLeft=a.x,document.body.scrollTop=a.y});if(document.documentElement.scrollLeft=b.x,document.documentElement.scrollTop=b.y,d=a.getPageScroll(),d.x!==c.x&&d.y!==c.y)return void(a.setPageScroll=function(a){document.documentElement.scrollLeft=a.x,document.documentElement.scrollTop=a.y});a.setPageScroll=function(){}}return a.setPageScroll(b)},getWindowSize:function(){var b=document.documentElement||{},c=document.body||{};if("number"==typeof window.innerWidth)a.getWindowSize=function(){return new a.Point(window.innerWidth,window.innerHeight)};else if(b.clientWidth||b.clientHeight)a.getWindowSize=function(){return new a.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else{if(!c.clientWidth&&!c.clientHeight)throw new Error("Unknown window size, no known technique.");a.getWindowSize=function(){return new a.Point(document.body.clientWidth,document.body.clientHeight)}}return a.getWindowSize()},makeCenteredNode:function(b){b=a.getElement(b);var c=[a.makeNeutralElement("div"),a.makeNeutralElement("div"),a.makeNeutralElement("div")];return a.extend(c[0].style,{display:"table",height:"100%",width:"100%"}),a.extend(c[1].style,{display:"table-row"}),a.extend(c[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),c[0].appendChild(c[1]),c[1].appendChild(c[2]),c[2].appendChild(b),c[0]},makeNeutralElement:function(a){var b=document.createElement(a),c=b.style;return c.background="transparent none",c.border="none",c.margin="0px",c.padding="0px",c.position="static",b},now:function(){return a.now=Date.now?Date.now:function(){return(new Date).getTime()},a.now()},makeTransparentImage:function(b){return a.makeTransparentImage=function(b){var c=a.makeNeutralElement("img");return c.src=b,c},a.Browser.vendor==a.BROWSERS.IE&&a.Browser.version<7&&(a.makeTransparentImage=function(b){var c=a.makeNeutralElement("img"),d=null;return d=a.makeNeutralElement("span"),d.style.display="inline-block",c.onload=function(){d.style.width=d.style.width||c.width+"px",d.style.height=d.style.height||c.height+"px",c.onload=null,c=null},c.src=b,d.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+b+"', sizingMethod='scale')",d}),a.makeTransparentImage(b)},setElementOpacity:function(b,c,d){var e,f;b=a.getElement(b),d&&!a.Browser.alpha&&(c=Math.round(c)),a.Browser.opacity?b.style.opacity=1>c?c:"":1>c?(e=Math.round(100*c),f="alpha(opacity="+e+")",b.style.filter=f):b.style.filter=""},addClass:function(b,c){b=a.getElement(b),b.className?-1===(" "+b.className+" ").indexOf(" "+c+" ")&&(b.className+=" "+c):b.className=c},indexOf:function(a,b,c){return this.indexOf=Array.prototype.indexOf?function(a,b,c){return a.indexOf(b,c)}:function(a,b,c){var d,e,f=c?c:0;if(!a)throw new TypeError;if(e=a.length,0===e||f>=e)return-1;for(0>f&&(f=e-Math.abs(f)),d=f;e>d;d++)if(a[d]===b)return d;return-1},this.indexOf(a,b,c)},removeClass:function(b,c){var d,e,f=[];for(b=a.getElement(b),d=b.className.split(/\s+/),e=0;e<d.length;e++)d[e]&&d[e]!==c&&f.push(d[e]);b.className=f.join(" ")},addEvent:function(){if(window.addEventListener)return function(b,c,d,e){b=a.getElement(b),b.addEventListener(c,d,e)};if(window.attachEvent)return function(b,c,d){b=a.getElement(b),b.attachEvent("on"+c,d)};throw new Error("No known event model.")}(),removeEvent:function(){if(window.removeEventListener)return function(b,c,d,e){b=a.getElement(b),b.removeEventListener(c,d,e)};if(window.detachEvent)return function(b,c,d){b=a.getElement(b),b.detachEvent("on"+c,d)};throw new Error("No known event model.")}(),cancelEvent:function(b){b=a.getEvent(b),a.cancelEvent=b.preventDefault?function(a){a.preventDefault()}:function(b){b=a.getEvent(b),b.cancel=!0,b.returnValue=!1},a.cancelEvent(b)},stopEvent:function(b){b=a.getEvent(b),a.stopEvent=b.stopPropagation?function(a){a.stopPropagation()}:function(b){b=a.getEvent(b),b.cancelBubble=!0},a.stopEvent(b)},createCallback:function(a,b){var c,d=[];for(c=2;c<arguments.length;c++)d.push(arguments[c]);return function(){var c,e=d.concat([]);for(c=0;c<arguments.length;c++)e.push(arguments[c]);return b.apply(a,e)}},getUrlParameter:function(a){var b=d[a];return b?b:null},getUrlProtocol:function(a){var b=a.match(/^([a-z]+:)\/\//i);return null===b?window.location.protocol:b[1].toLowerCase()},createAjaxRequest:function(b){var c;try{c=!!new ActiveXObject("Microsoft.XMLHTTP")}catch(d){c=!1}if(c)a.createAjaxRequest=window.XMLHttpRequest?function(a){return a?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")};else{if(!window.XMLHttpRequest)throw new Error("Browser doesn't support XMLHttpRequest.");a.createAjaxRequest=function(){return new XMLHttpRequest}}return a.createAjaxRequest(b)},makeAjaxRequest:function(b,c,d){var e=a.getUrlProtocol(b),f=a.createAjaxRequest("file:"===e);if(!a.isFunction(c))throw new Error("makeAjaxRequest requires a success callback");f.onreadystatechange=function(){if(4==f.readyState){f.onreadystatechange=function(){};var g="http:"===e||"https:"===e?200:0;f.status===g?c(f):(a.console.log("AJAX request returned %d: %s",f.status,b),a.isFunction(d)&&d(f))}};try{f.open("GET",b,!0),f.send(null)}catch(g){var h=g.message,i=a.Browser.vendor==a.BROWSERS.IE&&a.Browser.version<10;i&&"undefined"!=typeof g.number&&-2147024891==g.number&&(h+="\nSee http://msdn.microsoft.com/en-us/library/ms537505(v=vs.85).aspx#xdomain"),a.console.log("%s while making AJAX request: %s",g.name,h),f.onreadystatechange=function(){},a.isFunction(d)&&d(f,g)}},jsonp:function(b){var c,d=b.url,e=document.head||document.getElementsByTagName("head")[0]||document.documentElement,f=b.callbackName||"openseadragon"+a.now(),g=window[f],h="$1"+f+"$2",i=b.param||"callback",j=b.callback;d=d.replace(/(\=)\?(&|$)|\?\?/i,h),d+=(/\?/.test(d)?"&":"?")+i+"="+f,window[f]=function(b){if(g)window[f]=g;else try{delete window[f]}catch(c){}j&&a.isFunction(j)&&j(b)},c=document.createElement("script"),(void 0!==b.async||!1!==b.async)&&(c.async="async"),b.scriptCharset&&(c.charset=b.scriptCharset),c.src=d,c.onload=c.onreadystatechange=function(a,b){(b||!c.readyState||/loaded|complete/.test(c.readyState))&&(c.onload=c.onreadystatechange=null,e&&c.parentNode&&e.removeChild(c),c=void 0)},e.insertBefore(c,e.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(b){if(window.DOMParser)a.parseXml=function(a){var b,c=null;return b=new DOMParser,c=b.parseFromString(a,"text/xml")};else{if(!window.ActiveXObject)throw new Error("Browser doesn't support XML DOM.");a.parseXml=function(a){var b=null;return b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a),b}}return a.parseXml(b)},imageFormatSupported:function(a){return a=a?a:"",!!c[a.toLowerCase()]}}),a.Browser={vendor:a.BROWSERS.UNKNOWN,version:0,alpha:!0};var c={bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1},d={};!function(){var b,c=(navigator.appName,navigator.appVersion),e=navigator.userAgent;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(a.Browser.vendor=a.BROWSERS.IE,a.Browser.version=parseFloat(e.substring(e.indexOf("MSIE")+5,e.indexOf(";",e.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(e.indexOf("Firefox")>=0?(a.Browser.vendor=a.BROWSERS.FIREFOX,a.Browser.version=parseFloat(e.substring(e.indexOf("Firefox")+8))):e.indexOf("Safari")>=0?(a.Browser.vendor=e.indexOf("Chrome")>=0?a.BROWSERS.CHROME:a.BROWSERS.SAFARI,a.Browser.version=parseFloat(e.substring(e.substring(0,e.indexOf("Safari")).lastIndexOf("/")+1,e.indexOf("Safari")))):(b=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,}) "),null!==b.exec(e)&&(a.Browser.vendor=a.BROWSERS.IE,a.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":a.Browser.vendor=a.BROWSERS.OPERA,a.Browser.version=parseFloat(c)}var f,g,h,i=window.location.search.substring(1),j=i.split("&");for(h=0;h<j.length;h++)f=j[h],g=f.indexOf("="),g>0&&(d[f.substring(0,g)]=decodeURIComponent(f.substring(g+1)));a.Browser.alpha=!(a.Browser.vendor==a.BROWSERS.IE&&a.Browser.version<9||a.Browser.vendor==a.BROWSERS.CHROME&&a.Browser.version<2),a.Browser.opacity=!(a.Browser.vendor==a.BROWSERS.IE&&a.Browser.version<9)}();var e=function(){};a.console=window.console||{log:e,debug:e,info:e,warn:e,error:e},function(b){var c=b.requestAnimationFrame||b.mozRequestAnimationFrame||b.webkitRequestAnimationFrame||b.msRequestAnimationFrame,d=b.cancelAnimationFrame||b.mozCancelAnimationFrame||b.webkitCancelAnimationFrame||b.msCancelAnimationFrame;if(c&&d)a.requestAnimationFrame=function(){return c.apply(b,arguments)},a.cancelAnimationFrame=function(){return d.apply(b,arguments)};else{var e,f=[],g=[],h=0;a.requestAnimationFrame=function(b){return f.push([++h,b]),e||(e=setInterval(function(){if(f.length){var b=a.now(),c=g;for(g=f,f=c;g.length;)g.shift()[1](b)}else clearInterval(e),e=void 0},20)),h},a.cancelAnimationFrame=function(a){var b,c;for(b=0,c=f.length;c>b;b+=1)if(f[b][0]===a)return void f.splice(b,1);for(b=0,c=g.length;c>b;b+=1)if(g[b][0]===a)return void g.splice(b,1)}}}(window),a._processDZIError=function(a){var b=a.getElementsByTagName("Message")[0],c=b.firstChild.nodeValue;throw new Error(c)}}(OpenSeadragon),function(a){var b={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(b.supportsFullScreen=!0,b.getFullScreenElement=function(){return document.fullscreenElement},b.requestFullScreen=function(a){return a.requestFullscreen()},b.exitFullScreen=function(){document.exitFullscreen()},b.fullScreenEventName="fullscreenchange",b.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(b.supportsFullScreen=!0,b.getFullScreenElement=function(){return document.msFullscreenElement},b.requestFullScreen=function(a){return a.msRequestFullscreen()},b.exitFullScreen=function(){document.msExitFullscreen()},b.fullScreenEventName="MSFullscreenChange",b.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(b.supportsFullScreen=!0,b.getFullScreenElement=function(){return document.webkitFullscreenElement},b.requestFullScreen=function(a){return a.webkitRequestFullscreen()},b.exitFullScreen=function(){document.webkitExitFullscreen()},b.fullScreenEventName="webkitfullscreenchange",b.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(b.supportsFullScreen=!0,b.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},b.requestFullScreen=function(a){return a.webkitRequestFullScreen()},b.exitFullScreen=function(){document.webkitCancelFullScreen()},b.fullScreenEventName="webkitfullscreenchange",b.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(b.supportsFullScreen=!0,b.getFullScreenElement=function(){return document.mozFullScreenElement},b.requestFullScreen=function(a){return a.mozRequestFullScreen()},b.exitFullScreen=function(){document.mozCancelFullScreen()},b.fullScreenEventName="mozfullscreenchange",b.fullScreenErrorEventName="mozfullscreenerror"),b.isFullScreen=function(){return null!==b.getFullScreenElement()},b.cancelFullScreen=function(){a.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),b.exitFullScreen()},a.extend(a,b)}(OpenSeadragon),function(a){a.EventSource=function(){this.events={}},a.EventSource.prototype={addHandler:function(b,c,d){var e=this.events[b];e||(this.events[b]=e=[]),c&&a.isFunction(c)&&(e[e.length]={handler:c,userData:d||null})},removeHandler:function(b,c){var d,e=this.events[b],f=[];if(e&&a.isArray(e)){for(d=0;d<e.length;d++)e[d].handler!==c&&f.push(e[d]);this.events[b]=f}},removeAllHandlers:function(a){if(a)this.events[a]=[];else for(var b in this.events)this.events[b]=[]},getHandler:function(a){var b=this.events[a];return b&&b.length?(b=1===b.length?[b[0]]:Array.apply(null,b),function(a,c){var d,e=b.length;for(d=0;e>d;d++)b[d]&&(c.eventSource=a,c.userData=b[d].userData,b[d].handler(c))}):null},raiseEvent:function(a,b){var c=this.getHandler(a);c&&(b||(b={}),c(this,b))}}}(OpenSeadragon),function(a){function b(b){var c,d,e=_[b.hash];if(!e.tracking){for(d=0;d<a.MouseTracker.subscribeEvents.length;d++)c=a.MouseTracker.subscribeEvents[d],a.addEvent(b.element,c,e[c],!1);e.tracking=!0}}function c(b){var c,d,f=_[b.hash];if(f.tracking){for(d=0;d<a.MouseTracker.subscribeEvents.length;d++)c=a.MouseTracker.subscribeEvents[d],a.removeEvent(b.element,c,f[c],!1);e(b),f.tracking=!1}}function d(b){var c=_[b.hash];c.capturing||(a.MouseTracker.supportsMouseCapture?b.element.setCapture(!0):(a.addEvent(window,"mouseup",c.mouseupcaptured,!0),a.addEvent(window,"mousemove",c.mousemovecaptured,!0)),c.capturing=!0)}function e(b){var c=_[b.hash];c.capturing&&(a.MouseTracker.supportsMouseCapture?b.element.releaseCapture():(a.removeEvent(window,"mousemove",c.mousemovecaptured,!0),a.removeEvent(window,"mouseup",c.mouseupcaptured,!0)),c.capturing=!1)}function f(b){var c;if(a.MouseTracker.unprefixedPointerEvents)c=b.pointerType;else switch(b.pointerType){case 2:c="touch";break;case 3:c="pen";break;case 4:c="mouse";break;default:c=""}return c}function g(b){return a.getMousePosition(b)}function h(a,b){return i(g(a),b)}function i(b,c){var d=a.getElementOffset(c);return b.minus(d)}function j(b,c){return new a.Point((b.x+c.x)/2,(b.y+c.y)/2)}function k(b,c){b.clickHandler&&a.cancelEvent(c)}function l(b,c){b.dblClickHandler&&a.cancelEvent(c)}function m(b,c){var d;b.keyHandler&&(c=a.getEvent(c),d=b.keyHandler({eventSource:b,position:h(c,b.element),keyCode:c.keyCode?c.keyCode:c.charCode,shift:c.shiftKey,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),d||a.cancelEvent(c))}function n(b,c){var d;b.focusHandler&&(c=a.getEvent(c),d=b.focusHandler({eventSource:b,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),d===!1&&a.cancelEvent(c))}function o(b,c){var d;b.blurHandler&&(c=a.getEvent(c),d=b.blurHandler({eventSource:b,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),d===!1&&a.cancelEvent(c))}function p(a,b){r(a,b,b)}function q(b,c){c=a.getEvent(c);var d={target:c.target||c.srcElement,type:"wheel",shiftKey:c.shiftKey||!1,clientX:c.clientX,clientY:c.clientY,pageX:c.pageX?c.pageX:c.clientX,pageY:c.pageY?c.pageY:c.clientY,deltaMode:"MozMousePixelScroll"==c.type?0:1,deltaX:0,deltaZ:0};d.deltaY="mousewheel"==a.MouseTracker.wheelEventName?-1/a.DEFAULT_SETTINGS.pixelsPerWheelLine*c.wheelDelta:c.detail,r(b,d,c)}function r(b,c,d){var e,f=0;f=c.deltaY<0?1:-1,b.scrollHandler&&(e=b.scrollHandler({eventSource:b,pointerType:"mouse",position:h(c,b.element),scroll:f,shift:c.shiftKey,isTouchEvent:!1,originalEvent:d,preventDefaultAction:!1,userData:b.userData}),e===!1&&a.cancelEvent(d))}function s(a,b){if(a===b)return!1;for(;b&&b!==a;)b=b.parentNode;return b===a}function t(b,c){var d;c=a.getEvent(c),this===c.relatedTarget||s(this,c.relatedTarget)||(d={id:a.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:g(c),currentTime:a.now()},U(b,c,[d]))}function u(b,c){var d;c=a.getEvent(c),this===c.relatedTarget||s(this,c.relatedTarget)||(d={id:a.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:g(c),currentTime:a.now()},V(b,c,[d]))}function v(b,c){var d;c=a.getEvent(c),d={id:a.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:g(c),currentTime:a.now()},U(b,c,[d])}function w(b,c){var d;c=a.getEvent(c),d={id:a.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:g(c),currentTime:a.now()},V(b,c,[d])}function x(b,c){var e;c=a.getEvent(c),e={id:a.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:g(c),currentTime:a.now()},W(b,c,[e],c.button)&&(a.stopEvent(c),d(b)),(b.clickHandler||b.dblClickHandler||b.pressHandler||b.dragHandler||b.dragEndHandler)&&a.cancelEvent(c)}function y(a,b){A(a,b)}function z(b,c){A(b,c),a.stopEvent(c)}function A(b,c){var d;c=a.getEvent(c),d={id:a.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:g(c),currentTime:a.now()},X(b,c,[d],c.button)&&e(b)}function B(a,b){D(a,b)}function C(b,c){D(b,c),a.stopEvent(c)}function D(b,c){var d;c=a.getEvent(c),d={id:a.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:g(c),currentTime:a.now()},Y(b,c,[d])}function E(b,c){var d,e=c.changedTouches.length,f=[];for(d=0;e>d;d++)f.push({id:c.changedTouches[d].identifier,type:"touch",currentPos:g(c.changedTouches[d]),currentTime:a.now()});U(b,c,f)}function F(b,c){var d,e=c.changedTouches.length,f=[];for(d=0;e>d;d++)f.push({id:c.changedTouches[d].identifier,type:"touch",currentPos:g(c.changedTouches[d]),currentTime:a.now()});V(b,c,f)}function G(b,c){var d,e,f=c.changedTouches.length,h=[];for(d=a.now(),e=0;f>e;e++)h.push({id:c.changedTouches[e].identifier,type:"touch",currentPos:g(c.changedTouches[e]),currentTime:d});a.MouseTracker.haveTouchEnter||U(b,c,h),W(b,c,h,0),a.cancelEvent(c)}function H(b,c){var d,e,f=c.changedTouches.length,h=[];for(d=a.now(),e=0;f>e;e++)h.push({id:c.changedTouches[e].identifier,type:"touch",currentPos:g(c.changedTouches[e]),currentTime:d});X(b,c,h,0),!a.MouseTracker.haveTouchEnter&&f>0&&V(b,c,h),a.cancelEvent(c)}function I(b,c){var d,e=c.changedTouches.length,f=[];for(d=0;e>d;d++)f.push({id:c.changedTouches[d].identifier,type:"touch",currentPos:g(c.changedTouches[d]),currentTime:a.now()});Y(b,c,f),a.cancelEvent(c)}function J(a,b){var c,d=b.changedTouches.length,e=[];for(c=0;d>c;c++)e.push({id:b.changedTouches[c].identifier,type:"touch"});Z(a,b,e)}function K(a,b){return b.stopPropagation(),b.preventDefault(),!1}function L(a,b){return b.stopPropagation(),b.preventDefault(),!1}function M(b,c){var d;d={id:c.pointerId,type:f(c),isPrimary:c.isPrimary,currentPos:g(c),currentTime:a.now()},U(b,c,[d])}function N(b,c){var d;d={id:c.pointerId,type:f(c),isPrimary:c.isPrimary,currentPos:g(c),currentTime:a.now()},V(b,c,[d])}function O(b,c){var d;d={id:c.pointerId,type:f(c),isPrimary:c.isPrimary,currentPos:g(c),currentTime:a.now()},W(b,c,[d],c.button)&&(a.MouseTracker.unprefixedPointerEvents?c.currentTarget.setPointerCapture(c.pointerId):c.currentTarget.msSetPointerCapture(c.pointerId),a.stopEvent(c)),(b.clickHandler||b.dblClickHandler||b.pressHandler||b.dragHandler||b.dragEndHandler||b.pinchHandler)&&a.cancelEvent(c)}function P(b,c){var d;d={id:c.pointerId,type:f(c),isPrimary:c.isPrimary,currentPos:g(c),currentTime:a.now()},X(b,c,[d],c.button)&&(a.MouseTracker.unprefixedPointerEvents?c.currentTarget.releasePointerCapture(c.pointerId):c.currentTarget.msReleasePointerCapture(c.pointerId))}function Q(b,c){var d;d={id:c.pointerId,type:f(c),isPrimary:c.isPrimary,currentPos:g(c),currentTime:a.now()},Y(b,c,[d])}function R(a,b){var c;c={id:b.pointerId,type:f(b)},Z(a,b,[c])}function S(a,b){return b.hasOwnProperty("isPrimary")||(b.isPrimary=0===a.getLength()?!0:!1),b.speed=0,b.direction=0,b.contactPos=b.currentPos,b.contactTime=b.currentTime,b.lastPos=b.currentPos,b.lastTime=b.currentTime,a.add(b)}function T(a,b){var c,d;return a.getById(b.id)?(c=a.removeById(b.id),b.hasOwnProperty("isPrimary")||(d=a.getPrimary(),d||(d=a.getByIndex(0),d&&(d.isPrimary=!0)))):c=a.getLength(),c}function U(b,c,d){var e,f,g,h,j=b.getActivePointersListByType(d[0].type),k=d.length;for(e=0;k>e;e++)f=d[e],g=j.getById(f.id),g?(g.insideElement=!0,g.lastPos=g.currentPos,g.lastTime=g.currentTime,g.currentPos=f.currentPos,g.currentTime=f.currentTime,f=g):(f.captured=!1,f.insideElementPressed=!1,f.insideElement=!0,S(j,f)),b.enterHandler&&(h=b.enterHandler({eventSource:b,pointerType:f.type,position:i(f.currentPos,b.element),buttons:j.buttons,insideElementPressed:f.insideElementPressed,buttonDownAny:0!==j.buttons,isTouchEvent:"touch"===f.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),h===!1&&a.cancelEvent(c))}function V(b,c,d){var e,f,g,h,j=(_[b.hash],b.getActivePointersListByType(d[0].type)),k=d.length;for(e=0;k>e;e++)f=d[e],g=j.getById(f.id),g&&(g.captured?(g.insideElement=!1,g.lastPos=g.currentPos,g.lastTime=g.currentTime,g.currentPos=f.currentPos,g.currentTime=f.currentTime):T(j,g),f=g),b.exitHandler&&(h=b.exitHandler({eventSource:b,pointerType:f.type,position:i(f.currentPos,b.element),buttons:j.buttons,insideElementPressed:g?g.insideElementPressed:!1,buttonDownAny:0!==j.buttons,isTouchEvent:"touch"===f.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),h===!1&&a.cancelEvent(c))}function W(b,c,d,e){var f,g,h,k,l=_[b.hash],m=b.getActivePointersListByType(d[0].type),n=d.length;if("undefined"!=typeof c.buttons?m.buttons=c.buttons:0===e?m.buttons|=1:1===e?m.buttons|=4:2===e?m.buttons|=2:3===e?m.buttons|=8:4===e?m.buttons|=16:5===e&&(m.buttons|=32),0!==e&&1!==e)return!1;for(g=0;n>g;g++)h=d[g],k=m.getById(h.id),k?(k.captured=!0,k.insideElementPressed=!0,k.insideElement=!0,k.contactPos=h.currentPos,k.contactTime=h.currentTime,k.lastPos=k.currentPos,k.lastTime=k.currentTime,k.currentPos=h.currentPos,k.currentTime=h.currentTime,h=k):(h.captured=!0,h.insideElementPressed=!0,h.insideElement=!0,S(m,h)),m.contacts++,(b.dragHandler||b.dragEndHandler||b.pinchHandler)&&a.MouseTracker.gesturePointVelocityTracker.addPoint(b,h),1===m.contacts?b.pressHandler&&(f=b.pressHandler({eventSource:b,pointerType:h.type,position:i(h.contactPos,b.element),buttons:m.buttons,isTouchEvent:"touch"===h.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),f===!1&&a.cancelEvent(c)):2===m.contacts&&b.pinchHandler&&"touch"===h.type&&(l.pinchGPoints=m.asArray(),l.lastPinchDist=l.currentPinchDist=l.pinchGPoints[0].currentPos.distanceTo(l.pinchGPoints[1].currentPos),l.lastPinchCenter=l.currentPinchCenter=j(l.pinchGPoints[0].currentPos,l.pinchGPoints[1].currentPos));return!0}function X(b,c,d,e){var f,g,h,k,l,m,n,o=_[b.hash],p=b.getActivePointersListByType(d[0].type),q=d.length,r=!1,s=!1;if("undefined"!=typeof c.buttons?p.buttons=c.buttons:0===e?p.buttons^=-2:1===e?p.buttons^=-5:2===e?p.buttons^=-3:3===e?p.buttons^=-9:4===e?p.buttons^=-17:5===e&&(p.buttons^=-33),0!==e&&1!==e)return!1;for(k=0;q>k;k++)l=d[k],m=p.getById(l.id),m&&(m.captured&&(m.captured=!1,r=!0,s=!0),m.lastPos=m.currentPos,m.lastTime=m.currentTime,m.currentPos=l.currentPos,m.currentTime=l.currentTime,m.insideElement||T(p,m),g=m.currentPos,h=m.currentTime,s?(p.contacts--,(b.dragHandler||b.dragEndHandler||b.pinchHandler)&&a.MouseTracker.gesturePointVelocityTracker.removePoint(b,m),0===p.contacts?(b.releaseHandler&&(f=b.releaseHandler({eventSource:b,pointerType:m.type,position:i(g,b.element),buttons:p.buttons,insideElementPressed:m.insideElementPressed,insideElementReleased:m.insideElement,isTouchEvent:"touch"===m.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),f===!1&&a.cancelEvent(c)),b.dragEndHandler&&!m.currentPos.equals(m.contactPos)&&(f=b.dragEndHandler({eventSource:b,pointerType:m.type,position:i(m.currentPos,b.element),speed:m.speed,direction:m.direction,shift:c.shiftKey,isTouchEvent:"touch"===m.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),f===!1&&a.cancelEvent(c)),(b.clickHandler||b.dblClickHandler)&&m.insideElement&&(n=h-m.contactTime<=b.clickTimeThreshold&&m.contactPos.distanceTo(g)<=b.clickDistThreshold,b.clickHandler&&(f=b.clickHandler({eventSource:b,pointerType:m.type,position:i(m.currentPos,b.element),quick:n,shift:c.shiftKey,isTouchEvent:"touch"===m.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),f===!1&&a.cancelEvent(c)),b.dblClickHandler&&n&&(p.clicks++,1===p.clicks?(o.lastClickPos=g,o.dblClickTimeOut=setTimeout(function(){p.clicks=0},b.dblClickTimeThreshold)):2===p.clicks&&(clearTimeout(o.dblClickTimeOut),p.clicks=0,o.lastClickPos.distanceTo(g)<=b.dblClickDistThreshold&&(f=b.dblClickHandler({eventSource:b,pointerType:m.type,position:i(m.currentPos,b.element),shift:c.shiftKey,isTouchEvent:"touch"===m.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),f===!1&&a.cancelEvent(c)),o.lastClickPos=null)))):2===p.contacts&&b.pinchHandler&&"touch"===m.type&&(o.pinchGPoints=p.asArray(),o.lastPinchDist=o.currentPinchDist=o.pinchGPoints[0].currentPos.distanceTo(o.pinchGPoints[1].currentPos),o.lastPinchCenter=o.currentPinchCenter=j(o.pinchGPoints[0].currentPos,o.pinchGPoints[1].currentPos))):b.releaseHandler&&(f=b.releaseHandler({eventSource:b,pointerType:m.type,position:i(g,b.element),buttons:p.buttons,insideElementPressed:m.insideElementPressed,insideElementReleased:m.insideElement,isTouchEvent:"touch"===m.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),f===!1&&a.cancelEvent(c)));
return r}function Y(b,c,d){var e,f,g,h,k,l,m=_[b.hash],n=b.getActivePointersListByType(d[0].type),o=d.length;for("undefined"!=typeof c.buttons&&(n.buttons=c.buttons),e=0;o>e;e++)f=d[e],g=n.getById(f.id),g?(f.hasOwnProperty("isPrimary")&&(g.isPrimary=f.isPrimary),g.lastPos=g.currentPos,g.lastTime=g.currentTime,g.currentPos=f.currentPos,g.currentTime=f.currentTime):(f.captured=!1,f.insideElementPressed=!1,f.insideElement=!0,S(n,f));b.stopHandler&&"mouse"===d[0].type&&(clearTimeout(b.stopTimeOut),b.stopTimeOut=setTimeout(function(){$(b,c,d[0].type)},b.stopDelay)),0===n.contacts?b.moveHandler&&(l=b.moveHandler({eventSource:b,pointerType:d[0].type,position:i(d[0].currentPos,b.element),buttons:n.buttons,isTouchEvent:"touch"===d[0].type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),l===!1&&a.cancelEvent(c)):1===n.contacts?(b.moveHandler&&(g=n.asArray()[0],l=b.moveHandler({eventSource:b,pointerType:g.type,position:i(g.currentPos,b.element),buttons:n.buttons,isTouchEvent:"touch"===g.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),l===!1&&a.cancelEvent(c)),b.dragHandler&&(g=n.asArray()[0],k=g.currentPos.minus(g.lastPos),l=b.dragHandler({eventSource:b,pointerType:g.type,position:i(g.currentPos,b.element),buttons:n.buttons,delta:k,speed:g.speed,direction:g.direction,shift:c.shiftKey,isTouchEvent:"touch"===g.type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),l===!1&&a.cancelEvent(c))):2===n.contacts&&(b.moveHandler&&(h=n.asArray(),l=b.moveHandler({eventSource:b,pointerType:h[0].type,position:i(j(h[0].currentPos,h[1].currentPos),b.element),buttons:n.buttons,isTouchEvent:"touch"===h[0].type,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),l===!1&&a.cancelEvent(c)),b.pinchHandler&&"touch"===d[0].type&&(k=m.pinchGPoints[0].currentPos.distanceTo(m.pinchGPoints[1].currentPos),k!=m.currentPinchDist&&(m.lastPinchDist=m.currentPinchDist,m.currentPinchDist=k,m.lastPinchCenter=m.currentPinchCenter,m.currentPinchCenter=j(m.pinchGPoints[0].currentPos,m.pinchGPoints[1].currentPos),l=b.pinchHandler({eventSource:b,pointerType:"touch",gesturePoints:m.pinchGPoints,lastCenter:i(m.lastPinchCenter,b.element),center:i(m.currentPinchCenter,b.element),lastDistance:m.lastPinchDist,distance:m.currentPinchDist,shift:c.shiftKey,originalEvent:c,preventDefaultAction:!1,userData:b.userData}),l===!1&&a.cancelEvent(c))))}function Z(a,b,c){X(a,b,c,0),V(a,b,c)}function $(a,b,c){a.stopHandler&&a.stopHandler({eventSource:a,pointerType:c,position:h(b,a.element),buttons:a.getActivePointersListByType(c).buttons,isTouchEvent:"touch"===c,originalEvent:b,preventDefaultAction:!1,userData:a.userData})}var _={};a.MouseTracker=function(b){var c=arguments;a.isPlainObject(b)||(b={element:c[0],clickTimeThreshold:c[1],clickDistThreshold:c[2]}),this.hash=Math.random(),this.element=a.getElement(b.element),this.clickTimeThreshold=b.clickTimeThreshold,this.clickDistThreshold=b.clickDistThreshold,this.dblClickTimeThreshold=b.dblClickTimeThreshold,this.dblClickDistThreshold=b.dblClickDistThreshold,this.userData=b.userData||null,this.stopDelay=b.stopDelay||50,this.enterHandler=b.enterHandler||null,this.exitHandler=b.exitHandler||null,this.pressHandler=b.pressHandler||null,this.releaseHandler=b.releaseHandler||null,this.moveHandler=b.moveHandler||null,this.scrollHandler=b.scrollHandler||null,this.clickHandler=b.clickHandler||null,this.dblClickHandler=b.dblClickHandler||null,this.dragHandler=b.dragHandler||null,this.dragEndHandler=b.dragEndHandler||null,this.pinchHandler=b.pinchHandler||null,this.stopHandler=b.stopHandler||null,this.keyHandler=b.keyHandler||null,this.focusHandler=b.focusHandler||null,this.blurHandler=b.blurHandler||null;var d=this;_[this.hash]={click:function(a){k(d,a)},dblclick:function(a){l(d,a)},keypress:function(a){m(d,a)},focus:function(a){n(d,a)},blur:function(a){o(d,a)},wheel:function(a){p(d,a)},mousewheel:function(a){q(d,a)},DOMMouseScroll:function(a){q(d,a)},MozMousePixelScroll:function(a){q(d,a)},mouseover:function(a){t(d,a)},mouseout:function(a){u(d,a)},mouseenter:function(a){v(d,a)},mouseleave:function(a){w(d,a)},mousedown:function(a){x(d,a)},mouseup:function(a){y(d,a)},mouseupcaptured:function(a){z(d,a)},mousemove:function(a){B(d,a)},mousemovecaptured:function(a){C(d,a)},touchenter:function(a){E(d,a)},touchleave:function(a){F(d,a)},touchstart:function(a){G(d,a)},touchend:function(a){H(d,a)},touchmove:function(a){I(d,a)},touchcancel:function(a){J(d,a)},gesturestart:function(a){K(d,a)},gesturechange:function(a){L(d,a)},pointerenter:function(a){M(d,a)},MSPointerEnter:function(a){M(d,a)},pointerleave:function(a){N(d,a)},MSPointerLeave:function(a){N(d,a)},pointerdown:function(a){O(d,a)},MSPointerDown:function(a){O(d,a)},pointerup:function(a){P(d,a)},MSPointerUp:function(a){P(d,a)},pointermove:function(a){Q(d,a)},MSPointerMove:function(a){Q(d,a)},pointercancel:function(a){R(d,a)},MSPointerCancel:function(a){R(d,a)},tracking:!1,activePointersLists:[],capturing:!1,lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null}},a.MouseTracker.prototype={destroy:function(){c(this),this.element=null,_[this.hash]=null,delete _[this.hash]},isTracking:function(){return _[this.hash].tracking},setTracking:function(a){return a?b(this):c(this),this},getActivePointersListByType:function(b){var c,d,e=_[this.hash],f=e.activePointersLists.length;for(c=0;f>c;c++)if(e.activePointersLists[c].type===b)return e.activePointersLists[c];return d=new a.MouseTracker.GesturePointList(b),e.activePointersLists.push(d),d},enterHandler:function(){},exitHandler:function(){},pressHandler:function(){},releaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}},a.MouseTracker.gesturePointVelocityTracker=function(){var b=[],c=0,d=0,e=function(a,b){return a.hash.toString()+b.type+b.id.toString()},f=function(){var c,e,f,g,h,i,j=b.length,k=a.now();for(g=k-d,d=k,c=0;j>c;c++)e=b[c],f=e.gPoint,f.direction=Math.atan2(f.currentPos.y-e.lastPos.y,f.currentPos.x-e.lastPos.x),h=e.lastPos.distanceTo(f.currentPos),e.lastPos=f.currentPos,i=1e3*h/(g+1),f.speed=.75*i+.25*f.speed},g=function(g,h){var i=e(g,h);b.push({guid:i,gPoint:h,lastPos:h.currentPos}),1===b.length&&(d=a.now(),c=window.setInterval(f,50))},h=function(a,d){var f,g=e(a,d),h=b.length;for(f=0;h>f;f++)if(b[f].guid===g){b.splice(f,1),h--,0===h&&window.clearInterval(c);break}};return{addPoint:g,removePoint:h}}(),a.MouseTracker.wheelEventName=a.Browser.vendor==a.BROWSERS.IE&&a.Browser.version>8||"onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll",a.MouseTracker.supportsMouseCapture=function(){var b=document.createElement("div");return a.isFunction(b.setCapture)&&a.isFunction(b.releaseCapture)}(),a.MouseTracker.subscribeEvents=["click","dblclick","keypress","focus","blur",a.MouseTracker.wheelEventName],"DOMMouseScroll"==a.MouseTracker.wheelEventName&&a.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(a.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerdown","pointerup","pointermove","pointercancel"),a.MouseTracker.unprefixedPointerEvents=!0,a.MouseTracker.maxTouchPoints=navigator.maxTouchPoints?navigator.maxTouchPoints:0,a.MouseTracker.haveTouchEnter=!0,a.MouseTracker.haveMouseEnter=!0):window.MSPointerEvent?(a.MouseTracker.subscribeEvents.push("MSPointerEnter","MSPointerLeave","MSPointerDown","MSPointerUp","MSPointerMove","MSPointerCancel"),a.MouseTracker.unprefixedPointerEvents=!1,a.MouseTracker.maxTouchPoints=navigator.msMaxTouchPoints?navigator.msMaxTouchPoints:0,a.MouseTracker.haveTouchEnter=!0,a.MouseTracker.haveMouseEnter=!0):(a.MouseTracker.subscribeEvents.push("mouseover","mouseout","mousedown","mouseup","mousemove"),a.MouseTracker.haveMouseEnter=!1,"ontouchstart"in window?(a.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ontouchenter"in window?(a.MouseTracker.subscribeEvents.push("touchenter","touchleave"),a.MouseTracker.haveTouchEnter=!0):a.MouseTracker.haveTouchEnter=!1):a.MouseTracker.haveTouchEnter=!1,"ongesturestart"in window&&a.MouseTracker.subscribeEvents.push("gesturestart","gesturechange"),a.MouseTracker.mousePointerId="legacy-mouse",a.MouseTracker.maxTouchPoints=10),a.MouseTracker.GesturePointList=function(a){this._gPoints=[],this.type=a,this.buttons=0,this.contacts=0,this.clicks=0},a.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(a){return this._gPoints.push(a)},removeById:function(a){var b,c=this._gPoints.length;for(b=0;c>b;b++)if(this._gPoints[b].id===a){this._gPoints.splice(b,1);break}return this._gPoints.length},getByIndex:function(a){return a<this._gPoints.length?this._gPoints[a]:null},getById:function(a){var b,c=this._gPoints.length;for(b=0;c>b;b++)if(this._gPoints[b].id===a)return this._gPoints[b];return null},getPrimary:function(){var a,b=this._gPoints.length;for(a=0;b>a;a++)if(this._gPoints[a].isPrimary)return this._gPoints[a];return null}}}(OpenSeadragon),function(a){a.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},a.Control=function(b,c,d){var e=b.parentNode;"number"==typeof c&&(a.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),c={anchor:c}),c.attachToViewer="undefined"==typeof c.attachToViewer?!0:c.attachToViewer,this.autoFade="undefined"==typeof c.autoFade?!0:c.autoFade,this.element=b,this.anchor=c.anchor,this.container=d,this.anchor==a.ControlAnchor.ABSOLUTE?(this.wrapper=a.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top="number"==typeof c.top?c.top+"px":c.top,this.wrapper.style.left="number"==typeof c.left?c.left+"px":c.left,this.wrapper.style.height="number"==typeof c.height?c.height+"px":c.height,this.wrapper.style.width="number"==typeof c.width?c.width+"px":c.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=a.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor==a.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),c.attachToViewer?this.anchor==a.ControlAnchor.TOP_RIGHT||this.anchor==a.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):e.appendChild(this.wrapper)},a.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.container.removeChild(this.wrapper)},isVisible:function(){return"none"!=this.wrapper.style.display},setVisible:function(b){this.wrapper.style.display=b?this.anchor==a.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(b){this.element[a.SIGNAL]&&a.Browser.vendor==a.BROWSERS.IE?a.setElementOpacity(this.element,b,!0):a.setElementOpacity(this.wrapper,b,!0)}}}(OpenSeadragon),function(a){function b(a,b){var c,d=a.controls;for(c=d.length-1;c>=0;c--)if(d[c].element==b)return c;return-1}a.ControlDock=function(b){var c,d,e=["topleft","topright","bottomright","bottomleft"];for(a.extend(!0,this,{id:"controldock-"+a.now()+"-"+Math.floor(1e6*Math.random()),container:a.makeNeutralElement("div"),controls:[]},b),this.container.onsubmit=function(){return!1},this.element&&(this.element=a.getElement(this.element),this.element.appendChild(this.container),this.element.style.position="relative",this.container.style.width="100%",this.container.style.height="100%"),d=0;d<e.length;d++)c=e[d],this.controls[c]=a.makeNeutralElement("div"),this.controls[c].style.position="absolute",c.match("left")&&(this.controls[c].style.left="0px"),c.match("right")&&(this.controls[c].style.right="0px"),c.match("top")&&(this.controls[c].style.top="0px"),c.match("bottom")&&(this.controls[c].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},a.ControlDock.prototype={addControl:function(c,d){c=a.getElement(c);var e=null;if(!(b(this,c)>=0)){switch(d.anchor){case a.ControlAnchor.TOP_RIGHT:e=this.controls.topright,c.style.position="relative",c.style.paddingRight="0px",c.style.paddingTop="0px";break;case a.ControlAnchor.BOTTOM_RIGHT:e=this.controls.bottomright,c.style.position="relative",c.style.paddingRight="0px",c.style.paddingBottom="0px";break;case a.ControlAnchor.BOTTOM_LEFT:e=this.controls.bottomleft,c.style.position="relative",c.style.paddingLeft="0px",c.style.paddingBottom="0px";break;case a.ControlAnchor.TOP_LEFT:e=this.controls.topleft,c.style.position="relative",c.style.paddingLeft="0px",c.style.paddingTop="0px";break;case a.ControlAnchor.ABSOLUTE:e=this.container,c.style.margin="0px",c.style.padding="0px";break;default:case a.ControlAnchor.NONE:e=this.container,c.style.margin="0px",c.style.padding="0px"}this.controls.push(new a.Control(c,d,e)),c.style.display="inline-block"}},removeControl:function(c){c=a.getElement(c);var d=b(this,c);return d>=0&&(this.controls[d].destroy(),this.controls.splice(d,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var a;for(a=this.controls.length-1;a>=0;a--)if(this.controls[a].isVisible())return!0;return!1},setControlsEnabled:function(a){var b;for(b=this.controls.length-1;b>=0;b--)this.controls[b].setVisible(a);return this}}}(OpenSeadragon),function($){function _getSafeElemSize(a){return a=$.getElement(a),new $.Point(0===a.clientWidth?1:a.clientWidth,0===a.clientHeight?1:a.clientHeight)}function getTileSourceImplementation(viewer,tileSource,successCallback,failCallback){var _this=viewer;"string"==$.type(tileSource)&&(tileSource.match(/\s*<.*/)?tileSource=$.parseXml(tileSource):tileSource.match(/\s*[\{\[].*/)&&(tileSource=eval("("+tileSource+")"))),setTimeout(function(){if("string"==$.type(tileSource))tileSource=new $.TileSource(tileSource,function(a){successCallback(a.tileSource)}),tileSource.addHandler("open-failed",function(a){failCallback(a)});else if($.isPlainObject(tileSource)||tileSource.nodeType)if($.isFunction(tileSource.getTileUrl)){var a=new $.TileSource(tileSource);a.getTileUrl=tileSource.getTileUrl,successCallback(a)}else{var b=$.TileSource.determineType(_this,tileSource);if(!b)return void failCallback({message:"Unable to load TileSource",source:tileSource});var c=b.prototype.configure.apply(_this,[tileSource]),d=new b(c);successCallback(d)}else successCallback(tileSource)},1)}function openTileSource(a,b){var c,d=a;return d.source&&d.close(),THIS[d.hash].prevContainerSize=_getSafeElemSize(d.container),d.collectionMode?(d.source=new $.TileSourceCollection({rows:d.collectionRows,layout:d.collectionLayout,tileSize:d.collectionTileSize,tileSources:d.tileSources,tileMargin:d.collectionTileMargin}),d.viewport=d.viewport?d.viewport:new $.Viewport({collectionMode:!0,collectionTileSource:d.source,containerSize:THIS[d.hash].prevContainerSize,contentSize:d.source.dimensions,springStiffness:d.springStiffness,animationTime:d.animationTime,showNavigator:!1,minZoomImageRatio:1,maxZoomPixelRatio:1,viewer:d,degrees:d.degrees})):(b&&(d.source=b),d.viewport=d.viewport?d.viewport:new $.Viewport({containerSize:THIS[d.hash].prevContainerSize,contentSize:d.source.dimensions,springStiffness:d.springStiffness,animationTime:d.animationTime,minZoomImageRatio:d.minZoomImageRatio,maxZoomPixelRatio:d.maxZoomPixelRatio,visibilityRatio:d.visibilityRatio,wrapHorizontal:d.wrapHorizontal,wrapVertical:d.wrapVertical,defaultZoomLevel:d.defaultZoomLevel,minZoomLevel:d.minZoomLevel,maxZoomLevel:d.maxZoomLevel,viewer:d,degrees:d.degrees})),d.preserveViewport&&d.viewport.resetContentSize(d.source.dimensions),d.source.overlays=d.source.overlays||[],d.drawer=new $.Drawer({viewer:d,source:d.source,viewport:d.viewport,element:d.drawersContainer,opacity:d.opacity,maxImageCacheCount:d.maxImageCacheCount,imageLoaderLimit:d.imageLoaderLimit,minZoomImageRatio:d.minZoomImageRatio,wrapHorizontal:d.wrapHorizontal,wrapVertical:d.wrapVertical,immediateRender:d.immediateRender,blendTime:d.blendTime,alwaysBlend:d.alwaysBlend,minPixelRatio:d.collectionMode?0:d.minPixelRatio,timeout:d.timeout,debugMode:d.debugMode,debugGridColor:d.debugGridColor,crossOriginPolicy:d.crossOriginPolicy}),d.drawers=[d.drawer],d.drawer.canRotate()||(d.rotateLeft&&(c=d.buttons.buttons.indexOf(d.rotateLeft),d.buttons.buttons.splice(c,1),d.buttons.element.removeChild(d.rotateLeft.element)),d.rotateRight&&(c=d.buttons.buttons.indexOf(d.rotateRight),d.buttons.buttons.splice(c,1),d.buttons.element.removeChild(d.rotateRight.element))),d.showNavigator&&!d.collectionMode&&(d.navigator?d.navigator.open(b):d.navigator=new $.Navigator({id:d.navigatorId,position:d.navigatorPosition,sizeRatio:d.navigatorSizeRatio,maintainSizeRatio:d.navigatorMaintainSizeRatio,top:d.navigatorTop,left:d.navigatorLeft,width:d.navigatorWidth,height:d.navigatorHeight,autoResize:d.navigatorAutoResize,tileSources:b,tileHost:d.tileHost,prefixUrl:d.prefixUrl,viewer:d})),d.showReferenceStrip&&!d.referenceStrip&&(d.referenceStrip=new $.ReferenceStrip({id:d.referenceStripElement,position:d.referenceStripPosition,sizeRatio:d.referenceStripSizeRatio,scroll:d.referenceStripScroll,height:d.referenceStripHeight,width:d.referenceStripWidth,tileSources:d.tileSources,tileHost:d.tileHost,prefixUrl:d.prefixUrl,viewer:d})),THIS[d.hash].animating=!1,THIS[d.hash].forceRedraw=!0,d._updateRequestId=scheduleUpdate(d,updateMulti),VIEWERS[d.hash]=d,loadOverlays(d),d.raiseEvent("open",{source:b}),d}function loadOverlays(a){a.currentOverlays=[];for(var b=0;b<a.overlays.length;b++)a.currentOverlays[b]=getOverlayObject(a,a.overlays[b]);for(var c=0;c<a.source.overlays.length;c++)a.currentOverlays[b+c]=getOverlayObject(a,a.source.overlays[c])}function getOverlayObject(a,b){if(b instanceof $.Overlay)return b;var c=null;if(b.element)c=$.getElement(b.element);else{var d=b.id?b.id:"openseadragon-overlay-"+Math.floor(1e7*Math.random());c=$.getElement(b.id),c||(c=document.createElement("a"),c.href="#/overlay/"+d),c.id=d,$.addClass(c,b.className?b.className:"openseadragon-overlay")}var e=b.location;e||(e=b.width&&b.height?void 0!==b.px?a.viewport.imageToViewportRectangle(new $.Rect(b.px,b.py,b.width,b.height)):new $.Rect(b.x,b.y,b.width,b.height):void 0!==b.px?a.viewport.imageToViewportCoordinates(new $.Point(b.px,b.py)):new $.Point(b.x,b.y));var f=b.placement;return f&&"string"===$.type(f)&&(f=$.OverlayPlacement[b.placement.toUpperCase()]),new $.Overlay({element:c,location:e,placement:f,onDraw:b.onDraw,checkResize:b.checkResize})}function getOverlayIndex(a,b){var c;for(c=a.length-1;c>=0;c--)if(a[c].element===b)return c;return-1}function drawOverlays(a,b,c){var d,e=b.length;for(d=0;e>d;d++)b[d].drawHTML(c,a)}function scheduleUpdate(a,b){return $.requestAnimationFrame(function(){b(a)})}function scheduleControlsFade(a){$.requestAnimationFrame(function(){updateControlsFade(a)})}function beginControlsAutoHide(a){a.autoHideControls&&(a.controlsShouldFade=!0,a.controlsFadeBeginTime=$.now()+a.controlsFadeDelay,window.setTimeout(function(){scheduleControlsFade(a)},a.controlsFadeDelay))}function updateControlsFade(a){var b,c,d,e;if(a.controlsShouldFade){for(b=$.now(),c=b-a.controlsFadeBeginTime,d=1-c/a.controlsFadeLength,d=Math.min(1,d),d=Math.max(0,d),e=a.controls.length-1;e>=0;e--)a.controls[e].autoFade&&a.controls[e].setOpacity(d);d>0&&scheduleControlsFade(a)}}function abortControlsAutoHide(a){var b;for(a.controlsShouldFade=!1,b=a.controls.length-1;b>=0;b--)a.controls[b].setOpacity(1)}function onFocus(){abortControlsAutoHide(this)}function onBlur(){beginControlsAutoHide(this)}function onCanvasClick(a){var b;!a.preventDefaultAction&&this.viewport&&a.quick&&(b=this.gestureSettingsByDeviceType(a.pointerType),b.clickToZoom&&(this.viewport.zoomBy(a.shift?1/this.zoomPerClick:this.zoomPerClick,this.viewport.pointFromPixel(a.position,!0)),this.viewport.applyConstraints())),this.raiseEvent("canvas-click",{tracker:a.eventSource,position:a.position,quick:a.quick,shift:a.shift,originalEvent:a.originalEvent})}function onCanvasDblClick(a){var b;!a.preventDefaultAction&&this.viewport&&(b=this.gestureSettingsByDeviceType(a.pointerType),b.dblClickToZoom&&(this.viewport.zoomBy(a.shift?1/this.zoomPerClick:this.zoomPerClick,this.viewport.pointFromPixel(a.position,!0)),this.viewport.applyConstraints())),this.raiseEvent("canvas-double-click",{tracker:a.eventSource,position:a.position,shift:a.shift,originalEvent:a.originalEvent})}function onCanvasDrag(a){var b;!a.preventDefaultAction&&this.viewport&&(b=this.gestureSettingsByDeviceType(a.pointerType),this.panHorizontal||(a.delta.x=0),this.panVertical||(a.delta.y=0),this.viewport.panBy(this.viewport.deltaPointsFromPixels(a.delta.negate()),b.flickEnabled),this.constrainDuringPan&&this.viewport.applyConstraints()),this.raiseEvent("canvas-drag",{tracker:a.eventSource,position:a.position,delta:a.delta,speed:a.speed,direction:a.direction,shift:a.shift,originalEvent:a.originalEvent})}function onCanvasDragEnd(a){var b;if(!a.preventDefaultAction&&this.viewport&&(b=this.gestureSettingsByDeviceType(a.pointerType),b.flickEnabled&&a.speed>=b.flickMinSpeed)){var c=b.flickMomentum*a.speed*Math.cos(a.direction),d=b.flickMomentum*a.speed*Math.sin(a.direction),e=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),f=this.viewport.pointFromPixel(new $.Point(e.x-c,e.y-d));this.panHorizontal||(f.x=e.x),this.panVertical||(f.y=e.y),this.viewport.panTo(f,!1),this.viewport.applyConstraints()}this.raiseEvent("canvas-drag-end",{tracker:a.eventSource,position:a.position,speed:a.speed,direction:a.direction,shift:a.shift,originalEvent:a.originalEvent})}function onCanvasRelease(a){var b;a.insideElementPressed&&this.viewport&&(b=this.gestureSettingsByDeviceType(a.pointerType),b.flickEnabled||this.viewport.applyConstraints()),this.raiseEvent("canvas-release",{tracker:a.eventSource,position:a.position,insideElementPressed:a.insideElementPressed,insideElementReleased:a.insideElementReleased,originalEvent:a.originalEvent})}function onCanvasPinch(a){var b,c,d,e;return!a.preventDefaultAction&&this.viewport&&(b=this.gestureSettingsByDeviceType(a.pointerType),b.pinchToZoom&&(c=this.viewport.pointFromPixel(a.center,!0),d=this.viewport.pointFromPixel(a.lastCenter,!0),e=d.minus(c),this.panHorizontal||(e.x=0),this.panVertical||(e.y=0),this.viewport.zoomBy(a.distance/a.lastDistance,c,!0),this.viewport.panBy(e,!0),this.viewport.applyConstraints())),this.raiseEvent("canvas-pinch",{tracker:a.eventSource,gesturePoints:a.gesturePoints,lastCenter:a.lastCenter,center:a.center,lastDistance:a.lastDistance,distance:a.distance,shift:a.shift,originalEvent:a.originalEvent}),!1}function onCanvasScroll(a){var b,c;return!a.preventDefaultAction&&this.viewport&&(b=this.gestureSettingsByDeviceType(a.pointerType),b.scrollToZoom&&(c=Math.pow(this.zoomPerScroll,a.scroll),this.viewport.zoomBy(c,this.viewport.pointFromPixel(a.position,!0)),this.viewport.applyConstraints())),this.raiseEvent("canvas-scroll",{tracker:a.eventSource,position:a.position,scroll:a.scroll,shift:a.shift,originalEvent:a.originalEvent}),!1}function onContainerExit(a){a.insideElementPressed||(THIS[this.hash].mouseInside=!1,THIS[this.hash].animating||beginControlsAutoHide(this)),this.raiseEvent("container-exit",{tracker:a.eventSource,position:a.position,buttons:a.buttons,insideElementPressed:a.insideElementPressed,buttonDownAny:a.buttonDownAny,originalEvent:a.originalEvent})}function onContainerPress(a){"touch"!==a.pointerType||$.MouseTracker.haveTouchEnter||(THIS[this.hash].mouseInside=!0,abortControlsAutoHide(this))}function onContainerRelease(a){(!a.insideElementReleased||"touch"===a.pointerType&&!$.MouseTracker.haveTouchEnter)&&(THIS[this.hash].mouseInside=!1,THIS[this.hash].animating||beginControlsAutoHide(this)),this.raiseEvent("container-release",{tracker:a.eventSource,position:a.position,insideElementPressed:a.insideElementPressed,insideElementReleased:a.insideElementReleased,originalEvent:a.originalEvent})}function onContainerEnter(a){THIS[this.hash].mouseInside=!0,abortControlsAutoHide(this),this.raiseEvent("container-enter",{tracker:a.eventSource,position:a.position,buttons:a.buttons,insideElementPressed:a.insideElementPressed,buttonDownAny:a.buttonDownAny,originalEvent:a.originalEvent})}function updateMulti(a){return a.source?(updateOnce(a),void(a.source&&(a._updateRequestId=scheduleUpdate(a,updateMulti)))):void(a._updateRequestId=null)}function updateOnce(a){var b,c;if(a.source){if(a.autoResize&&(b=_getSafeElemSize(a.container),!b.equals(THIS[a.hash].prevContainerSize))){var d=a.viewport.getBounds(),e=a.viewport.getCenter();resizeViewportAndRecenter(a,b,d,e),THIS[a.hash].prevContainerSize=b,THIS[a.hash].forceRedraw=!0}c=a.viewport.update(),a.referenceStrip&&(c=a.referenceStrip.update(a.viewport)||c),!THIS[a.hash].animating&&c&&(a.raiseEvent("animation-start"),abortControlsAutoHide(a)),c?(updateDrawers(a),drawOverlays(a.viewport,a.currentOverlays,a.overlaysContainer),a.navigator&&a.navigator.update(a.viewport),a.raiseEvent("animation")):(THIS[a.hash].forceRedraw||drawersNeedUpdate(a))&&(updateDrawers(a),drawOverlays(a.viewport,a.currentOverlays,a.overlaysContainer),a.navigator&&a.navigator.update(a.viewport),THIS[a.hash].forceRedraw=!1),THIS[a.hash].animating&&!c&&(a.raiseEvent("animation-finish"),THIS[a.hash].mouseInside||beginControlsAutoHide(a)),THIS[a.hash].animating=c}}function resizeViewportAndRecenter(a,b,c,d){var e=a.viewport;e.resize(b,!0);var f=1/a.source.aspectRatio,g=c.width<=1?c.width:1,h=c.height<=f?c.height:f,i=new $.Rect(d.x-g/2,d.y-h/2,g,h);e.fitBounds(i,!0)}function updateDrawers(a){for(var b=0;b<a.drawers.length;b++)a.drawers[b].update()}function drawersNeedUpdate(a){for(var b=0;b<a.drawers.length;b++)if(a.drawers[b].needsUpdate())return!0;return!1}function resolveUrl(a,b){return a?a+b:b}function beginZoomingIn(){THIS[this.hash].lastZoomTime=$.now(),THIS[this.hash].zoomFactor=this.zoomPerSecond,THIS[this.hash].zooming=!0,scheduleZoom(this)}function beginZoomingOut(){THIS[this.hash].lastZoomTime=$.now(),THIS[this.hash].zoomFactor=1/this.zoomPerSecond,THIS[this.hash].zooming=!0,scheduleZoom(this)}function endZooming(){THIS[this.hash].zooming=!1}function scheduleZoom(a){$.requestAnimationFrame($.delegate(a,doZoom))}function doZoom(){var a,b,c;THIS[this.hash].zooming&&this.viewport&&(a=$.now(),b=a-THIS[this.hash].lastZoomTime,c=Math.pow(THIS[this.hash].zoomFactor,b/1e3),this.viewport.zoomBy(c),this.viewport.applyConstraints(),THIS[this.hash].lastZoomTime=a,scheduleZoom(this))}function doSingleZoomIn(){this.viewport&&(THIS[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function doSingleZoomOut(){this.viewport&&(THIS[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function lightUp(){this.buttons.emulateEnter(),this.buttons.emulateExit()}function onHome(){this.viewport&&this.viewport.goHome()}function onFullScreen(){this.isFullPage()&&!$.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttons&&this.buttons.emulateExit(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function onRotateLeft(){if(this.viewport){var a=this.viewport.getRotation();0===a?a=270:a-=90,this.viewport.setRotation(a)}}function onRotateRight(){if(this.viewport){var a=this.viewport.getRotation();270===a?a=0:a+=90,this.viewport.setRotation(a)}}function onPrevious(){var a=THIS[this.hash].sequence-1;this.navPrevNextWrap&&0>a&&(a+=this.tileSources.length),this.goToPage(a)}function onNext(){var a=THIS[this.hash].sequence+1;this.navPrevNextWrap&&a>=this.tileSources.length&&(a=0),this.goToPage(a)}var THIS={},VIEWERS={};$.Viewer=function(a){var b,c=arguments,d=this;if($.isPlainObject(a)||(a={id:c[0],xmlPath:c.length>1?c[1]:void 0,prefixUrl:c.length>2?c[2]:void 0,controls:c.length>3?c[3]:void 0,overlays:c.length>4?c[4]:void 0}),a.config&&($.extend(!0,a,a.config),delete a.config),$.extend(!0,this,{id:a.id,hash:a.hash||a.id,element:null,container:null,keyboardCommandArea:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,drawers:[],drawersContainer:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttons:null,profiler:null},$.DEFAULT_SETTINGS,a),"undefined"==typeof this.hash)throw new Error("A hash must be defined, either by specifying options.id or options.hash.");"undefined"!=typeof THIS[this.hash]&&$.console.warn("Hash "+this.hash+" has already been used."),THIS[this.hash]={fsBoundsDelta:new $.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,sequenced:!1,sequence:0,fullPage:!1,onfullscreenchange:null},this._updateRequestId=null,this.currentOverlays=[],$.EventSource.call(this),this.addHandler("open-failed",function(a){var b=$.getString("Errors.OpenFailed",a.eventSource,a.message);d._showMessage(b)}),$.ControlDock.call(this,a);var e;for(this.xmlPath&&(this.tileSources=[this.xmlPath]),this.tileSources&&($.isArray(this.tileSources)?(this.tileSources.length>1&&(THIS[this.hash].sequenced=!0),this.initialPage>this.tileSources.length-1&&(this.initialPage=this.tileSources.length-1),e=this.tileSources[this.initialPage],THIS[this.hash].sequence=this.initialPage):e=this.tileSources),this.element=this.element||document.getElementById(this.id),this.canvas=$.makeNeutralElement("div"),this.keyboardCommandArea=$.makeNeutralElement("textarea"),this.drawersContainer=$.makeNeutralElement("div"),this.overlaysContainer=$.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(a){a.width="100%",a.height="100%",a.overflow="hidden",a.position="absolute",a.top="0px",a.left="0px",void 0!==a["touch-action"]?a["touch-action"]="none":void 0!==a["-ms-touch-action"]&&(a["-ms-touch-action"]="none")}(this.canvas.style),this.container.className="openseadragon-container",function(a){a.width="100%",a.height="100%",a.position="relative",a.overflow="hidden",a.left="0px",a.top="0px",a.textAlign="left"}(this.container.style),this.keyboardCommandArea.className="keyboard-command-area",function(a){a.width="100%",a.height="100%",a.overflow="hidden",a.position="absolute",a.top="0px",a.left="0px",a.resize="none"}(this.keyboardCommandArea.style),this.container.insertBefore(this.canvas,this.container.firstChild),this.container.insertBefore(this.keyboardCommandArea,this.container.firstChild),this.element.appendChild(this.container),this.canvas.appendChild(this.drawersContainer),this.canvas.appendChild(this.overlaysContainer),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.keyboardCommandArea.innerTracker=new $.MouseTracker({_this:this,element:this.keyboardCommandArea,focusHandler:function(a){if(!a.preventDefaultAction){var b=$.getElementPosition(this.element);window.scrollTo(0,b.y)}},keyHandler:function(a){if(!a.preventDefaultAction)switch(a.keyCode){case 61:return d.viewport.zoomBy(1.1),d.viewport.applyConstraints(),!1;case 45:return d.viewport.zoomBy(.9),d.viewport.applyConstraints(),!1;case 48:return d.viewport.goHome(),d.viewport.applyConstraints(),!1;case 119:case 87:case 38:return a.shift?d.viewport.zoomBy(1.1):d.viewport.panBy(new $.Point(0,-.05)),d.viewport.applyConstraints(),!1;
case 115:case 83:case 40:return a.shift?d.viewport.zoomBy(.9):d.viewport.panBy(new $.Point(0,.05)),d.viewport.applyConstraints(),!1;case 97:case 37:return d.viewport.panBy(new $.Point(-.05,0)),d.viewport.applyConstraints(),!1;case 100:case 39:return d.viewport.panBy(new $.Point(.05,0)),d.viewport.applyConstraints(),!1;default:return!0}}}).setTracking(!0),this.innerTracker=new $.MouseTracker({element:this.canvas,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,clickHandler:$.delegate(this,onCanvasClick),dblClickHandler:$.delegate(this,onCanvasDblClick),dragHandler:$.delegate(this,onCanvasDrag),dragEndHandler:$.delegate(this,onCanvasDragEnd),releaseHandler:$.delegate(this,onCanvasRelease),scrollHandler:$.delegate(this,onCanvasScroll),pinchHandler:$.delegate(this,onCanvasPinch)}).setTracking(this.mouseNavEnabled?!0:!1),this.outerTracker=new $.MouseTracker({element:this.container,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:$.delegate(this,onContainerEnter),exitHandler:$.delegate(this,onContainerExit),pressHandler:$.delegate(this,onContainerPress),releaseHandler:$.delegate(this,onContainerRelease)}).setTracking(this.mouseNavEnabled?!0:!1),this.toolbar&&(this.toolbar=new $.ControlDock({element:this.toolbar})),this.bindStandardControls(),this.bindSequenceControls(),e&&(this.open(e),this.tileSources.length>1&&this._updateSequenceButtons(this.initialPage)),b=0;b<this.customControls.length;b++)this.addControl(this.customControls[b].id,{anchor:this.customControls[b].anchor});$.requestAnimationFrame(function(){beginControlsAutoHide(d)})},$.extend($.Viewer.prototype,$.EventSource.prototype,$.ControlDock.prototype,{isOpen:function(){return!!this.source},openDzi:function(a){return this.open(a)},openTileSource:function(a){return this.open(a)},open:function(a){var b=this;return b._hideMessage(),getTileSourceImplementation(b,a,function(a){openTileSource(b,a)},function(a){b.raiseEvent("open-failed",a)}),this},close:function(){return THIS[this.hash]?(null!==this._updateRequestId&&($.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.navigator&&this.navigator.close(),this.clearOverlays(),this.drawersContainer.innerHTML="",this.overlaysContainer.innerHTML="",this.drawer&&this.drawer.destroy(),this.source=null,this.drawer=null,this.drawers=[],this.viewport=this.preserveViewport?this.viewport:null,VIEWERS[this.hash]=null,delete VIEWERS[this.hash],this.raiseEvent("close"),this):this},destroy:function(){if(this.close(),this.removeAllHandlers(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.keyboardCommandArea&&this.keyboardCommandArea.innerTracker.destroy(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),THIS[this.hash]=null,delete THIS[this.hash],this.canvas=null,this.keyboardCommandArea=null,this.container=null,this.element=null},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(a){return this.innerTracker.setTracking(a),this.raiseEvent("mouse-enabled",{enabled:a}),this},areControlsEnabled:function(){var a,b=this.controls.length;for(a=0;a<this.controls.length;a++)b=b&&this.controls[a].isVisibile();return b},setControlsEnabled:function(a){return a?abortControlsAutoHide(this):beginControlsAutoHide(this),this.raiseEvent("controls-enabled",{enabled:a}),this},isFullPage:function(){return THIS[this.hash].fullPage},setFullPage:function(a){var b,c,d=document.body,e=d.style,f=document.documentElement.style,g=this;if(a==this.isFullPage())return this;var h={fullPage:a,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",h),h.preventDefaultAction)return this;if(a){for(this.elementSize=$.getElementSize(this.element),this.pageScroll=$.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=e.margin,this.docMargin=f.margin,e.margin="0",f.margin="0",this.bodyPadding=e.padding,this.docPadding=f.padding,e.padding="0",f.padding="0",this.bodyWidth=e.width,this.bodyHeight=e.height,e.width="100%",e.height="100%",this.previousBody=[],THIS[this.hash].prevElementParent=this.element.parentNode,THIS[this.hash].prevNextSibling=this.element.nextSibling,THIS[this.hash].prevElementWidth=this.element.style.width,THIS[this.hash].prevElementHeight=this.element.style.height,b=d.childNodes.length,c=0;b>c;c++)this.previousBody.push(d.childNodes[0]),d.removeChild(d.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,d.appendChild(this.toolbar.element),$.addClass(this.toolbar.element,"fullpage")),$.addClass(this.element,"fullpage"),d.appendChild(this.element),this.element.style.height=$.getWindowSize().y+"px",this.element.style.width=$.getWindowSize().x+"px",this.toolbar&&this.toolbar.element&&(this.element.style.height=$.getElementSize(this.element).y-$.getElementSize(this.toolbar.element).y+"px"),THIS[this.hash].fullPage=!0,$.delegate(this,onContainerEnter)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,e.margin=this.bodyMargin,f.margin=this.docMargin,e.padding=this.bodyPadding,f.padding=this.docPadding,e.width=this.bodyWidth,e.height=this.bodyHeight,d.removeChild(this.element),b=this.previousBody.length,c=0;b>c;c++)d.appendChild(this.previousBody.shift());$.removeClass(this.element,"fullpage"),THIS[this.hash].prevElementParent.insertBefore(this.element,THIS[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(d.removeChild(this.toolbar.element),$.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=THIS[this.hash].prevElementWidth,this.element.style.height=THIS[this.hash].prevElementHeight;var i=0,j=function(){$.setPageScroll(g.pageScroll);var a=$.getPageScroll();i++,(10>i&&a.x!==g.pageScroll.x||a.y!==g.pageScroll.y)&&$.requestAnimationFrame(j)};$.requestAnimationFrame(j),THIS[this.hash].fullPage=!1,$.delegate(this,onContainerExit)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:a}),this},setFullScreen:function(a){var b=this;if(!$.supportsFullScreen)return this.setFullPage(a);if($.isFullScreen()===a)return this;var c={fullScreen:a,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",c),c.preventDefaultAction)return this;if(a){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var d=function(){var a=$.isFullScreen();a||($.removeEvent(document,$.fullScreenEventName,d),$.removeEvent(document,$.fullScreenErrorEventName,d),b.setFullPage(!1),b.isFullPage()&&(b.element.style.width=b.fullPageStyleWidth,b.element.style.height=b.fullPageStyleHeight)),b.navigator&&b.viewport&&b.navigator.update(b.viewport),b.raiseEvent("full-screen",{fullScreen:a})};$.addEvent(document,$.fullScreenEventName,d),$.addEvent(document,$.fullScreenErrorEventName,d),$.requestFullScreen(document.body)}else $.exitFullScreen();return this},isVisible:function(){return"hidden"!=this.container.style.visibility},setVisible:function(a){return this.container.style.visibility=a?"":"hidden",this.raiseEvent("visible",{visible:a}),this},addLayer:function(a){function b(a){c.raiseEvent("add-layer-failed",a)}var c=this,d=a.tileSource;if(!this.isOpen())throw new Error("An image must be loaded before adding layers.");if(!d)throw new Error("No tile source provided as new layer.");if(this.collectionMode)throw new Error("Layers not supported in collection mode.");return getTileSourceImplementation(this,d,function(d){if(d instanceof Array)return void b({message:"Sequences can not be added as layers.",source:d,options:a});for(var e=0;e<c.drawers.length;e++){var f=c.drawers[e].source.aspectRatio,g=f-d.aspectRatio;if(Math.abs(g)>c.layersAspectRatioEpsilon)return void b({message:"Aspect ratio mismatch with layer "+e+".",source:d,options:a})}var h=new $.Drawer({viewer:c,source:d,viewport:c.viewport,element:c.drawersContainer,opacity:void 0!==a.opacity?a.opacity:c.opacity,maxImageCacheCount:c.maxImageCacheCount,imageLoaderLimit:c.imageLoaderLimit,minZoomImageRatio:c.minZoomImageRatio,wrapHorizontal:c.wrapHorizontal,wrapVertical:c.wrapVertical,immediateRender:c.immediateRender,blendTime:c.blendTime,alwaysBlend:c.alwaysBlend,minPixelRatio:c.minPixelRatio,timeout:c.timeout,debugMode:c.debugMode,debugGridColor:c.debugGridColor});c.drawers.push(h),void 0!==a.level&&c.setLayerLevel(h,a.level),THIS[c.hash].forceRedraw=!0,c.raiseEvent("add-layer",{options:a,drawer:h})},function(c){c.options=a,b(c)}),this},getLayerAtLevel:function(a){if(a>=this.drawers.length)throw new Error("Level bigger than number of layers.");return this.drawers[a]},getLevelOfLayer:function(a){return $.indexOf(this.drawers,a)},getLayersCount:function(){return this.drawers.length},setLayerLevel:function(a,b){var c=this.getLevelOfLayer(a);if(b>=this.drawers.length)throw new Error("Level bigger than number of layers.");if(b===c||-1===c)return this;if(0===b||0===c){if(THIS[this.hash].sequenced)throw new Error("Cannot reassign base level when in sequence mode.");this.drawer=0===b?a:this.getLayerAtLevel(b),this.source=this.drawer.source}if(this.drawers.splice(c,1),this.drawers.splice(b,0,a),this.drawersContainer.removeChild(a.canvas),0===b){var d=this.drawers[1].canvas;d.parentNode.insertBefore(a.canvas,d)}else{var e=this.drawers[b-1].canvas;e.parentNode.insertBefore(a.canvas,e.nextSibling)}return this.raiseEvent("layer-level-changed",{drawer:a,previousLevel:c,newLevel:b}),this},removeLayer:function(a){var b=this.drawers.indexOf(a);if(-1===b)return this;if(0===b){if(THIS[this.hash].sequenced)throw new Error("Cannot remove base layer when in sequence mode.");if(1===this.drawers.length)return this.close(),this;this.drawer=this.drawers[1]}return this.drawers.splice(b,1),this.drawersContainer.removeChild(a.canvas),this.raiseEvent("remove-layer",{drawer:a}),this},forceRedraw:function(){return THIS[this.hash].forceRedraw=!0,this},bindSequenceControls:function(){var a=$.delegate(this,onFocus),b=$.delegate(this,onBlur),c=$.delegate(this,onNext),d=$.delegate(this,onPrevious),e=this.navImages,f=!0;return this.showSequenceControl&&THIS[this.hash].sequenced&&((this.previousButton||this.nextButton)&&(f=!1),this.previousButton=new $.Button({element:this.previousButton?$.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.PreviousPage"),srcRest:resolveUrl(this.prefixUrl,e.previous.REST),srcGroup:resolveUrl(this.prefixUrl,e.previous.GROUP),srcHover:resolveUrl(this.prefixUrl,e.previous.HOVER),srcDown:resolveUrl(this.prefixUrl,e.previous.DOWN),onRelease:d,onFocus:a,onBlur:b}),this.nextButton=new $.Button({element:this.nextButton?$.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.NextPage"),srcRest:resolveUrl(this.prefixUrl,e.next.REST),srcGroup:resolveUrl(this.prefixUrl,e.next.GROUP),srcHover:resolveUrl(this.prefixUrl,e.next.HOVER),srcDown:resolveUrl(this.prefixUrl,e.next.DOWN),onRelease:c,onFocus:a,onBlur:b}),this.navPrevNextWrap||this.previousButton.disable(),f&&(this.paging=new $.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:$.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||$.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var a=$.delegate(this,beginZoomingIn),b=$.delegate(this,endZooming),c=$.delegate(this,doSingleZoomIn),d=$.delegate(this,beginZoomingOut),e=$.delegate(this,doSingleZoomOut),f=$.delegate(this,onHome),g=$.delegate(this,onFullScreen),h=$.delegate(this,onRotateLeft),i=$.delegate(this,onRotateRight),j=$.delegate(this,onFocus),k=$.delegate(this,onBlur),l=this.navImages,m=[],n=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton)&&(n=!1),this.showZoomControl&&(m.push(this.zoomInButton=new $.Button({element:this.zoomInButton?$.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.ZoomIn"),srcRest:resolveUrl(this.prefixUrl,l.zoomIn.REST),srcGroup:resolveUrl(this.prefixUrl,l.zoomIn.GROUP),srcHover:resolveUrl(this.prefixUrl,l.zoomIn.HOVER),srcDown:resolveUrl(this.prefixUrl,l.zoomIn.DOWN),onPress:a,onRelease:b,onClick:c,onEnter:a,onExit:b,onFocus:j,onBlur:k})),m.push(this.zoomOutButton=new $.Button({element:this.zoomOutButton?$.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.ZoomOut"),srcRest:resolveUrl(this.prefixUrl,l.zoomOut.REST),srcGroup:resolveUrl(this.prefixUrl,l.zoomOut.GROUP),srcHover:resolveUrl(this.prefixUrl,l.zoomOut.HOVER),srcDown:resolveUrl(this.prefixUrl,l.zoomOut.DOWN),onPress:d,onRelease:b,onClick:e,onEnter:d,onExit:b,onFocus:j,onBlur:k}))),this.showHomeControl&&m.push(this.homeButton=new $.Button({element:this.homeButton?$.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.Home"),srcRest:resolveUrl(this.prefixUrl,l.home.REST),srcGroup:resolveUrl(this.prefixUrl,l.home.GROUP),srcHover:resolveUrl(this.prefixUrl,l.home.HOVER),srcDown:resolveUrl(this.prefixUrl,l.home.DOWN),onRelease:f,onFocus:j,onBlur:k})),this.showFullPageControl&&m.push(this.fullPageButton=new $.Button({element:this.fullPageButton?$.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.FullPage"),srcRest:resolveUrl(this.prefixUrl,l.fullpage.REST),srcGroup:resolveUrl(this.prefixUrl,l.fullpage.GROUP),srcHover:resolveUrl(this.prefixUrl,l.fullpage.HOVER),srcDown:resolveUrl(this.prefixUrl,l.fullpage.DOWN),onRelease:g,onFocus:j,onBlur:k})),this.showRotationControl&&(m.push(this.rotateLeftButton=new $.Button({element:this.rotateLeftButton?$.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.RotateLeft"),srcRest:resolveUrl(this.prefixUrl,l.rotateleft.REST),srcGroup:resolveUrl(this.prefixUrl,l.rotateleft.GROUP),srcHover:resolveUrl(this.prefixUrl,l.rotateleft.HOVER),srcDown:resolveUrl(this.prefixUrl,l.rotateleft.DOWN),onRelease:h,onFocus:j,onBlur:k})),m.push(this.rotateRightButton=new $.Button({element:this.rotateRightButton?$.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.RotateRight"),srcRest:resolveUrl(this.prefixUrl,l.rotateright.REST),srcGroup:resolveUrl(this.prefixUrl,l.rotateright.GROUP),srcHover:resolveUrl(this.prefixUrl,l.rotateright.HOVER),srcDown:resolveUrl(this.prefixUrl,l.rotateright.DOWN),onRelease:i,onFocus:j,onBlur:k}))),n&&(this.buttons=new $.ButtonGroup({buttons:m,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttons.element,this.addHandler("open",$.delegate(this,lightUp)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:$.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||$.ControlAnchor.TOP_LEFT}))),this},currentPage:function(){return THIS[this.hash].sequence},goToPage:function(a){return a>=0&&a<this.tileSources.length&&(this.raiseEvent("page",{page:a}),THIS[this.hash].sequence=a,this._updateSequenceButtons(a),this.open(this.tileSources[a]),this.referenceStrip&&this.referenceStrip.setFocus(a)),this},addOverlay:function(a,b,c,d){var e;return e=$.isPlainObject(a)?a:{element:a,location:b,placement:c,onDraw:d},a=$.getElement(e.element),getOverlayIndex(this.currentOverlays,a)>=0?this:(this.currentOverlays.push(getOverlayObject(this,e)),THIS[this.hash].forceRedraw=!0,this.raiseEvent("add-overlay",{element:a,location:e.location,placement:e.placement}),this)},updateOverlay:function(a,b,c){var d;return a=$.getElement(a),d=getOverlayIndex(this.currentOverlays,a),d>=0&&(this.currentOverlays[d].update(b,c),THIS[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:a,location:b,placement:c})),this},removeOverlay:function(a){var b;return a=$.getElement(a),b=getOverlayIndex(this.currentOverlays,a),b>=0&&(this.currentOverlays[b].destroy(),this.currentOverlays.splice(b,1),THIS[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:a})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return THIS[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},_updateSequenceButtons:function(a){this.nextButton&&(this.tileSources.length-1===a?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(a>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(a){this._hideMessage();var b=$.makeNeutralElement("div");b.appendChild(document.createTextNode(a)),this.messageDiv=$.makeCenteredNode(b),$.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var a=this.messageDiv;a&&(a.parentNode.removeChild(a),delete this.messageDiv)},gestureSettingsByDeviceType:function(a){switch(a){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}}})}(OpenSeadragon),function(a){function b(a){this.drag?this.drag=!1:this.viewer.viewport&&(this.viewer.viewport.panTo(this.viewport.pointFromPixel(a.position)),this.viewer.viewport.applyConstraints())}function c(a){this.viewer.viewport&&(this.drag=!0,this.panHorizontal||(a.delta.x=0),this.panVertical||(a.delta.y=0),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(a.delta)))}function d(a){a.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function e(a){return this.viewer.raiseEvent("navigator-scroll",{tracker:a.eventSource,position:a.position,scroll:a.scroll,shift:a.shift,originalEvent:a.originalEvent}),!1}a.Navigator=function(f){var g,h,i,j=f.viewer;f.id?(this.element=document.getElementById(f.id),f.controlOptions={anchor:a.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(f.id="navigator-"+a.now(),this.element=a.makeNeutralElement("div"),f.controlOptions={anchor:a.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:!0},f.position&&("BOTTOM_RIGHT"==f.position?f.controlOptions.anchor=a.ControlAnchor.BOTTOM_RIGHT:"BOTTOM_LEFT"==f.position?f.controlOptions.anchor=a.ControlAnchor.BOTTOM_LEFT:"TOP_RIGHT"==f.position?f.controlOptions.anchor=a.ControlAnchor.TOP_RIGHT:"TOP_LEFT"==f.position?f.controlOptions.anchor=a.ControlAnchor.TOP_LEFT:"ABSOLUTE"==f.position&&(f.controlOptions.anchor=a.ControlAnchor.ABSOLUTE,f.controlOptions.top=f.top,f.controlOptions.left=f.left,f.controlOptions.height=f.height,f.controlOptions.width=f.width))),this.element.id=f.id,this.element.className+=" navigator",f=a.extend(!0,{sizeRatio:a.DEFAULT_SETTINGS.navigatorSizeRatio},f,{element:this.element,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,autoResize:f.autoResize}),f.minPixelRatio=this.minPixelRatio=j.minPixelRatio,this.borderWidth=2,this.fudge=new a.Point(1,1),this.totalBorderWidths=new a.Point(2*this.borderWidth,2*this.borderWidth).minus(this.fudge),f.controlOptions.anchor!=a.ControlAnchor.NONE&&!function(a,b){a.margin="0px",a.border=b+"px solid #555",a.padding="0px",a.background="#000",a.opacity=.8,a.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=a.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(a,b){a.position="relative",a.top="0px",a.left="0px",a.fontSize="0px",a.overflow="hidden",a.border=b+"px solid #900",a.margin="0px",a.padding="0px",a.background="transparent",a["float"]="left",a.cssFloat="left",a.styleFloat="left",a.zIndex=999999999,a.cursor="default"}(this.displayRegion.style,this.borderWidth),this.element.innerTracker=new a.MouseTracker({element:this.element,dragHandler:a.delegate(this,c),clickHandler:a.delegate(this,b),releaseHandler:a.delegate(this,d),scrollHandler:a.delegate(this,e)}).setTracking(!0),j.addControl(this.element,f.controlOptions),f.controlOptions.anchor!=a.ControlAnchor.ABSOLUTE&&f.controlOptions.anchor!=a.ControlAnchor.NONE&&(f.width&&f.height?(this.element.style.height="number"==typeof f.height?f.height+"px":f.height,this.element.style.width="number"==typeof f.width?f.width+"px":f.width):(g=a.getElementSize(j.element),this.element.style.height=Math.round(g.y*f.sizeRatio)+"px",this.element.style.width=Math.round(g.x*f.sizeRatio)+"px",this.oldViewerSize=g),h=a.getElementSize(this.element),this.elementArea=h.x*h.y),this.oldContainerSize=new a.Point(0,0),a.Viewer.apply(this,[f]),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegion),i=this.element.getElementsByTagName("textarea")[0],i&&i.parentNode.removeChild(i)},a.extend(a.Navigator.prototype,a.EventSource.prototype,a.Viewer.prototype,{updateSize:function(){if(this.viewport){var b=new a.Point(0===this.container.clientWidth?1:this.container.clientWidth,0===this.container.clientHeight?1:this.container.clientHeight);if(!b.equals(this.oldContainerSize)){var c=this.viewport.getBounds(),d=this.viewport.getCenter();this.viewport.resize(b,!0);var e=1/this.source.aspectRatio,f=c.width<=1?c.width:1,g=c.height<=e?c.height:e,h=new a.Rect(d.x-f/2,d.y-g/2,f,g);this.viewport.fitBounds(h,!0),this.oldContainerSize=b,this.drawer.update()}}},update:function(b){var c,d,e,f,g,h;c=a.getElementSize(this.viewer.element),c.equals(this.oldViewerSize)||(this.oldViewerSize=c,this.maintainSizeRatio?(d=c.x*this.sizeRatio,e=c.y*this.sizeRatio):(d=Math.sqrt(this.elementArea*(c.x/c.y)),e=this.elementArea/d),this.element.style.width=Math.round(d)+"px",this.element.style.height=Math.round(e)+"px",this.updateSize()),b&&this.viewport&&(f=b.getBounds(!0),g=this.viewport.pixelFromPoint(f.getTopLeft(),!1),h=this.viewport.pixelFromPoint(f.getBottomRight(),!1).minus(this.totalBorderWidths),function(a){a.top=Math.round(g.y)+"px",a.left=Math.round(g.x)+"px";var b=Math.abs(g.x-h.x),c=Math.abs(g.y-h.y);a.width=Math.round(Math.max(b,0))+"px",a.height=Math.round(Math.max(c,0))+"px"}(this.displayRegion.style))},open:function(b){this.updateSize();var c=this.viewer.viewport.containerSize.times(this.sizeRatio);return this.minPixelRatio=b.tileSize>c.x||b.tileSize>c.y?Math.min(c.x,c.y)/b.tileSize:this.viewer.minPixelRatio,a.Viewer.prototype.open.apply(this,[b])}})}(OpenSeadragon),function(a){var b={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right"}};a.extend(a,{getString:function(c){var d,e=c.split("."),f=null,g=arguments,h=b;for(d=0;d<e.length-1;d++)h=h[e[d]]||{};return f=h[e[d]],"string"!=typeof f&&(a.console.debug("Untranslated source string:",c),f=""),f.replace(/\{\d+\}/g,function(a){var b=parseInt(a.match(/\d+/),10)+1;return b<g.length?g[b]:""})},setString:function(a,c){var d,e=a.split("."),f=b;for(d=0;d<e.length-1;d++)f[e[d]]||(f[e[d]]={}),f=f[e[d]];f[e[d]]=c}})}(OpenSeadragon),function(a){a.Point=function(a,b){this.x="number"==typeof a?a:0,this.y="number"==typeof b?b:0},a.Point.prototype={plus:function(b){return new a.Point(this.x+b.x,this.y+b.y)},minus:function(b){return new a.Point(this.x-b.x,this.y-b.y)},times:function(b){return new a.Point(this.x*b,this.y*b)},divide:function(b){return new a.Point(this.x/b,this.y/b)},negate:function(){return new a.Point(-this.x,-this.y)},distanceTo:function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2))},apply:function(b){return new a.Point(b(this.x),b(this.y))},equals:function(b){return b instanceof a.Point&&this.x===b.x&&this.y===b.y},rotate:function(b,c){var d=b*Math.PI/180,e=Math.cos(d)*(this.x-c.x)-Math.sin(d)*(this.y-c.y)+c.x,f=Math.sin(d)*(this.x-c.x)+Math.cos(d)*(this.y-c.y)+c.y;return new a.Point(e,f)},toString:function(){return"("+Math.round(this.x)+","+Math.round(this.y)+")"}}}(OpenSeadragon),function($){function processResponse(xhr){var responseText=xhr.responseText,status=xhr.status,statusText,data;if(!xhr)throw new Error($.getString("Errors.Security"));if(200!==xhr.status&&0!==xhr.status)throw status=xhr.status,statusText=404==status?"Not Found":xhr.statusText,new Error($.getString("Errors.Status",status,statusText));if(responseText.match(/\s*<.*/))try{data=xhr.responseXML&&xhr.responseXML.documentElement?xhr.responseXML:$.parseXml(responseText)}catch(e){data=xhr.responseText}else data=responseText.match(/\s*[\{\[].*/)?eval("("+responseText+")"):responseText;return data}$.TileSource=function(a){var b,c,d=null,e=arguments;for(b=$.isPlainObject(a)?a:{width:e[0],height:e[1],tileSize:e[2],tileOverlap:e[3],minLevel:e[4],maxLevel:e[5]},$.EventSource.call(this),$.extend(!0,this,b),c=0;c<arguments.length;c++)if($.isFunction(arguments[c])){d=arguments[c],this.addHandler("ready",function(a){d(a)});break}"string"==$.type(arguments[0])?(this.aspectRatio=1,this.dimensions=new $.Point(10,10),this.tileSize=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(arguments[0])):(this.ready=!0,this.aspectRatio=b.width&&b.height?b.width/b.height:1,this.dimensions=new $.Point(b.width,b.height),this.tileSize=b.tileSize?b.tileSize:0,this.tileOverlap=b.tileOverlap?b.tileOverlap:0,this.minLevel=b.minLevel?b.minLevel:0,this.maxLevel=void 0!==b.maxLevel&&null!==b.maxLevel?b.maxLevel:b.width&&b.height?Math.ceil(Math.log(Math.max(b.width,b.height))/Math.log(2)):0,d&&$.isFunction(d)&&d(this))},$.TileSource.prototype={getLevelScale:function(a){var b,c={};for(b=0;b<=this.maxLevel;b++)c[b]=1/Math.pow(2,this.maxLevel-b);return this.getLevelScale=function(a){return c[a]},this.getLevelScale(a)},getNumTiles:function(a){var b=this.getLevelScale(a),c=Math.ceil(b*this.dimensions.x/this.tileSize),d=Math.ceil(b*this.dimensions.y/this.tileSize);return new $.Point(c,d)},getPixelRatio:function(a){var b=this.dimensions.times(this.getLevelScale(a)),c=1/b.x,d=1/b.y;return new $.Point(c,d)},getClosestLevel:function(a){var b,c,d=Math.floor(Math.max(a.x,a.y)/this.tileSize);for(b=this.minLevel;b<this.maxLevel&&(c=this.getNumTiles(b),!(Math.max(c.x,c.y)+1>=d));b++);return Math.max(0,b-1)},getTileAtPoint:function(a,b){var c=b.times(this.dimensions.x).times(this.getLevelScale(a)),d=Math.floor(c.x/this.tileSize),e=Math.floor(c.y/this.tileSize);return new $.Point(d,e)},getTileBounds:function(a,b,c){var d=this.dimensions.times(this.getLevelScale(a)),e=0===b?0:this.tileSize*b-this.tileOverlap,f=0===c?0:this.tileSize*c-this.tileOverlap,g=this.tileSize+(0===b?1:2)*this.tileOverlap,h=this.tileSize+(0===c?1:2)*this.tileOverlap,i=1/d.x;return g=Math.min(g,d.x-e),h=Math.min(h,d.y-f),new $.Rect(e*i,f*i,g*i,h*i)},getImageInfo:function(a){var b,c,d,e,f,g,h,i=this;a&&(f=a.split("/"),g=f[f.length-1],h=g.lastIndexOf("."),h>-1&&(f[f.length-1]=g.slice(0,h))),c=function(b){"string"==typeof b&&(b=$.parseXml(b));var c=$.TileSource.determineType(i,b,a);return c?(e=c.prototype.configure.apply(i,[b,a]),d=new c(e),i.ready=!0,void i.raiseEvent("ready",{tileSource:d})):void i.raiseEvent("open-failed",{message:"Unable to load TileSource",source:a})},a.match(/\.js$/)?(b=a.split("/").pop().replace(".js",""),$.jsonp({url:a,async:!1,callbackName:b,callback:c})):$.makeAjaxRequest(a,function(a){var b=processResponse(a);c(b)},function(b,c){var d;try{d="HTTP "+b.status+" attempting to load TileSource"}catch(e){var f;f="undefined"!=typeof c&&c.toString?c.toString():"Unknown error",d=f+" attempting to load TileSource"}i.raiseEvent("open-failed",{message:d,source:a})})},supports:function(){return!1},configure:function(){throw new Error("Method not implemented.")},getTileUrl:function(){throw new Error("Method not implemented.")},tileExists:function(a,b,c){var d=this.getNumTiles(a);return a>=this.minLevel&&a<=this.maxLevel&&b>=0&&c>=0&&b<d.x&&c<d.y}},$.extend(!0,$.TileSource.prototype,$.EventSource.prototype),$.TileSource.determineType=function(a,b,c){var d;for(d in OpenSeadragon)if(d.match(/.+TileSource$/)&&$.isFunction(OpenSeadragon[d])&&$.isFunction(OpenSeadragon[d].prototype.supports)&&OpenSeadragon[d].prototype.supports.call(a,b,c))return OpenSeadragon[d];$.console.error("No TileSource was able to open %s %s",c,b)}}(OpenSeadragon),function(a){function b(b,d){if(!d||!d.documentElement)throw new Error(a.getString("Errors.Xml"));var e,f,g,h,i,j=d.documentElement,k=j.tagName,l=null,m=[];if("Image"==k)try{if(h=j.getElementsByTagName("Size")[0],l={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:j.getAttribute("Url"),Format:j.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(j.getAttribute("Overlap"),10),TileSize:parseInt(j.getAttribute("TileSize"),10),Size:{Height:parseInt(h.getAttribute("Height"),10),Width:parseInt(h.getAttribute("Width"),10)}}},!a.imageFormatSupported(l.Image.Format))throw new Error(a.getString("Errors.ImageFormat",l.Image.Format.toUpperCase()));for(e=j.getElementsByTagName("DisplayRect"),i=0;i<e.length;i++)f=e[i],g=f.getElementsByTagName("Rect")[0],m.push({Rect:{X:parseInt(g.getAttribute("X"),10),Y:parseInt(g.getAttribute("Y"),10),Width:parseInt(g.getAttribute("Width"),10),Height:parseInt(g.getAttribute("Height"),10),MinLevel:parseInt(f.getAttribute("MinLevel"),10),MaxLevel:parseInt(f.getAttribute("MaxLevel"),10)}});return m.length&&(l.Image.DisplayRect=m),c(b,l)}catch(n){throw n instanceof Error?n:new Error(a.getString("Errors.Dzi"))}else{if("Collection"==k)throw new Error(a.getString("Errors.Dzc"));if("Error"==k)return a._processDZIError(j)}throw new Error(a.getString("Errors.Dzi"))}function c(b,c){var d,e,f=c.Image,g=f.Url,h=f.Format,i=f.Size,j=f.DisplayRect||[],k=parseInt(i.Width,10),l=parseInt(i.Height,10),m=parseInt(f.TileSize,10),n=parseInt(f.Overlap,10),o=[];for(e=0;e<j.length;e++)d=j[e].Rect,o.push(new a.DisplayRect(parseInt(d.X,10),parseInt(d.Y,10),parseInt(d.Width,10),parseInt(d.Height,10),parseInt(d.MinLevel,10),parseInt(d.MaxLevel,10)));return a.extend(!0,{width:k,height:l,tileSize:m,tileOverlap:n,minLevel:null,maxLevel:null,tilesUrl:g,fileFormat:h,displayRects:o},c)}a.DziTileSource=function(b){var c,d,e,f;if(f=a.isPlainObject(b)?b:{width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=f.tilesUrl,this.fileFormat=f.fileFormat,this.displayRects=f.displayRects,this.displayRects)for(c=this.displayRects.length-1;c>=0;c--)for(d=this.displayRects[c],e=d.minLevel;e<=d.maxLevel;e++)this._levelRects[e]||(this._levelRects[e]=[]),this._levelRects[e].push(d);
a.TileSource.apply(this,[f])},a.extend(a.DziTileSource.prototype,a.TileSource.prototype,{supports:function(a){var b;return a.Image?b=a.Image.xmlns:a.documentElement&&"Image"==a.documentElement.tagName&&(b=a.documentElement.namespaceURI),"http://schemas.microsoft.com/deepzoom/2008"==b||"http://schemas.microsoft.com/deepzoom/2009"==b},configure:function(d,e){var f;return f=a.isPlainObject(d)?c(this,d):b(this,d),e&&!f.tilesUrl&&(f.tilesUrl=e.replace(/([^\/]+)\.(dzi|xml|js)(\?.*|$)/,"$1_files/"),f.queryParams=-1!=e.search(/\.(dzi|xml|js)\?/)?e.match(/\?.*/):""),f},getTileUrl:function(a,b,c){return[this.tilesUrl,a,"/",b,"_",c,".",this.fileFormat,this.queryParams].join("")},tileExists:function(a,b,c){var d,e,f,g,h,i,j,k=this._levelRects[a];if(!k||!k.length)return!0;for(j=k.length-1;j>=0;j--)if(d=k[j],!(a<d.minLevel||a>d.maxLevel)&&(e=this.getLevelScale(a),f=d.x*e,g=d.y*e,h=f+d.width*e,i=g+d.height*e,f=Math.floor(f/this.tileSize),g=Math.floor(g/this.tileSize),h=Math.ceil(h/this.tileSize),i=Math.ceil(i/this.tileSize),b>=f&&h>b&&c>=g&&i>c))return!0;return!1}})}(OpenSeadragon),function(a){function b(b,e){if(!e||!e.documentElement)throw new Error(a.getString("Errors.Xml"));var f=e.documentElement,g=f.tagName,h=null;if("info"==g)try{return h={ns:f.namespaceURI},c(f,h),d(b,h)}catch(i){throw i instanceof Error?i:new Error(a.getString("Errors.IIIF"))}throw new Error(a.getString("Errors.IIIF"))}function c(b,d,e){var f,g;if(3==b.nodeType&&e)g=b.nodeValue.trim(),g.match(/^\d*$/)&&(g=Number(g)),d[e]?(a.isArray(d[e])||(d[e]=[d[e]]),d[e].push(g)):d[e]=g;else if(1==b.nodeType)for(f=0;f<b.childNodes.length;f++)c(b.childNodes[f],d,b.nodeName)}function d(a,b){return b.image_host&&(b.tilesUrl=b.image_host),b}a.IIIFTileSource=function(b){if(a.extend(!0,this,b),!(this.height&&this.width&&this.identifier&&this.tilesUrl))throw new Error("IIIF required parameters not provided.");if(b.tileSize=this.tile_width,!b.maxLevel){var c=-1,d=this.scale_factors||this.scale_factor;if(d instanceof Array)for(var e=0;e<d.length;e++){var f=Number(d[e]);!isNaN(f)&&f>c&&(c=f)}b.maxLevel=0>c?Number(Math.ceil(Math.log(Math.max(this.width,this.height),2))):c}a.TileSource.apply(this,[b])},a.extend(a.IIIFTileSource.prototype,a.TileSource.prototype,{supports:function(a){return a.ns&&"http://library.stanford.edu/iiif/image-api/ns/"==a.ns||a.profile&&("http://library.stanford.edu/iiif/image-api/compliance.html#level1"==a.profile||"http://library.stanford.edu/iiif/image-api/compliance.html#level2"==a.profile||"http://library.stanford.edu/iiif/image-api/compliance.html#level3"==a.profile||"http://library.stanford.edu/iiif/image-api/compliance.html"==a.profile)||a.documentElement&&"info"==a.documentElement.tagName&&"http://library.stanford.edu/iiif/image-api/ns/"==a.documentElement.namespaceURI},configure:function(c,e){var f,g,h;return g=a.isPlainObject(c)?d(this,c):b(this,c),e&&!g.tilesUrl&&(f=e.split("/"),f.pop(),f=f.join("/"),"http"!==e.substring(0,4)&&(h=location.protocol+"//"+location.host,f=h+f),g.tilesUrl=f.replace(c.identifier,"")),g},getTileUrl:function(a,b,c){var d,e,f,g,h,i,j="0",k="native.jpg",l=Math.pow(.5,this.maxLevel-a),m=Math.ceil(this.width*l),n=Math.ceil(this.height*l),o=Math.ceil(this.tileSize/l),p=Math.ceil(this.tileSize/l);return m<this.tile_width&&n<this.tile_height?(i=m+",",d="full"):(e=b*o,f=c*p,g=Math.min(o,this.width-e),h=Math.min(p,this.height-f),i=Math.ceil(g*l)+",",d=[e,f,g,h].join(",")),[this.tilesUrl,this.identifier,d,i,j,k].join("/")}})}(OpenSeadragon),function(a){a.IIIF1_1TileSource=function(b){if(a.extend(!0,this,b),!(this.height&&this.width&&this["@id"]))throw new Error("IIIF required parameters not provided.");if(this.profile&&"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0"==this.profile)throw new Error("IIIF Image API 1.1 compliance level 1 or greater is required.");if(this.tile_width)b.tileSize=this.tile_width;else if(this.tile_height)b.tileSize=this.tile_height;else{for(var c=Math.min(this.height,this.width),d=[256,512,1024],e=[],f=0;f<d.length;f++)d[f]<=c&&e.push(d[f]);b.tileSize=e.length>0?Math.max.apply(null,e):c,this.tile_width=b.tileSize,this.tile_height=b.tileSize}if(!b.maxLevel){var g=-1,h=this.scale_factors||this.scale_factor;if(h instanceof Array)for(var i=0;i<h.length;i++){var j=Number(h[i]);!isNaN(j)&&j>g&&(g=j)}b.maxLevel=0>g?Number(Math.ceil(Math.log(Math.max(this.width,this.height),2))):g}a.TileSource.apply(this,[b])},a.extend(a.IIIF1_1TileSource.prototype,a.TileSource.prototype,{supports:function(a){return a["@context"]&&"http://library.stanford.edu/iiif/image-api/1.1/context.json"==a["@context"]},configure:function(a){return a},getTileUrl:function(a,b,c){var d,e,f,g,h,i,j,k="0",l="native.jpg",m=Math.pow(.5,this.maxLevel-a),n=Math.ceil(this.width*m),o=Math.ceil(this.height*m),p=Math.ceil(this.tileSize/m),q=Math.ceil(this.tileSize/m);return n<this.tile_width&&o<this.tile_height?(i=n+",",d="full"):(e=b*p,f=c*q,g=Math.min(p,this.width-e),h=Math.min(q,this.height-f),i=Math.ceil(g*m)+",",d=[e,f,g,h].join(",")),j=[this["@id"],d,i,k,l].join("/")}})}(OpenSeadragon),function(a){a.OsmTileSource=function(b){var c;c=a.isPlainObject(b)?b:{width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},c.width&&c.height||(c.width=65572864,c.height=65572864),c.tileSize||(c.tileSize=256,c.tileOverlap=0),c.tilesUrl||(c.tilesUrl="http://tile.openstreetmap.org/"),c.minLevel=8,a.TileSource.apply(this,[c])},a.extend(a.OsmTileSource.prototype,a.TileSource.prototype,{supports:function(a){return a.type&&"openstreetmaps"==a.type},configure:function(a){return a},getTileUrl:function(a,b,c){return this.tilesUrl+(a-8)+"/"+b+"/"+c+".png"}})}(OpenSeadragon),function(a){a.TmsTileSource=function(b){var c;c=a.isPlainObject(b)?b:{width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var d,e=256*Math.ceil(c.width/256),f=256*Math.ceil(c.height/256);d=e>f?e/256:f/256,c.maxLevel=Math.ceil(Math.log(d)/Math.log(2))-1,c.tileSize=256,c.width=e,c.height=f,a.TileSource.apply(this,[c])},a.extend(a.TmsTileSource.prototype,a.TileSource.prototype,{supports:function(a){return a.type&&"tiledmapservice"==a.type},configure:function(a){return a},getTileUrl:function(a,b,c){var d=this.getNumTiles(a).y-1;return this.tilesUrl+a+"/"+b+"/"+(d-c)+".png"}})}(OpenSeadragon),function(a){function b(b){var c,d,e=[];for(d=0;d<b.length;d++)c=b[d],c.height&&c.width&&c.url&&(c.url.toLowerCase().match(/^.*\.(png|jpg|jpeg|gif)$/)||c.mimetype&&c.mimetype.toLowerCase().match(/^.*\/(png|jpg|jpeg|gif)$/))?e.push({url:c.url,width:Number(c.width),height:Number(c.height)}):a.console.error("Unsupported image format: %s",c.url?c.url:"<no URL>");return e.sort(function(a,b){return a.height-b.height})}function c(b,c){if(!c||!c.documentElement)throw new Error(a.getString("Errors.Xml"));var e,f,g=c.documentElement,h=g.tagName,i=null,j=[];if("image"==h)try{for(i={type:g.getAttribute("type"),levels:[]},j=g.getElementsByTagName("level"),f=0;f<j.length;f++)e=j[f],i.levels.push({url:e.getAttribute("url"),width:parseInt(e.getAttribute("width"),10),height:parseInt(e.getAttribute("height"),10)});return d(b,i)}catch(k){throw k instanceof Error?k:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if("collection"==h)throw new Error("Legacy Image Pyramid Collections not yet supported.");if("error"==h)throw new Error("Error: "+c)}throw new Error("Unknown element "+h)}function d(a,b){return b.levels}a.LegacyTileSource=function(c){var d,e,f;a.isArray(c)&&(d={type:"legacy-image-pyramid",levels:c}),d.levels=b(d.levels),d.levels.length>0?(e=d.levels[d.levels.length-1].width,f=d.levels[d.levels.length-1].height):(e=0,f=0,a.console.error("No supported image formats found")),a.extend(!0,d,{width:e,height:f,tileSize:Math.max(f,e),tileOverlap:0,minLevel:0,maxLevel:d.levels.length>0?d.levels.length-1:0}),a.TileSource.apply(this,[d]),this.levels=d.levels},a.extend(a.LegacyTileSource.prototype,a.TileSource.prototype,{supports:function(a){return a.type&&"legacy-image-pyramid"==a.type||a.documentElement&&"legacy-image-pyramid"==a.documentElement.getAttribute("type")},configure:function(b){var e;return e=a.isPlainObject(b)?d(this,b):c(this,b)},getLevelScale:function(a){var b=0/0;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(b=this.levels[a].width/this.levels[this.maxLevel].width),b},getNumTiles:function(b){var c=this.getLevelScale(b);return c?new a.Point(1,1):new a.Point(0,0)},getTileAtPoint:function(){return new a.Point(0,0)},getTileUrl:function(a){var b=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(b=this.levels[a].url),b}})}(OpenSeadragon),function(a){a.TileSourceCollection=function(b){var c;c=a.isPlainObject(b)?b:{tileSize:arguments[0],tileSources:arguments[1],rows:arguments[2],layout:arguments[3]},c.layout||(c.layout="horizontal");var d=0,e=1,f=Math.ceil(c.tileSources.length/c.rows),g=f>=c.rows?f:c.rows;for("horizontal"==c.layout?(c.width=c.tileSize*f,c.height=c.tileSize*c.rows):(c.height=c.tileSize*f,c.width=c.tileSize*c.rows),c.tileOverlap=-c.tileMargin,c.tilesPerRow=f;e<c.tileSize*g;)e=2*e,d++;c.minLevel=d,a.TileSource.apply(this,[c])},a.extend(a.TileSourceCollection.prototype,a.TileSource.prototype,{getTileBounds:function(b,c,d){var e=this.dimensions.times(this.getLevelScale(b)),f=this.tileSize*c-this.tileOverlap,g=this.tileSize*d-this.tileOverlap,h=this.tileSize+1*this.tileOverlap,i=this.tileSize+1*this.tileOverlap,j=1/e.x;return h=Math.min(h,e.x-f),i=Math.min(i,e.y-g),new a.Rect(f*j,g*j,h*j,i*j)},configure:function(){},getTileUrl:function(){return null}})}(OpenSeadragon),function(a){function b(b){a.requestAnimationFrame(function(){c(b)})}function c(c){var d,e,f;c.shouldFade&&(d=a.now(),e=d-c.fadeBeginTime,f=1-e/c.fadeLength,f=Math.min(1,f),f=Math.max(0,f),c.imgGroup&&a.setElementOpacity(c.imgGroup,f,!0),f>0&&b(c))}function d(c){c.shouldFade=!0,c.fadeBeginTime=a.now()+c.fadeDelay,window.setTimeout(function(){b(c)},c.fadeDelay)}function e(b){b.shouldFade=!1,b.imgGroup&&a.setElementOpacity(b.imgGroup,1,!0)}function f(b,c){b.element.disabled||(c>=a.ButtonState.GROUP&&b.currentState==a.ButtonState.REST&&(e(b),b.currentState=a.ButtonState.GROUP),c>=a.ButtonState.HOVER&&b.currentState==a.ButtonState.GROUP&&(b.imgHover&&(b.imgHover.style.visibility=""),b.currentState=a.ButtonState.HOVER),c>=a.ButtonState.DOWN&&b.currentState==a.ButtonState.HOVER&&(b.imgDown&&(b.imgDown.style.visibility=""),b.currentState=a.ButtonState.DOWN))}function g(b,c){b.element.disabled||(c<=a.ButtonState.HOVER&&b.currentState==a.ButtonState.DOWN&&(b.imgDown&&(b.imgDown.style.visibility="hidden"),b.currentState=a.ButtonState.HOVER),c<=a.ButtonState.GROUP&&b.currentState==a.ButtonState.HOVER&&(b.imgHover&&(b.imgHover.style.visibility="hidden"),b.currentState=a.ButtonState.GROUP),c<=a.ButtonState.REST&&b.currentState==a.ButtonState.GROUP&&(d(b),b.currentState=a.ButtonState.REST))}a.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},a.Button=function(b){var c=this;a.EventSource.call(this),a.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:a.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:a.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null},b),this.element=b.element||a.makeNeutralElement("div"),b.element||(this.imgRest=a.makeTransparentImage(this.srcRest),this.imgGroup=a.makeTransparentImage(this.srcGroup),this.imgHover=a.makeTransparentImage(this.srcHover),this.imgDown=a.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,this.element.style.position="relative",this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",a.Browser.vendor==a.BROWSERS.FIREFOX&&a.Browser.version<3&&(this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top=""),this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=a.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new a.MouseTracker({element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(b){b.insideElementPressed?(f(c,a.ButtonState.DOWN),c.raiseEvent("enter",{originalEvent:b.originalEvent})):b.buttonDownAny||f(c,a.ButtonState.HOVER)},focusHandler:function(a){this.enterHandler(a),c.raiseEvent("focus",{originalEvent:a.originalEvent})},exitHandler:function(b){g(c,a.ButtonState.GROUP),b.insideElementPressed&&c.raiseEvent("exit",{originalEvent:b.originalEvent})},blurHandler:function(a){this.exitHandler(a),c.raiseEvent("blur",{originalEvent:a.originalEvent})},pressHandler:function(b){f(c,a.ButtonState.DOWN),c.raiseEvent("press",{originalEvent:b.originalEvent})},releaseHandler:function(b){b.insideElementPressed&&b.insideElementReleased?(g(c,a.ButtonState.HOVER),c.raiseEvent("release",{originalEvent:b.originalEvent})):b.insideElementPressed?g(c,a.ButtonState.GROUP):f(c,a.ButtonState.HOVER)},clickHandler:function(a){a.quick&&c.raiseEvent("click",{originalEvent:a.originalEvent})},keyHandler:function(a){return 13===a.keyCode?(c.raiseEvent("click",{originalEvent:a.originalEvent}),c.raiseEvent("release",{originalEvent:a.originalEvent}),!1):!0}}).setTracking(!0),g(this,a.ButtonState.REST)},a.extend(a.Button.prototype,a.EventSource.prototype,{notifyGroupEnter:function(){f(this,a.ButtonState.GROUP)},notifyGroupExit:function(){g(this,a.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,a.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,a.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()}})}(OpenSeadragon),function(a){a.ButtonGroup=function(b){a.extend(!0,this,{buttons:[],clickTimeThreshold:a.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:a.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},b);var c,d=this.buttons.concat([]),e=this;if(this.element=b.element||a.makeNeutralElement("div"),!b.group)for(this.label=a.makeNeutralElement("label"),this.element.style.display="inline-block",this.element.appendChild(this.label),c=0;c<d.length;c++)this.element.appendChild(d[c].element);this.tracker=new a.MouseTracker({element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(){var a;for(a=0;a<e.buttons.length;a++)e.buttons[a].notifyGroupEnter()},exitHandler:function(a){var b;if(!a.insideElementPressed)for(b=0;b<e.buttons.length;b++)e.buttons[b].notifyGroupExit()},pressHandler:function(b){if("touch"===b.pointerType&&!a.MouseTracker.haveTouchEnter){var c;for(c=0;c<e.buttons.length;c++)e.buttons[c].notifyGroupEnter()}},releaseHandler:function(b){var c;if(!b.insideElementReleased||"touch"===b.pointerType&&!a.MouseTracker.haveTouchEnter)for(c=0;c<e.buttons.length;c++)e.buttons[c].notifyGroupExit()}}).setTracking(!0)},a.ButtonGroup.prototype={emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateExit:function(){this.tracker.exitHandler({eventSource:this.tracker})}}}(OpenSeadragon),function(a){a.Rect=function(a,b,c,d){this.x="number"==typeof a?a:0,this.y="number"==typeof b?b:0,this.width="number"==typeof c?c:0,this.height="number"==typeof d?d:0},a.Rect.prototype={getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new a.Point(this.x,this.y)},getBottomRight:function(){return new a.Point(this.x+this.width,this.y+this.height)},getTopRight:function(){return new a.Point(this.x+this.width,this.y)},getBottomLeft:function(){return new a.Point(this.x,this.y+this.height)},getCenter:function(){return new a.Point(this.x+this.width/2,this.y+this.height/2)},getSize:function(){return new a.Point(this.width,this.height)},equals:function(b){return b instanceof a.Rect&&this.x===b.x&&this.y===b.y&&this.width===b.width&&this.height===b.height},rotate:function(b,c){var d,e=this.width,f=this.height;if(b=(b+360)%360,b%90!==0)throw new Error("Currently only 0, 90, 180, and 270 degrees are supported.");if(0===b)return new a.Rect(this.x,this.y,this.width,this.height);switch(c=c||this.getCenter(),b){case 90:d=this.getBottomLeft(),e=this.height,f=this.width;break;case 180:d=this.getBottomRight();break;case 270:d=this.getTopRight(),e=this.height,f=this.width;break;default:d=this.getTopLeft()}return d=d.rotate(b,c),new a.Rect(d.x,d.y,e,f)},toString:function(){return"["+Math.round(100*this.x)+","+Math.round(100*this.y)+","+Math.round(100*this.width)+"x"+Math.round(100*this.height)+"]"}}}(OpenSeadragon),function(a){function b(b){var c=Number(this.element.style.marginLeft.replace("px","")),e=Number(this.element.style.marginTop.replace("px","")),f=Number(this.element.style.width.replace("px","")),g=Number(this.element.style.height.replace("px","")),h=a.getElementSize(this.viewer.canvas);return this.dragging=!0,this.element&&("horizontal"==this.scroll?-b.delta.x>0?c>-(f-h.x)&&(this.element.style.marginLeft=c+2*b.delta.x+"px",d(this,h.x,c+2*b.delta.x)):-b.delta.x<0&&0>c&&(this.element.style.marginLeft=c+2*b.delta.x+"px",d(this,h.x,c+2*b.delta.x)):-b.delta.y>0?e>-(g-h.y)&&(this.element.style.marginTop=e+2*b.delta.y+"px",d(this,h.y,e+2*b.delta.y)):-b.delta.y<0&&0>e&&(this.element.style.marginTop=e+2*b.delta.y+"px",d(this,h.y,e+2*b.delta.y))),!1}function c(b){var c=Number(this.element.style.marginLeft.replace("px","")),e=Number(this.element.style.marginTop.replace("px","")),f=Number(this.element.style.width.replace("px","")),g=Number(this.element.style.height.replace("px","")),h=a.getElementSize(this.viewer.canvas);return this.element&&("horizontal"==this.scroll?b.scroll>0?c>-(f-h.x)&&(this.element.style.marginLeft=c-60*b.scroll+"px",d(this,h.x,c-60*b.scroll)):b.scroll<0&&0>c&&(this.element.style.marginLeft=c-60*b.scroll+"px",d(this,h.x,c-60*b.scroll)):b.scroll<0?e>h.y-g&&(this.element.style.marginTop=e+60*b.scroll+"px",d(this,h.y,e+60*b.scroll)):b.scroll>0&&0>e&&(this.element.style.marginTop=e+60*b.scroll+"px",d(this,h.y,e+60*b.scroll))),!1}function d(b,c,d){var e,f,g,h,i,j,k;for(e="horizontal"==b.scroll?b.panelWidth:b.panelHeight,f=Math.ceil(c/e)+5,g=Math.ceil((Math.abs(d)+c)/e)+1,f=g-f,f=0>f?0:f,j=f;g>j&&j<b.panels.length;j++)k=b.panels[j],k.activePanel||(h=new a.Viewer({id:k.id,tileSources:[b.viewer.tileSources[j]],element:k,navigatorSizeRatio:b.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0}),h.displayRegion=a.makeNeutralElement("textarea"),h.displayRegion.id=k.id+"-displayregion",h.displayRegion.className="displayregion",i=h.displayRegion.style,i.position="relative",i.top="0px",i.left="0px",i.fontSize="0px",i.overflow="hidden",i.float="left",i.cssFloat="left",i.styleFloat="left",i.zIndex=999999999,i.cursor="default",i.width=b.panelWidth-4+"px",i.height=b.panelHeight-4+"px",h.displayRegion.innerTracker=new a.MouseTracker({element:h.displayRegion}),k.getElementsByTagName("div")[0].appendChild(h.displayRegion),k.activePanel=!0)}function e(a){var b=a.eventSource.element;return"horizontal"==this.scroll?b.style.marginBottom="0px":b.style.marginLeft="0px",!1}function f(b){var c=b.eventSource.element;return"horizontal"==this.scroll?c.style.marginBottom="-"+a.getElementSize(c).y/2+"px":c.style.marginLeft="-"+a.getElementSize(c).x/2+"px",!1}function g(a){switch(a.keyCode){case 61:return c.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;case 45:return c.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;case 48:case 119:case 87:case 38:return c.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;case 115:case 83:case 40:return c.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;case 97:case 37:return c.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;case 100:case 39:return c.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;default:return!0}}var h={};a.ReferenceStrip=function(i){var j,k,l,m=this,n=i.viewer,o=a.getElementSize(n.element);for(i.id||(i.id="referencestrip-"+a.now(),this.element=a.makeNeutralElement("div"),this.element.id=i.id,this.element.className="referencestrip"),i=a.extend(!0,{sizeRatio:a.DEFAULT_SETTINGS.referenceStripSizeRatio,position:a.DEFAULT_SETTINGS.referenceStripPosition,scroll:a.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:a.DEFAULT_SETTINGS.clickTimeThreshold},i,{element:this.element,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1}),a.extend(this,i),h[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,k=this.element.style,k.marginTop="0px",k.marginRight="0px",k.marginBottom="0px",k.marginLeft="0px",k.left="0px",k.bottom="0px",k.border="0px",k.background="#000",k.position="relative",a.setElementOpacity(this.element,.8),this.viewer=n,this.innerTracker=new a.MouseTracker({element:this.element,dragHandler:a.delegate(this,b),scrollHandler:a.delegate(this,c),enterHandler:a.delegate(this,e),exitHandler:a.delegate(this,f),keyHandler:a.delegate(this,g)}).setTracking(!0),i.width&&i.height?(this.element.style.width=i.width+"px",this.element.style.height=i.height+"px",n.addControl(this.element,{anchor:a.ControlAnchor.BOTTOM_LEFT})):"horizontal"==i.scroll?(this.element.style.width=o.x*i.sizeRatio*n.tileSources.length+12*n.tileSources.length+"px",this.element.style.height=o.y*i.sizeRatio+"px",n.addControl(this.element,{anchor:a.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=o.y*i.sizeRatio*n.tileSources.length+12*n.tileSources.length+"px",this.element.style.width=o.x*i.sizeRatio+"px",n.addControl(this.element,{anchor:a.ControlAnchor.TOP_LEFT})),this.panelWidth=o.x*this.sizeRatio+8,this.panelHeight=o.y*this.sizeRatio+8,this.panels=[],l=0;l<n.tileSources.length;l++)j=a.makeNeutralElement("div"),j.id=this.element.id+"-"+l,j.style.width=m.panelWidth+"px",j.style.height=m.panelHeight+"px",j.style.display="inline",j.style.float="left",j.style.cssFloat="left",j.style.styleFloat="left",j.style.padding="2px",j.innerTracker=new a.MouseTracker({element:j,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,pressHandler:function(b){b.eventSource.dragging=a.now()},releaseHandler:function(b){var c=b.eventSource,d=c.element.id,e=Number(d.split("-")[2]),f=a.now();b.insideElementPressed&&b.insideElementReleased&&c.dragging&&f-c.dragging<c.clickTimeThreshold&&(c.dragging=null,n.goToPage(e))}}).setTracking(!0),this.element.appendChild(j),j.activePanel=!1,this.panels.push(j);d(this,"vertical"==this.scroll?o.y:o.y,0),this.setFocus(0)},a.extend(a.ReferenceStrip.prototype,a.EventSource.prototype,a.Viewer.prototype,{setFocus:function(b){var c,f=a.getElement(this.element.id+"-"+b),g=a.getElementSize(this.viewer.canvas),h=Number(this.element.style.width.replace("px","")),i=Number(this.element.style.height.replace("px","")),j=-Number(this.element.style.marginLeft.replace("px","")),k=-Number(this.element.style.marginTop.replace("px",""));this.currentSelected!==f&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=f,this.currentSelected.style.background="#999","horizontal"==this.scroll?(c=Number(b)*(this.panelWidth+3),c>j+g.x-this.panelWidth?(c=Math.min(c,h-g.x),this.element.style.marginLeft=-c+"px",d(this,g.x,-c)):j>c&&(c=Math.max(0,c-g.x/2),this.element.style.marginLeft=-c+"px",d(this,g.x,-c))):(c=Number(b)*(this.panelHeight+3),c>k+g.y-this.panelHeight?(c=Math.min(c,i-g.y),this.element.style.marginTop=-c+"px",d(this,g.y,-c)):k>c&&(c=Math.max(0,c-g.y/2),this.element.style.marginTop=-c+"px",d(this,g.y,-c))),this.currentPage=b,a.getElement(f.id+"-displayregion").focus(),e.call(this,{eventSource:this.innerTracker}))},update:function(){return h[this.id].animating?(a.console.log("image reference strip update"),!0):!1}})}(OpenSeadragon),function(a){a.DisplayRect=function(b,c,d,e,f,g){a.Rect.apply(this,[b,c,d,e]),this.minLevel=f,this.maxLevel=g},a.extend(a.DisplayRect.prototype,a.Rect.prototype)}(OpenSeadragon),function(a){function b(a,b){return(1-Math.exp(a*-b))/(1-Math.exp(-a))}a.Spring=function(b){var c=arguments;"object"!=typeof b&&(b={initial:c.length&&"number"==typeof c[0]?c[0]:0,springStiffness:c.length>1?c[1].springStiffness:5,animationTime:c.length>1?c[1].animationTime:1.5}),a.extend(!0,this,b),this.current={value:"number"==typeof this.initial?this.initial:0,time:a.now()},this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time}},a.Spring.prototype={resetTo:function(a){this.target.value=a,this.target.time=this.current.time,this.start.value=this.target.value,this.start.time=this.target.time},springTo:function(a){this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=a,this.target.time=this.start.time+1e3*this.animationTime},shiftBy:function(a){this.start.value+=a,this.target.value+=a},update:function(){this.current.time=a.now(),this.current.value=this.current.time>=this.target.time?this.target.value:this.start.value+(this.target.value-this.start.value)*b(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time))}}}(OpenSeadragon),function(a){function b(b){a.extend(!0,this,{timeout:a.DEFAULT_SETTINGS.timeout,jobId:null},b),this.image=null}function c(a,b,c){var d;a.jobsInProgress--,(!a.jobLimit||a.jobsInProgress<a.jobLimit)&&a.jobQueue.length>0&&(d=a.jobQueue.shift(),d.start()),c(b.image)}b.prototype={start:function(){var a=this;this.image=new Image,a.crossOriginPolicy!==!1&&(this.image.crossOrigin=this.crossOriginPolicy),this.image.onload=function(){a.finish(!0)},this.image.onabort=this.image.onerror=function(){a.finish(!1)},this.jobId=window.setTimeout(function(){a.finish(!1)},this.timeout),this.image.src=this.src},finish:function(a){this.image.onload=this.image.onerror=this.image.onabort=null,a||(this.image=null),this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},a.ImageLoader=function(){a.extend(!0,this,{jobLimit:a.DEFAULT_SETTINGS.imageLoaderLimit,jobQueue:[],jobsInProgress:0})},a.ImageLoader.prototype={addJob:function(a){var d=this,e=function(b){c(d,b,a.callback)},f={src:a.src,callback:e},g=new b(f);!this.jobLimit||this.jobsInProgress<this.jobLimit?(g.start(),this.jobsInProgress++):this.jobQueue.push(g)}}}(OpenSeadragon),function(a){var b={};a.Tile=function(a,b,c,d,e,f){this.level=a,this.x=b,this.y=c,this.bounds=d,this.exists=e,this.url=f,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.image=null,this.style=null,this.position=null,this.size=null,this.blendStart=null,this.opacity=null,this.distance=null,this.visibility=null,this.beingDrawn=!1,this.lastTouchTime=0},a.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},drawHTML:function(b){return this.loaded&&this.image?(this.element||(this.element=a.makeNeutralElement("div"),this.imgElement=a.makeNeutralElement("img"),this.imgElement.src=this.url,this.imgElement.style.msInterpolationMode="nearest-neighbor",this.imgElement.style.width="100%",this.imgElement.style.height="100%",this.style=this.element.style,this.style.position="absolute"),this.element.parentNode!=b&&b.appendChild(this.element),this.imgElement.parentNode!=this.element&&this.element.appendChild(this.imgElement),this.style.top=this.position.y+"px",this.style.left=this.position.x+"px",this.style.height=this.size.y+"px",this.style.width=this.size.x+"px",void a.setElementOpacity(this.element,this.opacity)):void a.console.warn("Attempting to draw tile %s when it's not yet loaded.",this.toString())},drawCanvas:function(c,d){var e,f,g=this.position,h=this.size;return this.loaded&&(this.image||b[this.url])?(c.globalAlpha=this.opacity,1==c.globalAlpha&&this.url.match(".png")&&c.clearRect(g.x+1,g.y+1,h.x-2,h.y-2),b[this.url]||(f=document.createElement("canvas"),f.width=this.image.width,f.height=this.image.height,e=f.getContext("2d"),e.drawImage(this.image,0,0),b[this.url]=e,this.image=null),e=b[this.url],d({context:c,tile:this,rendered:e}),void c.drawImage(e.canvas,0,0,e.canvas.width,e.canvas.height,g.x,g.y,h.x,h.y)):void a.console.warn("Attempting to draw tile %s when it's not yet loaded.",this.toString())},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),b[this.url]&&delete b[this.url],this.element=null,this.imgElement=null,this.image=null,this.loaded=!1,this.loading=!1}}}(OpenSeadragon),function(a){a.OverlayPlacement={CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8},a.Overlay=function(b,c,d){var e;e=a.isPlainObject(b)?b:{element:b,location:c,placement:d},this.element=e.element,this.scales=e.location instanceof a.Rect,this.bounds=new a.Rect(e.location.x,e.location.y,e.location.width,e.location.height),this.position=new a.Point(e.location.x,e.location.y),this.size=new a.Point(e.location.width,e.location.height),this.style=e.element.style,this.placement=e.location instanceof a.Point?e.placement:a.OverlayPlacement.TOP_LEFT,this.onDraw=e.onDraw,this.checkResize=void 0===e.checkResize?!0:e.checkResize},a.Overlay.prototype={adjust:function(b,c){switch(this.placement){case a.OverlayPlacement.TOP_LEFT:break;case a.OverlayPlacement.TOP:b.x-=c.x/2;break;case a.OverlayPlacement.TOP_RIGHT:b.x-=c.x;break;case a.OverlayPlacement.RIGHT:b.x-=c.x,b.y-=c.y/2;break;case a.OverlayPlacement.BOTTOM_RIGHT:b.x-=c.x,b.y-=c.y;break;case a.OverlayPlacement.BOTTOM:b.x-=c.x/2,b.y-=c.y;break;case a.OverlayPlacement.BOTTOM_LEFT:b.y-=c.y;break;case a.OverlayPlacement.LEFT:b.y-=c.y/2;break;default:case a.OverlayPlacement.CENTER:b.x-=c.x/2,b.y-=c.y/2}},destroy:function(){var a=this.element,b=this.style;a.parentNode&&(a.parentNode.removeChild(a),a.prevElementParent&&(b.display="none",document.body.appendChild(a))),this.onDraw=null,b.top="",b.left="",b.position="",this.scales&&(b.width="",b.height="")},drawHTML:function(b,c){var d,e,f=this.element,g=this.style,h=this.scales,i=c.degrees,j=c.pixelFromPoint(this.bounds.getTopLeft(),!0);if(f.parentNode!=b&&(f.prevElementParent=f.parentNode,f.prevNextSibling=f.nextSibling,b.appendChild(f),this.size=a.getElementSize(f)),d=h?c.deltaPixelsFromPoints(this.bounds.getSize(),!0):this.checkResize?a.getElementSize(f):this.size,this.position=j,this.size=d,this.adjust(j,d),j=j.apply(Math.floor),d=d.apply(Math.ceil),0!==i&&this.scales){e=new a.Point(d.x/2,d.y/2);var k=new a.Point(c.viewer.drawer.canvas.width/2,c.viewer.drawer.canvas.height/2);j=j.plus(e).rotate(i,k).minus(e),d=d.rotate(i,new a.Point(0,0)),d=new a.Point(Math.abs(d.x),Math.abs(d.y))}this.onDraw?this.onDraw(j,d,f):(g.left=j.x+"px",g.top=j.y+"px",g.position="absolute",g.display="block",h&&(g.width=d.x+"px",g.height=d.y+"px"))},update:function(b,c){this.scales=b instanceof a.Rect,this.bounds=new a.Rect(b.x,b.y,b.width,b.height),this.placement=b instanceof a.Point?c:a.OverlayPlacement.TOP_LEFT}}}(OpenSeadragon),function(a){function b(b){b.updateAgain=!1,b.viewer&&b.viewer.raiseEvent("update-viewport",{});for(var d,e,g,h,i,j,l,m,n=null,o=!1,q=a.now(),r=b.viewport.getContainerSize(),s=b.viewport.getBounds(!0),t=s.getTopLeft(),u=s.getBottomRight(),v=b.viewport.deltaPixelsFromPoints(b.source.getPixelRatio(0),!0).x,w=Math.max(b.source.minLevel,Math.floor(Math.log(b.minZoomImageRatio)/Math.log(2))),x=Math.min(Math.abs(b.source.maxLevel),Math.abs(Math.floor(Math.log(v/b.minPixelRatio)/Math.log(2)))),y=b.viewport.degrees;b.lastDrawn.length>0;)d=b.lastDrawn.pop(),d.beingDrawn=!1;
if(b.canvas.innerHTML="",b.useCanvas&&((b.canvas.width!=r.x||b.canvas.height!=r.y)&&(b.canvas.width=r.x,b.canvas.height=r.y),b.context.clearRect(0,0,r.x,r.y)),90===y||270===y){var z=s.rotate(y);t=z.getTopLeft(),u=z.getBottomRight()}if(!(!b.wrapHorizontal&&(u.x<0||t.x>1)||!b.wrapVertical&&(u.y<0||t.y>b.normHeight))){b.wrapHorizontal||(t.x=Math.max(t.x,0),u.x=Math.min(u.x,1)),b.wrapVertical||(t.y=Math.max(t.y,0),u.y=Math.min(u.y,b.normHeight)),w=Math.min(w,x);var A;for(e=x;e>=w;e--){if(A=!1,g=b.viewport.deltaPixelsFromPoints(b.source.getPixelRatio(e),!0).x,!o&&g>=b.minPixelRatio||e==w)A=!0,o=!0;else if(!o)continue;if(h=b.viewport.deltaPixelsFromPoints(b.source.getPixelRatio(e),!1).x,i=b.viewport.deltaPixelsFromPoints(b.source.getPixelRatio(Math.max(b.source.getClosestLevel(b.viewport.containerSize)-1,0)),!1).x,j=b.immediateRender?1:i,l=Math.min(1,(g-.5)/.5),m=j/Math.abs(j-h),n=c(b,o,A,e,l,m,t,u,q,n),k(b.coverage,e))break}p(b,b.lastDrawn),n&&(f(b,n,q),b.updateAgain=!0)}}function c(a,b,c,e,f,g,h,i,j,k){var l,m,o,p,q,r=a.viewport.pixelFromPoint(a.viewport.getCenter());for(a.viewer&&a.viewer.raiseEvent("update-level",{havedrawn:b,level:e,opacity:f,visibility:g,topleft:h,bottomright:i,currenttime:j,best:k}),o=a.source.getTileAtPoint(e,h),p=a.source.getTileAtPoint(e,i),q=a.source.getNumTiles(e),n(a.coverage,e),a.wrapHorizontal||(p.x=Math.min(p.x,q.x-1)),a.wrapVertical||(p.y=Math.min(p.y,q.y-1)),l=o.x;l<=p.x;l++)for(m=o.y;m<=p.y;m++)k=d(a,c,b,l,m,e,f,g,r,q,j,k);return k}function d(a,b,c,d,f,g,j,k,n,p,q,r){var s=e(d,f,g,a.source,a.tilesMatrix,q,p,a.normHeight),t=b;if(a.viewer&&a.viewer.raiseEvent("update-tile",{tile:s}),m(a.coverage,g,d,f,!1),!s.exists)return r;if(c&&!t&&(l(a.coverage,g,d,f)?m(a.coverage,g,d,f,!0):t=!0),!t)return r;if(h(s,a.source.tileOverlap,a.viewport,n,k),s.loaded){var u=i(a,s,d,f,g,j,q);u&&(a.updateAgain=!0)}else s.loading||(r=o(r,s));return r}function e(b,c,d,e,f,g,h,i){var j,k,l,m,n,o;return f[d]||(f[d]={}),f[d][b]||(f[d][b]={}),f[d][b][c]||(j=(h.x+b%h.x)%h.x,k=(h.y+c%h.y)%h.y,l=e.getTileBounds(d,j,k),m=e.tileExists(d,j,k),n=e.getTileUrl(d,j,k),l.x+=1*(b-j)/h.x,l.y+=i*(c-k)/h.y,f[d][b][c]=new a.Tile(d,b,c,l,m,n)),o=f[d][b][c],o.lastTouchTime=g,o}function f(a,b,c){a.viewport.collectionMode?(a.midUpdate=!1,g(a,b,c)):(b.loading=!0,a.imageLoader.addJob({src:b.url,callback:function(d){g(a,b,c,d)}}))}function g(b,c,d,e){var f,g,h,i,j,k,l,m,n,o;if(c.loading=!1,b.midUpdate)return void a.console.warn("Tile load callback in middle of drawing routine.");if(e||b.viewport.collectionMode){if(d<b.lastResetTime)return void a.console.log("Ignoring tile %s loaded before reset: %s",c,c.url)}else if(a.console.log("Tile %s failed to load: %s",c,c.url),!b.debugMode)return void(c.exists=!1);if(c.loaded=!0,c.image=e,f=b.tilesLoaded.length,b.tilesLoaded.length>=b.maxImageCacheCount){for(g=Math.ceil(Math.log(b.source.tileSize)/Math.log(2)),h=null,k=-1,o=b.tilesLoaded.length-1;o>=0;o--)l=b.tilesLoaded[o],l.level<=b.cutoff||l.beingDrawn||(h?(m=l.lastTouchTime,i=h.lastTouchTime,n=l.level,j=h.level,(i>m||m==i&&n>j)&&(h=l,k=o)):(h=l,k=o));h&&k>=0&&(h.unload(),f=k)}b.tilesLoaded[f]=c,b.updateAgain=!0}function h(b,c,d,e,f){var g=b.bounds.getTopLeft(),h=b.bounds.getSize(),i=d.pixelFromPoint(g,!0),j=d.pixelFromPoint(g,!1),k=d.deltaPixelsFromPoints(h,!0),l=d.deltaPixelsFromPoints(h,!1),m=j.plus(l.divide(2)),n=e.distanceTo(m);c||(k=k.plus(new a.Point(1,1))),b.position=i,b.size=k,b.distance=n,b.visibility=f}function i(a,b,c,d,e,f,g){var h,i,j=1e3*a.blendTime;if(b.blendStart||(b.blendStart=g),h=g-b.blendStart,i=j?Math.min(1,h/j):1,a.alwaysBlend&&(i*=f),b.opacity=i,a.lastDrawn.push(b),1==i)m(a.coverage,e,c,d,!0);else if(j>h)return!0;return!1}function j(a){a.tilesMatrix={},a.tilesLoaded=[]}function k(a,b,c,d){var e,f,g,h;if(!a[b])return!1;if(void 0===c||void 0===d){e=a[b];for(g in e)if(e.hasOwnProperty(g)){f=e[g];for(h in f)if(f.hasOwnProperty(h)&&!f[h])return!1}return!0}return void 0===a[b][c]||void 0===a[b][c][d]||a[b][c][d]===!0}function l(a,b,c,d){return void 0===c||void 0===d?k(a,b+1):k(a,b+1,2*c,2*d)&&k(a,b+1,2*c,2*d+1)&&k(a,b+1,2*c+1,2*d)&&k(a,b+1,2*c+1,2*d+1)}function m(b,c,d,e,f){return b[c]?(b[c][d]||(b[c][d]={}),void(b[c][d][e]=f)):void a.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",c)}function n(a,b){a[b]={}}function o(a,b){return a?b.visibility>a.visibility?b:b.visibility==a.visibility&&b.distance<a.distance?b:a:b}function p(b,c){var d,e,f,g,h,i,j,k,l=function(a){b.viewer&&b.viewer.raiseEvent("tile-drawing",a)};for(d=c.length-1;d>=0;d--){if(e=c[d],b.viewport.collectionMode?(f=e.x+"/"+e.y,h=b.viewport,k=h.collectionTileSource,b.collectionOverlays[f]?(g=b.collectionOverlays[f],g.viewport&&(g.viewport.resize(e.size,!0),g.viewport.goHome(!0))):(i="horizontal"==k.layout?e.y+e.x*k.rows:e.x+e.y*k.rows,j=i<k.tileSources.length?k.tileSources[i]:null,j&&(b.collectionOverlays[f]=g=new a.Viewer({hash:h.viewer.hash+"-"+f,element:a.makeNeutralElement("div"),mouseNavEnabled:!1,showNavigator:!1,showSequenceControl:!1,showNavigationControl:!1,tileSources:[j]}),v&&(g.element.style.border="1px solid rgba(255,255,255,0.38)",g.element.style["-webkit-box-reflect"]="below 0px -webkit-gradient(linear,left top,left bottom,from(transparent),color-stop(62%,transparent),to(rgba(255,255,255,0.62)))"),b.viewer.addOverlay(g.element,e.bounds)))):(b.useCanvas?0!==b.viewport.degrees?(q(e,b.canvas,b.context,b.viewport.degrees),e.drawCanvas(b.context,l),r(e,b.canvas,b.context)):e.drawCanvas(b.context,l):e.drawHTML(b.canvas),e.beingDrawn=!0),b.debugMode)try{s(b,e,c.length,d)}catch(m){a.console.error(m)}b.viewer&&b.viewer.raiseEvent("tile-drawn",{tile:e})}}function q(a,b,c,d){var e=b.width/2,f=b.height/2,g=a.position.x-e,h=a.position.y-f;c.save(),c.translate(e,f),c.rotate(Math.PI/180*d),a.position.x=g,a.position.y=h}function r(a,b,c){var d=b.width/2,e=b.height/2,f=a.position.x+d,g=a.position.y+e;a.position.x=f,a.position.y=g,c.restore()}function s(a,b,c,d){a.useCanvas&&(a.context.save(),a.context.lineWidth=2,a.context.font="small-caps bold 13px ariel",a.context.strokeStyle=a.debugGridColor,a.context.fillStyle=a.debugGridColor,a.context.strokeRect(b.position.x,b.position.y,b.size.x,b.size.y),0===b.x&&0===b.y&&(a.context.fillText("Zoom: "+a.viewport.getZoom(),b.position.x,b.position.y-30),a.context.fillText("Pan: "+a.viewport.getBounds().toString(),b.position.x,b.position.y-20)),a.context.fillText("Level: "+b.level,b.position.x+10,b.position.y+20),a.context.fillText("Column: "+b.x,b.position.x+10,b.position.y+30),a.context.fillText("Row: "+b.y,b.position.x+10,b.position.y+40),a.context.fillText("Order: "+d+" of "+c,b.position.x+10,b.position.y+50),a.context.fillText("Size: "+b.size.toString(),b.position.x+10,b.position.y+60),a.context.fillText("Position: "+b.position.toString(),b.position.x+10,b.position.y+70),a.context.restore())}var t=(a.getWindowSize(),a.Browser.vendor),u=a.Browser.version,v=t==a.BROWSERS.FIREFOX||t==a.BROWSERS.OPERA||t==a.BROWSERS.SAFARI&&u>=4||t==a.BROWSERS.CHROME&&u>=2||t==a.BROWSERS.IE&&u>=9;a.Drawer=function(b){var c=arguments;a.isPlainObject(b)||(b={source:c[0],viewport:c[1],element:c[2]}),a.extend(!0,this,{viewer:null,imageLoader:new a.ImageLoader,tilesMatrix:{},tilesLoaded:[],coverage:{},lastDrawn:[],lastResetTime:0,midUpdate:!1,updateAgain:!0,collectionOverlays:{},opacity:a.DEFAULT_SETTINGS.opacity,maxImageCacheCount:a.DEFAULT_SETTINGS.maxImageCacheCount,minZoomImageRatio:a.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:a.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:a.DEFAULT_SETTINGS.wrapVertical,immediateRender:a.DEFAULT_SETTINGS.immediateRender,blendTime:a.DEFAULT_SETTINGS.blendTime,alwaysBlend:a.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:a.DEFAULT_SETTINGS.minPixelRatio,debugMode:a.DEFAULT_SETTINGS.debugMode,timeout:a.DEFAULT_SETTINGS.timeout,crossOriginPolicy:a.DEFAULT_SETTINGS.crossOriginPolicy},b),this.useCanvas=a.supportsCanvas&&(this.viewer?this.viewer.useCanvas:!0),this.container=a.getElement(this.element),this.canvas=a.makeNeutralElement(this.useCanvas?"canvas":"div"),this.context=this.useCanvas?this.canvas.getContext("2d"):null,this.normHeight=this.source.dimensions.y/this.source.dimensions.x,this.element=this.container,this.container.dir="ltr",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",a.setElementOpacity(this.canvas,this.opacity,!0),this.container.style.textAlign="left",this.container.appendChild(this.canvas)},a.Drawer.prototype={addOverlay:function(b,c,d,e){return a.console.error("drawer.addOverlay is deprecated. Use viewer.addOverlay instead."),this.viewer.addOverlay(b,c,d,e),this},updateOverlay:function(b,c,d){return a.console.error("drawer.updateOverlay is deprecated. Use viewer.updateOverlay instead."),this.viewer.updateOverlay(b,c,d),this},removeOverlay:function(b){return a.console.error("drawer.removeOverlay is deprecated. Use viewer.removeOverlay instead."),this.viewer.removeOverlay(b),this},clearOverlays:function(){return a.console.error("drawer.clearOverlays is deprecated. Use viewer.clearOverlays instead."),this.viewer.clearOverlays(),this},setOpacity:function(b){return this.opacity=b,a.setElementOpacity(this.canvas,this.opacity,!0),this},getOpacity:function(){return this.opacity},needsUpdate:function(){return this.updateAgain},numTilesLoaded:function(){return this.tilesLoaded.length},reset:function(){return j(this),this.lastResetTime=a.now(),this.updateAgain=!0,this},update:function(){return this.midUpdate=!0,b(this),this.midUpdate=!1,this},canRotate:function(){return this.useCanvas},destroy:function(){for(var a=0;a<this.tilesLoaded.length;++a)this.tilesLoaded[a].unload();this.canvas.width=1,this.canvas.height=1}}}(OpenSeadragon),function(a){a.Viewport=function(b){var c=arguments;c.length&&c[0]instanceof a.Point&&(b={containerSize:c[0],contentSize:c[1],config:c[2]}),b.config&&(a.extend(!0,b,b.config),delete b.config),a.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,viewer:null,springStiffness:a.DEFAULT_SETTINGS.springStiffness,animationTime:a.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:a.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:a.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:a.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:a.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:a.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:a.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:a.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:a.DEFAULT_SETTINGS.maxZoomLevel,degrees:a.DEFAULT_SETTINGS.degrees},b),this.centerSpringX=new a.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new a.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new a.Spring({initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.resetContentSize(this.contentSize),this.goHome(!0),this.update()},a.Viewport.prototype={resetContentSize:function(b){return this.contentSize=b,this.contentAspectX=this.contentSize.x/this.contentSize.y,this.contentAspectY=this.contentSize.y/this.contentSize.x,this.fitWidthBounds=new a.Rect(0,0,1,this.contentAspectY),this.fitHeightBounds=new a.Rect(0,0,this.contentAspectY,this.contentAspectY),this.homeBounds=new a.Rect(0,0,1,this.contentAspectY),this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:b}),this},getHomeZoom:function(){var a=this.contentAspectX/this.getAspectRatio();return this.defaultZoomLevel?this.defaultZoomLevel:a>=1?1:a},getHomeBounds:function(){var b=this.homeBounds.getCenter(),c=1/this.getHomeZoom(),d=c/this.getAspectRatio();return new a.Rect(b.x-c/2,b.y-d/2,c,d)},goHome:function(a){return this.viewer&&this.viewer.raiseEvent("home",{immediately:a}),this.fitBounds(this.getHomeBounds(),a)},getMinZoom:function(){var a=this.getHomeZoom(),b=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*a;return Math.min(b,a)},getMaxZoom:function(){var a=this.maxZoomLevel?this.maxZoomLevel:this.contentSize.x*this.maxZoomPixelRatio/this.containerSize.x;return Math.max(a,this.getHomeZoom())},getAspectRatio:function(){return this.containerSize.x/this.containerSize.y},getContainerSize:function(){return new a.Point(this.containerSize.x,this.containerSize.y)},getBounds:function(b){var c=this.getCenter(b),d=1/this.getZoom(b),e=d/this.getAspectRatio();return new a.Rect(c.x-d/2,c.y-e/2,d,e)},getCenter:function(b){var c,d,e,f,g,h,i,j,k=new a.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),l=new a.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return b?k:this.zoomPoint?(c=this.pixelFromPoint(this.zoomPoint,!0),d=this.getZoom(),e=1/d,f=e/this.getAspectRatio(),g=new a.Rect(k.x-e/2,k.y-f/2,e,f),h=this.zoomPoint.minus(g.getTopLeft()).times(this.containerSize.x/g.width),i=h.minus(c),j=i.divide(this.containerSize.x*d),l.plus(j)):l},getZoom:function(a){return a?this.zoomSpring.current.value:this.zoomSpring.target.value},applyConstraints:function(a){var b,c,d,e,f,g,h,i=this.getZoom(),j=Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom()),k=0,l=0;return i!=j&&this.zoomTo(j,this.zoomPoint,a),b=this.getBounds(),c=this.visibilityRatio*b.width,d=this.visibilityRatio*b.height,e=b.x+b.width,f=1-b.x,g=b.y+b.height,h=this.contentAspectY-b.y,this.wrapHorizontal||(c>e&&(k=c-e),c>f&&(k=k?(k+f-c)/2:f-c)),this.wrapVertical||(d>g&&(l=d-g),d>h&&(l=l?(l+h-d)/2:h-d)),(k||l||a)&&(b.x+=k,b.y+=l,b.width>1&&(b.x=.5-b.width/2),b.height>this.contentAspectY&&(b.y=this.contentAspectY/2-b.height/2),this.fitBounds(b,a)),this.viewer&&this.viewer.raiseEvent("constrain",{immediately:a}),this},ensureVisible:function(a){return this.applyConstraints(a)},fitBounds:function(b,c){var d,e,f,g,h=this.getAspectRatio(),i=b.getCenter(),j=new a.Rect(b.x,b.y,b.width,b.height);return j.getAspectRatio()>=h?(j.height=b.width/h,j.y=i.y-j.height/2):(j.width=b.height*h,j.x=i.x-j.width/2),this.panTo(this.getCenter(!0),!0),this.zoomTo(this.getZoom(!0),null,!0),d=this.getBounds(),e=this.getZoom(),f=1/j.width,f==e||j.width==d.width?this.panTo(i,c):(g=d.getTopLeft().times(this.containerSize.x/d.width).minus(j.getTopLeft().times(this.containerSize.x/j.width)).divide(this.containerSize.x/d.width-this.containerSize.x/j.width),this.zoomTo(f,g,c))},fitVertically:function(a){var b=this.getCenter();return this.wrapHorizontal&&(b.x=(1+b.x%1)%1,this.centerSpringX.resetTo(b.x),this.centerSpringX.update()),this.wrapVertical&&(b.y=(this.contentAspectY+b.y%this.contentAspectY)%this.contentAspectY,this.centerSpringY.resetTo(b.y),this.centerSpringY.update()),this.fitBounds(this.fitHeightBounds,a)},fitHorizontally:function(a){var b=this.getCenter();return this.wrapHorizontal&&(b.x=(this.contentAspectX+b.x%this.contentAspectX)%this.contentAspectX,this.centerSpringX.resetTo(b.x),this.centerSpringX.update()),this.wrapVertical&&(b.y=(1+b.y%1)%1,this.centerSpringY.resetTo(b.y),this.centerSpringY.update()),this.fitBounds(this.fitWidthBounds,a)},panBy:function(b,c){var d=new a.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return b=b.rotate(-this.degrees,new a.Point(0,0)),this.panTo(d.plus(b),c)},panTo:function(a,b){return b?(this.centerSpringX.resetTo(a.x),this.centerSpringY.resetTo(a.y)):(this.centerSpringX.springTo(a.x),this.centerSpringY.springTo(a.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:a,immediately:b}),this},zoomBy:function(b,c,d){return c instanceof a.Point&&!isNaN(c.x)&&!isNaN(c.y)&&(c=c.rotate(-this.degrees,new a.Point(this.centerSpringX.target.value,this.centerSpringY.target.value))),this.zoomTo(this.zoomSpring.target.value*b,c,d)},zoomTo:function(b,c,d){return this.zoomPoint=c instanceof a.Point&&!isNaN(c.x)&&!isNaN(c.y)?c:null,d?this.zoomSpring.resetTo(b):this.zoomSpring.springTo(b),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:b,refPoint:c,immediately:d}),this},setRotation:function(a){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(a=(a+360)%360,a%90!==0)throw new Error("Currently only 0, 90, 180, and 270 degrees are supported.");return this.degrees=a,this.viewer.forceRedraw(),this},getRotation:function(){return this.degrees},resize:function(b,c){var d,e=this.getBounds(),f=e;return this.containerSize=new a.Point(b.x,b.y),c&&(d=b.x/this.containerSize.x,f.width=e.width*d,f.height=f.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:b,maintain:c}),this.fitBounds(f,!0)},update:function(){var a,b,c,d,e=this.centerSpringX.current.value,f=this.centerSpringY.current.value,g=this.zoomSpring.current.value;return this.zoomPoint&&(a=this.pixelFromPoint(this.zoomPoint,!0)),this.zoomSpring.update(),this.zoomPoint&&this.zoomSpring.current.value!=g?(b=this.pixelFromPoint(this.zoomPoint,!0),c=b.minus(a),d=this.deltaPointsFromPixels(c,!0),this.centerSpringX.shiftBy(d.x),this.centerSpringY.shiftBy(d.y)):this.zoomPoint=null,this.centerSpringX.update(),this.centerSpringY.update(),this.centerSpringX.current.value!=e||this.centerSpringY.current.value!=f||this.zoomSpring.current.value!=g},deltaPixelsFromPoints:function(a,b){return a.times(this.containerSize.x*this.getZoom(b))},deltaPointsFromPixels:function(a,b){return a.divide(this.containerSize.x*this.getZoom(b))},pixelFromPoint:function(a,b){var c=this.getBounds(b);return a.minus(c.getTopLeft()).times(this.containerSize.x/c.width)},pointFromPixel:function(a,b){var c=this.getBounds(b);return a.divide(this.containerSize.x/c.width).plus(c.getTopLeft())},viewportToImageCoordinates:function(b,c){return 1==arguments.length?this.viewportToImageCoordinates(b.x,b.y):new a.Point(b*this.contentSize.x,c*this.contentSize.y*this.contentAspectX)},imageToViewportCoordinates:function(b,c){return 1==arguments.length?this.imageToViewportCoordinates(b.x,b.y):new a.Point(b/this.contentSize.x,c/this.contentSize.y/this.contentAspectX)},imageToViewportRectangle:function(b,c,d,e){var f,g,h;return 1==arguments.length?(h=b,this.imageToViewportRectangle(h.x,h.y,h.width,h.height)):(f=this.imageToViewportCoordinates(b,c),g=this.imageToViewportCoordinates(d,e),new a.Rect(f.x,f.y,g.x,g.y))},viewportToImageRectangle:function(b,c,d,e){var f,g,h;return 1==arguments.length?(h=b,this.viewportToImageRectangle(h.x,h.y,h.width,h.height)):(f=this.viewportToImageCoordinates(b,c),g=this.viewportToImageCoordinates(d,e),new a.Rect(f.x,f.y,g.x,g.y))},viewerElementToImageCoordinates:function(a){var b=this.pointFromPixel(a,!0);return this.viewportToImageCoordinates(b)},imageToViewerElementCoordinates:function(a){var b=this.imageToViewportCoordinates(a);return this.pixelFromPoint(b,!0)},windowToImageCoordinates:function(a){var b=a.minus(OpenSeadragon.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(b)},imageToWindowCoordinates:function(a){var b=this.imageToViewerElementCoordinates(a);return b.plus(OpenSeadragon.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(a){return this.pointFromPixel(a,!0)},viewportToViewerElementCoordinates:function(a){return this.pixelFromPoint(a,!0)},windowToViewportCoordinates:function(a){var b=a.minus(OpenSeadragon.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(b)},viewportToWindowCoordinates:function(a){var b=this.viewportToViewerElementCoordinates(a);return b.plus(OpenSeadragon.getElementPosition(this.viewer.element))},viewportToImageZoom:function(a){var b=this.viewer.source.dimensions.x,c=this.getContainerSize().x,d=c/b;return a*d},imageToViewportZoom:function(a){var b=this.viewer.source.dimensions.x,c=this.getContainerSize().x,d=b/c;return a*d}}}(OpenSeadragon);


/*!
 * Autolinker.js
 * 0.7.0
 *
 * Copyright(c) 2014 Gregory Jacobs <greg@greg-jacobs.com>
 * MIT Licensed. http://www.opensource.org/licenses/mit-license.php
 *
 * https://github.com/gregjacobs/Autolinker.js
 */
!function(a,b){"function"==typeof define&&define.amd?define(b):"undefined"!=typeof exports?module.exports=b():a.Autolinker=b()}(this,function(){var a={htmlRegex:/<(\/)?(\w+)(?:(?:\s+\w+(?:\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/g,prefixRegex:/^(https?:\/\/)?(www\.)?/,link:function(b,c){function d(b){return b=b.replace(h,function(b,c,d,e,f,g){var h=c,o=d,p=e,q=f,r=g,s="",t="",u=[],v=b.charAt(b.length-1);if(")"===v){var w=b.match(/\(/g),x=b.match(/\)/g),y=w&&w.length||0,z=x&&x.length||0;z>y&&(b=b.substr(0,b.length-1),t=")")}var A=b,B=b;return h&&!l||q&&!m||r&&!n?s+B+t:(h?(s=o,A="https://twitter.com/"+p,B="@"+p):q?(A="mailto:"+q,B=q):/^[A-Za-z]{3,9}:/i.test(A)||(A="http://"+A),j&&(B=B.replace(a.prefixRegex,"")),"/"===B.charAt(B.length-1)&&(B=B.slice(0,-1)),u.push('href="'+A+'"'),i&&u.push('target="_blank"'),k&&B.length>k&&(B=B.substring(0,k-2)+".."),s+"<a "+u.join(" ")+">"+B+"</a>"+t)})}c=c||{};for(var e,f,g=a.htmlRegex,h=a.matcherRegex,i=("newWindow"in c?c.newWindow:!0),j=("stripPrefix"in c?c.stripPrefix:!0),k=c.truncate,l=("twitter"in c?c.twitter:!0),m=("email"in c?c.email:!0),n=("urls"in c?c.urls:!0),o=0,p="",q=0;null!==(e=g.exec(b));){var r=e[0],s=e[2],t=!!e[1];f=b.substring(o,e.index),o=e.index+r.length,"a"===s?t?(q--,0===q&&(p+=f)):(q++,p+=d(f)):0===q&&(p+=d(f)),p+=r}return o<b.length&&(p+=d(b.substring(o))),p},matcherRegex:function(){var a=/(^|\s)@(\w{1,15})/,b=/(?:[\-;:&=\+\$,\w\.]+@)/,c=/(?:[A-Za-z]{3,9}:(?:\/\/)?)/,d=/(?:www\.)/,e=/[A-Za-z0-9\.\-]*[A-Za-z0-9\-]/,f=/\.(?:international|construction|contractors|enterprises|photography|productions|foundation|immobilien|industries|management|properties|technology|christmas|community|directory|education|equipment|institute|marketing|solutions|vacations|bargains|boutique|builders|catering|cleaning|clothing|computer|democrat|diamonds|graphics|holdings|lighting|partners|plumbing|supplies|training|ventures|academy|careers|company|cruises|domains|exposed|flights|florist|gallery|guitars|holiday|kitchen|neustar|okinawa|recipes|rentals|reviews|shiksha|singles|support|systems|agency|berlin|camera|center|coffee|condos|dating|estate|events|expert|futbol|kaufen|luxury|maison|monash|museum|nagoya|photos|repair|report|social|supply|tattoo|tienda|travel|viajes|villas|vision|voting|voyage|actor|build|cards|cheap|codes|dance|email|glass|house|mango|ninja|parts|photo|shoes|solar|today|tokyo|tools|watch|works|aero|arpa|asia|best|bike|blue|buzz|camp|club|cool|coop|farm|fish|gift|guru|info|jobs|kiwi|kred|land|limo|link|menu|mobi|moda|name|pics|pink|post|qpon|rich|ruhr|sexy|tips|vote|voto|wang|wien|wiki|zone|bar|bid|biz|cab|cat|ceo|com|edu|gov|int|kim|mil|net|onl|org|pro|pub|red|tel|uno|wed|xxx|xyz|ac|ad|ae|af|ag|ai|al|am|an|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bm|bn|bo|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cu|cv|cw|cx|cy|cz|de|dj|dk|dm|do|dz|ec|ee|eg|er|es|et|eu|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|st|su|sv|sx|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tp|tr|tt|tv|tw|tz|ua|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw)\b/,g=/(?:[-A-Za-z0-9+&@#\/%?=~_()|!:,.;]*[-A-Za-z0-9+&@#\/%=~_()|])?/;return new RegExp(["(",a.source,")","|","(",b.source,e.source,f.source,")","|","(","(?:","(?:",c.source,e.source,")","|","(?:",d.source,e.source,")","|","(?:",e.source,f.source,")",")",g.source,")"].join(""),"g")}()};return a});
"use strict";

/**
 * @author Eberhard Graether / http://egraether.com/
 */

THREE.TrackballControls = function ( object, domElement ) {

	var _this = this;
	var STATE = { NONE: -1, ROTATE: 0, ZOOM: 1, PAN: 2, TOUCH_ROTATE: 3, TOUCH_ZOOM: 4, TOUCH_PAN: 5 };

	this.object = object;
	this.domElement = ( domElement !== undefined ) ? domElement : document;

	// API

	this.enabled = true;

	this.setEnabled = function(enabled) {
		if (_this.enabled && enabled || !_this.enabled && !enabled) {
			return;
		}
		else if (enabled) {
			enable();
			_this.onCameraMove();
		}
		else if (!enabled) {
			disable();
		}
	};

	this.destroy = function() {
		disable();
	};

	this.isEnabled = function() {
		return _this.enabled;
	};

	this.onCameraMove = function() {};

	this.screen = { left: 0, top: 0, width: 0, height: 0 };

	this.rotateSpeed = 1.0;
	this.zoomSpeed = 1.2;
	this.panSpeed = 0.3;

	this.noRotate = false;
	this.noZoom = false;
	this.noPan = false;
	this.noRoll = false;

	this.staticMoving = false;
	this.dynamicDampingFactor = 0.2;

	this.minDistance = 0;
	this.maxDistance = Infinity;

	this.keys = [ 65 /*A*/, 83 /*S*/, 68 /*D*/ ];

	// internals

	this.target = new THREE.Vector3();

	var lastPosition = new THREE.Vector3();

	var _state = STATE.NONE,
	_prevState = STATE.NONE,

	_eye = new THREE.Vector3(),

	_rotateStart = new THREE.Vector3(),
	_rotateEnd = new THREE.Vector3(),

	_zoomStart = new THREE.Vector2(),
	_zoomEnd = new THREE.Vector2(),

	_touchZoomDistanceStart = 0,
	_touchZoomDistanceEnd = 0,

	_panStart = new THREE.Vector2(),
	_panEnd = new THREE.Vector2();

	// for reset

	this.target0 = this.target.clone();
	this.position0 = this.object.position.clone();
	this.up0 = this.object.up.clone();

	// events

	var changeEvent = { type: 'change' };


	// methods

	this.handleResize = function () {

		if ( this.domElement === document ) {

			this.screen.left = 0;
			this.screen.top = 0;
			this.screen.width = window.innerWidth;
			this.screen.height = window.innerHeight;

		} else {

			this.screen = this.domElement.getBoundingClientRect();

		}

	};

	this.handleEvent = function ( event ) {

		if ( typeof this[ event.type ] === 'function' ) {

			this[ event.type ]( event );

		}

	};

	this.getMouseOnScreen = function ( clientX, clientY ) {

		return new THREE.Vector2(
			( clientX - _this.screen.left ) / _this.screen.width,
			( clientY - _this.screen.top ) / _this.screen.height
		);

	};

	this.getMouseProjectionOnBall = function ( clientX, clientY ) {

		var mouseOnBall = new THREE.Vector3(
			( clientX - _this.screen.width * 0.5 - _this.screen.left ) / (_this.screen.width*0.5),
			( _this.screen.height * 0.5 + _this.screen.top - clientY ) / (_this.screen.height*0.5),
			0.0
		);

		var length = mouseOnBall.length();

		if ( _this.noRoll ) {

			if ( length < Math.SQRT1_2 ) {

				mouseOnBall.z = Math.sqrt( 1.0 - length*length );

			} else {

				mouseOnBall.z = 0.5 / length;

			}

		} else if ( length > 1.0 ) {

			mouseOnBall.normalize();

		} else {

			mouseOnBall.z = Math.sqrt( 1.0 - length * length );

		}

		_eye.copy( _this.object.position ).sub( _this.target );

		var projection = _this.object.up.clone().setLength( mouseOnBall.y );
		projection.add( _this.object.up.clone().cross( _eye ).setLength( mouseOnBall.x ) );
		projection.add( _eye.setLength( mouseOnBall.z ) );

		return projection;

	};

	this.rotateCamera = function () {

		var angle = Math.acos( _rotateStart.dot( _rotateEnd ) / _rotateStart.length() / _rotateEnd.length() );

		if ( angle ) {

			_this.onCameraMove();

			var axis = ( new THREE.Vector3() ).crossVectors( _rotateStart, _rotateEnd ).normalize(),
				quaternion = new THREE.Quaternion();

			angle *= _this.rotateSpeed;

			quaternion.setFromAxisAngle( axis, -angle );

			_eye.applyQuaternion( quaternion );
			_this.object.up.applyQuaternion( quaternion );

			_rotateEnd.applyQuaternion( quaternion );

			if ( _this.staticMoving ) {

				_rotateStart.copy( _rotateEnd );

			} else {

				quaternion.setFromAxisAngle( axis, angle * ( _this.dynamicDampingFactor - 1.0 ) );
				_rotateStart.applyQuaternion( quaternion );

			}

		}

	};

	this.zoomCamera = function () {

		if ( _state === STATE.TOUCH_ZOOM ) {

			_this.onCameraMove();

			var factor = _touchZoomDistanceStart / _touchZoomDistanceEnd;
			_touchZoomDistanceStart = _touchZoomDistanceEnd;
			_eye.multiplyScalar( factor );

		} else {

			var factor = 1.0 + ( _zoomEnd.y - _zoomStart.y ) * _this.zoomSpeed;

			if ( factor !== 1.0 && factor > 0.0 ) {

				_this.onCameraMove();

				_eye.multiplyScalar( factor );

				if ( _this.staticMoving ) {

					_zoomStart.copy( _zoomEnd );

				} else {

					_zoomStart.y += ( _zoomEnd.y - _zoomStart.y ) * this.dynamicDampingFactor;

				}

			}

		}

	};

	this.panCamera = function () {

		var mouseChange = _panEnd.clone().sub( _panStart );

		if ( mouseChange.lengthSq() ) {

			_this.onCameraMove();

			mouseChange.multiplyScalar( _eye.length() * _this.panSpeed );

			var pan = _eye.clone().cross( _this.object.up ).setLength( mouseChange.x );
			pan.add( _this.object.up.clone().setLength( mouseChange.y ) );

			_this.object.position.add( pan );
			_this.target.add( pan );

			if ( _this.staticMoving ) {

				_panStart = _panEnd;

			} else {

				_panStart.add( mouseChange.subVectors( _panEnd, _panStart ).multiplyScalar( _this.dynamicDampingFactor ) );

			}

		}

	};

	this.checkDistances = function () {

		if ( !_this.noZoom || !_this.noPan ) {

			if ( _eye.lengthSq() > _this.maxDistance * _this.maxDistance ) {

				_this.onCameraMove();

				_this.object.position.addVectors( _this.target, _eye.setLength( _this.maxDistance ) );

			}

			if ( _eye.lengthSq() < _this.minDistance * _this.minDistance ) {

				_this.onCameraMove();

				_this.object.position.addVectors( _this.target, _eye.setLength( _this.minDistance ) );

			}

		}

	};

	this.update = function () {

		_eye.subVectors( _this.object.position, _this.target );

		if ( !_this.noRotate ) {

			_this.rotateCamera();

		}

		if ( !_this.noZoom ) {

			_this.zoomCamera();

		}

		if ( !_this.noPan ) {

			_this.panCamera();

		}

		_this.object.position.addVectors( _this.target, _eye );

		_this.checkDistances();

		_this.object.lookAt( _this.target );

		if ( lastPosition.distanceToSquared( _this.object.position ) > 0 ) {

			_this.dispatchEvent( changeEvent );

			lastPosition.copy( _this.object.position );

		}

	};

	this.reset = function () {

		_state = STATE.NONE;
		_prevState = STATE.NONE;

		_this.target.copy( _this.target0 );
		_this.object.position.copy( _this.position0 );
		_this.object.up.copy( _this.up0 );

		_eye.subVectors( _this.object.position, _this.target );

		_this.object.lookAt( _this.target );

		_this.dispatchEvent( changeEvent );

		lastPosition.copy( _this.object.position );

	};

	this.resetFromPose = function( position, orientation, distance ) {

		var dist  = distance || 0.99999; //1 === true :(
		var front = new THREE.Vector3(0,0,-1);
		var up    = new THREE.Vector3(0,1,0);

		_this.position0 = position.clone();
		_this.target0   = position.clone().add(front.applyQuaternion(orientation).multiplyScalar(dist));
		_this.up0       = up.applyQuaternion(orientation);
		_this.reset();

	};

	this.simulateMouseWheel = function(delta) {
		_zoomStart.y += ( 1 / delta ) * 0.05;
	};


	// listeners

	function keydown( event ) {

		if ( _this.enabled === false ) {

			return;

		}

		window.removeEventListener( 'keydown', keydown );

		_prevState = _state;

		if ( _state !== STATE.NONE ) {

			return;

		} else if ( event.keyCode === _this.keys[ STATE.ROTATE ] && !_this.noRotate ) {

			_state = STATE.ROTATE;

		} else if ( event.keyCode === _this.keys[ STATE.ZOOM ] && !_this.noZoom ) {

			_state = STATE.ZOOM;

		} else if ( event.keyCode === _this.keys[ STATE.PAN ] && !_this.noPan ) {

			_state = STATE.PAN;

		}

	}

	function keyup( ) {

		if ( _this.enabled === false ) {

			return;

		}

		_state = _prevState;

		window.addEventListener( 'keydown', keydown, false );

	}

	function mousedown( event ) {

		if ( _this.enabled === false ) {

			return;

		}

		event.preventDefault();
		event.stopPropagation();

		if ( _state === STATE.NONE ) {

			_state = event.button;

		}

		if ( _state === STATE.ROTATE && !_this.noRotate ) {

			_rotateStart = _this.getMouseProjectionOnBall( event.clientX, event.clientY );
			_rotateEnd.copy(_rotateStart);

		} else if ( _state === STATE.ZOOM && !_this.noZoom ) {

			_zoomStart = _this.getMouseOnScreen( event.clientX, event.clientY );
			_zoomEnd.copy(_zoomStart);

		} else if ( _state === STATE.PAN && !_this.noPan ) {

			_panStart = _this.getMouseOnScreen( event.clientX, event.clientY );
			_panEnd.copy(_panStart);

		}

		document.addEventListener( 'mousemove', mousemove, false );
		document.addEventListener( 'mouseup', mouseup, false );

	}

	function mousemove( event ) {

		if ( _this.enabled === false ) {

			return;

		}

		event.preventDefault();
		event.stopPropagation();

		if ( _state === STATE.ROTATE && !_this.noRotate ) {

			_rotateEnd = _this.getMouseProjectionOnBall( event.clientX, event.clientY );

		} else if ( _state === STATE.ZOOM && !_this.noZoom ) {

			_zoomEnd = _this.getMouseOnScreen( event.clientX, event.clientY );

		} else if ( _state === STATE.PAN && !_this.noPan ) {

			_panEnd = _this.getMouseOnScreen( event.clientX, event.clientY );

		}

	}

	function mouseup( event ) {

		if ( _this.enabled === false ) {

			return;

		}

		event.preventDefault();
		event.stopPropagation();

		_state = STATE.NONE;

		document.removeEventListener( 'mousemove', mousemove );
		document.removeEventListener( 'mouseup', mouseup );

	}

	function mousewheel( event ) {

		if ( _this.enabled === false ) {

			return;

		}

		event.preventDefault();
		event.stopPropagation();

		var delta = 0;

		if ( event.wheelDelta ) { // WebKit / Opera / Explorer 9

			delta = event.wheelDelta / 40;

		} else if ( event.detail ) { // Firefox

			delta = - event.detail / 3;

		}

		_zoomStart.y += delta * 0.01;

	}

	function touchstart( event ) {

		if ( _this.enabled === false ) {

			return;

		}

		switch ( event.touches.length ) {

			case 1:
				_state = STATE.TOUCH_ROTATE;
				_rotateStart = _rotateEnd = _this.getMouseProjectionOnBall( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
				break;

			case 2:
				_state = STATE.TOUCH_ZOOM;
				var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
				var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
				_touchZoomDistanceEnd = _touchZoomDistanceStart = Math.sqrt( dx * dx + dy * dy );
				break;

			case 3:
				_state = STATE.TOUCH_PAN;
				_panStart = _panEnd = _this.getMouseOnScreen( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
				break;

			default:
				_state = STATE.NONE;

		}

	}

	function touchmove( event ) {

		if ( _this.enabled === false ) {

			return;

		}

		event.preventDefault();
		event.stopPropagation();

		switch ( event.touches.length ) {

			case 1:
				_rotateEnd = _this.getMouseProjectionOnBall( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
				break;

			case 2:
				var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
				var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
				_touchZoomDistanceEnd = Math.sqrt( dx * dx + dy * dy );
				break;

			case 3:
				_panEnd = _this.getMouseOnScreen( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
				break;

			default:
				_state = STATE.NONE;

		}

	}

	function touchend( event ) {

		if ( _this.enabled === false ) {

			return;

		}

		switch ( event.touches.length ) {

			case 1:
				_rotateStart = _rotateEnd = _this.getMouseProjectionOnBall( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
				break;

			case 2:
				_touchZoomDistanceStart = _touchZoomDistanceEnd = 0;
				break;

			case 3:
				_panStart = _panEnd = _this.getMouseOnScreen( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
				break;

		}

		_state = STATE.NONE;

	}

	function contextmenu(event) {
		event.preventDefault();
	}

	function enable() {
		_this.domElement.addEventListener( 'contextmenu', contextmenu, false );
		_this.domElement.addEventListener( 'mousedown', mousedown, false );

		_this.domElement.addEventListener( 'mousewheel', mousewheel, false );
		_this.domElement.addEventListener( 'DOMMouseScroll', mousewheel, false ); // firefox

		_this.domElement.addEventListener( 'touchstart', touchstart, false );
		_this.domElement.addEventListener( 'touchend', touchend, false );
		_this.domElement.addEventListener( 'touchmove', touchmove, false );

		window.addEventListener( 'keydown', keydown, false );
		window.addEventListener( 'keyup', keyup, false );

		_this.enabled = true;
	}

	function disable() {
		_this.domElement.removeEventListener( 'contextmenu', contextmenu );
		_this.domElement.removeEventListener( 'mousedown', mousedown);

		_this.domElement.removeEventListener( 'mousewheel', mousewheel);
		_this.domElement.removeEventListener( 'DOMMouseScroll', mousewheel); // firefox

		_this.domElement.removeEventListener( 'touchstart', touchstart);
		_this.domElement.removeEventListener( 'touchend', touchend);
		_this.domElement.removeEventListener( 'touchmove', touchmove);

		window.removeEventListener( 'keydown', keydown, false );
		window.removeEventListener( 'keyup', keyup, false );

		_this.enabled = false;
	}
	enable();

	this.handleResize();

};

THREE.TrackballControls.prototype = Object.create( THREE.EventDispatcher.prototype );

"use strict";function isInsideTriangle(a,b,c,d,e){var f=.5*(-b[c[1]]*a[c[2]]+b[c[0]]*(-a[c[1]]+a[c[2]])+a[c[0]]*(b[c[1]]-b[c[2]])+a[c[1]]*b[c[2]]),g=0>f?-1:1,h=(b[c[0]]*a[c[2]]-a[c[0]]*b[c[2]]+(b[c[2]]-b[c[0]])*d+(a[c[0]]-a[c[2]])*e)*g,i=(a[c[0]]*b[c[1]]-b[c[0]]*a[c[1]]+(b[c[0]]-b[c[1]])*d+(a[c[1]]-a[c[0]])*e)*g;return h>=0&&i>=0&&2*f*g>=h+i}var PS=PS||{};PS.Packet={},PS.isWebGLEnabled=function(){try{var a=document.createElement("canvas");return!!window.WebGLRenderingContext&&(a.getContext("experimental-webgl")||a.getContext("webgl"))}catch(b){return!1}},PS.extend=function(a,b,c){var d={deep:c&&c.deep===!1?!1:!0,merge:c&&c.merge===!1?!1:!0};for(var e in b)b.hasOwnProperty(e)&&("object"==typeof b[e]&&"object"==typeof a[e]&&d.deep&&d.merge?PS.extend(a[e],b[e]):a[e]="object"==typeof b[e]&&d.deep?PS.extend(Array.isArray(b[e])?[]:{},b[e]):b[e]);return a},PS.extractGuid=function(a){return a=a.replace("/packet/",""),a=a.replace("http://cdn.photosynth.net/ps2/",""),a=a.replace("https://cdn.photosynth.net/ps2/","")},PS.Packet.WebGLMU=new function(){this.textureMemoryAmount=0,this.buffersMemoryAmount=0,this.addTexture=function(a,b){b&&console.warn(a),this.textureMemoryAmount+=a},this.addBuffer=function(a,b){b&&console.warn(a),this.buffersMemoryAmount+=a},this.info=function(){console.log("Textures: "+Math.round(this.textureMemoryAmount/1048576)+"mo, Buffers: "+Math.round(this.buffersMemoryAmount/1048576)+"mo")}},PS.Packet.MultiTouchGestureHandler=function(a,b){function c(a){a.type="gestureStart",E.gestureStart(a)}function d(a){a.type="gestureChange",E.gestureChange(a)}function e(a){a.type="gestureEnd",E.gestureEnd(a),U.focus()}function f(a){a.type="discreteZoom",E.discreteZoom(a)}function g(a){E.keyDown(a)&&a.preventDefault()}function h(a){E.keyUp(a)&&a.preventDefault()}function i(a){for(var b=0,c=0,d=D,e=document.fullscreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement;null!==d&&d!==e&&!isNaN(d.offsetLeft)&&!isNaN(d.offsetTop);)d===document.body?(b+=d.offsetLeft-document.documentElement.scrollLeft,c+=d.offsetTop-document.documentElement.scrollTop):(b+=d.offsetLeft-d.scrollLeft,c+=d.offsetTop-d.scrollTop),d=d.offsetParent;var f=a.clientX-b,g=a.clientY-c;return{x:f,y:g}}function j(a){try{M||"touch"!==a.pointerType||(E.onLog({type:"Stats",time:0,label:"touch"}),M=!0),F.addPointer(a.pointerId),D.msSetPointerCapture(a.pointerId);var b=i(a);O++,O>1&&e({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,translationX:G,translationY:H,scale:I,pointersStillDown:!0}),c({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,pointerCount:O,originalEvent:a}),G=0,H=0,I=1}catch(d){}}function k(a){O--,0>O&&(O=0);var b=i(a),d=O>0;e({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,translationX:G,translationY:H,scale:I,pointersStillDown:d}),d&&(c({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,pointerCount:O}),G=0,H=0,I=1)}function l(a){if(O>0){G+=a.translationX,H+=a.translationY,I*=a.scale;var b=i(a);a.detail&a.MSGESTURE_FLAG_INERTIA?e({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,translationX:G,translationY:H,scale:I}):d({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,translationX:G,translationY:H,scale:I})}}function m(a){if(O>0){var b=i(a);e({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,translationX:G,translationY:H,scale:I})}}function n(a){var b=i(a);c({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,pointerCount:1,originalEvent:a}),P={x:b.x,y:b.y},a.preventDefault(),document.addEventListener("mousemove",o,!1),document.addEventListener("mouseup",p,!1)}function o(a){if(null!==P){var b=i(a);d({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,translationX:b.x-P.x,translationY:b.y-P.y,scale:1,originalEvent:a}),a.preventDefault()}}function p(a){if(null!==P){var b=i(a);e({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,translationX:b.x-P.x,translationY:b.y-P.y,scale:1,originalEvent:a}),P=null,a.preventDefault(),document.removeEventListener("mousemove",o,!1),document.removeEventListener("mouseup",p,!1)}}function q(a){var b,c=a.detail?-1*a.detail:a.wheelDelta/40;c>0?b=1:0>c&&(b=-1);var d=i(a);f({layerX:d.x,layerY:d.y,screenX:a.screenX,screenY:a.screenY,direction:b}),a.preventDefault()}function r(a){var b=i(a);f({layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,direction:1}),a.preventDefault()}function s(a){T=0===a.length?{primary:null,secondary:null}:1===a.length?{primary:a[0].identifier,secondary:null}:{primary:a[0].identifier,secondary:a[1].identifier}}function t(a){if(null===T)return null;for(var b={primary:null,secondary:null},c=0;c<a.length;c++){var d=a[c];if(d.identifier===T.primary?(b.primary=d,b.primary.layerXY=i(d)):d.identifier===T.secondary&&(b.secondary=d,b.secondary.layerXY=i(b.secondary)),null!==b.primary&&null!==b.secondary)return b}return b}function u(a,b){var c=a.primary,d=a.secondary,e=(c.layerXY.x+d.layerXY.x)/2,f=(c.layerXY.y+d.layerXY.y)/2,g=(c.screenX+d.screenX)/2,h=(c.screenY+d.screenY)/2,i=c.layerXY.x-d.layerXY.x,j=c.layerXY.y-d.layerXY.y,k=Math.sqrt(i*i+j*j),l={layerX:e,layerY:f,screenX:g,screenY:h,pointerCount:null===a.secondary?1:2};return b?(l.translationX=e-Q.x,l.translationY=f-Q.y,l.scale=k/R):(Q={x:e,y:f},R=k),l}function v(a){c(a),S=a,S.translationX=0,S.translationY=0,S.scale=1}function w(a){d(a),S=a}function x(a,b){a.pointersStillDown=b,e(a)}function y(a){if(a.preventDefault(),1===a.targetTouches.length){s(a.targetTouches);var b=t(a.targetTouches);v({layerX:b.primary.layerXY.x,layerY:b.primary.layerXY.y,screenX:b.primary.screenX,screenY:b.primary.screenY,pointerCount:null===b.secondary?1:2}),Q={x:b.primary.layerXY.x,y:b.primary.layerXY.y}}else if(2===a.targetTouches.length){var b=t(a.targetTouches);x(S,!0),s(a.targetTouches),b=t(a.targetTouches),v(u(b,!1))}}function z(a){a.preventDefault(),M||(E.onLog({type:"Stats",time:0,label:"touch"}),M=!0);var b=t(a.targetTouches);w(null===b.secondary?{layerX:b.primary.layerXY.x,layerY:b.primary.layerXY.y,screenX:b.primary.screenX,screenY:b.primary.screenY,translationX:b.primary.layerXY.x-Q.x,translationY:b.primary.layerXY.y-Q.y,scale:1}:u(b,!0))}function A(a){if(a.preventDefault(),0===a.targetTouches.length)s(a.targetTouches),x(S),Q=null,R=null;else if(1===a.targetTouches.length){x(S,!0),s(a.targetTouches);var b=t(a.targetTouches),c=b.primary;v({layerX:c.layerXY.x,layerY:c.layerXY.y,screenX:c.screenX,screenY:c.screenY,pointerCount:null===b.secondary?1:2}),Q={x:c.layerXY.x,y:c.layerXY.y}}else{var d=t(a.targetTouches);if(null===d.primary||null===d.secondary){x(S,!0),s(a.targetTouches);var b=t(a.targetTouches);v(u(b,!1))}}}function B(){D.appendChild(U),U.addEventListener("keydown",g,!1),U.addEventListener("keyup",h,!1),U.focus()}function C(){U.removeEventListener("keydown",g,!1),U.removeEventListener("keyup",h,!1),U.parentNode&&U.parentNode.removeChild(U)}var D=a,E={gestureStart:function(){},gestureChange:function(){},gestureEnd:function(){},discreteZoom:function(){},keyDown:function(){},keyUp:function(){},onLog:function(){}};PS.extend(E,b);var F,G,H,I,J,K,L=!1,M=!1,N=this,O=0,P=null,Q=null,R=null,S=null,T={primary:null,secondary:null};window.navigator.msPointerEnabled&&window.MSGesture?(J=function(){F=new MSGesture,F.target=D,D.addEventListener("MSPointerDown",j,!1),D.addEventListener("MSPointerUp",k,!1),D.addEventListener("MSGestureChange",l,!0),D.addEventListener("MSGestureEnd",m,!0),D.addEventListener("dblclick",r,!1),D.addEventListener("mousewheel",q,!1)},K=function(){D.removeEventListener("MSPointerDown",j,!1),D.removeEventListener("MSPointerUp",k,!1),D.removeEventListener("MSGestureChange",l,!0),D.removeEventListener("MSGestureEnd",m,!0),D.removeEventListener("dblclick",r,!1),D.removeEventListener("mousewheel",q,!1),F=null}):(J=function(){D.addEventListener("touchstart",y,!1),D.addEventListener("touchmove",z,!1),D.addEventListener("touchend",A,!1),D.addEventListener("mousedown",n,!1),D.addEventListener("mousewheel",q,!1),D.addEventListener("DOMMouseScroll",q,!1),D.addEventListener("dblclick",r,!1),window.parent&&window!==window.parent&&document.addEventListener("mouseout",p,!1)},K=function(){D.removeEventListener("touchstart",y,!1),D.removeEventListener("touchmove",z,!1),D.removeEventListener("touchend",A,!1),D.removeEventListener("mousedown",n,!1),document.removeEventListener("mousemove",o,!1),document.removeEventListener("mouseup",p,!1),D.removeEventListener("mousewheel",q,!1),D.removeEventListener("DOMMouseScroll",q,!1),D.removeEventListener("dblclick",r,!1),window.parent&&window!==window.parent&&document.removeEventListener("mouseout",p,!1)});var U=document.createElement("input");U.readOnly=!0,U.style.width="0px",U.style.height="0px",U.style.opacity=0,B(),this.enable=function(){J(),L=!0},this.disable=function(){K(),L=!1},this.destroy=function(){N.disable(),C()},this.isEnabled=function(){return L},this.userCurrentlyInteracting=function(){return O>0},this.focusKeyboardElement=function(){U.focus()},this.blurKeyboardElement=function(){U.blur()}},PS.Packet.InputType={Mouse:"mouse",Touch:"touch"},PS.Packet.SingleTouchInputHandler=function(a,b){function c(a){for(var b=0,c=0,d=o,e=document.fullscreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement;null!==d&&d!==e&&!isNaN(d.offsetLeft)&&!isNaN(d.offsetTop);)d===document.body?(b+=d.offsetLeft-document.documentElement.scrollLeft,c+=d.offsetTop-document.documentElement.scrollTop):(b+=d.offsetLeft-d.scrollLeft,c+=d.offsetTop-d.scrollTop),d=d.offsetParent;var f=a.clientX-b,g=a.clientY-c;return{x:f,y:g}}function d(a){document.removeEventListener("MSPointerMove",e,!1),document.removeEventListener("MSPointerUp",f,!1),s=a.pointerId;var b=c(a);p.onDown({type:"mouse"===a.pointerType?PS.Packet.InputType.Mouse:PS.Packet.InputType.Touch,layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,clientX:a.clientX,clientY:a.clientY,originalEvent:a})&&(a.preventDefault(),document.addEventListener("MSPointerMove",e,!1),document.addEventListener("MSPointerUp",f,!1))}function e(a){if(a.pointerId===s){var b=c(a);p.onMove({type:"mouse"===a.pointerType?PS.Packet.InputType.Mouse:PS.Packet.InputType.Touch,layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,clientX:a.clientX,clientY:a.clientY,originalEvent:a})&&a.preventDefault()}}function f(a){if(a.pointerId===s){var b=c(a);p.onUp({type:"mouse"===a.pointerType?PS.Packet.InputType.Mouse:PS.Packet.InputType.Touch,layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,clientX:a.clientX,clientY:a.clientY,originalEvent:a})&&a.preventDefault()}document.removeEventListener("MSPointerMove",e,!1),document.removeEventListener("MSPointerUp",f,!1),s=null}function g(a){t=!0;var b=c(a);p.onDown({type:PS.Packet.InputType.Mouse,layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,clientX:a.clientX,clientY:a.clientY,originalEvent:a})&&a.preventDefault(),document.addEventListener("mousemove",h,!1),document.addEventListener("mouseup",i,!1),p.interpretOutAsUp&&document.addEventListener("mouseout",i,!1)}function h(a){if(t){var b=c(a);p.onMove({type:PS.Packet.InputType.Mouse,layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,clientX:a.clientX,clientY:a.clientY,originalEvent:a})&&a.preventDefault()}}function i(a){if(t){var b=c(a);p.onUp({type:PS.Packet.InputType.Mouse,layerX:b.x,layerY:b.y,screenX:a.screenX,screenY:a.screenY,clientX:a.clientX,clientY:a.clientY,originalEvent:a})&&a.preventDefault()}t=!1,document.removeEventListener("mousemove",h,!1),document.removeEventListener("mouseup",i,!1)}function j(a,b){for(var c=0;c<a.changedTouches.length;++c)if(a.changedTouches[c].identifier===b)return a.changedTouches[c];return null}function k(){u=null,document.removeEventListener("touchmove",m,!1),document.removeEventListener("touchend",n,!1)}function l(a){if(1===a.changedTouches.length){var b=a.changedTouches[0];u=b.identifier;var d=c(b);p.onDown({type:PS.Packet.InputType.Touch,layerX:d.x,layerY:d.y,screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,clientY:b.clientY,originalEvent:a})&&a.preventDefault(),document.addEventListener("touchmove",m,!1),document.addEventListener("touchend",n,!1)}}function m(a){var b=j(a,u);if(b){var d=c(b);p.onMove({type:PS.Packet.InputType.Touch,layerX:d.x,layerY:d.y,screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,clientY:b.clientY,originalEvent:a})&&a.preventDefault()}else k()}function n(a){var b=j(a,u);if(b){var d=c(b);p.onUp({type:PS.Packet.InputType.Touch,layerX:d.x,layerY:d.y,screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,clientY:b.clientY,originalEvent:a})&&a.preventDefault()}k()}var o=a,p={interpretOutAsUp:!1,onDown:function(){},onMove:function(){},onUp:function(){}};PS.extend(p,b);var q,r,s=null,t=!1,u=null;window.navigator.msPointerEnabled?(q=function(){o.addEventListener("MSPointerDown",d,!1)},r=function(){o.removeEventListener("MSPointerDown",d,!1),document.removeEventListener("MSPointerMove",e,!1),document.removeEventListener("MSPointerUp",f,!1)}):(q=function(){o.addEventListener("mousedown",g,!1),o.addEventListener("touchstart",l,!1)},r=function(){o.removeEventListener("mousedown",g,!1),document.removeEventListener("mousemove",h,!1),document.removeEventListener("mouseup",i,!1),p.interpretOutAsUp&&document.removeEventListener("mouseout",i,!1),o.removeEventListener("touchstart",l,!1),document.removeEventListener("touchmove",m,!1),document.removeEventListener("touchend",n,!1)}),q(),this.stop=function(){r()}},PS.Utils={},PS.Utils.generateRangeArray=function(a){for(var b=new Array(a),c=0;a>c;++c)b[c]=c;return b},PS.Utils.ImageDownloader=function(a,b,c){this.img=new Image,c===!0&&(this.img.crossOrigin="anonymous"),this.img.onload=function(){b(null,this)},this.img.onerror=function(){b(this,null)},this.img.src=a},PS.Utils.addCSSFile=function(a){var b=document.createElement("link");b.setAttribute("rel","stylesheet"),b.setAttribute("type","text/css"),b.setAttribute("href",a),document.getElementsByTagName("head")[0].appendChild(b)},PS.Utils.addScriptFile=function(a){var b=document.createElement("script");b.setAttribute("type","text/javascript"),b.setAttribute("src",a),document.getElementsByTagName("head")[0].appendChild(b)},PS.Utils.getUrlParams=function(){var a={},b=(window.location.search.split("?")[1]||"").split("&");for(var c in b)if(b.hasOwnProperty(c)){var d=b[c].split("=");a[d[0]]=decodeURIComponent(d[1]||"")}return a},PS.Utils.tryParse=function(a){try{return JSON.parse(a)}catch(b){return void console.warn(b)}},PS.Utils.Async={},PS.Utils.Async.fireOnce=function(a,b,c){var d=!1;return function(){if(d&&c)throw new Error("Async.Queue callback was already fired");d||(d=!0,a.apply(b,arguments))}},PS.Utils.Async.parallel=function(a,b){for(var c=a.length,d=new Array(c),e=b,f=0,g=0;c>g;++g)a[g](function(){var a=g;return function(b,g){f++,b&&e(b,null),d[a]=g,f===c&&e(null,d)}}())},PS.Utils.Async.Queue=function(a,b){function c(){h++,i--,j.cancelled?e.onCancel.call(j):h===g?e.onComplete.call(j):k||d()}function d(){for(;i<e.concurrency&&f.length>0;)i++,setTimeout(function(){var a=f.shift();return function(){e.onProcess.call(j,a,PS.Utils.Async.fireOnce(c,j,!0))}}(),0)}var e={concurrency:1,onProcess:function(){},onComplete:function(){},onCancel:function(){}};PS.extend(e,b),e.onCancel=PS.Utils.Async.fireOnce(e.onCancel,j,!1);var f=a.slice(0),g=f.length,h=0,i=0,j=this,k=!1;this.cancelled=!1,this.pause=function(){k=!0},this.resume=function(){k=!1,0===f.length?e.onComplete.call(j):d()},this.cancel=function(){this.cancelled=!0},j.resume()},PS.Utils.Async.PriorityOrdering={Ascending:0,Descending:1},PS.Utils.Async.PriorityItem=function(a,b,c){this.key=a,this.value=b,this.priority=c},PS.Utils.Async.PriorityQueue=function(a,b){function c(){h++,i--,j.cancelled?e.onCancel.call(j):h===g?e.onComplete.call(j):k||d()}function d(){for(;i<e.concurrency&&f.length>0;)i++,setTimeout(function(){l&&(l=!1,f.sort(e.priorityOrdering===PS.Utils.Async.PriorityOrdering.Ascending?function(a,b){return a.priority-b.priority}:function(a,b){return b.priority-a.priority}));var a=f.shift();return function(){e.onProcess.call(j,a,PS.Utils.Async.fireOnce(c,j,!0))}}(),0)}var e={concurrency:1,priorityOrdering:PS.Utils.Async.PriorityOrdering.Ascending,onProcess:function(){},onComplete:function(){},onCancel:function(){}};PS.extend(e,b),e.onCancel=PS.Utils.Async.fireOnce(e.onCancel,j,!1);var f=a.slice(0),g=f.length,h=0,i=0,j=this,k=!1,l=!0;this.cancelled=!1,this.setPriority=function(a,b){for(var c=0;c<f.length;++c){var d=f[c];if(d.key===a)return d.priority=b,l=!0,!0}return!1},this.push=function(a,b,c){f.push(new PS.Utils.Async.PriorityItem(a,b,c)),l=!0,j.resume()},this.pause=function(){k=!0},this.resume=function(){k=!1,0===f.length?e.onComplete():d()},this.cancel=function(){this.cancelled=!0},this.size=function(){return f.length},this.destroy=function(){j.cancel(),f=[]},j.resume()},PS.Utils.Request=function(a,b){var c=b||{},d=c.onComplete||function(){},e=c.onProgress||function(){},f=c.onError||function(){},g=c.responseType||"",h=c.method||"GET",i=c.content||null,j=c.headers||[],k=c.onUploadProgress||function(){},l=new XMLHttpRequest;l.open(h,a,!0);for(var m=0;m<j.length;++m){var n=j[m];l.setRequestHeader(n.name,n.value)}g&&(l.responseType=g),l.onreadystatechange=function(){4===l.readyState&&(l.status>=400&&l.status<=500||0===l.status?f(l):d(l))},l.upload.onprogress=function(a){k(a)},l.onprogress=function(a){e(a)},l.send(i)},PS.Tween={create:function(a){function b(){var a=Date.now();if(a>e)return i=!0,j=!0,void c.onComplete(c.end,1);var h=(a-d)/c.duration;h=1===h?1:1-Math.pow(2,-10*h),c.onUpdate(g*h+c.start,h),f=window.requestAnimationFrame(b)}var c={duration:300,start:0,end:1,onStart:function(){},onUpdate:function(){},onComplete:function(){}};PS.extend(c,a);var d,e,f,g,h=!1,i=!1,j=!1;return this.start=function(){return h?void 0:(d=Date.now(),e=d+c.duration,g=c.end-c.start,f=window.requestAnimationFrame(b),h=!0,i=!1,j=!1,c.onStart(c.start,0),this)},this.stop=function(){return j=!0,h&&window.cancelAnimationFrame(f),this},this.running=function(){return h&&!j&&!i},this.done=function(){return i},this.stopped=function(){return j},this}},PS.Fx={},PS.Fx.Tween=function(a){function b(){var a=Date.now();if(a>e)return i=!0,j=!0,c.onUpdate(c.to,1),void c.onComplete(c.to,1);var h=(a-d)/c.duration,k=c.transition(h);c.onUpdate(g*k+c.from,k,h),f=window.requestAnimationFrame(b)}var c={duration:300,transition:PS.Fx.Transitions.Expo.easeOut,from:0,to:1,onStart:function(){},onUpdate:function(){},onComplete:function(){}};PS.extend(c,a);var d,e,f,g,h=!1,i=!1,j=!1;this.start=function(){return h?void 0:(d=Date.now(),e=d+c.duration,g=c.to-c.from,f=window.requestAnimationFrame(b),h=!0,i=!1,j=!1,c.onStart(c.from,0),c.onUpdate(c.from,0),this)},this.stop=function(){return j=!0,h&&window.cancelAnimationFrame(f),this},this.running=function(){return h&&!j&&!i},this.done=function(){return i},this.stopped=function(){return j}},PS.Fx.Transitions=function(){var a={Linear:function(a){return a},Pow:function(a,b){return Math.pow(a,b||6)},Expo:function(a){return Math.pow(2,8*(a-1))},Circ:function(a){return 1-Math.sin(Math.acos(a))},Sine:function(a){return 1-Math.cos(a*Math.PI/2)},Back:function(a,b){return b=b||1.618,Math.pow(a,2)*((b+1)*a-b)},Bounce:function(a){for(var b,c=0,d=1;1;c+=d,d/=2)if(a>=(7-4*c)/11){b=d*d-Math.pow((11-6*c-11*a)/4,2);break}return b},Elastic:function(a,b){return Math.pow(2,10*--a)*Math.cos(20*a*Math.PI*(b||1)/3)}};["Quad","Cubic","Quart","Quint"].forEach(function(b,c){a[b]=function(){var a=c+2;return function(b){return Math.pow(b,a)}}()});var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=function(){var b=a[c];return{easeIn:function(a){return b(a)},easeOut:function(a){return 1-b(1-a)},easeInOut:function(a){return(.5>=a?b(2*a):2-b(2*(1-a)))/2}}}());return b}(),PS.Progress=new function(){var a,b,c,d={color:"#19DB9F",initValue:0,position:"top",thickness:2},e=this,f=!1,g=!1;this.init=function(a){return g?e.reset(a):(PS.extend(d,a),c=document.createElement("div"),c.style.position="absolute",c.style.width="100%",c.style.backgroundColor="rgba(0, 0, 0, 0.3)",c.style.display="none",b=document.createElement("div"),c.appendChild(b),document.body.appendChild(c),e.reset(d),void(g=!0))},this.reset=function(a){PS.extend(d,a),c.style.display="none",c.style.height=d.thickness+"px",c.style.left=0,"bottom"===d.position?(c.style.bottom=0,c.style.top="auto"):(c.style.bottom="auto",c.style.top=0),b.style.backgroundColor=d.color,b.style.height=d.thickness+"px",e.set(d.initValue),f=!1},this.set=function(d){g&&(a=d,b.style.width=Math.round(100*d)+"%",f||(c.style.display="",f=!0))},this.done=function(){g&&(c.style.display="none",f=!1)}},window.ArrayBuffer&&!window.ArrayBuffer.prototype.slice&&(window.ArrayBuffer.prototype.slice=function(a,b){var c=new Uint8Array(this).subarray(a,b),d=new Uint8Array(b-a);return d.set(c),d.buffer});var Exif=function(){function a(a,b){function c(a,b){if(a+b>e.byteLength)throw"Out of range access\nTrying to access offset: "+(a+b)+", length: "+e.byteLength}var d=a,e=new DataView(a),f=0,g="undefined"==typeof b?!0:b;this.seek=function(a){c(0,a),f=a},this.tell=function(){return f},this.setEndianness=function(a){g=a},this.eof=function(){return f>=e.byteLength},this.getString=function(a,b){c(a,b);for(var d="",e=0;b>e;++e)d+=String.fromCharCode(this.getUint8(a+e));return d},this.getImage=function(a,b){c(a,b);var e=d.slice(a,a+b);return new Blob([new Uint8Array(e)],{type:"image/jpeg"})};for(var h=[{name:"Float32",nbBytes:4},{name:"Float64",nbBytes:8},{name:"Int8",nbBytes:1},{name:"Int16",nbBytes:2},{name:"Int32",nbBytes:4},{name:"Uint8",nbBytes:1},{name:"Uint16",nbBytes:2},{name:"Uint32",nbBytes:4}],i=0;i<h.length;++i){var j=h[i];j.name="get"+j.name,this[j.name]=function(){var a=j.name,b=j.nbBytes;return function(d){var h=d||!1;h||(d=f),c(d,b);var i=e[a](d,g);return h||(f+=b),i}}()}}function b(a,b){var c=b||{},d=c.onComplete||function(){},e=c.onProgress||function(){},f=c.onError||function(){},g=c.responseType||"",h=c.method||"GET",i=c.content||null,j=c.headers||[],k=c.onUploadProgress||function(){},l=new XMLHttpRequest;l.open(h,a,!0);for(var m=0;m<j.length;++m){var n=j[m];l.setRequestHeader(n.name,n.value)}g&&(l.responseType=g),l.onreadystatechange=function(){4===l.readyState&&(l.status>=400&&l.status<=500?f(l):d(l))},l.upload.onprogress=function(a){k(a)},l.onprogress=function(a){e(a)},l.send(i)}function c(a){function b(a,c,d){var e=["Exif","GPS","Thumbnail"],f={};for(var g in a)if(a.hasOwnProperty(g)){var h=a[g];"object"==typeof h&&-1===e.indexOf(g)?f[g]=c?[h.value,d[h.tag][1]]:h.value:"Exif"===g?f.Exif=b(h,c,m.Exif,{}):"GPS"===g?f.GPS=b(h,c,m.GPS,{}):"Thumbnail"===g&&(f.Thumbnail=b(h,c,m.Tiff,{}))}return f}function c(a){var b=new Date,c=a.split(" ");if(2===c.length){var d=c[0].split(":"),e=c[1].split(":");3===d.length&&3===e.length&&(b.setFullYear(parseInt(d[0],10)),b.setMonth(parseInt(d[1],10)-1),b.setDate(parseInt(d[2],10)),b.setHours(parseInt(e[0],10)),b.setMinutes(parseInt(e[1],10)),b.setSeconds(parseInt(e[2],10)))}return b}var d=this;this.tags=a,this.hasCapturedDate=function(){return d.tags.Datetime||d.tags.Exif&&d.tags.Exif.DateTimeOriginal},this.getCapturedDate=function(){if(d.hasCapturedDate()){if(d.tags.Exif&&d.tags.Exif.DateTimeOriginal){var a=d.tags.Exif.DateTimeOriginal.value;return c(a)}var a=d.tags.DateTime.value;return c(a)}return new Date},this.hasGPS=function(){return d.tags.GPS&&d.tags.GPS.GPSLatitude&&d.tags.GPS.GPSLongitude},this.hasThumbnail=function(){return d.tags.Thumbnail&&d.tags.Thumbnail.blob},this.getTag=function(a){return d.tags&&d.tags[a]?d.tags[a]:d.tags.GPS&&d.tags.GPS[a]?d.tags.GPS[a]:d.tags.Exif&&d.tags.Exif[a]?d.tags.Exif[a]:void 0},this.getGPSCoord=function(){if(d.hasGPS()){var a=d.tags.GPS,b=a.GPSLatitude.value,c=a.GPSLongitude.value,e=a.GPSLatitudeRef.value||"N",f=a.GPSLongitudeRef.value||"W";return{latitude:(b[0]+b[1]/60+b[2]/3600)*("N"===e?1:-1),longitude:(c[0]+c[1]/60+c[2]/3600)*("W"===f?-1:1)}}return{}},this.getThumbnailBlob=function(){return d.tags.Thumbnail.blob},this.toJSON=function(a){return b(d.tags,a,m.Tiff)}}function d(){this.versionMajor=null,this.versionMinor=null,this.units=null,this.xDensity=null,this.yDensity=null,this.thumbnailW=null,this.thumbnailH=null,this.thumbnailData=null,this.hasThumbnail=function(){return 0!==this.thumbnailW&&0!==this.thumbnailH},this.getVersion=function(){return this.versionMajor+"."+this.versionMinor},this.getThumbnail=function(){}}function e(a,b){this.headerOffset=a,this.ifdOffset=b}function f(a,b,c){return a.getString(b,c-1).replace("\x00","")}function g(b,g){function h(b){var e=new a(b,!1),g=e.getUint16();if(g===n.SOI){for(g=e.getUint16();!e.eof();){var h=e.getUint16()-2;if(g===n.APP0){var l=e.tell(),o=f(e,e.tell(),5);if(e.seek(e.tell()+5),"JFIF"===o){var p=new d;p.versionMajor=e.getUint8(),p.versionMinor=e.getUint8(),p.units=e.getUint8(),p.xDensity=e.getUint16(),p.yDensity=e.getUint16(),p.thumbnailW=e.getUint8(),p.thumbnailH=e.getUint8()}e.seek(l+h)}else if(g===n.APP1){var l=e.tell(),o=f(e,e.tell(),6);if(e.seek(e.tell()+6),"Exif"===o){var r=i(e),s=k(e,r.headerOffset,r.ifdOffset,m.Tiff,{});return s=j(e,r.headerOffset,s),void w(new c(s))}e.seek(l+h)}else if(g===n.APP2)e.seek(e.tell()+h);else{if(g===n.SOF0||g===n.SOF2)return void u(q.NO_EXIF_FOUND);e.seek(e.tell()+h)}g=e.getUint16()}u(q.NO_EXIF_FOUND)}else u(q.NOT_A_JPEG)}function i(a){var b=a.tell(),c=a.getUint16();if(c===o.LittleEndian)a.setEndianness(!0);else{if(c!==o.BigEndian)return void u(q.CORRUPTED_TIFF_HEADER_BYTE_ORDER);a.setEndianness(!1)}var d=a.getUint16();if(42!==d)return void u(q.CORRUPTED_TIFF_HEADER_42);var f=a.getUint32();return new e(b,f)}function j(a,b,c){if(c.ExifIFDPointer){var d=c.ExifIFDPointer.value;delete c.ExifIFDPointer,c.Exif={},k(a,b,d,m.Exif,c.Exif)}if(c.GPSInfoIFDPointer){var d=c.GPSInfoIFDPointer.value;delete c.GPSInfoIFDPointer;var e=c.GPS={};k(a,b,d,m.GPS,e)}return c.Thumbnail&&c.Thumbnail.JPEGInterchangeFormat&&c.Thumbnail.JPEGInterchangeFormatLength&&(c.Thumbnail.blob=a.getImage(b+c.Thumbnail.JPEGInterchangeFormat.value,c.Thumbnail.JPEGInterchangeFormatLength.value),delete c.Thumbnail.JPEGInterchangeFormat,delete c.Thumbnail.JPEGInterchangeFormatLength),c}function k(a,b,c,d,e){var f=a.getUint16(b+c),g={};x&&console.log("Number of fields: "+f);for(var h=0;f>h;h++){var i=c+2+12*h,j=a.getUint16(b+i);if(d[j]){var l=r(a,b,i);e[d[j][0]]={value:l,tag:j},x&&(g[d[j][0]]={value:l,tag:j})}else{var l=r(a,b,i);v(j,l)}}x&&console.log(g);var m=a.getUint32(b+c+2+12*f);return 0!==m&&(e.Thumbnail?k(a,b,m,d,e):e.Thumbnail=k(a,b,m,d,{})),e}function l(a){switch(a){case p.UNSIGNED_CHAR:return 1;case p.STRING:return 1;case p.UNSIGNED_SHORT:return 2;case p.UNSIGNED_INT:return 4;case p.UNSIGNED_RATIONAL:return 8;case p.CHAR:return 1;case p.UNDEFINED:return 1;case p.SHORT:return 2;case p.INT:return 4;case p.RATIONAL:return 8;case p.FLOAT:return 4;case p.DOUBLE:return 8;default:return 0}}function r(a,b,c){a.seek(b+c+2);var d,e=a.getUint16(),f=a.getUint32(),g=l(e),h=f*g;return d=4>=h?a.tell():b+a.getUint32(),s(a,e,d,f,g)}function s(a,b,c,d,e){if(b===p.STRING||b===p.UNDEFINED)return f(a,c,d);if(1!==d){for(var g=new Array(d),h=0;d>h;++h)g[h]=s(a,b,c+h*e,1,e);return g}switch(b){case p.UNSIGNED_CHAR:return a.getUint8(c);case p.UNSIGNED_SHORT:return a.getUint16(c);case p.UNSIGNED_INT:return a.getUint32(c);case p.UNSIGNED_RATIONAL:var i=a.getUint32(c),j=a.getUint32(c+4);return 0===j?0:i/j;case p.CHAR:return a.getInt8(c);case p.SHORT:return a.getInt16(c);case p.INT:return a.getInt32(c);case p.RATIONAL:var i=a.getInt32(c),j=a.getInt32(c+4);return 0===j?0:i/j;case p.FLOAT:return a.getFloat32(c);case p.DOUBLE:return a.getFloat64(c);default:return"Unknown type"}return 0}var t=g||{},u=t.onError||function(){},v=t.onUnknownTagFound||function(){},w=t.onParsed||function(){},x=t.verboseLog||!1;h(b)}function h(a,b){var c,d=b||{},e=d.onError||function(){};if("string"==typeof a)c=a;else{if("object"!=typeof a)return void e(q.UNKNOWN_INPUT_TYPE);var f=a.constructor.toString();if(!(-1!==f.indexOf("HTMLImageElement")||a instanceof Image))return-1!==f.indexOf("ArrayBuffer")?i(a,b):void e(q.UNKNOWN_INPUT_TYPE);if(c=a.src,!c)return void e(q.IMAGE_WITHOUT_VALID_SRC)}c&&j(c,{onComplete:function(a){i(a,b)},onError:function(){e(q.DOWNLOAD_FAILED)}})}function i(a,b){var c=b||{},d=c.onError||function(){};try{new g(a,b)}catch(e){d(e)}}function j(a,c){var d=c||{},e=d.onComplete||function(){},f=d.onError||function(){};new b(a,{responseType:"arraybuffer",headers:[{name:"Range",value:"bytes=0-131072"}],onComplete:function(a){e(a.response)},onError:function(a){f(a)}})}function k(b){var c=new a(b,!1),d=c.getUint16();return d===n.SOI}var l="4",m={};m.Tiff={256:["ImageWidth","Image width"],257:["ImageHeight","Image height"],258:["BitsPerSample","Number of bits per component"],259:["Compression","Compression scheme"],262:["PhotometricInterpretation","Pixel composition"],274:["Orientation","Orientation of image"],277:["SamplesPerPixel","Number of components"],284:["PlanarConfiguration","Image data arrangement"],530:["YCbCrSubSampling","Subsampling ratio of Y to C"],531:["YCbCrPositioning","Y and C positioning"],282:["XResolution","Image resolution in width direction"],283:["YResolution","Image resolution in height direction"],296:["ResolutionUnit","Unit of X and Y resolution"],273:["StripOffsets","Image data location"],278:["RowsPerStrip","Number of rows per strip"],279:["StripByteCounts","Bytes per compression strip"],513:["JPEGInterchangeFormat","Offset to JPEG SOI"],514:["JPEGInterchangeFormatLength","Bytes of JPEG data"],301:["TransferFunction","Transfer function"],318:["WhitePoint","White point chromaticity"],319:["PrimaryChromaticities","Chromaticities of primaries"],529:["YCbCrCoefficients","Color space transformation matrix coefficients"],532:["ReferenceBlackWhite","Pair of black and white reference values"],306:["DateTime","File change date and time"],270:["ImageDescription","Image title"],271:["Make","Image input equipment manufacturer"],272:["Model","Image input equipment model"],305:["Software","Software used"],315:["Artist","Person who created the image"],33432:["Copyright","Copyright holder"],34665:["ExifIFDPointer","Exif tag"],34853:["GPSInfoIFDPointer","GPS tag"],40965:["InteroperabilityIFDPointer","Interoperability tag"]},m.Exif={36864:["ExifVersion","Exif version"],40960:["FlashpixVersion","Supported Flashpix version"],40961:["ColorSpace","Color space information"],37121:["ComponentsConfiguration","Meaning of each component"],37122:["CompressedBitsPerPixel","Image compression mode"],40962:["PixelXDimension","Valid image width"],40963:["PixelYDimension","Valid image height"],37500:["MakerNote","Manufacturer notes"],37510:["UserComment","User comments"],40964:["RelatedSoundFile","Related audio file"],36867:["DateTimeOriginal","Date and time of original data generation"],36868:["DateTimeDigitized","Date and time of digital data generation"],37520:["SubsecTime","DateTime subseconds"],37521:["SubsecTimeOriginal","DateTimeOriginal subseconds"],37522:["SubsecTimeDigitized","DateTimeDigitized subseconds"],33434:["ExposureTime","Exposure time"],33437:["FNumber","F number"],34850:["ExposureProgram","Exposure program"],34852:["SpectralSensitivity","Spectral sensitivity"],34855:["ISOSpeedRatings","ISO speed rating"],34856:["OECF","Optoelectric conversion factor"],37377:["ShutterSpeedValue","Shutter speed"],37378:["ApertureValue","Aperture"],37379:["BrightnessValue","Brightness"],37380:["ExposureBiasValue","Exposure bias"],37381:["MaxApertureValue","Maximum lens aperture"],37382:["SubjectDistance","Subject distance"],37383:["MeteringMode","Metering mode"],37384:["LightSource","Light source"],37385:["Flash","Flash"],37386:["FocalLength","Lens focal length"],37396:["SubjectArea","Subject area"],41483:["FlashEnergy","Flash energy"],41484:["SpatialFrequencyResponse","Spatial frequency response"],41486:["FocalPlaneXResolution","Focal plane X resolution"],41487:["FocalPlaneYResolution","Focal plane Y resolution"],41488:["FocalPlaneResolutionUnit","Focal plane resolution unit"],41492:["SubjectLocation","Subject location"],41493:["ExposureIndex","Exposure index"],41495:["SensingMethod","Sensing method"],41728:["FileSource","File source"],41729:["SceneType","Scene type"],41730:["CFAPattern","CFA pattern"],41985:["CustomRendered","Custom image processing"],41986:["ExposureMode","Exposure mode"],41987:["WhiteBalance","White balance"],41988:["DigitalZoomRation","Digital zoom ratio"],41989:["FocalLengthIn35mmFilm","Focal length in 35 mm film"],41990:["SceneCaptureType","Scene capture type"],41991:["GainControl","Gain control"],41992:["Contrast","Contrast"],41993:["Saturation","Saturation"],41994:["Sharpness","Sharpness"],41995:["DeviceSettingDescription","Device settings description"],41996:["SubjectDistanceRange","Subject distance range"],42016:["ImageUniqueID","Unique image ID"]},m.GPS={0:["GPSVersionID","GPS tag version"],1:["GPSLatitudeRef","North or South Latitude"],2:["GPSLatitude","Latitude"],3:["GPSLongitudeRef","East or West Longitude"],4:["GPSLongitude","Longitude"],5:["GPSAltitudeRef","Altitude reference"],6:["GPSAltitude","Altitude"],7:["GPSTimeStamp","GPS time (atomic clock)"],8:["GPSSatellites","GPS satellites used for measurement"],9:["GPSStatus","GPS receiver status"],10:["GPSMeasureMode","GPS measurement mode"],11:["GPSDOP","Measurement precision"],12:["GPSSpeedRef","Speed unit"],13:["GPSSpeed","Speed of GPS receiver"],14:["GPSTrackRef","Reference for direction of movement"],15:["GPSTrack","Direction of movement"],16:["GPSImgDirectionRef","Reference for direction of image"],17:["GPSImgDirection","Direction of image"],18:["GPSMapDatum","Geodetic survey data used"],19:["GPSDestLatitudeRef","Reference for latitude of destination"],20:["GPSDestLatitude","Latitude of destination"],21:["GPSDestLongitudeRef","Reference for longitude of destination"],22:["GPSDestLongitude","Longitude of destination"],23:["GPSDestBearingRef","Reference for bearing of destination"],24:["GPSDestBearing","Bearing of destination"],25:["GPSDestDistanceRef","Reference for distance to destination"],26:["GPSDestDistance","Distance to destination"],27:["GPSProcessingMethod","Name of GPS processing method"],28:["GPSAreaInformation","Name of GPS area"],29:["GPSDateStamp","GPS date"],30:["GPSDifferential","GPS differential correction"]};
var n={SOI:65496,APP0:65504,APP1:65505,APP2:65506,DQT:65499,DHT:65476,DRI:65501,SOF:65472,SOF0:65472,SOF2:65474,SOS:65498,EOI:65497},o={LittleEndian:18761,BigEndian:19789},p={UNSIGNED_CHAR:1,STRING:2,UNSIGNED_SHORT:3,UNSIGNED_INT:4,UNSIGNED_RATIONAL:5,CHAR:6,UNDEFINED:7,SHORT:8,INT:9,RATIONAL:10,FLOAT:11,DOUBLE:12},q={IMAGE_WITHOUT_VALID_SRC:"Exif.parse: Image element with empty src",DOWNLOAD_FAILED:"Exif.parse: download failed",NOT_A_JPEG:"Exif.parser: Not a jpeg file",NO_EXIF_FOUND:"Exif.parser: No Exif tags found",CORRUPTED_TIFF_HEADER_BYTE_ORDER:"Exif.parser: corrupted TIFF header [byte order]",CORRUPTED_TIFF_HEADER_42:"Exif.parser: corrupted TIFF header [42]",UNKNOWN:"Exif.parser: unknown error"};return{revision:l,parse:h,BinaryReader:a,Request:b,Errors:q,isJpeg:k}}();PS.Packet.ViewMode={Smooth:0,Linear:1,Global:2},PS.Packet.ResizeMode={Fast:0,Slow:1},PS.Packet.PresetGPU={TabletPhone:0,Laptop:1,Desktop:2,Extreme:3,Custom:4},PS.Packet.Player=function(a,b){function c(){if(y)if(!x&&n.debugMenuEnabled){x=new dat.GUI({width:330}),x.domElement.parentNode.style.zIndex=8;var a=x.addFolder("General");a.add(D,"reset").name("Reset settings");var b=a.add(D,"consoleLogging");b.onChange(function(a){PS.Packet.ViewerOptions.override({loggingEnabled:a})});var c=a.add(D,"geometry");c.onChange(function(a){m.packetViewer.setOptions({geometryEnabled:a}),PS.Packet.ViewerOptions.override({viewer:{geometryEnabled:a}})});var e=n.seadragonEnabled,f=a.add(D,"seadragon").listen();f.onChange(function(a){e&&(m.seadragonViewer.setForceVisible(a),m.packetViewer.cameraController.setSeadragonEnabled(a)),PS.Packet.ViewerOptions.override({seadragonEnabled:a})});var g=a.add(D,"pathFixing");g.onChange(function(a){PS.Packet.ViewerOptions.override({viewer:{pathFixingEnabled:a}})});var h=a.add(D,"mapVisibleAtStartup");h.onChange(function(a){PS.Packet.ViewerOptions.override({map:{isVisible:a}})});var i=a.add(D,"pointCloud");if(i.onChange(function(a){PS.Packet.ViewerOptions.override({viewer:{pointCloudEnabled:a}})}),n.viewer.pointCloudEnabled){var j=a.add(D,"pointCloudSize",.01,.3);j.onChange(function(a){m.packetViewer.setPointSize(a)})}var k=a.add(D,"cameraMode",{Smooth:PS.Packet.CameraMode.Smooth,Linear:PS.Packet.CameraMode.Linear,Global:PS.Packet.CameraMode.Global});k.onFinishChange(function(a){a=parseInt(a,10),a===PS.Packet.CameraMode.Global?(D.holeFilling=!1,m.packetViewer.renderer.setHoleFillingEnabled(!1)):(D.holeFilling=!0,m.packetViewer.renderer.setHoleFillingEnabled(!0)),m.setCameraMode(a)}),a.open();var l=x.addFolder("Rendering"),o=l.add(D,"cropping");o.onChange(function(a){m.packetViewer.renderer.setCroppingEnabled(a),PS.Packet.ViewerOptions.override({viewer:{renderer:{croppingEnabled:a}}})});var p=l.add(D,"holeFilling");p.onChange(function(a){m.packetViewer.renderer.setHoleFillingEnabled(a),PS.Packet.ViewerOptions.override({viewer:{renderer:{holeFillingEnabled:a}}})});var q=l.add(D,"colorBalance");q.onChange(function(a){m.packetViewer.setOptions({colorBalanceEnabled:a}),PS.Packet.ViewerOptions.override({viewer:{colorBalanceEnabled:a}})});var r=l.add(D,"lazyRendering");r.onChange(function(a){m.packetViewer.renderer.setOptions({lazyRenderingEnabled:a}),PS.Packet.ViewerOptions.override({viewer:{renderer:{lazyRenderingEnabled:a}}})});var s=l.add(D,"polygonColor");if(s.onChange(function(a){PS.Packet.ViewerOptions.override({viewer:{debugBlendingEnabled:a}})}),n.viewer.debugBlendingEnabled){var t=l.add(D,"polygonBlending",0,1);t.onChange(function(a){m.packetViewer.setDebugBlending(a)})}var u=l.add(D,"blendingMode",{Opacity:PS.Packet.BlendingMode.Opacity,"Dithering Luminance":PS.Packet.BlendingMode.DitheringLuminance,"Dithering Color":PS.Packet.BlendingMode.DitheringColor,Feathering:PS.Packet.BlendingMode.Feathering});u.onChange(function(a){a=parseInt(a,10),PS.Packet.ViewerOptions.override({viewer:{renderer:{blendingMode:a}}})});var v=l.add(D,"blendingFunction",{Linear:PS.Packet.BlendingFunction.Linear,Step:PS.Packet.BlendingFunction.Step,Sigmoid:PS.Packet.BlendingFunction.Sigmoid});if(v.onChange(function(a){a=parseInt(a,10),m.packetViewer.renderer.setOptions({blendingFunction:a}),PS.Packet.ViewerOptions.override({viewer:{renderer:{blendingFunction:a}}})}),n.viewer.renderer.blendingFunction===PS.Packet.BlendingFunction.Sigmoid){var w=l.add(D,"blendingSigma",0,1);w.onChange(function(a){m.packetViewer.renderer.setOptions({blendingSigma:a}),PS.Packet.ViewerOptions.override({viewer:{renderer:{blendingSigma:a}}})})}l.open();var z=x.addFolder("Path"),A=z.add(D,"endpoint");A.onChange(function(a){m.packetViewer.dataset.path.setOptions({extendPathEnabled:a}),PS.Packet.ViewerOptions.override({viewer:{extendPathEnabled:a}})});var B=z.add(D,"smoothFov");B.onChange(function(a){PS.Packet.ViewerOptions.override({viewer:{smoothFovEnabled:a}})});var C=z.add(D,"smoothSpeed");C.onChange(function(a){PS.Packet.ViewerOptions.override({viewer:{smoothSpeedEnabled:a}})});var E=z.add(D,"virtualOnRest");E.onChange(function(a){m.packetViewer.setOptions({virtualPathEnabled:a}),PS.Packet.ViewerOptions.override({viewer:{virtualPathEnabled:a}})});var g=z.add(D,"pathFixing");g.onChange(function(a){PS.Packet.ViewerOptions.override({viewer:{pathFixingEnabled:a}})});var F=x.addFolder("UI"),G=F.add(D,"toggleGlobalView");G.onChange(function(a){PS.Packet.ViewerOptions.override({metadata:{enableGlobalView:a}})});var H=F.add(D,"toggle3D");H.onChange(function(a){PS.Packet.ViewerOptions.override({metadata:{enable3DToggle:a}})});var I=F.add(D,"progressBar");I.onChange(function(a){PS.Packet.ViewerOptions.override({viewer:{progressBarEnabled:a}})});var J=F.add(D,"position",{right:"right",center:"center"});J.onChange(function(a){PS.Packet.ViewerOptions.override({metadata:{position:a}})});var K=x.addFolder("GPU");K.add(D,"texturesMemoryUsage",0,200).listen(),K.add(D,"buffersMemoryUsage",0,200).listen(),K.add(D,"totalMemoryUsage",0,200).listen();var L=K.add(D,"presetGPU",{"Tablet/Phone":PS.Packet.PresetGPU.TabletPhone,Laptop:PS.Packet.PresetGPU.Laptop,Desktop:PS.Packet.PresetGPU.Desktop,Extreme:PS.Packet.PresetGPU.Extreme});L.onFinishChange(function(a){var b=d(parseInt(a,10));PS.Packet.ViewerOptions.override({viewer:b})})}else n.debugMenuEnabled&&(x.closed=!x.closed)}function d(a){var b={};switch(a){case PS.Packet.PresetGPU.TabletPhone:b.maxRenderSize=48e4,b.maxHDPixels=196608,b.gpuHDMemoryBudget=50;break;case PS.Packet.PresetGPU.Desktop:b.maxRenderSize=2073600,b.maxHDPixels=48e4,b.gpuHDMemoryBudget=150;break;case PS.Packet.PresetGPU.Extreme:b.maxRenderSize=2073600,b.maxHDPixels=2073600,b.gpuHDMemoryBudget=200;break;case PS.Packet.PresetGPU.Custom:break;default:b.maxRenderSize=786432,b.maxHDPixels=414720,b.gpuHDMemoryBudget=80}return b.presetGPU=a,b}function e(){return""===n.packetURL?"/ps2/"+n.guid+"/packet/":n.packetURL}function f(){return document.fullscreenEnabled||document.msFullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled}function g(){document.fullscreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.mozCancelFullScreen&&document.mozCancelFullScreen():p.requestFullscreen?p.requestFullscreen():p.msRequestFullscreen?p.msRequestFullscreen():p.webkitRequestFullscreen?p.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):p.mozRequestFullScreen&&p.mozRequestFullScreen()}function h(){var a=document.fullscreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement;a?(m.metadataViewer.setFullscreenButtonState("exitFullscreen"),n.onToggleFullscreen(!0)):(m.metadataViewer.setFullscreenButtonState("fullscreen"),n.onToggleFullscreen(!1));var b=a?screen.width:n.width,c=a?screen.height:n.height;m.resize(b,c,PS.Packet.ResizeMode.Slow)}function i(a){m.resize(a.target.innerWidth,a.target.innerHeight,PS.Packet.ResizeMode.Fast),u&&clearTimeout(u),u=setTimeout(function(){var b=a.target.innerWidth,c=a.target.innerHeight;return function(){m.resize(b,c,PS.Packet.ResizeMode.Slow)}}(),300)}function j(a){var a=a||function(){};if(y)return void a();document.addEventListener("fullscreenchange",h,!1),document.addEventListener("MSFullscreenChange",h,!1),document.addEventListener("webkitfullscreenchange",h,!1),document.addEventListener("mozfullscreenchange",h,!1),q=document.createElement("div"),q.setAttribute("class","PSPacketViewer"),p.appendChild(q),n.seadragonEnabled&&(r=document.createElement("div"),r.setAttribute("class","PSSeadragonViewer"),r.style.width=n.width+"px",r.style.height=n.height+"px",p.appendChild(r)),n.mapEnabled&&(s=document.createElement("div"),s.setAttribute("class","PSPacketMapViewer"),s.style.width=n.width+"px",s.style.height=n.height+"px",p.appendChild(s)),t=document.createElement("div"),t.setAttribute("class","PSInputLayer PSMetadataViewer"),t.style.width=n.width+"px",t.style.height=n.height+"px",p.appendChild(t),n.metadata.onTogglePlay=function(){n.seadragonEnabled&&(m.seadragonViewer.isHomeZoom()||m.seadragonViewer.goHome()),m.packetViewer.togglePlay()},n.metadata.onToggle3D=function(a){m.packetViewer.setOptions({geometryEnabled:"3d"===a})},n.metadata.onButtonClick=function(){m.packetViewer.cameraController.focusKeyboardElement()},n.metadata.enableFullscreen=n.metadata.enableFullscreen&&f(),n.metadata.onToggleFullscreen=function(a){g(a)},n.metadata.onZoomIn=function(){m.packetViewer.renderer.simulateMouseWheel(.3)},n.metadata.onZoomOut=function(){m.packetViewer.renderer.simulateMouseWheel(-.3)},n.metadata.logoURL=n.logoURL,n.metadata.logoTarget=n.logoTarget,n.metadata.width=n.width,n.metadata.height=n.height,m.metadataViewer=new PS.Packet.Metadata.Viewer(t,m,n.metadata),m.metadataViewer.progressIndicator.setPercent(15),m.metadataViewer.setCameraMode(n.startCameraMode),n.autoResizeEnabled&&window.addEventListener("resize",i,!1);var b=PS.extend({},n.viewer);PS.extend(n.viewer,{startCameraMode:n.startCameraMode,onJsonParsed:function(a,c){m.metadataViewer.progressIndicator.setPercent(45),b.onJsonParsed(a,c)},onCanvasUpdated:function(c,d){if(m.metadataViewer.progressIndicator.setPercent(65),b.onCanvasUpdated(c,d),n.mapEnabled&&m.mapViewer.init(c,c.dataset),m.setBackgroundColor(c.dataset.getDominantColor()),n.seadragonEnabled&&0!==c.getCameras()[0].originalSize.x){var e=m.packetViewer.getSeadragonOptions();e.onPositionChanged=n.seadragonViewer.onPositionChanged,e.onResize=n.seadragonViewer.onResize,e.onZoomLevelStateChanged=function(a){m.metadataViewer.setSeadragonZoomState(a),n.seadragonViewer.onZoomLevelStateChanged(a)},e.corsEnabled=n.corsEnabled,m.seadragonViewer.init(e)}a()},onKeyUp:function(a){var d=!1;if(!n.debugMenuEnabled||100!==a.keyCode&&52!==a.keyCode)if(!n.debugMenuEnabled||98!==a.keyCode&&50!==a.keyCode){if(67===a.keyCode)d=!0,m.toggleCameraMode();else if(77===a.keyCode)d=!0,m.mapViewer.setVisible(!m.mapViewer.isVisible());else if(70===a.keyCode)d=!0,g(a);else if(32===a.keyCode){d=!0;var e=m.metadataViewer.getPlayButtonState(),f="play"===e?"pause":"play";m.metadataViewer.setPlayButtonState(f),n.metadata.onTogglePlay("play"===f?"stopped":"playing")}}else d=!0,C&&(C=!1,c());else d=!0,C=!0,w&&clearTimeout(w),w=setTimeout(function(){C=!1},1e3);return d|=b.onKeyUp(a)},onBeginDownloading:function(a,c){"image"===c.type&&(z[c.index]=!0,m.metadataViewer.progressIndicator.start()),b.onBeginDownloading(a,c)},onProgressPercentChange:function(a){if(1===a)m.metadataViewer.setProgressPercentVisibility(!1);else{var b=Math.round(100*a),c=10>b?"0"+b:b;m.metadataViewer.setProgressPercentVisibility(!0),m.metadataViewer.setProgressPercentText(c)}},onFinishDownloading:function(a,c){if("image"===c.type){delete z[c.index];var d=0;for(var e in z)z.hasOwnProperty(e)&&d++;0===d&&m.metadataViewer.progressIndicator.stop()}b.onFinishDownloading(a,c)},onAllGeometryDownloaded:function(){n.seadragonEnabled&&m.seadragonViewer.enable(),b.onAllGeometryDownloaded()},onGPUMemoryChanged:function(){var a=PS.Packet.WebGLMU.textureMemoryAmount/1048576,b=PS.Packet.WebGLMU.buffersMemoryAmount/1048576;D.texturesMemoryUsage=a,D.buffersMemoryUsage=b,D.totalMemoryUsage=a+b},onStartAnimating:function(){v=Date.now(),m.metadataViewer.setPlayButtonState("pause"),n.seadragonEnabled&&m.seadragonViewer.setVisible(!1),b.onStartAnimating()},onStopAnimating:function(a){if(v){var c=Date.now()-v;c>3e3&&n.viewer.onLog({type:"Stats",label:"fps",time:c,nbFrames:a})}m.metadataViewer.setPlayButtonState("play"),b.onStopAnimating()},startDownloadingTiles:function(a,b){if(n.seadragonEnabled&&0!==a.originalSize.x&&B!==a){var c=m.packetViewer.dataset.getSeadragonRootUrl(a.iIndex),d=m.packetViewer.getCropping(a,m.packetViewer.dataset.path.getPose(a.qIndex,PS.Packet.ViewMode.Smooth).fov);m.seadragonViewer.startLoading(c,a.originalSize,d,function(){b&&m.seadragonViewer.setVisible(!0)})&&(B=a)}},onCameraChanged:function(a){n.seadragonEnabled&&m.packetViewer.getCurrentCameraMode()!==PS.Packet.ViewMode.Global&&m.seadragonViewer.setVisible(!0),b.onCameraChanged(a)},onCameraModeChanged:function(a){D.cameraMode=a,l.style.backgroundColor=a===PS.Packet.ViewMode.Global?"white":o,b.onCameraModeChanged(a)},onPoseChanged:function(a){n.seadragonEnabled&&m.seadragonViewer.setVisible(!1),n.mapEnabled&&m.mapViewer.update(a),b.onPoseChanged(a)},onPositionChanged:function(a,c){n.seadragonEnabled&&m.seadragonViewer.setVisible(!1),n.mapEnabled&&m.mapViewer.update(c.pose),b.onPositionChanged(a)},onLog:function(a){if(n.loggingEnabled)switch(a.type){case"Error":case"Warning":case"Info":console.log(a.type+": "+a.message);break;case"Stats":console.log("fps"===a.label?"Stats: "+a.label+" -> "+a.time+"ms ["+Math.round(10*a.nbFrames*1e3/a.time)/10+"fps]":"Stats: "+a.label+" -> "+a.time+"ms");break;default:console.log(a)}n.onLog(a)}}),m.packetViewer=new PS.Packet.Viewer(q,e(),n.viewer),n.seadragonEnabled&&(m.seadragonViewer=new PS.Packet.Seadragon.Viewer(r,t),m.packetViewer.seadragonViewer=m.seadragonViewer),n.mapEnabled&&(m.mapViewer=new PS.Packet.Map.Viewer(s,n.map)),y=!0}function k(){return p=document.createElement("div"),p.setAttribute("class","PSPacketPlayer"),p.style.width=n.width+"px",p.style.height=n.height+"px",l.appendChild(p),PS.isWebGLEnabled()?void(n.autoLoad?j():new PS.Utils.Request(e()+"0.json",{onComplete:function(a){var b=JSON.parse(a.responseText),c=b.dominant_colors||[[0,0,0]],d=c[0],f=b.topology,g=b.cameras.sort(function(a,b){return a.path_index-b.path_index}),h=1024;"spin"!==f&&"panorama"!==f||b.isClosed||(h=g[g.length-1].path_index+1);var i=n.viewer.startTransitionPercent;if(-1===n.viewer.startTransitionPercent&&(i="spin"===f||"panorama"===f?.5:0),-1!==n.viewer.startCameraIndex&&n.viewer.startCameraIndex<g.length){var k=g[n.viewer.startCameraIndex];i=k.path_index/(h-1)}var l=i*(h-1);if(b.isClosed)for(var m=0;m<g.length;++m){var o=Math.abs(g[m].path_index-l)%h;o>Math.round(h/2)&&(o=h-o),g[m].dist=o}else for(var m=0;m<g.length;++m)g[m].dist=Math.abs(g[m].path_index-l);g.sort(function(a,b){return a.dist-b.dist});var q=g[0].index,r=10>q?"000"+q:100>q?"00"+q:1e3>q?"0"+q:q,s="",t="rgb("+d[0]+","+d[1]+","+d[2]+")",u=n.embedThumbURL?n.embedThumbURL:e()+"l1/img"+r+".jpg";s+='<div class="preview" style="width:'+n.width+"px; height: "+n.height+"px; background: "+t+" url('"+u+"') no-repeat center; background-size: contain;\">",s+=PS.Packet.Metadata.Viewer.prototype.generateLogoString(n.metadata.enableLogo,n.logoURL,n.logoTarget),s+='	<div style="width:'+n.width+"px; height: "+n.height+'px; background-color: rgba(0,0,0,0.5)">',s+='		<button class="load" alt="Click to view"></button>',s+="	</div>",s+="</div>",p.innerHTML=s;var v=p.getElementsByTagName("button")[0];v.addEventListener("click",function(){var a=p.getElementsByClassName("preview")[0];a.getElementsByTagName("svg")[0].style.display="none",j(function(){a.style.display="none"})},!1)}})):(y=!0,void(p.innerHTML='<p class="noWebGL">Sorry, <a href="http://get.webgl.org/">WebGL</a> is not supported &nbsp;<span style="font-size: 70px;">:(</span></p>'))}var l=a,m=this,n={width:1280,height:720,guid:"",packetURL:"",embedThumbURL:"",logoURL:"",logoTarget:"_blank",autoLoad:!0,seadragonEnabled:!0,autoResizeEnabled:!0,mapEnabled:!0,corsEnabled:!1,debugMenuEnabled:!0,startCameraMode:PS.Packet.ViewMode.Smooth,loggingEnabled:!1,onLog:function(){},onToggleFullscreen:function(){},viewer:{onJsonParsed:function(){},onCanvasCreated:function(){},onCanvasUpdated:function(){},onBeginDownloading:function(){},onFinishDownloading:function(){},onStartAnimating:function(){},onStopAnimating:function(){},onCameraModeChanged:function(){},onCameraChanged:function(){},onCamerasChanged:function(){},onPositionChanged:function(){},onAllGeometryDownloaded:function(){},onPoseChanged:function(){},onKeyDown:function(){},onKeyUp:function(){},startTransitionPercent:-1,startCameraIndex:-1,pointCloudEnabled:!1,geometryEnabled:!0,colorBalanceEnabled:!0,pathFixingEnabled:!0,debugBlendingEnabled:!1,progressBarEnabled:!1,extendPathEnabled:!0,smoothFovEnabled:!0,smoothSpeedEnabled:!1,virtualPathEnabled:!0,renderer:{croppingEnabled:!0,holeFillingEnabled:!0,lazyRenderingEnabled:!0,blendingFunction:PS.Packet.BlendingFunction.Linear,blendingMode:PS.Packet.BlendingMode.Opacity,blendingSigma:.5},presetGPU:PS.Packet.PresetGPU.Laptop},seadragonViewer:{onPositionChanged:function(){},onResize:function(){},onZoomLevelStateChanged:function(){}},metadata:{title:"",enableLogo:!0,enableGlobalView:!1,enable3DToggle:!1,enableFullscreen:!0,toolbarPosition:"center",progressPosition:"center"},map:{isVisible:!1}};if(PS.extend(n,b),PS.extend(n.viewer,{width:n.width,height:n.height}),PS.extend(n.metadata,{width:n.width,height:n.height}),PS.extend(n.viewer,{corsEnabled:n.corsEnabled}),PS.extend(n.viewer,d(n.viewer.presetGPU)),""===n.guid&&""===n.packetURL)return void console.log("You need to provide a guid or a packetURL as option");var o,p,q,r,s,t,u,v,w,x,y=!1,z={},A=null,B=null,C=!1,D={reset:function(){PS.Packet.ViewerOptions.reset()},consoleLogging:n.loggingEnabled,geometry:n.viewer.geometryEnabled,seadragon:n.seadragonEnabled,mapVisibleAtStartup:n.map.isVisible,pointCloud:n.viewer.pointCloudEnabled,pointCloudSize:.05,cameraMode:n.startCameraMode,cropping:n.viewer.renderer.croppingEnabled,holeFilling:n.viewer.renderer.holeFillingEnabled,colorBalance:n.viewer.colorBalanceEnabled,lazyRendering:n.viewer.renderer.lazyRenderingEnabled,polygonColor:n.viewer.debugBlendingEnabled,polygonBlending:1,blendingMode:n.viewer.renderer.blendingMode,blendingFunction:n.viewer.renderer.blendingFunction,blendingSigma:n.viewer.renderer.blendingSigma,endpoint:n.viewer.extendPathEnabled,smoothFov:n.viewer.smoothFovEnabled,smoothSpeed:n.viewer.smoothSpeedEnabled,virtualOnRest:n.viewer.virtualPathEnabled,pathFixing:n.viewer.pathFixingEnabled,toggleGlobalView:n.metadata.enableGlobalView,toggle3D:n.metadata.enable3DToggle,progressBar:n.viewer.progressBarEnabled,position:n.metadata.toolbarPosition,presetGPU:n.viewer.presetGPU,texturesMemoryUsage:0,buffersMemoryUsage:0,totalMemoryUsage:0};this.getDiv=function(){return p},this.setBackgroundColor=function(a){o=a.getStyle(),m.packetViewer.getCanvas().style.backgroundColor=o,p.style.backgroundColor=n.startCameraMode!==PS.Packet.ViewMode.Global?o:""},this.toggleFullscreen=function(a){g(a)},this.resize=function(a,b,c){var d=a+"px",e=b+"px";m.packetViewer.resize(a,b,c),m.metadataViewer.resize(a,b),m.mapViewer.resize(a,b,c),p.style.width=d,p.style.height=e,t.style.width=d,t.style.height=e,n.seadragonEnabled&&B&&m.seadragonViewer.openSeadragon&&(m.seadragonViewer.setCropping(m.packetViewer.getCropping(B)),m.seadragonViewer.openSeadragon.viewport.goHome(!0),null!==A&&clearTimeout(A),m.seadragonViewer.openSeadragon.viewport&&(A=setTimeout(function(){m.seadragonViewer.openSeadragon.viewport.zoomBy(1.001,new OpenSeadragon.Point(0,0),!0),m.seadragonViewer.openSeadragon.viewport.goHome(!0),A=null},200)))},this.setCameraMode=function(a){m.packetViewer.setCameraMode(a),n.seadragonEnabled&&m.seadragonViewer.setVisible(!1),p.style.backgroundColor=a===PS.Packet.ViewMode.Global?"":o,m.metadataViewer.setCameraMode(a)},this.toggleCameraMode=function(){var a=m.packetViewer.getCurrentCameraMode(),b=a===PS.Packet.ViewMode.Smooth?PS.Packet.ViewMode.Global:PS.Packet.ViewMode.Smooth;m.setCameraMode(b)},this.load=function(a,b){var c=m.packetViewer.dataset;c&&c.rootUrl===a||(n.mapEnabled&&m.mapViewer.setVisible(!1),m.packetViewer.load(a,b),n.packetURL=a)},this.preload=function(a,b){m.packetViewer.datasetLoader.preload(a,b)},this.setActiveDataset=function(a){n.mapEnabled&&m.mapViewer.setVisible(n.map.isVisible),B=null,n.packetURL=a.rootUrl,m.packetViewer.datasetLoader.setActive(a)},this.getAnnotationInfo=function(a,b){if(a.x>=0&&a.x<=1&&a.y>=0&&a.y<=1)for(var c=m.packetViewer.dataset,d=c.geometryRanges,e=0;e<d.length;++e){var f=c.computeRange(e);if(B.index>=f.start&&B.index<f.end){var g=e,h=B.index-f.start;b(a,g,h,B);break}}},this.destroy=function(){if(clearTimeout(u),clearTimeout(A),n.seadragonEnabled=!1,m.packetViewer&&(m.packetViewer.destroy(),m.packetViewer=null),m.seadragonViewer&&(m.seadragonViewer.destroy(),m.seadragonViewer=null),m.metadataViewer&&(m.metadataViewer.destroy(),m.metadataViewer=null),m.mapViewer&&(m.mapViewer=null),x){var a=x.domElement.parentNode;x.destroy(),x=null,a.parentNode.removeChild(a)}y&&(document.removeEventListener("fullscreenchange",h),document.removeEventListener("MSFullscreenChange",h),document.removeEventListener("webkitfullscreenchange",h),document.removeEventListener("mozfullscreenchange",h),window.removeEventListener("resize",i)),l.removeChild(p),l.style.backgroundColor=""},k()},PS.Packet.ViewerOptions={},PS.Packet.ViewerOptions.getLocalStorageName=function(){return"PSPacketViewerOptions_v1"},PS.Packet.ViewerOptions.getDefault=function(){var a={viewer:{maxRenderSize:786432,maxHDPixels:414720,gpuHDMemoryBudget:80}};return a},PS.Packet.ViewerOptions.getUser=function(){var a=PS.Packet.ViewerOptions.getDefault();if(window.localStorage){var b=JSON.parse(localStorage.getItem(PS.Packet.ViewerOptions.getLocalStorageName())||"{}");PS.extend(a,b)}return a},PS.Packet.ViewerOptions.override=function(a){var b=PS.Packet.ViewerOptions.getUser();PS.extend(b,a),window.localStorage&&localStorage.setItem(PS.Packet.ViewerOptions.getLocalStorageName(),JSON.stringify(b))},PS.Packet.ViewerOptions.reset=function(){window.localStorage&&localStorage.setItem(PS.Packet.ViewerOptions.getLocalStorageName(),"{}")},THREE.Vector3.prototype.rotate=function(a,b){var c=Math.sin(b),d=Math.cos(b);this.x-=a.x,this.y-=a.y;var e=this.x*d-this.y*c,f=this.x*c+this.y*d;this.x=a.x+e,this.y=a.y+f},PS.Packet.Map={},PS.Packet.Map.Viewer=function(a,b){function c(){k=document.createElement("canvas"),k.style.position="absolute",k.style.top="0px",k.style.right="0px",k.style.display="block",l=k.getContext("2d"),o=document.createElement("canvas"),o.style.position="absolute",o.style.top="0px",o.style.right="0px",o.style.display="block",p=o.getContext("2d"),r.appendChild(k),r.appendChild(o),r.style.zIndex=2;var a="top right";r.style.transformOrigin=a,r.style.msTransformOrigin=a,r.style.webkitTransformOrigin=a,r.style.mozTransformOrigin=a,q.setVisible(v)}function d(a){return a.rotate(w.origin,w.angle),a.x=a.x*w.scaling+w.offset.x,a.y=j-(a.y*w.scaling+w.offset.y),a}function e(a,b){var c=b.cameras,d=b.path;g=a.resizeState.containerWidth,h=a.resizeState.containerHeight,i=g/3,j=h/3;for(var e=new THREE.Vector2,f=0;f<d.points.length;++f){var k=d.points[f].position;e.x+=k.x,e.y+=k.y}e.x/=d.points.length,e.y/=d.points.length,w.origin.set(e.x,e.y);for(var l={a:0,b:0,c:0,d:0},f=0;f<d.points.length;++f){var k=d.points[f].position,m=k.x-e.x,n=k.y-e.y;l.a+=m*m,l.b+=m*n,l.c+=n*m,l.d+=n*n}var o=l.a+l.d,p=l.a*l.d-l.b*l.c,q=o/2+Math.sqrt(o*o/4-p),r=Math.abs(l.b)>1e-6?-Math.atan2(l.c,q-l.d)+Math.PI/2:0;w.angle=r;for(var s=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY,u=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY,f=0;f<c.length;++f){var k=c[f].pose.position.clone();k.rotate(e,r),s=Math.min(s,k.x),t=Math.max(t,k.x),u=Math.min(u,k.y),v=Math.max(v,k.y)}for(var f=0;f<d.points.length;++f){var k=d.points[f].position.clone();k.rotate(e,r),s=Math.min(s,k.x),t=Math.max(t,k.x),u=Math.min(u,k.y),v=Math.max(v,k.y)}var x=Math.abs(t-s),y=Math.abs(v-u),z=i/x,A=j/y;w.scaling=.8*Math.min(z,A);var B=Math.max(x*w.scaling/.8,90),C=(g-a.getCropping(a.dataset.medianCamera).w)/2;if(C>B){var D=y*w.scaling/.8,E=C/B,F=h/D,G=Math.min(E,F);w.scaling*=G,B*=G,D*=G,j=Math.round(D)}i=Math.round(B);var H=(B-x*w.scaling)/2;w.offset.set(H+-s*w.scaling,(j-y*w.scaling)/2-u*w.scaling)}function f(a,b){m=a,n=b,e(a,b),k.width=i,o.width=i,k.height=j,o.height=j,l.clearRect(0,0,i,j),p.clearRect(0,0,i,j),l.fillStyle=s.backgroundColor,l.fillRect(0,0,i,j),l.save(),l.strokeStyle=s.posesColor,l.beginPath();for(var c=0;c<b.cameras.length;++c){var f=b.cameras[c].pose.position.clone();d(f),l.moveTo(f.x,f.y),l.arc(f.x,f.y,1,0,2*Math.PI)}l.stroke(),l.restore(),l.save(),l.strokeStyle=s.pathColor,l.beginPath();var f=b.path.points[0].position.clone();d(f),l.moveTo(f.x,f.y);for(var c=1;c<b.path.points.length;++c){var f=b.path.points[c].position.clone();d(f),l.lineTo(f.x,f.y)}if(b.path.isClosed){var f=b.path.points[0].position.clone();d(f),l.lineTo(f.x,f.y)}l.stroke(),l.restore(),q.setVisible(v),q.update(a.getCurrentPose())}var g,h,i,j,k,l,m,n,o,p,q=this,r=a,s={isVisible:!1,halfAngle:30,backgroundColor:"rgba(0, 0 , 0, 0.5)",pathColor:"rgba(255, 255, 255, 0.3)",currentPoseColor:"red",posesColor:"green"};PS.extend(s,b);var t=s.halfAngle*Math.PI/180,u=20,v=s.isVisible,w={origin:new THREE.Vector2,offset:new THREE.Vector2,dominantAngle:0,scaling:0};this.init=function(a,b){v=s.isVisible,f(a,b)},this.resize=function(a,b,c){var d=Math.min(a/g,b/h);c===PS.Packet.ResizeMode.Slow&&(f(m,n),d=1);var e="scale("+d.toFixed(8)+")";r.style.transform=e,r.style.msTransform=e,r.style.webkitTransform=e,r.style.mozTransform=e,r.style.width=a+"px",r.style.height=b+"px"},this.update=function(a){p.clearRect(0,0,i,j),p.save(),p.strokeStyle=s.currentPoseColor,p.beginPath();var b=d(a.position.clone()),c=b.x,e=b.y;p.moveTo(c,e),p.arc(c,e,2,0,2*Math.PI);var f=new THREE.Vector3(0,0,-1);f.applyQuaternion(a.orientation);var g=Math.atan2(f.y,f.x)+w.angle,h=u,k=.6*u;p.moveTo(c,e),p.lineTo(c+Math.cos(g)*h,e-Math.sin(g)*h),p.moveTo(c+Math.cos(g-t)*k,e-Math.sin(g-t)*k),p.lineTo(c+Math.cos(g)*h,e-Math.sin(g)*h),p.lineTo(c+Math.cos(g+t)*k,e-Math.sin(g+t)*k),p.stroke(),p.restore()},this.isVisible=function(){return v},this.setVisible=function(a){r.style.display=a?"":"none",v=a},c()},PS.Packet.Metadata={},PS.Packet.Metadata.Viewer=function(a,b,c){function d(a,b){a&&(a.removeEventListener("click",b),g(a),a=null)}function e(a){a.cancelBubble=!0}function f(a){a.addEventListener("mousedown",e,!1),a.addEventListener("touchstart",e,!1),a.addEventListener("touchmove",e,!1),a.addEventListener("touchend",e,!1),a.addEventListener("MSPointerDown",e,!1),a.addEventListener("MSPointerUp",e,!1),a.addEventListener("MSGestureStart",e,!1),a.addEventListener("MSGestureChange",e,!1),a.addEventListener("MSGestureEnd",e,!1)}function g(a){a.removeEventListener("mousedown",e),a.removeEventListener("touchstart",e),a.removeEventListener("touchmove",e),a.removeEventListener("touchend",e),a.removeEventListener("MSPointerDown",e),a.removeEventListener("MSPointerUp",e),a.removeEventListener("MSGestureStart",e),a.removeEventListener("MSGestureChange",e),a.removeEventListener("MSGestureEnd",e)}function h(a){u.onLogoClick(a,u.logoURL,u.logoTarget),u.onButtonClick()}function i(){u.onAnnotate(),u.onButtonClick()}function j(){this.className="play"===this.className?"pause":"play",u.onTogglePlay("play"===this.className?"stopped":"playing"),u.onButtonClick()}function k(a){u.onToggleFullscreen(a),u.onButtonClick()}function l(){s.toggleCameraMode(),u.onButtonClick()}function m(a){u.onZoomOut(a),u.onButtonClick()}function n(a){u.onZoomIn(a),u.onButtonClick()}function o(){this.className="twod"===this.className?"threed":"twod",u.onToggle3D("twod"===this.className?"3d":"2d"),u.onButtonClick()}function p(a){G.style.display="none",s.seadragonViewer.goHome(),u.onZoomToHome(a),u.onButtonClick()}function q(){var a=r.generateLogoString(u.enableLogo,u.logoURL,u.logoTarget);a+='<div class="license ccattrib" style="top: '+(u.height-25)+"px; width: 16px; height: 16px;"+(u.enableLicense?"":"display: none;")+'" title="This work is licensed to the public under the Creative Commons Attribution license."></div>',""!==u.title&&(u.title+=" ",a+='<p class="title" style="width: '+8*u.title.length+'px">'+u.title+"</p>"),u.enableZoomToHome&&(a+='<div class="zoomToHome" style="display: none;"><button /></div>');var b="right"===u.toolbarPosition?"right: 10px;":"left: "+(u.width/2-I/2)+"px;";a+='<div class="toolbar" style="bottom: '+u.toolbarBottomOffset+"px; "+b+'">',u.enableAnnotate&&(a+='	<button class="annotate" title="Add a new highlight"></button>'),a+='	<button class="pause" title="Play/Pause" style="'+(u.enablePlayToggle?"":"display: none;")+'"></button>',u.enableFullscreen&&(a+='	<button class="fullscreen" title="Fullscreen"></button>'),u.enableGlobalView&&(a+='	<button class="cameraMode" title="Change camera mode"></button>',a+='	<button class="zoomOut" title="Zoom out" style="display: none;"></button>',a+='	<button class="zoomIn"  title="Zoom in"  style="display: none;"></button>'),u.enable3DToggle&&(a+='	<button class="twod" title="3D On/Off"></button>'),a+="</div>";var c=Math.round(.18*Math.min(u.width,u.height));a+='<div class="progress-container" style="font-size: '+c+"px; margin-top:"+-Math.round(c/2)+'px;"><div class="progress-value">00</div><div class="progress-percent" style="font-size: '+Math.round(.48*c)+"px; top:"+-Math.round(.348*c)+'px">%</div></div>',t.innerHTML+=a,C=t.getElementsByClassName("toolbar")[0],r.setToolbarVisibility(u.toolbarVisible),D=t.getElementsByClassName("progress-container")[0],E=t.getElementsByClassName("progress-value")[0],F=t.getElementsByClassName("progress-percent")[0],r.setProgressPercentVisibility(!1),r.resize(u.width,u.height);var d=C.getElementsByTagName("button");if(d=Array.prototype.slice.call(d),H=t.getElementsByTagName("svg")[0],r.progressIndicator=new PS.Packet.Metadata.ProgressIndicator(H),f(H),""!==u.logoURL){var e=H.getElementsByTagName("a")[0];e.addEventListener("click",h,!1)}var g=0;if(u.enableAnnotate&&(v=d[g++],v.addEventListener("click",i,!1),f(v)),w=d[g++],w.addEventListener("click",j,!1),f(w),u.enableFullscreen&&(x=d[g++],x.addEventListener("click",k,!1),f(x)),u.enableGlobalView&&(y=d[g++],y.addEventListener("click",l,!1),f(y),A=d[g++],A.addEventListener("click",m,!1),f(A),z=d[g++],z.addEventListener("click",n,!1),f(z)),u.enable3DToggle&&(B=d[g++],B.addEventListener("click",o,!1),f(B)),u.enableZoomToHome){G=t.getElementsByClassName("zoomToHome")[0];var q=G.getElementsByTagName("button")[0];q.addEventListener("click",p,!1)}}var r=this,s=b,t=a,u={onTogglePlay:function(){},onToggleFullscreen:function(){},onZoomIn:function(){},onZoomOut:function(){},onZoomToHome:function(){},onToggle3D:function(){},onLogoClick:function(){},onAnnotate:function(){},onButtonClick:function(){},enableAnnotate:!1,enableGlobalView:!1,enableFullscreen:!0,enablePlayToggle:!0,enableLicense:!1,enableLogo:!0,enable3DToggle:!1,enableZoomToHome:!0,toolbarVisible:!0,toolbarBottomOffset:10,toolbarPosition:"center",progressPosition:"center",logoURL:"",logoTarget:"_blank",width:1280,height:720};PS.extend(u,c);var v,w,x,y,z,A,B,C,D,E,F,G,H,I=191;this.destroy=function(){r.progressIndicator&&r.progressIndicator.destroy(),d(H,h),d(v,i),d(w,j),d(x,k),d(y,l),d(z,m),d(A,n),d(B,o),H.getElementsByTagName("a").length>0&&H.getElementsByTagName("a")[0].removeEventListener("click",h),G&&G.getElementsByTagName("button")[0].removeEventListener("click",p)},this.setCameraMode=function(a){u.enableGlobalView&&(a===PS.Packet.ViewMode.Global?(z.style.display="inline",A.style.display="inline"):(z.style.display="none",A.style.display="none"))
},this.setPlayButtonState=function(a){w.className=a},this.getPlayButtonState=function(){return w.className},this.setFullscreenButtonState=function(a){u.enableFullscreen&&(x.className=a,u.enableAnnotate&&(v.style.display="exitFullscreen"===a?"none":""))},this.getFullscreenButtonState=function(){return u.enableFullscreen?x.className:"fullscreen"},this.setProgressPercentVisibility=function(a){D.style.visibility=a?"visible":"hidden"},this.setProgressPercentText=function(a){E.innerHTML=a},this.setToolbarVisibility=function(a){C.style.display=a?"":"none"},this.setToolbarBottomOffset=function(a){C.style.bottom=a+"px"},this.setToolbarPosition=function(a){u.toolbarPosition=a,r.resize(u.width,u.height)},this.setProgressPercentPosition=function(a){u.progressPosition=a,r.resize(u.width,u.height)},this.setZoomToHomeVisibility=function(a){G.style.display=a?"":"none"},this.setSeadragonZoomState=function(a){G&&(G.style.display=a?"none":"")},this.resize=function(a,b){u.width=a,u.height=b;var c=Math.min(u.width,u.height);if("center"===u.progressPosition){var d=Math.round(.18*c);F.style.fontSize=Math.round(.48*d)+"px",F.style.top=-Math.round(.348*d)+"px",D.style.fontSize=d+"px",D.style.marginTop=-Math.round(d/2)+"px";var e=E.clientWidth;D.style.left=Math.round((a-e)/2)+"px",D.style.right="auto",D.style.top="50%",D.style.bottom="auto"}else{var d=Math.round(.1*c);F.style.fontSize=Math.round(.48*d)+"px",F.style.top=-Math.round(.348*d)+"px",D.style.fontSize=d+"px",D.style.marginTop=0,D.style.left="auto",D.style.right="25px",D.style.top="auto",D.style.bottom="10px"}"center"===u.toolbarPosition?(C.style.right="auto",C.style.left=a/2-I/2+"px"):(C.style.right="10px",C.style.left="auto")},q()},PS.Packet.Metadata.Viewer.prototype.generateLogoString=function(a,b,c){var d="";return d+='<div class="progress-indicator" style="position: absolute; z-index: 5; top: 3px; left: 19px;'+(a?"":"display: none;")+'">',d+='	<svg height="67" width="67" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">',d+='		<g transform="scale(0.8)">',d+='		<g transform="translate(12, 0)">',d+='			<circle cx="31" cy="31" r="17.75" stroke-opacity="1" style="stroke: #fff; stroke-width: 1.5px; fill: none;"></circle>',d+='			<circle cx="31" cy="31" r="17.75" stroke-opacity="1" style="stroke: #000; stroke-width:   4px; fill: none;" opacity="0.05" ></circle>',d+="		</g>",d+='		<g transform="translate(24, 12)">',d+='			<circle cx="31" cy="31" r="11.5" stroke-opacity="1" style="stroke: #fff; stroke-width: 1.5px; fill: none;"></circle>',d+='			<circle cx="31" cy="31" r="11.5" stroke-opacity="1" style="stroke: #000; stroke-width:   4px; fill: none;" opacity="0.05" ></circle>',d+="		</g>",d+='		<g transform="translate(12, 24)">',d+='			<circle cx="31" cy="31" r="30.25" stroke-opacity="0" style="stroke: #fff; stroke-width: 1.5px; fill: none;"></circle>',d+='			<circle cx="31" cy="31" r="30.25" stroke-opacity="0" style="stroke: #000; stroke-width:   4px; fill: none;" opacity="0.05" ></circle>',d+="		</g>",d+='		<g transform="translate(0, 12)">',d+='			<circle cx="31" cy="31" r="24" stroke-opacity="1" style="stroke: #fff; stroke-width: 1.5px; fill: none;"></circle>',d+='			<circle cx="31" cy="31" r="24" stroke-opacity="1" style="stroke: #000; stroke-width:   4px; fill: none;" opacity="0.05" ></circle>',d+="		</g>",d+="		</g>",""!==b&&(d+='			<a xmlns="http://www.w3.org/2000/svg" xlink:href="'+b+'" xmlns:xlink="http://www.w3.org/1999/xlink" target="'+c+'" style="cursor: pointer;">',d+='				<rect x="0" y="0" width="100%" height="100%" fill-opacity="0"/>',d+="		</a>"),d+="	</svg>",d+="</div>"},PS.Packet.Metadata.ProgressIndicator=function(a){function b(){r||32!==s?(c(h,s),c(k,(s+25)%100),c(j,(s+50)%100),c(i,(s+75)%100),c(l,s),c(o,(s+25)%100),c(n,(s+50)%100),c(m,(s+75)%100),s++,s>=100&&(s=0)):(i.setAttribute("stroke-opacity",parseFloat(i.getAttribute("stroke-opacity"))+.08),k.setAttribute("stroke-opacity",parseFloat(k.getAttribute("stroke-opacity"))+.01),i.getAttribute("stroke-opacity")>=1&&(clearInterval(d),q=!1)),p&&50===s&&(p=!1)}function c(a,b){a.setAttribute("r",10+b/4),p?a.setAttribute("stroke-opacity",50>b?1:(b-80)/-30):a.setAttribute("stroke-opacity",20>=b?b/20:50>b?1:(b-80)/-30)}var d,e,f=a,g=f.getElementsByTagName("circle"),h=g[0],i=g[2],j=g[4],k=g[6],l=g[1],m=g[3],n=g[5],o=g[7],p=!0,q=!1,r=!1,s=0,t=this;this.destroy=function(){t.stop(),clearInterval(d),e&&(cancelAnimationFrame(e),e=null)},this.setPercent=function(a){a>=100?t.stop():t.start()},this.start=function(){r||(r=!0,p=!0,q||(s=32,d=setInterval(function(){e=requestAnimationFrame(b)},25)),q=!1)},this.stop=function(){r&&(r=!1,q=!0)},this.setVisible=function(a){f.style.display=a?"":"none"}},PS.Packet.CameraForWorker=function(a){this.position=a.pose.position,this.cameraFront=a.cameraFront,this.cameraUp=a.cameraUp,this.cameraRight=a.cameraRight,this.my=a.my,this.mx=a.mx},PS.Packet.IntersectPoint=function(a,b){this.p=a,this.isFront=b},PS.Packet.Camera=function(a,b,c,d){function e(a){var b,c=!0;b=i.intersectPoint(i.dominantPlane,-1,1);var d=b.p;c&=b.isFront,b=i.intersectPoint(i.dominantPlane,1,1);var e=b.p;c&=b.isFront,b=i.intersectPoint(i.dominantPlane,1,-1);var f=b.p;c&=b.isFront,b=i.intersectPoint(i.dominantPlane,-1,-1);var g=b.p;if(c&=b.isFront,!c){var h=.99*i.far,j=2*h*Math.tan(.5*i.fovy*Math.PI/180),k=j*i.aspectRatio,l=i.pose.position.clone(),m=i.pose.orientation.clone();d=new THREE.Vector3(-k/2,j/2,-h).applyQuaternion(m).add(l),e=new THREE.Vector3(k/2,j/2,-h).applyQuaternion(m).add(l),f=new THREE.Vector3(k/2,-j/2,-h).applyQuaternion(m).add(l),g=new THREE.Vector3(-k/2,-j/2,-h).applyQuaternion(m).add(l)}var n=new THREE.BufferGeometry;if(n.dynamic=!0,n.attributes={index:{itemSize:1,array:new Uint16Array([0,2,1,0,3,2]),numItems:6},position:{itemSize:3,array:new Float32Array([d.x,d.y,d.z,e.x,e.y,e.z,f.x,f.y,f.z,g.x,g.y,g.z]),numItems:4}},a){var o={r:Math.random(),g:Math.random(),b:Math.random()};n.attributes.color={itemSize:3,array:new Float32Array([o.r,o.g,o.b,o.r,o.g,o.b,o.r,o.g,o.b,o.r,o.g,o.b]),numItems:4}}n.offsets.push({start:0,count:6,index:0});var p=6,q=4;return n.size=2*p+3*q*4+a?3*q*4:0,PS.Packet.WebGLMU.addBuffer(n.size),n}function f(a,b){var c=PS.Packet.Shaders.Factory.generateProjectiveShaders({thumbnailAtlasShader:!1,debugPolygonColorEnabled:a,featheringBlendingEnabled:b}),d=THREE.UniformsUtils.clone(c.uniforms);d.textureMatrix.value=i.textureMatrix,d.colorTex.value=null;var e=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:d,depthWrite:!0,vertexColors:a?THREE.VertexColors:THREE.NoColors});return e}function g(a,b){var c=PS.Packet.Shaders.Factory.generateProjectiveShaders({thumbnailAtlasShader:!0,debugPolygonColorEnabled:a,featheringBlendingEnabled:b}),d=THREE.UniformsUtils.clone(c.uniforms);d.textureMatrix.value=i.textureMatrix;var e=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:d,depthWrite:!0,vertexColors:a?THREE.VertexColors:THREE.NoColors});return e}function h(a){var b=i.highMaterial.uniforms;if(b.colorTex.value){var c=a.image;PS.Packet.WebGLMU.addTexture(-c.width*c.height*3),i.viewer.onGPUMemoryChange(),b.colorTex.value.dispose(),b.colorTex.value=null}b.colorTex.value=a}var i=this,j=new THREE.Vector3(a.position[0],a.position[1],a.position[2]),k=new THREE.Quaternion(a.orientation[0],a.orientation[1],a.orientation[2],a.orientation[3]);this.dominantPlane=new PS.Packet.Plane(new THREE.Vector3(a.dominant_plane[0],a.dominant_plane[1],a.dominant_plane[2]),a.dominant_plane[3]),this.aspectRatio=parseFloat(a.intrinsics[1]),this.fovy=parseFloat(a.intrinsics[0]),this.fovx=2*Math.atan(this.aspectRatio*Math.tan(this.fovy*Math.PI/360))*180/Math.PI,this.k1=parseFloat(a.intrinsics[2]),this.k2=parseFloat(a.intrinsics[3]),this.near=parseFloat(a.depth_range[0]),this.far=parseFloat(a.depth_range[1]),this.index=b,this.qIndex=a.path_index,this.iIndex=a.index,this.sIndex=0,this.originalSize=a.original_size?new THREE.Vector2(parseFloat(a.original_size[0]),parseFloat(a.original_size[1])):new THREE.Vector2(0,0),this.pyramid=new PS.Packet.Seadragon.TileSource(this.originalSize),this.nextCamera=null,this.prevCamera=null,this.viewer=null;var l=(new THREE.Matrix4).makeRotationFromQuaternion(k);this.cameraRight=(new THREE.Vector3).getColumnFromMatrix(0,l),this.cameraUp=(new THREE.Vector3).getColumnFromMatrix(1,l),this.cameraFront=(new THREE.Vector3).getColumnFromMatrix(2,l).negate(),this.pose=new PS.Packet.Pose(j,k),this.textureMatrix=this.computeTextureMatrix(this.pose),this.featurePoints=[];var m=this.fovy*Math.PI/180;this.my=Math.tan(m/2),this.mx=this.my*this.aspectRatio,this.balanceToPrevious=new THREE.Vector4(1,1,1,1),this.balanceToNext=new THREE.Vector4(1,1,1,1),this.unsmoothedScale=new THREE.Vector4(1,1,1,1),this.smoothedScale=new THREE.Vector4(1,1,1,1),a.balance_to_previous&&(this.balanceToPrevious.x=a.balance_to_previous[0],this.balanceToPrevious.y=a.balance_to_previous[1],this.balanceToPrevious.z=a.balance_to_previous[2]),a.balance_to_next&&(this.balanceToNext.x=a.balance_to_next[0],this.balanceToNext.y=a.balance_to_next[1],this.balanceToNext.z=a.balance_to_next[2]),a.timestamp&&(this.timestamp=parseInt(a.timestamp,10)),this.lowGeometry=e(c),this.highGeometry=i.lowGeometry,this.lowMaterial=g(c,d),this.highMaterial=f(c,d),this.mesh=new THREE.Mesh(this.lowGeometry,this.lowMaterial),this.mesh.matrixAutoUpdate=!1,this.colorScale=this.highMaterial.uniforms.colorScale,this.colorScale.value=new THREE.Vector4(1,1,1,1),this.isSelected=!1,this.isDownloading=!1,this.wasDownloadedOnce=!1;var n=!0;this.loadTexture=function(a,b,c){i.isDownloading=!0,i.viewer.onBeginDownloading(i.viewer,{type:"image",index:i.index,sIndex:i.sIndex}),new PS.Utils.ImageDownloader(a,function(a,d){if(a&&(console.log("Failed loading: "+a.src),i.isDownloading=!1),d){if(i.wasDownloadedOnce=!0,b(d),i.isSelected){var e=new THREE.Texture(d);e.flipY=!0,e.needsUpdate=!1,e.generateMipmaps=!1,e.minFilter=THREE.LinearFilter,e.onUpdate=function(){c(e);var a=e.image;PS.Packet.WebGLMU.addTexture(a.width*a.height*3),i.viewer.onGPUMemoryChange()},i.viewer.loadTexture(e)}i.isDownloading=!1,i.viewer.onFinishDownloading(i.viewer,{type:"image",index:i.index,sIndex:i.sIndex})}},i.viewer.isCorsEnabled())},this.resetScale=function(){i.smoothedScale=new THREE.Vector4(1,1,1,1)},this.initializeScaleToCamera=function(a){if(a===i.nextCamera)i.smoothedScale.x=a.smoothedScale.x*i.balanceToNext.x,i.smoothedScale.y=a.smoothedScale.y*i.balanceToNext.y,i.smoothedScale.z=a.smoothedScale.z*i.balanceToNext.z;else if(a===i.prevCamera)i.smoothedScale.x=a.smoothedScale.x*i.balanceToPrevious.x,i.smoothedScale.y=a.smoothedScale.y*i.balanceToPrevious.y,i.smoothedScale.z=a.smoothedScale.z*i.balanceToPrevious.z;else{for(var b=i.nextCamera,c=i.prevCamera,d=1;b!==a&&c!==a;)b&&b.nextCamera&&(b=b.nextCamera),c&&c.prevCamera&&(c=c.prevCamera),d+=1;if(d>4)return void i.resetScale();var e=i;if(i.smoothedScale=a.smoothedScale,b===a)for(;e!==a;)i.smoothedScale.x=i.smoothedScale.x*e.balanceToNext.x,i.smoothedScale.y=i.smoothedScale.y*e.balanceToNext.y,i.smoothedScale.z=i.smoothedScale.z*e.balanceToNext.z,e=e.nextCamera;else if(c===a)for(;e!==a;)i.smoothedScale.x=i.smoothedScale.x*e.balanceToPrevious.x,i.smoothedScale.y=i.smoothedScale.y*e.balanceToPrevious.y,i.smoothedScale.z=i.smoothedScale.z*e.balanceToPrevious.z,e=e.prevCamera}},this.setPercentToNext=function(a){i.unsmoothedScale=new THREE.Vector4(1,1,1,1).lerp(i.balanceToNext,a)},this.setPercentToPrevious=function(a){i.unsmoothedScale=new THREE.Vector4(1,1,1,1).lerp(i.balanceToPrevious,a)},this.updateLowMaterial=function(a,b,c){var d=i.lowMaterial.uniforms;d.colorTex.value=b,d.thumbnail.value=a.getUniform(c)},this.updateMesh=function(a,b){n=!1,this.highGeometry=a,this.highGeometry.dynamic=!0,b||(this.mesh=new THREE.Mesh(this.highGeometry,this.highMaterial.uniforms.colorTex.value?this.highMaterial:this.lowMaterial)),this.mesh.matrixAutoUpdate=!1,this.viewer.renderer.forceUpdateIfVisible(this,this.sIndex)},this.assignPreloadedContent=function(a,b){this.highMaterial.uniforms.colorTex.value=a,this.highGeometry=b,this.highGeometry.dynamic=!0,this.mesh=new THREE.Mesh(this.highGeometry,this.highMaterial),this.mesh.matrixAutoUpdate=!1},this.useAtlas=function(a,b){if(i.mesh.material===i.highMaterial||b){if(i.mesh.material===i.highMaterial){var c=i.highMaterial.uniforms.colorTex.value;c.dispose();var d=c.image;PS.Packet.WebGLMU.addTexture(-d.width*d.height*3),i.viewer.onGPUMemoryChange(),i.highMaterial.uniforms.colorTex.value=null}i.mesh=new THREE.Mesh(a?i.lowGeometry:i.highGeometry,i.lowMaterial),i.viewer.renderer.forceUpdateIfVisible(i,i.sIndex)}},this.useHD=function(a,b){if(i.mesh.material===i.lowMaterial&&!i.isDownloading&&i.highGeometry||b){var c=i.viewer.dataset.getImageUrl(this.iIndex);return i.mesh.material===i.highMaterial?(i.mesh=new THREE.Mesh(a?i.lowGeometry:i.highGeometry,i.highMaterial),i.mesh.matrixAutoUpdate=!1,i.viewer.renderer.forceUpdateIfVisible(i,i.sIndex),!0):!n&&i.wasDownloadedOnce?(i.loadTexture(c,function(){},function(b){i.updateHighMaterial(b,a)}),!0):!1}},this.updateHighMaterial=function(a,b){h(a),i.mesh=new THREE.Mesh(b?i.lowGeometry:i.highGeometry,i.highMaterial),i.mesh.matrixAutoUpdate=!1,i.viewer.renderer.forceUpdateIfVisible(i,i.sIndex)}},PS.Packet.Camera.prototype.computeTextureMatrix=function(a){var b=a.orientation.clone();b.inverse();var c=a.position.clone(),d=c.applyQuaternion(b);d.x=-d.x,d.y=-d.y,d.z=-d.z;var e=0,f=0;if(this.aspectRatio<1){var g=1/(2*Math.tan(this.fovy*Math.PI/360));f=g,e=g/this.aspectRatio}else{var g=1/(2*Math.tan(this.fovx*Math.PI/360));e=g,f=g*this.aspectRatio}var h=new THREE.Matrix4(-e,0,.5,0,0,f,.5,0,0,0,1,0,0,0,0,1),i=(new THREE.Matrix4).compose(d,b,new THREE.Vector3(1,1,1)),j=new THREE.Matrix4;return j.multiplyMatrices(h,i),j.multiplyScalar(-1),j.n44=1,j},PS.Packet.Camera.prototype.intersectPoint=function(a,b,c){var d=this.cameraFront.clone().add(this.cameraRight.clone().multiplyScalar(b*this.mx)).add(this.cameraUp.clone().multiplyScalar(c*this.my)).normalize(),e=a.normal,f=a.depth,g=e.dot(this.pose.position)+f,h=e.dot(d),i=-(g/h);return new PS.Packet.IntersectPoint(d.multiplyScalar(i).add(this.pose.position),i>=0)},PS.Packet.Camera.prototype.dispose=function(){if(this.highMaterial){var a=this.highMaterial.uniforms.colorTex.value;a&&(PS.Packet.WebGLMU.addTexture(-a.image.width*a.image.height*3),a.dispose(),a=null),this.highMaterial.dispose(),this.highMaterial=null}this.highGeometry&&(PS.Packet.WebGLMU.addBuffer(-this.highGeometry.size),this.highGeometry.dispose(),this.highGeometry=null),this.lowMaterial&&(this.lowMaterial.dispose(),this.lowMaterial=null),this.lowGeometry&&(PS.Packet.WebGLMU.addBuffer(-this.lowGeometry.size),this.lowGeometry.dispose(),this.lowGeometry=null)},PS.Packet.Dataset=function(a){this.rootUrl=a,this.version=null,this.topology=null,this.dominantColors=null,this.cameras=[],this.path=null,this.atlases=[],this.thumbnails=[],this.particleSystems=[],this.frustrums=null,this.camerasAxes=[],this.smoothCameraPath=null,this.linearCameraPath=null,this.origin=null,this.averageQIndexDistBetweenCameras=null,this.averageWorldDistBetweenCameras=null,this.reverseCamIndex=null,this.nbAtlases=null,this.nbAtlasesLoaded=0,this.geometryRanges=null,this.nbGeometryLoaded=0,this.nbPointCloudFiles=null,this.medianFov=null,this.medianAspectRatio=null,this.near=null,this.far=null,this.medianCamera=null,this.imageSize=new THREE.Vector2,this.thumbSize=new THREE.Vector2,this.renderingImageSize=new THREE.Vector2,this.nbLevels=null,this.lod=null,this.nbSurroundingImage=null,this.pointCloudMaterial=new THREE.ParticleBasicMaterial({size:.05,vertexColors:!0}),this.animateSpeed=1,this.startTransitionPercent=null,this.startingCamera=null,this.draggingDirection=new THREE.Vector2,this.draggingDirectionCSSClass="",this.startLoading=Date.now(),this.preDownloadedImages=[],this.allGeometryWereDownloaded=!1,this.allHDWereDownloadedOnce=!1,this.priorityDownloader=null,this.isRenderable=!1},PS.Packet.Dataset.prototype.getCameraByIndex=function(a){var b=this.reverseCamIndex[a];return this.cameras[b]},PS.Packet.Dataset.prototype.getImageUrl=function(a){var b=10>a?"000"+a:100>a?"00"+a:1e3>a?"0"+a:a;return this.rootUrl+"l"+this.lod+"/img"+b+".jpg"},PS.Packet.Dataset.prototype.getSeadragonRootUrl=function(a){var b=10>a?"000"+a:100>a?"00"+a:1e3>a?"0"+a:a;return this.rootUrl+"undistorted/img"+b+"/"},PS.Packet.Dataset.prototype.getGeometryUrl=function(a){return this.rootUrl+(2===this.version.json?"geometry/":"")+"geometry_"+a+".bin"},PS.Packet.Dataset.prototype.getPointCloudUrl=function(a){return this.rootUrl+(2===this.version.json?"points/points_"+a+".bin":"ps1/points_0_"+a+".bin")},PS.Packet.Dataset.prototype.getSurroundingCameras=function(a,b){var c=this.cameras.slice(0),d=this;return c.sort(this.path.isClosed?function(b,c){var e=Math.abs(b.qIndex-a)%d.path.nbPoints;e>Math.round(d.path.nbPoints/2)&&(e=d.path.nbPoints-e);var f=Math.abs(c.qIndex-a)%d.path.nbPoints;return f>Math.round(d.path.nbPoints/2)&&(f=d.path.nbPoints-f),e-f}:function(b,c){return Math.abs(b.qIndex-a)-Math.abs(c.qIndex-a)}),b&&(c=c.filter(function(a,c){return b>c})),c.map(function(a){return a.sIndex})},PS.Packet.Dataset.prototype.createSubCamerasList=function(a,b){for(var c=new Array(b-a),d=0,e=a;b>e;++e)c[d++]=new PS.Packet.CameraForWorker(this.cameras[this.reverseCamIndex[e]]);return c},PS.Packet.Dataset.prototype.computeRange=function(a){for(var b=0,c=this.geometryRanges[0],d=1;a>=d;++d)b=c,c+=this.geometryRanges[d];return{start:b,end:c}},PS.Packet.Dataset.prototype.createCamerasFrustums=function(){for(var a=new THREE.Geometry,b=new THREE.LineBasicMaterial({color:0,opacity:1,linewidth:3,vertexColors:!1}),c=this.averageWorldDistBetweenCameras/2,d=0;d<this.cameras.length;++d){var e=this.cameras[d],f=2*c*Math.tan(.5*e.fovy*Math.PI/180),g=f*e.aspectRatio,h=e.pose.position.clone(),i=e.pose.orientation.clone(),j=new THREE.Vector3(-g/2,f/2,-c).applyQuaternion(i).add(h),k=new THREE.Vector3(g/2,f/2,-c).applyQuaternion(i).add(h),l=new THREE.Vector3(g/2,-f/2,-c).applyQuaternion(i).add(h),m=new THREE.Vector3(-g/2,-f/2,-c).applyQuaternion(i).add(h);a.vertices.push(j),a.vertices.push(k),a.vertices.push(k),a.vertices.push(l),a.vertices.push(l),a.vertices.push(m),a.vertices.push(m),a.vertices.push(j),a.vertices.push(h),a.vertices.push(j),a.vertices.push(h),a.vertices.push(k),a.vertices.push(h),a.vertices.push(l),a.vertices.push(h),a.vertices.push(m)}var n=new THREE.Line(a,b,THREE.LinePieces);return n.visible=!1,n},PS.Packet.Dataset.prototype.createAxes=function(a){var b=new THREE.Geometry;b.vertices.push(new THREE.Vector3,new THREE.Vector3(1,0,0),new THREE.Vector3,new THREE.Vector3(0,1,0),new THREE.Vector3,new THREE.Vector3(0,0,1)),b.colors.push(new THREE.Color(16711680),new THREE.Color(16711680),new THREE.Color(65280),new THREE.Color(65280),new THREE.Color(255),new THREE.Color(255));var c=new THREE.Line(b,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),THREE.LinePieces);return c.position=a,c.visible=!1,c},PS.Packet.Dataset.prototype.createCamerasAxes=function(){for(var a=this.cameras.length,b=new Array(a),c=this.averageWorldDistBetweenCameras/2,d=0;a>d;++d){var e=this.cameras[d],f=this.createAxes(e.pose.position);f.quaternion=e.pose.orientation,f.scale.set(c,c,c),b[d]=f}return b},PS.Packet.Dataset.prototype.createSmoothCameraPath=function(){for(var a=new THREE.Geometry,b=new THREE.LineBasicMaterial({color:16711935,opacity:1,linewidth:3,vertexColors:!1}),c=0;c<this.path.points.length-1;++c){var d=this.path.points[c],e=this.path.points[c+1];a.vertices.push(d.position),a.vertices.push(e.position)}var f=new THREE.Line(a,b,THREE.LinePieces);return f.visible=!1,f},PS.Packet.Dataset.prototype.createLinearCameraPath=function(){for(var a=new THREE.Geometry,b=new THREE.LineBasicMaterial({color:0,opacity:1,linewidth:3,vertexColors:!1}),c=0;c<this.cameras.length-1;++c){var d=this.cameras[c],e=this.cameras[c+1];a.vertices.push(d.pose.position),a.vertices.push(e.pose.position)}var f=new THREE.Line(a,b,THREE.LinePieces);return f.visible=!1,f},PS.Packet.Dataset.prototype.createGlobalViewGeometries=function(){this.frustums=this.createCamerasFrustums(),this.camerasAxes=this.createCamerasAxes(),this.smoothCameraPath=this.createSmoothCameraPath(),this.linearCameraPath=this.createLinearCameraPath(),this.origin=this.createAxes(new THREE.Vector3(0,0,0));var a=2*this.averageWorldDistBetweenCameras;this.origin.scale.set(a,a,a)},PS.Packet.Dataset.prototype.updateSlidingWindow=function(a){for(var b=!a.geometryEnabled,c=this.getSurroundingCameras(a.currentQIndex,this.nbSurroundingImage),d=0;d<this.cameras.length;++d){var e=this.cameras[d],f=e.isSelected,g=-1!==c.indexOf(d);if(e.isSelected=g,f&&!g)e.useAtlas(b);else if(g&&!f){var h=e.useHD(b);!h&&g&&(e.isSelected=!1)}}},PS.Packet.Dataset.prototype.unload=function(a){this.isRenderable=!1,this.priorityDownloader&&this.priorityDownloader.destroy(),this.pointCloudMaterial.dispose();var b=a.getScenes(),c=b[0].scene;c.remove(this.frustums),c.remove(this.smoothCameraPath),c.remove(this.linearCameraPath),c.remove(this.origin);for(var d=0;d<this.camerasAxes.length;++d)c.remove(this.camerasAxes[d]);for(var d=0;d<this.particleSystems.length;++d)c.remove(this.particleSystems[d]);for(var d=0;d<b.length;++d)b[d].clear();this.frustums.geometry.dispose(),this.smoothCameraPath.geometry.dispose(),this.linearCameraPath.geometry.dispose(),this.origin.geometry.dispose();for(var d=0;d<this.camerasAxes.length;++d)this.camerasAxes[d].geometry.dispose();for(var d=0;d<this.cameras.length;++d)this.cameras[d].dispose();for(var d=0;d<this.atlases.length;++d){var e=this.atlases[d];PS.Packet.WebGLMU.addTexture(-e.image.width*e.image.height*3),e.dispose()}for(var d=0;d<this.particleSystems.length;++d){var f=this.particleSystems[d],g=f.geometry.attributes.position.numItems/3;PS.Packet.WebGLMU.addBuffer(3*-g*4*2),f.geometry.dispose()}},PS.Packet.Dataset.prototype.getDominantColor=function(){var a=this.dominantColors[0];return(new THREE.Color).setRGB(a[0]/255,a[1]/255,a[2]/255)},PS.Packet.DatasetLoader=function(a,b){function c(a,b){for(var c=a.cameras.length,d=0;c>d;++d)a.cameras[d].sIndex=d,(c-1>d||b)&&(a.cameras[d].nextCamera=a.cameras[(d+1)%c]),(d>0||b)&&(a.cameras[d].prevCamera=a.cameras[d>0?d-1:c-1])}function d(a){var b=a.cameras.length;a.averageQIndexDistBetweenCameras=0,a.averageWorldDistBetweenCameras=0;for(var c=1;b>c;++c)a.averageQIndexDistBetweenCameras+=a.cameras[c].qIndex-a.cameras[c-1].qIndex,a.averageWorldDistBetweenCameras+=a.cameras[c].pose.position.clone().sub(a.cameras[c-1].pose.position).length();a.averageQIndexDistBetweenCameras/=b-1,a.averageWorldDistBetweenCameras/=b-1,a.reverseCamIndex=new Array(b);for(var c=0;b>c;++c)a.reverseCamIndex[a.cameras[c].index]=c;for(var d=Number.POSITIVE_INFINITY,e=0,c=0;b>c;++c)d=Math.min(a.cameras[c].near,d),e=Math.max(a.cameras[c].far,e);d/=4,e*=8,a.near=d,a.far=e,o.onLog({type:"Info",message:"Perspective camera -> near: "+d+", far: "+e})}function e(a){for(var b=a.cameras.length,c=new THREE.Vector3,d=new THREE.Vector3,e=1;b>e;++e){var f=a.cameras[e].pose.orientation.clone().inverse();c.subVectors(a.cameras[e].pose.position,a.cameras[e-1].pose.position).normalize(),c.applyQuaternion(f),d.add(c)}"walk"===a.topology?(a.draggingDirection.set(0,d.z<0?1:-1),a.draggingDirectionCSSClass="Vertical"):Math.abs(d.x)>Math.abs(d.y)?(a.draggingDirection.set(d.x<0?1:-1,0),a.draggingDirectionCSSClass="Horizontal"):(a.draggingDirection.set(0,d.y<0?-1:1),a.draggingDirectionCSSClass="Vertical"),o.onLog({type:"Info",message:"Dragging direction: ("+a.draggingDirection.x+","+a.draggingDirection.y+")"})}function f(a){for(var b=a.cameras.length,c=new Array(b),d=0;b>d;++d)c[d]=a.cameras[d].aspectRatio;return c.sort(function(a,b){return a-b}),c[Math.floor(b/2)]}function g(a){if(a.startTransitionPercent=-1===o.startTransitionPercent?"spin"===a.topology||"panorama"===a.topology?.5:0:o.startTransitionPercent,-1!==o.startCameraIndex)if(o.startCameraIndex>=0&&o.startCameraIndex<a.cameras.length){var b=a.cameras[o.startCameraIndex];o.startTransitionPercent=b.qIndex/(a.path.nbPoints-1),o.onLog({type:"Info",message:"Start camera index: "+o.startCameraIndex})}else o.onLog({type:"Error",message:"Out of range startCameraIndex: "+o.startCameraIndex+" >= "+a.cameras.length}),o.onLog({type:"Info",message:"Start transition percent: "+a.startTransitionPercent});else o.onLog({type:"Info",message:"Start transition percent: "+a.startTransitionPercent});a.startingCamera=a.path.getClosestCamera(o.startTransitionPercent*a.path.nbPoints,!1)}function h(a){if("wall"===a.topology||"walk"===a.topology)a.animateSpeed*=a.averageQIndexDistBetweenCameras*o.wallWalkFramePerSecond*16.667/1e3;else if("spin"===a.topology||"panorama"===a.topology){a.animateSpeed*=17067.008/(1e3*o.timeForFullRotation);var b=a.cameras.length/(o.timeForFullRotation*a.path.nbPoints/1024),c="spin"===a.topology?o.maxSpinFramePerSecond:o.maxPanoFramePerSecond;b>c&&(a.animateSpeed*=c/b)}o.onLog({type:"Info",message:"Animation duration: "+Math.round(16.667*a.path.nbPoints*10/(1e3*a.animateSpeed))/10+"s"})}function i(a,b){if("spin"===a.topology&&b.center_point&&o.pathFixingEnabled){for(var c=new THREE.Vector3(b.center_point[0],b.center_point[1],b.center_point[2]),d=new THREE.Vector3(0,0,1),e=a.cameras[0].cameraUp.dot(d)<0,f=e?d.clone().negate():d.clone(),g=!1,h=!1,i=0,j=0,k=0;k<a.path.nbPoints;++k){var l=a.path.points[k],m=c.clone().sub(l.position).normalize(),n=new THREE.Vector3(0,0,-1).applyQuaternion(l.orientation),p=new THREE.Vector3(1,0,0).applyQuaternion(l.orientation),q=(new THREE.Vector3).crossVectors(n,f).normalize(),r=180*Math.acos(n.dot(m))/Math.PI;r>i&&(i=r);var s=180*Math.acos(p.dot(q))/Math.PI;s>j&&(j=s)}i<o.singleLookAtThreshold&&(g=!0),j<o.cameraRollThreshold&&(h=!0),a.path.fixSpinOrientations(c,f,g,h)}else if(("wall"===a.topology||"walk"===a.topology)&&o.pathFixingEnabled){var t=a.path.getOrientationVariability(),u=180*t[1]/Math.PI<o.sharedOrientationThreshold;if(o.onLog({type:"Info",message:"Orientation variation "+180*t[1]/Math.PI+" -> "+u}),u)a.path.setAllOrientations(t[0]);else{var v=new THREE.Vector3(0,0,1),w=new THREE.Vector3(0,0,-1),x=new THREE.Vector3(1,0,0),y=a.path.getDirectionVariability(v,w),z=a.path.getDirectionVariability(v,x),A=180*y[1]/Math.PI<o.wallWalkPitchThreshold,B=180*z[1]/Math.PI<o.wallWalkRollThreshold;o.onLog({type:"Info",message:"Pitch variation "+180*y[1]/Math.PI+" -> "+A}),o.onLog({type:"Info",message:"Roll variation "+180*z[1]/Math.PI+" -> "+B}),a.path.fixWallWalkOrientations(v,y[0],z[0],A,B)}}}function j(a){a.renderingImageSize=a.imageSize.clone();for(var b=0;a.renderingImageSize.x*a.renderingImageSize.y>o.maxHDPixels&&b<a.nbLevels-1;)a.renderingImageSize.x=Math.floor(a.renderingImageSize.x/2),a.renderingImageSize.y=Math.floor(a.renderingImageSize.y/2),b++;return o.onLog({type:"Info",message:"Choosing LoD "+b+" ("+a.renderingImageSize.x+"x"+a.renderingImageSize.y+")"}),b}function k(a){for(var b=a.cameras.length,c=0;b>c;++c){var d=a.thumbnails[c],e=a.atlases[d.atlasIndex];a.cameras[c].updateLowMaterial(d,e,a.thumbSize)}o.onLog({type:"Stats",label:"dominant plane geometry",time:Date.now()-q})}function l(a,b,c,d){var e=[];if("zigzag"===d)for(var f=0;2*a>f;++f){var g=f>>1^-(1&f),h=b+g;a>h&&h>=0&&e.push(h)}else if(-1===c){for(var f=b;f>=0;--f)e.push(f);for(var f=b+1;a>f;++f)e.push(f)}else if(1===c){for(var f=b;a>f;++f)e.push(f);for(var f=b-1;f>=0;--f)e.push(f)}return e}function m(a){var b=a.cameras.length,c=l(b,a.startingCamera.sIndex,o.animateDirection,"contiguous").slice(0,o.downloadConcurrency),d=PS.Utils.generateRangeArray(a.geometryRanges.length),e=c.map(function(a){return{type:"image",index:a}});e=e.concat(d.map(function(a){return{type:"geometry",index:a}})),a.preDownloadedImages=c;var f=0;o.onProgressPercentChange(0),new PS.Utils.Async.Queue(e,{concurrency:o.downloadConcurrency,onProcess:function(b,c){var d=b.index;if("image"===b.type){var g=a.getImageUrl(a.cameras[d].iIndex);a.cameras[d].loadTexture(g,function(){a.cameras[d].isSelected=!0,f++,o.onProgressPercentChange(f/e.length),c()},function(b){a.cameras[d].updateHighMaterial(b)})}else{var h=a.computeRange(d);new PS.Utils.Request(a.getGeometryUrl(d),{responseType:"arraybuffer",onComplete:function(b){f++,o.onProgressPercentChange(f/e.length);var g=r?[]:[b.response];v.postMessage({type:"createGeometry",cameras:a.createSubCamerasList(h.start,h.end),buffer:b.response,startCameraIndex:h.start,endCameraIndex:h.end,fileIndex:d,debugBlendingEnabled:o.debugBlendingEnabled,rootUrl:a.rootUrl},g),c()},onError:function(){o.onLog({type:"Error",message:"Fail to load: "+a.getGeometryUrl(d)}),c()}})}},onComplete:function(){a.allGeometryWereDownloaded=!0,o.onProgressPercentChange(1),o.onAllGeometryDownloaded(),o.onLog({type:"Stats",label:"full geometry downloaded",time:new Date-q}),o.progressBarEnabled&&PS.Progress.init();var b=o.getViewerState(),c=b.hasUserAlreadyInteracted(),d=a.startingCamera.sIndex,e="contiguous";if(c){var f=a.path.getClosestCamera(b.currentQIndex,!1);d=f.sIndex,e="zigzag";var g=b.currentPose;g.position.equals(f.pose.position)&&g.orientation.equals(f.pose.orientation)&&o.startDownloadingTiles(f,!0)}var h=l(a.cameras.length,d,o.animateDirection,e);c||(h=h.slice(o.downloadConcurrency));var i=h.map(function(b,c){var d=a.cameras[b];return new PS.Utils.Async.PriorityItem(d.iIndex,b,c)});a.priorityDownloader=new PS.Utils.Async.PriorityQueue(i,{concurrency:o.downloadConcurrency,onProcess:function(b,c){var d=a.cameras[b.value],e=a.getImageUrl(d.iIndex);d.loadTexture(e,function(){var b=a.cameras.reduce(function(a,b){return a+(b.wasDownloadedOnce?1:0)},0);o.progressBarEnabled&&PS.Progress.set(b/a.cameras.length),s.updateSlidingWindow(o.getViewerState()),c()},function(){})},onComplete:function(){a.allHDWereDownloadedOnce=!0,o.onAllHDLoaded(),o.onLog({type:"Stats",label:"all HD",time:new Date-q}),o.progressBarEnabled&&setTimeout(function(){PS.Progress.done()},150),o.pointCloudEnabled&&n(a)}})}})}function n(a){var b=a.nbPointCloudFiles;o.onLog({type:"Info",message:b+" PS1 point cloud files"}),new PS.Utils.Async.Queue(PS.Utils.generateRangeArray(a.nbPointCloudFiles),{concurrency:o.downloadConcurrency,onProcess:function(b,c){new PS.Utils.Request(a.getPointCloudUrl(b),{responseType:"arraybuffer",onComplete:function(d){var e=r?[]:[d.response];v.postMessage({type:"createPointCloud",index:b,buffer:d.response,rootUrl:a.rootUrl},e),c()},onError:function(){o.onLog({type:"Error",message:"Fail to load: "+a.getPointCloudUrl(b)}),c()}})},onComplete:function(){o.onLog({type:"Stats",label:"point cloud downloaded",time:new Date-q})}})}var o={onViewerReady:function(){}};PS.extend(o,b);var p,q,r=-1!==navigator.userAgent.indexOf("Trident"),s=this,t=a;this.destroy=function(){v&&(v.destroy(),v=null)};var u=PS.extend({},b);u.onPointCloudLoaded=function(a,b){if(p.rootUrl!==a)return b.dispose(),void(b=null);var c=new THREE.ParticleSystem(b,p.pointCloudMaterial);c.visible=!1,p.particleSystems.push(c),o.onPointCloudLoaded(c),p.particleSystems.length===p.nbPointCloudFiles&&o.onLog({type:"Stats",label:"point cloud loaded",time:new Date-q})},u.onGeometryCreated=function(a,b,c){if(p.rootUrl!==a)return c.dispose(),void(c=null);var d=p.reverseCamIndex[b],e=p.cameras[d];e.updateMesh(c,!o.geometryEnabled)},u.onGeometryFileLoaded=function(a){if(p.rootUrl===a&&(p.nbGeometryLoaded++,p.nbGeometryLoaded===p.geometryRanges.length)){for(var b=0;b<p.atlases.length;++b)p.atlases[b].minFilter=THREE.LinearFilter,p.atlases[b].magFilter=THREE.LinearFilter,p.atlases[b].needsUpdate=!0;o.onLog({type:"Stats",time:new Date-q,label:"full geometry loaded"}),o.onAllGeometryLoaded()}};var v=new PS.Packet.DatasetLoaderWorker(u);this.updateSlidingWindow=function(a){if(p.isRenderable&&(p.updateSlidingWindow(a),p.allGeometryWereDownloaded&&!p.allHDWereDownloadedOnce&&p.priorityDownloader)){var b=p.path.getClosestCamera(a.currentQIndex,!0).sIndex,c="zigzag",d=l(p.cameras.length,b,o.animateDirection,c);d.forEach(function(a,b){var c=p.cameras[a];
c.wasDownloadedOnce||p.priorityDownloader.setPriority(c.iIndex,b)})}},this.load=function(a,b){var c={startCameraIndex:-1};PS.extend(c,b),o.startCameraIndex=c.startCameraIndex,s.preload(a,function(a){s.setActive(a)})},this.setActive=function(a){p&&(t.unload(),t.onGPUMemoryChange()),p=a,o.onViewerReady(a),m(a)},this.preload=function(a,b){q=Date.now();var l=new PS.Packet.Dataset;l.startLoading=Date.now(),l.rootUrl=a,o.onLog({type:"Info",message:"Loading: "+l.rootUrl+"0.json"}),new PS.Utils.Async.parallel([function(a){new PS.Utils.Request(l.rootUrl+"0.json",{onComplete:function(b){var c=JSON.parse(b.responseText);a(null,c)},onError:function(){o.onLog({type:"Error",message:"Fail to load: "+l.rootUrl+"0.json"}),a("Fail to load: "+l.rootUrl+"0.json",null)}})},function(a){new PS.Utils.Request(l.rootUrl+"path.bin",{responseType:"arraybuffer",onComplete:function(b){a(null,b.response)},onError:function(){o.onLog({type:"Error",message:"Fail to load: "+l.rootUrl+"path.bin"}),a("Fail to load: "+l.rootUrl+"path.bin",null)}})}],function(a,m){if(!a){var n=m;if(n[0]&&n[1]){var p=n[0];l.version={},l.version.json=p.json_version,l.version.geometry=p.geometry_version,l.version.path=p.path_version,l.version.atlas=p.atlas_version,l.version.image=p.image_version,1===l.version.image?l.imageSize.set(p.image_size[0],p.image_size[1]):l.imageSize.set(p.cameras[0].image_size[0],p.cameras[0].image_size[1]),l.thumbSize.set(p.thumbnail_size[0],p.thumbnail_size[1]);var q=1===p.is_closed,r=p.cameras.length;o.onLog({type:"Info",message:r+" cameras found"}),l.cameras=new Array(r);for(var s=0;r>s;++s)l.cameras[s]=new PS.Packet.Camera(p.cameras[s],s,o.debugBlendingEnabled,o.renderer.blendingMode===PS.Packet.BlendingMode.Feathering);l.cameras.sort(function(a,b){return a.qIndex-b.qIndex}),l.nbAtlases=p.num_atlases,l.geometryRanges=p.geometry_ranges,l.medianFov=p.median_fov,l.medianAspectRatio=f(l),l.topology=p.topology,l.dominantColors=p.dominant_colors||[[0,0,0]],l.nbPointCloudFiles=p.num_point_files||0,l.nbLevels=p.pyramid_levels,l.medianCamera={fovy:l.medianFov,fovx:2*Math.atan(l.medianAspectRatio*Math.tan(l.medianFov*Math.PI/360))*180/Math.PI,aspectRatio:l.medianAspectRatio},c(l,q),d(l),e(l);var t=PS.Packet.Parsers.parsePathFile(n[1]);l.path=new PS.Packet.Path(t,l.cameras,q,l.topology,l.averageQIndexDistBetweenCameras,l.medianFov,l.draggingDirection,{extendPathEnabled:o.extendPathEnabled,smoothFovEnabled:o.smoothFovEnabled,smoothSpeedEnabled:o.smoothSpeedEnabled,onEndpointProgress:o.onEndpointProgress,onEndpointReached:o.onEndpointReached}),g(l),h(l),i(l,p),o.onJsonParsed(p,l);for(var u=new Array(l.nbAtlases),s=0;s<l.nbAtlases;++s)u[s]=function(){var a=s;return function(b){var c=l.rootUrl+(2===l.version.json?"atlas/":"")+"atlas_"+a+".jpg";new PS.Utils.ImageDownloader(c,b,o.corsEnabled)}}();new PS.Utils.Async.parallel(u,function(a,c){if(a)console.log(a);else{l.atlases=new Array(l.nbAtlases);for(var d=0;d<l.nbAtlases;++d){var e=new THREE.Texture(c[d]);e.needsUpdate=!0,e.flipY=!0,e.minFilter=THREE.NearestFilter,e.magFilter=THREE.NearestFilter;var f=e.image;l.nbAtlasesLoaded++,PS.Packet.WebGLMU.addTexture(f.width*f.height*3),l.atlases[d]=e}var g=0;l.lod=j(l);var h=l.renderingImageSize.x*l.renderingImageSize.y*3;l.nbSurroundingImage=Math.max(3,Math.round(1024*o.gpuHDMemoryBudget*1024/h)),o.onLog({type:"Info",message:"Sliding window of "+l.nbSurroundingImage+" images -> "+Math.round(h*l.nbSurroundingImage/1048576)+"mo"});var i=1,m=0;l.thumbnails=new Array(r);for(var d=0;r>d;++d)i+l.thumbSize.x+1>=2048&&(i=1,m=0,g++),l.thumbnails[l.reverseCamIndex[d]]=new PS.Packet.Thumbnail(m,g,l.atlases[g].image.width),m++,i+=l.thumbSize.x+1;k(l),l.createGlobalViewGeometries(),l.isRenderable=!0,b(l)}})}}})}},PS.Packet.DatasetLoaderWorker=function(a){var b={onPointCloudLoaded:function(){},onGeometryCreated:function(){},onGeometryFileLoaded:function(){},onLog:function(){},pathToWorker:"",tracksEnabled:!1};PS.extend(b,a);var c,d=-1!==navigator.userAgent.indexOf("Trident");this.destroy=function(){c&&(c.terminate(),c=null)},this.postMessage=function(){c&&c.postMessage.apply(c,arguments)};try{if(""===b.pathToWorker&&b.onLog({type:"Error",message:"you need to provide the path to the js worker for IE11"}),!PS.Packet.WorkerParser||d)c=new Worker(b.pathToWorker);else{var e=new Blob([PS.Packet.WorkerParser],{type:"application/javascript"});c=new Worker((URL||window.webkitURL).createObjectURL(e))}c.onerror=function(a){b.onLog({type:"Error",message:a.message+" "+a.filename+"("+a.lineno+")"})},c.onmessage=function(a){if("log"===a.data.type)b.onLog({type:"Error",message:a.data.msg+" (geometry_"+a.data.fileIndex+".bin)"});else if("pointCloud"===a.data.type){var c=a.data.result,d=new THREE.BufferGeometry;d.attributes={position:{itemSize:3,array:c.positions},color:{itemSize:3,array:c.colors}};var e=c.positions.length/3;PS.Packet.WebGLMU.addBuffer(3*e*4*2),b.onPointCloudLoaded(a.data.rootUrl,d,b.tracksEnabled?a.data.result.viewList:[])}else if("geometry"===a.data.type){for(var f,g,h=a.data.endCameraIndex-a.data.startCameraIndex,i=a.data.result,j=0;h>j;++j){var k=i[j].indices,l=i[j].vertices,m=i[j].colors;f=i[j].width,g=i[j].height;var n=k.length,e=l.length/3,o=new THREE.BufferGeometry;o.attributes={index:{itemSize:1,array:k},position:{itemSize:3,array:l}},b.debugBlendingEnabled&&(o.attributes.color={itemSize:3,array:m}),o.offsets=[];for(var p=0;n>0;){var q=Math.min(n,65535);o.offsets.push({start:p,count:q,index:0}),n-=q,p+=q}var r=a.data.startCameraIndex+j;o.size=2*n+3*e*4+b.debugBlendingEnabled?3*e*4:0,PS.Packet.WebGLMU.addBuffer(o.size),b.onGeometryCreated(a.data.rootUrl,r,o)}b.onGeometryFileLoaded(a.data.rootUrl)}else b.onLog({type:"Error",message:"Unknown web worker message type:"+a.data.type})}}catch(f){b.onLog({type:"Error",message:f})}},PS.Packet.GestureVelocity=function(){function a(a){var b=Date.now(),j=b-c,k=a.translationX-d,l=a.translationY-e;if(0!==j&&null!==f){j>i&&(f.x=0,f.y=0);var m={x:k/j,y:l/j};f.x=(f.x*g+m.x)/(g+1),f.y=(f.y*g+m.y)/(g+1),g++,g>h&&(g=h),c=Date.now(),d=a.translationX,e=a.translationY}}var b,c=null,d=0,e=0,f=null,g=0,h=5;this.onGestureStart=function(a){c=Date.now(),d=0,e=0,f={x:0,y:0},g=0,b=a.pointerCount};var i=100;this.onGestureChange=function(b){a(b)},this.onGestureEnd=function(c){return a(c),null===f||1!==b||c.pointersStillDown||0===g?{x:0,y:0}:{x:f.x,y:f.y}}},PS.Packet.KeyboardVelocity=function(a){function b(){this.x=0,this.y=0,this.z=0,this.isZero=function(){return 0===this.x&&0===this.y&&0===this.z}}function c(a,b){return a&&b||!a&&!b?0:a?1:-1}function d(){o.x=c(j,i),o.y=c(l,k),o.z=c(m,n)}function e(a,b){return null===a||null===b?0:b-a}function f(a,b,c){return Math.min(Math.max(a,b),c)}function g(a,b,c){var d=!1;if(0===b){if(0===a)return 0;b=0>a?1:-1,d=!0}var e=f(a+b*c,-1,1);return d&&Math.abs(e)<Math.abs(c)?0:e}var h=a,i=!1,j=!1,k=!1,l=!1,m=!1,n=!1,o=new b,p=new b,q=null;this.keyDown=function(a){o.isZero()&&p.isZero()&&(q=Date.now());var b=!1;return"37"===a.keyCode?(i=!0,b=!0):"38"===a.keyCode?(k=!0,b=!0):"39"===a.keyCode?(j=!0,b=!0):"40"===a.keyCode?(l=!0,b=!0):"107"===a.keyCode||"187"===a.keyCode?(m=!0,b=!0):("109"===a.keyCode||"189"===a.keyCode)&&(n=!0,b=!0),d(),b},this.keyUp=function(a){var b=!1;return"37"===a.keyCode?(i=!1,b=!0):"38"===a.keyCode?(k=!1,b=!0):"39"===a.keyCode?(j=!1,b=!0):"40"===a.keyCode?(l=!1,b=!0):"107"===a.keyCode||"187"===a.keyCode?(m=!1,b=!0):("109"===a.keyCode||"189"===a.keyCode)&&(n=!1,b=!0),d(),b},this.getKeydownDirection=function(){return o},this.getVelocity=function(){return p},this.update=function(){var a=Date.now(),b=e(q,a);if(0!==b){var c=h*b/1e3;p.x=g(p.x,o.x,c),p.y=g(p.y,o.y,c),p.z=g(p.z,o.z,c)}q=a},this.updateNeeded=function(){return!o.isZero()||!p.isZero()},this.anyKeysDown=function(){return!o.isZero()}},PS.Packet.MultiViewCameraController=function(a,b,c,d,e,f,g,h){function i(a){return jb.dot(a)*F}function j(a){a!==J&&(J=a,D.onInputModeChange(J,E.toString(J)),H.setSeadragonDraggingCursor(a===E.Seadragon))}function k(){if(J!==E.Packet&&J!==E.TransitionToSeadragon){J===E.TransitionToPacket?I.isHomeZoom()&&j(E.TransitionToSeadragon):J===E.Seadragon&&I.isHomeZoom()&&!R.anyKeysDown()&&j(E.TransitionToSeadragon);var a=I.openSeadragon.viewport.homeBounds,b=I.openSeadragon.viewport.pixelFromPoint(a.getTopLeft(),!0),c=I.openSeadragon.viewport.pixelFromPoint(a.getBottomRight(),!0),d=c.x-b.x,e=c.y-b.y,f=I.openSeadragon.viewport.pixelFromPoint(a.getCenter(),!0),g=H.getCanvasRect(),h=I.getViewportRect(),i=g.w/g.h,k=h.width/h.height,l=k>i?e/h.height:d/h.width,m=f.x-g.centerX+h.left,n=f.y-g.centerY+h.top;H.setContainerTransform(m,n,l)}}function l(a,b){var c=I.getOffset();return I.openSeadragon.viewport.pointFromPixel(new OpenSeadragon.Point(a-c.x,b-c.y))}function m(a){I.openSeadragon.viewport.getZoom()<a&&I.openSeadragon.viewport.zoomTo(a,I.openSeadragon.viewport.getCenter()),I.openSeadragon.viewport.visibilityRatio=.5,I.openSeadragon.viewport.applyConstraints()}function n(){m(I.openSeadragon.viewport.getHomeZoom()),I.openSeadragon.viewport.visibilityRatio=1,I.openSeadragon.viewport.applyConstraints()}function o(){var a=I.openSeadragon.viewport.getHomeZoom()/2;m(a)}function p(a){if(H.resetAnimateTimer(!0),O=!0,S=!1,eb=!1,cb.onGestureStart(a),K=1,L=0,M=0,N=a.pointerCount,!R.anyKeysDown())if(1===a.pointerCount){if(a.originalEvent&&a.originalEvent.ctrlKey&&q()&&D.onCtrlClick(a.layerX,a.layerY),(J===E.Packet||J===E.TransitionToSeadragon)&&H.renderer.overlayScene.intersect(a,H.resizeState))return void j(E.TransitionToPortal);a.pointersStillDown||(J===E.Seadragon?I.isHomeZoom()?j(E.Packet):I.openSeadragon.viewport.getZoom()===I.openSeadragon.viewport.getHomeZoom()&&j(E.TransitionToPacket):(J===E.Packet||J===E.TransitionToSeadragon)&&(H.stopSnappingToCamera(),H.resetAnimateTimer(),H.dataset.path.makePersistentVirtualPathTemporary()))}else null===a.pointerCount||a.pointerCount<2}function q(){return I&&I.openSeadragon&&P}function r(a){if(cb.onGestureChange(a),O){var b=Math.sqrt(a.translationX*a.translationX+a.translationY*a.translationY);b>Q&&(O=!1)}if(R.anyKeysDown())return K=a.scale,L=a.translationX,void(M=a.translationY);if(U=null,J===E.TransitionToSeadragon){var c=I&&I.isVisible();c||1===N?j(N>1&&q()?E.Seadragon:E.Packet):(K=a.scale,L=a.translationX,M=a.translationY)}else J===E.TransitionToPacket&&(I.isHomeZoom()?j(N>1&&q()?E.Seadragon:E.Packet):(K=a.scale,L=a.translationX,M=a.translationY));if(J===E.Seadragon){var d=a.layerX,e=a.layerY,f=a.translationX-L,g=a.translationY-M,h=a.scale/K,i=l(d,e);I.openSeadragon.viewport.panBy(I.openSeadragon.viewport.deltaPointsFromPixels(new OpenSeadragon.Point(-f,-g)),!0),I.openSeadragon.viewport.zoomBy(h,i,!0),K=a.scale,L=a.translationX,M=a.translationY}else if(J===E.Packet){H.setContainerTransform(0,0,1);var f=a.translationX-L,g=a.translationY-M,k=t(f,g)+gb;s(k)}}function s(a){H.stopSnappingToCamera(),H.setPosition(a),H.resetAnimateTimer(!0)}function t(a,b){var c=new THREE.Vector2(a/G.clientWidth,b/G.clientHeight);return i(c)*ib*D.draggingSpeedFactor}function u(a,b,c,d){var e=Math.abs(b);if(d>=e)return[c,0];var f=Math.log(a),g=Math.log(d/e)/f,h=e/f,i=h*(Math.pow(a,g)-Math.pow(a,0));e!==b&&(i=-i);var j=c+i;return[j,g]}function v(a){if(J===E.TransitionToPortal)return void j(E.Packet);var b=cb.onGestureEnd(a);if(O&&D.onTapped(),!R.anyKeysDown()&&(J!==E.Seadragon||a.pointersStillDown||n(),J===E.TransitionToSeadragon&&j(E.Packet),J===E.Packet&&1===N))if(a.pointersStillDown){var c=a.translationX-L,d=a.translationY-M,e=t(c,d)+gb;e=hb.fixRange(e);var f=H.dataset.path.getClosestCamera(e,!1);H.snapToCamera(f,{duration:a.pointersStillDown?100:300}),q()&&j(E.TransitionToSeadragon)}else{db=t(b.x,b.y),Y=Date.now(),$=hb.fixRange(H.getCurrentQIndex()),bb=$;var g=u(D.inertiaDampingPerMS,db,$,fb),h=g[0];Z=g[1];var i=hb.fixRange(h),f=H.dataset.path.getClosestCamera(i,!1);if(ab=f,_=f.qIndex,hb.isClosed){for(var k=hb.nbPoints,l=k/2;_-h>l;)_-=k;for(;h-_>l;)_+=k}var m=Math.abs($-_),o=H.dataset.path.getPersistentVirtualPathRadius();o>m?(H.snapToCamera(f,{duration:500}),q()&&j(E.TransitionToSeadragon)):(H.dataset.path.createPersistentVirtualPath(f,!0),eb=!0,B())}}function w(a){if(H.resetAnimateTimer(!0),q()&&I.isVisible())if(W&&a.direction<0)c.isHomeZoom()||(I.openSeadragon.viewport.goHome(),j(E.TransitionToPacket));else{var b=a.layerX,d=a.layerY,e=a.direction<0?.83333333333333:1.2,f=l(b,d);I.openSeadragon.viewport.zoomBy(e,f),n(),j(E.Seadragon)}}function x(a){var b=D.onKeyDown(a);b|=R.keyDown(a);var c=R.getKeydownDirection();return H.isPlaying()&&0!==c.z?(H.stopSnappingToCamera(),H.resetAnimateTimer(),j(E.TransitionToSeadragon),H.snapToCamera(H.dataset.path.getClosestCamera(H.getCurrentQIndex(),!0))):!S&&R.updateNeeded()&&(J===E.Seadragon&&I.isHomeZoom()&&z(c)&&j(E.Packet),J!==E.Packet&&J!==E.TransitionToSeadragon||!z(c)||(H.stopSnappingToCamera(),H.resetAnimateTimer(),j(E.Packet),V=new THREE.Vector2(0,0)),B()),b}function y(a){var b=D.onKeyUp(a);return b|=R.keyUp(a)}function z(a){return 0!==a.x||0!==a.y}function A(a){var b=a-1,c=b*b;return 1-c*c}function B(){S||(S=!0,T=Date.now(),requestAnimationFrame(C))}function C(){if(S){var a=Date.now(),b=a-T;R.update();var c=R.getVelocity(),d=R.getKeydownDirection(),e=!1;if(J===E.TransitionToSeadragon&&(z(d)?j(E.Packet):0!==d.z&&q()&&j(E.Seadragon)),J===E.Packet)if(H.setContainerTransform(0,0,1),eb){db*=Math.pow(D.inertiaDampingPerMS,b);var f,g=(a-Y)/Z;if(1>g){bb+=db*b;var h=A(g),k=1-h,m=k*$+h*_;f=k*bb+h*m,f=hb.fixRange(f),e=!0,s(f)}else j(E.TransitionToSeadragon),H.snapToCamera(ab,{duration:100}),H.dataset.path.removePersistentVirtualPath(),eb=!1}else{var p=.3,r=p*-c.x*b/1e3,t=p*-c.y*b/1e3;V.x+=r,V.y+=t;var f=i(V)*ib+gb;if(z(d))e=!0,f!==hb.fixRange(f)&&(U=null),s(f);else{f=hb.fixRange(f);var u=H.dataset.path.getClosestCamera(f,!0);if(null!==U){var v=.5;u.qIndex<f?u.qIndex>=U.qIndex&&(f=U.qIndex-v,f=hb.fixRange(f),u=H.dataset.path.getClosestCamera(f,!0)):u.qIndex>f&&u.qIndex<=U.qIndex&&(f=U.qIndex+v,f=hb.fixRange(f),u=H.dataset.path.getClosestCamera(f,!0))}j(E.TransitionToSeadragon),H.snapToCamera(u),U=u,e=!1}}else if(J===E.Seadragon)if(d.isZero())n(),c.x=0,c.y=0,c.z=0,e=!1;else{var w=G.clientWidth/2,x=G.clientHeight/2,y=l(w,x),B=1.002,F=.5,r=d.x*b*F,t=d.y*b*F,K=Math.pow(B,b*d.z);I.openSeadragon.viewport.panBy(I.openSeadragon.viewport.deltaPointsFromPixels(new OpenSeadragon.Point(r,t)),!0),I.openSeadragon.viewport.zoomBy(K,y,!1),o(),e=!0}e?(requestAnimationFrame(C),T=a):(S=!1,T=null,c.x=0,c.y=0,c.z=0)}}var D={onTapped:function(){},onLog:function(){},onKeyDown:function(){},onKeyUp:function(){},onInputModeChange:function(){},onCtrlClick:function(){},inertiaDampingPerMS:.995,draggingSpeedFactor:1};PS.extend(D,h),this.setOptions=function(a){PS.extend(D,a)},this.getOptions=function(){var a={};return PS.extend(a,D),a};var E={Seadragon:0,Packet:1,TransitionToSeadragon:2,TransitionToPacket:3,TransitionToPortal:4,toString:function(a){switch(a){case 0:return"Seadragon";case 1:return"Packet";case 4:return"TransitionToPortal";case 2:return"TransitionToSeadragon";default:return"TransitionToPacket"}}};this.resetCurrentPosition=function(a){gb=a},this.reset=function(a){gb=a.startTransitionPercent,hb=a.path,ib=a.path.nbPoints-1,jb=a.draggingDirection,F=g};var F=g,G=a,H=b,I=c,J=E.Packet;I&&I.setAnimationCallback(k);var K,L,M,N,O,P=!0,Q=2,R=new PS.Packet.KeyboardVelocity(1),S=!1,T=null,U=null,V=new THREE.Vector2(0,0),W=!0,X=new PS.Packet.MultiTouchGestureHandler(G,{discreteZoom:w,gestureStart:p,gestureChange:r,gestureEnd:v,keyDown:x,keyUp:y,onLog:D.onLog});this.focusKeyboardElement=function(){X.focusKeyboardElement()},this.blurKeyboardElement=function(){X.blurKeyboardElement()},this.destroy=function(){X.destroy(),X=null};var Y,Z,$,_,ab,bb,cb=new PS.Packet.GestureVelocity,db=0,eb=!1,fb=5e-4,gb=e,hb=d,ib=d.nbPoints-1,jb=f;this.forceInputMode=function(a){j(a)},this.setSeadragonEnabled=function(a){P=a},this.setCameraMode=function(a){a===PS.Packet.CameraMode.Global?X.disable():(X.enable(),H.setCameraMode(a),s(gb))},this.setCurrentArcPosition=function(a){gb=a},this.zoomTo=function(a){j(E.Seadragon),I.openSeadragon.viewport.zoomSpring.animationTime=8,I.openSeadragon.viewport.fitBounds(a),setTimeout(function(){I.openSeadragon.viewport.zoomSpring.animationTime=1.5},2042)}},PS.Packet.OffscreenScene=function(a){this.scene=a,this.currentImageIndex=-1,this.currentMesh=void 0,this.setCurrentImage=function(a,b){this.clear(),this.currentImageIndex=a,this.scene.add(b),this.currentMesh=b},this.clear=function(){this.currentMesh&&(this.scene.remove(this.currentMesh),this.currentMesh=void 0,this.currentImageIndex=-1)}},PS.Packet.BlendingMode={Opacity:0,DitheringLuminance:1,DitheringColor:2,Feathering:3},PS.Packet.BlendingFunction={Linear:0,Step:1,Sigmoid:2},PS.Packet.Renderer=function(a,b,c,d,e,f){function g(a,b){for(var c=[],d=a,e=b,f=-1;;){if(d=Math.ceil((d+1)/2),e=Math.ceil((e+1)/2),f++,3>d||3>e)break;c.push(new THREE.Vector2(d,e))}z=f+1,y=c}function h(){for(var a=y.length,b=new Array(a),c=0;a>c;++c){var d=y[c];b[c]=new THREE.WebGLRenderTarget(d.x,d.y,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),PS.Packet.WebGLMU.addTexture(d.x*d.y*4)}return b}function i(a,b){r.dispose(),s.dispose(),PS.Packet.WebGLMU.addTexture(-a*b*4),PS.Packet.WebGLMU.addTexture(-a*b*4),t.dispose(),PS.Packet.WebGLMU.addTexture(-a*b*4);for(var c=0;c<A.length;++c){var d=A[c];PS.Packet.WebGLMU.addTexture(-d.width*d.height*4),d.dispose()}for(var c=0;c<B.length;++c){var d=B[c];PS.Packet.WebGLMU.addTexture(-d.width*d.height*4),d.dispose()}}function j(a,b){if(w=new THREE.Scene,R.push(new PS.Packet.OffscreenScene(new THREE.Scene)),R.push(new PS.Packet.OffscreenScene(new THREE.Scene)),u=new THREE.OrthographicCamera(N/2,N/-2,O/-2,O/2,-1e4,1e4),u.position.z=100,w.add(u),v=new THREE.PerspectiveCamera(n.fov,N/O,n.near,n.far),v.fov=n.fov,R[0].scene.add(v),r=new THREE.WebGLRenderTarget(N,O,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),s=new THREE.WebGLRenderTarget(N,O,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),PS.Packet.WebGLMU.addTexture(N*O*4),PS.Packet.WebGLMU.addTexture(N*O*4),n.blendingMode===PS.Packet.BlendingMode.DitheringLuminance||n.blendingMode===PS.Packet.BlendingMode.DitheringColor){for(var c=128,d=c*c*3,e=new Uint8Array(d),f=0,i=d/3,j=0;i>j;++j)e[f++]=Math.floor(255*Math.random()),e[f++]=Math.floor(255*Math.random()),e[f++]=Math.floor(255*Math.random());I=new THREE.DataTexture(e,c,c,THREE.RGBFormat,THREE.UnsignedByteType,new THREE.UVMapping,THREE.RepeatWrapping,THREE.RepeatWrapping),I.needsUpdate=!0,PS.Packet.WebGLMU.addTexture(d)}t=new THREE.WebGLRenderTarget(N,O,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),PS.Packet.WebGLMU.addTexture(N*O*4),g(N,O),A=h(),B=h(),D=new THREE.ShaderMaterial({uniforms:{uReduceTex:{type:"t",value:null},uReduceDx:{type:"f",value:0},uReduceDy:{type:"f",value:0}},vertexShader:PS.Packet.Shaders.commonMaterial.vertexShader,fragmentShader:PS.Packet.Shaders.downsamplingMaterial.fragmentShader,depthWrite:!1}),E=new THREE.ShaderMaterial({uniforms:{uExpandTex0:{type:"t",value:null},uExpandTex1:{type:"t",value:null}},vertexShader:PS.Packet.Shaders.commonMaterial.vertexShader,fragmentShader:PS.Packet.Shaders.upsamplingMaterial.fragmentShader,depthWrite:!1});var k=PS.Packet.Shaders.Factory.generateBlendingShaders({blendingMode:n.blendingMode}),l=THREE.UniformsUtils.clone(k.uniforms);l.tDiffuse1.value=r,l.tDiffuse2.value=s,l.blendFactor.value=.5,(n.blendingMode===PS.Packet.BlendingMode.DitheringLuminance||n.blendingMode===PS.Packet.BlendingMode.DitheringColor)&&(l.tRandom.value=I,l.texSize.value=new THREE.Vector2(N,O)),F=new THREE.ShaderMaterial({uniforms:l,vertexShader:k.vertexShader,fragmentShader:k.fragmentShader,depthWrite:!1}),x=F.uniforms.blendFactor,G=new THREE.ShaderMaterial({uniforms:{tDiffuse:{type:"t",value:r}},vertexShader:PS.Packet.Shaders.commonMaterial.vertexShader,fragmentShader:PS.Packet.Shaders.commonMaterial.fragmentShader,depthWrite:!1});var m=new THREE.PlaneGeometry(N,O),y=new THREE.Mesh(m,F);y.position.z=-100,y.rotation.z=Math.PI,w.add(y),C=y,q=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:n.screenshotEnabled,devicePixelRatio:1}),q.setClearColor(0,0),q.setSize(N,O),q.autoClear=!1,p=a,p.appendChild(q.domElement),o=new THREE.TrackballControls(v,b),o.setEnabled(n.startCameraMode===PS.Packet.CameraMode.Global),o.onCameraMove=function(){K.resetAnimateTimer(),M=!0},L.setCameraMode(n.startCameraMode),o.rotateSpeed=1,o.zoomSpeed=1.2,o.panSpeed=.8,o.noZoom=!1,o.noPan=!1,o.staticMoving=!1,o.dynamicDampingFactor=.2,o.keys=[65,83,68]}function k(a,b){C.material=D;for(var c=0;z-1>c;c++){var d=y[c-1],e=0===c?N:d.x,f=0===c?O:d.y,g=D.uniforms;g.uReduceTex.value=0===c?a:A[c-1],g.uReduceDx.value=1/e,g.uReduceDy.value=1/f,q.render(w,u,A[c],!0)}C.material=E;for(var c=z-2;c>=0;c--){var g=E.uniforms;g.uExpandTex1.value=0===c?a:A[c-1],g.uExpandTex0.value=c===z-2?A[c]:B[c],q.render(w,u,0===c?b:B[c-1],!0)}}function l(){H===PS.Packet.CameraMode.Global?(q.clear(),q.render(R[S].scene,v)):(q.clear(),q.render(R[0].scene,v,r,!0),q.render(R[1].scene,v,s,!0),n.holeFillingEnabled?(C.material=F,q.render(w,u,t,!0),k(t,r),C.material=G,n.croppingEnabled&&(q.enableScissorTest(!0),q.setScissor(P.x,P.y,P.w,P.h)),q.render(w,u),n.croppingEnabled&&q.enableScissorTest(!1)):(C.material=F,n.croppingEnabled&&(q.enableScissorTest(!0),q.setScissor(P.x,P.y,P.w,P.h)),q.render(w,u),n.croppingEnabled&&q.enableScissorTest(!1))),L.overlayScene.isEmpty()||q.render(L.overlayScene,v)}function m(){o.isEnabled()&&o.update(),J=requestAnimationFrame(m),M&&l(),n.lazyRenderingEnabled&&(M=!1),n.onUpdate()}var n={onUpdate:function(){},onCamerasChanged:function(){},onLog:function(){},holeFillingEnabled:!0,croppingEnabled:!0,lazyRenderingEnabled:!0,screenshotEnabled:!1,startCameraMode:0,blendingFunction:PS.Packet.BlendingFunction.Sigmoid,blendingMode:PS.Packet.BlendingMode.Opacity,blendingSigma:.5,fov:50,near:.03,far:5e3};PS.extend(n,f),this.setOptions=function(a){var b=n.lazyRenderingEnabled;PS.extend(n,a),b&&!n.lazyRenderingEnabled&&(M=!0)},this.getOptions=function(){var a={};return PS.extend(a,n),a},this.reset=function(a){n.near=a.near,n.far=a.far,n.fov=a.medianFov,v=new THREE.PerspectiveCamera(n.fov,N/O,n.near,n.far),R[0].clear(),R[1].clear(),v.position.copy(a.startingCamera.pose.position),v.quaternion.copy(a.startingCamera.pose.orientation),v.fov=n.fov};var o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K=a,L=this,M=!0,N=c,O=d,P={x:0,y:0,w:N,h:O},Q=new THREE.Vector2(c,d),R=[],S=0,T=!1;this.addInScene=function(a){R[0].scene.add(a)},this.getRenderer=function(){return q},this.getScenes=function(){return R},this.overlayScene=new function(){var a=new THREE.Scene,b=[],c=new THREE.Projector,d=new THREE.Raycaster,e=a.add;return a.add=function(c){b.push(c),e.call(a,c),a.updateMatrixWorld()},a.clear=function(){for(var c=0;c<b.length;++c)a.remove(b[c]),b[c].geometry.dispose();b=[]},a.isEmpty=function(){return 0===b.length},a.intersect=function(b,e){if(a.isEmpty())return!1;var f=e,g=(f.containerWidth-f.scale*f.width)/2,h=(f.containerHeight-f.scale*f.height)/2,i=(b.layerX-g)/f.scale,j=(b.layerY-h)/f.scale;if(i>0&&N>i&&j>0&&O>j){var k=new THREE.Vector3(i/N*2-1,2*-(j/O)+1,1);c.unprojectVector(k,v),d.set(v.position,k.sub(v.position).normalize());var l=d.intersectObjects(a.children);if(l.length>0){var m=l[0].object;if(m.material&&m.material.visible&&m.visible&&m.onclick)return m.onclick(),!0}}return!1},a},this.setCameraMode=function(a){H!==a&&(a===PS.Packet.CameraMode.Global?(q.setClearColor(16777215,1),o.setEnabled(!0),o.resetFromPose(v.position,v.quaternion,v.distanceToObject)):(q.setClearColor(0,0),o.setEnabled(!1)),o.setEnabled(a===PS.Packet.CameraMode.Global),H=a)},this.getCroppingInformations=function(){return P},this.setCroppingInformations=function(a){P=a,M=!0},this.setCroppingEnabled=function(a){n.croppingEnabled!==a&&(n.croppingEnabled=a,M=!0)},this.setHoleFillingEnabled=function(a){n.holeFillingEnabled!==a&&(n.holeFillingEnabled=a,M=!0)},this.forceUpdateIfVisible=function(a,b){R[0].currentImageIndex===b?(R[0].setCurrentImage(b,a.mesh),M=!0):R[1].currentImageIndex===b&&(R[1].setCurrentImage(b,a.mesh),M=!0)},this.forceUpdateScenes=function(a){var b=R[0].currentImageIndex,c=R[1].currentImageIndex;R[0].setCurrentImage(b,a[b].mesh),R[1].setCurrentImage(c,a[c].mesh),M=!0},this.forceRenderFrame=function(){M=!0};var U=!1;this.updateScenes=function(a,b,c,d,e){var f=R[0].currentImageIndex,g=R[1].currentImageIndex,h=a[b],i=a[c];-1!==f&&-1!==g?f===b&&g===c||g===b&&f===c||(f===b&&g!==c?(R[1].setCurrentImage(c,i.mesh),n.onCamerasChanged(b,c),U=!1,i.initializeScaleToCamera(h),a[g].resetScale()):f===c&&g!==b?(R[1].setCurrentImage(b,h.mesh),n.onCamerasChanged(b,c),U=!0,h.initializeScaleToCamera(i),a[g].resetScale()):g===b&&f!==c?(R[0].setCurrentImage(c,i.mesh),n.onCamerasChanged(b,c),U=!0,i.initializeScaleToCamera(h),a[f].resetScale()):g===c&&f!==b?(R[0].setCurrentImage(b,h.mesh),n.onCamerasChanged(b,c),U=!1,h.initializeScaleToCamera(i),a[f].resetScale()):f!==b&&g!==c&&(R[0].setCurrentImage(b,h.mesh),R[1].setCurrentImage(c,i.mesh),n.onCamerasChanged(b,c),U=!1,.5>d?(h.initializeScaleToCamera(a[f]),i.initializeScaleToCamera(h)):(i.initializeScaleToCamera(a[f]),h.initializeScaleToCamera(i)),a[f].resetScale(),a[g].resetScale())):(R[0].setCurrentImage(b,h.mesh),R[1].setCurrentImage(c,i.mesh),n.onCamerasChanged(b,c),U=!1,.5>d?i.initializeScaleToCamera(h):h.initializeScaleToCamera(i)),e!==v.fov&&H!==PS.Packet.CameraMode.Global&&(v.projectionMatrix.makePerspective(e,N/O,n.near,n.far),v.fov=e);var j=d;d=Math.max(0,Math.min(1,d)),d===j||T||(T=!0,n.onLog({type:"Error",message:"Out of range blending ("+j+")",context:{minIndex:b,maxIndex:c,percent:d}})),h.setPercentToNext(d),i.setPercentToPrevious(1-d);var k=U?d:1-d;if(n.blendingFunction===PS.Packet.BlendingFunction.Step)k=Math.round(k);else if(n.blendingFunction===PS.Packet.BlendingFunction.Sigmoid){var l=n.blendingSigma,m=k,o=Math.exp(-m*m/(l*l)),p=Math.exp(-(1-m)*(1-m)/(l*l));k=p/(o+p)}k=Math.max(0,Math.min(1,k)),x.value=k,M=!0},this.getCamera=function(){return v},this.startRenderLoop=function(){m()},this.stopRenderLoop=function(){J&&(cancelAnimationFrame(J),J=null)},this.isRenderLoopRunning=function(){return J?!0:!1},this.getSize=function(){return Q},this.destroy=function(a,b){L.stopRenderLoop(),i(a,b),R[0].clear(),R[1].clear(),w.remove(C),C=null,D.dispose(),E.dispose(),F.dispose(),G.dispose(),I&&I.dispose(),o.destroy()},this.resize=function(a,b){var c=N,d=O;Q.set(a,b),N=a,O=b,P={x:0,y:0,w:Math.floor(N),h:Math.floor(O)},u=new THREE.OrthographicCamera(N/2,N/-2,O/-2,O/2,-1e4,1e4),u.position.z=100,v.aspect=N/O,v.updateProjectionMatrix(),i(c,d),r=new THREE.WebGLRenderTarget(N,O,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),s=new THREE.WebGLRenderTarget(N,O,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),PS.Packet.WebGLMU.addTexture(N*O*4),PS.Packet.WebGLMU.addTexture(N*O*4),t=new THREE.WebGLRenderTarget(N,O,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),PS.Packet.WebGLMU.addTexture(N*O*4),g(N,O),A=h(),B=h(),w.remove(C);var e=new THREE.PlaneGeometry(N,O),f=new THREE.Mesh(e,F);f.position.z=-100,f.rotation.z=Math.PI,w.add(f),C=f,q.setSize(N,O),F.uniforms.tDiffuse1.value=r,F.uniforms.tDiffuse2.value=s,G.uniforms.tDiffuse.value=r,(n.blendingMode===PS.Packet.BlendingMode.DitheringLuminance||n.blendingMode===PS.Packet.BlendingMode.DitheringColor)&&F.uniforms.texSize.value.set(N,O),o.handleResize(),L.forceRenderFrame()},this.simulateMouseWheel=function(a){o.simulateMouseWheel(a)},j(b,e)},PS.Packet.CameraMode={Smooth:0,Linear:1,Global:2},PS.Packet.Thumbnail=function(a,b,c){this.thumbnailIndex=a,this.atlasIndex=b,this.atlasWidth=c,this.getUniform=function(a){var b=1+this.thumbnailIndex*(a.x+2),c=1,d=a.x,e=a.y;return new THREE.Vector4(b/(this.atlasWidth-1),c/(a.y+1),d/(this.atlasWidth-1),e/(a.y+1))}},PS.Packet.Viewer=function(a,b,c){function d(a,b,c,d){var e="translate3d("+b.toFixed(8)+"px, "+c.toFixed(8)+"px, 0) scale("+d.toFixed(8)+")";a.style.transform=e,a.style.msTransform=e,a.style.webkitTransform=e,a.style.mozTransform=e}function e(){if(v++,!w.dataset.path.isClosed){var a=w.dataset.path.fixRange(y);u=a<w.dataset.averageQIndexDistBetweenCameras?a/w.dataset.averageQIndexDistBetweenCameras*.5+.5:a>w.dataset.path.nbPoints-1-w.dataset.averageQIndexDistBetweenCameras?(w.dataset.path.nbPoints-1-a)/w.dataset.averageQIndexDistBetweenCameras*.5+.5:1}y+=s.animateSpeed*s.animateDirection*u*w.dataset.path.getLocalSpeed(y),!w.dataset.path.isClosed&&y>w.dataset.path.nbPoints-1?(y=w.dataset.path.nbPoints-1,s.animateDirection*=-1,w.dataset.path.updateDraggingDirection(1,2*s.animateDirection)):!w.dataset.path.isClosed&&0>y&&(y=0,s.animateDirection*=-1,w.dataset.path.updateDraggingDirection(1,2*s.animateDirection)),w.setPosition(y)}function f(a){D||(D=!0,s.animateDirection=a?a:w.dataset.path.getDraggingDirection(),v=0,s.onStartAnimating())}function g(a){D&&(D=!1,s.onStopAnimating(v),w.snapToCamera(w.dataset.path.getClosestCamera(y,!0),{onComplete:a||function(){}})),E=new Date}function h(a){if(H!==PS.Packet.CameraMode.Global){G.copy(a.pose);var b=w.renderer.getCamera();b.position=G.position,b.quaternion=G.orientation}w.renderer.updateScenes(w.dataset.cameras,a.prevCamIndex,a.nextCamIndex,a.percent,a.fov)}function i(){if(z&&A){var a=1-s.colorBalanceSmoothingWeight;if(z.smoothedScale.lerp(z.unsmoothedScale,a),A.smoothedScale.lerp(A.unsmoothedScale,a),z.colorScale.value=z.smoothedScale.clone(),A.colorScale.value=A.smoothedScale.clone(),s.renderer.lazyRenderingEnabled){var b=.001,c=z.smoothedScale.clone().sub(z.unsmoothedScale).lengthSq(),d=A.smoothedScale.clone().sub(A.unsmoothedScale).lengthSq();(c>b||d>b)&&w.renderer.forceRenderFrame()}}}function j(a,b){var c=a.parentNode.getElementsByClassName("PSInputLayer")[0];c.classList.remove("PSInputLayerVertical"),c.classList.remove("PSInputLayerHorizontal"),c.classList.add("PSInputLayer"+b)}function k(a,b){var c=PS.extend({},s);c.onJsonParsed=function(a,b){w.dataset||(w.dataset=b),s.onJsonParsed(w)},c.onViewerReady=function(b){w.dataset=b,s.onDatasetLoaded(w.dataset),j(a,b.draggingDirectionCSSClass),y=b.startingCamera.qIndex,G.copy(b.startingCamera.pose),s.animateSpeed=b.animateSpeed,w.renderer?(r(b),s.onCanvasUpdated(w,B)):(q(a,b),s.onCanvasCreated(w,B),s.onCanvasUpdated(w,B)),w.renderer.setCroppingInformations(w.getCropping(b.medianCamera),b.medianFov),s.startCameraMode===PS.Packet.CameraMode.Global&&(w.setCameraMode(PS.Packet.CameraMode.Smooth),w.setPosition(y)),w.setCameraMode(s.startCameraMode),w.cameraController.resetCurrentPosition(y),w.setPosition(y),E=new Date,F=new Date(+E.getTime()),s.autoStartEnabled||s.onStopAnimating(-1),w.snapToCamera(b.startingCamera,{duration:1,onComplete:function(){w.renderer.isRenderLoopRunning()||w.renderer.startRenderLoop(),s.onDatasetRendered(w.dataset)}})},c.onAllGeometryLoaded=function(){s.onAllGeometryLoaded();var a=E.getTime()!==F.getTime();if(s.autoStartEnabled&&!a)f(s.animateDirection);else if(!s.autoStartEnabled&&!a){var b=w.dataset.startingCamera,c=w.state.currentPose;c.position.equals(b.pose.position)&&c.orientation.equals(b.pose.orientation)&&s.startDownloadingTiles(b,!0)}},c.onPointCloudLoaded=function(a){a.visible=H===PS.Packet.ViewMode.Global,w.renderer.addInScene(a)},c.getViewerState=function(){return w.state},w.datasetLoader=new PS.Packet.DatasetLoader(w,c),w.load(b)}function l(){var a=Date.now();for(!D&&a-E>s.idleDelay&&(s.onIdle(),E=new Date),D&&e(a-K),K=a,s.colorBalanceEnabled&&i();J.length>0;){var b=J.shift();if(w.renderer.getRenderer().uploadTexture(b),Date.now()-a>7)return}}function m(a,b){var c=a/b,d=0,e=0;c>w.dataset.medianAspectRatio?(d=b*w.dataset.medianAspectRatio,e=b):(d=a,e=a/w.dataset.medianAspectRatio);var f=1;if(d*e>s.maxRenderSize){var g=d,h=d/e;d=Math.sqrt(s.maxRenderSize*h),e=d/h,f=g/d}return{width:d,height:e,scale:f}}function n(a,b,c){x.containerWidth=a,x.containerHeight=b;
var d=m(a,b);c===PS.Packet.ResizeMode.Slow?(x.scale=d.scale,x.width=d.width,x.height=d.height,x.translateX=(a-d.width)/2,x.translateY=(b-d.height)/2):(x.scale=d.width*d.scale/x.width,x.translateX=(a-x.width)/2,x.translateY=(b-x.height)/2),s.onResize(x,c)}function o(){d(B,x.translateX,x.translateY,x.scale);var a=w.renderer.getSize();(a.x!==x.width||a.y!==x.height)&&w.renderer.resize(x.width,x.height)}function p(a){a.preventDefault(),s.onWebGLContextLost()}function q(a,b){var c=a.parentNode.getElementsByClassName("PSInputLayer")[0],d=PS.extend({},s.renderer);d.startCameraMode=s.startCameraMode,d.fov=w.dataset.medianFov,d.near=d.near||b.near,d.far=d.far||b.far,d.onLog=s.onLog,d.onUpdate=function(){l(),s.onAnimFrameRequested(w)},d.onCamerasChanged=function(a,b){z=w.dataset.cameras[a],A=w.dataset.cameras[b],w.datasetLoader.updateSlidingWindow(w.state),s.onCamerasChanged(a,b)},n(s.width,s.height,PS.Packet.ResizeMode.Slow),w.renderer=new PS.Packet.Renderer(w,a,x.width,x.height,c,d),B=w.renderer.getRenderer().domElement,B.addEventListener("webglcontextlost",p,!1),o(),w.onGPUMemoryChange(),w.dataset.cameras.forEach(function(a){a.viewer=w});var e=w.renderer.getRenderer().domElement;e.style.position="relative",w.renderer.addInScene(w.dataset.frustums),w.renderer.addInScene(w.dataset.smoothCameraPath),w.renderer.addInScene(w.dataset.linearCameraPath),w.renderer.addInScene(w.dataset.origin);for(var f=0;f<w.dataset.camerasAxes.length;++f){var g=w.dataset.camerasAxes[f];w.renderer.addInScene(g)}w.cameraController=new PS.Packet.MultiViewCameraController(c,w,w.seadragonViewer,w.dataset.path,y,w.dataset.draggingDirection,s.animateSpeed,{onTapped:s.onTapped,onLog:s.onLog,onKeyDown:s.onKeyDown,onKeyUp:s.onKeyUp,onCtrlClick:s.onCtrlClick,onInputModeChange:s.onInputModeChange})}function r(){n(x.containerWidth,x.containerHeight,PS.Packet.ResizeMode.Slow),w.renderer.reset(w.dataset),w.dataset.cameras.forEach(function(a){a.viewer=w}),w.renderer.addInScene(w.dataset.frustums),w.renderer.addInScene(w.dataset.smoothCameraPath),w.renderer.addInScene(w.dataset.linearCameraPath),w.renderer.addInScene(w.dataset.origin);for(var a=0;a<w.dataset.camerasAxes.length;++a){var b=w.dataset.camerasAxes[a];w.renderer.addInScene(b)}w.cameraController.reset(w.dataset),o()}var s={onJsonParsed:function(){},onCanvasCreated:function(){},onCanvasUpdated:function(){},onCameraModeChanged:function(){},onCamerasChanged:function(){},onCameraChanged:function(){},onPositionChanged:function(){},onBeginDownloading:function(){},onFinishDownloading:function(){},onGPUMemoryChanged:function(){},onStartAnimating:function(){},onStopAnimating:function(){},onAllGeometryLoaded:function(){},onAllGeometryDownloaded:function(){},onAllHDLoaded:function(){},onLog:function(){},onTapped:function(){},onWebGLContextLost:function(){},onPoseChanged:function(){},onProgressPercentChange:function(){},onKeyDown:function(){},onKeyUp:function(){},onIdle:function(){},onEndpointProgress:function(){},onEndpointReached:function(){},onCtrlClick:function(){},onAnimFrameRequested:function(){},onContainerTransformed:function(){},onResize:function(){},onDatasetLoaded:function(){},onDatasetRendered:function(){},startDownloadingTiles:function(){},onInputModeChange:function(){},debugBlendingEnabled:!1,autoStartEnabled:!0,pointCloudEnabled:!1,virtualPathEnabled:!0,extendPathEnabled:!0,geometryEnabled:!0,smoothFovEnabled:!1,smoothSpeedEnabled:!1,colorBalanceEnabled:!0,pathFixingEnabled:!0,progressBarEnabled:!1,renderer:{holeFillingEnabled:!0,croppingEnabled:!0,screenshotEnabled:!1,lazyRenderingEnabled:!0,blendingFunction:PS.Packet.BlendingFunction.Linear,blendingMode:PS.Packet.BlendingMode.Opacity,blendingSigma:.5},downloadConcurrency:8,startTransitionPercent:-1,startCameraIndex:-1,startCameraMode:PS.Packet.CameraMode.Smooth,pathToWorker:"",width:1280,height:720,gpuHDMemoryBudget:50,maxHDPixels:48e4,maxRenderSize:921600,singleLookAtThreshold:6,cameraRollThreshold:15,wallWalkRollThreshold:10,wallWalkPitchThreshold:4,sharedOrientationThreshold:8,colorBalanceSmoothingWeight:.8,idleDelay:Number.POSITIVE_INFINITY,animateSpeed:1,animateDirection:1,timeForFullRotation:15,wallWalkFramePerSecond:2,maxSpinFramePerSecond:3,maxPanoFramePerSecond:1.3};PS.extend(s,c);var t=a,u=1,v=0,w=this,x={containerWidth:0,containerHeight:0,width:0,height:0,scale:0,translateX:0,translateY:0};this.__defineGetter__("resizeState",function(){return PS.extend({},x)}),this.setContainerTransform=function(a,b,c){s.onContainerTransformed(a,b,c),d(t,a,b,c)},this.setOptions=function(a){var b=s.geometryEnabled,c=s.colorBalanceEnabled,d=a||{};if(PS.extend(s,d),b!==s.geometryEnabled)for(var e=!s.geometryEnabled,f=0;f<w.dataset.cameras.length;++f){var g=w.dataset.cameras[f];g.isSelected?g.useHD(e,!0):g.useAtlas(e,!0)}if(c!==s.colorBalanceEnabled)for(var f=0;f<w.dataset.cameras.length;++f)w.dataset.cameras[f].resetScale()},this.getOptions=function(){var a={};return PS.extend(a,s),a},this.getSeadragonOptions=function(){return{renderingSize:w.dataset.renderingImageSize.clone()}},this.isCorsEnabled=function(){return s.corsEnabled},this.unload=function(){w.stopPlaying(),w.stopSnappingToCamera(),w.renderer.stopRenderLoop(),w.dataset.unload(w.renderer),w.dataset=null,w.renderer.overlayScene.clear()},this.destroy=function(){w.unload(),w.datasetLoader&&(w.datasetLoader.destroy(),w.datasetLoader=null),w.renderer&&(w.renderer.destroy(),w.renderer=null),w.cameraController&&(w.cameraController.destroy(),w.cameraController=null),B&&B.removeEventListener("webglcontextlost",p)},this.onBeginDownloading=s.onBeginDownloading,this.onFinishDownloading=s.onFinishDownloading,this.onGPUMemoryChange=s.onGPUMemoryChanged;var y,z,A,B,C,D=!1,E=new Date,F=new Date(E),G=new PS.Packet.Pose(new THREE.Vector3,new THREE.Quaternion),H=-1,I=!1;this.getCropping=function(a,b){var c=w.renderer.getCamera(),d=x.width,e=x.height,f=b?b:c.fov,g=2*Math.atan(c.aspect*Math.tan(f*Math.PI/360))*180/Math.PI,h=a.aspectRatio<c.aspect?e/(2*Math.tan(f*Math.PI/360)):d/(2*Math.tan(g*Math.PI/360)),i=2*h*Math.tan(a.fovx*Math.PI/360),j=2*h*Math.tan(a.fovy*Math.PI/360);return{x:x.scale*Math.round((d-i)/2),y:x.scale*Math.round((e-j)/2),w:x.scale*Math.round(i),h:x.scale*Math.round(j)}},this.getWebGLViewer=function(){return s.onLog({type:"Warning",message:"deprecated, you can use the .renderer property now instead"}),w.renderer},this.getPath=function(){return s.onLog({type:"Warning",message:"deprecated, you can use the .path property now instead"}),w.dataset.path},this.setDebugBlending=function(a){if(s.debugBlendingEnabled){for(var b=0;b<w.dataset.cameras.length;++b)w.dataset.cameras[b].lowMaterial.uniforms.debugBlending.value=a,w.dataset.cameras[b].highMaterial.uniforms.debugBlending.value=a;w.renderer.forceRenderFrame()}},this.setCameraMode=function(a){if(H!==a){if(H=a,w.renderer.setCameraMode(a),w.cameraController.setCameraMode(a),a===PS.Packet.CameraMode.Global){w.dataset.frustums.visible=!0;for(var b=0;b<w.dataset.camerasAxes.length;++b)w.dataset.camerasAxes[b].visible=!0;for(var b=0;b<w.dataset.particleSystems.length;++b)w.dataset.particleSystems[b].visible=!0;w.dataset.smoothCameraPath.visible=!0,w.dataset.linearCameraPath.visible=!0,w.dataset.origin.visible=!0,w.setSeadragonDraggingCursor(!0)}else{w.dataset.frustums.visible=!1;for(var b=0;b<w.dataset.camerasAxes.length;++b)w.dataset.camerasAxes[b].visible=!1;for(var b=0;b<w.dataset.particleSystems.length;++b)w.dataset.particleSystems[b].visible=!1;w.dataset.smoothCameraPath.visible=!1,w.dataset.linearCameraPath.visible=!1,w.dataset.origin.visible=!1,w.setSeadragonDraggingCursor(!1)}s.onCameraModeChanged(a)}},this.__defineGetter__("path",function(){return console.log("deprecated, please use: dataset.path instead"),w.dataset.path}),this.setDampingFactor=function(){s.onLog({type:"Warning",message:"inertia has been removed due to a change so this as no effect"})},this.setPointSize=function(a){w.dataset.pointCloudMaterial.size=a,w.renderer.forceRenderFrame()},this.getClosestCamera=function(a){return s.onLog({type:"Warning",message:"deprecated, use .path.getClosestCamera(qIndex)"}),w.dataset.path.getClosestCamera(a)},this.getDominantColors=function(){return w.dataset.dominantColors},this.getStartPosition=function(){return w.dataset.startTransitionPercent},this.getCurrentPose=function(){return new PS.Packet.Pose(G.position,G.orientation)},this.getCurrentQIndex=function(){return y},this.getCurrentCameraMode=function(){return H},this.gotoCamera=function(a,b){var c={speedFactor:4,prefetchSeadragon:!0,onCameraChanged:!0,onComplete:function(){}};if(PS.extend(c,b),z===a||A===a)w.snapToCamera(a,b);else{D&&(D=!1,s.onStopAnimating(v)),w.cameraController.forceInputMode(4);var d=y,e=a.qIndex;if(w.dataset.path.isClosed){var f=w.dataset.path.nbPoints/2;Math.abs(e-d)>f&&(f>d?d+=w.dataset.path.nbPoints:e+=w.dataset.path.nbPoints)}var g=Math.abs(e-d),h=16.67*g/(s.animateSpeed*c.speedFactor);w.dataset.path.createPersistentVirtualPath(a),w.stopSnappingToCamera(),c.prefetchSeadragon&&s.startDownloadingTiles(a,!1),C=new PS.Tween.create({duration:h,start:d,end:e,onUpdate:function(a){w.setPosition(a),w.cameraController.setCurrentArcPosition(a)},onComplete:function(){w.cameraController.forceInputMode(2),w.setPosition(e),s.virtualPathEnabled&&w.dataset.path.createTemporaryVirtualPath(a),c.onCameraChanged&&s.onCameraChanged(a),c.onComplete()}}).start()}},this.snapToCamera=function(a,b){D&&(D=!1,s.onStopAnimating(v));var c={duration:300,onComplete:function(){}};PS.extend(c,b);var d=w.renderer.getCamera();if(d.position.equals(a.pose.position)&&d.quaternion.equals(a.pose.orientation))return s.virtualPathEnabled&&w.dataset.path.createTemporaryVirtualPath(a),s.onCameraChanged(a),void c.onComplete();var e=w.dataset.path.fixRange(y),f=a.qIndex,g=G.clone(),h=a.pose,i=a.smoothedScale.clone(),j=new THREE.Vector4(1,1,1,1),k=a===z?A:z,l=k.smoothedScale.clone(),m=a===z?k.balanceToPrevious.clone():k.balanceToNext.clone();if(w.dataset.path.isClosed){var n=w.dataset.path.nbPoints/2;Math.abs(f-e)>n&&(n>e?e+=w.dataset.path.nbPoints:f+=w.dataset.path.nbPoints)}w.stopSnappingToCamera(),s.startDownloadingTiles(a,!1),C=new PS.Tween.create({duration:c.duration,start:e,end:f,onUpdate:function(b,c){w.cameraController.setCurrentArcPosition(b),w.setPositionBetweenPoses(g,h,c,b),a.smoothedScale=i.clone().lerp(j,c),k.smoothedScale=l.clone().lerp(m,c)},onComplete:function(){w.setPositionBetweenPoses(g,h,1,a.qIndex),a.smoothedScale=j,k.smoothedScale=m,s.virtualPathEnabled&&w.dataset.path.createTemporaryVirtualPath(a),s.onCameraChanged(a),c.onComplete()}}).start()},this.stopSnappingToCamera=function(){C&&C.stop()},this.resetAnimateTimer=function(a){g(),a||w.cameraController.setCurrentArcPosition(w.dataset.path.fixRange(y))},this.setTransitionBetweenPoses=function(a,b,c,d){console.log("deprecated: use this.setPositionBetweenPoses() instead"),w.setPositionBetweenPoses(a,b,c,d)},this.setPositionBetweenPoses=function(a,b,c,d){y=d;var e=w.dataset.path.getPose(d,H);e.pose=w.dataset.path.getLinearInterpolation(a,b,c),s.onPoseChanged(e.pose),h(e)},this.setTransitionPercent=function(a){console.log("deprecated: use this.setPosition() instead"),w.setPosition(a)},this.setPosition=function(a){w.dataset.path.updateDraggingDirection(y,a),y=a;var b=w.dataset.path.getPose(a,H);s.onPositionChanged(a,b),h(b)},this.setPositionBetweenCameras=function(a,b,c,d,e,f){y=f;var g=w.dataset.path.getPose(f,H);g.pose=w.dataset.path.getLinearInterpolation(a,c,e),g.fov=d*e+(1-e)*b,s.onPoseChanged(g.pose),h(g)},this.getCameras=function(){return w.dataset.cameras},this.getNbCameras=function(){return w.dataset.cameras.length},this.getUsedCamera=function(){var a=w.renderer.getScenes();return[a[0].currentImageIndex,a[1].currentImageIndex]},this.setSeadragonDraggingCursor=function(a){if(I!==a){var b=t.parentNode.getElementsByClassName("PSInputLayer")[0];a?b.classList.add("PSInputLayerSeadragon"):b.classList.remove("PSInputLayerSeadragon"),I=a}},this.state=new function(){this.__defineGetter__("currentPose",function(){return G}),this.__defineGetter__("currentQIndex",function(){return y}),this.__defineGetter__("currentMode",function(){return H}),this.__defineGetter__("prevCamera",function(){return z}),this.__defineGetter__("nextCamera",function(){return A}),this.__defineGetter__("geometryEnabled",function(){return s.geometryEnabled}),this.hasUserAlreadyInteracted=function(){return E.getTime()!==F.getTime()}},this.load=function(a,b){D=!1,w.datasetLoader.load(a,b)};var J=[];this.loadTexture=function(a){J.push(a)};var K=new Date;this.getStatus=function(){return{c:w.dataset.cameras.map(function(a){return{s:a.isSelected?1:0,d:a.isDownloading?1:0,a:a.mesh.material===a.lowMaterial?1:0}}),p:y,m:H,d:w.dataset.rootUrl,v:w.dataset.version}},this.togglePlay=function(){D?g():f()},this.stopPlaying=function(a){D?g(a):C&&C.running()?(w.stopSnappingToCamera(),D=!0,g(a)):a&&a()},this.startPlaying=function(a){f(a)},this.isPlaying=function(){return D},this.resize=function(a,b,c){n(a,b,c),o()},this.getCanvasRect=function(){return{centerX:x.containerWidth/2,centerY:x.containerHeight/2,w:x.width*x.scale,h:x.height*x.scale}},this.getCanvas=function(){return B},k(a,b)},PS.Packet.QuantizedPose=function(a,b){this.position=a,this.orientation=b,this.nextIndex=0,this.prevIndex=0,this.fov=0,this.speed=1},PS.Packet.Pose=function(a,b){this.position=a,this.orientation=b},PS.Packet.Pose.prototype.copy=function(a){return this.position.copy(a.position),this.orientation.copy(a.orientation),this},PS.Packet.Pose.prototype.clone=function(){return new PS.Packet.Pose(new THREE.Vector3,new THREE.Quaternion).copy(this)},PS.Packet.Plane=function(a,b){this.normal=a,this.depth=b},PS.Packet.Parsers={},PS.Packet.Parsers.parsePathFile=function(a){var b=new DataView(a),c=0,d=b.getUint16(0,!0);c+=2;for(var e=new Array(d),f=0;d>f;++f){var g=b.getFloat32(c,!0);c+=4;var h=b.getFloat32(c,!0);c+=4;var i=b.getFloat32(c,!0);c+=4;var j=new THREE.Vector3(g,h,i),k=b.getFloat32(c,!0);c+=4;var l=b.getFloat32(c,!0);c+=4;var m=b.getFloat32(c,!0);c+=4;var n=1-k*k-l*l-m*m,o=n>1e-6?Math.sqrt(n):0,p=new THREE.Quaternion(k,l,m,o);e[f]=new PS.Packet.QuantizedPose(j,p)}return e},PS.Packet.RenderingPose=function(a,b,c,d,e){this.prevCamIndex=a,this.nextCamIndex=b,this.pose=c,this.percent=d,this.fov=e,this.speed=1},PS.Packet.VirtualPath=function(){this.isActive=!1,this.range=3,this.midPose=null,this.midQIndex=null,this.minQIndex=null,this.maxQIndex=null},PS.Packet.Path=function(a,b,c,d,e,f,g,h){function i(a){function b(a,b){var c=a%b;return 0>c?c+b:c}for(var c=new Array(q.nbPoints),d=0;d<q.nbPoints;++d)c[d]=0;for(var e=100,f=2*e+1,g=2e3,h=new Array(f),i=0,d=0;f>d;++d)h[d]=Math.exp(-(d-e)*(d-e)/g),i+=h[d];if(q.isClosed){for(var d=0;f>d;++d)h[d]/=i;for(var d=0;d<q.nbPoints;++d)for(var j=0;f>j;++j)c[d]+=q.points[b(d+j-e,q.nbPoints)][a]*h[j]}else for(var d=0;d<q.nbPoints;++d){for(var k=Math.min(e,Math.min(d,q.nbPoints-1-d)),l=2*k+1,m=0,n=Math.floor((e-k)/2),j=0;l>j;++j){var o=h[j+n];c[d]+=q.points[d+j-k][a]*o,m+=o}c[d]/=m}for(var d=0;d<q.nbPoints;++d)q.points[d][a]=c[d]}function j(a,b){for(var c=a[0].qIndex,d=a[a.length-1].qIndex,e=q.points,f=0;f<e.length;++f){var g=e[f],h=0,j=0;if(c>f)q.isClosed?(h=a.length-1,j=0):(h=-1,j=0,console.log("Error: malformed path"));else if(f>d)q.isClosed?(h=a.length-1,j=0):(h=a.length-1,j=-1,console.log("Error: malformed path"));else for(h=0,j=1;f<a[h].qIndex||f>a[j].qIndex;)h++,j++;g.nextIndex=j,g.prevIndex=h}if(p.smoothFovEnabled){if(q.isClosed)for(var f=0;f<e.length;++f){var k,g=e[f],l=a[g.prevIndex],m=a[g.nextIndex];k=l.qIndex<=m.qIndex?(f-l.qIndex)/(m.qIndex-l.qIndex):f>m.qIndex?(f-l.qIndex)/(m.qIndex+q.nbPoints-l.qIndex):(f+q.nbPoints-l.qIndex)/(m.qIndex+q.nbPoints-l.qIndex),g.fov=k*m.fovy+(1-k)*l.fovy}else for(var f=0;f<e.length;++f){var g=e[f],l=a[g.prevIndex],m=a[g.nextIndex],k=(f-l.qIndex)/(m.qIndex-l.qIndex);g.fov=k*m.fovy+(1-k)*l.fovy}i("fov")}else for(var f=0;f<q.nbPoints;++f)q.points[f].fov=b;if(p.smoothSpeedEnabled){if(q.isClosed)for(var f=0;f<e.length;++f){var n,g=e[f],l=a[g.prevIndex],m=a[g.nextIndex];n=l.qIndex<=m.qIndex?m.qIndex-l.qIndex:m.qIndex+q.nbPoints-l.qIndex,g.speed=s/n}else for(var f=0;f<e.length;++f){var g=e[f],l=a[g.prevIndex],m=a[g.nextIndex],n=m.qIndex-l.qIndex;g.speed=n/s}i("speed")}}function k(a,b){var c,d,e;return a>b.midQIndex?(c=b.midPose,d=q.points[b.maxQIndex],e=b.maxQIndex===b.midQIndex?1:(a-b.midQIndex)/(b.maxQIndex-b.midQIndex)):(c=q.points[b.minQIndex],d=b.midPose,e=b.midQIndex===b.minQIndex?0:(a-b.minQIndex)/(b.midQIndex-b.minQIndex)),q.getLinearInterpolation(c,d,e)}function l(){return u.isActive?u:t}function m(a,b){a.isActive=!0,a.midQIndex=b.qIndex,a.midPose=b.pose;var c=n(a);a.minQIndex=q.fixRange(Math.round(b.qIndex-c)),a.maxQIndex=q.fixRange(Math.round(b.qIndex+c))}function n(a){return.5*s*a.range}function o(a,b,c,d,e){var f=q.points[a],g=q.points[b],h=0,i=0;if(f.nextIndex===g.prevIndex)if(a>b)if(0===g.prevIndex)h=f.prevIndex,i=f.nextIndex;else{var j=r[f.nextIndex].qIndex;c>j?(h=g.prevIndex,i=g.nextIndex):(h=f.prevIndex,i=f.nextIndex)}else c>r[f.nextIndex].qIndex?(h=g.prevIndex,i=g.nextIndex):(h=f.prevIndex,i=f.nextIndex);else h=f.prevIndex,i=f.nextIndex;if(-1===h||-1===i)return void console.log("Error: malformed path");var k,l,m,n=r[h],o=r[i];if(0!==e&&p.extendPathEnabled){var t,u,v=s;if(Math.abs(e)>v?(e=v*(0>e?-1:1),p.onEndpointReached(0>e?-1:1)):p.onEndpointProgress(e/v),0>e){t=f.orientation.clone(),u=f.position.clone(),l=0;var w=Math.abs(e/v);m=f.fov+w*x}else{t=g.orientation.clone(),u=g.position.clone(),l=1;var w=Math.abs(e/v);m=g.fov+w*y}return k=new PS.Packet.Pose(u,t),new PS.Packet.RenderingPose(h,i,k,l,m)}return l=n.qIndex<o.qIndex?(c-n.qIndex)/(o.qIndex-n.qIndex):c>n.qIndex?(c-n.qIndex)/(o.qIndex+q.nbPoints-n.qIndex):(c+q.nbPoints-n.qIndex)/(o.qIndex+q.nbPoints-n.qIndex),d===PS.Packet.CameraMode.Smooth?k=q.getLinearInterpolation(f,g,c-a):d===PS.Packet.CameraMode.Linear||d===PS.Packet.CameraMode.Global?k=q.getLinearInterpolation(n.pose,o.pose,l):console.log("Error: getPose() is called with a wrong mode"),m=g.fov*(c-a)+f.fov*(1-(c-a)),new PS.Packet.RenderingPose(h,i,k,l,m)}var p={extendPathEnabled:!0,smoothFovEnabled:!0,smoothSpeedEnabled:!1,onEndpointProgress:function(){},onEndpointReached:function(){}};PS.extend(p,h),this.setOptions=function(a){PS.extend(p,a)},this.topology=d,this.isClosed=c,this.points=a,this.nbPoints=a.length;var q=this,r=b,s=e,t=new PS.Packet.VirtualPath,u=new PS.Packet.VirtualPath,v=1,w=5,x=w,y=w;"walk"===d&&(g.y<0?x*=-1:y*=-1),j(b,f),this.getLocalSpeed=function(a){var b=q.fixRange(a);return q.points[Math.floor(b)].speed},this.distance=function(a){return a?function(a,b){return b>a?b-a:(b+q.nbPoints-a)%q.nbPoints}:function(a,b){return Math.abs(b-a)}}(q.isClosed),this.shortestDistance=function(a){return a?function(a,b){var c=q.distance(a,b);return c>q.nbPoints/2?q.nbPoints-c:c}:function(a,b){return q.distance(a,b)}}(q.isClosed),this.fixRange=function(a){return a?function(a){for(var b=this.nbPoints,c=a;0>c;)c+=b;return c%=b}:function(a){return 0>a?0:a>this.nbPoints-1?this.nbPoints-1:a}}(q.isClosed),this.isInsideVirtualPath=function(a){return a?function(a,b){return b=b?b:l(),b.isActive?b.minQIndex<b.maxQIndex?a>=b.minQIndex&&a<=b.maxQIndex:a>=b.minQIndex||a<=b.maxQIndex:!1}:function(a,b){return b=b?b:l(),b.isActive?a>=b.minQIndex&&a<=b.maxQIndex:!1}}(q.isClosed),this.getPoseInsideVirtualPath=function(a){return a?function(a){var b=l();if(b.minQIndex<b.maxQIndex)return k(a,b);if(b.midQIndex>b.minQIndex){if(a>b.minQIndex&&a<=b.midQIndex)return k(a,b);var c,d=b.midPose,e=q.points[b.maxQIndex];return c=a<b.minQIndex?(a+q.nbPoints-b.midQIndex)/(b.maxQIndex+q.nbPoints-b.midQIndex):(a-b.midQIndex)/(b.maxQIndex+q.nbPoints-b.midQIndex),q.getLinearInterpolation(d,e,c)}if(a>b.midQIndex&&a<=b.maxQIndex)return k(a,b);var c,d=q.points[b.minQIndex],e=b.midPose;return c=a>b.minQIndex?(a-b.minQIndex)/(b.midQIndex+q.nbPoints-b.minQIndex):(a+q.nbPoints-b.minQIndex)/(b.midQIndex+q.nbPoints-b.minQIndex),q.getLinearInterpolation(d,e,c)}:function(a){var b=l();return k(a,b)}}(q.isClosed),this.getPersistentVirtualPathRadius=function(){return n(u)},this.createTemporaryVirtualPath=function(a){m(t,a)};var z=null;this.createPersistentVirtualPath=function(a,b){b&&u.isActive?z=a:m(u,a)},this.removePersistentVirtualPath=function(){u.isActive=!1},this.makePersistentVirtualPathTemporary=function(){u.isActive&&(t.isActive=u.isActive,t.range=u.range,t.midQIndex=u.midQIndex,t.midPose=u.midPose,t.minQIndex=u.minQIndex,t.maxQIndex=u.maxQIndex,u.isActive=!1)},this.getClosestCamera=function(a){return a?function(a,b){a=this.fixRange(a);var c=this.fixRange(Math.round(a)),d=this.points[c];if(b){var e=0>v?d.prevIndex:d.nextIndex;return r[e]}var f=0,g=0;d.prevIndex>d.nextIndex?a>r[d.prevIndex].qIndex?(f=Math.abs(r[d.prevIndex].qIndex-a),g=Math.abs(r[d.nextIndex].qIndex+q.nbPoints-a)):(f=Math.abs(r[d.prevIndex].qIndex-q.nbPoints-a),g=Math.abs(r[d.nextIndex].qIndex-a)):(f=Math.abs(r[d.prevIndex].qIndex-a),g=Math.abs(r[d.nextIndex].qIndex-a));var e=g>f?d.prevIndex:d.nextIndex;return r[e]}:function(a,b){a=this.fixRange(a);var c=Math.round(a),d=this.points[c];if(b){var e=0>v?d.prevIndex:d.nextIndex;return r[e]}if(-1===d.prevIndex)return console.log("Error: malformed path"),r[d.nextIndex];if(-1===d.nextIndex)return console.log("Error: malformed path"),r[d.prevIndex];var f=Math.abs(r[d.prevIndex].qIndex-a),g=Math.abs(r[d.nextIndex].qIndex-a),e=g>f?d.prevIndex:d.nextIndex;return r[e]}}(q.isClosed);var A=function(a){return a?function(a){a=q.fixRange(a);var b=Math.round(a),c=a-b,d=0>c?b-1:b+1,e=Math.min(b,d),f=Math.max(b,d);return f===q.nbPoints&&(f=0),[e,f,a,0]}:function(a){var b=a;a=q.fixRange(a);var c=Math.round(a),d=a-c,e=0>d?c-1:c+1,f=Math.min(c,e),g=Math.max(c,e);f===q.points.length-1&&(g=f,f-=1);var h=b-a;return[f,g,a,h]}}(q.isClosed);this.getPose=function(a,b){var c=A(a),d=o(c[0],c[1],c[2],b,c[3]);q.isClosed&&(a=q.fixRange(a));var e=l();return e.isActive&&b===PS.Packet.CameraMode.Smooth&&(q.isInsideVirtualPath(a)?d.pose=q.getPoseInsideVirtualPath(a):e===t?e.isActive=!1:z&&(m(u,z),z=null)),d},this.updateDraggingDirection=function(a,b){a!==b&&(v=b>a?1:-1)},this.getDraggingDirection=function(){return v}},PS.Packet.Path.prototype.getLinearInterpolation=function(a,b,c){var d=a.position.clone().multiplyScalar(1-c).add(b.position.clone().multiplyScalar(c)),e=THREE.Quaternion.slerp(a.orientation,b.orientation,new THREE.Quaternion,c);return new PS.Packet.Pose(d,e)},PS.Packet.Path.prototype.getDirectionVariability=function(a,b){for(var c=0,d=0,e=0,f=0;f<this.nbPoints;++f){var g=this.points[f],h=b.clone().applyQuaternion(g.orientation),i=h.dot(a);e+=i,(0===f||c>i)&&(c=i),(0===f||i>d)&&(d=i)}e/=this.nbPoints;var j=Math.acos(d),k=Math.acos(c),l=Math.acos(e),m=Math.max(k-l,l-j);return[l,m]},PS.Packet.Path.prototype.getOrientationVariability=function(){for(var a=new THREE.Vector4(0,0,0,0),b=0;b<this.nbPoints;++b){var c=this.points[b].orientation,d=a.x*c.x+a.y*c.y+a.z*c.z+a.w*c.w;a=d>=0?a.add(c):a.sub(c)}a.normalize();for(var e=new THREE.Quaternion(a.x,a.y,a.z,a.w),f=0,b=0;b<this.nbPoints;++b){var c=this.points[b].orientation,g=c.clone().inverse().multiply(e),h=2*Math.acos(g.w);h>Math.PI&&(h=2*Math.PI-h),f=Math.max(h,f)}return[e,f]},PS.Packet.Path.prototype.fixSpinOrientations=function(a,b,c,d){if(c||d)for(var e=0;e<this.nbPoints;++e){var f,g,h,i=this.points[e];if(c&&d)f=a.clone().sub(i.position).normalize(),g=(new THREE.Vector3).crossVectors(f,b).normalize(),h=(new THREE.Vector3).crossVectors(g,f).normalize();else if(c&&!d){f=a.clone().sub(i.position).normalize();var j=new THREE.Vector3(0,0,-1).applyQuaternion(i.orientation),k=Math.acos(f.clone().normalize().dot(j.clone().normalize())),l=(new THREE.Quaternion).setFromAxisAngle((new THREE.Vector3).crossVectors(j,f).normalize(),k).multiply(i.orientation);g=new THREE.Vector3(1,0,0).applyQuaternion(l),h=new THREE.Vector3(0,1,0).applyQuaternion(l)}else!c&&d&&(f=new THREE.Vector3(0,0,-1).applyQuaternion(i.orientation),g=(new THREE.Vector3).crossVectors(f,b).normalize(),h=(new THREE.Vector3).crossVectors(g,f).normalize());var m=new THREE.Matrix4(g.x,h.x,-f.x,0,g.y,h.y,-f.y,0,g.z,h.z,-f.z,0,0,0,0,1);i.orientation.setFromRotationMatrix(m)}},PS.Packet.Path.prototype.fixWallWalkOrientations=function(a,b,c,d,e){if(d||e)for(var f=0;f<this.nbPoints;++f){var g,h,i,j=this.points[f];if(g=new THREE.Vector3(0,0,-1).applyQuaternion(j.orientation),h=new THREE.Vector3(1,0,0).applyQuaternion(j.orientation),d){var k=Math.acos(g.dot(a)),l=b-k,m=(new THREE.Quaternion).setFromAxisAngle((new THREE.Vector3).crossVectors(g,a).normalize(),-l);g=g.applyQuaternion(m),h=h.applyQuaternion(m)}if(e){var n=Math.acos(h.dot(a)),l=c-n,o=(new THREE.Quaternion).setFromAxisAngle((new THREE.Vector3).crossVectors(h,a).normalize(),-l);g=g.applyQuaternion(o),h=h.applyQuaternion(o)}i=(new THREE.Vector3).crossVectors(h,g).normalize();var p=new THREE.Matrix4(h.x,i.x,-g.x,0,h.y,i.y,-g.y,0,h.z,i.z,-g.z,0,0,0,0,1);j.orientation.setFromRotationMatrix(p)}},PS.Packet.Path.prototype.setAllOrientations=function(a){for(var b=0;b<this.nbPoints;++b){var c=this.points[b];c.orientation=a.clone()}},PS.Packet.Shaders={},PS.Packet.Shaders.commonMaterial={uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","	vUv = uv;","	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tDiffuse;","void main() {","	gl_FragColor =  texture2D(tDiffuse, vUv.xy);","}"].join("\n")},PS.Packet.Shaders.downsamplingMaterial={fragmentShader:["varying vec2 vUv;","uniform sampler2D uReduceTex;","uniform float uReduceDx;","uniform float uReduceDy;","void main (void)","{","	vec4 color0 = texture2D(uReduceTex, vUv + vec2(-uReduceDx,  0));","	vec4 color1 = texture2D(uReduceTex, vUv + vec2( uReduceDx,  0));","	gl_FragColor = 0.5 * (color0 + color1);","}"].join("\n")},PS.Packet.Shaders.upsamplingMaterial={fragmentShader:["varying vec2 vUv;","uniform sampler2D uExpandTex0;","uniform sampler2D uExpandTex1;","void main (void)","{","	vec4 up = texture2D(uExpandTex0, vUv);","	if (up.a > 0.0)","	{","		up /= up.a;","	}","	vec4 orig = texture2D(uExpandTex1, vUv);","	if (orig.a > 0.0)","	{","		orig.rgb /= orig.a;","	}","	gl_FragColor = vec4(mix(up.rgb, orig.rgb, orig.a), 1);","}"].join("\n")},PS.Packet.Shaders.Shader=function(a,b,c){this.uniforms=a,this.vertexShader=b,this.fragmentShader=c},PS.Packet.Shaders.Factory={generateProjectiveShaders:function(a){var b={thumbnailAtlasShader:!1,debugPolygonColorEnabled:!1,featheringBlendingEnabled:!1,opacityOverrideEnabled:!1,positioningEnabled:!1,overrideColorEnabled:!1};PS.extend(b,a);var c={colorTex:{type:"t",value:null},colorScale:{type:"v4",value:new THREE.Vector4(1,1,1,1)},textureMatrix:{type:"m4",value:new THREE.Matrix4}};b.debugPolygonColorEnabled&&(c=PS.extend(c,{debugBlending:{type:"f",value:1}})),b.thumbnailAtlasShader&&(c=PS.extend(c,{thumbnail:{type:"v4",value:new THREE.Vector4(0,0,0,0)}})),b.opacityOverrideEnabled&&(c=PS.extend(c,{opacity:{type:"f",value:1}}));var d="";d+="uniform mat4 textureMatrix;\n",d+="varying vec4 vUv;\n",b.debugPolygonColorEnabled&&(d+="varying vec3 vColor;\n"),d+="void main() {\n",d+="	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n",d+=b.positioningEnabled?"	vUv = textureMatrix * modelMatrix * vec4(position, 1.0);\n":"	vUv = textureMatrix * vec4(position, 1.0);\n",b.debugPolygonColorEnabled&&(d+="	vColor = color;\n"),d+="}\n";var e="";return e+="uniform sampler2D colorTex;\n",e+="uniform vec4 colorScale;\n",e+="varying vec4 vUv;\n",b.thumbnailAtlasShader&&(e+="uniform vec4 thumbnail;\n"),b.debugPolygonColorEnabled&&(e+="uniform float debugBlending;\n",e+="varying vec3 vColor;\n"),b.opacityOverrideEnabled&&(e+="uniform float opacity;\n"),b.featheringBlendingEnabled&&(e+="float linearFeather(vec2 xy) {\n",e+="	float dx = min(xy.x, 1.0-xy.x);\n",e+="	float dy = min(xy.y, 1.0-xy.y);\n",e+="	float d = min(dx,dy);\n",e+="	return d;\n",e+="}\n",e+="float radialFeather(vec2 xy) {\n",e+="	float rx = xy.x - 0.5;\n",e+="	float ry = xy.y - 0.5;\n",e+="	float r = sqrt(rx*rx + ry*ry);\n",e+="	const float sqrt2 =  1.41421356237310;\n",e+="	r = 1.0 - sqrt2 * r;\n",e+="	return r;\n",e+="}\n",e+="float mixAndClamp(float d, float r) {\n",e+="	const float linearThresh = 5.0;\n",e+="	const float radialThresh = 1.0;\n",e+="	d = clamp(d * linearThresh, 0.0, 1.0);\n",e+="	r = clamp(r * radialThresh, 0.0, 1.0);\n",e+="	float alpha = 2.0 / (1.0/r + 1.0/d);\n",e+="	alpha = r * d;\n",e+="	alpha = clamp(alpha, 0.0, 1.0);\n",e+="	return alpha;\n",e+="}\n",e+="vec4 feather(vec4 c, vec2 xy) {\n",e+="	float d = linearFeather(xy);\n",e+="	float r = radialFeather(xy);\n",e+="	float alpha = mixAndClamp(d, r);\n",e+="	c.a = alpha;\n",e+="	return c;\n",e+="}\n"),e+="void main() {\n",e+="	vec4 t = vUv;\n",(!b.thumbnailAtlasShader||b.featheringBlendingEnabled)&&(e+="	vec2 xy = vec2(t.x/t.z, 1.0-t.y/t.z);\n"),b.debugPolygonColorEnabled&&(e+="	vec4 polygonColor = vec4(vColor, 1.0);\n"),e+=b.thumbnailAtlasShader?"	vec4 textureColor = texture2D(colorTex, vec2(t.x/t.z*thumbnail.z+thumbnail.x, 1.0-t.y/t.z*thumbnail.w+thumbnail.y));\n":"	vec4 textureColor = texture2D(colorTex, xy);\n",e+="float scaleWt = clamp(0.8*(3.0-dot(textureColor.rgb,textureColor.rgb)), 0.0, 1.0);\n",e+="textureColor.rgb = mix(textureColor.rgb, colorScale.rgb*textureColor.rgb, scaleWt);\n",b.featheringBlendingEnabled&&(e+="textureColor = feather(textureColor, xy);\n"),e+=b.debugPolygonColorEnabled?"	gl_FragColor = mix(polygonColor, textureColor, debugBlending);\n":"	gl_FragColor = textureColor;\n",b.opacityOverrideEnabled&&(e+="	gl_FragColor.a = opacity;\n"),b.overrideColorEnabled&&(e+="	gl_FragColor.rgb = vec3(1, 0, 1);\n"),e+="}\n",new PS.Packet.Shaders.Shader(c,d,e)},generateBlendingShaders:function(a){var b={blendingMode:PS.Packet.BlendingMode.Opacity};PS.extend(b,a);var c={tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},blendFactor:{type:"f",value:.5}};(b.blendingMode===PS.Packet.BlendingMode.DitheringLuminance||b.blendingMode===PS.Packet.BlendingMode.DitheringColor)&&(c=PS.extend(c,{tRandom:{type:"t",value:null},texSize:{type:"v2",value:new THREE.Vector2}}));var d=PS.Packet.Shaders.commonMaterial.vertexShader,e="";return e+="varying vec2 vUv;\n",e+="uniform sampler2D tDiffuse1;\n",e+="uniform sampler2D tDiffuse2;\n",(b.blendingMode===PS.Packet.BlendingMode.DitheringLuminance||b.blendingMode===PS.Packet.BlendingMode.DitheringColor)&&(e+="uniform sampler2D tRandom;\n",e+="uniform vec2 texSize;\n"),e+="uniform float blendFactor;\n",b.blendingMode===PS.Packet.BlendingMode.Feathering&&(e+="float computeWeight(float alpha0, float alpha1) {\n",e+="	float edgeWeight = alpha0 / (alpha0 + alpha1);\n",e+="	float weight0 = blendFactor * edgeWeight;\n",e+="	float weight1 = (1.0-blendFactor) * (1.0-edgeWeight);\n",e+="	weight0 = weight0 / (weight0 + weight1);\n",e+="	return weight0;\n",e+="}\n"),e+="void main() {\n",e+="	vec4 color0 = texture2D(tDiffuse1, vUv);\n",e+="	vec4 color1 = texture2D(tDiffuse2, vUv);\n",(b.blendingMode===PS.Packet.BlendingMode.DitheringLuminance||b.blendingMode===PS.Packet.BlendingMode.DitheringColor)&&(e+="	vec2 uvCoord2 = vUv*texSize*vec2(1.0/128.0, 1.0/128.0);\n"),b.blendingMode===PS.Packet.BlendingMode.DitheringLuminance?e+="	float prob = float(blendFactor <= texture2D(tRandom, uvCoord2).r);\n":b.blendingMode===PS.Packet.BlendingMode.DitheringColor&&(e+="	bvec3 prob   = lessThanEqual(vec3(blendFactor, blendFactor, blendFactor), texture2D(tRandom, uvCoord2).rgb);\n",e+="	vec3  probf  = vec3(float(prob.x), float(prob.y), float(prob.z));\n",e+="	bvec3 nprob  = not(prob);\n",e+="	vec3  nprobf = vec3(float(nprob.x), float(nprob.y), float(nprob.z));\n"),e+="	const float epsilon = 0.001;\n",e+="	vec4 color;\n",e+="	if (color0.a < epsilon && color1.a < epsilon)\n",e+="	{\n",e+="		color = vec4(0, 0, 0, 0);\n",e+="	}\n",e+="	else if (color0.a < epsilon && color1.a >= epsilon)\n",e+="	{\n",e+="		color = color1;\n",b.blendingMode===PS.Packet.BlendingMode.Feathering&&(e+="		color.a = 1.0;\n"),e+="	}\n",e+="	else if (color0.a >= epsilon && color1.a < epsilon)\n",e+="	{\n",e+="		color = color0;\n",b.blendingMode===PS.Packet.BlendingMode.Feathering&&(e+="		color.a = 1.0;\n"),e+="	}\n",e+="	else\n",e+="	{\n",b.blendingMode===PS.Packet.BlendingMode.Feathering?(e+="		float weight = computeWeight(color0.a, color1.a);\n",e+="		color = mix(color1, color0, weight);\n",e+="		color.a = 1.0;\n"):b.blendingMode===PS.Packet.BlendingMode.DitheringLuminance?(e+="		color.rgb = mix(color0.rgb, color1.rgb, prob);\n",e+="		color.a = 1.0;\n"):b.blendingMode===PS.Packet.BlendingMode.DitheringColor?(e+="		color.rgb = color1.rgb*probf + color0.rgb*nprobf;\n",e+="		color.a = 1.0;\n"):e+="		color = mix(color1, color0, blendFactor);\n",e+="	}\n",e+="	gl_FragColor = color;\n",e+="}\n",new PS.Packet.Shaders.Shader(c,d,e)
}},PS.Packet.Seadragon={},PS.Packet.Seadragon.generateUniqueHash=function(){var a=0;return function(){return"seadragon_"+a++}}(),PS.Packet.Seadragon.TileSource=function(a,b){this.dimensions=a.clone(),this.maxLevel=Math.ceil(Math.log(Math.max(a.x,a.y))/Math.log(2)),this.tileSize=b||510},PS.Packet.Seadragon.TileSource.prototype={getLevelScale:function(a){for(var b={},c=0;c<=this.maxLevel;c++)b[c]=1/Math.pow(2,this.maxLevel-c);return this.getLevelScale=function(a){return b[a]},this.getLevelScale(a)},getLevelSize:function(a){var b=this.getLevelScale(a),c=Math.ceil(b*this.dimensions.x),d=Math.ceil(b*this.dimensions.y);return new THREE.Vector2(c,d)},getNumTiles:function(a){var b=this.getLevelScale(a),c=Math.ceil(b*this.dimensions.x/this.tileSize),d=Math.ceil(b*this.dimensions.y/this.tileSize);return new THREE.Vector2(c,d)},getNbTiles:function(a){var b=this.getNumTiles(a);return b.x*b.y}},PS.Packet.Seadragon.Viewer=function(a,b){function c(){var a=k.clientWidth,b=k.clientHeight,c=g.w/g.h,d=a/b,e=d>c?g.h/b:g.w/a;1>e&&(e=1);var f=a*e,h=b*e;o=(a-f)/2,p=(b-h)/2,j.style.left=o+"px",j.style.top=p+"px",j.style.width=f+"px",j.style.height=h+"px"}function d(a){for(var b=a.x,c=a.y,d=Math.ceil(Math.log(Math.max(b,c))/Math.log(2)),e=d;b>s.renderingSize.x||c>s.renderingSize.y;)b/=2,c/=2,e--;return Math.min(Math.max(e,0),d)}function e(a,b){f=OpenSeadragon({element:j,showNavigationControl:!1,springStiffness:20,animationTime:1.5,visibilityRatio:1,hash:PS.Packet.Seadragon.generateUniqueHash(),tileSources:{Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a,Format:"jpg",Overlap:1,TileSize:510,Size:{Width:b.x,Height:b.y}},minLevel:d(b)}}),f.addHandler("open",function(){r();var a=k.clientWidth,b=k.clientHeight,c=g.w/g.h,d=a/b,e=d>c?g.h/b:g.w/a;if(1>e){var h=f.viewport.getBounds(!0),i=h.getCenter(),j=h.width/e,l=h.height/e,m=new OpenSeadragon.Rect(i.x-j/2,i.y-l/2,j,l);f.viewport.fitBounds(m,!0),f.viewport.originalHomeBounds=f.viewport.homeBounds,f.viewport.homeBounds=m,f.viewport.contentAspectX=f.viewport.getAspectRatio()*f.viewport.getZoom()}else f.viewport.originalHomeBounds=f.viewport.homeBounds;f.viewport.goHome(!0)}),f.addHandler("resize",function(){c(),f.viewport.goHome(!0),s.onResize()}),f.addHandler("home",function(){k.style.visibility="visible"}),f.addHandler("animation-finish",function(){s.onZoomLevelStateChanged(i.isHomeZoom())}),f.addHandler("animation",function(a){s.onPositionChanged();var b=i.isHomeZoom();q!==b&&(q=b,s.onZoomLevelStateChanged(b)),h&&h(a)}),j.style.position="absolute",i.openSeadragon=f}var f,g,h,i=this,j=a,k=b,i=this,l=!1,m=!0,n=!1,o=0,p=0,q=!0,r=function(){},s={renderingSize:new THREE.Vector2(0,0),onPositionChanged:function(){},onResize:function(){},onZoomLevelStateChanged:function(){},corsEnabled:!1};this.init=function(a){PS.extend(s,a)},this.destroy=function(){f&&(f.removeAllHandlers("open"),f.removeAllHandlers("resize"),f.removeAllHandlers("home"),f.removeAllHandlers("animation-finish"),f.removeAllHandlers("anination"),f.destroy(),f=null),i.openSeadreagon=null},this.enable=function(){n=!0},this.disable=function(){n=!1},this.setVisible=function(a){l!==a&&(n||!n&&!a)&&(m&&(j.style.visibility=a?"visible":"hidden"),l=a)},this.setForceVisible=function(a){j.style.visibility=a&&l?"visible":"hidden",m=a},this.isVisible=function(){return l},this.isHomeZoom=function(){var a=.001;return f&&f.viewport?Math.abs(f.viewport.getZoom(!0)-f.viewport.getHomeZoom())<a:!1},this.goHome=function(){f&&f.viewport&&f.viewport.goHome()},this.getViewportRect=function(){return{left:j.offsetLeft,top:j.offsetTop,width:j.clientWidth,height:j.clientHeight}},this.getOffset=function(){return{x:o,y:p}},this.setCropping=function(a){g=a,c()},this.startLoading=function(a,b,h,j){return r=j||function(){},g=h,c(),i.setVisible(!1),!f&&n?e(a,b):n&&f.open({Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a,Format:"jpg",Overlap:"1",TileSize:"510",Size:{Width:b.x,Height:b.y}},minLevel:d(b)}),n},this.setAnimationCallback=function(a){h=a},this.windowToImageCoordinates=function(a,b){var c=f.viewport,d=c.contentAspectX;c.contentAspectX=c.contentSize.x/c.contentSize.y;var e=c.windowToImageCoordinates(new OpenSeadragon.Point(a,b));return c.contentAspectX=d,new THREE.Vector2(e.x,e.y)},this.fitBoundsWithConstraints=function(a,b){if(f.viewport.fitBoundsWithConstraints)return f.viewport.fitBoundsWithConstraints(a,b);var c,d,e,g,h,i,j,k,l,m,n,o=f.viewport,p=o.getAspectRatio(),q=a.getCenter(),r=new OpenSeadragon.Rect(a.x,a.y,a.width,a.height),s=0,t=0;r.getAspectRatio()>=p?(r.height=a.width/p,r.y=q.y-r.height/2):(r.width=a.height*p,r.x=q.x-r.width/2),n=r.getAspectRatio(),o.panTo(o.getCenter(!0),!0),o.zoomTo(o.getZoom(!0),null,!0),c=o.getBounds(),d=o.getZoom(),e=1/r.width;var u=Math.max(Math.min(e,o.getMaxZoom()),o.getMinZoom());return e!==u&&(e=u,r.width=1/e,r.x=q.x-r.width/2,r.height=r.width/n,r.y=q.y-r.height/2),h=o.visibilityRatio*r.width,i=o.visibilityRatio*r.height,j=r.x+r.width,k=1-r.x,l=r.y+r.height,m=o.contentAspectY-r.y,o.wrapHorizontal||(h>j&&(s=h-j),h>k&&(s=s?(s+k-h)/2:k-h)),o.wrapVertical||(i>l&&(t=i-l),i>m&&(t=t?(t+m-i)/2:m-i)),(s||t)&&(r.x+=s,r.y+=t,r.width>1&&(r.x=.5-r.width/2),r.height>o.contentAspectY&&(r.y=o.contentAspectY/2-r.height/2)),e===d||r.width===c.width?o.panTo(r.getCenter(),b):(g=c.getTopLeft().times(o.containerSize.x/c.width).minus(r.getTopLeft().times(o.containerSize.x/r.width)).divide(o.containerSize.x/c.width-o.containerSize.x/r.width),o.zoomTo(e,g,b))}},PS.Packet.Annotation={},PS.Packet.Annotation.VisibilityPreset={Auto:0,All:1,One:2,Manual:3},PS.Packet.Annotation.Viewer=function(a){function b(a,b,c,d,e,f,g,h,i){this.worldPoint=a,this.visibility=b,this.visibilityPreset=c,this.surfaceOrientation=d,this.radius=42,this.accurateRadius=42,this.distCamObject=e,this.queryPoint=g,this.camSIndex=f,this.div=h,this.id=i,this.text="",this.dbid=""}function c(a){return function(b){var c=b.relatedTarget;this===c||d(this,c)||a.call(this,b)}}function d(a,b){if(a===b)return!1;for(;b&&b!==a;)b=b.parentNode;return b===a}function e(){u=!0;var a=o.getDiv(),b=o.packetViewer.resizeState,d=b.width*b.scale,e=b.height*b.scale;p=document.createElement("div"),p.className="PSAnnotationViewer",J=Math.floor((b.containerWidth-d)/2),K=Math.floor((b.containerHeight-e)/2),M(p,"transform","translate("+J+"px, "+K+"px)"),q=document.createElement("div"),q.className="PSAnnotations",p.appendChild(q),r=document.createElement("div"),r.className="PSAnnotationInfobox",r.style.display="none";var f=document.createElement("div");f.className="content",r.addEventListener("mouseover",c(function(){G=!0}),!1),r.addEventListener("mouseout",c(function(){G=!1,i()}),!1),r.appendChild(f);var g=document.createElement("button");g.style.display=n.editEnabled?"":"none",g.appendChild(document.createTextNode("edit")),new PS.Packet.SingleTouchInputHandler(g,{onDown:function(a){return a.originalEvent.cancelBubble=!0,y=x,n.onAnnotationEdit(j(y),J,K),k(),!0}}),r.appendChild(g);var h=document.createElement("button");h.style.display=n.editEnabled?"":"none",h.appendChild(document.createTextNode("delete")),new PS.Packet.SingleTouchInputHandler(h,{onDown:function(a){return a.originalEvent.cancelBubble=!0,n.onAnnotationDelete(j(x)),!0}}),r.appendChild(h),new PS.Packet.SingleTouchInputHandler(r,{onDown:function(a){return a.originalEvent.cancelBubble=!0,!0}}),p.appendChild(r);var l=a.getElementsByClassName("PSInputLayer")[0];l.appendChild(p)}function f(){var a=o.seadragonViewer;if(a.openSeadragon&&a.openSeadragon.viewport&&!a.isHomeZoom()){var b=a.openSeadragon.viewport,c=b.originalHomeBounds,d=b.pixelFromPoint(c.getTopLeft(),!0);J=d.x,K=d.y}else{var e=o.packetViewer.resizeState;J=(e.containerWidth-e.width*e.scale)/2,K=(e.containerHeight-e.height*e.scale)/2}M(p,"transform","translate("+J+"px, "+K+"px)")}function g(a){if(y!==a){var b=j(a);if(b){x=a;var c=b?b.text:"";r.getElementsByClassName("content")[0].innerHTML=Autolinker.link(c,{truncate:35,emails:!1,twitter:!1,stripPrefix:!1}),""!==c||n.editEnabled?(r.style.display="",h(),b.div.classList.add("PSAnnotationHovered"),k()):(h(),r.style.display="none")}}}function h(){for(var a=0;a<t.length;++a)t[a].div.classList.remove("PSAnnotationHovered")}function i(){h(),x=-1,r.style.display="none"}function j(a){for(var b=0;b<t.length;++b){var c=t[b];if(c.id===a)return c}return null}function k(){if(t.length>0&&I&&w.length>0){var a=o.packetViewer.renderer.getCamera(),b=o.packetViewer.state.currentQIndex,c=o.packetViewer.dataset.path;v.identity(),v.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);for(var d=o.packetViewer.resizeState,e=d.width*d.scale,f=d.height*d.scale,g=0;g<t.length;++g){var h=t[g],j=h.div;if(!h.visible||-1===h.visibility.indexOf(w[0].index)&&-1===h.visibility.indexOf(w[1].index))j.style.display="none",x===h.id&&i(),y===h.id&&l(h,v,e,f,.2);else{var k=.5,m=-1!==h.visibility.indexOf(w[0].index),p=-1!==h.visibility.indexOf(w[1].index);if(m&&p)k=1;else{var q=c.shortestDistance(w[0].qIndex,b),r=c.shortestDistance(w[1].qIndex,b),s=c.shortestDistance(w[0].qIndex,w[1].qIndex);k=m?r/s:q/s,k=Math.min(1,Math.max(0,k))}l(h,v,e,f,k),j.style.display=0===k?"none":""}y===h.id&&n.onEditedAnnotationMove(h,J,K)}}}function l(a,b,c,d,e){var f=a.worldPoint,g=f.clone();g.applyProjection(b);var h=(g.x+1)*(c/2),i=(-g.y+1)*(d/2);h*=A,i*=A;var j=f.clone();if(j.applyMatrix4(b),!(j.z<0)){var k=a.radius*a.distCamObject/f.distanceTo(z.position)*A;a.accurateRadius=k,k=Math.max(C,Math.min(D,k));var l=a.div;l.style.top=i-k+"px",l.style.left=h-k+"px",l.style.width=l.style.height=2*k+"px",l.style.opacity=e,a.visible&&x===a.id&&y!==a.id&&m(h,i,k)}}function m(a,b,c){var d=r.offsetWidth,e=r.offsetHeight,f=e/2,g=d/2,h=new THREE.Vector2(J+a,K+b),i=-10;if(r.style.left=h.x+c+i+d<window.innerWidth?a+c+i+"px":a-c-i-d+"px",h.y>window.innerHeight){if(r.style.top=b-c-i-e+"px",r.style.left=a-g+"px",h.x+g>window.innerWidth){var j=new THREE.Vector2(window.innerWidth,window.innerHeight);if(h.x>window.innerWidth){var k=j.sub(h).normalize().multiplyScalar(c+i).add(h);r.style.left=k.x-J-d+"px",r.style.top=k.y-K-e+"px"}else{var l=h.clone().add(new THREE.Vector2(0,-c)),m=l.sub(j).clone(),k=m.clone().normalize().multiplyScalar(m.length()+i).add(j);r.style.left=k.x-J-d+"px",r.style.top=k.y-K-e+"px"}}else if(h.x-g<0){var j=new THREE.Vector2(0,window.innerHeight);if(h.x<0){var k=j.sub(h).normalize().multiplyScalar(c+i).add(h);r.style.left=k.x-J+"px",r.style.top=k.y-K-e+"px"}else{var l=h.clone().add(new THREE.Vector2(0,-c)),m=l.sub(j).clone(),k=m.clone().normalize().multiplyScalar(m.length()+i).add(j);r.style.left=k.x-J+"px",r.style.top=k.y-K-e+"px"}}}else if(h.y<0){if(r.style.top=b+c+i+"px",r.style.left=a-g+"px",h.x+g>window.innerWidth){var j=new THREE.Vector2(window.innerWidth,0);if(h.x>window.innerWidth){var k=j.sub(h).normalize().multiplyScalar(c+i).add(h);r.style.left=k.x-J-d+"px",r.style.top=k.y-K+"px"}else{var n=h.clone().add(new THREE.Vector2(0,c)),m=n.sub(j).clone(),k=m.clone().normalize().multiplyScalar(m.length()+i).add(j);r.style.left=k.x-J-d+"px",r.style.top=k.y-K+"px"}}else if(h.x-g<0){var j=new THREE.Vector2(0,0);if(h.x<0){var k=j.sub(h).normalize().multiplyScalar(c+i).add(h);r.style.left=k.x-J+"px",r.style.top=k.y-K+"px"}else{var n=h.clone().add(new THREE.Vector2(0,c)),m=n.sub(j).clone(),k=m.clone().normalize().multiplyScalar(m.length()+i).add(j);r.style.left=k.x-J+"px",r.style.top=k.y-K+"px"}}}else r.style.top=h.y-f>0&&h.y+f<window.innerHeight?b-f+"px":h.y-e>0&&h.y<window.innerHeight?b-e+"px":b+"px"}var n={editEnabled:!1,onInitialized:function(){},onAnnotationClick:function(){},onAnnotationEdit:function(){},onAnnotationDelete:function(){},onEditedAnnotationMove:function(){}};PS.extend(n,a);var o,p,q,r,s,t=[],u=!1,v=new THREE.Matrix4,w=[],x=-1,y=-1,z={position:new THREE.Vector3,orientation:new THREE.Quaternion},A=1,B=0,C=22,D=Math.min(window.innerWidth,window.innerHeight)/2.5,E=1,F=this,G=!1,H=!1,I=!0,J=0,K=0,L=!1,M=function(a,b,c,d){d=d||["Webkit","Moz","O","Ms"];for(var e=d.length;e--;){var f=d[e];a.style[f+b.charAt(0).toUpperCase()+b.slice(1)]=c,a.style[b]=c}};this.resize=function(a,b){if(u)if(b!==PS.Packet.ResizeMode.Slow||L)F.setLayerVisibility(!1);else{F.setLayerVisibility(!0);for(var a=o.packetViewer.resizeState,c=Math.min(a.width*a.scale,a.height*a.scale),d=0;d<t.length;++d)t[d].radius*=c/E;E=c,D=Math.min(window.innerWidth,window.innerHeight)/2.5,f(),k()}},this.setTransform=function(a,b,c){I&&u&&(A=c,f(),k())},this.setFullscreenState=function(a){u&&(L=a,F.setLayerVisibility(!1))},this.setLayerVisibility=function(a){u&&(I=a,p.style.display=a?"":"none",k())},this.init=function(a){o=a,t=[];var b=o.packetViewer.resizeState;E=Math.min(b.width*b.scale,b.height*b.scale),u||e(),n.onInitialized()},this.add=function(a,c,d,e,f,h,l,m){var o=B++,p=document.createElement("div");p.className="PSAnnotation",new PS.Packet.SingleTouchInputHandler(p,{onDown:function(){var a=o;return function(b){b.originalEvent.stopPropagation(),setTimeout(function(){g(a);var b=j(a);b&&b.div.classList.add("PSAnnotationHovered")},300);var c=j(a);return n.onAnnotationClick(c,s),!0}}()}),p.addEventListener("mouseover",function(){var a=o;return function(){H=!0,x!==a&&g(a)}}(),!1),p.addEventListener("mouseout",function(){return function(){H=!1,setTimeout(function(){G||H||i()},5)}}(),!1),q.appendChild(p);var r=new b(a,c,d,l,e,f,h,p,o);return r.visible=m,t.push(r),k(),o},this.setRadius=function(a,b){var c=j(a);c&&(c.radius=b/A,k())},this.setVisibility=function(a,b){var c=j(a);c&&(c.visibility=b,k())},this.setVisible=function(a,b){var c=j(a);c&&(c.visible=b,k())},this.setText=function(a,b){var c=j(a);c&&(c.text=b,k())},this.setPersistentId=function(a,b){var c=j(a);c&&(c.dbid=b)},this.setEditable=function(a,b){y=b?a:-1},this.setVisibilityEditable=function(a,b){var c=j(a);c&&(b?c.div.classList.add("PSAnnotationEdited"):c.div.classList.remove("PSAnnotationEdited"))},this.setVisibilityPreset=function(a,b){var c=j(a);c&&(c.visibilityPreset=b)},this.setConnectionInfo=function(a,b){var c=j(a);c&&(c.transform=b)},this.remove=function(a){var b=j(a);b&&(q.removeChild(b.div),t.splice(t.indexOf(b),1),x===b.id&&i(),y===b.id&&(y=-1))},this.onCameraChanged=function(a){s=a,z.position.copy(a.pose.position),z.orientation.copy(a.pose.orientation),k()},this.onCamerasChanged=function(a,b){var c=o.packetViewer.getCameras();w=[c[a],c[b]]},this.onPoseChanged=function(a){z.position.copy(a.position),z.orientation.copy(a.quaternion),k()},this.dump=function(){var a=o.packetViewer.resizeState,b=Math.min(a.width*a.scale,a.height*a.scale);return{annotations:t.map(function(a){return{worldPoint:a.worldPoint.toArray(),queryPoint:a.queryPoint.toArray(),visibility:a.visibility.toString(),radius:a.radius/b,text:a.text,imgIndex:o.packetViewer.dataset.cameras[a.camSIndex].index,dbid:a.dbid,surfaceOrientation:a.surfaceOrientation.toArray()}})}},this.load=function(a){var b=o.packetViewer.resizeState;E=Math.min(b.width*b.scale,b.height*b.scale);for(var c=o.packetViewer.dataset,d=0;d<a.length;++d){var e=a[d],f=(new THREE.Vector3).fromArray(e.worldPoint),g=c.getCameraByIndex(e.imgIndex),h=F.add(f,e.visibility.split(",").map(function(a){return parseInt(a,10)}),e.visibilityPreset,f.distanceTo(g.pose.position),g.sIndex,(new THREE.Vector2).fromArray(e.queryPoint),(new THREE.Quaternion).fromArray(e.surfaceOrientation),!0);F.setText(h,e.text),F.setRadius(h,e.radius*E*A),F.setPersistentId(h,e.dbid),e.transform&&F.setConnectionInfo(h,e.transform)}},this.get=function(a){var b=j(a);if(b){var c=o.packetViewer.resizeState,d=Math.min(c.width*c.scale,c.height*c.scale);return{worldPoint:b.worldPoint.toArray(),queryPoint:b.queryPoint.toArray(),visibility:b.visibility.toString(),visibilityPreset:b.visibilityPreset,radius:b.radius/d,text:b.text,dbid:b.dbid,imgIndex:o.packetViewer.dataset.cameras[b.camSIndex].index,surfaceOrientation:b.surfaceOrientation.toArray()}}},this.getRaw=function(a){return j(a)},this.clear=function(){for(i(),x=-1,y=-1;t.length>0;)F.remove(t[0].id)},this.forceRender=function(){k()},this.destroy=function(){}},PS.Packet.Annotation.GeometryService=function(){function a(a,b){this.normal=a,this.depth=b}function b(a,b){new PS.Utils.Request(a,{responseType:"arraybuffer",onComplete:function(a){b(a.response)}})}function c(a,b,c){var d=a.getUint16(b,!0);b+=2;var e=a.getUint16(b,!0);b+=2;var f=a.getUint16(b,!0);b+=2;var g=a.getUint32(b,!0);b+=4;var h=a.getUint32(b,!0);b+=4;{var i=Math.floor(d*c.x),j=Math.floor(e*c.y);a.getFloat32(b,!0)}b+=4;a.getFloat32(b,!0);b+=4;a.getFloat32(b,!0);b+=4;a.getFloat32(b,!0);b+=4;for(var k={minX:0,minY:0,maxX:0,maxY:0},l=new Uint16Array(g),m=new Uint16Array(g),n=new Uint16Array(h),o=new Uint16Array(3),p=0;f>p;++p){var q=a.getUint16(b,!0);b+=2;var r=a.getUint16(b,!0);b+=2;var s=a.getUint16(b,!0);b+=2;var t=a.getUint16(b,!0);b+=2;var u=a.getUint16(b,!0);b+=2,k.minX=t,k.minY=u,k.maxX=t,k.maxY=u;var v=t,w=u;l[0]=v,m[0]=w;for(var x=1;r>x;++x)v+=a.getInt16(b,!0),b+=2,w+=a.getInt16(b,!0),b+=2,l[x]=v,m[x]=w,k.minX=Math.min(k.minX,v),k.minY=Math.min(k.minY,w),k.maxX=Math.max(k.maxX,v),k.maxY=Math.max(k.maxY,w);var y=a.getUint16(b,!0);b+=2,n[0]=y;for(var z=y,A=3*s-1,x=0;A>x;++x)z+=a.getInt16(b,!0),b+=2,n[x+1]=z;var B=i>=k.minX&&i<=k.maxX&&j>=k.minY&&j<=k.maxY;if(B)for(var C=0,x=0;s>x;++x)if(o[0]=n[C++],o[1]=n[C++],o[2]=n[C++],isInsideTriangle(l,m,o,i,j))return q}return-1}function d(b,d,e){var f=new DataView(b),g=0,h=f.getUint16(g,!0);g+=2;for(var i=h,j=new Array(i),k=new Array(i),l=0,m=0,n=0;i>n;++n){var o=f.getUint32(g,!0);g+=4;var p=f.getUint32(g,!0);g+=4,k[n]=o,j[n]=p,l+=o,m+=p}for(var n=0;d>n;++n)g+=k[n];for(var q=c(f,g,e),n=d;i>n;++n)g+=k[n];for(var n=0;d>n;++n)g+=j[n];for(var r=j[d]/16,s=new Array(r),n=0;r>n;++n){var t=f.getFloat32(g,!0);g+=4;var u=f.getFloat32(g,!0);g+=4;var v=f.getFloat32(g,!0);g+=4;var w=f.getFloat32(g,!0);g+=4,s[n]=new a(new THREE.Vector3(t,u,v),w)}return-1!==q?s[q]:{}}this.getGeometryPlane=function(a,c,e,f,g){var h=a+"/geometry/geometry_"+c+".bin";b(h,function(a){var b=d(a,e,f);g(b)})}},PS.Packet.Annotation.VisibilityServiceFallback=function(){var a,b=30,c=5;this.init=function(b){a=b},this.getVisibilityInformation=function(d){var e,f=a.cameras[d].qIndex,g=a.path,h=g.nbPoints;e="panorama"===a.topology&&g.isClosed?.25*h:"spin"===a.topology&&g.isClosed?b*h/360:c*h/100;for(var i=g.fixRange(f-e),j=g.fixRange(f+e),k=[],l=0;l<a.cameras.length;++l){var m=a.cameras[l],n=m.qIndex;n>=i&&j>=n&&j>i?k.push(m.index):i>j&&(n>=i&&h-1>=n?k.push(m.index):n>=0&&j>=n&&k.push(m.index))}if(1===k.length||0===k.length){var o=a.cameras.length;0===d?(k.push(a.cameras[1].index),k.push(a.cameras[2].index)):d===o-1?(k.push(a.cameras[o-3].index),k.push(a.cameras[o-2].index)):(k.push(a.cameras[d-1].index),k.push(a.cameras[d+1].index))}return k}},PS.Packet.Annotation.VisibilityService=function(){function a(a,b){new PS.Utils.Request(a,{responseType:"arraybuffer",onComplete:function(a){b(a.response)}})}function b(a,b,c,d){this.nbTracks=a,this.nbVertices=b,this.positions=c,this.viewList=d}function c(a){function c(a){function b(){return d.getUint8(e++)}function c(){var a=d.getFloat32(e,!1);return e+=4,a}var d=new DataView(a),e=0;this.ReadCompressedInt=function(){var a,c=0;do a=b(),c=c<<7|127&a;while(128>a);return c},this.ReadBigEndianSingle=function(){return c()},this.ReadBigEndianUInt16=function(){var a=b(),c=b();return c|a<<8}}var d=new c(a),e=d.ReadBigEndianUInt16(),f=d.ReadBigEndianUInt16();if(1!==e||0!==f)return!1;for(var g=d.ReadCompressedInt(),h=[],i=0;g>i;++i)for(var j=d.ReadCompressedInt(),k=0;j>k;k++){var l=d.ReadCompressedInt(),m=d.ReadCompressedInt();h.push([i,l,m])}for(var n=d.ReadCompressedInt(),o=new Float32Array(3*n),p=new Array(n),i=0;n>i;i++)o[3*i+0]=d.ReadBigEndianSingle(),o[3*i+1]=d.ReadBigEndianSingle(),o[3*i+2]=d.ReadBigEndianSingle(),d.ReadBigEndianUInt16(),p[i]=[];for(var i=0;i<h.length;++i)for(var q=h[i],k=q[1];k<q[1]+q[2];++k)p[k].push(q[0]);for(var r=0,i=0;i<p.length;++i)p[i].length>2&&r++;return new b(r,n,o,p)}var d=[];this.init=function(b,e){var f=[];new PS.Utils.Async.Queue(PS.Utils.generateRangeArray(e),{onProcess:function(d,e){var g=b+"/points/points_"+d+".bin";a(g,function(a){f.push(c(a)),e()})},onComplete:function(){d=f}})},this.getFeatureVisibleInCamera=function(a){for(var b=[],c=d,e=0;e<c.length;++e)for(var f=c[e],g=0;g<f.viewList.length;++g){var h=f.viewList[g];if(-1!==h.indexOf(a)){var i=f.positions[3*g],j=f.positions[3*g+1],k=f.positions[3*g+2];b.push(i),b.push(j),b.push(k),b.push(e),b.push(g)}}return b},this.getVisibilityInformation=function(a){for(var b=d,c={},e=0;e<a.length;++e)for(var f=a[e],g=f[0],h=f[1],i=b[g].viewList[h],j=0;j<i.length;++j)c[i[j]]=!0;var k=[];for(var e in c)c.hasOwnProperty(e)&&k.push(parseInt(e,10));return k}},PS.Packet.Annotation.Builder=function(a){function b(a,b,c){this.distance=a,this.pointCloudIndex=b,this.pointIndex=c}function c(a,c,d){for(var e=a.originalSize.x,f=a.originalSize.y,g=new THREE.Vector2(d.x*e,d.y*f),h=c.length/5,i=a.textureMatrix,j=new THREE.Vector3,k=0,l=new THREE.Vector2,m=new Array(h),n=0;h>n;++n){j.set(c[k++],c[k++],c[k++]);var o=c[k++],p=c[k++],q=j.applyMatrix4(i),r=Math.floor((q.x+1)*(e/2)),s=Math.floor((-q.y+1)*(f/2));l.set(r,s),m[n]=new b(g.distanceTo(l),o,p)}m.sort(function(a,b){return a.distance-b.distance});for(var t=[],n=0;n<m.length;++n){var l=m[n];if(!(l.distance<45))break;t.push(l)}return 0===t.length&&t.push(m[0]),t}var d,e=new PS.Packet.Annotation.GeometryService,f=new PS.Packet.Annotation.VisibilityService,g=new PS.Packet.Annotation.VisibilityServiceFallback,h=!a;this.init=function(a){d=a;var b=a.packetViewer.dataset;0!==b.nbPointCloudFiles&&h?f.init(b.rootUrl,b.nbPointCloudFiles):g.init(b)},this.getPositionAndVisibility=function(a,b,i,j,k){e.getGeometryPlane(d.packetViewer.dataset.rootUrl,b,i,a,function(b){if(b.depth){var e=new PS.Packet.Plane(new THREE.Vector3(b.normal.x,b.normal.y,b.normal.z),b.depth),i=j.intersectPoint(e,2*(a.x-.5),-2*(a.y-.5));if(i.isFront){var l=i.p,m=(new THREE.Quaternion).setFromRotationMatrix((new THREE.Matrix4).lookAt(l,l.clone().sub(b.normal),new THREE.Vector3(0,0,1)));if(0!==d.packetViewer.dataset.nbPointCloudFiles&&h){var n=f.getFeatureVisibleInCamera(j.index),o=c(j,n,a),p=f.getVisibilityInformation(o.map(function(a){return[a.pointCloudIndex,a.pointIndex]}));k(l,p,l.distanceTo(j.pose.position),j.sIndex,a.clone(),m)}else{var p=g.getVisibilityInformation(j.sIndex);k(l,p,l.distanceTo(j.pose.position),j.sIndex,a.clone(),m)}}}})}},PS.Packet.Annotation.VisibilityRangeUpdateMode={Init:0,Start:1,Stop:2},PS.Packet.Annotation.VisibilityControl=function(a){function b(a){var b=e(k),d=e(l);o.style.left=b-v+"px",p.style.left=d+"px",c(a)}function c(a){var b=parseInt(o.style.left,10)+v,c=parseInt(p.style.left,10);r.style.left=b+"px",r.style.width=c-b+"px",a!==PS.Packet.Annotation.VisibilityRangeUpdateMode.Init&&(k=f(b),l=f(c),g.onRangeChanged({start:k,stop:l,visibility:d(),mode:a})),x=a}function d(){var a=[],b=i.cameras;if(i.path.isClosed&&k>l)for(var c=0;c<b.length;++c){var d=b[c].qIndex;(d>=k||l>=d)&&a.push(b[c].index)}else for(var c=0;c<b.length;++c){var d=b[c].qIndex;d>=k&&l>=d&&a.push(b[c].index)}return 0===a.length&&a.push(j.index),a}function e(a){var b=i.path;if(b.isClosed&&j){var c=j.qIndex/b.nbPoints*u,d=a/b.nbPoints*u;return(d-c+u/2+u)%u}return a/b.nbPoints*u}function f(a){var b=i.path;if(b.isClosed&&j){var c=b.nbPoints/2,d=b.fixRange(j.qIndex-c);return b.fixRange(d+a/u*b.nbPoints)}return a/u*b.nbPoints}var g={onCancel:function(){},onDone:function(){},onRangeChanged:function(){}};PS.extend(g,a);var h,i,j,k,l,m=document.getElementsByClassName("PSAnnotationVisibilityLayer")[0],n=m.getElementsByClassName("toolbar")[0],o=n.getElementsByClassName("slider-start")[0],p=n.getElementsByClassName("slider-stop")[0],q=n.getElementsByClassName("slider-keyframe")[0],r=n.getElementsByClassName("slider-range")[0],s=n.getElementsByClassName("cancel")[0],t=n.getElementsByClassName("done")[0],u=530,v=20,w=this,x=PS.Packet.Annotation.VisibilityRangeUpdateMode.Init;this.init=function(a){h=a,i=a.packetViewer.dataset},this.setVisible=function(a){m.style.display=a?"block":"none"},this.setState=function(a,b){j=a,w.setVisibility(b),y=e(j.qIndex),q.style.left=y+"px"},this.setVisibility=function(a){for(var c=i.cameras,d=[],e=0;e<a.length;++e)for(var g=a[e],h=0;h<c.length;++h)if(c[h].index===g){d.push(c[h].qIndex);break}var j=d.reduce(function(a,b){return Math.min(a,b)}),m=d.reduce(function(a,b){return Math.max(a,b)}),n=i.path;if(n.isClosed){for(var o=new Array(c.length),e=0;e<c.length;++e){var p=-1!==a.indexOf(c[e].index);o[e]=p}var q=o[0],r=o[c.length-1];if(q&&r)if(c.length===a.length)k=f(0),l=f(u-1);else{k=-1,l=-1;for(var e=1;e<c.length;++e)if(!o[e]){l=c[e-1].qIndex;break}for(var e=c.length-2;e>0;--e)if(!o[e]){k=c[e+1].qIndex;break}(-1===k||-1===l)&&(console.log("Error while setting visibility range"),k=j,l=m)}else k=j,l=m}else k=j,l=m;b(PS.Packet.Annotation.VisibilityRangeUpdateMode.Init)},s.addEventListener("click",function(){w.setVisible(!1),g.onCancel(x)},!1),t.addEventListener("click",function(){w.setVisible(!1),g.onDone({mode:x,visibility:d()})},!1);var y,z,A;new PS.Packet.SingleTouchInputHandler(o,{onDown:function(a){return z=a.clientX,A=parseInt(o.style.left,10)+v,!0},onMove:function(a){var b=a.clientX-z,d=A+b;return d=Math.max(0,Math.min(y,d)),o.style.left=d-v+"px",c(PS.Packet.Annotation.VisibilityRangeUpdateMode.Start),!0},onUp:function(a){var b=a.clientX-z,d=A+b;return d=Math.max(0,Math.min(y,d)),o.style.left=d-v+"px",c(PS.Packet.Annotation.VisibilityRangeUpdateMode.Start),!0}});var B,C;new PS.Packet.SingleTouchInputHandler(p,{onDown:function(a){return B=a.clientX,C=parseInt(p.style.left,10),!0},onMove:function(a){var b=a.clientX-B,d=C+b;return d=Math.min(u,Math.max(y,d)),p.style.left=d+"px",c(PS.Packet.Annotation.VisibilityRangeUpdateMode.Stop),!0},onUp:function(a){var b=a.clientX-B,d=C+b;return d=Math.min(u,Math.max(y,d)),p.style.left=d+"px",c(PS.Packet.Annotation.VisibilityRangeUpdateMode.Stop),!0}})},PS.Packet.Annotation.Editor=function(a,b){function c(a){a.addEventListener("mousedown",function(a){a.cancelBubble=!0},!1),a.addEventListener("touchstart",function(a){a.cancelBubble=!0},!1),a.addEventListener("touchmove",function(a){a.cancelBubble=!0},!1),a.addEventListener("touchend",function(a){a.cancelBubble=!0},!1),a.addEventListener("MSPointerDown",function(a){a.cancelBubble=!0},!1),a.addEventListener("MSPointerUp",function(a){a.cancelBubble=!0},!1),a.addEventListener("MSGestureStart",function(a){a.cancelBubble=!0},!1),a.addEventListener("MSGestureChange",function(a){a.cancelBubble=!0},!1),a.addEventListener("MSGestureEnd",function(a){a.cancelBubble=!0},!1)}function d(a){var b="https://photosynth.net/preview/view/",c=a.split("?startat=");if(2===c.length&&""!==c[1]){var d=parseInt(c[1],10),e=c[0].replace(b,"");if(36===e.length&&c[0].length===b.length+36)return{isValid:!0,info:{source:{sIndex:L.getRaw(X).camSIndex},target:{guid:e,sIndex:d}}}}return{isValid:!1}}function e(){L.setVisibilityEditable(X,!1),L.setVisible(X,!1),h(!0),_=!0,L.onPoseChanged(G.packetViewer.renderer.getCamera())}function f(a){if(a!==PS.Packet.Annotation.VisibilityRangeUpdateMode.Init){var b=L.getRaw(X);G.packetViewer.gotoCamera(H.cameras[b.camSIndex],{onComplete:function(){e()}})}else e()}function g(a){a>=0&&4>a?z[a].checked=!0:z[0].checked=!0,A.disabled=a!==PS.Packet.Annotation.VisibilityPreset.Manual,L.setVisibilityPreset(X,a)}function h(a){r.style.display=a?"block":"none"}function i(a){y.innerText?y.innerText=a:y.textContent=a}function j(a){s.style.display=a?"":"none"}function k(a,b,c){"block"!==t.style.display&&(j(!1),S=R,T.set(a,b),t.style.display="block",l(S,!0,!0),-1!==X&&(L.remove(X),X=-1),G.getAnnotationInfo(c,function(a,b,c,d){M.getPositionAndVisibility(a,b,c,d,function(a,b,c,d,e,f){X=L.add(a,b,PS.Packet.Annotation.VisibilityPreset.Auto,c,d,e,f,!1),L.setRadius(X,S),L.setEditable(X,!0),Y=b;var g=L.getRaw(X);N.setState(H.cameras[g.camSIndex],g.visibility)})}))}function l(a,b,c){t.style.top=T.y-a+"px",t.style.left=T.x-a+"px",t.style.width=t.style.height=2*a+"px";var d=37,e=38;v.style.top=a-e/2+"px";var f=w.offsetWidth,g=w.offsetHeight,h=f/2,i=g/2,j=25;w.style.top=a-i+"px",T.x+a+j+f<window.innerWidth?(w.style.left=2*a+j+"px",v.style.left=-d/2-2+"px",c&&(Z=q.Right)):(w.style.left=-j-f+"px",v.style.left=2*a-d/2+"px",c&&(Z=q.Left));var k=!1;T.y-i<0&&(w.style.top=2*a+j+"px",k=!0),T.y+i>window.innerHeight&&(w.style.top=-g-j+"px",k=!0),k&&(w.style.left=T.x-h<0?a+"px":T.x+h>window.innerWidth?-f+"px":a-h+"px"),b&&L.setRadius(X,a)}function m(){var a=o(T.x,T.y);a.hover&&G.getAnnotationInfo(a.point,function(a,b,c,d){M.getPositionAndVisibility(a,b,c,d,function(a,b,c,d,e,f){var g=L.get(X);L.remove(X),X=L.add(a,b,PS.Packet.Annotation.VisibilityPreset.Auto,c,d,e,f,!1),L.setRadius(X,S),L.setEditable(X,!0),L.setText(X,g.text),L.setPersistentId(X,g.dbid),Y=b})})}function n(){X=-1,G.packetViewer.cameraController.focusKeyboardElement(),O.setVisible(!1),t.style.display="none",O.setMode("caption"),x.value=$,Z=q.Right,g(PS.Packet.Annotation.VisibilityPreset.Auto)}function o(a,b){var c=G.seadragonViewer.openSeadragon.viewport;if(c){var d=G.seadragonViewer.windowToImageCoordinates(a,b),e=c.contentSize;if(d.x/=e.x,d.y/=e.y,d.x>=0&&d.x<=1&&d.y>=0&&d.y<=1)return{hover:!0,point:d}}return{hover:!1}}var p={onLayerVisibilityChange:function(){},onAnnotationPublished:function(){},onCancel:function(){},onSynthConnectionRequested:function(){},alwaysUseHeuristic:!0};PS.extend(p,b);var q={Right:1,Left:-1},r=document.getElementsByClassName("PSAnnotationEditorLayer")[0],s=r.getElementsByClassName("title")[0],t=r.getElementsByClassName("preview")[0],u=r.getElementsByClassName("exit")[0],v=t.getElementsByClassName("anchor")[0],w=t.getElementsByClassName("editPanel")[0],x=t.getElementsByTagName("textarea")[0],y=w.getElementsByClassName("publish")[0],z=Array.prototype.slice.call(document.getElementsByName("ps2-visibility-range-type"),0),A=w.getElementsByClassName("edit")[0],B=w.getElementsByClassName("connect")[0],C=w.getElementsByClassName("synth-url-selector")[0],D=w.getElementsByClassName("cancel")[0],E=w.getElementsByClassName("publish")[0],F=w.getElementsByTagName("h3");z.forEach(function(a){c(a),a.addEventListener("click",function(a){a.cancelBubble=!0,O.changeVisibility(this.value)},!1);var b=a.parentNode;c(b),b.addEventListener("click",function(a){a.cancelBubble=!0,a.preventDefault(),O.changeVisibility(this.getAttribute("value"))},!1)}),new PS.Packet.SingleTouchInputHandler(A,{onDown:function(a){return O.changeVisibility("manual"),a.originalEvent.cancelBubble=!0,!0}}),new PS.Packet.SingleTouchInputHandler(F[0],{onDown:function(a){return O.setMode("caption"),a.originalEvent.cancelBubble=!0,!0}}),new PS.Packet.SingleTouchInputHandler(F[1],{onDown:function(a){return O.setMode("visibility"),a.originalEvent.cancelBubble=!0,!0}}),new PS.Packet.SingleTouchInputHandler(F[2],{onDown:function(a){return O.setMode("synth connection"),a.originalEvent.cancelBubble=!0,!0}}),C.addEventListener("change",function(){var a=this.value,b=d(a).isValid;B.disabled=!b},!1),new PS.Packet.SingleTouchInputHandler(D,{onDown:function(a){return O.cancel(),a.originalEvent.cancelBubble=!0,!0}}),new PS.Packet.SingleTouchInputHandler(E,{onDown:function(a){return O.publish(),a.originalEvent.cancelBubble=!0,!0}}),new PS.Packet.SingleTouchInputHandler(B,{onDown:function(a){var b=d(C.value),c=L.get(X);return b.isValid&&c&&c.dbid&&(p.onSynthConnectionRequested(b.info,c.dbid),O.exit()),a.originalEvent.cancelBubble=!0,!0}}),new PS.Packet.SingleTouchInputHandler(u,{onDown:function(a){return O.exit(),a.originalEvent.cancelBubble=!0,!0}});var G,H,I,J,K,L=a,M=new PS.Packet.Annotation.Builder(p.alwaysUseHeuristic),N=new PS.Packet.Annotation.VisibilityControl({onCancel:function(a){L.setVisibility(X,Y),f(a)},onDone:function(a){L.setVisibility(X,a.visibility),f(a.mode)},onRangeChanged:function(a){a.mode===PS.Packet.Annotation.VisibilityRangeUpdateMode.Start?G.packetViewer.setPosition(a.start):a.mode===PS.Packet.Annotation.VisibilityRangeUpdateMode.Stop&&G.packetViewer.setPosition(a.stop)}}),O=this,P=22,Q=Math.min(window.innerWidth,window.innerHeight)/2.5,R=50,S=R,T=new THREE.Vector2,U=!1,V=!1,W=new THREE.Vector2,X=-1,Y=[],Z=q.Right,$="Add your note",_=!1;
this.init=function(a){G=a,H=a.packetViewer.dataset,M.init(a),N.init(a)},this.move=function(a,b,c){if(_){var d=a.div.style,e=parseInt(d.width,10)/2,f=b+parseInt(d.left,10)+e,g=c+parseInt(d.top,10)+e;S=e,T.set(f,g),W.set(f,g),t.style.display="block",l(e,!1,!0)}_=!1},this.edit=function(a,b,c){if(a.transform){var d=a.transform.target;C.value="https://photosynth.net/preview/view/"+d.guid+"?startat="+d.sIndex}else C.value="";X=a.id,O.setVisible(!0),j(!1),_=!0,O.move(a,b,c),O.setMode("caption"),x.value=a.text||$,L.setVisible(X,!1),N.setState(H.cameras[a.camSIndex],a.visibility),Y=a.visibility,K=L.get(a.id),g(a.visibilityPreset)},this.resize=function(){Q=Math.min(window.innerWidth,window.innerHeight)/2.5},this.setPosition=function(a){I=a},this.onCameraChanged=function(a){J=a},this.start=function(){O.setVisible(!0),j(!0),O.setMode("caption")},this.publish=function(){var a=x.value;a!==$&&L.setText(X,a),L.setVisible(X,!0),L.setEditable(X,!1);var b=L.get(X),c=G.packetViewer.resizeState,d=Math.min(c.width*c.scale,c.height*c.scale),e=b.radius*d,f=G.seadragonViewer.openSeadragon.viewport,g=1/f.viewportToImageZoom(f.getHomeZoom());e*=g;var h=G.packetViewer.dataset.getCameraByIndex(b.imgIndex),j=h.originalSize,k=b.queryPoint[0]*j.x,l=b.queryPoint[1]*j.y;i("saving..."),y.disabled=!0,p.onAnnotationPublished(b,X,{x:k,y:l,radius:e},function(a){i("save"),y.disabled=!1,a&&n()})},this.exit=function(){O.cancel(),O.setVisible(!1)},this.cancel=function(){if(-1!==X){var a=L.get(X);""===a.dbid?L.remove(X):(L.load([K]),K=null)}n(),p.onCancel()},this.changeVisibility=function(a){var b=L.getRaw(X);if("manual"===a)g(PS.Packet.Annotation.VisibilityPreset.Manual),G.seadragonViewer.isHomeZoom()||G.seadragonViewer.goHome(),N.setVisibility(b.visibility),N.setVisible(!0),L.setVisibility(X,H.cameras.map(function(a){return a.index})),L.setVisible(X,!0),L.setVisibilityEditable(X,!0),h(!1);else if("all"===a){g(PS.Packet.Annotation.VisibilityPreset.All);var c=H.cameras.map(function(a){return a.index});N.setVisibility(c),L.setVisibility(X,c)}else if("one"===a){g(PS.Packet.Annotation.VisibilityPreset.One);var c=[H.cameras[b.camSIndex].index];N.setVisibility(c),L.setVisibility(X,c)}else g(PS.Packet.Annotation.VisibilityPreset.Auto),N.setVisibility(Y),L.setVisibility(X,Y)},this.setVisible=function(a){h(a),G.metadataViewer.setToolbarVisibility(!a),p.onLayerVisibilityChange(a)},this.isVisible=function(){return"block"===r.style.display},this.setMode=function(a){G.packetViewer.cameraController.blurKeyboardElement();for(var b=w.getElementsByTagName("h3"),c=0;c<b.length;++c)b[c].parentNode.classList.remove("selected");for(var c=0;c<b.length;++c)(b[c].innerText===a||b[c].textContent===a)&&b[c].parentNode.classList.add("selected")};var ab="default";r.addEventListener("mousemove",function(a){var b=o(a.clientX,a.clientY);b.hover?-1!==X&&"default"!==ab?ab=r.style.cursor="default":-1===X&&"crosshair"!==ab&&(ab=r.style.cursor="crosshair"):"default"!==ab&&(ab=r.style.cursor="default")},!1),new PS.Packet.SingleTouchInputHandler(r,{onDown:function(a){if(a.originalEvent.target===r&&!U){var b=o(a.clientX,a.clientY);if(b.hover)return k(a.layerX,a.layerY,b.point),a.originalEvent.cancelBubble=!0,!0}return!1}}),new PS.Packet.SingleTouchInputHandler(v,{onDown:function(a){return U=!0,W.set(a.screenX,a.screenY),a.originalEvent.cancelBubble=!0,!0},onMove:function(a){var b=W.x-a.screenX;return b*=Z,l(Math.max(P,Math.min(Q,S+b)),!0,!1),a.originalEvent.cancelBubble=!0,!0},onUp:function(a){var b=W.x-a.screenX;return b*=Z,l(Math.max(P,Math.min(Q,S+b)),!0,!0),U=!1,S+=b,!0}}),new PS.Packet.SingleTouchInputHandler(t,{onDown:function(a){var b=a.originalEvent.target;return b&&b===t?(t.classList.add("previewMoving"),V=!0,a.originalEvent.cancelBubble=!0,!0):(V=!1,!1)},onMove:function(a){if(V){var b=o(a.clientX,a.clientY);if(b.hover)return T.set(a.clientX,a.clientY),l(Math.max(P,Math.min(Q,S)),!0,!1),a.originalEvent.cancelBubble=!0,!0}return!1},onUp:function(a){if(V){var b=o(a.clientX,a.clientY);b.hover&&T.set(a.clientX,a.clientY),m(),l(Math.max(P,Math.min(Q,S)),!0,!0)}return V=!1,t.classList.remove("previewMoving"),!0}}),c(x),x.addEventListener("click",function(){this.value===$&&(this.value="")},!1),x.addEventListener("blur",function(){""===this.value&&(this.value=$)},!1),x.addEventListener("change",function(){var a=this.value;a!==$&&L.setText(X,a)},!1)};
PS.Packet.WorkerParser='';
"use strict";var Photosynth=Photosynth||{};Photosynth.EventDispatcher=function(a){this.events={},this.eventNames=a,this.addEventListener=function(a,b){this.isValidEvent(a)?(this.events[a]||(this.events[a]=[]),this.events[a].push(b)):console.warn('"'+a+'" is not a supported event')},this.removeEventListener=function(a,b){if(this.isValidEvent(a))if(this.events[a]){var c=this.events[a],d=c.indexOf(b);-1!==d?c.splice(d,1):console.warn("callback not found for this event")}else console.warn("callback not found for this event");else console.warn('"'+a+'" is not a supported event')},this.isValidEvent=function(a){return-1!==this.eventNames.indexOf(a)},this.toArray=function(a){return Array.prototype.slice.call(a)},this.fireCallbacks=function(a,b){var c=!0,d=this.events[a];if(d)for(var e=0;e<d.length;++e)c&=d[e].apply(null,b);return c}},Photosynth.PS2Viewer=function(a,b){function c(a,b){var c={startCameraIndex:-1};PS.extend(c,b);var i={width:d.width,height:d.height,autoLoad:d.autoLoad,autoResizeEnabled:d.autoResizeEnabled,debugMenuEnabled:d.debugMenuEnabled,packetURL:a,corsEnabled:!0,loggingEnabled:d.loggingEnabled,onToggleFullscreen:function(a){j.callbacks.onToggleFullscreen(a)},viewer:{startCameraIndex:c.startCameraIndex,pathToWorker:d.pathToWorker,presetGPU:d.presetGPU,autoStartEnabled:d.autoStart,renderer:{screenshotEnabled:d.screenshotEnabled},onCameraChanged:function(a){j.callbacks.onCameraChanged(a)},onCamerasChanged:function(a,b){j.callbacks.onCamerasChanged(a,b)},onCanvasCreated:function(){h=!0,j.callbacks.onCanvasCreated()},onCanvasUpdated:function(){j.callbacks.onCanvasUpdated(),1!==d.animateSpeed&&e.packetViewer.setOptions({animateSpeed:e.packetViewer.getOptions().animateSpeed*d.animateSpeed})},onDatasetLoaded:function(a){j.callbacks.onDatasetLoaded(a)},onDatasetRendered:function(a){j.callbacks.onDatasetRendered(a)},onStartAnimating:function(){j.callbacks.onStartAnimating()},onStopAnimating:function(){j.callbacks.onStopAnimating()},onCameraModeChanged:function(a){j.callbacks.onCameraModeChanged(a)},onPoseChanged:function(){j.callbacks.onPoseChanged()},onPositionChanged:function(a){j.callbacks.onPositionChanged(a)},onAllGeometryLoaded:function(){j.callbacks.onAllGeometryLoaded()},onAllHDLoaded:function(){j.callbacks.onAllHDLoaded()},onContainerTransformed:function(a,b,c){j.callbacks.onContainerTransformed(a,b,c)},onResize:function(a,b){j.callbacks.onResize(a,b)}},seadragonViewer:{onResize:function(){j.callbacks.onSeadragonResize()},onZoomLevelStateChanged:function(a){j.callbacks.onZoomLevelStateChanged(a)}},metadata:{enableAnnotate:d.annotateEnabled,onAnnotate:function(){e.packetViewer.stopPlaying(),j.callbacks.onAnnotate()}}};d.presetGPU===PS.Packet.PresetGPU.Custom&&(d.maxRenderSize&&d.maxHDPixels&&d.gpuHDMemoryBudget&&d.maxRenderSize>0&&d.maxHDPixels>0&&d.gpuHDMemoryBudget>0?PS.extend(i,{viewer:{maxRenderSize:d.maxRenderSize,maxHDPixels:d.maxHDPixels,gpuHDMemoryBudget:d.gpuHDMemoryBudget}}):(console.log("PresetGPU.Custom selected but 'maxRenderSize' or 'maxHDPixels' or 'gpuHDMemoryBudget' are missing or invalid (defaulting to PresetGPU.Laptop)"),PS.extend(i,{viewer:{presetGPU:PS.Packet.PresetGPU.Laptop}}))),d.debugMenuEnabled&&PS.extend(i,PS.Packet.ViewerOptions.getUser()),e=new PS.Packet.Player(g,i),f=!0}var d={width:-1,height:-1,animateSpeed:1,presetGPU:PS.Packet.PresetGPU.Laptop,autoStart:!0,autoLoad:!0,loggingEnabled:!1,annotateEnabled:!1,pathToWorker:"",autoResizeEnabled:!1,hiddenMenuEnabled:!1,debugMenuEnabled:!1};PS.extend(d,b),(-1===d.width||0===d.width)&&(d.width=a.offsetWidth||800),(-1===d.height||0===d.height)&&(d.height=a.offsetHeight||500),""===d.pathToWorker&&console.warn("You need to provide the pathToWorker as an option");var e,f=!1,g=a,h=!1,i=this,j=new Photosynth.PlayerEventDispatcher;this.addEventListener=function(a,b){j.addEventListener(a,b)},this.removeEventListener=function(a,b){j.removeEventListener(a,b)},this.loadGuid=function(a,b){PS.API.getPS2Url(a,function(c){c?i.load(c,b):console.error("'"+a+"' is not a valid guid")})},this.load=function(a,b){h=!1,f?e.load(a,b):c(a,b)},this.preload=function(a,b){e.preload(a,b)},this.setActiveDataset=function(a){e.setActiveDataset(a)},this.setCameraMode=function(a){h&&e.setCameraMode(a)},this.getCameraMode=function(){return e&&e.packetViewer?e.packetViewer.getCurrentCameraMode():PS.Packet.ViewMode.Smooth},this.setPosition=function(a){h&&e.packetViewer.setPosition(a)},this.setAnimationSpeed=function(a){h&&e.packetViewer.setOptions({animateSpeed:e.packetViewer.getOptions().animateSpeed*a})},this.isPlaying=function(){return h?e.packetViewer.isPlaying():!1},this.togglePlay=function(a){var b={direction:null,onStopped:null};b=PS.extend(b,a),b.direction=-1===b.direction?-1:1===b.direction?1:null,b.onStopped="function"==typeof b.onStopped?b.onStopped:null,h&&(e.packetViewer.isPlaying()?e.packetViewer.stopPlaying(b.onStopped):(e.seadragonViewer.isHomeZoom()||e.seadragonViewer.goHome(),e.packetViewer.startPlaying(b.direction)))},this.play=function(a){i.isPlaying()||i.togglePlay({direction:a})},this.stop=function(a){i.isPlaying()&&i.togglePlay({onStopped:a})},this.gotoCamera=function(a,b){e.packetViewer.gotoCamera(a,b)},this.isHomeZoom=function(){return e&&e.seadragonViewer?e.seadragonViewer.isHomeZoom():!0},this.goHomeZoom=function(){e&&e.seadragonViewer&&e.seadragonViewer.goHome()},this.getInternal=function(){return e},this.blur=function(){e&&e.packetViewer&&e.packetViewer.cameraController&&e.packetViewer.cameraController.blurKeyboardElement()},this.focus=function(){e&&e.packetViewer&&e.packetViewer.cameraController&&e.packetViewer.cameraController.focusKeyboardElement()},this.resize=function(a,b,c){e.resize(a,b,c?c:PS.Packet.ResizeMode.Slow)},this.dispose=function(){e&&(e.destroy(),e=null)}},Photosynth.PlayerEventDispatcher=function(){var a=new Photosynth.EventDispatcher(["viewer-built","viewer-updated","camera-changed","cameras-changed","position-changed","pose-changed","dataset-loaded","dataset-rendered","geometry-loaded","imagery-loaded","animation-start","animation-stop","enter-fullscreen","exit-fullscreen","camera-mode-changed","zoom-level-changed","resize","seadragon-resize","container-transformed","annotate"]);return a.callbacks={onCanvasCreated:function(){a.fireCallbacks("viewer-built",a.toArray(arguments))},onCanvasUpdated:function(){a.fireCallbacks("viewer-updated",a.toArray(arguments))},onAllHDLoaded:function(){a.fireCallbacks("imagery-loaded",a.toArray(arguments))},onAllGeometryLoaded:function(){a.fireCallbacks("geometry-loaded",a.toArray(arguments))},onCameraModeChanged:function(){a.fireCallbacks("camera-mode-changed",a.toArray(arguments))},onCameraChanged:function(b){a.fireCallbacks("camera-changed",[b,b.sIndex])},onCamerasChanged:function(){a.fireCallbacks("cameras-changed",a.toArray(arguments))},onPositionChanged:function(){a.fireCallbacks("position-changed",a.toArray(arguments))},onPoseChanged:function(){a.fireCallbacks("pose-changed")},onDatasetLoaded:function(){a.fireCallbacks("dataset-loaded",a.toArray(arguments))},onDatasetRendered:function(){a.fireCallbacks("dataset-rendered",a.toArray(arguments))},onStartAnimating:function(){a.fireCallbacks("animation-start",a.toArray(arguments))},onStopAnimating:function(){a.fireCallbacks("animation-stop",a.toArray(arguments))},onToggleFullscreen:function(b){a.fireCallbacks(b?"enter-fullscreen":"exit-fullscreen")},onZoomLevelStateChanged:function(){a.fireCallbacks("zoom-level-changed",a.toArray(arguments))},onResize:function(){a.fireCallbacks("resize",a.toArray(arguments))},onContainerTransformed:function(){a.fireCallbacks("container-transformed",a.toArray(arguments))},onSeadragonResize:function(){a.fireCallbacks("seadragon-resize")},onAnnotate:function(){a.fireCallbacks("annotate")}},a},Photosynth.PS2AnnotationViewer=function(a,b){function c(a){e.packetViewer.cameraController.forceInputMode(0);var b=e.seadragonViewer.openSeadragon.viewport,c=1/b.viewportToImageZoom(b.getZoom()),d=a.accurateRadius*c,f=b.contentSize,g=new THREE.Vector2(f.x*a.queryPoint.x,f.y*a.queryPoint.y),h=b.imageToViewportRectangle(new OpenSeadragon.Rect(g.x-d,g.y-d,2*d,2*d));e.seadragonViewer.fitBoundsWithConstraints(h,!1)}var d={editEnabled:!1,visibleInFullscreen:!1};PS.extend(d,b);var e,f=a,g=this,h=new Photosynth.AnnotationViewerEventDispatcher;this.addEventListener=function(a,b){h.addEventListener(a,b)},this.removeEventListener=function(a,b){h.removeEventListener(a,b)};var i=new PS.Packet.Annotation.Viewer({editEnabled:d.editEnabled,onInitialized:function(){h.callbacks.onInit(g)},onAnnotationClick:function(a,b){if(h.callbacks.onAnnotationClick(a,b)){var d=e.packetViewer.dataset.cameras[a.camSIndex];f.isPlaying()&&f.togglePlay(),b===d?c(a):f.isHomeZoom()?f.gotoCamera(d,{onComplete:function(){c(a)}}):(f.goHomeZoom(),setTimeout(function(){f.gotoCamera(d,{onComplete:function(){c(a)}})},300))}},onAnnotationEdit:function(a,b,c){h.callbacks.onAnnotationEdit(a,b,c)},onAnnotationDelete:function(a){h.callbacks.onAnnotationDelete(a)},onEditedAnnotationMove:function(a,b,c){h.callbacks.onEditedAnnotationMove(a,b,c)}});this.load=function(a){i.load(a)},this.clear=function(){i.clear()},this.getInternal=function(){return i},f.addEventListener("enter-fullscreen",function(){d.visibleInFullscreen||i.setFullscreenState(!0)}),f.addEventListener("exit-fullscreen",function(){d.visibleInFullscreen||i.setFullscreenState(!1)}),f.addEventListener("viewer-updated",function(){e=f.getInternal(),i.init(e),i.setLayerVisibility(!1)}),f.addEventListener("geometry-loaded",function(){i.setLayerVisibility(!0)}),f.addEventListener("camera-changed",function(a){i.onCameraChanged(a)}),f.addEventListener("cameras-changed",function(a,b){i.onCamerasChanged(a,b)}),f.addEventListener("position-changed",function(){i.onPoseChanged(e.packetViewer.renderer.getCamera())}),f.addEventListener("pose-changed",function(){i.onPoseChanged(e.packetViewer.renderer.getCamera())}),f.addEventListener("container-transformed",function(a,b,c){i.setTransform(a,b,c)}),f.addEventListener("resize",function(a,b){i.resize(a,b)}),f.addEventListener("camera-mode-changed",function(a){a===PS.Packet.CameraMode.Global?i.setLayerVisibility(!1):(i.setLayerVisibility(!0),i.onPoseChanged(e.packetViewer.renderer.getCamera()))}),f.addEventListener("seadragon-resize",function(){i.onPoseChanged(e.packetViewer.renderer.getCamera())})},Photosynth.AnnotationViewerEventDispatcher=function(){var a=new Photosynth.EventDispatcher(["init","annotation-click","annotation-edit","annotation-delete","edited-annotation-move"]);return a.callbacks={onInit:function(){a.fireCallbacks("init",a.toArray(arguments))},onAnnotationClick:function(){return a.fireCallbacks("annotation-click",a.toArray(arguments))},onAnnotationEdit:function(){a.fireCallbacks("annotation-edit",a.toArray(arguments))},onAnnotationDelete:function(){a.fireCallbacks("annotation-delete",a.toArray(arguments))},onEditedAnnotationMove:function(){a.fireCallbacks("edited-annotation-move",a.toArray(arguments))}},a},Photosynth.PS2AnnotationEditor=function(a,b,c){function d(){var a="";a+='<div class="PSAnnotationEditorLayer" style="display: none;">',a+='	<div class="title">',a+='		Click to add a highlight <button class="exit" title="Cancel"></button>',a+="	</div>",a+='	<div class="preview" style="display: none;">',a+='		<div class="anchor"></div>',a+='		<div class="editPanel">',a+='			<div class="accordion selected">',a+="				<h3>caption</h3>",a+='				<div class="content">',a+='					<textarea maxlength="400">Add your note</textarea>',a+="				</div>",a+="			</div>",a+='			<div class="accordion">',a+="				<h3>visibility</h3>",a+='				<div class="content">',a+='					<p class="visibility-explanation">Select when the highlight is visible on the synth:</p>',a+='					<ul class="visibility-range-type">',a+='						<li><label value="auto"  ><input type="radio" name="ps2-visibility-range-type" value="auto" checked=checked />automatic</label></li>',a+='						<li><label value="all"   ><input type="radio" name="ps2-visibility-range-type" value="all" />show on all frames</label></li>',a+='						<li><label value="one"   ><input type="radio" name="ps2-visibility-range-type" value="one" />only show on current frame</label></li>',a+='						<li><label value="manual"><input type="radio" name="ps2-visibility-range-type" value="manual" />manual</label> <button class="edit"  disabled=disabled>edit visibility range</button></li>',a+="					</ul>",a+="				</div>",a+="			</div>",a+='			<div class="accordion">',a+="				<h3>synth connection</h3>",a+='				<div class="content">',a+='					<p style="color: white; margin-bottom: 5px; margin-top: 5px;">Please enter target synth URL:</p>',a+='					<input class="synth-url-selector" type="text" value="" style="width:320px; font-size: 14px;" />',a+='					<button class="connect" disabled=disabled style="margin-left: 0px; margin-top: 10px;">connect</button>',a+="				</div>",a+="			</div>",a+='			<div class="command" style="">',a+='				<button class="cancel">cancel</button> <button class="publish" style="margin-right: 5px;">save</button>',a+="			</div>",a+="		</div>",a+="	</div>",a+="</div>",a+='<div class="PSAnnotationVisibilityLayer" style="display: none;">',a+='	<div class="toolbar">',a+="		<p>Drag the control points to adjust when the highlight is visible.</p>",a+='		<div class="slider-container">',a+='			<div class="slider-handle slider-start" title="start"></div>',a+='			<div class="slider-handle slider-stop"  title="stop"></div>',a+='			<div class="slider-range"></div>',a+='			<div class="slider-keyframe"></div>',a+='			<div class="slider-container-start"></div>',a+='			<div class="slider-container-stop"></div>',a+="		</div>",a+='		<button class="cancel" title="Cancel"></button> <button class="done">done</button>',a+="	</div>",a+="</div>";var b=document.createElement("div");b.innerHTML=a,e.appendChild(b)}var e=c;d();var f,g=a,h=b,i=h.getInternal(),j=new Photosynth.AnnotationEditorEventDispatcher;this.addEventListener=function(a,b){j.addEventListener(a,b)},this.removeEventListener=function(a,b){j.removeEventListener(a,b)};var k=new PS.Packet.Annotation.Editor(i,{alwaysUseHeuristic:!0,onLayerVisibilityChange:function(a){j.callbacks.onLayerVisibilityChange(a)},onAnnotationPublished:function(a,b,c,d){j.callbacks.onAnnotationPublished(a,c,function(a,c){a&&i.setPersistentId(b,c),d(a)})},onCancel:function(){j.callbacks.onCancel()},onSynthConnectionRequested:function(a,b){j.callbacks.onSynthConnectionRequested(a,b)}});this.getInternal=function(){return k},g.addEventListener("viewer-built",function(){f=g.getInternal(),k.init(f)}),g.addEventListener("camera-changed",function(a){k.onCameraChanged(a)}),g.addEventListener("position-changed",function(a){k.setPosition(a)}),g.addEventListener("resize",function(a){k.resize(a)}),g.addEventListener("annotate",function(){k.start()}),h.addEventListener("annotation-edit",function(a,b,c){k.edit(a,b,c)}),h.addEventListener("annotation-delete",function(a){j.callbacks.onAnnotationDelete(a,function(b){b&&i.remove(a.id)})}),h.addEventListener("edited-annotation-move",function(a,b,c){k.move(a,b,c)})},Photosynth.AnnotationEditorEventDispatcher=function(){var a=new Photosynth.EventDispatcher(["visibility-change","cancel","annotation-created","annotation-edited","annotation-delete","synth-connection-requested"]);return a.callbacks={onLayerVisibilityChange:function(){a.fireCallbacks("visibility-change",a.toArray(arguments))},onCancel:function(){a.fireCallbacks("cancel",a.toArray(arguments))},onAnnotationPublished:function(b){b.dbid?a.fireCallbacks("annotation-edited",a.toArray(arguments)):a.fireCallbacks("annotation-created",a.toArray(arguments))},onAnnotationDelete:function(){a.fireCallbacks("annotation-delete",a.toArray(arguments))},onSynthConnectionRequested:function(){a.fireCallbacks("synth-connection-requested",a.toArray(arguments))}},a};